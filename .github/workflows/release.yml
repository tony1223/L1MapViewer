name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ v é–‹é ­çš„ tagï¼Œä¾‹å¦‚ v1.24.1225143000

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: L1MapViewer
  CSPROJ_NAME: L1MapViewerCore.csproj

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        # ä¾‹å¦‚: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # ç§»é™¤å‰å°é›¶ä»¥é¿å…å…«é€²åˆ¶è§£æå•é¡Œ
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # å¦‚æœä¸æ˜¯æ™‚é–“æˆ³æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨åŸç‰ˆæœ¬è™Ÿ
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.CSPROJ_NAME }} -r win-x64

    - name: Build Self-Contained
      run: |
        dotnet publish ${{ env.CSPROJ_NAME }} -f net10.0-windows --configuration Release --runtime win-x64 --self-contained true --no-restore -o publish-sc /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Build Framework-Dependent
      run: |
        dotnet publish ${{ env.CSPROJ_NAME }} -f net10.0-windows --configuration Release --self-contained false -o publish-fd /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archives
      shell: pwsh
      run: |
        Compress-Archive -Path "publish-sc/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip"
        Compress-Archive -Path "publish-fd/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip"

    - name: Upload self-contained artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-win-x64-self-contained
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip

    - name: Upload framework-dependent artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-win-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install GTK dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev

    - name: Restore dependencies
      run: dotnet restore ${{ env.CSPROJ_NAME }} -r linux-x64

    - name: Build and Publish
      run: |
        dotnet publish ${{ env.CSPROJ_NAME }} -f net10.0 --configuration Release --runtime linux-x64 --self-contained true --no-restore -o publish /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archive
      run: |
        cd publish
        chmod +x ${{ env.PROJECT_NAME }}* 2>/dev/null || true
        chmod +x L1MapViewerCore* 2>/dev/null || true
        zip -r "../${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-linux-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install macOS workload
      run: |
        dotnet workload install macos || true

    - name: Restore dependencies
      run: |
        dotnet restore ${{ env.CSPROJ_NAME }} -r osx-x64
        dotnet restore ${{ env.CSPROJ_NAME }} -r osx-arm64

    - name: Build x64
      run: |
        # é—œé–‰ R2R è®“ managed DLL æ¶æ§‹ç„¡é—œï¼Œä»¥ä¾¿å»ºç«‹ universal binary
        dotnet publish ${{ env.CSPROJ_NAME }} -f net10.0 --configuration Release --runtime osx-x64 --self-contained true -o publish-x64 /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }} /p:PublishReadyToRun=false

    - name: Build arm64
      run: |
        dotnet publish ${{ env.CSPROJ_NAME }} -f net10.0 --configuration Release --runtime osx-arm64 --self-contained true -o publish-arm64 /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }} /p:PublishReadyToRun=false

    - name: Create macOS App Bundle and Universal Binary DMG
      run: |
        APP_NAME="${{ env.PROJECT_NAME }}.app"
        EXECUTABLE_NAME="L1MapViewerCore"

        # å»ºç«‹ app bundle çµæ§‹
        mkdir -p "universal/$APP_NAME/Contents/MacOS"
        mkdir -p "universal/$APP_NAME/Contents/Resources"

        # å»ºç«‹ Info.plist
        cat > "universal/$APP_NAME/Contents/Info.plist" << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>L1MapViewerCore</string>
            <key>CFBundleIdentifier</key>
            <string>com.flyworld.l1mapviewer</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>L1MapViewer</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSPrincipalClass</key>
            <string>NSApplication</string>
        </dict>
        </plist>
        PLIST

        # è¤‡è£½ arm64 ç‰ˆæœ¬çš„æª”æ¡ˆåˆ° app bundle
        cp -R publish-arm64/* "universal/$APP_NAME/Contents/MacOS/"

        # ä½¿ç”¨ lipo åˆä½µæ‰€æœ‰ Mach-O æª”æ¡ˆ (åŸ·è¡Œæª”å’Œ dylib)
        MACOS_DIR="universal/$APP_NAME/Contents/MacOS"
        for file in "$MACOS_DIR"/*; do
          filename=$(basename "$file")
          x64_file="publish-x64/$filename"
          if [ -f "$x64_file" ] && file "$file" | grep -q "Mach-O"; then
            echo "Creating universal binary for $filename"
            lipo -create "$file" "$x64_file" -output "$MACOS_DIR/$filename.universal" 2>/dev/null || true
            if [ -f "$MACOS_DIR/$filename.universal" ]; then
              mv "$MACOS_DIR/$filename.universal" "$MACOS_DIR/$filename"
            fi
          fi
        done

        # Ad-hoc ç°½ç½²
        codesign --force --deep --sign - "universal/$APP_NAME" || true

        # å»ºç«‹ DMG
        hdiutil create -volname "${{ env.PROJECT_NAME }}" -srcfolder "universal/$APP_NAME" -ov -format UDZO "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.dmg"

    - name: Upload universal artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-osx-universal
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.dmg

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f \( -name "*.zip" -o -name "*.dmg" \)

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}
        body: |
          ## ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}

          ### Downloads

          | Platform | File | Note |
          |----------|------|------|
          | Windows x64 | `*-win-x64.zip` | éœ€å®‰è£ [.NET 10 Runtime](https://dotnet.microsoft.com/download/dotnet/10.0) |
          | Windows x64 | `*-win-x64-self-contained.zip` | åŒ…å« .NET Runtimeï¼Œå¯ç›´æ¥åŸ·è¡Œ |
          | Linux x64 | `*-linux-x64.zip` | Self-contained |
          | macOS Universal | `*-osx-universal.dmg` | Self-contained, æ”¯æ´ Intel & Apple Silicon |

          ### macOS / Linux ä½¿ç”¨èªªæ˜

          **macOS**:
          1. ä¸‹è¼‰ DMG æª”æ¡ˆä¸¦é›™æ“Šæ›è¼‰
          2. å°‡ L1MapViewer.app æ‹–æ›³åˆ°æ‡‰ç”¨ç¨‹å¼è³‡æ–™å¤¾
          3. é¦–æ¬¡é–‹å•Ÿæ™‚ï¼Œå³éµé»æ“Š app â†’ é¸æ“‡ã€Œæ‰“é–‹ã€
          4. å¦‚æœé‚„æ˜¯ç„¡æ³•é–‹å•Ÿï¼Œåœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œï¼š
          ```bash
          xattr -cr /Applications/L1MapViewer.app
          ```

          **Linux**:
          ```bash
          # è§£å£“ç¸®å¾Œï¼Œçµ¦äºˆåŸ·è¡Œæ¬Šé™
          chmod +x L1MapViewerCore
          ./L1MapViewerCore
          ```

          ### Changes
          See [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}) for details.
        files: |
          artifacts/**/*.zip
          artifacts/**/*.dmg
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.TAG, '-') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Discord Release Notification (Release Channel)
      if: success()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_RELEASE }}
        nodetail: true
        title: "ğŸ‰ æ–°ç‰ˆæœ¬ç™¼å¸ƒ: ${{ steps.get_version.outputs.TAG }}"
        description: |
          **${{ env.PROJECT_NAME }}** å·²ç™¼å¸ƒæ–°ç‰ˆæœ¬ï¼

          ğŸ“¦ [ä¸‹è¼‰é€£çµ](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }})
          ğŸ“ [è®Šæ›´ç´€éŒ„](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }})

          æ”¯æ´å¹³å°: Windows x64, Linux x64, macOS (Intel & Apple Silicon)
        color: 0x00ff00

    - name: Discord Release Notification (Dev Channel)
      if: success()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_DEV }}
        nodetail: true
        title: "ğŸ‰ æ–°ç‰ˆæœ¬ç™¼å¸ƒ: ${{ steps.get_version.outputs.TAG }}"
        description: |
          **${{ env.PROJECT_NAME }}** å·²ç™¼å¸ƒæ–°ç‰ˆæœ¬ï¼

          ğŸ“¦ [ä¸‹è¼‰é€£çµ](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }})
          ğŸ“ [è®Šæ›´ç´€éŒ„](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }})

          æ”¯æ´å¹³å°: Windows x64, Linux x64, macOS (Intel & Apple Silicon)
        color: 0x00ff00
