using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using L1MapViewer;
using L1MapViewer.CLI;
using L1MapViewer.Controls;
using L1MapViewer.Converter;
using L1MapViewer.Helper;
using L1MapViewer.Localization;
using L1MapViewer.Models;
using L1MapViewer.Other;
using L1MapViewer.Reader;
using Lin.Helper.Core.Sprite;

namespace L1FlyMapViewer
{
    public partial class MapForm : Form, IMapViewer
    {
        // ===== Model å±¤ =====
        /// <summary>
        /// åœ°åœ–æ–‡ä»¶ Model - ç®¡ç†æ‰€æœ‰ S32 è³‡æ–™
        /// </summary>
        private readonly MapDocument _document = new MapDocument();

        /// <summary>
        /// ç·¨è¼¯ç‹€æ…‹ Model - ç®¡ç†é¸å–ã€å‰ªè²¼ç°¿ã€Undo
        /// </summary>
        private readonly EditState _editState = new EditState();

        /// <summary>
        /// æª¢è¦–ç‹€æ…‹ Model - ç®¡ç†ç¸®æ”¾ã€æ²å‹•ã€é¡¯ç¤ºé¸é …
        /// </summary>
        private readonly ViewState _viewState = new ViewState();

        // Layer8 SPR é¡¯ç¤ºç›¸é—œ
        private readonly Dictionary<int, List<Image>> _layer8SprCache = new Dictionary<int, List<Image>>();
        private readonly Dictionary<(string, int), int> _layer8AnimFrame = new Dictionary<(string, int), int>();
        private System.Windows.Forms.Timer _layer8AnimTimer;

        // IMapViewer ä»‹é¢å¯¦ä½œ - æ˜ç¢ºå…¬é–‹æ§åˆ¶é …å±¬æ€§
        ComboBox IMapViewer.comboBox1 => this.comboBox1;
        PictureBox IMapViewer.pictureBox1 => this.pictureBox1;
        PictureBox IMapViewer.pictureBox2 => this.pictureBox2;
        PictureBox IMapViewer.pictureBox3 => this.pictureBox3;
        PictureBox IMapViewer.pictureBox4 => this.pictureBox4;
        VScrollBar IMapViewer.vScrollBar1 => this.vScrollBar1;
        HScrollBar IMapViewer.hScrollBar1 => this.hScrollBar1;
        ToolStripProgressBar IMapViewer.toolStripProgressBar1 => this.toolStripProgressBar1;
        ToolStripStatusLabel IMapViewer.toolStripStatusLabel1 => this.toolStripStatusLabel1;
        ToolStripStatusLabel IMapViewer.toolStripStatusLabel2 => this.toolStripStatusLabel2;
        ToolStripStatusLabel IMapViewer.toolStripStatusLabel3 => this.toolStripStatusLabel3;
        Panel IMapViewer.panel1 => this.panel1;

        private Point mouseDownPoint;
        private bool isMouseDrag;
        private const int DRAG_THRESHOLD = 5;

        // ç¸®æ”¾ç›¸é—œï¼ˆåœ°åœ–é è¦½ï¼‰
        [System.ComponentModel.DesignerSerializationVisibility(System.ComponentModel.DesignerSerializationVisibility.Hidden)]
        public double zoomLevel { get; set; } = 1.0;
        private const double ZOOM_MIN = 0.5;
        private const double ZOOM_MAX = 5.0;
        private const double ZOOM_STEP = 0.2;
        private Image originalMapImage;

        // S32 ç·¨è¼¯å™¨ç¸®æ”¾ç›¸é—œ
        [System.ComponentModel.DesignerSerializationVisibility(System.ComponentModel.DesignerSerializationVisibility.Hidden)]
        public double s32ZoomLevel { get; set; } = 1.0;
        private Image originalS32Image;
        private double pendingS32ZoomLevel = 1.0;

        // å°åœ°åœ–å®Œæ•´æ¸²æŸ“ Bitmapï¼ˆæ•´å¼µåœ°åœ–çš„ç¸®åœ–ï¼‰
        private Bitmap _miniMapFullBitmap = null;

        // å°åœ°åœ–æ¸²æŸ“å™¨ï¼ˆèˆ‡ CLI å…±ç”¨é‚è¼¯ï¼‰
        private MiniMapRenderer _miniMapRenderer = new MiniMapRenderer();

        // åœ–å±¤åˆ‡æ›é˜²æŠ–Timer
        private System.Windows.Forms.Timer renderDebounceTimer;

        // ç¸®æ”¾é˜²æŠ–Timer
        private System.Windows.Forms.Timer zoomDebounceTimer;

        // æ‹–æ›³çµæŸå¾Œå»¶é²æ¸²æŸ“ Timer
        private System.Windows.Forms.Timer dragRenderTimer;

        // ç´ æè²¼ä¸Šé è¦½ç‹€æ…‹
        private Fs3pData _pendingMaterial = null;
        private string _pendingMaterialPath = null;

        // æ•ˆèƒ½ Log æª”æ¡ˆè·¯å¾‘ï¼ˆé–‹é—œç”± Program.PerfLogEnabled æ§åˆ¶ï¼Œå•Ÿå‹•æ™‚åŠ  --perf-logï¼‰
        private static readonly string _perfLogPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "perf.log");
        private static void LogPerf(string message)
        {
            if (!L1MapViewerCore.Program.PerfLogEnabled) return;
            string timestamp = DateTime.Now.ToString("HH:mm:ss.fff");
            string elapsed = $"+{L1MapViewerCore.Program.StartupStopwatch.ElapsedMilliseconds}ms";
            string line = $"{timestamp} {elapsed,-10} {message}";
            Console.WriteLine(line);
            try { File.AppendAllText(_perfLogPath, line + Environment.NewLine); } catch { }
        }

        // é€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼
        private enum PassableEditMode
        {
            None,           // ç„¡ç·¨è¼¯æ¨¡å¼
            SetPassable,    // è¨­å®šç‚ºå¯é€šè¡Œ
            SetImpassable   // è¨­å®šç‚ºä¸å¯é€šè¡Œ
        }
        private PassableEditMode currentPassableEditMode = PassableEditMode.None;
        private Label lblPassabilityHelp; // é€šè¡Œæ€§ç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤

        // å€åŸŸç·¨è¼¯æ¨¡å¼
        private RegionEditMode currentRegionEditMode = RegionEditMode.None;
        private RegionType currentRegionType = RegionType.Normal;
        private Label lblRegionHelp; // å€åŸŸç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
        private Button btnRegionNormal;  // ä¸€èˆ¬å€åŸŸæŒ‰éˆ•
        private Button btnRegionSafe;    // å®‰å…¨å€åŸŸæŒ‰éˆ•
        private Button btnRegionCombat;  // æˆ°é¬¥å€åŸŸæŒ‰éˆ•

        // Layer5 é€æ˜ç·¨è¼¯æ¨¡å¼ï¼ˆç‹€æ…‹å­˜æ–¼ _editState.IsLayer5EditModeï¼‰
        private Label lblLayer5Help; // Layer5 ç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤

        // é è¨­æ“ä½œæç¤ºæ¨™ç±¤
        private Label lblDefaultHint;

        // Undo ç›¸é—œå¸¸æ•¸
        private const int MAX_UNDO_HISTORY = 5;

        // å°åœ°åœ–æ‹–æ‹½
        private bool isMiniMapDragging = false;
        // å°åœ°åœ–æ˜¯å¦æœ‰ç„¦é»ï¼ˆç”¨æ–¼æ–¹å‘éµå°èˆªï¼‰
        private bool isMiniMapFocused = false;

        // ä¸»åœ°åœ–æ‹–æ‹½ï¼ˆä¸­éµæ‹–æ‹½ç§»å‹•è¦–åœ–ï¼‰
        private bool isMainMapDragging = false;
        private Point mainMapDragStartPoint;
        private Point mainMapDragStartScroll;

        // æ‹–æ›³æ•ˆèƒ½ç›£æ§
        private int _dragMoveCount = 0;
        private int _dragPaintCount = 0;
        private Stopwatch _dragSessionSw = new Stopwatch();

        // Viewport æ¸²æŸ“ç›¸é—œ
        private Bitmap _viewportBitmap;  // ç•¶å‰æ¸²æŸ“çš„ Viewport Bitmap
        private readonly object _viewportBitmapLock = new object();  // ä¿è­· _viewportBitmap çš„é–

        // Tile è³‡æ–™å¿«å– - key: "tileId_indexId" (ä½¿ç”¨ ConcurrentDictionary æ”¯æ´å¤šåŸ·è¡Œç·’)
        private System.Collections.Concurrent.ConcurrentDictionary<string, byte[]> tileDataCache = new System.Collections.Concurrent.ConcurrentDictionary<string, byte[]>();

        // æ•´å€‹ .til æª”æ¡ˆå¿«å– - key: tileId, value: parsed tile array
        private System.Collections.Concurrent.ConcurrentDictionary<int, List<byte[]>> _tilFileCache = new System.Collections.Concurrent.ConcurrentDictionary<int, List<byte[]>>();

        // R ç‰ˆ tile å¿«å– - key: tileId, value: isRemaster
        private System.Collections.Concurrent.ConcurrentDictionary<int, bool> _tilRemasterCache = new System.Collections.Concurrent.ConcurrentDictionary<int, bool>();

        // list.til å¿«å– - å„²å­˜ Tile.pak ä¸­ list.til è¨˜éŒ„çš„æœ€å¤§ TileId æ•¸å­—
        private int? _listTilMaxId = null;

        /// <summary>
        /// é è¼‰å…¥åœ°åœ–ç”¨åˆ°çš„æ‰€æœ‰ tile æª”æ¡ˆï¼ˆèƒŒæ™¯åŸ·è¡Œï¼‰
        /// </summary>
        private void PreloadTilesAsync(IEnumerable<S32Data> s32Files)
        {
            Task.Run(() =>
            {
                var sw = Stopwatch.StartNew();

                // æ”¶é›†æ‰€æœ‰ç”¨åˆ°çš„ tileId
                var tileIds = new HashSet<int>();
                foreach (var s32 in s32Files)
                {
                    // Layer1
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32.Layer1[y, x];
                            if (cell != null && cell.TileId >= 0)
                                tileIds.Add(cell.TileId);
                        }
                    }
                    // Layer4
                    foreach (var obj in s32.Layer4)
                    {
                        if (obj.TileId > 0)
                            tileIds.Add(obj.TileId);
                    }
                }

                // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰ til æª”æ¡ˆ
                int loadedCount = 0;
                System.Threading.Tasks.Parallel.ForEach(tileIds, tileId =>
                {
                    _tilFileCache.GetOrAdd(tileId, _ =>
                    {
                        string key = $"{tileId}.til";
                        byte[] data = L1PakReader.UnPack("Tile", key);
                        if (data == null) return null;
                        return L1Til.Parse(data);
                    });
                    System.Threading.Interlocked.Increment(ref loadedCount);
                });

                sw.Stop();
                LogPerf($"[PRELOAD] Loaded {loadedCount} til files in {sw.ElapsedMilliseconds}ms");
            });
        }

        /// <summary>
        /// å»ºç«‹ S32 ç©ºé–“ç´¢å¼•ï¼Œç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾æŒ‡å®šå€åŸŸå…§çš„ S32 æª”æ¡ˆ
        /// </summary>
        private void BuildS32SpatialIndex()
        {
            var sw = Stopwatch.StartNew();
            _s32SpatialIndex.Clear();

            int blockWidth = 64 * 24 * 2;   // 3072
            int blockHeight = 64 * 12 * 2;  // 1536

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                S32Data s32Data = kvp.Value;

                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                // è¨ˆç®—é€™å€‹ S32 block è¦†è“‹çš„æ ¼å­ç¯„åœ
                int minGridX = mx / SPATIAL_GRID_SIZE;
                int minGridY = my / SPATIAL_GRID_SIZE;
                int maxGridX = (mx + blockWidth - 1) / SPATIAL_GRID_SIZE;
                int maxGridY = (my + blockHeight - 1) / SPATIAL_GRID_SIZE;

                // å°‡ S32 åŠ å…¥æ‰€æœ‰è¦†è“‹çš„æ ¼å­
                for (int gx = minGridX; gx <= maxGridX; gx++)
                {
                    for (int gy = minGridY; gy <= maxGridY; gy++)
                    {
                        var key = (gx, gy);
                        if (!_s32SpatialIndex.TryGetValue(key, out var list))
                        {
                            list = new List<string>();
                            _s32SpatialIndex[key] = list;
                        }
                        list.Add(filePath);
                    }
                }
            }

            sw.Stop();
            LogPerf($"[SPATIAL-INDEX] Built index for {_document.S32Files.Count} S32 files, {_s32SpatialIndex.Count} grid cells, in {sw.ElapsedMilliseconds}ms");
        }

        /// <summary>
        /// å»ºç«‹ Layer4 ç©ºé–“ç´¢å¼•ï¼Œç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾é™„è¿‘çš„ Layer4 ç‰©ä»¶
        /// </summary>
        private void BuildLayer4SpatialIndex()
        {
            try
            {
                _layer4SpatialIndex.Build(_document.S32Files.Values);
                LogPerf($"[LAYER4-INDEX] Built index for {_layer4SpatialIndex.TotalObjects:N0} objects, {_layer4SpatialIndex.GridCellCount:N0} grid cells, {_layer4SpatialIndex.GroupCount:N0} groups, in {_layer4SpatialIndex.BuildTimeMs}ms");
            }
            catch (Exception ex)
            {
                LogPerf($"[LAYER4-INDEX] ERROR: {ex.Message}");
                Console.WriteLine($"BuildLayer4SpatialIndex error: {ex}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨ç©ºé–“ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾èˆ‡æŒ‡å®šå€åŸŸç›¸äº¤çš„ S32 æª”æ¡ˆ
        /// </summary>
        private HashSet<string> GetS32FilesInRect(Rectangle worldRect)
        {
            var result = new HashSet<string>();

            // è¨ˆç®— worldRect è¦†è“‹çš„æ ¼å­ç¯„åœ
            int minGridX = worldRect.X / SPATIAL_GRID_SIZE;
            int minGridY = worldRect.Y / SPATIAL_GRID_SIZE;
            int maxGridX = (worldRect.Right - 1) / SPATIAL_GRID_SIZE;
            int maxGridY = (worldRect.Bottom - 1) / SPATIAL_GRID_SIZE;

            // æ”¶é›†æ‰€æœ‰å¯èƒ½ç›¸äº¤çš„ S32
            for (int gx = minGridX; gx <= maxGridX; gx++)
            {
                for (int gy = minGridY; gy <= maxGridY; gy++)
                {
                    if (_s32SpatialIndex.TryGetValue((gx, gy), out var list))
                    {
                        foreach (var filePath in list)
                        {
                            result.Add(filePath);
                        }
                    }
                }
            }

            return result;
        }

        // S32 Block æ¸²æŸ“å¿«å– - key: filePath, value: rendered bitmap (Layer1+Layer4)
        private System.Collections.Concurrent.ConcurrentDictionary<string, Bitmap> _s32BlockCache = new System.Collections.Concurrent.ConcurrentDictionary<string, Bitmap>();

        // è¨˜éŒ„å·²ç¶“ç¹ªè£½åˆ° viewport bitmap çš„ S32 æª”æ¡ˆè·¯å¾‘ï¼ˆç”¨æ–¼å¢é‡æ¸²æŸ“ï¼‰
        private HashSet<string> _renderedS32Blocks = new HashSet<string>();

        // S32 ç©ºé–“ç´¢å¼• - key: (gridX, gridY), value: è©²æ ¼å­å…§çš„ S32 æª”æ¡ˆè·¯å¾‘åˆ—è¡¨
        // æ¯å€‹ S32 block å¤§å°ç‚º 3072x1536ï¼Œä½¿ç”¨æ­¤ç´¢å¼•å¯å¿«é€ŸæŸ¥æ‰¾ worldRect å…§çš„ S32
        private Dictionary<(int gridX, int gridY), List<string>> _s32SpatialIndex = new Dictionary<(int, int), List<string>>();
        private const int SPATIAL_GRID_SIZE = 3072;  // èˆ‡ S32 block å¯¬åº¦ç›¸åŒ

        // Layer4 ç©ºé–“ç´¢å¼• - ç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾é™„è¿‘çš„ Layer4 ç‰©ä»¶
        private Layer4SpatialIndex _layer4SpatialIndex = new Layer4SpatialIndex();

        #region Layer4 Spatial Index Helpers

        /// <summary>
        /// å¢é‡æ–°å¢å–®å€‹ Layer4 ç‰©ä»¶åˆ°ç©ºé–“ç´¢å¼•
        /// </summary>
        private void Layer4Index_Add(S32Data s32Data, ObjectTile obj)
        {
            _layer4SpatialIndex.AddObject(s32Data, obj);
        }

        /// <summary>
        /// å¢é‡æ–°å¢å¤šå€‹ Layer4 ç‰©ä»¶åˆ°ç©ºé–“ç´¢å¼•
        /// </summary>
        private void Layer4Index_AddRange(S32Data s32Data, IEnumerable<ObjectTile> objects)
        {
            _layer4SpatialIndex.AddObjects(s32Data, objects);
        }

        /// <summary>
        /// å¢é‡ç§»é™¤å–®å€‹ Layer4 ç‰©ä»¶å¾ç©ºé–“ç´¢å¼•
        /// </summary>
        private void Layer4Index_Remove(S32Data s32Data, ObjectTile obj)
        {
            _layer4SpatialIndex.RemoveObject(s32Data, obj);
        }

        /// <summary>
        /// å¢é‡ç§»é™¤å¤šå€‹ Layer4 ç‰©ä»¶å¾ç©ºé–“ç´¢å¼•
        /// </summary>
        private void Layer4Index_RemoveRange(S32Data s32Data, IEnumerable<ObjectTile> objects)
        {
            _layer4SpatialIndex.RemoveObjects(s32Data, objects);
        }

        #endregion

        // å‹¾é¸çš„ S32 æª”æ¡ˆå¿«å–ï¼ˆé¿å…æ¯æ¬¡æ¸²æŸ“éƒ½éæ­· UIï¼‰
        private HashSet<string> _checkedS32Files = new HashSet<string>();

        // åœ°åœ–éæ¿¾ç›¸é—œ
        private List<string> allMapItems = new List<string>();  // æ‰€æœ‰åœ°åœ–é …ç›®
        private bool isFiltering = false;  // é˜²æ­¢éæ¿¾æ™‚è§¸ç™¼ SelectedIndexChanged

        public MapForm()
        {
            LogPerf("[FORM-CTOR] Start");
            InitializeComponent();
            this.AllowDrop = true;  // å…è¨±å¾ Explorer æ‹–æ”¾æª”æ¡ˆ
            this.DragEnter += lvMaterials_DragEnter;
            this.DragOver += lvMaterials_DragOver;
            this.DragDrop += lvMaterials_DragDrop;
            LogPerf("[FORM-CTOR] InitializeComponent done");

            // åˆå§‹åŒ–æ¸²æŸ“é˜²æŠ–Timerï¼ˆ300mså»¶é²ï¼‰
            renderDebounceTimer = new System.Windows.Forms.Timer();
            renderDebounceTimer.Interval = 300;
            renderDebounceTimer.Tick += (s, e) =>
            {
                renderDebounceTimer.Stop();
                if (_document.S32Files.Count > 0)
                {
                    RenderS32Map();
                }
            };
            
            // åˆå§‹åŒ–ç¸®æ”¾é˜²æŠ–Timerï¼ˆ150mså»¶é²ï¼‰
            zoomDebounceTimer = new System.Windows.Forms.Timer();
            zoomDebounceTimer.Interval = 150;
            zoomDebounceTimer.Tick += (s, e) =>
            {
                zoomDebounceTimer.Stop();
                ApplyS32Zoom(pendingS32ZoomLevel);
            };
            
            // åˆå§‹åŒ–æ‹–æ›³æ¸²æŸ“å»¶é²Timerï¼ˆ150mså»¶é²ï¼‰
            dragRenderTimer = new System.Windows.Forms.Timer();
            dragRenderTimer.Interval = 150;
            dragRenderTimer.Tick += (s, e) =>
            {
                var timerSw = Stopwatch.StartNew();
                LogPerf($"[DRAG-TIMER] tick start");
                dragRenderTimer.Stop();
                CheckAndRerenderIfNeeded();
                timerSw.Stop();
                LogPerf($"[DRAG-TIMER] tick end, total={timerSw.ElapsedMilliseconds}ms");
            };

            // åˆå§‹åŒ– Layer8 å‹•ç•«è¨ˆæ™‚å™¨ï¼ˆ100ms æ¯å¸§ï¼‰
            _layer8AnimTimer = new System.Windows.Forms.Timer();
            _layer8AnimTimer.Interval = 100;
            _layer8AnimTimer.Tick += (s, e) =>
            {
                if (_editState.EnabledLayer8Items.Count == 0)
                {
                    _layer8AnimTimer.Stop();
                    return;
                }

                // æ›´æ–°æ‰€æœ‰å•Ÿç”¨é …ç›®çš„å¸§ç´¢å¼•
                var keys = _layer8AnimFrame.Keys.ToList();
                foreach (var key in keys)
                {
                    _layer8AnimFrame[key]++;
                }

                // åªé‡ç¹ª L8 å‹•ç•«è¦†è“‹å±¤ï¼Œä¸å½±éŸ¿åœ°åœ–å’Œå…¶ä»–åœ–å±¤
                _mapViewerControl?.InvalidateAnimationOverlay();
            };

            // è¨»å†Šæ»‘é¼ æ»¾è¼ªäº‹ä»¶ç”¨æ–¼ç¸®æ”¾
            this.panel1.MouseWheel += Panel1_MouseWheel;

            // ç¢ºä¿ panel1 å¯ä»¥æ¥æ”¶ç„¦é»
            this.panel1.TabStop = true;

            // ç•¶æ»‘é¼ é€²å…¥ panel1 æ™‚è‡ªå‹•å–å¾—ç„¦é»
            this.panel1.MouseEnter += (s, e) => this.panel1.Focus();

            // è¨­ç½® PictureBox çš„ SizeMode ç‚º StretchImage
            this.pictureBox1.SizeMode = PictureBoxSizeMode.StretchImage;
            this.pictureBox2.SizeMode = PictureBoxSizeMode.StretchImage;
            this.pictureBox3.SizeMode = PictureBoxSizeMode.StretchImage;
            this.pictureBox4.SizeMode = PictureBoxSizeMode.StretchImage;

            // è¨»å†Š S32 ç·¨è¼¯å™¨çš„æ»‘é¼ æ»¾è¼ªäº‹ä»¶
            this.s32MapPanel.MouseWheel += S32MapPanel_MouseWheel;
            this.s32MapPanel.TabStop = true;
            this.s32MapPanel.MouseEnter += (s, e) => this.s32MapPanel.Focus();

            // å•Ÿç”¨é›™ç·©è¡ä»¥æ¸›å°‘é–ƒçˆ
            typeof(Panel).InvokeMember("DoubleBuffered",
                System.Reflection.BindingFlags.SetProperty | System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic,
                null, this.s32MapPanel, new object[] { true });
            // MapViewerControl å·²å…§å»ºé›™ç·©è¡ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š

            // è¨­å®šå…±äº«çš„ ViewState
            _mapViewerControl.SetViewState(_viewState);

            // è¨‚é–± MapViewerControl äº‹ä»¶
            _mapViewerControl.MapMouseDown += MapViewerControl_MapMouseDown;
            _mapViewerControl.MapMouseMove += MapViewerControl_MapMouseMove;
            _mapViewerControl.MapMouseUp += MapViewerControl_MapMouseUp;
            _mapViewerControl.PaintOverlay += MapViewerControl_PaintOverlay;
            _mapViewerControl.CoordinateChanged += MapViewerControl_CoordinateChanged;
            _mapViewerControl.RenderCompleted += MapViewerControl_RenderCompleted;

            // æ‹–æ›³ç§»å‹•è¦–åœ–æ™‚æ›´æ–°å°åœ°åœ–ï¼ˆä½¿ç”¨é˜²æŠ–é¿å…éåº¦æ›´æ–°ï¼‰
            // æ³¨æ„ï¼šç¾åœ¨ä½¿ç”¨ä¸­éµæ‹–æ›³ç§»å‹•è¦–åœ–ï¼Œä¸å†ä½¿ç”¨ Panel AutoScroll

            // å»ºç«‹é€šè¡Œæ€§ç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
            lblPassabilityHelp = new Label
            {
                AutoSize = true,
                BackColor = Color.FromArgb(200, 30, 30, 30),
                ForeColor = Color.White,
                Font = new Font("Microsoft JhengHei", 9, FontStyle.Regular),
                Padding = new Padding(8),
                Visible = false,
                BorderStyle = BorderStyle.FixedSingle
            };
            this.s32MapPanel.Controls.Add(lblPassabilityHelp);
            lblPassabilityHelp.BringToFront();
            lblPassabilityHelp.Location = new Point(10, 10);

            // å»ºç«‹å€åŸŸç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
            lblRegionHelp = new Label
            {
                AutoSize = true,
                BackColor = Color.FromArgb(200, 40, 80, 40),
                ForeColor = Color.White,
                Font = new Font("Microsoft JhengHei", 9, FontStyle.Regular),
                Padding = new Padding(8),
                Visible = false,
                BorderStyle = BorderStyle.FixedSingle
            };
            this.s32MapPanel.Controls.Add(lblRegionHelp);
            lblRegionHelp.BringToFront();
            lblRegionHelp.Location = new Point(10, 10);

            // å»ºç«‹é è¨­æ“ä½œæç¤ºæ¨™ç±¤
            lblDefaultHint = new Label
            {
                AutoSize = true,
                BackColor = Color.FromArgb(180, 50, 50, 50),
                ForeColor = Color.White,
                Font = new Font("Microsoft JhengHei", 9, FontStyle.Regular),
                Padding = new Padding(8),
                Text = LocalizationManager.L("Hint_MouseControls"),
                Visible = true,
                BorderStyle = BorderStyle.FixedSingle
            };
            this.s32MapPanel.Controls.Add(lblDefaultHint);
            lblDefaultHint.BringToFront();
            lblDefaultHint.Location = new Point(10, 10);

            // å»ºç«‹å€åŸŸé¡å‹åˆ‡æ›æŒ‰éˆ•
            btnRegionNormal = new Button
            {
                Text = "ä¸€èˆ¬",
                Size = new Size(50, 25),
                Location = new Point(10, 85),
                BackColor = Color.FromArgb(200, 200, 200),
                FlatStyle = FlatStyle.Flat,
                Visible = false
            };
            btnRegionNormal.Click += (s, ev) => { currentRegionType = RegionType.Normal; UpdateRegionHelpLabel(); };
            this.s32MapPanel.Controls.Add(btnRegionNormal);
            btnRegionNormal.BringToFront();

            btnRegionSafe = new Button
            {
                Text = "å®‰å…¨",
                Size = new Size(50, 25),
                Location = new Point(65, 85),
                BackColor = Color.FromArgb(100, 150, 255),
                FlatStyle = FlatStyle.Flat,
                Visible = false
            };
            btnRegionSafe.Click += (s, ev) => { currentRegionType = RegionType.Safe; UpdateRegionHelpLabel(); };
            this.s32MapPanel.Controls.Add(btnRegionSafe);
            btnRegionSafe.BringToFront();

            btnRegionCombat = new Button
            {
                Text = "æˆ°é¬¥",
                Size = new Size(50, 25),
                Location = new Point(120, 85),
                BackColor = Color.FromArgb(180, 100, 255),
                FlatStyle = FlatStyle.Flat,
                Visible = false
            };
            btnRegionCombat.Click += (s, ev) => { currentRegionType = RegionType.Combat; UpdateRegionHelpLabel(); };
            this.s32MapPanel.Controls.Add(btnRegionCombat);
            btnRegionCombat.BringToFront();

            // è¨»å†Š F5 å¿«æ·éµé‡æ–°è¼‰å…¥
            this.KeyPreview = true;
            this.KeyDown += MapForm_KeyDown;

            // è¨‚é–±èªè¨€è®Šæ›´äº‹ä»¶
            LocalizationManager.LanguageChanged += OnLanguageChanged;
            UpdateLanguageMenuCheckmarks();
            UpdateLocalization();

            LogPerf("[FORM-CTOR] End");
        }

        // èªè¨€è®Šæ›´äº‹ä»¶è™•ç†
        private void OnLanguageChanged(object sender, EventArgs e)
        {
            if (InvokeRequired)
                Invoke(new Action(UpdateLocalization));
            else
                UpdateLocalization();
        }

        // èªè¨€é¸å–®é …ç›®é»æ“Šäº‹ä»¶
        private void LanguageMenuItem_Click(object sender, EventArgs e)
        {
            if (sender is ToolStripMenuItem menuItem && menuItem.Tag is string langCode)
            {
                LocalizationManager.SetLanguage(langCode);
                UpdateLanguageMenuCheckmarks();
            }
        }

        // æ›´æ–°èªè¨€é¸å–®å‹¾é¸ç‹€æ…‹
        private void UpdateLanguageMenuCheckmarks()
        {
            string currentLang = LocalizationManager.CurrentLanguage;
            langZhTWToolStripMenuItem.Checked = currentLang == "zh-TW";
            langJaJPToolStripMenuItem.Checked = currentLang == "ja-JP";
            langEnUSToolStripMenuItem.Checked = currentLang == "en-US";
        }

        // æ›´æ–°æ‰€æœ‰ UI æ–‡å­—
        private void UpdateLocalization()
        {
            // é¸å–®é …ç›®
            openToolStripMenuItem.Text = LocalizationManager.L("Menu_File_OpenClient");
            importMaterialToolStripMenuItem.Text = LocalizationManager.L("Menu_Import_Material");
            importFs32ToNewMapToolStripMenuItem.Text = LocalizationManager.L("Menu_Import_Fs32ToNewMap");
            exportToolStripMenuItem.Text = LocalizationManager.L("Menu_Export_ServerPassability");
            exportL1JToolStripMenuItem.Text = LocalizationManager.L("Menu_Export_L1JFormat");
            exportDIRToolStripMenuItem.Text = LocalizationManager.L("Menu_Export_DIRFormat");
            discordToolStripMenuItem.Text = LocalizationManager.L("Menu_Help_Discord");

            // é ç±¤
            tabMapPreview.Text = LocalizationManager.L("Tab_MapPreview");
            tabS32Editor.Text = LocalizationManager.L("Tab_S32Editor");

            // å·¦ä¸‹è§’ Tab é ç±¤
            tabMapList.Text = LocalizationManager.L("Tab_MapList");
            tabS32Files.Text = LocalizationManager.L("Tab_S32Files");
            txtMapSearch.PlaceholderText = LocalizationManager.L("Placeholder_SearchMap");

            // åœ–å±¤æ§åˆ¶æ¨™ç±¤
            chkLayer1.Text = LocalizationManager.L("Layer_1");
            chkLayer2.Text = LocalizationManager.L("Layer_2");
            chkLayer3.Text = LocalizationManager.L("Layer_3");
            chkLayer4.Text = LocalizationManager.L("Layer_4");
            chkShowPassable.Text = LocalizationManager.L("Layer_Passable");
            chkShowGrid.Text = LocalizationManager.L("Layer_Grid");
            chkShowS32Boundary.Text = LocalizationManager.L("Layer_S32Border");
            chkShowSafeZones.Text = LocalizationManager.L("Layer_SafeZones");
            chkShowCombatZones.Text = LocalizationManager.L("Layer_CombatZones");

            // S32 ç·¨è¼¯é¢æ¿æŒ‰éˆ•
            btnReloadMap.Text = LocalizationManager.L("Button_ReloadF5");
            btnSaveS32.Text = LocalizationManager.L("Button_SaveS32");
            btnCopySettings.Text = LocalizationManager.L("Button_CopySettings");
            btnCopyMapCoords.Text = LocalizationManager.L("Button_CopyMapCoords");
            btnImportFs32.Text = LocalizationManager.L("Button_ImportFs32");
            btnSetPassable.Text = LocalizationManager.L("Button_SetPassable");
            btnSetImpassable.Text = LocalizationManager.L("Button_SetImpassable");
            btnEditLayer5.Text = LocalizationManager.L("Button_EditLayer5");
            btnRegionEdit.Text = LocalizationManager.L("Button_RegionEdit");

            // S32 æª”æ¡ˆåˆ—è¡¨æŒ‰éˆ•
            btnS32SelectAll.Text = LocalizationManager.L("Button_SelectAll");
            btnS32SelectNone.Text = LocalizationManager.L("Button_SelectNone");

            // å·¥å…·åˆ—é …ç›®
            toolStripJumpLabel.Text = LocalizationManager.L("Label_GameCoord") + ":";
            toolStripJumpButton.Text = LocalizationManager.L("Button_JumpToCoord");

            // å³å´å·¥å…·æŒ‰éˆ• - ä¸Šæ–¹å·¥å…·
            btnToolCopy.Text = LocalizationManager.L("Button_Copy");
            btnToolPaste.Text = LocalizationManager.L("Button_Paste");
            btnToolDelete.Text = LocalizationManager.L("Button_Delete");
            btnToolUndo.Text = LocalizationManager.L("Button_Undo");
            btnToolRedo.Text = LocalizationManager.L("Button_Redo");
            btnToolSave.Text = LocalizationManager.L("Button_Save");
            btnToolCellInfo.Text = LocalizationManager.L("Button_Details");
            btnToolReplaceTile.Text = LocalizationManager.L("Button_Replace");
            btnToolAddS32.Text = LocalizationManager.L("Button_New");
            btnToolClearLayer7.Text = LocalizationManager.L("Button_ClearL7");
            btnToolClearCell.Text = LocalizationManager.L("Button_ClearCell");
            // å³å´å·¥å…·æŒ‰éˆ• - ä¸‹æ–¹æŸ¥è©¢
            btnToolCheckL1.Text = LocalizationManager.L("Button_CheckL1");
            btnToolCheckL2.Text = LocalizationManager.L("Button_ClearL2");
            btnToolCheckL4.Text = LocalizationManager.L("Button_CheckL4");
            btnToolCheckL5.Text = LocalizationManager.L("Button_CheckL5");
            btnToolCheckL6.Text = LocalizationManager.L("Button_CheckL6");
            btnToolCheckL7.Text = LocalizationManager.L("Button_CheckL7");
            btnToolCheckL8.Text = LocalizationManager.L("Button_CheckL8");

            // æµ®å‹•åœ–å±¤é¢æ¿
            lblLayerIcon.Text = "ğŸ“‘ " + LocalizationManager.L("Label_Layers");
            chkFloatLayer1.Text = LocalizationManager.L("Layer_FloatL1");
            chkFloatLayer2.Text = LocalizationManager.L("Layer_FloatL2");
            chkFloatLayer4.Text = LocalizationManager.L("Layer_FloatL4");
            chkFloatLayer5.Text = LocalizationManager.L("Layer_FloatL5");
            chkFloatPassable.Text = LocalizationManager.L("Layer_FloatPassable");
            chkFloatGrid.Text = LocalizationManager.L("Layer_FloatGrid");
            chkFloatS32Boundary.Text = LocalizationManager.L("Layer_FloatS32Border");
            chkFloatSafeZones.Text = LocalizationManager.L("Layer_FloatSafeZones");
            chkFloatCombatZones.Text = LocalizationManager.L("Layer_FloatCombatZones");

            // Tile é¢æ¿
            txtTileSearch.PlaceholderText = LocalizationManager.L("Placeholder_SearchTileId");
            lblTileList.Text = string.Format(LocalizationManager.L("Label_TileListCount"), lvTiles.Items.Count);
            lblMaterials.Text = LocalizationManager.L("Label_RecentMaterials");
            lblGroupThumbnails.Text = LocalizationManager.L("Label_GroupThumbnails");
            btnMoreMaterials.Text = LocalizationManager.L("Button_More");
            btnShowAllGroups.Text = LocalizationManager.L("Button_ShowAll");

            // æ»‘é¼ æ“ä½œæç¤º
            lblDefaultHint.Text = LocalizationManager.L("Hint_MouseControls");

            // ç‹€æ…‹åˆ—
            if (toolStripStatusLabel1.Text == "å°±ç·’" || toolStripStatusLabel1.Text == "Ready" || toolStripStatusLabel1.Text == "æº–å‚™å®Œäº†")
                toolStripStatusLabel1.Text = LocalizationManager.L("Status_Ready");
        }

        // è™•ç†å¿«æ·éµ
        private void MapForm_KeyDown(object sender, KeyEventArgs e)
        {
            // F5: é‡æ–°è¼‰å…¥ç•¶å‰åœ°åœ–
            if (e.KeyCode == Keys.F5)
            {
                e.Handled = true;
                ReloadCurrentMap();
            }
            // F6: åˆ†æ Layer3 å±¬æ€§å€¼çµ±è¨ˆ
            else if (e.KeyCode == Keys.F6)
            {
                e.Handled = true;
                AnalyzeLayer3Attributes();
            }
            // Ctrl+C: è¤‡è£½é¸å–å€åŸŸ
            else if (e.Control && e.KeyCode == Keys.C)
            {
                e.Handled = true;
                CopySelectedCells();
            }
            // Ctrl+V: è²¼ä¸Šé¸å–å€åŸŸ
            else if (e.Control && e.KeyCode == Keys.V)
            {
                e.Handled = true;
                PasteSelectedCells();
            }
            // Escape: å–æ¶ˆè¤‡è£½/è²¼ä¸Šæ¨¡å¼æˆ–å–æ¶ˆå¤šé‚Šå½¢ç¹ªè£½
            else if (e.KeyCode == Keys.Escape)
            {
                e.Handled = true;
                // å„ªå…ˆå–æ¶ˆå¤šé‚Šå½¢ç¹ªè£½
                if (_editState.IsDrawingPassabilityPolygon)
                {
                    _editState.PassabilityPolygonPoints.Clear();
                    _editState.IsDrawingPassabilityPolygon = false;
                    _mapViewerControl.Refresh();
                    this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆå¤šé‚Šå½¢ç¹ªè£½";
                }
                // å–æ¶ˆç´ æè²¼ä¸Šæ¨¡å¼
                else if (_pendingMaterial != null)
                {
                    CancelMaterialPasteMode();
                    this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆç´ æè²¼ä¸Šæ¨¡å¼";
                }
                else
                {
                    CancelLayer4CopyPaste();
                }
            }
            // Ctrl+Z: é‚„åŸ
            else if (e.Control && e.KeyCode == Keys.Z)
            {
                e.Handled = true;
                UndoLastAction();
            }
            // Ctrl+Y: é‡åš
            else if (e.Control && e.KeyCode == Keys.Y)
            {
                e.Handled = true;
                RedoLastAction();
            }
            // Del: åˆªé™¤é¸å–å€åŸŸå…§çš„ Layer4 ç‰©ä»¶
            else if (e.KeyCode == Keys.Delete)
            {
                e.Handled = true;
                DeleteSelectedLayer4Objects();
            }
            // 1/2/3 éµï¼šå€åŸŸç·¨è¼¯æ¨¡å¼ä¸‹åˆ‡æ›å€åŸŸé¡å‹
            else if (currentRegionEditMode == RegionEditMode.SetRegion)
            {
                RegionType newRegionType = currentRegionType;
                string newRegionName = "";

                if (e.KeyCode == Keys.D1 || e.KeyCode == Keys.NumPad1)
                {
                    newRegionType = RegionType.Normal;
                    newRegionName = "ä¸€èˆ¬å€åŸŸ";
                    e.Handled = true;
                }
                else if (e.KeyCode == Keys.D2 || e.KeyCode == Keys.NumPad2)
                {
                    newRegionType = RegionType.Safe;
                    newRegionName = "å®‰å…¨å€åŸŸ";
                    e.Handled = true;
                }
                else if (e.KeyCode == Keys.D3 || e.KeyCode == Keys.NumPad3)
                {
                    newRegionType = RegionType.Combat;
                    newRegionName = "æˆ°é¬¥å€åŸŸ";
                    e.Handled = true;
                }

                if (newRegionType != currentRegionType)
                {
                    currentRegionType = newRegionType;
                    this.toolStripStatusLabel1.Text = $"å€åŸŸè¨­ç½®æ¨¡å¼ ({newRegionName})ï¼šç›´æ¥é»æ“Šæ ¼å­è¨­å®šå€åŸŸé¡å‹ | 1/2/3éµåˆ‡æ›å€åŸŸé¡å‹";
                    UpdateRegionHelpLabel();
                }
            }
            // æ–¹å‘éµï¼šå°åœ°åœ–ç„¦é»æ™‚ç§»å‹•è¦–åœ–
            else if (isMiniMapFocused && (e.KeyCode == Keys.Up || e.KeyCode == Keys.Down ||
                                          e.KeyCode == Keys.Left || e.KeyCode == Keys.Right))
            {
                e.Handled = true;
                MoveMiniMapByArrowKey(e.KeyCode);
            }
        }

        // åˆªé™¤é¸å–å€åŸŸå…§çš„ Layer4 ç‰©ä»¶
        private void DeleteSelectedLayer4Objects()
        {
            if (!isLayer4CopyMode || _editState.SelectedCells.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "è«‹å…ˆä½¿ç”¨å·¦éµé¸å–è¦åˆªé™¤çš„å€åŸŸ";
                return;
            }

            // å‘¼å«ç¾æœ‰çš„æ‰¹æ¬¡åˆªé™¤åŠŸèƒ½
            DeleteAllLayer4ObjectsInRegion(_editState.SelectedCells);

            // æ¸…é™¤é¸å–ç‹€æ…‹
            isLayer4CopyMode = false;
            selectedRegion = new Rectangle();
            copyRegionBounds = new Rectangle();
            _editState.SelectedCells.Clear();
            _mapViewerControl.Refresh();
        }

        // è¤‡è£½ Layer4 ç‰©ä»¶
        private void CopySelectedCells()
        {
            if (!isLayer4CopyMode || copyRegionBounds.Width == 0 || copyRegionBounds.Height == 0)
            {
                this.toolStripStatusLabel1.Text = "è«‹å…ˆä½¿ç”¨ å·¦éµ é¸å–è¦è¤‡è£½çš„å€åŸŸ";
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡ä»»ä½•å±¤
            bool copyLayer1 = copySettingLayer1;
            bool copyLayer3 = copySettingLayer3;
            bool copyLayer4 = copySettingLayer4;
            bool copyLayer5 = copySettingLayer5;
            bool copyLayer6to8 = copySettingLayer6to8;

            if (!copyLayer1 && !copyLayer3 && !copyLayer4 && !copyLayer5 && !copyLayer6to8)
            {
                this.toolStripStatusLabel1.Text = "è«‹é»æ“Šã€Œè¤‡è£½è¨­å®š...ã€æŒ‰éˆ•é¸æ“‡è¦è¤‡è£½çš„åœ–å±¤";
                return;
            }

            _editState.CellClipboard.Clear();

            // ä½¿ç”¨å·²ç¶“åœ¨ MouseMove/MouseUp ä¸­è¨ˆç®—å¥½çš„ _editState.SelectedCells
            List<SelectedCell> selectedCells = _editState.SelectedCells;

            if (selectedCells.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "é¸å–å€åŸŸå…§æ²’æœ‰ä»»ä½•æ ¼å­";
                return;
            }

            // è¨ˆç®—æ‰€æœ‰æ ¼å­çš„å…¨åŸŸ Layer1 åº§æ¨™ç¯„åœ
            int minGlobalX = int.MaxValue, minGlobalY = int.MaxValue;
            foreach (var cell in selectedCells)
            {
                int globalX = cell.S32Data.SegInfo.nLinBeginX * 2 + cell.LocalX;
                int globalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                if (globalX < minGlobalX) minGlobalX = globalX;
                if (globalY < minGlobalY) minGlobalY = globalY;
            }

            int layer1Count = 0, layer3Count = 0, layer4Count = 0;

            // æ”¶é›†æ¯å€‹æ ¼å­çš„è³‡æ–™
            foreach (var cell in selectedCells)
            {
                int globalX = cell.S32Data.SegInfo.nLinBeginX * 2 + cell.LocalX;
                int globalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;

                var cellData = new CopiedCellData
                {
                    RelativeX = globalX - minGlobalX,
                    RelativeY = globalY - minGlobalY
                };

                // Layer1 è³‡æ–™ï¼ˆåœ°æ¿ï¼‰- ä¸€å€‹ Layer3 æ ¼å­å°æ‡‰å…©å€‹ Layer1 æ ¼å­
                if (copyLayer1)
                {
                    int layer1X = cell.LocalX;  // å¶æ•¸
                    if (layer1X >= 0 && layer1X < 128 && cell.LocalY >= 0 && cell.LocalY < 64)
                    {
                        var cell1 = cell.S32Data.Layer1[cell.LocalY, layer1X];
                        if (cell1 != null)
                        {
                            cellData.Layer1Cell1 = new TileCell { X = cell1.X, Y = cell1.Y, TileId = cell1.TileId, IndexId = cell1.IndexId };
                            if (cell1.TileId > 0) layer1Count++;
                        }
                    }
                    if (layer1X + 1 >= 0 && layer1X + 1 < 128 && cell.LocalY >= 0 && cell.LocalY < 64)
                    {
                        var cell2 = cell.S32Data.Layer1[cell.LocalY, layer1X + 1];
                        if (cell2 != null)
                        {
                            cellData.Layer1Cell2 = new TileCell { X = cell2.X, Y = cell2.Y, TileId = cell2.TileId, IndexId = cell2.IndexId };
                            if (cell2.TileId > 0) layer1Count++;
                        }
                    }
                }

                // Layer3 è³‡æ–™ï¼ˆå±¬æ€§ï¼‰
                if (copyLayer3)
                {
                    int layer3X = cell.LocalX / 2;  // Layer3 åº§æ¨™
                    if (layer3X >= 0 && layer3X < 64 && cell.LocalY >= 0 && cell.LocalY < 64)
                    {
                        var attr = cell.S32Data.Layer3[cell.LocalY, layer3X];
                        if (attr != null)
                        {
                            cellData.Layer3Attr = new MapAttribute { Attribute1 = attr.Attribute1, Attribute2 = attr.Attribute2 };
                            layer3Count++;
                        }
                    }
                }

                // Layer4 è³‡æ–™å·²ç§»è‡³è·¨å€å¡Šæœç´¢çµ±ä¸€è™•ç†

                _editState.CellClipboard.Add(cellData);
            }

            // Layer4 ç‰©ä»¶æœç´¢ï¼šéæ­·æ‰€æœ‰ S32ï¼Œæ‰¾å‡ºåº§æ¨™ç²¾ç¢ºè½åœ¨é¸å–ç¯„åœå…§çš„ç‰©ä»¶
            if (copyLayer4 && selectedCells.Count > 0)
            {
                // å»ºç«‹é¸å–æ ¼å­çš„å…¨åŸŸåº§æ¨™é›†åˆ (Layer3 åº§æ¨™ç³»)
                var selectedGlobalCells = new HashSet<(int x, int y)>();
                foreach (var cell in selectedCells)
                {
                    int globalL1X = cell.S32Data.SegInfo.nLinBeginX*2 + cell.LocalX;
                    int globalL1Y = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                    selectedGlobalCells.Add((globalL1X, globalL1Y));
                    selectedGlobalCells.Add((globalL1X +1 , globalL1Y));
                }

                // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆæœç´¢ç‰©ä»¶ï¼ˆç²¾ç¢ºåŒ¹é…é¸å–æ ¼å­ï¼‰
                foreach (var s32Data in _document.S32Files.Values)
                {
                    int segStartX = s32Data.SegInfo.nLinBeginX;
                    int segStartY = s32Data.SegInfo.nLinBeginY;

                    for (int i = 0; i < s32Data.Layer4.Count; i++)
                    {
                        var obj = s32Data.Layer4[i];

                        // è¨ˆç®—ç‰©ä»¶çš„å…¨åŸŸåº§æ¨™ (è€ƒæ…®ç‰©ä»¶ X å¯èƒ½è¶…å‡º 0-127 ç¯„åœ)
                        int objGlobalL3X = segStartX + obj.X / 2;
                        int objGlobalL1X = segStartX*2 + obj.X ;
                        int objGlobalL3Y = segStartY + obj.Y;

                        // ç²¾ç¢ºæª¢æŸ¥æ˜¯å¦åœ¨é¸å–çš„æ ¼å­å…§
                        if (selectedGlobalCells.Contains((objGlobalL1X, objGlobalL3Y)))
                        {
                            // obj.X æœ¬èº«å°±æ˜¯ Layer1 å±€éƒ¨åº§æ¨™ (0-127)
                            int objGlobalLayer1X = segStartX * 2 + obj.X;
                            int objGlobalY = segStartY + obj.Y;
                            int relX = objGlobalLayer1X - minGlobalX;
                            int relY = objGlobalY - minGlobalY;

                            bool alreadyCopied = _editState.CellClipboard.Any(cd =>
                                cd.Layer4Objects.Any(o =>
                                    o.RelativeX == relX && o.RelativeY == relY && o.GroupId == obj.GroupId && o.TileId == obj.TileId));

                            if (!alreadyCopied)
                            {
                                // å»ºç«‹æ–°çš„ cellData ä¾†å­˜æ”¾ç‰©ä»¶
                                var objCellData = new CopiedCellData
                                {
                                    RelativeX = relX,
                                    RelativeY = relY
                                };
                                objCellData.Layer4Objects.Add(new CopiedObjectTile
                                {
                                    RelativeX = relX,
                                    RelativeY = relY,
                                    GroupId = obj.GroupId,
                                    Layer = obj.Layer,
                                    IndexId = obj.IndexId,
                                    TileId = obj.TileId,
                                    OriginalIndex = i,
                                    // è¨˜éŒ„ Layer1 åº§æ¨™ç³»çµ± (0-127) çš„å±€éƒ¨åº§æ¨™
                                    OriginalLocalLayer1X = obj.X,
                                    OriginalLocalY = obj.Y
                                });
                                _editState.CellClipboard.Add(objCellData);
                                layer4Count++;
                            }
                        }
                    }
                }
            }

            _editState.SourceMapId = _document.MapId;
            _editState.CopySourceOrigin = new Point(minGlobalX, minGlobalY);  // è¨˜éŒ„è¤‡è£½æ™‚çš„åŸé»

            // è¤‡è£½ Layer2 å’Œ Layer5-8 è³‡æ–™ï¼ˆå¾æ‰€æœ‰æ¶‰åŠçš„ S32 æ”¶é›†ï¼Œæ ¹æ“šè¨­å®šï¼‰
            _editState.Layer2Clipboard.Clear();
            _editState.Layer5Clipboard.Clear();
            _editState.Layer6Clipboard.Clear();
            _editState.Layer7Clipboard.Clear();
            _editState.Layer8Clipboard.Clear();
            bool copyLayer2 = copySettingLayer2;

            var processedS32 = new HashSet<S32Data>();
            foreach (var cell in selectedCells)
            {
                if (!processedS32.Contains(cell.S32Data))
                {
                    processedS32.Add(cell.S32Data);
                    // Layer2
                    if (copyLayer2)
                    {
                        foreach (var item in cell.S32Data.Layer2)
                        {
                            // é¿å…é‡è¤‡åŠ å…¥
                            if (!_editState.Layer2Clipboard.Any(l => l.X == item.X && l.Y == item.Y && l.TileId == item.TileId))
                            {
                                _editState.Layer2Clipboard.Add(new Layer2Item
                                {
                                    X = item.X,
                                    Y = item.Y,
                                    IndexId = item.IndexId,
                                    TileId = item.TileId,
                                    UK = item.UK
                                });
                            }
                        }
                    }
                }
            }

            // Layer5-8ï¼šåªè¤‡è£½åº§æ¨™è½åœ¨é¸å–æ ¼å­ç¯„åœå…§çš„é …ç›®
            if (copyLayer5 || copyLayer6to8)
            {
                // å»ºç«‹é¸å–æ ¼å­çš„æœ¬åœ°åº§æ¨™é›†åˆï¼ˆæŒ‰ S32 æª”æ¡ˆåˆ†çµ„ï¼‰
                // Layer5 ä½¿ç”¨ Layer1 åº§æ¨™ç³» (X=0-127, Y=0-63)
                // Layer7 ä½¿ç”¨ Layer3 åº§æ¨™ç³» (X=0-63, Y=0-63)
                var selectedL1CellsByS32 = new Dictionary<S32Data, HashSet<(int x, int y)>>();  // Layer5 ç”¨
                var selectedL3CellsByS32 = new Dictionary<S32Data, HashSet<(int x, int y)>>();  // Layer7 ç”¨
                foreach (var cell in selectedCells)
                {
                    if (!selectedL1CellsByS32.ContainsKey(cell.S32Data))
                    {
                        selectedL1CellsByS32[cell.S32Data] = new HashSet<(int, int)>();
                        selectedL3CellsByS32[cell.S32Data] = new HashSet<(int, int)>();
                    }
                    // Layer5: X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                    // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆLocalX å’Œ LocalX+1ï¼‰
                    selectedL1CellsByS32[cell.S32Data].Add((cell.LocalX, cell.LocalY));
                    if (cell.LocalX + 1 < 128)
                    {
                        selectedL1CellsByS32[cell.S32Data].Add((cell.LocalX + 1, cell.LocalY));
                    }
                    // Layer7: X æ˜¯ 0-63 (Layer3 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                    int localL3X = cell.LocalX / 2;
                    selectedL3CellsByS32[cell.S32Data].Add((localL3X, cell.LocalY));
                }

                foreach (var kvp in selectedL1CellsByS32)
                {
                    var s32Data = kvp.Key;
                    var l1Cells = kvp.Value;
                    var l3Cells = selectedL3CellsByS32[s32Data];
                    int segStartX = s32Data.SegInfo.nLinBeginX;
                    int segStartY = s32Data.SegInfo.nLinBeginY;

                    // Layer5 - é€æ˜åœ–å¡Šï¼ˆæª¢æŸ¥ X, Y æ˜¯å¦åœ¨é¸å–ç¯„åœå…§ï¼‰
                    if (copyLayer5)
                    {
                        foreach (var item in s32Data.Layer5)
                        {
                            // Layer5 çš„ X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                            if (l1Cells.Contains((item.X, item.Y)))
                            {
                                // è¨ˆç®—ç›¸å°æ–¼è¤‡è£½åŸé»çš„å…¨åŸŸåº§æ¨™
                                int globalL1X = segStartX * 2 + item.X;
                                int globalY = segStartY + item.Y;
                                int relX = globalL1X - minGlobalX;
                                int relY = globalY - minGlobalY;

                                // å„²å­˜ç›¸å°åº§æ¨™ï¼ˆä½¿ç”¨ X, Y æ¬„ä½æš«å­˜ï¼‰
                                if (!_editState.Layer5Clipboard.Any(l => l.X == relX && l.Y == relY && l.ObjectIndex == item.ObjectIndex))
                                {
                                    _editState.Layer5Clipboard.Add(new Layer5Item { X = (byte)relX, Y = (byte)relY, ObjectIndex = item.ObjectIndex, Type = item.Type });
                                }
                            }
                        }
                    }

                    // Layer6 - ä½¿ç”¨çš„ TilIdï¼ˆåˆä½µä¸é‡è¤‡çš„ï¼Œé€™å€‹æ˜¯æ•´å€‹ S32 çš„ï¼‰
                    if (copyLayer6to8)
                    {
                        foreach (var tilId in s32Data.Layer6)
                        {
                            if (!_editState.Layer6Clipboard.Contains(tilId))
                            {
                                _editState.Layer6Clipboard.Add(tilId);
                            }
                        }
                    }

                    // Layer7 - å‚³é€é»ï¼ˆæª¢æŸ¥ X, Y æ˜¯å¦åœ¨é¸å–ç¯„åœå…§ï¼‰
                    if (copyLayer6to8)
                    {
                        foreach (var item in s32Data.Layer7)
                        {
                            // Layer7 çš„ X, Y æ˜¯ 64x64 åº§æ¨™ç³» (Layer3)
                            if (l3Cells.Contains((item.X, item.Y)))
                            {
                                // è¨ˆç®—ç›¸å°æ–¼è¤‡è£½åŸé»çš„åº§æ¨™ï¼ˆLayer3 åº§æ¨™ç³»ï¼‰
                                int globalL3X = segStartX + item.X;
                                int globalY = segStartY + item.Y;
                                int relL3X = globalL3X - (minGlobalX / 2);  // minGlobalX æ˜¯ Layer1 åº§æ¨™ï¼Œé™¤ä»¥ 2 å¾—åˆ° Layer3
                                int relY = globalY - minGlobalY;

                                if (!_editState.Layer7Clipboard.Any(l => l.Name == item.Name && l.X == relL3X && l.Y == relY))
                                {
                                    _editState.Layer7Clipboard.Add(new Layer7Item { Name = item.Name, X = (byte)relL3X, Y = (byte)relY, TargetMapId = item.TargetMapId, PortalId = item.PortalId });
                                }
                            }
                        }

                        // Layer8 - ç‰¹æ•ˆï¼ˆæª¢æŸ¥ X, Y æ˜¯å¦åœ¨é¸å–ç¯„åœå…§ï¼‰
                        // Layer8 çš„ X, Y å¯èƒ½æ˜¯åƒç´ åº§æ¨™ï¼Œéœ€è¦è½‰æ›ç‚ºæ ¼å­åº§æ¨™
                        foreach (var item in s32Data.Layer8)
                        {
                            // å‡è¨­ Layer8 çš„ X, Y ä¹Ÿæ˜¯ 64x64 åº§æ¨™ç³»ï¼ˆå¦‚æœæ˜¯åƒç´ åº§æ¨™å‰‡éœ€è¦é™¤ä»¥ tile å¤§å°ï¼‰
                            // æ ¹æ“šå¯¦éš›æª”æ¡ˆæ ¼å¼ï¼ŒLayer8 åº§æ¨™å¯èƒ½éœ€è¦èª¿æ•´
                            int cellX = item.X;
                            int cellY = item.Y;
                            // å¦‚æœåº§æ¨™è¶…é 64ï¼Œå¯èƒ½æ˜¯åƒç´ åº§æ¨™ï¼Œéœ€è¦é™¤ä»¥æŸå€‹ä¿‚æ•¸ï¼ˆå‡è¨­æ˜¯ 24ï¼‰
                            if (cellX >= 64 || cellY >= 64)
                            {
                                cellX = item.X / 24;  // å‡è¨­ tile å¯¬åº¦
                                cellY = item.Y / 24;  // å‡è¨­ tile é«˜åº¦
                            }
                            if (l3Cells.Contains((cellX, cellY)))
                            {
                                // è¨ˆç®—ç›¸å°æ–¼è¤‡è£½åŸé»çš„åº§æ¨™
                                int globalL3X = segStartX + cellX;
                                int globalY = segStartY + cellY;
                                int relL3X = globalL3X - (minGlobalX / 2);
                                int relY = globalY - minGlobalY;

                                if (!_editState.Layer8Clipboard.Any(l => l.SprId == item.SprId && l.X == relL3X && l.Y == relY))
                                {
                                    _editState.Layer8Clipboard.Add(new Layer8Item { SprId = item.SprId, X = (ushort)relL3X, Y = (ushort)relY, ExtendedData = item.ExtendedData });
                                }
                            }
                        }
                    }
                }
            }

            // è¨­å®šå‰ªè²¼ç°¿ç‹€æ…‹ï¼ˆä»»ä½•ä¸€å€‹å‰ªè²¼ç°¿æœ‰è³‡æ–™å°±ç®—æœ‰ï¼‰
            hasLayer4Clipboard = _editState.CellClipboard.Count > 0 ||
                                 _editState.Layer2Clipboard.Count > 0 ||
                                 _editState.Layer5Clipboard.Count > 0 ||
                                 _editState.Layer6Clipboard.Count > 0 ||
                                 _editState.Layer7Clipboard.Count > 0 ||
                                 _editState.Layer8Clipboard.Count > 0;

            // çµ„åˆæç¤ºè¨Šæ¯
            var parts = new List<string>();
            if (copyLayer1 && layer1Count > 0) parts.Add($"L1:{layer1Count}");
            if (copyLayer2 && _editState.Layer2Clipboard.Count > 0) parts.Add($"L2:{_editState.Layer2Clipboard.Count}");
            if (copyLayer3 && layer3Count > 0) parts.Add($"L3:{layer3Count}");
            if (copyLayer4 && layer4Count > 0) parts.Add($"L4:{layer4Count}");
            if (copyLayer5 && _editState.Layer5Clipboard.Count > 0) parts.Add($"L5:{_editState.Layer5Clipboard.Count}");
            if (copyLayer6to8 && (_editState.Layer6Clipboard.Count > 0 || _editState.Layer7Clipboard.Count > 0 || _editState.Layer8Clipboard.Count > 0))
                parts.Add($"L6:{_editState.Layer6Clipboard.Count} L7:{_editState.Layer7Clipboard.Count} L8:{_editState.Layer8Clipboard.Count}");

            string layerInfo = parts.Count > 0 ? string.Join(", ", parts) : "ç„¡è³‡æ–™";
            this.toolStripStatusLabel1.Text = $"å·²è¤‡è£½ {selectedCells.Count} æ ¼ ({layerInfo}) ä¾†æº: {_document.MapId}ï¼Œå·¦éµé¸å–è²¼ä¸Šä½ç½®å¾ŒæŒ‰ Ctrl+V";

            // æ¸…é™¤é¸å–æ¡†ä½†ä¿ç•™è¤‡è£½è³‡æ–™
            isLayer4CopyMode = false;
            selectedRegion = new Rectangle();
            copyRegionBounds = new Rectangle();
            _editState.SelectedCells.Clear();
            _mapViewerControl.Refresh();
        }

        // è²¼ä¸Šé¸å–å€åŸŸ
        private void PasteSelectedCells()
        {
            // æª¢æŸ¥ä»»ä½•ä¸€å€‹å‰ªè²¼ç°¿æ˜¯å¦æœ‰è³‡æ–™
            bool hasAnyClipboardData = _editState.CellClipboard.Count > 0 ||
                                       _editState.Layer2Clipboard.Count > 0 ||
                                       _editState.Layer5Clipboard.Count > 0 ||
                                       _editState.Layer6Clipboard.Count > 0 ||
                                       _editState.Layer7Clipboard.Count > 0 ||
                                       _editState.Layer8Clipboard.Count > 0;

            if (!hasLayer4Clipboard || !hasAnyClipboardData)
            {
                this.toolStripStatusLabel1.Text = "å‰ªè²¼ç°¿æ²’æœ‰è³‡æ–™ï¼Œè«‹å…ˆä½¿ç”¨å·¦éµé¸å–å€åŸŸå¾ŒæŒ‰ Ctrl+C è¤‡è£½";
                return;
            }

            // éœ€è¦å…ˆé¸å–è²¼ä¸Šä½ç½®ï¼ˆæª¢æŸ¥ CopyRegionOrigin æ˜¯å¦æœ‰æ•ˆï¼‰
            if (_editState.CopyRegionOrigin.X < 0 || _editState.CopyRegionOrigin.Y < 0)
            {
                this.toolStripStatusLabel1.Text = "è«‹ä½¿ç”¨å·¦éµé¸å–è²¼ä¸Šä½ç½®";
                return;
            }

            // å–å¾—è²¼ä¸Šä½ç½®çš„å…¨åŸŸ Layer1 åº§æ¨™
            int pasteOriginX = _editState.CopyRegionOrigin.X;
            int pasteOriginY = _editState.CopyRegionOrigin.Y;


            int layer1Count = 0, layer3Count = 0, layer4Count = 0;
            int skippedCount = 0;

            // å»ºç«‹ Undo è¨˜éŒ„
            var undoAction = new UndoAction
            {
                Description = $"è²¼ä¸Š {_editState.CellClipboard.Count} æ ¼è³‡æ–™"
            };

            // è²¼ä¸Šæ¯å€‹æ ¼å­çš„è³‡æ–™
            foreach (var cellData in _editState.CellClipboard)
            {
                // è¨ˆç®—ç›®æ¨™å…¨åŸŸ Layer1 åº§æ¨™
                int targetGlobalX = pasteOriginX + cellData.RelativeX;
                int targetGlobalY = pasteOriginY + cellData.RelativeY;

                // è½‰æ›ç‚ºéŠæˆ²åº§æ¨™ï¼ˆLayer3ï¼‰ä¾†æ‰¾ S32
                int targetGameX = targetGlobalX / 2;
                int targetGameY = targetGlobalY;

                // æ‰¾åˆ°ç›®æ¨™æ ¼å­æ‰€å±¬çš„ S32
                S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                if (targetS32 == null)
                {
                    skippedCount++;
                    continue;
                }

                // è¨ˆç®—ç›®æ¨™ S32 å…§çš„å±€éƒ¨åº§æ¨™
                int localX = targetGlobalX - targetS32.SegInfo.nLinBeginX * 2;
                int localY = targetGlobalY - targetS32.SegInfo.nLinBeginY;

                // æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
                if (localX < 0 || localX >= 128 || localY < 0 || localY >= 64)
                {
                    skippedCount++;
                    continue;
                }

                // Layer1 è³‡æ–™ï¼ˆåœ°æ¿ï¼‰- è¨˜éŒ„èˆŠå€¼å’Œæ–°å€¼åˆ° Undo
                if (cellData.Layer1Cell1 != null && localX >= 0 && localX < 128)
                {
                    var oldCell = targetS32.Layer1[localY, localX];
                    undoAction.ModifiedLayer1.Add(new UndoLayer1Info
                    {
                        S32FilePath = targetS32.FilePath,
                        LocalX = localX,
                        LocalY = localY,
                        OldTileId = oldCell?.TileId ?? 0,
                        OldIndexId = oldCell?.IndexId ?? 0,
                        NewTileId = cellData.Layer1Cell1.TileId,
                        NewIndexId = cellData.Layer1Cell1.IndexId
                    });

                    targetS32.Layer1[localY, localX] = new TileCell
                    {
                        X = localX,
                        Y = localY,
                        TileId = cellData.Layer1Cell1.TileId,
                        IndexId = cellData.Layer1Cell1.IndexId
                    };
                    if (cellData.Layer1Cell1.TileId > 0) layer1Count++;
                    targetS32.IsModified = true;
                }
                if (cellData.Layer1Cell2 != null && localX + 1 >= 0 && localX + 1 < 128)
                {
                    var oldCell = targetS32.Layer1[localY, localX + 1];
                    undoAction.ModifiedLayer1.Add(new UndoLayer1Info
                    {
                        S32FilePath = targetS32.FilePath,
                        LocalX = localX + 1,
                        LocalY = localY,
                        OldTileId = oldCell?.TileId ?? 0,
                        OldIndexId = oldCell?.IndexId ?? 0,
                        NewTileId = cellData.Layer1Cell2.TileId,
                        NewIndexId = cellData.Layer1Cell2.IndexId
                    });

                    targetS32.Layer1[localY, localX + 1] = new TileCell
                    {
                        X = localX + 1,
                        Y = localY,
                        TileId = cellData.Layer1Cell2.TileId,
                        IndexId = cellData.Layer1Cell2.IndexId
                    };
                    if (cellData.Layer1Cell2.TileId > 0) layer1Count++;
                    targetS32.IsModified = true;
                }

                // Layer3 è³‡æ–™ï¼ˆå±¬æ€§ï¼‰- è¨˜éŒ„èˆŠå€¼å’Œæ–°å€¼åˆ° Undo
                if (cellData.Layer3Attr != null)
                {
                    int layer3X = localX / 2;
                    if (layer3X >= 0 && layer3X < 64)
                    {
                        var oldAttr = targetS32.Layer3[localY, layer3X];
                        undoAction.ModifiedLayer3.Add(new UndoLayer3Info
                        {
                            S32FilePath = targetS32.FilePath,
                            LocalX = layer3X,
                            LocalY = localY,
                            OldAttribute1 = oldAttr?.Attribute1 ?? 0,
                            OldAttribute2 = oldAttr?.Attribute2 ?? 0,
                            NewAttribute1 = cellData.Layer3Attr.Attribute1,
                            NewAttribute2 = cellData.Layer3Attr.Attribute2
                        });

                        targetS32.Layer3[localY, layer3X] = new MapAttribute
                        {
                            Attribute1 = cellData.Layer3Attr.Attribute1,
                            Attribute2 = cellData.Layer3Attr.Attribute2
                        };
                        layer3Count++;
                        targetS32.IsModified = true;
                    }
                }

                // Layer4 è³‡æ–™ï¼ˆç‰©ä»¶ï¼‰- åŠ å…¥æ–°ç‰©ä»¶ä¸¦è¨˜éŒ„åˆ° Undo
                if (cellData.Layer4Objects.Count > 0)
                {
                    // åŠ å…¥æ–°ç‰©ä»¶
                    foreach (var objData in cellData.Layer4Objects.OrderBy(o => o.OriginalIndex))
                    {
                        // è¨ˆç®—ç‰©ä»¶åœ¨ç›®æ¨™ S32 å…§çš„å±€éƒ¨åº§æ¨™ï¼ˆLayer1 åº§æ¨™ç³»çµ± 0-127ï¼‰
                        int objTargetGlobalX = pasteOriginX + objData.RelativeX;
                        int objTargetGlobalY = pasteOriginY + objData.RelativeY;
                        int objLocalLayer1X = objTargetGlobalX - targetS32.SegInfo.nLinBeginX * 2;
                        int objLocalY = objTargetGlobalY - targetS32.SegInfo.nLinBeginY;

                        // obj.X æ˜¯ Layer1 åº§æ¨™ï¼Œå¯èƒ½è¶…é 127ï¼ˆç‰©ä»¶å¯ä»¥è·¨æ ¼å­ï¼‰
                        if (objLocalLayer1X >= 0 && objLocalY >= 0 && objLocalY < 64)
                        {
                            var newObj = new ObjectTile
                            {
                                GroupId = objData.GroupId,
                                X = objLocalLayer1X,  // ä½¿ç”¨ Layer1 åº§æ¨™
                                Y = objLocalY,
                                Layer = objData.Layer,
                                IndexId = objData.IndexId,
                                TileId = objData.TileId
                            };
                            targetS32.Layer4.Add(newObj);
                            Layer4Index_Add(targetS32, newObj);
                            layer4Count++;

                            // è¨˜éŒ„æ–°å¢çš„ç‰©ä»¶åˆ° Undoï¼ˆé‚„åŸæ™‚è¦åˆªé™¤ï¼‰
                            undoAction.AddedObjects.Add(new UndoObjectInfo
                            {
                                S32FilePath = targetS32.FilePath,
                                GameX = targetS32.SegInfo.nLinBeginX + objLocalLayer1X / 2,
                                GameY = targetS32.SegInfo.nLinBeginY + objLocalY,
                                LocalX = objLocalLayer1X,
                                LocalY = objLocalY,
                                GroupId = objData.GroupId,
                                Layer = objData.Layer,
                                IndexId = objData.IndexId,
                                TileId = objData.TileId
                            });
                        }
                    }
                    targetS32.IsModified = true;
                }
            }

            // å„²å­˜ Undo è¨˜éŒ„ï¼ˆå¦‚æœæœ‰ä»»ä½•ä¿®æ”¹ï¼‰
            if (undoAction.AddedObjects.Count > 0 || undoAction.ModifiedLayer1.Count > 0 || undoAction.ModifiedLayer3.Count > 0)
            {
                PushUndoAction(undoAction);
            }

            // åˆä½µ Layer2 å’Œ Layer5-8 åˆ°æ‰€æœ‰å—å½±éŸ¿çš„ç›®æ¨™ S32ï¼ˆæ ¹æ“šè¨­å®šï¼‰
            int layer2AddedCount = 0;
            int layer5to8CopiedCount = 0;
            var affectedS32Set = new HashSet<S32Data>();
            foreach (var cellData in _editState.CellClipboard)
            {
                int targetGlobalX = pasteOriginX + cellData.RelativeX;
                int targetGlobalY = pasteOriginY + cellData.RelativeY;
                int targetGameX = targetGlobalX / 2;
                int targetGameY = targetGlobalY;
                S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                if (targetS32 != null)
                    affectedS32Set.Add(targetS32);
            }

            foreach (var targetS32 in affectedS32Set)
            {
                // åˆä½µ Layer2ï¼ˆåŠ å…¥ä¸å­˜åœ¨çš„é …ç›®ï¼‰- æ ¹æ“šè¨­å®š
                if (copySettingLayer2 && _editState.Layer2Clipboard.Count > 0)
                {
                    foreach (var item in _editState.Layer2Clipboard)
                    {
                        if (!targetS32.Layer2.Any(l => l.X == item.X && l.Y == item.Y && l.TileId == item.TileId))
                        {
                            targetS32.Layer2.Add(new Layer2Item
                            {
                                X = item.X,
                                Y = item.Y,
                                IndexId = item.IndexId,
                                TileId = item.TileId,
                                UK = item.UK
                            });
                            layer2AddedCount++;
                            targetS32.IsModified = true;
                        }
                    }
                }

                // Layer6 - ä½¿ç”¨çš„ TilIdï¼ˆåˆä½µä¸é‡è¤‡çš„ï¼‰- æ ¹æ“šè¨­å®š
                if (copySettingLayer6to8)
                {
                    int layer6Added = 0;
                    foreach (var tilId in _editState.Layer6Clipboard)
                    {
                        if (!targetS32.Layer6.Contains(tilId))
                        {
                            targetS32.Layer6.Add(tilId);
                            targetS32.IsModified = true;
                            layer6Added++;
                        }
                    }
                    if (layer6Added > 0) layer5to8CopiedCount++;
                }
            }

            // Layer5 - é€æ˜åœ–å¡Šï¼ˆéœ€è¦è¨ˆç®—æ­£ç¢ºçš„ç›®æ¨™åº§æ¨™ï¼‰- æ ¹æ“šè¨­å®š
            if (copySettingLayer5 && _editState.Layer5Clipboard.Count > 0)
            {
                foreach (var item in _editState.Layer5Clipboard)
                {
                    // item.X, item.Y æ˜¯ç›¸å°åº§æ¨™ï¼ˆç›¸å°æ–¼è¤‡è£½åŸé»ï¼‰
                    int targetGlobalL1X = pasteOriginX + item.X;
                    int targetGlobalY = pasteOriginY + item.Y;

                    // æ‰¾åˆ°ç›®æ¨™ S32
                    int targetGameX = targetGlobalL1X / 2;
                    int targetGameY = targetGlobalY;
                    S32Data l5TargetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                    if (l5TargetS32 == null) continue;

                    // è¨ˆç®—ç›®æ¨™ S32 å…§çš„å±€éƒ¨åº§æ¨™
                    int localL1X = targetGlobalL1X - l5TargetS32.SegInfo.nLinBeginX * 2;
                    int localY = targetGlobalY - l5TargetS32.SegInfo.nLinBeginY;

                    // æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
                    if (localL1X < 0 || localL1X >= 128 || localY < 0 || localY >= 64)
                        continue;

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (!l5TargetS32.Layer5.Any(l => l.X == localL1X && l.Y == localY && l.ObjectIndex == item.ObjectIndex))
                    {
                        l5TargetS32.Layer5.Add(new Layer5Item
                        {
                            X = (byte)localL1X,
                            Y = (byte)localY,
                            ObjectIndex = item.ObjectIndex,
                            Type = item.Type
                        });
                        l5TargetS32.IsModified = true;
                    }
                }
            }

            // Layer7 - å‚³é€é»ï¼ˆéœ€è¦è¨ˆç®—æ­£ç¢ºçš„ç›®æ¨™åº§æ¨™ï¼‰- æ ¹æ“šè¨­å®š
            if (copySettingLayer6to8 && _editState.Layer7Clipboard.Count > 0)
            {
                foreach (var item in _editState.Layer7Clipboard)
                {
                    // item.X, item.Y æ˜¯ç›¸å°åº§æ¨™ï¼ˆç›¸å°æ–¼è¤‡è£½åŸé»çš„ Layer3 åº§æ¨™ï¼‰
                    // å…ˆè½‰ç‚º Layer1 åº§æ¨™ç³»ï¼Œå†è¨ˆç®—ç›®æ¨™
                    int targetGlobalL1X = pasteOriginX + item.X * 2;
                    int targetGlobalY = pasteOriginY + item.Y;

                    // æ‰¾åˆ°ç›®æ¨™ S32
                    int targetGameX = targetGlobalL1X / 2;
                    int targetGameY = targetGlobalY;
                    S32Data l7TargetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                    if (l7TargetS32 == null) continue;

                    // è¨ˆç®—ç›®æ¨™ S32 å…§çš„å±€éƒ¨ Layer3 åº§æ¨™
                    int localL3X = targetGameX - l7TargetS32.SegInfo.nLinBeginX;
                    int localY = targetGlobalY - l7TargetS32.SegInfo.nLinBeginY;

                    // æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
                    if (localL3X < 0 || localL3X >= 64 || localY < 0 || localY >= 64)
                        continue;

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (!l7TargetS32.Layer7.Any(l => l.Name == item.Name && l.X == localL3X && l.Y == localY))
                    {
                        l7TargetS32.Layer7.Add(new Layer7Item
                        {
                            Name = item.Name,
                            X = (byte)localL3X,
                            Y = (byte)localY,
                            TargetMapId = item.TargetMapId,
                            PortalId = item.PortalId
                        });
                        l7TargetS32.IsModified = true;
                    }
                }
            }

            // Layer8 - ç‰¹æ•ˆï¼ˆéœ€è¦è¨ˆç®—æ­£ç¢ºçš„ç›®æ¨™åº§æ¨™ï¼‰- æ ¹æ“šè¨­å®š
            if (copySettingLayer6to8 && _editState.Layer8Clipboard.Count > 0)
            {
                foreach (var item in _editState.Layer8Clipboard)
                {
                    // item.X, item.Y å¯èƒ½æ˜¯åƒç´ åº§æ¨™æˆ–æ ¼å­åº§æ¨™ï¼Œé€™è£¡å‡è¨­æ˜¯æ ¼å­åº§æ¨™
                    int targetGlobalL1X = pasteOriginX + item.X * 2;
                    int targetGlobalY = pasteOriginY + item.Y;

                    // æ‰¾åˆ°ç›®æ¨™ S32
                    int targetGameX = targetGlobalL1X / 2;
                    int targetGameY = targetGlobalY;
                    S32Data l8TargetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                    if (l8TargetS32 == null) continue;

                    // è¨ˆç®—ç›®æ¨™ S32 å…§çš„å±€éƒ¨åº§æ¨™
                    int localL3X = targetGameX - l8TargetS32.SegInfo.nLinBeginX;
                    int localY = targetGlobalY - l8TargetS32.SegInfo.nLinBeginY;

                    // æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
                    if (localL3X < 0 || localL3X >= 64 || localY < 0 || localY >= 64)
                        continue;

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (!l8TargetS32.Layer8.Any(l => l.SprId == item.SprId && l.X == localL3X && l.Y == localY))
                    {
                        l8TargetS32.Layer8.Add(new Layer8Item
                        {
                            SprId = item.SprId,
                            X = (ushort)localL3X,
                            Y = (ushort)localY,
                            ExtendedData = item.ExtendedData
                        });
                        l8TargetS32.IsModified = true;
                    }
                }
            }

            // æ¸…é™¤é¸å–æ¨¡å¼
            isLayer4CopyMode = false;
            selectedRegion = new Rectangle();
            copyRegionBounds = new Rectangle();
            _editState.SelectedCells.Clear();

            // é‡æ–°æ¸²æŸ“åœ°åœ–
            RenderS32Map();

            // æª¢æŸ¥æ˜¯å¦è·¨åœ°åœ–è²¼ä¸Š
            bool isCrossMap = !string.IsNullOrEmpty(_editState.SourceMapId) && _editState.SourceMapId != _document.MapId;

            // çµ„åˆæç¤ºè¨Šæ¯
            var parts = new List<string>();
            if (layer1Count > 0) parts.Add($"L1:{layer1Count}");
            if (layer2AddedCount > 0) parts.Add($"L2:+{layer2AddedCount}");
            if (layer3Count > 0) parts.Add($"L3:{layer3Count}");
            if (layer4Count > 0) parts.Add($"L4:{layer4Count}");
            if (layer5to8CopiedCount > 0) parts.Add($"L6:+{layer5to8CopiedCount}");

            string layerInfo = parts.Count > 0 ? string.Join(", ", parts) : "ç„¡è³‡æ–™";
            string message = $"å·²è²¼ä¸Š {_editState.CellClipboard.Count} æ ¼ ({layerInfo})";
            if (isCrossMap)
                message += $" (å¾ {_editState.SourceMapId} è·¨åœ°åœ–è²¼ä¸Š)";
            if (skippedCount > 0)
                message += $"ï¼Œ{skippedCount} æ ¼è¶…å‡ºç¯„åœè¢«è·³é";
            this.toolStripStatusLabel1.Text = message;

            // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();
        }

        // å–æ¶ˆè¤‡è£½/è²¼ä¸Šæ¨¡å¼
        private void CancelLayer4CopyPaste()
        {
            isLayer4CopyMode = false;
            // æ¢å¾©é¡¯ç¤ºå…¨éƒ¨ç¾¤çµ„
            UpdateGroupThumbnailsList();
            selectedRegion = new Rectangle();
            copyRegionBounds = new Rectangle();
            _editState.SelectedCells.Clear();
            _mapViewerControl.Refresh();
            this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆè¤‡è£½/è²¼ä¸Šæ¨¡å¼";
        }

        // æ–°å¢ Undo è¨˜éŒ„
        private void PushUndoAction(UndoAction action)
        {
            _editState.UndoHistory.Push(action);
            // æ–°æ“ä½œæœƒæ¸…ç©º redo æ­·å²
            _editState.RedoHistory.Clear();
            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (_editState.UndoHistory.Count > MAX_UNDO_HISTORY)
            {
                var tempStack = new Stack<UndoAction>();
                for (int i = 0; i < MAX_UNDO_HISTORY; i++)
                {
                    tempStack.Push(_editState.UndoHistory.Pop());
                }
                _editState.UndoHistory.Clear();
                while (tempStack.Count > 0)
                {
                    _editState.UndoHistory.Push(tempStack.Pop());
                }
            }
        }

        // åŸ·è¡Œé‚„åŸ (Ctrl+Z)
        private void UndoLastAction()
        {
            if (_editState.UndoHistory.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "æ²’æœ‰å¯é‚„åŸçš„æ“ä½œ";
                return;
            }

            var action = _editState.UndoHistory.Pop();

            // é‚„åŸåˆªé™¤çš„ç‰©ä»¶ï¼ˆé‡æ–°æ–°å¢ï¼‰
            foreach (var objInfo in action.RemovedObjects)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(objInfo.S32FilePath, out targetS32))
                {
                    var newObj = new ObjectTile
                    {
                        GroupId = objInfo.GroupId,
                        X = objInfo.LocalX,
                        Y = objInfo.LocalY,
                        Layer = objInfo.Layer,
                        IndexId = objInfo.IndexId,
                        TileId = objInfo.TileId
                    };
                    targetS32.Layer4.Add(newObj);
                    Layer4Index_Add(targetS32, newObj);
                    targetS32.IsModified = true;
                }
            }

            // é‚„åŸæ–°å¢çš„ç‰©ä»¶ï¼ˆåˆªé™¤ï¼‰
            foreach (var objInfo in action.AddedObjects)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(objInfo.S32FilePath, out targetS32))
                {
                    var objToRemove = targetS32.Layer4.FirstOrDefault(o =>
                        o.X == objInfo.LocalX &&
                        o.Y == objInfo.LocalY &&
                        o.GroupId == objInfo.GroupId &&
                        o.Layer == objInfo.Layer &&
                        o.IndexId == objInfo.IndexId &&
                        o.TileId == objInfo.TileId);

                    if (objToRemove != null)
                    {
                        targetS32.Layer4.Remove(objToRemove);
                        Layer4Index_Remove(targetS32, objToRemove);
                        targetS32.IsModified = true;
                    }
                }
            }

            // é‚„åŸåˆªé™¤çš„ç¬¬ä¸ƒå±¤è³‡æ–™ï¼ˆé‡æ–°æ–°å¢ï¼‰
            foreach (var layer7Info in action.RemovedLayer7Items)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer7Info.S32FilePath, out targetS32))
                {
                    targetS32.Layer7.Add(new Layer7Item
                    {
                        Name = layer7Info.Name,
                        X = layer7Info.X,
                        Y = layer7Info.Y,
                        TargetMapId = layer7Info.TargetMapId,
                        PortalId = layer7Info.PortalId
                    });
                    targetS32.IsModified = true;
                }
            }

            // é‚„åŸä¿®æ”¹çš„ç¬¬ä¸€å±¤è³‡æ–™ï¼ˆåœ°æ¿ï¼‰
            foreach (var layer1Info in action.ModifiedLayer1)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer1Info.S32FilePath, out targetS32))
                {
                    targetS32.Layer1[layer1Info.LocalY, layer1Info.LocalX] = new TileCell
                    {
                        X = layer1Info.LocalX,
                        Y = layer1Info.LocalY,
                        TileId = layer1Info.OldTileId,
                        IndexId = layer1Info.OldIndexId
                    };
                    targetS32.IsModified = true;
                }
            }

            // é‚„åŸä¿®æ”¹çš„ç¬¬ä¸‰å±¤è³‡æ–™ï¼ˆå±¬æ€§ï¼‰
            foreach (var layer3Info in action.ModifiedLayer3)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer3Info.S32FilePath, out targetS32))
                {
                    targetS32.Layer3[layer3Info.LocalY, layer3Info.LocalX] = new MapAttribute
                    {
                        Attribute1 = layer3Info.OldAttribute1,
                        Attribute2 = layer3Info.OldAttribute2
                    };
                    targetS32.IsModified = true;
                }
            }

            // å°‡æ­¤å‹•ä½œæ”¾å…¥ redo æ­·å²
            _editState.RedoHistory.Push(action);

            // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“åœ°åœ–
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            this.toolStripStatusLabel1.Text = $"å·²é‚„åŸ: {action.Description} (Ctrl+Z: {_editState.UndoHistory.Count} / Ctrl+Y: {_editState.RedoHistory.Count})";
        }

        // åŸ·è¡Œé‡åš (Ctrl+Y)
        private void RedoLastAction()
        {
            if (_editState.RedoHistory.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "æ²’æœ‰å¯é‡åšçš„æ“ä½œ";
                return;
            }

            var action = _editState.RedoHistory.Pop();

            // é‡åšæ–°å¢çš„ç‰©ä»¶ï¼ˆé‡æ–°æ–°å¢ï¼‰
            foreach (var objInfo in action.AddedObjects)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(objInfo.S32FilePath, out targetS32))
                {
                    var newObj = new ObjectTile
                    {
                        GroupId = objInfo.GroupId,
                        X = objInfo.LocalX,
                        Y = objInfo.LocalY,
                        Layer = objInfo.Layer,
                        IndexId = objInfo.IndexId,
                        TileId = objInfo.TileId
                    };
                    targetS32.Layer4.Add(newObj);
                    Layer4Index_Add(targetS32, newObj);
                    targetS32.IsModified = true;
                }
            }

            // é‡åšåˆªé™¤çš„ç‰©ä»¶ï¼ˆé‡æ–°åˆªé™¤ï¼‰
            foreach (var objInfo in action.RemovedObjects)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(objInfo.S32FilePath, out targetS32))
                {
                    var objToRemove = targetS32.Layer4.FirstOrDefault(o =>
                        o.X == objInfo.LocalX &&
                        o.Y == objInfo.LocalY &&
                        o.GroupId == objInfo.GroupId &&
                        o.Layer == objInfo.Layer &&
                        o.IndexId == objInfo.IndexId &&
                        o.TileId == objInfo.TileId);

                    if (objToRemove != null)
                    {
                        targetS32.Layer4.Remove(objToRemove);
                        Layer4Index_Remove(targetS32, objToRemove);
                        targetS32.IsModified = true;
                    }
                }
            }

            // é‡åšåˆªé™¤çš„ç¬¬ä¸ƒå±¤è³‡æ–™ï¼ˆé‡æ–°åˆªé™¤ï¼‰
            foreach (var layer7Info in action.RemovedLayer7Items)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer7Info.S32FilePath, out targetS32))
                {
                    var itemToRemove = targetS32.Layer7.FirstOrDefault(l =>
                        l.Name == layer7Info.Name &&
                        l.X == layer7Info.X &&
                        l.Y == layer7Info.Y &&
                        l.TargetMapId == layer7Info.TargetMapId &&
                        l.PortalId == layer7Info.PortalId);

                    if (itemToRemove != null)
                    {
                        targetS32.Layer7.Remove(itemToRemove);
                        targetS32.IsModified = true;
                    }
                }
            }

            // é‡åšä¿®æ”¹çš„ç¬¬ä¸€å±¤è³‡æ–™ï¼ˆå¥—ç”¨æ–°å€¼ï¼‰
            foreach (var layer1Info in action.ModifiedLayer1)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer1Info.S32FilePath, out targetS32))
                {
                    targetS32.Layer1[layer1Info.LocalY, layer1Info.LocalX] = new TileCell
                    {
                        X = layer1Info.LocalX,
                        Y = layer1Info.LocalY,
                        TileId = layer1Info.NewTileId,
                        IndexId = layer1Info.NewIndexId
                    };
                    targetS32.IsModified = true;
                }
            }

            // é‡åšä¿®æ”¹çš„ç¬¬ä¸‰å±¤è³‡æ–™ï¼ˆå¥—ç”¨æ–°å€¼ï¼‰
            foreach (var layer3Info in action.ModifiedLayer3)
            {
                S32Data targetS32 = null;
                if (_document.S32Files.TryGetValue(layer3Info.S32FilePath, out targetS32))
                {
                    targetS32.Layer3[layer3Info.LocalY, layer3Info.LocalX] = new MapAttribute
                    {
                        Attribute1 = layer3Info.NewAttribute1,
                        Attribute2 = layer3Info.NewAttribute2
                    };
                    targetS32.IsModified = true;
                }
            }

            // å°‡æ­¤å‹•ä½œæ”¾å› undo æ­·å²
            _editState.UndoHistory.Push(action);

            // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“åœ°åœ–
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            this.toolStripStatusLabel1.Text = $"å·²é‡åš: {action.Description} (Ctrl+Z: {_editState.UndoHistory.Count} / Ctrl+Y: {_editState.RedoHistory.Count})";
        }

        // å–å¾—ç­‰è·è±å½¢å€åŸŸå…§çš„æ‰€æœ‰æ ¼å­ï¼ˆæ”¯æ´é•·æ–¹å½¢ï¼‰
        private List<SelectedCell> GetCellsInIsometricRegion(Rectangle region)
        {
            List<SelectedCell> result = new List<SelectedCell>();

            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return result;

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // è¨ˆç®—è±å½¢çš„åƒæ•¸ï¼ˆä½¿ç”¨å¯¦éš›å¯¬é«˜ï¼‰
            float centerX = region.Left + region.Width / 2f;
            float centerY = region.Top + region.Height / 2f;
            float halfWidth = region.Width / 2f;
            float halfHeight = region.Height / 2f;

            foreach (var s32Data in _document.S32Files.Values)
            {
                // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        // èˆ‡ drawTilBlock ç›¸åŒçš„åƒç´ è¨ˆç®—
                        int localBaseX = 0;
                        int localBaseY = 63 * 12;
                        localBaseX -= 24 * (x / 2);
                        localBaseY -= 12 * (x / 2);

                        int X = mx + localBaseX + x * 24 + y * 24;
                        int Y = my + localBaseY + y * 12;

                        // æ ¼å­ä¸­å¿ƒé»
                        float cellCenterX = X + 12;
                        float cellCenterY = Y + 12;

                        // æª¢æŸ¥æ˜¯å¦åœ¨ç­‰è·è±å½¢å…§
                        if (IsPointInIsometricRegion(cellCenterX, cellCenterY, centerX, centerY, halfWidth, halfHeight))
                        {
                            result.Add(new SelectedCell
                            {
                                S32Data = s32Data,
                                LocalX = x,
                                LocalY = y
                            });
                        }
                    }
                }
            }

            return result;
        }

        // æª¢æŸ¥é»æ˜¯å¦åœ¨ç­‰è·è±å½¢å…§
        private bool IsPointInIsometricRegion(float px, float py, float centerX, float centerY, float halfWidth, float halfHeight)
        {
            // ä½¿ç”¨æ¨™æº–åŒ–çš„è±å½¢æª¢æ¸¬å…¬å¼
            float dx = Math.Abs(px - centerX) / halfWidth;
            float dy = Math.Abs(py - centerY) / halfHeight;
            return (dx + dy) <= 1.0f;
        }

        // æ ¹æ“šé¸ä¸­çš„æ ¼å­è¨ˆç®—å°é½Šæ ¼å­çš„è±å½¢é‚Šç•Œ
        private Rectangle GetAlignedBoundsFromCells(List<SelectedCell> cells)
        {
            if (cells.Count == 0 || string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return new Rectangle();

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // è¨ˆç®—æ‰€æœ‰æ ¼å­çš„è¢å¹•åº§æ¨™ç¯„åœ
            int minScreenX = int.MaxValue, maxScreenX = int.MinValue;
            int minScreenY = int.MaxValue, maxScreenY = int.MinValue;

            foreach (var cell in cells)
            {
                // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼ï¼ˆGetLoc + drawTilBlock å…¬å¼ï¼‰
                int[] loc = cell.S32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                // èˆ‡ drawTilBlock ç›¸åŒçš„åƒç´ è¨ˆç®—
                int localBaseX = 0;
                int localBaseY = 63 * 12;
                localBaseX -= 24 * (cell.LocalX / 2);
                localBaseY -= 12 * (cell.LocalX / 2);

                int X = mx + localBaseX + cell.LocalX * 24 + cell.LocalY * 24;
                int Y = my + localBaseY + cell.LocalY * 12;

                // è±å½¢çš„å››å€‹é ‚é»
                int left = X + 0;
                int right = X + 24;
                int top = Y + 0;
                int bottom = Y + 24;

                minScreenX = Math.Min(minScreenX, left);
                maxScreenX = Math.Max(maxScreenX, right);
                minScreenY = Math.Min(minScreenY, top);
                maxScreenY = Math.Max(maxScreenY, bottom);
            }

            // è¨ˆç®—è±å½¢çš„ä¸­å¿ƒå’Œå¤§å°
            int centerX = (minScreenX + maxScreenX) / 2;
            int centerY = (minScreenY + maxScreenY) / 2;
            int width = maxScreenX - minScreenX;
            int height = maxScreenY - minScreenY;

            // è¿”å›ä¸€å€‹çŸ©å½¢ï¼Œè¡¨ç¤ºè±å½¢çš„é‚Šç•Œæ¡†
            return new Rectangle(centerX - width / 2, centerY - height / 2, width, height);
        }

        // å–å¾—è¢å¹•çŸ©å½¢å€åŸŸå…§çš„æ‰€æœ‰æ ¼å­ï¼ˆç”¨æ–¼æ‹–æ›³é¸å–æ™‚å³æ™‚å°é½Šï¼‰
        private List<SelectedCell> GetCellsInScreenRect(Rectangle screenRect)
        {
            List<SelectedCell> result = new List<SelectedCell>();

            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return result;

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            foreach (var s32Data in _document.S32Files.Values)
            {
                // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        // èˆ‡ drawTilBlock ç›¸åŒçš„åƒç´ è¨ˆç®—
                        int localBaseX = 0;
                        int localBaseY = 63 * 12;
                        localBaseX -= 24 * (x / 2);
                        localBaseY -= 12 * (x / 2);

                        int X = mx + localBaseX + x * 24 + y * 24;
                        int Y = my + localBaseY + y * 12;

                        // æ ¼å­ä¸­å¿ƒé»
                        int cellCenterX = X + 12;
                        int cellCenterY = Y + 12;

                        // æª¢æŸ¥æ ¼å­ä¸­å¿ƒæ˜¯å¦åœ¨è¢å¹•çŸ©å½¢å…§
                        if (screenRect.Contains(cellCenterX, cellCenterY))
                        {
                            result.Add(new SelectedCell
                            {
                                S32Data = s32Data,
                                LocalX = x,
                                LocalY = y
                            });
                        }
                    }
                }
            }

            return result;
        }

        // å¾è¢å¹•èµ·é»åˆ°çµ‚é»ï¼Œè¨ˆç®—ç­‰è·æŠ•å½±çŸ©å½¢ç¯„åœå…§çš„æ‰€æœ‰æ ¼å­
        private List<SelectedCell> GetCellsInIsometricRange(Point startPoint, Point endPoint)
        {
            List<SelectedCell> result = new List<SelectedCell>();

            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return result;

            // æ‰¾å‡ºèµ·é»å’Œçµ‚é»å°æ‡‰çš„éŠæˆ²åº§æ¨™
            var (startGameX, startGameY, _, _, _) = ScreenToGameCoords(startPoint.X, startPoint.Y);
            var (endGameX, endGameY, _, _, _) = ScreenToGameCoords(endPoint.X, endPoint.Y);

            // å¦‚æœèµ·é»æ‰¾ä¸åˆ°ï¼Œè¿”å›ç©º
            if (startGameX < 0)
                return result;

            // å¦‚æœçµ‚é»æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨èµ·é»
            if (endGameX < 0)
            {
                endGameX = startGameX;
                endGameY = startGameY;
            }

            // è¨ˆç®—éŠæˆ²åº§æ¨™ç¯„åœ
            int minGameX = Math.Min(startGameX, endGameX);
            int maxGameX = Math.Max(startGameX, endGameX);
            int minGameY = Math.Min(startGameY, endGameY);
            int maxGameY = Math.Max(startGameY, endGameY);

            // è¨ˆç®—è¢å¹•ç¯„åœå°æ‡‰çš„ä¸–ç•Œåº§æ¨™çŸ©å½¢ï¼Œç”¨æ–¼ç©ºé–“ç´¢å¼•æŸ¥è©¢
            int minScreenX = Math.Min(startPoint.X, endPoint.X);
            int minScreenY = Math.Min(startPoint.Y, endPoint.Y);
            int maxScreenX = Math.Max(startPoint.X, endPoint.X);
            int maxScreenY = Math.Max(startPoint.Y, endPoint.Y);

            int worldLeft = (int)(minScreenX / s32ZoomLevel) + _viewState.ScrollX;
            int worldTop = (int)(minScreenY / s32ZoomLevel) + _viewState.ScrollY;
            int worldRight = (int)(maxScreenX / s32ZoomLevel) + _viewState.ScrollX;
            int worldBottom = (int)(maxScreenY / s32ZoomLevel) + _viewState.ScrollY;

            // æ“´å¤§æŸ¥è©¢ç¯„åœä»¥ç¢ºä¿ä¸æ¼æ‰é‚Šç•Œçš„ S32
            Rectangle queryRect = new Rectangle(worldLeft - 3072, worldTop - 1536,
                                                 worldRight - worldLeft + 6144,
                                                 worldBottom - worldTop + 3072);
            var candidateFiles = GetS32FilesInRect(queryRect);

            // åªéæ­·å€™é¸çš„ S32 æª”æ¡ˆ
            foreach (var filePath in candidateFiles)
            {
                if (!_document.S32Files.TryGetValue(filePath, out var s32Data))
                    continue;

                // å…ˆæª¢æŸ¥é€™å€‹ S32 çš„éŠæˆ²åº§æ¨™ç¯„åœæ˜¯å¦èˆ‡é¸å–ç¯„åœæœ‰äº¤é›†
                int s32MinGameX = s32Data.SegInfo.nLinBeginX;
                int s32MaxGameX = s32Data.SegInfo.nLinBeginX + 63;
                int s32MinGameY = s32Data.SegInfo.nLinBeginY;
                int s32MaxGameY = s32Data.SegInfo.nLinBeginY + 63;

                // å¿«é€Ÿæ’é™¤ä¸ç›¸äº¤çš„ S32
                if (s32MaxGameX < minGameX || s32MinGameX > maxGameX ||
                    s32MaxGameY < minGameY || s32MinGameY > maxGameY)
                    continue;

                // è¨ˆç®—åœ¨é€™å€‹ S32 å…§éœ€è¦æª¢æŸ¥çš„ç¯„åœ
                int localMinX3 = Math.Max(0, minGameX - s32Data.SegInfo.nLinBeginX);
                int localMaxX3 = Math.Min(63, maxGameX - s32Data.SegInfo.nLinBeginX);
                int localMinY = Math.Max(0, minGameY - s32Data.SegInfo.nLinBeginY);
                int localMaxY = Math.Min(63, maxGameY - s32Data.SegInfo.nLinBeginY);

                for (int y = localMinY; y <= localMaxY; y++)
                {
                    for (int x3 = localMinX3; x3 <= localMaxX3; x3++)
                    {
                        result.Add(new SelectedCell
                        {
                            S32Data = s32Data,
                            LocalX = x3 * 2,  // è½‰æ›ç‚º Layer1 åº§æ¨™
                            LocalY = y
                        });
                    }
                }
            }

            return result;
        }

        // é‡æ–°è¼‰å…¥ç•¶å‰åœ°åœ–
        private void ReloadCurrentMap()
        {
            if (string.IsNullOrEmpty(_document.MapId))
            {
                this.toolStripStatusLabel1.Text = "æ²’æœ‰é¸æ“‡åœ°åœ–";
                return;
            }

            // æ¸…é™¤å¿«å–
            tileDataCache.Clear();
            _editState.HighlightedS32Data = null;
            _editState.HighlightedCellX = -1;
            _editState.HighlightedCellY = -1;

            // é‡æ–°è¼‰å…¥ S32 æª”æ¡ˆ
            this.toolStripStatusLabel1.Text = "æ­£åœ¨é‡æ–°è¼‰å…¥...";
            LoadS32FileList(_document.MapId);
        }

        private void MapForm_Load(object sender, EventArgs e)
        {
            LogPerf("[FORM-LOAD] Start");

            // åˆå§‹åŒ–æµ®å‹•åœ–å±¤é¢æ¿ç‹€æ…‹ï¼ˆå¿…é ˆåœ¨è¼‰å…¥åœ°åœ–å‰åŸ·è¡Œï¼‰
            SyncFloatPanelCheckboxes();
            s32EditorPanel_Resize(null, null);
            layerFloatPanel.BringToFront();
            LogPerf("[FORM-LOAD] Panel setup done");

            // è¼‰å…¥æœ€è¿‘ä½¿ç”¨çš„ç´ æ
            RefreshMaterialsList();
            LogPerf("[FORM-LOAD] Materials list loaded");

            string iniPath = Path.GetTempPath() + "mapviewer.ini";

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å¤©å ‚è·¯å¾‘ï¼Œå¦‚æœæœ‰å°±è‡ªå‹•è¼‰å…¥
            if (File.Exists(iniPath))
            {
                string savedPath = Utils.GetINI("Path", "LineagePath", "", iniPath);
                LogPerf($"[FORM-LOAD] INI savedPath={savedPath}");
                if (!string.IsNullOrEmpty(savedPath) && Directory.Exists(savedPath))
                {
                    // å¦‚æœé‚„æ²’è¼‰å…¥åœ°åœ–è³‡æ–™ï¼Œè‡ªå‹•è¼‰å…¥
                    if (Share.MapDataList == null || Share.MapDataList.Count == 0)
                    {
                        LogPerf("[FORM-LOAD] Calling LoadMap...");
                        this.toolStripStatusLabel3.Text = savedPath;
                        Share.LineagePath = savedPath;
                        this.LoadMap(savedPath);
                        LogPerf("[FORM-LOAD] LoadMap returned (async continues in background)");
                        return; // LoadMap æœƒè§¸ç™¼ comboBox1_SelectedIndexChangedï¼Œæœƒè‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é¸æ“‡çš„åœ°åœ–
                    }
                }
            }

            // å¦‚æœå·²ç¶“æœ‰åœ°åœ–è³‡æ–™ï¼Œå¡«å…… comboBox
            if (Share.MapDataList != null && Share.MapDataList.Count > 0)
            {
                LogPerf("[FORM-LOAD] Filling comboBox...");
                // å„²å­˜æ‰€æœ‰åœ°åœ–é …ç›®ä¾›éæ¿¾ä½¿ç”¨
                allMapItems.Clear();
                foreach (string key in Utils.SortAsc(Share.MapDataList.Keys))
                {
                    Struct.L1Map l1Map = Share.MapDataList[key];
                    allMapItems.Add(string.Format("{0}-{1}", key, l1Map.szName));
                }

                isFiltering = true;
                this.comboBox1.Items.Clear();
                this.comboBox1.BeginUpdate();
                foreach (var item in allMapItems)
                {
                    this.comboBox1.Items.Add(item);
                }
                this.comboBox1.EndUpdate();
                isFiltering = false;

                // è®€å–ä¸Šæ¬¡é¸æ“‡çš„åœ°åœ–åç¨±
                if (this.comboBox1.Items.Count > 0)
                {
                    string lastMapName = "";

                    if (File.Exists(iniPath))
                    {
                        lastMapName = Utils.GetINI("MapForm", "LastSelectedMapName", "", iniPath);
                    }

                    // å¦‚æœæœ‰ä¸Šæ¬¡é¸æ“‡çš„åœ°åœ–ï¼Œæ‰¾åˆ°å®ƒ
                    int selectedIndex = 0;
                    if (!string.IsNullOrEmpty(lastMapName))
                    {
                        for (int i = 0; i < this.comboBox1.Items.Count; i++)
                        {
                            if (this.comboBox1.Items[i].ToString() == lastMapName)
                            {
                                selectedIndex = i;
                                break;
                            }
                        }
                    }

                    LogPerf($"[FORM-LOAD] Setting comboBox1.SelectedIndex={selectedIndex}");
                    this.comboBox1.SelectedIndex = selectedIndex;
                }
            }
            LogPerf("[FORM-LOAD] End");
        }

        private void openToolStripMenuItem_Click(object sender, EventArgs e)
        {
            using (FolderBrowserDialog folderDialog = new FolderBrowserDialog())
            {
                folderDialog.Description = "è«‹é¸æ“‡å¤©å ‚è³‡æ–™å¤¾";
                folderDialog.ShowNewFolderButton = false;

                string iniPath = Path.GetTempPath() + "mapviewer.ini";
                if (File.Exists(iniPath))
                {
                    string savedPath = Utils.GetINI("Path", "LineagePath", "", iniPath);
                    if (!string.IsNullOrEmpty(savedPath) && Directory.Exists(savedPath))
                        folderDialog.SelectedPath = savedPath;
                }
                else
                {
                    folderDialog.SelectedPath = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles);
                }

                if (folderDialog.ShowDialog() != DialogResult.OK || string.IsNullOrEmpty(folderDialog.SelectedPath))
                    return;

                this.toolStripStatusLabel3.Text = folderDialog.SelectedPath;
                Share.LineagePath = folderDialog.SelectedPath;
                Utils.WriteINI("Path", "LineagePath", folderDialog.SelectedPath, iniPath);
                this.LoadMap(folderDialog.SelectedPath);
            }
        }

        // åŒ¯å‡ºåœ°åœ–é€šè¡Œè³‡æ–™çµ¦ä¼ºæœå™¨ä½¿ç”¨ï¼ˆL1J æ ¼å¼ï¼‰
        private void exportL1JToolStripMenuItem_Click(object sender, EventArgs e)
        {
            ExportPassabilityData(isL1JFormat: true);
        }

        // åŒ¯å‡ºåœ°åœ–é€šè¡Œè³‡æ–™çµ¦ä¼ºæœå™¨ä½¿ç”¨ï¼ˆDIR æ ¼å¼ï¼‰
        private void exportDIRToolStripMenuItem_Click(object sender, EventArgs e)
        {
            ExportPassabilityData(isL1JFormat: false);
        }

        // é€šç”¨åŒ¯å‡ºé€šè¡Œè³‡æ–™å‡½æ•¸
        private void ExportPassabilityData(bool isL1JFormat)
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–ï¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆåœ¨ S32 ç·¨è¼¯å™¨ä¸­è¼‰å…¥åœ°åœ–è³‡æ–™ï¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            string formatName = isL1JFormat ? "L1J" : "DIR";
            using (SaveFileDialog saveDialog = new SaveFileDialog())
            {
                saveDialog.Filter = "æ–‡å­—æª” (*.txt)|*.txt";
                saveDialog.FileName = $"{_document.MapId}.txt";
                saveDialog.Title = $"åŒ¯å‡ºåœ°åœ–é€šè¡Œè³‡æ–™ ({formatName} æ ¼å¼)";

                if (saveDialog.ShowDialog() == DialogResult.OK)
                {
                    try
                    {
                        ExportMapData(saveDialog.FileName, isL1JFormat);
                        MessageBox.Show($"å·²æˆåŠŸåŒ¯å‡ºè‡³ï¼š\n{saveDialog.FileName}\næ ¼å¼: {formatName}", "åŒ¯å‡ºå®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        // åŒ¯å‡ºåœ°åœ–è³‡æ–™ï¼ˆåƒè€ƒ MapTool çš„æ ¼å¼ï¼‰
        // MapTool çš„ readS32 è®€å–æ–¹å¼ï¼š
        // - å¾ offset 32768 + tileCount*6 + 2 é–‹å§‹
        // - æ¯å€‹æ ¼å­è®€ 4 bytes: [Attribute1, ?, Attribute2, ?]
        // - è¿´åœˆæ˜¯ 64x64ï¼ŒtileList_t1 å­˜ Attribute1ï¼ŒtileList_t3 å­˜ Attribute2
        // - xLength = S32æ•¸é‡ * 64ï¼ˆä¸æ˜¯ 128ï¼ï¼‰
        // isL1JFormat: true = L1J æ ¼å¼ï¼ˆç¶“éè½‰æ›ï¼‰ï¼Œfalse = DIR æ ¼å¼ï¼ˆåŸå§‹ 8 æ–¹å‘ï¼‰
        private void ExportMapData(string filePath, bool isL1JFormat = true)
        {
            // æ ¹æ“šå¯¦éš›è¼‰å…¥çš„ S32 æª”æ¡ˆè¨ˆç®—ç¶­åº¦ï¼ˆèˆ‡ CLI å’Œ MapTool ç›¸åŒæ–¹å¼ï¼‰
            // nLinBeginX/Y å·²ç¶“æ˜¯ Layer3 åº§æ¨™ï¼ˆæ¯å€å¡Š 64 æ ¼ï¼‰ï¼Œä¸éœ€è¦è½‰æ›
            int minX = int.MaxValue, maxX = int.MinValue;
            int minY = int.MaxValue, maxY = int.MinValue;

            foreach (var s32Data in _document.S32Files.Values)
            {
                int blockStartX = s32Data.SegInfo.nLinBeginX;  // å·²æ˜¯ Layer3 åº§æ¨™
                int blockStartY = s32Data.SegInfo.nLinBeginY;

                minX = Math.Min(minX, blockStartX);
                maxX = Math.Max(maxX, blockStartX + 63);  // å€å¡ŠçµæŸ = èµ·å§‹ + 63
                minY = Math.Min(minY, blockStartY);
                maxY = Math.Max(maxY, blockStartY + 63);
            }

            int xLength = maxX - minX + 1;
            int yLength = maxY - minY + 1;
            int xBegin = minX;
            int yBegin = minY;

            // å»ºç«‹ tileList_t1 å’Œ tileList_t3 é™£åˆ—ï¼ˆå°æ‡‰ MapTool çš„æ ¼å¼ï¼‰
            // t1 = Attribute1 (ä¸Šä¸‹æ–¹å‘åˆ¤æ–·), t3 = Attribute2 (å·¦å³æ–¹å‘åˆ¤æ–·)
            int[,] tileList_t1 = new int[xLength, yLength];
            int[,] tileList_t3 = new int[xLength, yLength];

            // åˆå§‹åŒ–ç‚ºä¸å¯é€šè¡Œï¼ˆ1 = é è¨­å€¼ï¼Œèˆ‡ MapTool ç›¸åŒï¼‰
            for (int x = 0; x < xLength; x++)
            {
                for (int y = 0; y < yLength; y++)
                {
                    tileList_t1[x, y] = 1;
                    tileList_t3[x, y] = 1;
                }
            }

            // å¾ S32 è³‡æ–™å¡«å…… tileList
            foreach (var s32Data in _document.S32Files.Values)
            {
                // è¨ˆç®—é€™å€‹ S32 åœ¨åœ°åœ–é™£åˆ—ä¸­çš„åç§»
                int offsetX = s32Data.SegInfo.nLinBeginX - xBegin;
                int offsetY = s32Data.SegInfo.nLinBeginY - yBegin;

                // Layer3 æ˜¯ 64x64
                for (int ly = 0; ly < 64; ly++)
                {
                    for (int lx = 0; lx < 64; lx++)
                    {
                        var attr = s32Data.Layer3[ly, lx];
                        if (attr == null) continue;

                        int gx = offsetX + lx;
                        int gy = offsetY + ly;

                        if (gx >= 0 && gx < xLength && gy >= 0 && gy < yLength)
                        {
                            // Attribute1 ç”¨æ–¼ä¸Šä¸‹æ–¹å‘ (t1), Attribute2 ç”¨æ–¼å·¦å³æ–¹å‘ (t3)
                            // éœ€è¦ç¶“é replaceException è™•ç†ï¼ˆèˆ‡ MapTool ç›¸åŒï¼‰
                            int attr1Value = ReplaceException(attr.Attribute1);
                            int attr2Value = ReplaceException(attr.Attribute2);
                            tileList_t1[gx, gy] = attr1Value;
                            tileList_t3[gx, gy] = attr2Value;
                        }
                    }
                }
            }

            // è¨ˆç®— 8 æ–¹å‘é€šè¡Œæ€§ï¼ˆåƒè€ƒ MapTool çš„ decryptDataï¼‰
            int[,] tileList = new int[xLength, yLength];

            for (int x = 0; x < xLength; x++)
            {
                for (int y = 0; y < yLength; y++)
                {
                    if (x + 1 < xLength && y + 1 < yLength && x - 1 >= 0 && y - 1 >= 0)
                    {
                        // D0: ä¸‹æ–¹ - isPassable_D0(x, y) => (tileList_t1[x, y + 1] & 1) == 0
                        if ((tileList_t1[x, y + 1] & 1) == 0)
                            tileList[x, y] += 1;
                        // D4: ä¸Šæ–¹ - isPassable_D4(x, y) => (tileList_t1[x, y] & 1) == 0
                        if ((tileList_t1[x, y] & 1) == 0)
                            tileList[x, y] += 2;
                        // D2: å·¦æ–¹ - isPassable_D2(x, y) => (tileList_t3[x - 1, y] & 1) == 0
                        if ((tileList_t3[x - 1, y] & 1) == 0)
                            tileList[x, y] += 4;
                        // D6: å³æ–¹ - isPassable_D6(x, y) => (tileList_t3[x, y] & 1) == 0
                        if ((tileList_t3[x, y] & 1) == 0)
                            tileList[x, y] += 8;

                        // D1: å·¦ä¸‹å°è§’ - isPassable_D1(x - 1, y + 1)
                        if (IsPassable_D1(tileList_t1, tileList_t3, x - 1, y + 1, xLength, yLength))
                            tileList[x, y] += 16;
                        // D3: å·¦ä¸Šå°è§’ - isPassable_D3(x - 1, y - 1)
                        if (IsPassable_D3(tileList_t1, tileList_t3, x - 1, y - 1, xLength, yLength))
                            tileList[x, y] += 32;
                        // D5: å³ä¸Šå°è§’ - isPassable_D5(x + 1, y - 1)
                        if (IsPassable_D5(tileList_t1, tileList_t3, x + 1, y - 1, xLength, yLength))
                            tileList[x, y] += 64;
                        // D7: å³ä¸‹å°è§’ - isPassable_D7(x + 1, y + 1)
                        if (IsPassable_D7(tileList_t1, tileList_t3, x + 1, y + 1, xLength, yLength))
                            tileList[x, y] += 128;

                        // å€åŸŸé¡å‹ - getZone(x, y) ä½¿ç”¨ tileList_t1[x, y]
                        tileList[x, y] += GetZone(tileList_t1[x, y]);
                    }
                }
            }

            // æ ¹æ“šæ ¼å¼é¸æ“‡è¼¸å‡ºè³‡æ–™
            int[,] outputData;
            if (isL1JFormat)
            {
                // L1J æ ¼å¼ï¼šç¶“éè½‰æ›çš„ç°¡åŒ–æ ¼å¼
                outputData = FormatL1J(tileList, xLength, yLength);
            }
            else
            {
                // DIR æ ¼å¼ï¼šç›´æ¥è¼¸å‡ºåŸå§‹ 8 æ–¹å‘ + å€åŸŸé¡å‹
                outputData = tileList;
            }

            // å¯«å…¥æª”æ¡ˆï¼ˆèˆ‡ MapTool ç›¸åŒæ ¼å¼ï¼Œä¸å«åº§æ¨™ç¯„åœï¼Œä¸å« BOMï¼‰
            using (StreamWriter writer = new StreamWriter(filePath, false, new System.Text.UTF8Encoding(false)))
            {
                // å¯«å…¥è³‡æ–™ï¼ˆy ç‚ºè¡Œï¼Œx ç‚ºåˆ—ï¼‰
                for (int y = 0; y < yLength; y++)
                {
                    StringBuilder line = new StringBuilder();
                    for (int x = 0; x < xLength; x++)
                    {
                        if (x > 0) line.Append(",");
                        line.Append(outputData[x, y]);
                    }
                    writer.WriteLine(line.ToString());
                }
            }

            this.toolStripStatusLabel1.Text = $"å·²åŒ¯å‡º {_document.MapId}.txt ({xLength}x{yLength})";
        }

        // å°è§’æ–¹å‘é€šè¡Œæ€§åˆ¤æ–·
        // æ³¨æ„ï¼šæ ¹æ“šå®¢æˆ¶ç«¯é€†å‘åˆ†æï¼Œt1 å’Œ t3 ç¾åœ¨éƒ½ä½¿ç”¨ Attribute1 çš„å€¼
        // isPassable_D1(x, y) => æª¢æŸ¥ç›¸é—œæ ¼å­çš„ Attribute1
        private bool IsPassable_D1(int[,] t1, int[,] t3, int x, int y, int xLen, int yLen)
        {
            if (x < 0 || x + 1 >= xLen || y < 0 || y >= yLen || y - 1 < 0) return false;
            return (t1[x, y] & 1) == 0 && (t1[x + 1, y] & 1) == 0 &&
                   (t3[x + 1, y] & 1) == 0 && (t3[x + 1, y - 1] & 1) == 0;
        }

        // isPassable_D3(x, y) => æª¢æŸ¥ç›¸é—œæ ¼å­çš„ Attribute1
        private bool IsPassable_D3(int[,] t1, int[,] t3, int x, int y, int xLen, int yLen)
        {
            if (x < 0 || x + 1 >= xLen || y < 0 || y + 1 >= yLen) return false;
            return (t1[x, y + 1] & 1) == 0 && (t1[x + 1, y + 1] & 1) == 0 &&
                   (t3[x, y] & 1) == 0 && (t3[x, y + 1] & 1) == 0;
        }

        // isPassable_D5(x, y) => æª¢æŸ¥ç›¸é—œæ ¼å­çš„ Attribute1
        private bool IsPassable_D5(int[,] t1, int[,] t3, int x, int y, int xLen, int yLen)
        {
            if (x < 1 || x >= xLen || y < 0 || y + 1 >= yLen) return false;
            return (t1[x, y + 1] & 1) == 0 && (t1[x - 1, y + 1] & 1) == 0 &&
                   (t3[x - 1, y] & 1) == 0 && (t3[x - 1, y + 1] & 1) == 0;
        }

        // isPassable_D7(x, y) => æª¢æŸ¥ç›¸é—œæ ¼å­çš„ Attribute1
        private bool IsPassable_D7(int[,] t1, int[,] t3, int x, int y, int xLen, int yLen)
        {
            if (x < 1 || x >= xLen || y < 1 || y >= yLen) return false;
            return (t1[x, y] & 1) == 0 && (t1[x - 1, y] & 1) == 0 &&
                   (t3[x - 1, y] & 1) == 0 && (t3[x - 1, y - 1] & 1) == 0;
        }

        // æ›¿æ›ä¾‹å¤–å€¼ï¼ˆå®Œå…¨æŒ‰ç…§ MapTool çš„ replaceException é‚è¼¯ï¼‰
        // æŸäº›ç‰¹æ®Šå±¬æ€§å€¼éœ€è¦æ›¿æ›ç‚º 5
        private int ReplaceException(int value)
        {
            if (value == 65 || value == 69 || value == 73 || value == 33 || value == 77)
                return 5;
            return value;
        }

        // å–å¾—å€åŸŸé¡å‹ï¼ˆå®Œå…¨æŒ‰ç…§ MapTool çš„ getZone é‚è¼¯ï¼‰
        // çœ‹ tileList_t1[x,y] çš„ä½ 4 ä½å…ƒï¼ˆåå…­é€²ä½çš„æœ€å¾Œä¸€ä½ï¼‰
        private int GetZone(int tileValue)
        {
            string hex = (tileValue & 0x0F).ToString("X1");
            // 0-3: ä¸€èˆ¬å€åŸŸ (256)
            if (hex == "0" || hex == "1" || hex == "2" || hex == "3")
                return 256;
            // 4-7, C-F: å®‰å…¨å€åŸŸ (512)
            else if (hex == "4" || hex == "5" || hex == "6" || hex == "7" ||
                     hex == "C" || hex == "D" || hex == "E" || hex == "F")
                return 512;
            // 8-B: æˆ°é¬¥å€åŸŸ (1024)
            else if (hex == "8" || hex == "9" || hex == "A" || hex == "B")
                return 1024;
            return 256;
        }

        // è½‰æ›ç‚º L1J æ ¼å¼ï¼ˆå®Œå…¨æŒ‰ç…§ MapTool çš„ formate_L1J é‚è¼¯ï¼‰
        private int[,] FormatL1J(int[,] tileList, int xLength, int yLength)
        {
            int[,] result = new int[xLength, yLength];

            for (int y = 0; y < yLength; y++)
            {
                for (int x = 0; x < xLength; x++)
                {
                    int tile = tileList[x, y];

                    // (tile & 1) == 1 || (tile & 2) == 2 => +2
                    if ((tile & 1) == 1 || (tile & 2) == 2)
                        result[x, y] += 2;

                    // (tile & 4) == 4 || (tile & 8) == 8 => +1
                    if ((tile & 4) == 4 || (tile & 8) == 8)
                        result[x, y] += 1;

                    // (tile & 1) == 1 && (tile & 2) == 2 => +8
                    if ((tile & 1) == 1 && (tile & 2) == 2)
                        result[x, y] += 8;

                    // (tile & 4) == 4 && (tile & 8) == 8 => +4
                    if ((tile & 4) == 4 && (tile & 8) == 8)
                        result[x, y] += 4;

                    // (tile & 256) == 256 => ä»€éº¼éƒ½ä¸åšï¼ˆä¸€èˆ¬å€åŸŸï¼‰
                    // (tile & 512) == 512 => +16ï¼ˆå®‰å…¨å€åŸŸï¼‰
                    if ((tile & 512) == 512)
                        result[x, y] += 16;

                    // (tile & 1024) == 1024 => +32ï¼ˆæˆ°é¬¥å€åŸŸï¼‰
                    if ((tile & 1024) == 1024)
                        result[x, y] += 32;
                }
            }

            return result;
        }

        public void LoadMap(string selectedPath)
        {
            LogPerf("[LOADMAP] Start");

            // å…ˆåœ¨ UI åŸ·è¡Œç·’æª¢æŸ¥è·¯å¾‘æ˜¯å¦æœ‰æ•ˆï¼ˆé¿å… MessageBox åœ¨èƒŒæ™¯åŸ·è¡Œç·’å½ˆå‡ºï¼‰
            string szMapPath = string.Format(@"{0}\map\", selectedPath);
            if (!Directory.Exists(szMapPath))
            {
                MessageBox.Show("éŒ¯èª¤çš„å¤©å ‚è·¯å¾‘");
                return;
            }

            // åˆ‡æ›è³‡æ–™å¤¾æ™‚æ¸…é™¤æ‰€æœ‰å¿«å–ï¼ˆä¸åŒè³‡æ–™å¤¾çš„ tile/idx å…§å®¹ä¸åŒï¼‰
            _tilFileCache.Clear();
            _tilRemasterCache.Clear();
            tileDataCache.Clear();
            cachedAggregatedTiles.Clear();
            Share.IdxDataList.Clear();  // æ¸…é™¤ idx å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è®€å–æ–°è³‡æ–™å¤¾çš„ idx
            Share.MapDataList.Clear();  // æ¸…é™¤åœ°åœ–å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è®€å–æ–°è³‡æ–™å¤¾çš„åœ°åœ–
            TileHashManager.ClearCache();  // æ¸…é™¤ Tile MD5 å¿«å–
            _listTilMaxId = null;       // æ¸…é™¤ list.til å¿«å–

            // æ¸…é™¤ç•¶å‰åœ°åœ–ç‹€æ…‹
            _document.S32Files.Clear();
            _document.MapId = null;
            lstS32Files.Items.Clear();
            _checkedS32Files.Clear();
            lvTiles.Items.Clear();
            lvGroupThumbnails.Items.Clear();
            ClearS32BlockCache();
            ClearMiniMapCache();

            // æ¸…é™¤ viewport
            lock (_viewportBitmapLock)
            {
                if (_viewportBitmap != null)
                {
                    _viewportBitmap.Dispose();
                    _viewportBitmap = null;
                }
            }
            pictureBox1.Invalidate();

            LogPerf("[LOADMAP] Cache cleared");

            Utils.ShowProgressBar(true, this);
            this.toolStripStatusLabel1.Text = "æ­£åœ¨è®€å–åœ°åœ–åˆ—è¡¨...";

            // åœ¨èƒŒæ™¯åŸ·è¡Œç·’è¼‰å…¥åœ°åœ–è³‡æ–™
            Task.Run(() =>
            {
                LogPerf("[LOADMAP-BG] Task started, calling L1MapHelper.Read...");
                var stopwatch = Stopwatch.StartNew();
                var dictionary = L1MapHelper.Read(selectedPath);
                stopwatch.Stop();
                long readMs = stopwatch.ElapsedMilliseconds;
                LogPerf($"[LOADMAP-BG] L1MapHelper.Read done: {readMs}ms, maps={dictionary.Count}");

                // å›åˆ° UI åŸ·è¡Œç·’æ›´æ–°ä»‹é¢
                LogPerf("[LOADMAP-BG] Invoking UI update...");
                this.BeginInvoke((MethodInvoker)delegate
                {
                    LogPerf("[LOADMAP-UI] BeginInvoke callback started");
                    stopwatch.Restart();

                    // å„²å­˜æ‰€æœ‰åœ°åœ–é …ç›®ä¾›éæ¿¾ä½¿ç”¨
                    allMapItems.Clear();
                    foreach (string key in Utils.SortAsc(dictionary.Keys))
                    {
                        Struct.L1Map l1Map = dictionary[key];
                        allMapItems.Add(string.Format("{0}-{1}", key, l1Map.szName));
                    }

                    // å¡«å…… ComboBoxï¼ˆä¿ç•™çµ¦ç›¸å®¹æ€§ï¼‰
                    isFiltering = true;
                    this.comboBox1.Items.Clear();
                    this.comboBox1.BeginUpdate();
                    foreach (var item in allMapItems)
                    {
                        this.comboBox1.Items.Add(item);
                    }
                    this.comboBox1.EndUpdate();
                    isFiltering = false;

                    // å¡«å…… lstMaps ListBox
                    this.lstMaps.BeginUpdate();
                    this.lstMaps.Items.Clear();
                    foreach (var item in allMapItems)
                    {
                        this.lstMaps.Items.Add(item);
                    }
                    this.lstMaps.EndUpdate();

                    long uiMs = stopwatch.ElapsedMilliseconds;
                    LogPerf($"[LOADMAP-UI] Lists filled: {uiMs}ms");

                    // è®€å–ä¸Šæ¬¡é¸æ“‡çš„åœ°åœ–åç¨±ï¼ˆæ”¹ç”¨åç¨±è€Œéç´¢å¼•ï¼Œé¿å…éæ¿¾å¾Œç´¢å¼•éŒ¯äº‚ï¼‰
                    if (this.comboBox1.Items.Count > 0)
                    {
                        string iniPath = Path.GetTempPath() + "mapviewer.ini";
                        string lastMapName = "";

                        if (File.Exists(iniPath))
                        {
                            lastMapName = Utils.GetINI("MapForm", "LastSelectedMapName", "", iniPath);
                        }

                        // å¦‚æœæœ‰ä¸Šæ¬¡é¸æ“‡çš„åœ°åœ–ï¼Œæ‰¾åˆ°å®ƒ
                        int selectedIndex = 0;
                        if (!string.IsNullOrEmpty(lastMapName))
                        {
                            for (int i = 0; i < this.comboBox1.Items.Count; i++)
                            {
                                if (this.comboBox1.Items[i].ToString() == lastMapName)
                                {
                                    selectedIndex = i;
                                    break;
                                }
                            }
                        }

                        // å…ˆè¨­ç‚º -1 å†è¨­å›ä¾†ï¼Œå¼·åˆ¶è§¸ç™¼ SelectedIndexChanged äº‹ä»¶
                        // é€™æ¨£å³ä½¿é¸æ“‡ç›¸åŒçš„ indexï¼Œä¹Ÿæœƒé‡æ–°è¼‰å…¥ S32 æª”æ¡ˆ
                        LogPerf($"[LOADMAP-UI] Setting comboBox1.SelectedIndex={selectedIndex} (will trigger LoadS32FileList)");
                        this.comboBox1.SelectedIndex = -1;
                        this.comboBox1.SelectedIndex = selectedIndex;
                        LogPerf("[LOADMAP-UI] comboBox1.SelectedIndex set done");

                        // åŒæ­¥é¸æ“‡ lstMaps
                        isFiltering = true;  // é˜²æ­¢ lstMaps å†æ¬¡è§¸ç™¼è¼‰å…¥
                        this.lstMaps.SelectedIndex = selectedIndex;
                        isFiltering = false;
                    }

                    this.toolStripStatusLabel2.Text = $"Maps={dictionary.Count}, Files={L1MapHelper.LastTotalFileCount}";
                    this.toolStripStatusLabel1.Text = $"è¼‰å…¥å®Œæˆ - Zone3desc:{L1MapHelper.LastLoadZone3descMs}ms, ZoneXml:{L1MapHelper.LastLoadZoneXmlMs}ms, æƒæç›®éŒ„:{L1MapHelper.LastScanDirectoriesMs}ms, UI:{uiMs}ms (ç¸½è¨ˆ:{readMs + uiMs}ms)";
                    Utils.ShowProgressBar(false, this);
                    LogPerf("[LOADMAP-UI] Done");
                });
            });
            LogPerf("[LOADMAP] Task.Run started (async)");
        }

        // åœ°åœ–æœå°‹éæ¿¾
        private void comboBox1_TextChanged(object sender, EventArgs e)
        {
            if (isFiltering) return;

            string searchText = this.comboBox1.Text.ToLower();

            // å¦‚æœæ–‡å­—ç‚ºç©ºæˆ–æ˜¯é¸ä¸­äº†ä¸€å€‹é …ç›®ï¼Œä¸éæ¿¾
            if (string.IsNullOrEmpty(searchText) || this.comboBox1.SelectedItem != null &&
                this.comboBox1.SelectedItem.ToString().ToLower() == searchText)
            {
                return;
            }

            isFiltering = true;

            // è¨˜ä½æ¸¸æ¨™ä½ç½®
            int cursorPos = this.comboBox1.SelectionStart;

            // éæ¿¾é …ç›®
            var filteredItems = allMapItems
                .Where(item => item.ToLower().Contains(searchText))
                .ToList();

            this.comboBox1.BeginUpdate();
            this.comboBox1.Items.Clear();
            foreach (var item in filteredItems)
            {
                this.comboBox1.Items.Add(item);
            }
            this.comboBox1.EndUpdate();

            // é‚„åŸæ–‡å­—å’Œæ¸¸æ¨™ä½ç½®
            this.comboBox1.Text = searchText;
            this.comboBox1.SelectionStart = cursorPos;
            this.comboBox1.SelectionLength = 0;

            // é¡¯ç¤ºä¸‹æ‹‰é¸å–®
            if (filteredItems.Count > 0 && !this.comboBox1.DroppedDown)
            {
                this.comboBox1.DroppedDown = true;
            }

            isFiltering = false;

            this.toolStripStatusLabel1.Text = $"æ‰¾åˆ° {filteredItems.Count} å€‹åœ°åœ–";
        }

        // æ¸…ç©ºæœå°‹ï¼Œé¡¯ç¤ºæ‰€æœ‰åœ°åœ–
        private void ResetMapFilter()
        {
            isFiltering = true;
            this.comboBox1.BeginUpdate();
            this.comboBox1.Items.Clear();
            foreach (var item in allMapItems)
            {
                this.comboBox1.Items.Add(item);
            }
            this.comboBox1.EndUpdate();
            isFiltering = false;
        }

        // ===== å·¦ä¸‹è§’ Tab: åœ°åœ–åˆ—è¡¨ =====

        // åœ°åœ–æœå°‹ï¼ˆå·¦ä¸‹è§’ Tabï¼‰
        private void txtMapSearch_TextChanged(object sender, EventArgs e)
        {
            if (isFiltering) return;

            string searchText = txtMapSearch.Text.ToLower().Trim();

            isFiltering = true;
            lstMaps.BeginUpdate();
            lstMaps.Items.Clear();

            if (string.IsNullOrEmpty(searchText))
            {
                // é¡¯ç¤ºæ‰€æœ‰åœ°åœ–
                foreach (var item in allMapItems)
                {
                    lstMaps.Items.Add(item);
                }
            }
            else
            {
                // éæ¿¾åœ°åœ–
                foreach (var item in allMapItems)
                {
                    if (item.ToLower().Contains(searchText))
                    {
                        lstMaps.Items.Add(item);
                    }
                }
            }

            lstMaps.EndUpdate();
            isFiltering = false;

            this.toolStripStatusLabel1.Text = $"æ‰¾åˆ° {lstMaps.Items.Count} å€‹åœ°åœ–";
        }

        // åœ°åœ–åˆ—è¡¨é¸æ“‡è®Šæ›´ï¼ˆå·¦ä¸‹è§’ Tabï¼‰
        private void lstMaps_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (isFiltering) return;
            if (lstMaps.SelectedItem == null) return;

            string selectedMapName = lstMaps.SelectedItem.ToString();

            // å–å¾—åœ°åœ– ID
            string szSelectName = selectedMapName;
            if (szSelectName.Contains("-"))
                szSelectName = szSelectName.Split('-')[0].Trim();

            // é©—è­‰åœ°åœ–æ˜¯å¦å­˜åœ¨
            if (!Share.MapDataList.ContainsKey(szSelectName))
            {
                toolStripStatusLabel1.Text = $"åœ°åœ– {szSelectName} ä¸å­˜åœ¨";
                return;
            }

            // ä¿å­˜ç•¶å‰é¸æ“‡çš„åœ°åœ–åç¨±
            string iniPath = Path.GetTempPath() + "mapviewer.ini";
            Utils.WriteINI("MapForm", "LastSelectedMapName", selectedMapName, iniPath);

            // é‡ç½®ç¸®æ”¾ç´šåˆ¥
            zoomLevel = 1.0;
            if (originalMapImage != null)
            {
                originalMapImage.Dispose();
                originalMapImage = null;
            }

            // é‡ç½® S32 ç·¨è¼¯å™¨ç¸®æ”¾ç´šåˆ¥
            s32ZoomLevel = 1.0;
            if (originalS32Image != null)
            {
                originalS32Image.Dispose();
                originalS32Image = null;
            }

            // åŒæ­¥ comboBox1ï¼ˆä¿æŒç›¸å®¹æ€§ï¼‰
            isFiltering = true;
            for (int i = 0; i < comboBox1.Items.Count; i++)
            {
                if (comboBox1.Items[i].ToString() == selectedMapName)
                {
                    comboBox1.SelectedIndex = i;
                    break;
                }
            }
            isFiltering = false;

            // è¼‰å…¥åœ°åœ–
            try
            {
                var swMapSelect = Stopwatch.StartNew();

                // è·³é doPaintEvent - S32 ç·¨è¼¯å™¨æœ‰è‡ªå·±çš„ viewport æ¸²æŸ“ï¼Œä¸éœ€è¦èˆŠç‰ˆåœ°åœ–ç¸®åœ–
                // é€™å¯ä»¥ç¯€çœ 6+ ç§’ï¼ˆåŸæœ¬æœƒè®€å–æ‰€æœ‰ S32 æª”æ¡ˆè¨ˆç®— SHA1ï¼‰
                LogPerf($"[MAP-SELECT] Skipping doPaintEvent (S32 editor mode)");

                // è¼‰å…¥è©²åœ°åœ–çš„ s32 æª”æ¡ˆæ¸…å–®
                LoadS32FileList(szSelectName);
                LogPerf($"[MAP-SELECT] LoadS32FileList: {swMapSelect.ElapsedMilliseconds}ms");
            }
            catch (Exception ex)
            {
                toolStripStatusLabel1.Text = $"è¼‰å…¥åœ°åœ–å¤±æ•—: {ex.Message}";
            }
        }

        // åœ°åœ–åˆ—è¡¨å³éµé¸å–®
        private void lstMaps_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            int index = lstMaps.IndexFromPoint(e.Location);
            if (index < 0 || index >= lstMaps.Items.Count)
                return;

            // é¸å–è©²é …ç›®
            lstMaps.SelectedIndex = index;
            string selectedMapName = lstMaps.Items[index].ToString();

            // å–å¾—åœ°åœ– ID
            string mapId = selectedMapName;
            if (mapId.Contains("-"))
                mapId = mapId.Split('-')[0].Trim();

            // å»ºç«‹å³éµé¸å–®
            var menu = new ContextMenuStrip();

            // åŒ¯å‡ºç‚ºåœ°åœ–åŒ…é¸é …
            var exportItem = new ToolStripMenuItem("åŒ¯å‡ºç‚ºåœ°åœ–åŒ… (fs32)...");
            exportItem.Click += (s, args) => ExportMapAsFs32(mapId);
            menu.Items.Add(exportItem);

            menu.Show(lstMaps, e.Location);
        }

        // åŒ¯å‡ºæ•´å¼µåœ°åœ–ç‚º fs32
        private void ExportMapAsFs32(string mapId)
        {
            // æª¢æŸ¥åœ°åœ–æ˜¯å¦å­˜åœ¨
            if (!Share.MapDataList.ContainsKey(mapId))
            {
                MessageBox.Show($"åœ°åœ– {mapId} ä¸å­˜åœ¨", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            // é¡¯ç¤ºåŒ¯å‡ºé¸é …å°è©±æ¡†
            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: false, hasSelection: false))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                try
                {
                    // å…ˆè¼‰å…¥ S32 æª”æ¡ˆ
                    toolStripStatusLabel1.Text = $"æ­£åœ¨è¼‰å…¥åœ°åœ– {mapId}...";
                    Application.DoEvents();

                    var currentMap = Share.MapDataList[mapId];
                    var tempDocument = new MapDocument { MapId = mapId };

                    int loadedCount = 0;
                    foreach (var kvp in currentMap.FullFileNameList)
                    {
                        string filePath = kvp.Key;
                        var segInfo = kvp.Value;

                        if (File.Exists(filePath))
                        {
                            S32Data s32Data = null;
                            if (segInfo.isS32)
                            {
                                // è§£æ .s32 æª”æ¡ˆ
                                s32Data = S32Parser.ParseFile(filePath);
                            }
                            else
                            {
                                // è§£æ .seg æª”æ¡ˆ
                                s32Data = SegParser.ParseFile(filePath);
                            }

                            if (s32Data != null)
                            {
                                s32Data.SegInfo = segInfo;
                                s32Data.FilePath = filePath;
                                tempDocument.S32Files[filePath] = s32Data;
                                loadedCount++;
                                if (loadedCount % 10 == 0)
                                {
                                    toolStripStatusLabel1.Text = $"æ­£åœ¨è¼‰å…¥åœ°åœ–æª”æ¡ˆ... ({loadedCount})";
                                    Application.DoEvents();
                                }
                            }
                        }
                    }

                    if (tempDocument.S32Files.Count == 0)
                    {
                        MessageBox.Show($"åœ°åœ– {mapId} æ²’æœ‰å¯ç”¨çš„åœ°åœ–æª”æ¡ˆ (.s32 æˆ– .seg)", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    // æª¢æŸ¥ç•°å¸¸ï¼ˆåœ¨é¸æ“‡å„²å­˜ä½ç½®ä¹‹å‰ï¼Œè‹¥æœƒç§»é™¤ L8 æ“´å±•å‰‡ä¸æª¢æŸ¥ï¼‰
                    if (!CheckLayer5IssuesAndConfirm(tempDocument.S32Files, "åŒ¯å‡º", checkTileLimit: false, checkLayer8Extended: !dialog.StripLayer8Ext))
                        return;

                    // é¸æ“‡å„²å­˜ä½ç½®
                    using (var saveDialog = new SaveFileDialog())
                    {
                        saveDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32";
                        saveDialog.FileName = $"{mapId}.fs32";

                        if (saveDialog.ShowDialog() != DialogResult.OK)
                            return;

                        toolStripStatusLabel1.Text = $"æ­£åœ¨å»ºç«‹ fs32 æª”æ¡ˆ...";
                        Application.DoEvents();

                        // å»ºç«‹ fs32
                        var fs32 = Fs32Writer.CreateFromMap(tempDocument, dialog.LayerFlags, dialog.IncludeTiles, dialog.StripLayer8Ext);

                        // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                        if (dialog.IncludeTiles && fs32.Tiles.Count > 0)
                        {
                            int remasterCount = fs32.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                            if (remasterCount > 0)
                            {
                                var result = MessageBox.Show(
                                    $"åœ°åœ–åŒ…ä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                    "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                    "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                    "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                    "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                    MessageBoxButtons.YesNo,
                                    MessageBoxIcon.Question,
                                    MessageBoxDefaultButton.Button1);

                                if (result == DialogResult.Yes)
                                {
                                    foreach (var tileId in fs32.Tiles.Keys.ToList())
                                    {
                                        var tile = fs32.Tiles[tileId];
                                        if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                        {
                                            tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                            tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                        }
                                    }
                                }
                            }
                        }

                        Fs32Writer.Write(fs32, saveDialog.FileName);

                        string resultMsg = $"å·²åŒ¯å‡ºè‡³ {saveDialog.FileName}\n({fs32.Blocks.Count} å€å¡Š, {fs32.Tiles.Count} åœ–å¡Š)";
                        toolStripStatusLabel1.Text = resultMsg.Replace("\n", " ");
                        ShowAutoCloseMessage(resultMsg, "åŒ¯å‡ºå®Œæˆ");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[Export] Error: {ex}");
                    MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (isFiltering) return;  // éæ¿¾ä¸­ä¸è§¸ç™¼
            if (this.comboBox1.SelectedItem == null)
                return;

            LogPerf($"[COMBOBOX-CHANGED] Start, map={this.comboBox1.SelectedItem}");
            var swCombo = Stopwatch.StartNew();

            // ä¿å­˜ç•¶å‰é¸æ“‡çš„åœ°åœ–åç¨±ï¼ˆç”¨åç¨±è€Œéç´¢å¼•ï¼Œé¿å…éæ¿¾å¾ŒéŒ¯äº‚ï¼‰
            string iniPath = Path.GetTempPath() + "mapviewer.ini";
            Utils.WriteINI("MapForm", "LastSelectedMapName", this.comboBox1.SelectedItem.ToString(), iniPath);

            // é‡ç½®ç¸®æ”¾ç´šåˆ¥
            zoomLevel = 1.0;
            if (originalMapImage != null)
            {
                originalMapImage.Dispose();
                originalMapImage = null;
            }

            // é‡ç½® S32 ç·¨è¼¯å™¨ç¸®æ”¾ç´šåˆ¥
            s32ZoomLevel = 1.0;
            if (originalS32Image != null)
            {
                originalS32Image.Dispose();
                originalS32Image = null;
            }

            string szSelectName = this.comboBox1.SelectedItem.ToString();
            if (szSelectName.Contains("-"))
                szSelectName = szSelectName.Split('-')[0].Trim();

            // è·³é doPaintEvent - S32 ç·¨è¼¯å™¨æœ‰è‡ªå·±çš„ viewport æ¸²æŸ“ï¼Œä¸éœ€è¦èˆŠç‰ˆåœ°åœ–ç¸®åœ–
            // é€™å¯ä»¥ç¯€çœ 6+ ç§’ï¼ˆåŸæœ¬æœƒè®€å–æ‰€æœ‰ S32 æª”æ¡ˆè¨ˆç®— SHA1ï¼‰
            LogPerf($"[COMBOBOX-CHANGED] Skipping doPaintEvent (S32 editor mode)");

            // è¼‰å…¥è©²åœ°åœ–çš„ s32 æª”æ¡ˆæ¸…å–®
            LoadS32FileList(szSelectName);
            LogPerf($"[COMBOBOX-CHANGED] LoadS32FileList done: {swCombo.ElapsedMilliseconds}ms");

            // é¸æ“‡å¾Œé‡ç½®éæ¿¾ï¼Œé¡¯ç¤ºæ‰€æœ‰åœ°åœ–
            ResetMapFilter();
            LogPerf($"[COMBOBOX-CHANGED] End, total={swCombo.ElapsedMilliseconds}ms");
        }

        // ===== å°åœ°åœ– =====
        // å°åœ°åœ–å°ºå¯¸å¸¸æ•¸
        private const int MINIMAP_SIZE = 400;

        // å°åœ°åœ–çš„ç¸®æ”¾æ¯”ä¾‹å’Œåç§»ï¼ˆå¿«å–è¨ˆç®—çµæœï¼‰
        private float _miniMapScale = 1.0f;
        private int _miniMapOffsetX = 0;
        private int _miniMapOffsetY = 0;
        private readonly object _miniMapLock = new object();
        private bool _miniMapRendering = false;  // æ˜¯å¦æ­£åœ¨æ¸²æŸ“ä¸­

        /// <summary>
        /// æ›´æ–°å°åœ°åœ–ï¼ˆå¦‚æœæ²’æœ‰å¿«å–å‰‡èƒŒæ™¯æ¸²æŸ“ï¼Œå¦å‰‡åªæ›´æ–°ç´…æ¡†ï¼‰
        /// </summary>
        private void UpdateMiniMap()
        {
            var sw = Stopwatch.StartNew();
            try
            {
                int mapWidth = _viewState.MapWidth;
                int mapHeight = _viewState.MapHeight;

                if (mapWidth <= 0 || mapHeight <= 0)
                    return;

                // å¦‚æœæ²’æœ‰å¿«å–ä¸”æ²’æœ‰åœ¨æ¸²æŸ“ä¸­ï¼Œå•Ÿå‹•èƒŒæ™¯æ¸²æŸ“
                if (_miniMapFullBitmap == null && !_miniMapRendering)
                {
                    LogPerf($"[MINIMAP-UPDATE] starting full render (no cache)");
                    // å…ˆé¡¯ç¤ºä¸€å€‹ã€Œæ¸²æŸ“ä¸­ã€çš„ä½”ä½åœ–
                    ShowMiniMapPlaceholder();
                    RenderMiniMapFullAsync();
                    return;
                }

                // æ›´æ–°ç´…æ¡†é¡¯ç¤º
                UpdateMiniMapRedBox();
                sw.Stop();
                if (sw.ElapsedMilliseconds > 5)
                {
                    LogPerf($"[MINIMAP-UPDATE] redbox only, took {sw.ElapsedMilliseconds}ms");
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
        }

        /// <summary>
        /// é¡¯ç¤ºå°åœ°åœ–ä½”ä½åœ–ï¼ˆæ¸²æŸ“ä¸­æç¤ºï¼‰
        /// </summary>
        private void ShowMiniMapPlaceholder()
        {
            Bitmap placeholder = new Bitmap(MINIMAP_SIZE, MINIMAP_SIZE);
            using (Graphics g = Graphics.FromImage(placeholder))
            {
                g.Clear(Color.FromArgb(30, 30, 30));
                using (var font = new Font("Microsoft JhengHei", 12))
                using (var brush = new SolidBrush(Color.Gray))
                {
                    string text = "å°åœ°åœ–ç¹ªè£½ä¸­...";
                    var size = g.MeasureString(text, font);
                    g.DrawString(text, font, brush,
                        (MINIMAP_SIZE - size.Width) / 2,
                        (MINIMAP_SIZE - size.Height) / 2);
                }
            }
            miniMapPictureBox.Image?.Dispose();
            miniMapPictureBox.Image = placeholder;
        }

        /// <summary>
        /// èƒŒæ™¯æ¸²æŸ“å®Œæ•´çš„å°åœ°åœ–ï¼ˆä½¿ç”¨å…±ç”¨çš„ MiniMapRendererï¼‰
        /// </summary>
        private void RenderMiniMapFullAsync()
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return;

            int mapWidth = _viewState.MapWidth;
            int mapHeight = _viewState.MapHeight;
            if (mapWidth <= 0 || mapHeight <= 0)
                return;

            // æ¨™è¨˜æ­£åœ¨æ¸²æŸ“
            _miniMapRendering = true;

            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ï¼ˆåœ¨ UI åŸ·è¡Œç·’è¨ˆç®—ä¸¦å¿«å–ï¼‰
            float scale = Math.Min((float)MINIMAP_SIZE / mapWidth, (float)MINIMAP_SIZE / mapHeight);
            int scaledWidth = (int)(mapWidth * scale);
            int scaledHeight = (int)(mapHeight * scale);

            _miniMapScale = scale;
            _miniMapOffsetX = (MINIMAP_SIZE - scaledWidth) / 2;
            _miniMapOffsetY = (MINIMAP_SIZE - scaledHeight) / 2;

            // è¤‡è£½éœ€è¦çš„è³‡æ–™ï¼ˆé¿å…è·¨åŸ·è¡Œç·’å­˜å–ï¼‰
            var s32FilesSnapshot = _document.S32Files.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

            // å»ºç«‹å‹¾é¸çš„ S32 æª”æ¡ˆæ¸…å–®
            HashSet<string> checkedFilePaths = new HashSet<string>();
            for (int i = 0; i < lstS32Files.Items.Count; i++)
            {
                if (lstS32Files.GetItemChecked(i) && lstS32Files.Items[i] is S32FileItem item)
                {
                    checkedFilePaths.Add(item.FilePath);
                }
            }

            int s32Count = checkedFilePaths.Count;

            // èƒŒæ™¯åŸ·è¡Œç·’æ¸²æŸ“ï¼ˆä½¿ç”¨å…±ç”¨çš„ MiniMapRendererï¼‰
            Task.Run(() =>
            {
                try
                {
                    MiniMapRenderer.RenderStats stats;
                    Bitmap miniBitmap = _miniMapRenderer.RenderMiniMap(
                        mapWidth, mapHeight, MINIMAP_SIZE,
                        s32FilesSnapshot, checkedFilePaths,
                        out stats);

                    string mode = stats.IsSimplified ? "simplified" : "full";
                    LogPerf($"[MINIMAP] total={stats.TotalMs}ms | blocks={s32Count}, size={stats.ScaledWidth}x{stats.ScaledHeight}, mode={mode}");

                    // å›åˆ° UI åŸ·è¡Œç·’æ›´æ–°
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        lock (_miniMapLock)
                        {
                            if (_miniMapFullBitmap != null)
                                _miniMapFullBitmap.Dispose();
                            _miniMapFullBitmap = miniBitmap;
                        }
                        _miniMapRendering = false;

                        // æ¸²æŸ“å®Œæˆï¼Œæ›´æ–°é¡¯ç¤º
                        UpdateMiniMapRedBox();
                    });
                }
                catch
                {
                    _miniMapRendering = false;
                }
            });
        }

        /// <summary>
        /// åªæ›´æ–°å°åœ°åœ–ç´…æ¡†ä½ç½®ï¼ˆä¸é‡æ–°æ¸²æŸ“åº•åœ–ï¼‰
        /// </summary>
        private void UpdateMiniMapRedBox()
        {
            lock (_miniMapLock)
            {
                if (_miniMapFullBitmap == null)
                    return;

                // å»ºç«‹é¡¯ç¤ºåœ–ï¼ˆåº•åœ– + ç´…æ¡†ï¼‰
                Bitmap displayBitmap = new Bitmap(MINIMAP_SIZE, MINIMAP_SIZE);
                using (Graphics g = Graphics.FromImage(displayBitmap))
                {
                    g.Clear(Color.Black);

                    // ç¹ªè£½å°åœ°åœ–åº•åœ–ï¼ˆç½®ä¸­ï¼‰
                    g.DrawImage(_miniMapFullBitmap, _miniMapOffsetX, _miniMapOffsetY);

                    // ç¹ªè£½è¦–çª—ä½ç½®ç´…æ¡†
                    if (s32MapPanel.Width > 0 && s32MapPanel.Height > 0)
                    {
                        int scrollX = _viewState.ScrollX;
                        int scrollY = _viewState.ScrollY;
                        int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
                        int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);

                        int viewX = (int)(scrollX * _miniMapScale) + _miniMapOffsetX;
                        int viewY = (int)(scrollY * _miniMapScale) + _miniMapOffsetY;
                        int viewWidth = (int)(viewportWidthWorld * _miniMapScale);
                        int viewHeight = (int)(viewportHeightWorld * _miniMapScale);

                        using (Pen viewPortPen = new Pen(Color.Red, 2))
                        {
                            g.DrawRectangle(viewPortPen, viewX, viewY, viewWidth, viewHeight);
                        }
                    }
                }

                if (miniMapPictureBox.Image != null)
                    miniMapPictureBox.Image.Dispose();
                miniMapPictureBox.Image = displayBitmap;
            }
        }

        /// <summary>
        /// æ¸…é™¤å°åœ°åœ–å¿«å–ï¼ˆåœ°åœ–è®Šæ›´æ™‚å‘¼å«ï¼‰
        /// </summary>
        private void ClearMiniMapCache()
        {
            lock (_miniMapLock)
            {
                if (_miniMapFullBitmap != null)
                {
                    _miniMapFullBitmap.Dispose();
                    _miniMapFullBitmap = null;
                }
            }
        }

        /// <summary>
        /// ç›´æ¥è¤‡è£½ bitmap åƒç´ ï¼ˆæ¯” Graphics.DrawImage å¿«ï¼Œæ”¯æ´é€æ˜è‰² 0ï¼‰
        /// </summary>
        private void CopyBitmapDirect(Bitmap src, Bitmap dst, int dstX, int dstY)
        {
            int srcW = src.Width;
            int srcH = src.Height;
            int dstW = dst.Width;
            int dstH = dst.Height;

            // è¨ˆç®—å¯¦éš›è¤‡è£½ç¯„åœ
            int startX = Math.Max(0, -dstX);
            int startY = Math.Max(0, -dstY);
            int endX = Math.Min(srcW, dstW - dstX);
            int endY = Math.Min(srcH, dstH - dstY);

            if (startX >= endX || startY >= endY) return;

            Rectangle srcRect = new Rectangle(0, 0, srcW, srcH);
            Rectangle dstRect = new Rectangle(0, 0, dstW, dstH);

            BitmapData srcData = src.LockBits(srcRect, ImageLockMode.ReadOnly, PixelFormat.Format16bppRgb555);
            BitmapData dstData = dst.LockBits(dstRect, ImageLockMode.ReadWrite, PixelFormat.Format16bppRgb555);

            unsafe
            {
                byte* srcPtr = (byte*)srcData.Scan0;
                byte* dstPtr = (byte*)dstData.Scan0;
                int srcStride = srcData.Stride;
                int dstStride = dstData.Stride;

                for (int y = startY; y < endY; y++)
                {
                    ushort* srcRow = (ushort*)(srcPtr + y * srcStride + startX * 2);
                    ushort* dstRow = (ushort*)(dstPtr + (y + dstY) * dstStride + (startX + dstX) * 2);

                    for (int x = startX; x < endX; x++)
                    {
                        ushort pixel = *srcRow++;
                        if (pixel != 0)  // è·³éé€æ˜è‰²
                        {
                            *dstRow = pixel;
                        }
                        dstRow++;
                    }
                }
            }

            src.UnlockBits(srcData);
            dst.UnlockBits(dstData);
        }

        public void vScrollBar1_Scroll(object sender, ScrollEventArgs e)
        {
            this.pictureBox1.Top = -this.vScrollBar1.Value;
            if (!this.isMouseDrag)
                UpdateMiniMap();
        }

        public void hScrollBar1_Scroll(object sender, ScrollEventArgs e)
        {
            this.pictureBox1.Left = -this.hScrollBar1.Value;
            if (!this.isMouseDrag)
                UpdateMiniMap();
        }

        private void pictureBox2_MouseDown(object sender, MouseEventArgs e)
        {
            if (e.Button == MouseButtons.Left)
            {
                this.mouseDownPoint = Cursor.Position;
                this.isMouseDrag = true;
                this.Cursor = Cursors.Hand;
            }
            else if (e.Button == MouseButtons.Right)
            {
                L1MapHelper.doLocTagEvent(e, this);
            }
        }

        private void pictureBox2_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Left)
                return;

            this.Cursor = Cursors.Default;

            if (this.isMouseDrag)
            {
                int dragDistance = Math.Abs(Cursor.Position.X - this.mouseDownPoint.X) +
                                  Math.Abs(Cursor.Position.Y - this.mouseDownPoint.Y);

                if (dragDistance < DRAG_THRESHOLD)
                {
                    int adjustedX = (int)(e.X / this.zoomLevel);
                    int adjustedY = (int)(e.Y / this.zoomLevel);
                    var linLoc = L1MapHelper.GetLinLocation(adjustedX, adjustedY);
                    if (linLoc != null)
                    {
                        ShowSinglePoint(linLoc.x, linLoc.y);
                    }
                }

                UpdateMiniMap();
                this.isMouseDrag = false;
            }
        }

        private void pictureBox2_MouseMove(object sender, MouseEventArgs e)
        {
            if (this.isMouseDrag)
            {
                try
                {
                    int deltaX = Cursor.Position.X - this.mouseDownPoint.X;
                    int deltaY = Cursor.Position.Y - this.mouseDownPoint.Y;

                    int newScrollX = this.hScrollBar1.Value - deltaX;
                    int newScrollY = this.vScrollBar1.Value - deltaY;

                    if (this.hScrollBar1.Maximum > 0)
                    {
                        newScrollX = Math.Max(this.hScrollBar1.Minimum, Math.Min(newScrollX, this.hScrollBar1.Maximum));
                        this.hScrollBar1.Value = newScrollX;
                    }

                    if (this.vScrollBar1.Maximum > 0)
                    {
                        newScrollY = Math.Max(this.vScrollBar1.Minimum, Math.Min(newScrollY, this.vScrollBar1.Maximum));
                        this.vScrollBar1.Value = newScrollY;
                    }

                    this.vScrollBar1_Scroll(null, null);
                    this.hScrollBar1_Scroll(null, null);

                    this.mouseDownPoint = Cursor.Position;
                }
                catch
                {
                    // å¿½ç•¥éŒ¯èª¤
                }
            }
            else
            {
                L1MapHelper.doMouseMoveEvent(e, this);
            }
        }

        private void pictureBox2_Paint(object sender, PaintEventArgs e)
        {
            // å¯ä»¥åœ¨é€™è£¡ç¹ªè£½é¡å¤–çš„æ¨™è¨˜
        }

        // æ»‘é¼ æ»¾è¼ªç¸®æ”¾åœ°åœ–
        private void Panel1_MouseWheel(object sender, MouseEventArgs e)
        {
            if (Control.ModifierKeys != Keys.Control)
                return;

            if (this.pictureBox1.Image == null)
                return;

            double oldZoom = zoomLevel;
            if (e.Delta > 0)
            {
                zoomLevel = Math.Min(ZOOM_MAX, zoomLevel + ZOOM_STEP);
            }
            else
            {
                zoomLevel = Math.Max(ZOOM_MIN, zoomLevel - ZOOM_STEP);
            }

            if (Math.Abs(oldZoom - zoomLevel) < 0.001)
                return;

            if (originalMapImage == null)
            {
                originalMapImage = (Image)this.pictureBox1.Image.Clone();
            }

            this.panel1.SuspendLayout();

            try
            {
                Point mousePos = this.panel1.PointToClient(Cursor.Position);

                double xRatio = (double)(mousePos.X + this.hScrollBar1.Value) / this.pictureBox1.Width;
                double yRatio = (double)(mousePos.Y + this.vScrollBar1.Value) / this.pictureBox1.Height;

                int newWidth = (int)(originalMapImage.Width * zoomLevel);
                int newHeight = (int)(originalMapImage.Height * zoomLevel);

                this.pictureBox1.Size = new Size(newWidth, newHeight);
                this.pictureBox2.Size = new Size(newWidth, newHeight);
                this.pictureBox3.Size = new Size(newWidth, newHeight);
                this.pictureBox4.Size = new Size(newWidth, newHeight);

                this.hScrollBar1.Maximum = Math.Max(0, newWidth);
                this.vScrollBar1.Maximum = Math.Max(0, newHeight);

                int newScrollX = (int)(newWidth * xRatio - mousePos.X);
                int newScrollY = (int)(newHeight * yRatio - mousePos.Y);

                this.hScrollBar1.Value = Math.Max(0, Math.Min(this.hScrollBar1.Maximum - this.panel1.Width, newScrollX));
                this.vScrollBar1.Value = Math.Max(0, Math.Min(this.vScrollBar1.Maximum - this.panel1.Height, newScrollY));

                this.vScrollBar1_Scroll(null, null);
                this.hScrollBar1_Scroll(null, null);
            }
            finally
            {
                this.panel1.ResumeLayout();
            }

            this.panel1.Invalidate();
        }

        // S32 ç·¨è¼¯å™¨æ»‘é¼ æ»¾è¼ªäº‹ä»¶
        private void S32MapPanel_MouseWheel(object sender, MouseEventArgs e)
        {
            LogPerf($"[MOUSE-WHEEL] delta={e.Delta}, modifiers={Control.ModifierKeys}");

            // Ctrl+æ»¾è¼ª = ç¸®æ”¾
            if (Control.ModifierKeys == Keys.Control)
            {
                // æª¢æŸ¥æ˜¯å¦æœ‰è¼‰å…¥åœ°åœ–
                if (_viewState.MapWidth <= 0 || _viewState.MapHeight <= 0)
                {
                    LogPerf($"[MOUSE-WHEEL] no map loaded, mapWidth={_viewState.MapWidth}, mapHeight={_viewState.MapHeight}");
                    return;
                }

                double oldZoom = pendingS32ZoomLevel;
                if (e.Delta > 0)
                {
                    pendingS32ZoomLevel = Math.Min(ZOOM_MAX, pendingS32ZoomLevel + ZOOM_STEP);
                }
                else
                {
                    pendingS32ZoomLevel = Math.Max(ZOOM_MIN, pendingS32ZoomLevel - ZOOM_STEP);
                }

                LogPerf($"[MOUSE-WHEEL] zoom oldZoom={oldZoom}, newZoom={pendingS32ZoomLevel}");

                if (Math.Abs(oldZoom - pendingS32ZoomLevel) < 0.001)
                    return;

                // ç«‹å³æ›´æ–°ç‹€æ…‹æ¬„é¡¯ç¤ºç¸®æ”¾ç´šåˆ¥ï¼ˆçµ¦ç”¨æˆ¶å³æ™‚åé¥‹ï¼‰
                this.lblS32Info.Text = $"ç¸®æ”¾: {pendingS32ZoomLevel:P0}";

                // ä½¿ç”¨é˜²æŠ–è¨ˆæ™‚å™¨å»¶é²åŸ·è¡Œå¯¦éš›çš„ç¸®æ”¾æ“ä½œ
                zoomDebounceTimer.Stop();
                zoomDebounceTimer.Start();

                // é˜»æ­¢äº‹ä»¶ç¹¼çºŒå‚³é
                ((HandledMouseEventArgs)e).Handled = true;
                return;
            }

            // Shift+æ»¾è¼ª = å·¦å³æ²å‹•ï¼Œæ™®é€šæ»¾è¼ª = ä¸Šä¸‹æ²å‹•
            int scrollAmount = (int)(100 / s32ZoomLevel);  // æ²å‹•é‡ï¼ˆä¸–ç•Œåº§æ¨™åƒç´ ï¼‰
            int currentX = _viewState.ScrollX;
            int currentY = _viewState.ScrollY;

            // è¨ˆç®—æœ€å¤§æ²å‹•å€¼ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            int maxScrollX = Math.Max(0, _viewState.MapWidth - (int)(s32MapPanel.Width / s32ZoomLevel));
            int maxScrollY = Math.Max(0, _viewState.MapHeight - (int)(s32MapPanel.Height / s32ZoomLevel));

            if (Control.ModifierKeys == Keys.Shift)
            {
                // å·¦å³æ²å‹•
                int newX = currentX - (e.Delta > 0 ? scrollAmount : -scrollAmount);
                newX = Math.Max(0, Math.Min(newX, maxScrollX));
                _viewState.SetScrollSilent(newX, currentY);
            }
            else
            {
                // ä¸Šä¸‹æ²å‹•
                int newY = currentY - (e.Delta > 0 ? scrollAmount : -scrollAmount);
                newY = Math.Max(0, Math.Min(newY, maxScrollY));
                _viewState.SetScrollSilent(currentX, newY);
            }

            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
            CheckAndRerenderIfNeeded();

            // æ›´æ–°å°åœ°åœ–
            UpdateMiniMap();

            // é˜»æ­¢äº‹ä»¶ç¹¼çºŒå‚³é
            ((HandledMouseEventArgs)e).Handled = true;
        }

        // åŸ·è¡Œå¯¦éš›çš„ç¸®æ”¾æ“ä½œï¼ˆä½¿ç”¨ Viewport æ¸²æŸ“ï¼‰
        private void ApplyS32Zoom(double targetZoomLevel)
        {
            try
            {
                LogPerf($"[APPLY-ZOOM] start, targetZoom={targetZoomLevel}, currentZoom={s32ZoomLevel}");

                // æª¢æŸ¥æ˜¯å¦æœ‰è¼‰å…¥åœ°åœ–
                if (_viewState.MapWidth <= 0 || _viewState.MapHeight <= 0)
                {
                    LogPerf($"[APPLY-ZOOM] no map loaded");
                    return;
                }

                // æ›´æ–°ç¸®æ”¾ç´šåˆ¥
                s32ZoomLevel = targetZoomLevel;
                _viewState.ZoomLevel = targetZoomLevel;

                // æ³¨æ„ï¼šä¸è¦æ¸…é™¤èˆŠçš„æ¸²æŸ“ç‹€æ…‹ï¼Œè®“èˆŠ bitmap ç¹¼çºŒé¡¯ç¤ºç›´åˆ°æ–°çš„æº–å‚™å¥½
                // NeedsRerender() æœƒæª¢æ¸¬åˆ°ç¸®æ”¾æ”¹è®Šä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“

                LogPerf($"[APPLY-ZOOM] calling RenderS32Map");

                // é‡æ–°æ¸²æŸ“ï¼ˆç¸®æ”¾æ”¹è®Šæœƒè§¸ç™¼é‡æ–°æ¸²æŸ“ï¼‰
                RenderS32Map();

                LogPerf($"[APPLY-ZOOM] calling UpdateMiniMap");

                // æ›´æ–°å°åœ°åœ–
                UpdateMiniMap();

                // æ›´æ–°ç‹€æ…‹æ¬„é¡¯ç¤ºç¸®æ”¾ç´šåˆ¥
                this.lblS32Info.Text = $"ç¸®æ”¾: {s32ZoomLevel:P0}";

                LogPerf($"[APPLY-ZOOM] done");
            }
            catch (Exception ex)
            {
                LogPerf($"[APPLY-ZOOM] error: {ex.Message}");
                this.lblS32Info.Text = $"ç¸®æ”¾å¤±æ•—: {ex.Message}";
            }
        }

        // é¡¯ç¤ºå–®é»åº§æ¨™
        private void ShowSinglePoint(int x, int y)
        {
            string coords = string.Format("{0},{1}", x, y);
            this.toolStripStatusLabel2.Text = coords;

            try
            {
                Clipboard.SetText(coords);
                this.toolStripStatusLabel1.Text = "å·²è¤‡è£½: " + coords;
            }
            catch
            {
                this.toolStripStatusLabel1.Text = coords;
            }
        }

        // å°åœ°åœ–æ»‘é¼ æŒ‰ä¸‹ - é–‹å§‹æ‹–æ‹½æˆ–é»æ“Šè·³è½‰
        private void miniMapPictureBox_MouseDown(object sender, MouseEventArgs e)
        {
            // è¨­å®šå°åœ°åœ–ç„¦é»æ¨™è¨˜ï¼Œè®“ Form çš„ KeyDown è™•ç†æ–¹å‘éµ
            isMiniMapFocused = true;

            if (e.Button == MouseButtons.Left)
            {
                isMiniMapDragging = true;
                MoveMainMapFromMiniMap(e.X, e.Y, true);
            }
        }

        // å°åœ°åœ–æ»‘é¼ ç§»å‹• - æ‹–æ‹½æ™‚åªæ›´æ–°å°åœ°åœ–ç´…æ¡†
        private void miniMapPictureBox_MouseMove(object sender, MouseEventArgs e)
        {
            if (isMiniMapDragging && e.Button == MouseButtons.Left)
            {
                MoveMainMapFromMiniMap(e.X, e.Y, false);  // æ‹–æ‹½ä¸­ä¸é‡ç¹ªä¸»åœ°åœ–
            }
        }

        // å°åœ°åœ–æ»‘é¼ æ”¾é–‹ - çµæŸæ‹–æ‹½ï¼Œæ›´æ–°ä¸»åœ°åœ–
        private void miniMapPictureBox_MouseUp(object sender, MouseEventArgs e)
        {
            if (isMiniMapDragging)
            {
                isMiniMapDragging = false;
                // æ‹–æ‹½çµæŸæ™‚æ›´æ–°å°åœ°åœ–ï¼ˆä¸»åœ°åœ–å·²ç¶“æ²å‹•åˆ°æ­£ç¢ºä½ç½®ï¼‰
                UpdateMiniMap();
            }
        }

        // æ ¹æ“šå°åœ°åœ–åº§æ¨™ç§»å‹•ä¸»åœ°åœ–ï¼ˆé»æ“Šä½ç½®ç‚ºç´…æ¡†ä¸­å¿ƒï¼‰
        // updateMiniMapFlag: true=æ›´æ–°å°åœ°åœ–, false=åªæ›´æ–°ç´…æ¡†
        private void MoveMainMapFromMiniMap(int mouseX, int mouseY, bool updateMiniMapFlag)
        {
            try
            {
                // ä½¿ç”¨ ViewState çš„åœ°åœ–å¤§å°
                int pictureWidth = _viewState.MapWidth > 0 ? _viewState.MapWidth : this._mapViewerControl.Width;
                int pictureHeight = _viewState.MapHeight > 0 ? _viewState.MapHeight : this._mapViewerControl.Height;

                if (pictureWidth <= 0 || pictureHeight <= 0)
                    return;

                int miniWidth = MINIMAP_SIZE;
                int miniHeight = MINIMAP_SIZE;

                // è¨ˆç®—å°åœ°åœ–ä¸­åœ–ç‰‡çš„ç¸®æ”¾å’Œåç§»ï¼ˆèˆ‡ UpdateMiniMap ä¸€è‡´ï¼‰
                float scaleX = (float)miniWidth / pictureWidth;
                float scaleY = (float)miniHeight / pictureHeight;
                float scale = Math.Min(scaleX, scaleY);

                int scaledWidth = (int)(pictureWidth * scale);
                int scaledHeight = (int)(pictureHeight * scale);
                int offsetX = (miniWidth - scaledWidth) / 2;
                int offsetY = (miniHeight - scaledHeight) / 2;

                // è¨ˆç®—é»æ“Šåœ¨ç¸®æ”¾åœ–ç‰‡ä¸­çš„ç›¸å°ä½ç½®
                int clickX = mouseX - offsetX;
                int clickY = mouseY - offsetY;

                // é™åˆ¶åœ¨æœ‰æ•ˆç¯„åœå…§
                clickX = Math.Max(0, Math.Min(clickX, scaledWidth));
                clickY = Math.Max(0, Math.Min(clickY, scaledHeight));

                // è¨ˆç®—é»æ“Šä½ç½®å°æ‡‰çš„ä¸»åœ°åœ–ä¸–ç•Œåº§æ¨™
                int mapPosX = (int)((float)clickX / scaledWidth * pictureWidth);
                int mapPosY = (int)((float)clickY / scaledHeight * pictureHeight);

                // è¨ˆç®—æ²å‹•ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰ï¼Œè®“é»æ“Šä½ç½®æˆç‚ºè¦–çª—ä¸­å¤®
                int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
                int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);
                int newScrollX = mapPosX - viewportWidthWorld / 2;
                int newScrollY = mapPosY - viewportHeightWorld / 2;

                // é™åˆ¶åœ¨æœ‰æ•ˆç¯„åœå…§ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
                int maxScrollX = Math.Max(0, pictureWidth - viewportWidthWorld);
                int maxScrollY = Math.Max(0, pictureHeight - viewportHeightWorld);
                newScrollX = Math.Max(0, Math.Min(newScrollX, maxScrollX));
                newScrollY = Math.Max(0, Math.Min(newScrollY, maxScrollY));

                // è¨­å®š ViewState çš„æ²å‹•ä½ç½®
                _viewState.SetScrollSilent(newScrollX, newScrollY);

                // æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦æ›´æ–°å°åœ°åœ–å’Œé‡æ–°æ¸²æŸ“
                if (updateMiniMapFlag)
                {
                    CheckAndRerenderIfNeeded();
                    UpdateMiniMap();
                }
                else
                {
                    // æ‹–æ‹½æ™‚åªæ›´æ–°å°åœ°åœ–ç´…æ¡†ä½ç½®å’Œé‡ç¹ªï¼ˆå¿«é€Ÿç¹ªè£½ï¼‰
                    _mapViewerControl.Refresh();
                    UpdateMiniMapRedBox();
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
        }

        // å°åœ°åœ–é»æ“Šè·³è½‰ï¼ˆä¿ç•™çµ¦æ»‘é¼ å³éµæŸ¥è©¢ S32 æª”æ¡ˆç”¨ï¼‰
        private void miniMapPictureBox_MouseClick(object sender, MouseEventArgs e)
        {
            // å³éµé»æ“Šé¡¯ç¤º S32 æª”æ¡ˆè³‡è¨Š
            if (e.Button == MouseButtons.Right)
            {
                try
                {
                    // ä½¿ç”¨ ViewState çš„åœ°åœ–å¤§å°
                    int pictureWidth = _viewState.MapWidth > 0 ? _viewState.MapWidth : this._mapViewerControl.Width;
                    int pictureHeight = _viewState.MapHeight > 0 ? _viewState.MapHeight : this._mapViewerControl.Height;

                    if (pictureWidth <= 0 || pictureHeight <= 0)
                        return;

                    int miniWidth = MINIMAP_SIZE;
                    int miniHeight = MINIMAP_SIZE;

                    float scaleX = (float)miniWidth / pictureWidth;
                    float scaleY = (float)miniHeight / pictureHeight;
                    float scale = Math.Min(scaleX, scaleY);

                    int scaledWidth = (int)(pictureWidth * scale);
                    int scaledHeight = (int)(pictureHeight * scale);
                    int offsetX = (miniWidth - scaledWidth) / 2;
                    int offsetY = (miniHeight - scaledHeight) / 2;

                    int clickX = e.X - offsetX;
                    int clickY = e.Y - offsetY;

                    if (clickX < 0 || clickY < 0 || clickX > scaledWidth || clickY > scaledHeight)
                        return;

                    float clickRatioX = (float)clickX / scaledWidth;
                    float clickRatioY = (float)clickY / scaledHeight;

                    int mapX = (int)(clickRatioX * pictureWidth);
                    int mapY = (int)(clickRatioY * pictureHeight);

                    var linLoc = L1MapHelper.GetLinLocation(mapX, mapY);
                    if (linLoc != null)
                    {
                        int blockX = ((linLoc.x - 0x7FFF) / 64) + 0x7FFF;
                        int blockY = ((linLoc.y - 0x7FFF) / 64) + 0x7FFF;
                        string targetFileName = $"{blockX:X4}{blockY:X4}.s32";
                        this.toolStripStatusLabel1.Text = $"S32 æª”æ¡ˆ: {targetFileName} (åº§æ¨™: {linLoc.x},{linLoc.y})";
                    }
                }
                catch { }
            }
        }

        // å°åœ°åœ– PreviewKeyDown - ä¿ç•™çµ¦æœªä¾†ä½¿ç”¨ï¼ˆç›®å‰ç”± Form KeyDown è™•ç†ï¼‰
        private void miniMapPictureBox_PreviewKeyDown(object sender, PreviewKeyDownEventArgs e)
        {
        }

        // å°åœ°åœ–éµç›¤äº‹ä»¶ - ä¿ç•™çµ¦æœªä¾†ä½¿ç”¨ï¼ˆç›®å‰ç”± Form KeyDown è™•ç†ï¼‰
        private void miniMapPictureBox_KeyDown(object sender, KeyEventArgs e)
        {
        }

        // æ–¹å‘éµç§»å‹•å°åœ°åœ–è¦–åœ–
        private void MoveMiniMapByArrowKey(Keys keyCode)
        {
            if (_viewState.MapWidth <= 0 || _viewState.MapHeight <= 0)
                return;

            // è¨ˆç®—ç§»å‹•é‡ï¼ˆç§»å‹•ä¸€å€‹ viewport çš„å¤§å°ï¼Œè€ƒæ…®ç¸®æ”¾ï¼‰
            var viewport = _viewState.GetViewportWorldRect();
            int moveX = 0, moveY = 0;

            switch (keyCode)
            {
                case Keys.Up:
                    moveY = -viewport.Height;
                    break;
                case Keys.Down:
                    moveY = viewport.Height;
                    break;
                case Keys.Left:
                    moveX = -viewport.Width;
                    break;
                case Keys.Right:
                    moveX = viewport.Width;
                    break;
                default:
                    return;
            }

            // è¨ˆç®—æ–°çš„æ²å‹•ä½ç½®
            int newScrollX = _viewState.ScrollX + moveX;
            int newScrollY = _viewState.ScrollY + moveY;

            // é™åˆ¶åœ¨åœ°åœ–ç¯„åœå…§
            newScrollX = Math.Max(0, Math.Min(newScrollX, _viewState.MaxScrollX));
            newScrollY = Math.Max(0, Math.Min(newScrollY, _viewState.MaxScrollY));

            // æ›´æ–°æ²å‹•ä½ç½®
            _viewState.SetScrollSilent(newScrollX, newScrollY);

            // é‡æ–°æ¸²æŸ“ä¸¦æ›´æ–°å°åœ°åœ–
            RenderS32Map();
            UpdateMiniMap();
        }

        // ===== S32 ç·¨è¼¯å™¨åŠŸèƒ½ =====
        // é¡å‹å®šç¾©å·²ç§»è‡³ Models/S32DataModels.cs

        // ç•¶å‰é¸æ“‡çš„ S32 æª”æ¡ˆè³‡è¨Šï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
        private S32FileItem currentS32FileItem;

        // ä¾¿æ·å±¬æ€§ï¼šå¾å­—å…¸ä¸­ç²å–ç•¶å‰é¸ä¸­çš„ S32 è³‡æ–™
        private S32Data currentS32Data
        {
            get
            {
                if (currentS32FileItem != null && _document.S32Files.ContainsKey(currentS32FileItem.FilePath))
                {
                    return _document.S32Files[currentS32FileItem.FilePath];
                }
                return null;
            }
        }

        // ä¾¿æ·å±¬æ€§ï¼šæª¢æŸ¥ç•¶å‰é¸ä¸­çš„ S32 æ˜¯å¦å·²ä¿®æ”¹
        private bool isS32Modified
        {
            get
            {
                return currentS32Data != null && currentS32Data.IsModified;
            }
            set
            {
                if (currentS32Data != null)
                {
                    currentS32Data.IsModified = value;
                }
            }
        }

        // å€åŸŸé¸æ“‡ç›¸é—œè®Šé‡
        private bool isSelectingRegion = false;
        private Point regionStartPoint;
        private Point regionEndPoint;
        private Rectangle selectedRegion;

        // Layer4 è¤‡è£½è²¼ä¸Šç›¸é—œè®Šæ•¸
        private bool isLayer4CopyMode = false;           // æ˜¯å¦åœ¨è¤‡è£½é¸å–æ¨¡å¼
        private bool hasLayer4Clipboard = false;         // å‰ªè²¼ç°¿æ˜¯å¦æœ‰è³‡æ–™
        private Rectangle copyRegionBounds;               // è¤‡è£½å€åŸŸçš„ç¯„åœï¼ˆè¢å¹•åº§æ¨™ï¼‰

        // è¤‡è£½/åˆªé™¤è¨­å®šï¼ˆç”± Dialog è¨­å®šï¼‰
        private bool copySettingLayer1 = true;
        private bool copySettingLayer2 = true;
        private bool copySettingLayer3 = true;
        private bool copySettingLayer4 = true;
        private bool copySettingLayer5 = true;
        private bool copySettingLayer6to8 = true;
        // å‘å¾Œç›¸å®¹å±¬æ€§
        private bool copySettingLayer5to8 => copySettingLayer5 || copySettingLayer6to8;

        // æ ¹æ“šéŠæˆ²åº§æ¨™æ‰¾åˆ°å°æ‡‰çš„ S32Data
        private S32Data GetS32DataByGameCoords(int gameX, int gameY)
        {
            foreach (var s32Data in _document.S32Files.Values)
            {
                if (gameX >= s32Data.SegInfo.nLinBeginX && gameX <= s32Data.SegInfo.nLinEndX &&
                    gameY >= s32Data.SegInfo.nLinBeginY && gameY <= s32Data.SegInfo.nLinEndY)
                {
                    return s32Data;
                }
            }
            return null;
        }

        // è¢å¹•åº§æ¨™è½‰æ›ç‚ºéŠæˆ²åº§æ¨™ï¼ˆä½¿ç”¨ Layer3 æ ¼å­ï¼Œèˆ‡æ ¼ç·šä¸€è‡´ï¼‰
        private (int gameX, int gameY, S32Data s32Data, int localX, int localY) ScreenToGameCoords(int screenX, int screenY)
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return (-1, -1, null, -1, -1);

            // ä½¿ç”¨ ViewState çš„æ²å‹•ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            // å°‡è¢å¹•åº§æ¨™è½‰æ›ç‚ºä¸–ç•Œåº§æ¨™ï¼ˆè€ƒæ…®ç¸®æ”¾å’Œæ²å‹•ï¼‰
            int worldX = (int)(screenX / s32ZoomLevel) + _viewState.ScrollX;
            int worldY = (int)(screenY / s32ZoomLevel) + _viewState.ScrollY;

            // ä½¿ç”¨ç©ºé–“ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾å¯èƒ½åŒ…å«é€™å€‹é»çš„ S32
            // å»ºç«‹ä¸€å€‹å°ç¯„åœçš„æŸ¥è©¢çŸ©å½¢ï¼ˆé»å‘¨åœçš„å€åŸŸï¼‰
            Rectangle queryRect = new Rectangle(worldX - 48, worldY - 24, 96, 48);
            var candidateFiles = GetS32FilesInRect(queryRect);

            int blockWidth = 64 * 24 * 2;   // 3072
            int blockHeight = 64 * 12 * 2;  // 1536

            foreach (var filePath in candidateFiles)
            {
                if (!_document.S32Files.TryGetValue(filePath, out var s32Data))
                    continue;

                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                // å…ˆæª¢æŸ¥é»æ˜¯å¦åœ¨é€™å€‹ S32 block ç¯„åœå…§ï¼ˆç²—ç•¥æª¢æŸ¥ï¼‰
                if (worldX < mx || worldX > mx + blockWidth || worldY < my || worldY > my + blockHeight)
                    continue;

                // ä½¿ç”¨ Layer3 æ ¼å­ï¼ˆèˆ‡ DrawS32Grid ä¸€è‡´ï¼‰
                for (int y = 0; y < 64; y++)
                {
                    for (int x3 = 0; x3 < 64; x3++)
                    {
                        int x = x3 * 2;  // Layer1 åº§æ¨™

                        int localBaseX = 0;
                        int localBaseY = 63 * 12;
                        localBaseX -= 24 * (x / 2);
                        localBaseY -= 12 * (x / 2);

                        int X = mx + localBaseX + x * 24 + y * 24;
                        int Y = my + localBaseY + y * 12;

                        // Layer3 è±å½¢çš„å››å€‹é ‚é»ï¼ˆ48x24ï¼Œèˆ‡æ ¼ç·šä¸€è‡´ï¼‰
                        Point p1 = new Point(X, Y + 12);       // å·¦
                        Point p2 = new Point(X + 24, Y);       // ä¸Š
                        Point p3 = new Point(X + 48, Y + 12);  // å³
                        Point p4 = new Point(X + 24, Y + 24);  // ä¸‹

                        if (IsPointInDiamond(new Point(worldX, worldY), p1, p2, p3, p4))
                        {
                            // è¿”å› Layer3 åº§æ¨™ä½œç‚ºéŠæˆ²åº§æ¨™
                            int gameX = s32Data.SegInfo.nLinBeginX + x3;
                            int gameY = s32Data.SegInfo.nLinBeginY + y;
                            return (gameX, gameY, s32Data, x, y);
                        }
                    }
                }
            }
            return (-1, -1, null, -1, -1);
        }

        // éŠæˆ²åº§æ¨™è½‰æ›ç‚ºä¸–ç•Œåº§æ¨™ä¸­å¿ƒé»
        private (int worldX, int worldY) GameToWorldCoords(int gameX, int gameY)
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return (-1, -1);

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // æ‰¾åˆ°åŒ…å«é€™å€‹éŠæˆ²åº§æ¨™çš„ S32
            foreach (var s32Data in _document.S32Files.Values)
            {
                int localX = gameX - s32Data.SegInfo.nLinBeginX;
                int localY = gameY - s32Data.SegInfo.nLinBeginY;

                // æª¢æŸ¥æ˜¯å¦åœ¨é€™å€‹ S32 çš„ç¯„åœå…§
                if (localX >= 0 && localX < 128 && localY >= 0 && localY < 64)
                {
                    // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    int localBaseX = 0;
                    int localBaseY = 63 * 12;
                    localBaseX -= 24 * (localX / 2);
                    localBaseY -= 12 * (localX / 2);

                    int X = mx + localBaseX + localX * 24 + localY * 24;
                    int Y = my + localBaseY + localY * 12;

                    // è¿”å›è±å½¢ä¸­å¿ƒé»ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
                    return (X + 12, Y + 12);
                }
            }

            return (-1, -1);
        }

        // éŠæˆ²åº§æ¨™è½‰æ›ç‚ºè¢å¹•åº§æ¨™ä¸­å¿ƒé»ï¼ˆè€ƒæ…®æ²å‹•ä½ç½®ï¼‰
        private (int screenX, int screenY) GameToScreenCoords(int gameX, int gameY)
        {
            var (worldX, worldY) = GameToWorldCoords(gameX, gameY);
            if (worldX < 0) return (-1, -1);

            // ä½¿ç”¨ ViewState çš„æ²å‹•ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            // ä¸–ç•Œåº§æ¨™è½‰è¢å¹•åº§æ¨™ï¼ˆè€ƒæ…®ç¸®æ”¾å’Œæ²å‹•ï¼‰
            int screenX = (int)((worldX - _viewState.ScrollX) * s32ZoomLevel);
            int screenY = (int)((worldY - _viewState.ScrollY) * s32ZoomLevel);

            return (screenX, screenY);
        }

        // è¼‰å…¥ç•¶å‰åœ°åœ–çš„ s32 æª”æ¡ˆæ¸…å–®ä¸¦è¼‰å…¥æ‰€æœ‰ S32 è³‡æ–™
        private void LoadS32FileList(string mapId)
        {
            LogPerf($"[LOAD-S32-LIST] Start, mapId={mapId}");
            var totalStopwatch = Stopwatch.StartNew();
            var phaseStopwatch = new Stopwatch();

            lstS32Files.Items.Clear();
            _checkedS32Files.Clear();  // æ¸…ç©ºå¿«å–
            _document.S32Files.Clear();
            _layer4SpatialIndex.Clear();  // æ¸…ç©º Layer4 ç©ºé–“ç´¢å¼•
            _document.MapId = mapId;
            lblS32Files.Text = "S32 æª”æ¡ˆæ¸…å–®";  // é‡ç½®æ¨™ç±¤

            // æ¸…é™¤æ‰€æœ‰å¿«å–
            ClearS32BlockCache();
            ClearMiniMapCache();
            cachedAggregatedTiles.Clear();
            tileDataCache.Clear();
            _tilFileCache.Clear();
            _tilRemasterCache.Clear();
            LogPerf($"[LOAD-S32-LIST] Caches cleared: {totalStopwatch.ElapsedMilliseconds}ms");

            // æ¸…é™¤ viewport bitmap
            lock (_viewportBitmapLock)
            {
                if (_viewportBitmap != null)
                {
                    _viewportBitmap.Dispose();
                    _viewportBitmap = null;
                }
            }

            // é‡ç½® ViewState
            _viewState.Reset();

            // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹ï¼ˆä¿ç•™å‰ªè²¼ç°¿ä»¥æ”¯æ´è·¨åœ°åœ–è¤‡è£½ï¼‰
            _editState.SelectedCells.Clear();
            // æ³¨æ„ï¼šä¸æ¸…é™¤ CellClipboardã€Layer2Clipboardã€Layer5-8Clipboardï¼Œä»¥æ”¯æ´è·¨åœ°åœ–è¤‡è£½
            // _editState.CellClipboard.Clear();
            // _editState.Layer2Clipboard.Clear();
            // _editState.Layer5Clipboard.Clear();
            // _editState.Layer6Clipboard.Clear();
            // _editState.Layer7Clipboard.Clear();
            // _editState.Layer8Clipboard.Clear();
            _editState.UndoHistory.Clear();
            _editState.RedoHistory.Clear();
            _editState.SelectedLayer4Groups.Clear();
            // hasLayer4Clipboard ä¹Ÿä¿ç•™ï¼Œä¸æ¸…é™¤
            isLayer4CopyMode = false;
            selectedRegion = new Rectangle();
            copyRegionBounds = new Rectangle();

            // æ¸…é™¤ç¾¤çµ„ç¸®åœ–
            lvGroupThumbnails.Items.Clear();

            // éš±è— Layer5 ç•°å¸¸æŒ‰éˆ•
            btnToolCheckL5Invalid.Visible = false;

            // å¾ Share.MapDataList å–å¾—åœ°åœ–è³‡æ–™
            if (!Share.MapDataList.ContainsKey(mapId))
                return;

            Struct.L1Map currentMap = Share.MapDataList[mapId];

            // éšæ®µ 1: UI æ¸…å–®å»ºç«‹
            phaseStopwatch.Restart();
            List<S32FileItem> s32FileItems = new List<S32FileItem>();
            foreach (var kvp in currentMap.FullFileNameList)
            {
                string filePath = kvp.Key;
                Struct.L1MapSeg segInfo = kvp.Value;

                // è™•ç† s32 å’Œ seg æª”æ¡ˆ
                string fileName = Path.GetFileName(filePath);
                string fileType = segInfo.isS32 ? "" : " [SEG]";
                string displayName = $"{fileName}{fileType} ({segInfo.nBlockX:X4},{segInfo.nBlockY:X4}) [{segInfo.nLinBeginX},{segInfo.nLinBeginY}~{segInfo.nLinEndX},{segInfo.nLinEndY}]";

                S32FileItem item = new S32FileItem
                {
                    FilePath = filePath,
                    DisplayName = displayName,
                    SegInfo = segInfo,
                    IsChecked = true
                };

                int index = lstS32Files.Items.Add(item);
                lstS32Files.SetItemChecked(index, true);  // é è¨­å‹¾é¸
                _checkedS32Files.Add(filePath);  // åŠ å…¥å¿«å–
                s32FileItems.Add(item);
            }
            long uiListMs = phaseStopwatch.ElapsedMilliseconds;

            // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹S32æª”æ¡ˆ
            if (lstS32Files.Items.Count > 0)
            {
                lstS32Files.SelectedIndex = 0;
            }

            // æ›´æ–° S32 æª”æ¡ˆæ¸…å–®æ¨™ç±¤é¡¯ç¤ºæ•¸é‡
            lblS32Files.Text = $"S32 æª”æ¡ˆæ¸…å–® ({s32FileItems.Count})";

            this.toolStripStatusLabel1.Text = $"æ‰¾åˆ° {s32FileItems.Count} å€‹ S32 æª”æ¡ˆï¼Œæ­£åœ¨è¼‰å…¥...";

            // ä½¿ç”¨èƒŒæ™¯åŸ·è¡Œç·’é †åºè¼‰å…¥ï¼ˆé¿å…ä¸¦è¡Œé€ æˆç£ç¢Ÿç«¶çˆ­ï¼‰
            LogPerf($"[LOAD-S32-LIST] Starting background Task.Run, s32Count={s32FileItems.Count}");
            Task.Run(() =>
            {
                LogPerf("[LOAD-S32-BG] Task started");
                long totalFileReadMs = 0;
                long totalParseMs = 0;
                int loadedCount = 0;

                // éšæ®µ 1: å¾ªåºè®€å–æ‰€æœ‰æª”æ¡ˆï¼ˆé¿å…ç£ç¢Ÿç«¶çˆ­ï¼‰
                var fileDataList = new List<(S32FileItem item, byte[] data)>();
                var readSw = Stopwatch.StartNew();
                foreach (var item in s32FileItems)
                {
                    try
                    {
                        byte[] data = File.ReadAllBytes(item.FilePath);
                        fileDataList.Add((item, data));
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"è®€å– S32 æª”æ¡ˆå¤±æ•—: {item.FilePath}, éŒ¯èª¤: {ex.Message}");
                    }
                }
                readSw.Stop();
                totalFileReadMs = readSw.ElapsedMilliseconds;
                LogPerf($"[LOAD-S32-BG] File read done: {totalFileReadMs}ms, files={fileDataList.Count}");

                // éšæ®µ 2: å¹³è¡Œè§£ææ‰€æœ‰æª”æ¡ˆï¼ˆä½¿ç”¨ ConcurrentBag é¿å… Dictionary é–ç«¶çˆ­ï¼‰
                var parsedResults = new System.Collections.Concurrent.ConcurrentBag<(string path, S32Data data)>();
                var parseSw = Stopwatch.StartNew();
                var parallelOptions = new System.Threading.Tasks.ParallelOptions
                {
                    MaxDegreeOfParallelism = Environment.ProcessorCount
                };
                System.Threading.Tasks.Parallel.ForEach(fileDataList, parallelOptions, fileData =>
                {
                    try
                    {
                        S32Data s32Data;
                        if (fileData.item.SegInfo.isS32)
                        {
                            // è§£æ .s32 æª”æ¡ˆ
                            s32Data = ParseS32File(fileData.data);
                        }
                        else
                        {
                            // è§£æ .seg æª”æ¡ˆ
                            s32Data = SegParser.Parse(fileData.data);
                        }

                        if (s32Data != null)
                        {
                            s32Data.FilePath = fileData.item.FilePath;
                            s32Data.SegInfo = fileData.item.SegInfo;
                            s32Data.IsModified = false;
                            parsedResults.Add((fileData.item.FilePath, s32Data));
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"è§£æåœ°åœ–æª”æ¡ˆå¤±æ•—: {fileData.item.FilePath}, éŒ¯èª¤: {ex.Message}");
                    }
                });
                parseSw.Stop();
                totalParseMs = parseSw.ElapsedMilliseconds;

                // å°‡çµæœè¤‡è£½åˆ° _document.S32Files
                foreach (var (path, data) in parsedResults)
                {
                    _document.S32Files[path] = data;
                }
                loadedCount = parsedResults.Count;

                LogPerf($"[S32-LOAD] {loadedCount} files, read={totalFileReadMs}ms (seq), parse={totalParseMs}ms (parallel)");

                // å»ºç«‹ç©ºé–“ç´¢å¼•ï¼ˆç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾ worldRect å…§çš„ S32ï¼‰
                BuildS32SpatialIndex();

                // å»ºç«‹ Layer4 ç©ºé–“ç´¢å¼•ï¼ˆç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾é™„è¿‘ç‰©ä»¶ï¼‰
                BuildLayer4SpatialIndex();

                // é è¼‰å…¥æ‰€æœ‰ tile æª”æ¡ˆï¼ˆèƒŒæ™¯åŸ·è¡Œï¼Œèˆ‡ UI æ›´æ–°ä¸¦è¡Œï¼‰
                PreloadTilesAsync(_document.S32Files.Values.ToList());

                // è¨˜éŒ„èƒŒæ™¯è¼‰å…¥å®Œæˆæ™‚é–“
                long bgLoadMs = totalStopwatch.ElapsedMilliseconds;

                // è¼‰å…¥å®Œæˆå¾Œæ›´æ–° UI
                this.Invoke((MethodInvoker)delegate
                {
                    long invokeStartMs = totalStopwatch.ElapsedMilliseconds;
                    long invokeOverheadMs = invokeStartMs - bgLoadMs;

                    // éšæ®µ 3: è¨­å®šåˆå§‹æ²å‹•ä½ç½®åˆ°åœ°åœ–ä¸­å¤®ï¼ˆåœ¨æ¸²æŸ“ä¹‹å‰ï¼‰
                    phaseStopwatch.Restart();
                    if (_document.S32Files.Count > 0)
                    {
                        SetInitialScrollToCenter(currentMap);
                    }
                    long scrollSetupMs = phaseStopwatch.ElapsedMilliseconds;

                    // éšæ®µ 4: Viewport æ¸²æŸ“ï¼ˆå·²ç¶“åœ¨ä¸­å¤®ä½ç½®ï¼‰
                    phaseStopwatch.Restart();
                    if (_document.S32Files.Count > 0)
                    {
                        // åŒæ­¥ CheckedS32Files åˆ° MapDocument
                        SyncCheckedS32FilesToDocument();

                        // ä½¿ç”¨èˆŠçš„æ¸²æŸ“ï¼ˆMapViewerControl æ•´åˆå°šæœªå®Œæˆï¼‰
                        RenderS32Map();

                        // TODO: å®Œæˆ MapViewerControl æ•´åˆå¾Œæ”¹ç”¨é€™å€‹
                        // _mapViewerControl.LoadMap(_document);
                    }
                    long viewportRenderMs = phaseStopwatch.ElapsedMilliseconds;

                    // éšæ®µ 5: å°åœ°åœ–æ›´æ–°
                    phaseStopwatch.Restart();
                    if (_document.S32Files.Count > 0)
                    {
                        UpdateMiniMap();
                    }
                    long miniMapMs = phaseStopwatch.ElapsedMilliseconds;

                    // éšæ®µ 6: Tile åˆ—è¡¨ + ç¾¤çµ„ç¸®åœ–æ›´æ–°ï¼ˆå…©è€…ä¸¦è¡ŒèƒŒæ™¯åŸ·è¡Œï¼‰
                    phaseStopwatch.Restart();
                    if (_document.S32Files.Count > 0)
                    {
                        UpdateGroupThumbnailsList();  // ç•°æ­¥ï¼Œç«‹å³è¿”å›
                        UpdateTileListAsync();        // ç•°æ­¥ï¼Œç«‹å³è¿”å›
                        UpdateLayer5InvalidButton();
                    }
                    long tileListMs = phaseStopwatch.ElapsedMilliseconds;  // åªè¨ˆç®—å•Ÿå‹•æ™‚é–“
                    long thumbnailStartMs = 0;  // å·²åˆä½µåˆ°ä¸Šé¢

                    totalStopwatch.Stop();
                    long totalMs = totalStopwatch.ElapsedMilliseconds;

                    // è¨ˆç®—å„éšæ®µä½”æ¯”
                    long sumMs = uiListMs + totalFileReadMs + totalParseMs + invokeOverheadMs + scrollSetupMs + viewportRenderMs + miniMapMs + tileListMs + thumbnailStartMs;
                    long unmeasuredMs = totalMs - sumMs;

                    // é¡¯ç¤ºè¼‰å…¥æ™‚é–“çµ±è¨ˆï¼ˆç¾¤çµ„ç¸®åœ–åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œå®Œæˆå¾Œæœƒæ›´æ–°è‡ªå·±çš„æ¨™ç±¤ï¼‰
                    string stats = $"Loaded ({_document.S32Files.Count} S32) | " +
                                   $"Total: {totalMs}ms | " +
                                   $"UI: {uiListMs}ms | " +
                                   $"FileRead: {totalFileReadMs}ms | " +
                                   $"Parse: {totalParseMs}ms | " +
                                   $"Viewport: {viewportRenderMs}ms | " +
                                   $"TileList: {tileListMs}ms | " +
                                   $"Thumbnails: background";

                    this.toolStripStatusLabel1.Text = stats;

                    // Console log detailed timing
                    Console.WriteLine("========================================");
                    Console.WriteLine($"[LOAD TIMING] Map: {mapId}, S32 Files: {_document.S32Files.Count}");
                    Console.WriteLine("========================================");
                    Console.WriteLine($"  UI List:        {uiListMs,6} ms  ({(uiListMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine($"  File Read:      {totalFileReadMs,6} ms  ({(totalFileReadMs * 100.0 / totalMs),5:F1}%)  [{s32FileItems.Count} files]");
                    Console.WriteLine($"  S32 Parse:      {totalParseMs,6} ms  ({(totalParseMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine($"  Invoke Wait:    {invokeOverheadMs,6} ms  ({(invokeOverheadMs * 100.0 / totalMs),5:F1}%)  [thread switch]");
                    Console.WriteLine($"  Scroll Setup:   {scrollSetupMs,6} ms  ({(scrollSetupMs * 100.0 / totalMs),5:F1}%)  [set center pos]");
                    Console.WriteLine($"  Viewport:       {viewportRenderMs,6} ms  ({(viewportRenderMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine($"  Mini Map:       {miniMapMs,6} ms  ({(miniMapMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine($"  Tile List:      {tileListMs,6} ms  ({(tileListMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine($"  Thumb Start:    {thumbnailStartMs,6} ms  ({(thumbnailStartMs * 100.0 / totalMs),5:F1}%)  [async start]");
                    Console.WriteLine($"  Unmeasured:     {unmeasuredMs,6} ms  ({(unmeasuredMs * 100.0 / totalMs),5:F1}%)");
                    Console.WriteLine("----------------------------------------");
                    Console.WriteLine($"  TOTAL:          {totalMs,6} ms  (thumbnails in background)");
                    Console.WriteLine("========================================");
                });
            });
        }

        // åˆ†æç¬¬ä¸‰å±¤å±¬æ€§é¡å‹
        private void AnalyzeLayer3Attributes()
        {
            // çµ±è¨ˆ Attribute1 å’Œ Attribute2 çš„æ‰€æœ‰ä¸åŒå€¼
            Dictionary<short, int> attr1Values = new Dictionary<short, int>();
            Dictionary<short, int> attr2Values = new Dictionary<short, int>();

            foreach (var s32Data in _document.S32Files.Values)
            {
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 64; x++)
                    {
                        var attr = s32Data.Layer3[y, x];
                        if (attr == null) continue;

                        // çµ±è¨ˆ Attribute1
                        if (!attr1Values.ContainsKey(attr.Attribute1))
                            attr1Values[attr.Attribute1] = 0;
                        attr1Values[attr.Attribute1]++;

                        // çµ±è¨ˆ Attribute2
                        if (!attr2Values.ContainsKey(attr.Attribute2))
                            attr2Values[attr.Attribute2] = 0;
                        attr2Values[attr.Attribute2]++;
                    }
                }
            }

            // å»ºç«‹åˆ†æçµæœ
            StringBuilder sb = new StringBuilder();
            sb.AppendLine($"åœ°åœ–: {_document.MapId}");
            sb.AppendLine();

            sb.AppendLine("ã€å·¦ä¸Šé‚Š (Attribute1) çµ±è¨ˆã€‘");
            foreach (var kvp in attr1Values.OrderByDescending(x => x.Value).Take(15))
            {
                string flags = GetAttributeFlags(kvp.Key);
                sb.AppendLine($"  0x{kvp.Key:X4}: {kvp.Value} å€‹ | {flags}");
            }
            if (attr1Values.Count > 15)
                sb.AppendLine($"  ... é‚„æœ‰ {attr1Values.Count - 15} ç¨®å…¶ä»–å€¼");

            sb.AppendLine();
            sb.AppendLine("ã€å³ä¸Šé‚Š (Attribute2) çµ±è¨ˆã€‘");
            foreach (var kvp in attr2Values.OrderByDescending(x => x.Value).Take(15))
            {
                string flags = GetAttributeFlags(kvp.Key);
                sb.AppendLine($"  0x{kvp.Key:X4}: {kvp.Value} å€‹ | {flags}");
            }
            if (attr2Values.Count > 15)
                sb.AppendLine($"  ... é‚„æœ‰ {attr2Values.Count - 15} ç¨®å…¶ä»–å€¼");

            MessageBox.Show(sb.ToString(), "ç¬¬ä¸‰å±¤å±¬æ€§åˆ†æ", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // å–å¾—å±¬æ€§æ¨™è¨˜èªªæ˜
        private string GetAttributeFlags(short value)
        {
            List<string> flags = new List<string>();

            if ((value & 0x0001) != 0) flags.Add("ä¸å¯é€šè¡Œ");
            // MapTool é‚è¼¯: ä½4ä½ 4-7,C-F=å®‰å…¨, 8-B=æˆ°é¬¥
            int lowNibble = value & 0x0F;
            if ((lowNibble & 0x04) != 0) flags.Add("å®‰å…¨å€");
            else if ((lowNibble & 0x0C) == 0x08) flags.Add("æˆ°é¬¥å€");
            if ((value & 0x0002) != 0) flags.Add("bit1");
            if ((value & 0x0010) != 0) flags.Add("bit4");
            if ((value & 0x0020) != 0) flags.Add("bit5");
            if ((value & 0x0040) != 0) flags.Add("bit6");
            if ((value & 0x0080) != 0) flags.Add("bit7");
            if ((value & 0x0100) != 0) flags.Add("bit8");
            if ((value & 0x0200) != 0) flags.Add("bit9");
            if ((value & 0x0400) != 0) flags.Add("bit10");
            if ((value & 0x0800) != 0) flags.Add("bit11");
            if ((value & 0x1000) != 0) flags.Add("bit12");
            if ((value & 0x2000) != 0) flags.Add("bit13");
            if ((value & 0x4000) != 0) flags.Add("bit14");
            if ((value & 0x8000) != 0) flags.Add("bit15");

            if (flags.Count == 0) flags.Add("ç„¡æ¨™è¨˜(å¯é€šè¡Œ)");

            return string.Join(", ", flags);
        }

        // s32 æª”æ¡ˆé¸æ“‡è®Šæ›´äº‹ä»¶
        private void lstS32Files_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (lstS32Files.SelectedItem == null)
                return;

            var item = (S32FileItem)lstS32Files.SelectedItem;

            // ä¿å­˜ç•¶å‰é¸æ“‡çš„æª”æ¡ˆè³‡è¨Š
            currentS32FileItem = item;

            // è¼‰å…¥ä¸¦è§£æ s32 æª”æ¡ˆ
            LoadAndParseS32File(item.FilePath);
        }

        // S32 æª”æ¡ˆæ¸…å–®ç¹ªè£½äº‹ä»¶ï¼ˆè‡ªè¨‚é«˜äº®ï¼‰
        private void lstS32Files_DrawItem(object sender, DrawItemEventArgs e)
        {
            if (e.Index < 0 || e.Index >= lstS32Files.Items.Count)
                return;

            var item = lstS32Files.Items[e.Index] as S32FileItem;
            if (item == null)
                return;

            // åˆ¤æ–·æ˜¯å¦éœ€è¦é«˜äº®ï¼ˆé¸å–å€åŸŸæ¶‰åŠçš„ S32ï¼‰
            bool isHighlighted = _highlightedS32Paths != null && _highlightedS32Paths.Contains(item.FilePath);
            bool isSelected = (e.State & DrawItemState.Selected) == DrawItemState.Selected;
            bool isChecked = lstS32Files.GetItemChecked(e.Index);

            // ç¹ªè£½èƒŒæ™¯
            Color backColor;
            if (isSelected)
                backColor = SystemColors.Highlight;
            else if (isHighlighted)
                backColor = Color.FromArgb(255, 255, 200);  // æ·¡é»ƒè‰²é«˜äº®
            else
                backColor = SystemColors.Window;

            using (var brush = new SolidBrush(backColor))
            {
                e.Graphics.FillRectangle(brush, e.Bounds);
            }

            // ç¹ªè£½å‹¾é¸æ¡†
            int checkboxWidth = 16;
            Rectangle checkRect = new Rectangle(e.Bounds.X + 2, e.Bounds.Y + (e.Bounds.Height - 12) / 2, 12, 12);
            ControlPaint.DrawCheckBox(e.Graphics, checkRect,
                isChecked ? ButtonState.Checked : ButtonState.Normal);

            // ç¹ªè£½æ–‡å­—
            Color textColor = isSelected ? SystemColors.HighlightText : SystemColors.WindowText;
            Font drawFont = e.Font ?? lstS32Files.Font;
            using (var brush = new SolidBrush(textColor))
            {
                Rectangle textRect = new Rectangle(e.Bounds.X + checkboxWidth + 4, e.Bounds.Y,
                    e.Bounds.Width - checkboxWidth - 4, e.Bounds.Height);

                var format = new StringFormat
                {
                    LineAlignment = StringAlignment.Center,
                    Trimming = StringTrimming.EllipsisCharacter
                };
                e.Graphics.DrawString(item.ToString(), drawFont, brush, textRect, format);
            }

            // ç¹ªè£½ç„¦é»æ¡†
            if ((e.State & DrawItemState.Focus) == DrawItemState.Focus)
            {
                ControlPaint.DrawFocusRectangle(e.Graphics, e.Bounds);
            }
        }

        // S32 æª”æ¡ˆæ¸…å–®å³éµè·³è½‰
        private void lstS32Files_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            // å–å¾—é»æ“Šä½ç½®çš„é …ç›®
            int index = lstS32Files.IndexFromPoint(e.Location);
            if (index < 0 || index >= lstS32Files.Items.Count)
                return;

            var item = lstS32Files.Items[index] as S32FileItem;
            if (item == null)
                return;

            // é¸å–è©²é …ç›®
            lstS32Files.SelectedIndex = index;

            // å»ºç«‹å³éµé¸å–®
            ContextMenuStrip menu = new ContextMenuStrip();

            // è·³è½‰é¸é …
            ToolStripMenuItem jumpItem = new ToolStripMenuItem("è·³è½‰è‡³æ­¤å€å¡Š");
            jumpItem.Click += (s, args) =>
            {
                JumpToS32Block(item);
            };
            menu.Items.Add(jumpItem);

            // æŸ¥çœ‹è©³ç´°é¸é …
            ToolStripMenuItem detailItem = new ToolStripMenuItem("æŸ¥çœ‹è©³ç´°è³‡æ–™");
            detailItem.Click += (s, args) =>
            {
                ShowS32Details(item);
            };
            menu.Items.Add(detailItem);

            menu.Items.Add(new ToolStripSeparator());

            // åŒ¯å‡ºæ•´å¼µåœ°åœ–
            ToolStripMenuItem exportMapItem = new ToolStripMenuItem("åŒ¯å‡ºæ•´å¼µåœ°åœ–ç‚º fs32 åœ°åœ–åŒ…...");
            exportMapItem.Click += (s, args) => ExportCurrentMapAsFs32();
            menu.Items.Add(exportMapItem);

            // åŒ¯å‡ºå·²å‹¾é¸çš„ S32 æª”æ¡ˆ
            int checkedCount = lstS32Files.CheckedItems.Count;
            if (checkedCount > 0)
            {
                ToolStripMenuItem exportCheckedItem = new ToolStripMenuItem($"åŒ¯å‡ºå·²å‹¾é¸çš„ {checkedCount} å€‹å€å¡Šç‚º fs32 åœ°åœ–åŒ…...");
                exportCheckedItem.Click += (s, args) => ExportCheckedS32AsFs32();
                menu.Items.Add(exportCheckedItem);
            }

            menu.Items.Add(new ToolStripSeparator());

            // åŒ¯å…¥ fs32 åœ°åœ–åŒ…
            ToolStripMenuItem importFs32Item = new ToolStripMenuItem("åŒ¯å…¥ fs32 åœ°åœ–åŒ…...");
            importFs32Item.Click += (s, args) => ImportFs32ToCurrentMap();
            menu.Items.Add(importFs32Item);

            menu.Show(lstS32Files, e.Location);
        }

        // åŒ¯å‡ºç•¶å‰åœ°åœ–ç‚º fs32
        private void ExportCurrentMapAsFs32()
        {
            if (string.IsNullOrEmpty(_document.MapId) || _document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: false, hasSelection: false))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                // æª¢æŸ¥ç•°å¸¸ï¼ˆåŒ¯å‡ºä¸æª¢æŸ¥ Tile ä¸Šé™ï¼Œè‹¥æœƒç§»é™¤ L8 æ“´å±•å‰‡ä¸æª¢æŸ¥ï¼‰
                if (!CheckLayer5IssuesAndConfirm(_document.S32Files, "åŒ¯å‡º", checkTileLimit: false, checkLayer8Extended: !dialog.StripLayer8Ext))
                    return;

                using (var saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32";
                    saveDialog.FileName = $"{_document.MapId}.fs32";

                    if (saveDialog.ShowDialog() != DialogResult.OK)
                        return;

                    try
                    {
                        toolStripStatusLabel1.Text = $"æ­£åœ¨åŒ¯å‡ºåœ°åœ–...";
                        Application.DoEvents();

                        var fs32 = Fs32Writer.CreateFromMap(_document, dialog.LayerFlags, dialog.IncludeTiles, dialog.StripLayer8Ext);

                        // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                        if (dialog.IncludeTiles && fs32.Tiles.Count > 0)
                        {
                            int remasterCount = fs32.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                            if (remasterCount > 0)
                            {
                                var result = MessageBox.Show(
                                    $"åœ°åœ–åŒ…ä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                    "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                    "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                    "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                    "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                    MessageBoxButtons.YesNo,
                                    MessageBoxIcon.Question,
                                    MessageBoxDefaultButton.Button1);

                                if (result == DialogResult.Yes)
                                {
                                    foreach (var tileId in fs32.Tiles.Keys.ToList())
                                    {
                                        var tile = fs32.Tiles[tileId];
                                        if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                        {
                                            tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                            tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                        }
                                    }
                                }
                            }
                        }

                        Fs32Writer.Write(fs32, saveDialog.FileName);

                        string resultMsg = $"å·²åŒ¯å‡ºè‡³ {saveDialog.FileName}\n({fs32.Blocks.Count} å€å¡Š, {fs32.Tiles.Count} åœ–å¡Š)";
                        toolStripStatusLabel1.Text = resultMsg.Replace("\n", " ");
                        ShowAutoCloseMessage(resultMsg, "åŒ¯å‡ºå®Œæˆ");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[Export] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        // åŒ¯å‡ºå·²å‹¾é¸çš„ S32 ç‚º fs32
        private void ExportCheckedS32AsFs32()
        {
            var checkedS32s = new Dictionary<string, S32Data>();
            for (int i = 0; i < lstS32Files.Items.Count; i++)
            {
                if (lstS32Files.GetItemChecked(i) && lstS32Files.Items[i] is S32FileItem item)
                {
                    if (_document.S32Files.TryGetValue(item.FilePath, out var s32Data))
                    {
                        checkedS32s[item.FilePath] = s32Data;
                    }
                }
            }

            if (checkedS32s.Count == 0)
            {
                MessageBox.Show("æ²’æœ‰å·²å‹¾é¸çš„ S32 æª”æ¡ˆ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: false, hasSelection: true))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                // æª¢æŸ¥ç•°å¸¸ï¼ˆåŒ¯å‡ºä¸æª¢æŸ¥ Tile ä¸Šé™ï¼Œè‹¥æœƒç§»é™¤ L8 æ“´å±•å‰‡ä¸æª¢æŸ¥ï¼‰
                if (!CheckLayer5IssuesAndConfirm(checkedS32s, "åŒ¯å‡º", checkTileLimit: false, checkLayer8Extended: !dialog.StripLayer8Ext))
                    return;

                using (var saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32";
                    saveDialog.FileName = $"{_document.MapId}_partial.fs32";

                    if (saveDialog.ShowDialog() != DialogResult.OK)
                        return;

                    try
                    {
                        toolStripStatusLabel1.Text = $"æ­£åœ¨åŒ¯å‡º {checkedS32s.Count} å€‹å€å¡Š...";
                        Application.DoEvents();

                        var fs32 = Fs32Writer.CreateFromS32List(checkedS32s.Values.ToList(), _document.MapId, dialog.LayerFlags, dialog.IncludeTiles, dialog.StripLayer8Ext);

                        // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                        if (dialog.IncludeTiles && fs32.Tiles.Count > 0)
                        {
                            int remasterCount = fs32.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                            if (remasterCount > 0)
                            {
                                var result = MessageBox.Show(
                                    $"åœ°åœ–åŒ…ä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                    "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                    "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                    "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                    "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                    MessageBoxButtons.YesNo,
                                    MessageBoxIcon.Question,
                                    MessageBoxDefaultButton.Button1);

                                if (result == DialogResult.Yes)
                                {
                                    foreach (var tileId in fs32.Tiles.Keys.ToList())
                                    {
                                        var tile = fs32.Tiles[tileId];
                                        if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                        {
                                            tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                            tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                        }
                                    }
                                }
                            }
                        }

                        Fs32Writer.Write(fs32, saveDialog.FileName);

                        string resultMsg = $"å·²åŒ¯å‡ºè‡³ {saveDialog.FileName}\n({fs32.Blocks.Count} å€å¡Š, {fs32.Tiles.Count} åœ–å¡Š)";
                        toolStripStatusLabel1.Text = resultMsg.Replace("\n", " ");
                        ShowAutoCloseMessage(resultMsg, "åŒ¯å‡ºå®Œæˆ");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[Export] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        // åŒ¯å…¥ fs32 åœ°åœ–åŒ…åˆ°ç•¶å‰åœ°åœ–
        private void ImportFs32ToCurrentMap()
        {
            if (string.IsNullOrEmpty(_document.MapId))
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            string mapPath = Path.Combine(Share.LineagePath, "Map", _document.MapId);

            using (var openDialog = new OpenFileDialog())
            {
                openDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32|æ‰€æœ‰æª”æ¡ˆ|*.*";
                openDialog.Title = "é¸æ“‡è¦åŒ¯å…¥çš„ fs32 åœ°åœ–åŒ…";

                if (openDialog.ShowDialog() != DialogResult.OK)
                    return;

                try
                {
                    // 1. è¼‰å…¥ fs32
                    toolStripStatusLabel1.Text = "æ­£åœ¨è¼‰å…¥ fs32...";
                    Application.DoEvents();

                    var fs32 = Fs32Parser.ParseFile(openDialog.FileName);
                    if (fs32 == null || fs32.Blocks.Count == 0)
                    {
                        MessageBox.Show("ç„¡æ•ˆçš„ fs32 æª”æ¡ˆæˆ–ä¸åŒ…å«ä»»ä½•å€å¡Š", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    // 2. é¡¯ç¤ºåŒ¯å…¥è³‡è¨Šä¸¦é¸æ“‡åŒ¯å…¥æ¨¡å¼
                    string infoMessage = $"fs32 åœ°åœ–åŒ…è³‡è¨Šï¼š\n\n" +
                                         $"â€¢ ä¾†æºåœ°åœ–: {fs32.SourceMapId}\n" +
                                         $"â€¢ å€å¡Šæ•¸é‡: {fs32.Blocks.Count}\n" +
                                         $"â€¢ åœ–å¡Šæ•¸é‡: {fs32.Tiles.Count}\n\n" +
                                         $"å°‡åŒ¯å…¥è‡³ç•¶å‰åœ°åœ–: {_document.MapId}";

                    var importModeResult = ShowImportModeDialog(infoMessage);

                    if (importModeResult == null)
                        return;

                    bool isFullReplace = importModeResult.Value;

                    // å…¨éƒ¨å–ä»£éœ€è¦äºŒæ¬¡ç¢ºèª
                    if (isFullReplace)
                    {
                        var warningResult = MessageBox.Show(
                            "âš ï¸ è­¦å‘Šï¼šå…¨éƒ¨å–ä»£æ¨¡å¼ âš ï¸\n\n" +
                            "é€™å°‡æœƒåˆªé™¤ç•¶å‰åœ°åœ–çš„æ‰€æœ‰æ—¢æœ‰å€å¡Šï¼\n" +
                            "æ•´å¼µåœ°åœ–å¯èƒ½æœƒæ¶ˆå¤±ï¼Œåªå‰©ä¸‹åŒ¯å…¥çš„å€å¡Šã€‚\n\n" +
                            "æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\n" +
                            "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ",
                            "å±éšªæ“ä½œç¢ºèª",
                            MessageBoxButtons.YesNo,
                            MessageBoxIcon.Warning,
                            MessageBoxDefaultButton.Button2);

                        if (warningResult != DialogResult.Yes)
                            return;
                    }

                    // 3. è™•ç† Tilesï¼ˆå¦‚æœæœ‰ï¼‰
                    TileMappingResult tileMapping = null;
                    if (fs32.Tiles.Count > 0)
                    {
                        tileMapping = ProcessFs32Tiles(fs32);
                        if (tileMapping == null)
                        {
                            // ç”¨æˆ¶å–æ¶ˆ
                            return;
                        }
                    }

                    // 4. å…¨éƒ¨å–ä»£æ¨¡å¼ï¼šåˆªé™¤æ—¢æœ‰ S32 æª”æ¡ˆ
                    int deletedCount = 0;
                    if (isFullReplace)
                    {
                        toolStripStatusLabel1.Text = "æ­£åœ¨åˆªé™¤æ—¢æœ‰å€å¡Š...";
                        Application.DoEvents();

                        var existingS32Files = Directory.GetFiles(mapPath, "*.s32");
                        foreach (var file in existingS32Files)
                        {
                            try
                            {
                                File.Delete(file);
                                deletedCount++;
                                Console.WriteLine($"[ImportFs32] Deleted: {Path.GetFileName(file)}");
                            }
                            catch (Exception ex)
                            {
                                Console.WriteLine($"[ImportFs32] Failed to delete {Path.GetFileName(file)}: {ex.Message}");
                            }
                        }
                        Console.WriteLine($"[ImportFs32] Deleted {deletedCount} existing S32 files");
                    }

                    // 5. è§£æä¸¦å¯«å…¥ S32 å€å¡Š
                    toolStripStatusLabel1.Text = "æ­£åœ¨åŒ¯å…¥å€å¡Š...";
                    Application.DoEvents();

                    int importedCount = 0;
                    int skippedCount = 0;
                    var errors = new List<string>();

                    // å–å¾— MapInfoï¼ˆå¯èƒ½ç‚º nullï¼Œéœ€è¦å¾ç¾æœ‰ S32 æ¨ç®—ï¼‰
                    int mapMinBlockX = 0x7FFF;
                    int mapMinBlockY = 0x7FFF;
                    int mapBlockCountX = 1;

                    if (_document.MapInfo != null)
                    {
                        mapMinBlockX = _document.MapInfo.nMinBlockX;
                        mapMinBlockY = _document.MapInfo.nMinBlockY;
                        mapBlockCountX = _document.MapInfo.nBlockCountX;
                    }
                    else if (_document.S32Files.Count > 0)
                    {
                        // å¾ç¾æœ‰ S32 æ¨ç®—
                        var firstS32 = _document.S32Files.Values.First();
                        if (firstS32.SegInfo != null)
                        {
                            mapMinBlockX = firstS32.SegInfo.nMapMinBlockX;
                            mapMinBlockY = firstS32.SegInfo.nMapMinBlockY;
                            mapBlockCountX = firstS32.SegInfo.nMapBlockCountX;
                        }
                    }

                    Console.WriteLine($"[ImportFs32] MapInfo: MinBlockX={mapMinBlockX:X4}, MinBlockY={mapMinBlockY:X4}, BlockCountX={mapBlockCountX}");

                    foreach (var block in fs32.Blocks)
                    {
                        try
                        {
                            Console.WriteLine($"[ImportFs32] Processing block {block.BlockX:X4}{block.BlockY:X4}, data size={block.S32Data?.Length ?? 0}");

                            // è§£æ S32 è³‡æ–™
                            if (block.S32Data == null || block.S32Data.Length == 0)
                            {
                                errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: è³‡æ–™ç‚ºç©º");
                                skippedCount++;
                                continue;
                            }

                            var s32Data = S32Parser.Parse(block.S32Data);
                            if (s32Data == null)
                            {
                                errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: è§£æå¤±æ•—");
                                skippedCount++;
                                continue;
                            }

                            Console.WriteLine($"[ImportFs32] Parsed OK: Layer1={s32Data.Layer1 != null}, Layer2={s32Data.Layer2?.Count ?? 0}, Layer4={s32Data.Layer4?.Count ?? 0}");

                            // è¨­ç½® SegInfo
                            var segInfo = new Struct.L1MapSeg(block.BlockX, block.BlockY, true);
                            segInfo.nMapMinBlockX = mapMinBlockX;
                            segInfo.nMapMinBlockY = mapMinBlockY;
                            segInfo.nMapBlockCountX = mapBlockCountX;
                            s32Data.SegInfo = segInfo;

                            // å¦‚æœæœ‰ Tile Mappingï¼Œå¥—ç”¨åˆ° S32
                            if (tileMapping != null && tileMapping.IdMapping.Count > 0)
                            {
                                ApplyTileMappingToS32(s32Data, tileMapping);
                            }

                            // å¯«å…¥ S32 åˆ°ç›®æ¨™åœ°åœ–è³‡æ–™å¤¾
                            string s32FileName = $"{block.BlockX:x4}{block.BlockY:x4}.s32";
                            string s32FilePath = Path.Combine(mapPath, s32FileName);

                            Console.WriteLine($"[ImportFs32] Writing to {s32FilePath}");
                            S32Writer.Write(s32Data, s32FilePath);
                            importedCount++;
                            Console.WriteLine($"[ImportFs32] Block {block.BlockX:X4}{block.BlockY:X4} done");
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"[ImportFs32] Error in block {block.BlockX:X4}{block.BlockY:X4}: {ex}");
                            errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: {ex.Message}");
                            skippedCount++;
                        }
                    }

                    // 6. é¡¯ç¤ºçµæœ
                    string resultMessage = $"åŒ¯å…¥å®Œæˆï¼\n\n" +
                                           $"â€¢ åŒ¯å…¥æ¨¡å¼: {(isFullReplace ? "å…¨éƒ¨å–ä»£" : "éƒ¨ä»½å–ä»£")}\n";

                    if (isFullReplace && deletedCount > 0)
                    {
                        resultMessage += $"â€¢ å·²åˆªé™¤æ—¢æœ‰å€å¡Š: {deletedCount} å€‹\n";
                    }

                    resultMessage += $"â€¢ æˆåŠŸåŒ¯å…¥: {importedCount} å€‹å€å¡Š\n";

                    if (tileMapping != null)
                    {
                        resultMessage += $"â€¢ åŒ¯å…¥åœ–å¡Š: {tileMapping.ImportedCount} å€‹\n" +
                                         $"â€¢ é‡ç”¨åœ–å¡Š: {tileMapping.ReuseCount} å€‹\n" +
                                         $"â€¢ é‡æ–°ç·¨è™Ÿ: {tileMapping.RemappedCount} å€‹\n";
                    }

                    if (skippedCount > 0)
                    {
                        resultMessage += $"\nè·³é {skippedCount} å€‹å€å¡Š";
                        if (errors.Count > 0 && errors.Count <= 5)
                        {
                            resultMessage += ":\n" + string.Join("\n", errors);
                        }
                    }

                    MessageBox.Show(resultMessage, "åŒ¯å…¥å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);

                    // 7. é‡æ–°è¼‰å…¥ S32 æª”æ¡ˆæ¸…å–®
                    toolStripStatusLabel1.Text = "æ­£åœ¨é‡æ–°è¼‰å…¥åœ°åœ–...";
                    Application.DoEvents();

                    // è¨˜ä½ç•¶å‰æ»¾å‹•ä½ç½®
                    int scrollX = _viewState.ScrollX;
                    int scrollY = _viewState.ScrollY;

                    // å…ˆé‡æ–°æ•´ç† Share.MapDataList ä¸­çš„åœ°åœ–è³‡æ–™ï¼ˆæ›´æ–°æª”æ¡ˆæ¸…å–®ï¼‰
                    Console.WriteLine($"[ImportFs32] Refreshing map data for: {_document.MapId}");
                    L1MapHelper.RefreshMap(_document.MapId);

                    // æ¸…é™¤ Tile ç›¸é—œå¿«å–ï¼ˆåŒ¯å…¥æ–° Tile å¾Œéœ€è¦é‡æ–°è®€å–ï¼‰
                    Console.WriteLine($"[ImportFs32] Clearing tile caches");
                    TileHashManager.ClearCache();
                    _tilFileCache.Clear();
                    _tilRemasterCache.Clear();
                    tileDataCache.Clear();
                    cachedAggregatedTiles.Clear();

                    // é‡æ–°è¼‰å…¥ S32 æª”æ¡ˆæ¸…å–®
                    Console.WriteLine($"[ImportFs32] Reloading S32 file list for map: {_document.MapId}");
                    LoadS32FileList(_document.MapId);

                    // æ¢å¾©æ»¾å‹•ä½ç½®
                    _viewState.SetScrollSilent(scrollX, scrollY);
                    if (scrollX <= hScrollBar1.Maximum) hScrollBar1.Value = scrollX;
                    if (scrollY <= vScrollBar1.Maximum) vScrollBar1.Value = scrollY;

                    CheckAndRerenderIfNeeded();
                    UpdateMiniMap();

                    toolStripStatusLabel1.Text = $"å·²åŒ¯å…¥ {importedCount} å€‹å€å¡Š";
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ImportFs32] Error: {ex}");
                    MessageBox.Show($"åŒ¯å…¥å¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // è™•ç† fs32 ä¸­çš„ Tilesï¼ˆé¡ä¼¼ fs3p çš„é‚è¼¯ï¼‰
        private TileMappingResult ProcessFs32Tiles(Fs32Data fs32)
        {
            // å…ˆé€²è¡Œé è¦½åˆ†æ
            var previewResult = PreviewTileImport(fs32.Tiles);

            // å¦‚æœæ‰€æœ‰ tiles éƒ½å¯ä»¥é‡ç”¨ï¼Œéœé»˜è™•ç†
            if (previewResult.NeedImportCount == 0 && previewResult.NeedRemapCount == 0)
            {
                return BuildMappingWithoutImport(fs32.Tiles);
            }

            // éœ€è¦åŒ¯å…¥æ–° tilesï¼Œé¡¯ç¤ºå°è©±æ¡†è®“ä½¿ç”¨è€…ç¢ºèª
            string message = $"åœ°åœ–åŒ…åŒ…å« {fs32.Tiles.Count} å€‹åœ–å¡Šï¼š\n\n" +
                             $"â€¢ å¯é‡ç”¨ (MD5 ç›¸ç¬¦): {previewResult.ReuseCount} å€‹\n" +
                             $"â€¢ éœ€é‡æ–°ç·¨è™Ÿ (ID è¡çª): {previewResult.NeedRemapCount} å€‹\n" +
                             $"â€¢ éœ€æ–°å¢åŒ¯å…¥: {previewResult.NeedImportCount} å€‹\n\n" +
                             $"è«‹è¼¸å…¥æ–°åœ–å¡Šçš„èµ·å§‹ç·¨è™Ÿï¼š";

            using (var dialog = new Form())
            {
                dialog.Text = "åœ–å¡ŠåŒ¯å…¥è¨­å®š";
                dialog.Size = new Size(420, 220);
                dialog.StartPosition = FormStartPosition.CenterParent;
                dialog.FormBorderStyle = FormBorderStyle.FixedDialog;
                dialog.MaximizeBox = false;
                dialog.MinimizeBox = false;

                var lblMessage = new Label
                {
                    Text = message,
                    Location = new Point(15, 15),
                    Size = new Size(380, 100),
                    AutoSize = false
                };
                dialog.Controls.Add(lblMessage);

                var lblStartId = new Label
                {
                    Text = "èµ·å§‹ç·¨è™Ÿï¼š",
                    Location = new Point(15, 125),
                    Size = new Size(75, 20)
                };
                dialog.Controls.Add(lblStartId);

                var txtStartId = new TextBox
                {
                    Text = "10000",
                    Location = new Point(95, 122),
                    Size = new Size(100, 23)
                };
                dialog.Controls.Add(txtStartId);

                var btnOK = new Button
                {
                    Text = "ç¢ºå®šåŒ¯å…¥",
                    DialogResult = DialogResult.OK,
                    Location = new Point(220, 145),
                    Size = new Size(85, 28)
                };
                dialog.Controls.Add(btnOK);

                var btnCancel = new Button
                {
                    Text = "å–æ¶ˆ",
                    DialogResult = DialogResult.Cancel,
                    Location = new Point(310, 145),
                    Size = new Size(85, 28)
                };
                dialog.Controls.Add(btnCancel);

                dialog.AcceptButton = btnOK;
                dialog.CancelButton = btnCancel;

                if (dialog.ShowDialog() != DialogResult.OK)
                    return null;

                if (!int.TryParse(txtStartId.Text, out int startId) || startId < 1)
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹ç·¨è™Ÿ (å¤§æ–¼ 0)", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return null;
                }

                // åŸ·è¡Œå¯¦éš›åŒ¯å…¥
                var importer = new TileImportManager { StartSearchId = startId };
                var result = importer.ProcessTilesBatch(fs32.Tiles);

                // æª¢æŸ¥æ˜¯å¦æœ‰ Tile ID è¶…éä¸Šé™
                CheckAndExpandTileLimit(result);

                return result;
            }
        }

        // å°‡ Tile Mapping å¥—ç”¨åˆ° S32 çš„å„åœ–å±¤
        private void ApplyTileMappingToS32(S32Data s32Data, TileMappingResult mapping)
        {
            // Layer1
            if (s32Data.Layer1 != null)
            {
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId > 0)
                        {
                            cell.TileId = mapping.GetNewTileId(cell.TileId);
                        }
                    }
                }
            }

            // Layer2
            foreach (var item in s32Data.Layer2)
            {
                if (item.TileId > 0)
                {
                    item.TileId = (ushort)mapping.GetNewTileId(item.TileId);
                }
            }

            // Layer4
            foreach (var obj in s32Data.Layer4)
            {
                if (obj.TileId > 0)
                {
                    obj.TileId = mapping.GetNewTileId(obj.TileId);
                }
            }
        }

        // è·³è½‰è‡³æŒ‡å®š S32 å€å¡Š
        private void JumpToS32Block(S32FileItem item)
        {
            // ä½¿ç”¨ S32 å€å¡Šä¸­å¿ƒä½ç½®çš„ Layer3 åº§æ¨™
            var segInfo = item.SegInfo;
            int globalX = segInfo.nLinBeginX + 32;  // S32 ä¸­å¿ƒ (64x64 çš„ä¸­å¿ƒ)
            int globalY = segInfo.nLinBeginY + 32;

            // ä½¿ç”¨èˆ‡ JumpToGameCoordinate ç›¸åŒçš„åº§æ¨™è¨ˆç®—é‚è¼¯
            // Layer3 çš„æœ¬åœ°åº§æ¨™
            int layer3LocalX = 32;  // ä¸­å¿ƒä½ç½®
            int localY = 32;

            // è½‰æ›ç‚º Layer1 åº§æ¨™
            int localX = layer3LocalX * 2;

            // è¨ˆç®—è¢å¹•åº§æ¨™
            int[] loc = segInfo.GetLoc(1.0);
            int mx = loc[0];
            int my = loc[1];

            int localBaseX = 0;
            int localBaseY = 63 * 12;
            localBaseX -= 24 * (localX / 2);
            localBaseY -= 12 * (localX / 2);

            // è¨ˆç®—ä¸–ç•Œåº§æ¨™
            int worldX = mx + localBaseX + localX * 24 + localY * 24;
            int worldY = my + localBaseY + localY * 12;

            // æ²å‹•åˆ°è©²ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
            int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);
            int scrollX = worldX - viewportWidthWorld / 2;
            int scrollY = worldY - viewportHeightWorld / 2;

            int maxScrollX = Math.Max(0, _viewState.MapWidth - viewportWidthWorld);
            int maxScrollY = Math.Max(0, _viewState.MapHeight - viewportHeightWorld);
            scrollX = Math.Max(0, Math.Min(scrollX, maxScrollX));
            scrollY = Math.Max(0, Math.Min(scrollY, maxScrollY));

            _viewState.SetScrollSilent(scrollX, scrollY);

            // æ›´æ–°æ²è»¸
            hScrollBar1.Value = Math.Min(scrollX, hScrollBar1.Maximum);
            vScrollBar1.Value = Math.Min(scrollY, vScrollBar1.Maximum);

            // é‡æ–°æ¸²æŸ“
            CheckAndRerenderIfNeeded();
            UpdateMiniMap();

            this.toolStripStatusLabel1.Text = $"è·³è½‰è‡³ {item.DisplayName}";
        }

        // é¡¯ç¤º S32 è©³ç´°è³‡æ–™
        private void ShowS32Details(S32FileItem item)
        {
            if (!_document.S32Files.TryGetValue(item.FilePath, out S32Data s32Data))
            {
                MessageBox.Show("ç„¡æ³•è¼‰å…¥ S32 è³‡æ–™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            // çµ±è¨ˆå„å±¤è³‡æ–™
            int layer1Count = 0;
            for (int y = 0; y < 64; y++)
            {
                for (int x = 0; x < 128; x++)
                {
                    var cell = s32Data.Layer1[y, x];
                    if (cell != null && cell.TileId > 0)
                        layer1Count++;
                }
            }

            int layer2Count = s32Data.Layer2.Count;

            int layer3Count = 0;
            for (int y = 0; y < 64; y++)
            {
                for (int x = 0; x < 64; x++)
                {
                    var attr = s32Data.Layer3[y, x];
                    if (attr != null && (attr.Attribute1 != 0 || attr.Attribute2 != 0))
                        layer3Count++;
                }
            }

            int layer4Count = s32Data.Layer4.Count;
            int layer4GroupCount = s32Data.Layer4.Select(o => o.GroupId).Distinct().Count();

            int layer5Count = s32Data.Layer5.Count;
            int layer6Count = s32Data.Layer6.Count;
            int layer7Count = s32Data.Layer7.Count;
            int layer8Count = s32Data.Layer8.Count;

            // å»ºç«‹è©³ç´°è³‡è¨Šè¦–çª—
            Form detailForm = new Form();
            detailForm.Text = $"S32 è©³ç´°è³‡æ–™ - {item.DisplayName}";
            detailForm.Size = new Size(450, 420);
            detailForm.FormBorderStyle = FormBorderStyle.FixedDialog;
            detailForm.StartPosition = FormStartPosition.CenterParent;
            detailForm.MaximizeBox = false;
            detailForm.MinimizeBox = false;

            // æª”æ¡ˆè³‡è¨Š
            GroupBox gbFile = new GroupBox { Text = "æª”æ¡ˆè³‡è¨Š", Location = new Point(10, 10), Size = new Size(410, 80) };
            gbFile.Controls.Add(new Label { Text = $"æª”æ¡ˆè·¯å¾‘: {item.FilePath}", Location = new Point(10, 20), Size = new Size(390, 20), AutoEllipsis = true });
            gbFile.Controls.Add(new Label { Text = $"å€å¡Šåº§æ¨™: ({item.SegInfo.nBlockX}, {item.SegInfo.nBlockY})", Location = new Point(10, 40), Size = new Size(190, 20) });
            gbFile.Controls.Add(new Label { Text = $"éŠæˆ²åº§æ¨™: ({item.SegInfo.nLinBeginX}~{item.SegInfo.nLinEndX}, {item.SegInfo.nLinBeginY}~{item.SegInfo.nLinEndY})", Location = new Point(200, 40), Size = new Size(200, 20) });
            detailForm.Controls.Add(gbFile);

            // å„å±¤çµ±è¨ˆ
            GroupBox gbLayers = new GroupBox { Text = "å„å±¤è³‡æ–™çµ±è¨ˆ", Location = new Point(10, 100), Size = new Size(410, 230) };

            ListView lvLayers = new ListView();
            lvLayers.Location = new Point(10, 20);
            lvLayers.Size = new Size(390, 200);
            lvLayers.View = View.Details;
            lvLayers.FullRowSelect = true;
            lvLayers.GridLines = true;
            lvLayers.Columns.Add("å±¤ç´š", 80);
            lvLayers.Columns.Add("èªªæ˜", 150);
            lvLayers.Columns.Add("æ•¸é‡", 80);
            lvLayers.Columns.Add("å‚™è¨»", 70);

            lvLayers.Items.Add(new ListViewItem(new[] { "Layer1", "åœ°æ¿åœ–å¡Š", layer1Count.ToString(), $"/{64 * 128}" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer2", "ç¬¬äºŒå±¤è³‡æ–™", layer2Count.ToString(), "" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer3", "åœ°åœ–å±¬æ€§", layer3Count.ToString(), $"/{64 * 64}" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer4", "ç‰©ä»¶", layer4Count.ToString(), $"{layer4GroupCount} ç¾¤çµ„" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer5", "äº‹ä»¶", layer5Count.ToString(), "" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer6", "ä½¿ç”¨çš„ TileId", layer6Count.ToString(), "" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer7", "å‚³é€é»", layer7Count.ToString(), "" }));
            lvLayers.Items.Add(new ListViewItem(new[] { "Layer8", "ç‰¹æ•ˆ", layer8Count.ToString(), s32Data.Layer8HasExtendedData ? "æ“´å±•" : "" }));

            gbLayers.Controls.Add(lvLayers);
            detailForm.Controls.Add(gbLayers);

            // æŒ‰éˆ•
            Button btnClose = new Button { Text = "é—œé–‰", Location = new Point(350, 340), Size = new Size(80, 30) };
            btnClose.Click += (s, args) => detailForm.Close();
            detailForm.Controls.Add(btnClose);

            Button btnJump = new Button { Text = "è·³è½‰è‡³æ­¤", Location = new Point(260, 340), Size = new Size(80, 30) };
            btnJump.Click += (s, args) =>
            {
                JumpToS32Block(item);
                detailForm.Close();
            };
            detailForm.Controls.Add(btnJump);

            detailForm.ShowDialog();
        }

        // S32 æ¸…å–®å‹¾é¸ç‹€æ…‹è®Šæ›´äº‹ä»¶
        private void lstS32Files_ItemCheck(object sender, ItemCheckEventArgs e)
        {
            // æ›´æ–°é …ç›®çš„å‹¾é¸ç‹€æ…‹
            if (lstS32Files.Items[e.Index] is S32FileItem item)
            {
                item.IsChecked = (e.NewValue == CheckState.Checked);

                // æ›´æ–°å‹¾é¸æª”æ¡ˆå¿«å–
                if (e.NewValue == CheckState.Checked)
                    _checkedS32Files.Add(item.FilePath);
                else
                    _checkedS32Files.Remove(item.FilePath);

                // å»¶é²è§¸ç™¼é‡æ–°æ¸²æŸ“ï¼ˆå› ç‚º ItemCheck åœ¨ç‹€æ…‹è®Šæ›´å‰è§¸ç™¼ï¼‰
                if (!_isBatchCheckUpdate)
                {
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        RenderS32Map();
                    });
                }
            }
        }

        // æ‰¹æ¬¡å‹¾é¸æ›´æ–°æ¨™è¨˜ï¼ˆé¿å…æ¯æ¬¡å‹¾é¸éƒ½è§¸ç™¼æ¸²æŸ“ï¼‰
        private bool _isBatchCheckUpdate = false;

        // å…¨é¸ S32 æª”æ¡ˆ
        private void btnS32SelectAll_Click(object sender, EventArgs e)
        {
            _isBatchCheckUpdate = true;
            for (int i = 0; i < lstS32Files.Items.Count; i++)
            {
                lstS32Files.SetItemChecked(i, true);
            }
            _isBatchCheckUpdate = false;
            RenderS32Map();
        }

        // å…¨ä¸é¸ S32 æª”æ¡ˆ
        private void btnS32SelectNone_Click(object sender, EventArgs e)
        {
            _isBatchCheckUpdate = true;
            for (int i = 0; i < lstS32Files.Items.Count; i++)
            {
                lstS32Files.SetItemChecked(i, false);
            }
            _isBatchCheckUpdate = false;
            RenderS32Map();
        }

        // ç´”ç²¹çš„ S32 æª”æ¡ˆè§£ææ–¹æ³•ï¼ˆä¸æ¶‰åŠ UIï¼‰
        private S32Data ParseS32File(byte[] data)
        {
            S32Data s32Data = new S32Data();

            // ä¿å­˜åŸå§‹æ–‡ä»¶æ•¸æ“šï¼ˆç›´æ¥ä½¿ç”¨ï¼Œä¸è¤‡è£½ï¼Œå› ç‚º data å·²ç¶“æ˜¯ç¨ç«‹çš„å‰¯æœ¬ï¼‰
            s32Data.OriginalFileData = data;

            using (BinaryReader br = new BinaryReader(new MemoryStream(data)))
            {
                // è¨˜éŒ„ç¬¬ä¸€å±¤åç§»
                s32Data.Layer1Offset = (int)br.BaseStream.Position;

                // ç¬¬ä¸€å±¤ï¼ˆåœ°æ¿ï¼‰- 64x128
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        int id = br.ReadByte();
                        int til = br.ReadUInt16();
                        int nk = br.ReadByte();

                        s32Data.Layer1[y, x] = new TileCell
                        {
                            X = x,
                            Y = y,
                            TileId = til,
                            IndexId = id
                        };

                        // æ”¶é›†ä½¿ç”¨çš„ tileï¼ˆç¬¬ä¸€å±¤ï¼‰
                        if (!s32Data.UsedTiles.ContainsKey(til))
                        {
                            s32Data.UsedTiles[til] = new TileInfo
                            {
                                TileId = til,
                                IndexId = id,
                                UsageCount = 1,
                                Thumbnail = null
                            };
                        }
                        else
                        {
                            s32Data.UsedTiles[til].UsageCount++;
                        }
                    }
                }

                // è¨˜éŒ„ç¬¬äºŒå±¤åç§»
                s32Data.Layer2Offset = (int)br.BaseStream.Position;

                // ç¬¬äºŒå±¤
                int layer2Count = br.ReadUInt16();
                for (int i = 0; i < layer2Count; i++)
                {
                    s32Data.Layer2.Add(new Layer2Item
                    {
                        X = br.ReadByte(),
                        Y = br.ReadByte(),
                        IndexId = br.ReadByte(),
                        TileId = br.ReadUInt16(),
                        UK = br.ReadByte()
                    });
                }

                // è¨˜éŒ„ç¬¬ä¸‰å±¤åç§»
                s32Data.Layer3Offset = (int)br.BaseStream.Position;

                // ç¬¬ä¸‰å±¤ï¼ˆåœ°åœ–å±¬æ€§ï¼‰- 64x64
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 64; x++)
                    {
                        s32Data.Layer3[y, x] = new MapAttribute
                        {
                            Attribute1 = br.ReadInt16(),
                            Attribute2 = br.ReadInt16()
                        };
                    }
                }

                // è¨˜éŒ„ç¬¬å››å±¤åç§»
                s32Data.Layer4Offset = (int)br.BaseStream.Position;

                // ç¬¬å››å±¤ï¼ˆç‰©ä»¶ï¼‰
                int layer4GroupCount = br.ReadInt32();
                for (int i = 0; i < layer4GroupCount; i++)
                {
                    int groupId = br.ReadInt16();
                    int blockCount = br.ReadUInt16();

                    for (int j = 0; j < blockCount; j++)
                    {
                        int x = br.ReadByte();
                        int y = br.ReadByte();

                        // æª¢æŸ¥æ˜¯å¦ç‚º dummy è³‡æ–™ (0xCD 0xCD)
                        if (x == 0xCD && y == 0xCD)
                        {
                            // è·³é 5 bytes dummy è³‡æ–™
                            br.ReadBytes(5);
                            j--;
                            blockCount--;
                            continue;
                        }

                        int layer = br.ReadByte();  // h (åœ–å±¤é«˜åº¦)
                        uint tileData = br.ReadUInt32();  // tiledata
                        int indexId = (int)(tileData & 0xFF);
                        int tileId = (int)((tileData >> 8) & 0xFFFFFF);

                        var objTile = new ObjectTile
                        {
                            GroupId = groupId,
                            X = x,
                            Y = y,
                            Layer = layer,
                            IndexId = indexId,
                            TileId = tileId
                        };

                        s32Data.Layer4.Add(objTile);

                        // æ”¶é›†ä½¿ç”¨çš„ tileï¼ˆç¬¬å››å±¤ï¼‰
                        if (!s32Data.UsedTiles.ContainsKey(tileId))
                        {
                            s32Data.UsedTiles[tileId] = new TileInfo
                            {
                                TileId = tileId,
                                IndexId = indexId,
                                UsageCount = 1,
                                Thumbnail = null
                            };
                        }
                        else
                        {
                            s32Data.UsedTiles[tileId].UsageCount++;
                        }
                    }
                }

                // è¨˜éŒ„ç¬¬å››å±¤çµæŸä½ç½®ï¼ˆå¾Œé¢å¯èƒ½é‚„æœ‰ç¬¬5-8å±¤ç­‰æœªçŸ¥æ•¸æ“šï¼‰
                s32Data.Layer4EndOffset = (int)br.BaseStream.Position;

                // è®€å–ç¬¬5-8å±¤çš„åŸå§‹è³‡æ–™
                int remainingLength = (int)(br.BaseStream.Length - br.BaseStream.Position);
                if (remainingLength > 0)
                {
                    s32Data.Layer5to8Data = br.ReadBytes(remainingLength);

                    // è§£æç¬¬5-8å±¤
                    using (var layerStream = new MemoryStream(s32Data.Layer5to8Data))
                    using (var layerReader = new BinaryReader(layerStream))
                    {
                        try
                        {
                            // ç¬¬äº”å±¤ - äº‹ä»¶
                            if (layerStream.Position + 4 <= layerStream.Length)
                            {
                                int lv5Count = layerReader.ReadInt32();
                                for (int i = 0; i < lv5Count && layerStream.Position + 5 <= layerStream.Length; i++)
                                {
                                    s32Data.Layer5.Add(new Layer5Item
                                    {
                                        X = layerReader.ReadByte(),
                                        Y = layerReader.ReadByte(),
                                        ObjectIndex = layerReader.ReadUInt16(),
                                        Type = layerReader.ReadByte()
                                    });
                                }
                            }

                            // ç¬¬å…­å±¤ - ä½¿ç”¨çš„ til
                            if (layerStream.Position + 4 <= layerStream.Length)
                            {
                                int lv6Count = layerReader.ReadInt32();
                                for (int i = 0; i < lv6Count && layerStream.Position + 4 <= layerStream.Length; i++)
                                {
                                    int til = layerReader.ReadInt32();
                                    s32Data.Layer6.Add(til);
                                }
                            }

                            // ç¬¬ä¸ƒå±¤ - å‚³é€é»ã€å…¥å£é»
                            if (layerStream.Position + 2 <= layerStream.Length)
                            {
                                int lv7Count = layerReader.ReadUInt16();
                                for (int i = 0; i < lv7Count && layerStream.Position + 1 <= layerStream.Length; i++)
                                {
                                    byte len = layerReader.ReadByte();
                                    if (layerStream.Position + len + 8 > layerStream.Length) break;

                                    string name = Encoding.Default.GetString(layerReader.ReadBytes(len));
                                    s32Data.Layer7.Add(new Layer7Item
                                    {
                                        Name = name,
                                        X = layerReader.ReadByte(),
                                        Y = layerReader.ReadByte(),
                                        TargetMapId = layerReader.ReadUInt16(),
                                        PortalId = layerReader.ReadInt32()
                                    });
                                }
                            }

                            // ç¬¬å…«å±¤ - ç‰¹æ•ˆã€è£é£¾å“
                            if (layerStream.Position + 2 <= layerStream.Length)
                            {
                                ushort lv8Num = layerReader.ReadUInt16();
                                bool hasExtendedData = (lv8Num >= 0x8000);
                                if (hasExtendedData)
                                {
                                    lv8Num = (ushort)(lv8Num & 0x7FFF);  // å–æ¶ˆé«˜ä½
                                }
                                s32Data.Layer8HasExtendedData = hasExtendedData;

                                int itemSize = hasExtendedData ? 10 : 6;  // 6 bytes åŸºæœ¬, +4 bytes æ“´å±•
                                for (int i = 0; i < lv8Num && layerStream.Position + itemSize <= layerStream.Length; i++)
                                {
                                    s32Data.Layer8.Add(new Layer8Item
                                    {
                                        SprId = layerReader.ReadUInt16(),
                                        X = layerReader.ReadUInt16(),
                                        Y = layerReader.ReadUInt16(),
                                        ExtendedData = hasExtendedData ? layerReader.ReadInt32() : 0
                                    });
                                }
                            }
                        }
                        catch (EndOfStreamException)
                        {
                            // å¿½ç•¥è®€å–è¶…å‡ºç¯„åœçš„éŒ¯èª¤
                        }
                    }
                }
                else
                {
                    s32Data.Layer5to8Data = new byte[0];
                }
            }

            return s32Data;
        }

        // è¼‰å…¥ä¸¦è§£æ s32 æª”æ¡ˆï¼ˆå¸¶ UI æ›´æ–°ï¼‰
        private void LoadAndParseS32File(string filePath)
        {
            try
            {
                // S32 æª”æ¡ˆå·²ç¶“åœ¨ LoadS32FileList() ä¸­è¼‰å…¥ï¼Œé€™è£¡åªæ›´æ–°UIé¡¯ç¤º
                if (!_document.S32Files.ContainsKey(filePath))
                {
                    this.toolStripStatusLabel1.Text = "é¸ä¸­çš„ S32 æª”æ¡ˆä¸åœ¨è¨˜æ†¶é«”ä¸­";
                    return;
                }

                S32Data s32Data = _document.S32Files[filePath];

                this.toolStripStatusLabel1.Text = $"å·²é¸æ“‡ {Path.GetFileName(filePath)} - ç¬¬1å±¤:{64*128}æ ¼, ç¬¬2å±¤:{s32Data.Layer2.Count}é …, ç¬¬3å±¤:{64*64}æ ¼, ç¬¬4å±¤:{s32Data.Layer4.Count}ç‰©ä»¶, æ­¤æª”æ¡ˆä½¿ç”¨{s32Data.UsedTiles.Count}ç¨®Tile";

                // æ³¨æ„ï¼šä¸éœ€è¦é‡æ–°æ¸²æŸ“åœ°åœ–ï¼Œå› ç‚ºæ•´å¼µåœ°åœ–å·²ç¶“åœ¨é¡¯ç¤ºäº†
                // å¦‚æœéœ€è¦é«˜äº®é¡¯ç¤ºç•¶å‰é¸ä¸­çš„ S32 å€åŸŸï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ 
            }
            catch (Exception ex)
            {
                MessageBox.Show($"é¡¯ç¤º s32 æª”æ¡ˆè³‡è¨Šå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // å±¤é¸æ“‡è®Šæ›´äº‹ä»¶
        private void S32Layer_CheckedChanged(object sender, EventArgs e)
        {
            // åŒæ­¥ ViewState
            if (sender == chkShowSafeZones)
            {
                _viewState.ShowSafeZones = chkShowSafeZones.Checked;
            }
            else if (sender == chkShowCombatZones)
            {
                _viewState.ShowCombatZones = chkShowCombatZones.Checked;
            }

            // åŒæ­¥åˆ°æµ®å‹•é¢æ¿çš„ CheckBoxï¼ˆé¿å…ç„¡é™éè¿´ï¼‰
            if (sender == chkLayer1 && chkFloatLayer1.Checked != chkLayer1.Checked)
            {
                chkFloatLayer1.Checked = chkLayer1.Checked;
            }
            else if (sender == chkLayer2 && chkFloatLayer2.Checked != chkLayer2.Checked)
            {
                chkFloatLayer2.Checked = chkLayer2.Checked;
            }
            else if (sender == chkLayer4 && chkFloatLayer4.Checked != chkLayer4.Checked)
            {
                chkFloatLayer4.Checked = chkLayer4.Checked;
            }
            else if (sender == chkShowPassable && chkFloatPassable.Checked != chkShowPassable.Checked)
            {
                chkFloatPassable.Checked = chkShowPassable.Checked;
            }
            else if (sender == chkShowGrid && chkFloatGrid.Checked != chkShowGrid.Checked)
            {
                chkFloatGrid.Checked = chkShowGrid.Checked;
            }
            else if (sender == chkShowS32Boundary && chkFloatS32Boundary.Checked != chkShowS32Boundary.Checked)
            {
                chkFloatS32Boundary.Checked = chkShowS32Boundary.Checked;
            }
            else if (sender == chkShowLayer5 && chkFloatLayer5.Checked != chkShowLayer5.Checked)
            {
                chkFloatLayer5.Checked = chkShowLayer5.Checked;
            }
            else if (sender == chkShowSafeZones && chkFloatSafeZones.Checked != chkShowSafeZones.Checked)
            {
                chkFloatSafeZones.Checked = chkShowSafeZones.Checked;
            }
            else if (sender == chkShowCombatZones && chkFloatCombatZones.Checked != chkShowCombatZones.Checked)
            {
                chkFloatCombatZones.Checked = chkShowCombatZones.Checked;
            }

            // æ›´æ–°åœ–ç¤ºé¡¯ç¤ºç‹€æ…‹
            UpdateLayerIconText();

            // æ¸…é™¤å¿«å–ï¼ˆå› ç‚ºå¿«å–çš„ bitmap æ˜¯ç”¨ç‰¹å®šåœ–å±¤è¨­å®šæ¸²æŸ“çš„ï¼‰
            ClearS32BlockCache();

            // ä½¿ç”¨é˜²æŠ–Timerï¼Œé¿å…å¿«é€Ÿåˆ‡æ›æ™‚å¤šæ¬¡æ¸²æŸ“
            renderDebounceTimer.Stop();
            renderDebounceTimer.Start();
        }


        // æµ®å‹•åœ–å±¤é¢æ¿é¸é …è®Šæ›´
        private void chkFloatLayer_CheckedChanged(object sender, EventArgs e)
        {
            // åŒæ­¥åˆ°åŸæœ¬çš„ CheckBoxï¼ˆæœƒè§¸ç™¼ S32Layer_CheckedChangedï¼‰
            if (sender == chkFloatLayer1)
            {
                chkLayer1.Checked = chkFloatLayer1.Checked;
            }
            else if (sender == chkFloatLayer2)
            {
                chkLayer2.Checked = chkFloatLayer2.Checked;
            }
            else if (sender == chkFloatLayer4)
            {
                chkLayer4.Checked = chkFloatLayer4.Checked;
            }
            else if (sender == chkFloatPassable)
            {
                chkShowPassable.Checked = chkFloatPassable.Checked;
            }
            else if (sender == chkFloatGrid)
            {
                chkShowGrid.Checked = chkFloatGrid.Checked;
            }
            else if (sender == chkFloatS32Boundary)
            {
                chkShowS32Boundary.Checked = chkFloatS32Boundary.Checked;
            }
            else if (sender == chkFloatLayer5)
            {
                chkShowLayer5.Checked = chkFloatLayer5.Checked;
            }
            else if (sender == chkFloatSafeZones)
            {
                chkShowSafeZones.Checked = chkFloatSafeZones.Checked;
            }
            else if (sender == chkFloatCombatZones)
            {
                chkShowCombatZones.Checked = chkFloatCombatZones.Checked;
            }
            else if (sender == chkFloatLayer8)
            {
                // Layer8 æ²’æœ‰å°æ‡‰çš„ä¸» CheckBoxï¼Œç›´æ¥æ›´æ–° ViewState
                _viewState.ShowLayer8 = chkFloatLayer8.Checked;
                // é‡æ–°æ¸²æŸ“åœ°åœ–
                RenderS32Map();
            }

            // æ›´æ–°åœ–ç¤ºé¡¯ç¤ºç‹€æ…‹
            UpdateLayerIconText();
        }

        // æ›´æ–°æµ®å‹•åœ–å±¤åœ–ç¤ºæ–‡å­—ï¼ˆé¡¯ç¤ºç›®å‰å•Ÿç”¨çš„å±¤ï¼‰
        private void UpdateLayerIconText()
        {
            // åœ–ç¤ºç”¨ä¸åŒé¡è‰²è¡¨ç¤ºç‹€æ…‹ - æ ¹æ“šå•Ÿç”¨å±¤æ•¸é‡
            int enabledCount = 0;
            if (chkFloatLayer1.Checked) enabledCount++;
            if (chkFloatLayer2.Checked) enabledCount++;
            if (chkFloatLayer4.Checked) enabledCount++;
            if (chkFloatPassable.Checked) enabledCount++;
            if (chkFloatGrid.Checked) enabledCount++;
            if (chkFloatS32Boundary.Checked) enabledCount++;
            if (chkFloatLayer5.Checked) enabledCount++;
            if (chkFloatSafeZones.Checked) enabledCount++;
            if (chkFloatCombatZones.Checked) enabledCount++;
            if (chkFloatLayer8.Checked) enabledCount++;

            if (enabledCount == 0)
            {
                lblLayerIcon.ForeColor = Color.Gray;
            }
            else if (enabledCount == 10)
            {
                lblLayerIcon.ForeColor = Color.LightGreen;
            }
            else
            {
                lblLayerIcon.ForeColor = Color.Yellow;
            }
        }

        // s32EditorPanel å¤§å°è®Šæ›´æ™‚èª¿æ•´æµ®å‹•é¢æ¿ä½ç½®
        private void s32EditorPanel_Resize(object sender, EventArgs e)
        {
            // å°‡æµ®å‹•é¢æ¿æ”¾åœ¨ s32MapPanel å€åŸŸçš„å³ä¸Šè§’ï¼ˆç›¸å°æ–¼ s32EditorPanelï¼‰
            int rightMargin = 10;
            int topMargin = 10;
            // s32MapPanel çš„èµ·é»æ˜¯ s32LayerControlPanel ä¸‹æ–¹
            int mapPanelTop = s32MapPanel.Top;
            int mapPanelRight = s32MapPanel.Right;
            layerFloatPanel.Location = new Point(mapPanelRight - layerFloatPanel.Width - rightMargin - 20, mapPanelTop + topMargin);
        }

        // åŒæ­¥æµ®å‹•é¢æ¿èˆ‡åŸæœ¬ CheckBox çš„ç‹€æ…‹
        private void SyncFloatPanelCheckboxes()
        {
            chkFloatLayer1.Checked = chkLayer1.Checked;
            chkFloatLayer2.Checked = chkLayer2.Checked;
            chkFloatLayer4.Checked = chkLayer4.Checked;
            chkFloatPassable.Checked = chkShowPassable.Checked;
            chkFloatGrid.Checked = chkShowGrid.Checked;
            chkFloatS32Boundary.Checked = chkShowS32Boundary.Checked;
            chkFloatLayer5.Checked = chkShowLayer5.Checked;
            chkFloatSafeZones.Checked = chkShowSafeZones.Checked;
            chkFloatCombatZones.Checked = chkShowCombatZones.Checked;
            UpdateLayerIconText();
        }

        // è¤‡è£½è¨­å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnCopySettings_Click(object sender, EventArgs e)
        {
            using (var dialog = new CopySettingsDialog(copySettingLayer1, copySettingLayer2, copySettingLayer3, copySettingLayer4, copySettingLayer5, copySettingLayer6to8))
            {
                if (dialog.ShowDialog(this) == DialogResult.OK)
                {
                    copySettingLayer1 = dialog.CopyLayer1;
                    copySettingLayer2 = dialog.CopyLayer2;
                    copySettingLayer3 = dialog.CopyLayer3;
                    copySettingLayer4 = dialog.CopyLayer4;
                    copySettingLayer5 = dialog.CopyLayer5;
                    copySettingLayer6to8 = dialog.CopyLayer6to8;

                    // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºç›®å‰è¨­å®š
                    var layers = new List<string>();
                    if (copySettingLayer1) layers.Add("L1");
                    if (copySettingLayer2) layers.Add("L2");
                    if (copySettingLayer3) layers.Add("L3");
                    if (copySettingLayer4) layers.Add("L4");
                    if (copySettingLayer5) layers.Add("L5");
                    if (copySettingLayer6to8) layers.Add("L6-8");
                    string layerInfo = layers.Count > 0 ? string.Join(",", layers) : "ç„¡";

                    this.toolStripStatusLabel1.Text = $"è¤‡è£½/åˆªé™¤è¨­å®šå·²æ›´æ–°: {layerInfo}";
                }
            }
        }

        // è¤‡è£½åœ°åœ–åº§æ¨™æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnCopyMapCoords_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // å–å¾—åœ°åœ–çš„éŠæˆ²åº§æ¨™ç¯„åœ
            int startX = currentMap.nLinBeginX;
            int endX = currentMap.nLinEndX;
            int startY = currentMap.nLinBeginY;
            int endY = currentMap.nLinEndY;

            // æ ¼å¼åŒ–ç‚º SQL UPDATE èªå¥
            string coordText = $"UPDATE mapids SET startX={startX}, endX={endX}, startY={startY}, endY={endY} WHERE mapid = {_document.MapId}";

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            Clipboard.SetText(coordText);

            this.toolStripStatusLabel1.Text = $"å·²è¤‡è£½: {coordText}";
        }

        // åŒ¯å…¥åœ°åœ–åŒ…æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnImportFs32_Click(object sender, EventArgs e)
        {
            ImportFs32ToCurrentMap();
        }

        // å…è¨±é€šè¡ŒæŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnSetPassable_Click(object sender, EventArgs e)
        {
            if (currentPassableEditMode == PassableEditMode.SetPassable)
            {
                // å–æ¶ˆæ¨¡å¼
                currentPassableEditMode = PassableEditMode.None;
                btnSetPassable.BackColor = SystemColors.Control;
                this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆå…è¨±é€šè¡Œæ¨¡å¼";
                UpdatePassabilityHelpLabel();
            }
            else
            {
                // å•Ÿç”¨å…è¨±é€šè¡Œæ¨¡å¼
                currentPassableEditMode = PassableEditMode.SetPassable;
                btnSetPassable.BackColor = Color.LightGreen;
                btnSetImpassable.BackColor = SystemColors.Control;
                // å–æ¶ˆ Layer5 ç·¨è¼¯æ¨¡å¼
                _editState.IsLayer5EditMode = false;
                btnEditLayer5.BackColor = SystemColors.Control;
                UpdateLayer5HelpLabel();
                // è‡ªå‹•é¡¯ç¤ºé€šè¡Œæ€§è¦†è“‹å±¤
                EnsurePassabilityLayerVisible();
                this.toolStripStatusLabel1.Text = "å…è¨±é€šè¡Œæ¨¡å¼ï¼šé»æ“Šæ ¼å­è¨­å®š | Ctrl+å·¦éµç¹ªè£½å¤šé‚Šå½¢ï¼Œå³éµå®Œæˆ";
                UpdatePassabilityHelpLabel();
            }
        }

        // ç¦æ­¢é€šè¡ŒæŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnSetImpassable_Click(object sender, EventArgs e)
        {
            if (currentPassableEditMode == PassableEditMode.SetImpassable)
            {
                // å–æ¶ˆæ¨¡å¼
                currentPassableEditMode = PassableEditMode.None;
                btnSetImpassable.BackColor = SystemColors.Control;
                this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆç¦æ­¢é€šè¡Œæ¨¡å¼";
                UpdatePassabilityHelpLabel();
            }
            else
            {
                // å•Ÿç”¨ç¦æ­¢é€šè¡Œæ¨¡å¼
                currentPassableEditMode = PassableEditMode.SetImpassable;
                btnSetImpassable.BackColor = Color.LightCoral;
                btnSetPassable.BackColor = SystemColors.Control;
                // å–æ¶ˆ Layer5 ç·¨è¼¯æ¨¡å¼
                _editState.IsLayer5EditMode = false;
                btnEditLayer5.BackColor = SystemColors.Control;
                UpdateLayer5HelpLabel();
                // è‡ªå‹•é¡¯ç¤ºé€šè¡Œæ€§è¦†è“‹å±¤
                EnsurePassabilityLayerVisible();
                this.toolStripStatusLabel1.Text = "ç¦æ­¢é€šè¡Œæ¨¡å¼ï¼šé»æ“Šæ ¼å­è¨­å®š | Ctrl+å·¦éµç¹ªè£½å¤šé‚Šå½¢ï¼Œå³éµå®Œæˆ";
                UpdatePassabilityHelpLabel();
            }
        }

        // æˆ°é¬¥å€åŸŸè¨­ç½®æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnRegionEdit_Click(object sender, EventArgs e)
        {
            if (currentRegionEditMode == RegionEditMode.SetRegion)
            {
                // å–æ¶ˆå€åŸŸç·¨è¼¯æ¨¡å¼
                currentRegionEditMode = RegionEditMode.None;
                btnRegionEdit.BackColor = SystemColors.Control;
                this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆå€åŸŸè¨­ç½®æ¨¡å¼";
                UpdateRegionHelpLabel();
            }
            else
            {
                // å•Ÿç”¨å€åŸŸç·¨è¼¯æ¨¡å¼
                currentRegionEditMode = RegionEditMode.SetRegion;
                btnRegionEdit.BackColor = Color.LightBlue;
                // å–æ¶ˆå…¶ä»–ç·¨è¼¯æ¨¡å¼
                currentPassableEditMode = PassableEditMode.None;
                btnSetPassable.BackColor = SystemColors.Control;
                btnSetImpassable.BackColor = SystemColors.Control;
                UpdatePassabilityHelpLabel();
                _editState.IsLayer5EditMode = false;
                btnEditLayer5.BackColor = SystemColors.Control;
                UpdateLayer5HelpLabel();
                // è‡ªå‹•é¡¯ç¤ºå€åŸŸè¦†è“‹å±¤
                EnsureRegionsLayerVisible();
                this.toolStripStatusLabel1.Text = $"å€åŸŸè¨­ç½®æ¨¡å¼ ({GetRegionTypeName(currentRegionType)})ï¼šå·¦éµæ‹–æ›³é¸å–ï¼Œå³éµå¥—ç”¨ | 1=ä¸€èˆ¬ 2=å®‰å…¨ 3=æˆ°é¬¥";
                UpdateRegionHelpLabel();
            }
        }

        // ç¢ºä¿é€šè¡Œæ€§åœ–å±¤å¯è¦‹
        private void EnsurePassabilityLayerVisible()
        {
            if (!chkShowPassable.Checked)
            {
                chkShowPassable.Checked = true;
                chkFloatPassable.Checked = true;
                UpdateLayerIconText();
                RenderS32Map();
            }
        }

        // ç¢ºä¿å€åŸŸè¦†è“‹å±¤å¯è¦‹
        private void EnsureRegionsLayerVisible()
        {
            bool needRender = false;
            if (!chkShowSafeZones.Checked)
            {
                chkShowSafeZones.Checked = true;
                chkFloatSafeZones.Checked = true;
                needRender = true;
            }
            if (!chkShowCombatZones.Checked)
            {
                chkShowCombatZones.Checked = true;
                chkFloatCombatZones.Checked = true;
                needRender = true;
            }
            if (needRender)
            {
                UpdateLayerIconText();
                RenderS32Map();
            }
        }

        // å–å¾—å€åŸŸé¡å‹åç¨±
        private string GetRegionTypeName(RegionType regionType)
        {
            switch (regionType)
            {
                case RegionType.Normal:
                    return "ä¸€èˆ¬å€åŸŸ";
                case RegionType.Safe:
                    return "å®‰å…¨å€åŸŸ";
                case RegionType.Combat:
                    return "æˆ°é¬¥å€åŸŸ";
                default:
                    return "æœªçŸ¥";
            }
        }

        // å–å¾—å€åŸŸé¡å‹é¡è‰²
        private Color GetRegionTypeColor(RegionType regionType)
        {
            switch (regionType)
            {
                case RegionType.Normal:
                    return Color.LightGreen;
                case RegionType.Safe:
                    return Color.LightBlue;
                case RegionType.Combat:
                    return Color.Orange;
                default:
                    return Color.Gray;
            }
        }

        // æª¢æ¸¬æ ¼å­çš„å€åŸŸé¡å‹
        private RegionType GetCellRegionType(S32Data s32Data, int cellX, int cellY)
        {
            // è¨ˆç®—ç¬¬ä¸‰å±¤åº§æ¨™
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;

            if (s32Data.Layer3[cellY, layer3X] == null)
                return RegionType.Normal;

            var attr = s32Data.Layer3[cellY, layer3X];

            // æ ¹æ“š MapTool é‚è¼¯æª¢æŸ¥å€åŸŸé¡å‹
            // ä½4ä½: 0-3=ä¸€èˆ¬, 4-7/C-F=å®‰å…¨(bit2), 8-B=æˆ°é¬¥(bit3ä¸”ébit2)
            int val1 = attr.Attribute1 & 0x0F;
            int val2 = attr.Attribute2 & 0x0F;

            bool isSafe = (val1 & 0x04) != 0 || (val2 & 0x04) != 0;
            bool isCombat = (val1 & 0x0C) == 0x08 || (val2 & 0x0C) == 0x08;

            if (isCombat) return RegionType.Combat;
            if (isSafe) return RegionType.Safe;
            return RegionType.Normal;
        }

        // è¨­å®šæ ¼å­çš„å€åŸŸé¡å‹
        private void SetCellRegionType(S32Data s32Data, int cellX, int cellY, RegionType regionType)
        {
            // è¨ˆç®—ç¬¬ä¸‰å±¤åº§æ¨™
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;

            // è¨ˆç®—éŠæˆ²åº§æ¨™
            int gameX = s32Data.SegInfo.nLinBeginX + layer3X;
            int gameY = s32Data.SegInfo.nLinBeginY + cellY;

            // ç¢ºä¿å±¬æ€§å­˜åœ¨
            if (s32Data.Layer3[cellY, layer3X] == null)
            {
                s32Data.Layer3[cellY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
            }

            var attr = s32Data.Layer3[cellY, layer3X];

            // å…ˆæ¸…é™¤ç¾æœ‰çš„å€åŸŸæ¨™è¨˜ï¼ˆæ ¹æ“š MapTool é‚è¼¯ï¼Œæ¸…é™¤ bit 2 å’Œ bit 3ï¼‰
            attr.Attribute1 = (short)(attr.Attribute1 & ~0x0C); // æ¸…é™¤ 0x04 å’Œ 0x08 ä½å…ƒ
            attr.Attribute2 = (short)(attr.Attribute2 & ~0x0C); // æ¸…é™¤ 0x04 å’Œ 0x08 ä½å…ƒ

            // æ ¹æ“šå€åŸŸé¡å‹è¨­å®šæ¨™è¨˜ï¼ˆMapTool é‚è¼¯ï¼‰
            switch (regionType)
            {
                case RegionType.Safe:
                    attr.Attribute1 = (short)(attr.Attribute1 | 0x04); // è¨­å®š bit 2 = å®‰å…¨å€åŸŸ
                    attr.Attribute2 = (short)(attr.Attribute2 | 0x04);
                    this.toolStripStatusLabel1.Text = $"å·²è¨­å®š ({gameX},{gameY}) ç‚ºå®‰å…¨å€åŸŸ";
                    break;
                case RegionType.Combat:
                    attr.Attribute1 = (short)(attr.Attribute1 | 0x08); // è¨­å®š bit 3 = æˆ°é¬¥å€åŸŸ
                    attr.Attribute2 = (short)(attr.Attribute2 | 0x08);
                    this.toolStripStatusLabel1.Text = $"å·²è¨­å®š ({gameX},{gameY}) ç‚ºæˆ°é¬¥å€åŸŸ";
                    break;
                case RegionType.Normal:
                default:
                    // ä¸€èˆ¬å€åŸŸä¸éœ€è¦ç‰¹æ®Šæ¨™è¨˜ï¼ˆå·²åœ¨ä¸Šé¢æ¸…é™¤ï¼‰
                    this.toolStripStatusLabel1.Text = $"å·²è¨­å®š ({gameX},{gameY}) ç‚ºä¸€èˆ¬å€åŸŸ";
                    break;
            }

            s32Data.IsModified = true;
            ClearS32BlockCache();
            RenderS32Map();
        }

        // æ‰¹é‡è¨­å®šé¸å–å€åŸŸçš„å€åŸŸé¡å‹
        private void SetSelectedCellsRegionType(RegionType regionType)
        {
            if (_editState.SelectedCells.Count == 0) return;

            int count = 0;
            HashSet<S32Data> modifiedS32s = new HashSet<S32Data>();

            // å»ºç«‹ Undo è¨˜éŒ„
            var undoAction = new UndoAction
            {
                Description = $"è¨­å®š {_editState.SelectedCells.Count} å€‹æ ¼å­ç‚º{GetRegionTypeName(regionType)}"
            };

            foreach (var cell in _editState.SelectedCells)
            {
                if (cell.S32Data == null) continue;

                int layer3X = cell.LocalX / 2;
                if (layer3X >= 64) layer3X = 63;

                // ç¢ºä¿å±¬æ€§å­˜åœ¨
                if (cell.S32Data.Layer3[cell.LocalY, layer3X] == null)
                {
                    cell.S32Data.Layer3[cell.LocalY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                }

                var attr = cell.S32Data.Layer3[cell.LocalY, layer3X];

                // è¨˜éŒ„èˆŠå€¼
                short oldAttr1 = attr.Attribute1;
                short oldAttr2 = attr.Attribute2;

                // æ¸…é™¤ç¾æœ‰çš„å€åŸŸæ¨™è¨˜ï¼ˆMapTool é‚è¼¯ï¼‰
                attr.Attribute1 = (short)(attr.Attribute1 & ~0x0C);
                attr.Attribute2 = (short)(attr.Attribute2 & ~0x0C);

                // è¨­å®šæ–°çš„å€åŸŸæ¨™è¨˜ï¼ˆMapTool é‚è¼¯ï¼‰
                switch (regionType)
                {
                    case RegionType.Safe:
                        attr.Attribute1 = (short)(attr.Attribute1 | 0x04);
                        attr.Attribute2 = (short)(attr.Attribute2 | 0x04);
                        break;
                    case RegionType.Combat:
                        attr.Attribute1 = (short)(attr.Attribute1 | 0x08);
                        attr.Attribute2 = (short)(attr.Attribute2 | 0x08);
                        break;
                }

                // è¨˜éŒ„åˆ° Undo
                undoAction.ModifiedLayer3.Add(new UndoLayer3Info
                {
                    S32FilePath = cell.S32Data.FilePath,
                    LocalX = layer3X,
                    LocalY = cell.LocalY,
                    OldAttribute1 = oldAttr1,
                    OldAttribute2 = oldAttr2,
                    NewAttribute1 = attr.Attribute1,
                    NewAttribute2 = attr.Attribute2
                });

                cell.S32Data.IsModified = true;
                modifiedS32s.Add(cell.S32Data);
                count++;
            }

            // å„²å­˜ Undo è¨˜éŒ„
            if (undoAction.ModifiedLayer3.Count > 0)
            {
                PushUndoAction(undoAction);
            }

            this.toolStripStatusLabel1.Text = $"å·²å°‡ {count} å€‹æ ¼å­è¨­å®šç‚º{GetRegionTypeName(regionType)} (Ctrl+Z å¯é‚„åŸ)";

            // æ¸…é™¤é¸å–å€åŸŸ
            _editState.SelectedCells.Clear();

            ClearS32BlockCache();
            RenderS32Map();
        }

        // é€æ˜ç·¨è¼¯æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnEditLayer5_Click(object sender, EventArgs e)
        {
            if (_editState.IsLayer5EditMode)
            {
                // å–æ¶ˆæ¨¡å¼
                _editState.IsLayer5EditMode = false;
                btnEditLayer5.BackColor = SystemColors.Control;
                this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆé€æ˜ç·¨è¼¯æ¨¡å¼";
                UpdateLayer5HelpLabel();
                RenderS32Map();  // é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤ç¾¤çµ„è¦†è“‹å±¤
            }
            else
            {
                // å•Ÿç”¨é€æ˜ç·¨è¼¯æ¨¡å¼
                _editState.IsLayer5EditMode = true;
                btnEditLayer5.BackColor = Color.FromArgb(100, 180, 255);
                // å–æ¶ˆé€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼
                currentPassableEditMode = PassableEditMode.None;
                btnSetPassable.BackColor = SystemColors.Control;
                btnSetImpassable.BackColor = SystemColors.Control;
                UpdatePassabilityHelpLabel();
                // è‡ªå‹•é¡¯ç¤º Layer5 è¦†è“‹å±¤
                EnsureLayer5Visible();
                this.toolStripStatusLabel1.Text = "é€æ˜ç·¨è¼¯æ¨¡å¼ï¼šå·¦éµæ·»åŠ /å³éµåˆªé™¤é€æ˜è¨­å®š";
                UpdateLayer5HelpLabel();
                RenderS32Map();  // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç¾¤çµ„è¦†è“‹å±¤
            }
        }

        // ç¢ºä¿ Layer5 åœ–å±¤å¯è¦‹
        private void EnsureLayer5Visible()
        {
            if (!chkShowLayer5.Checked)
            {
                chkShowLayer5.Checked = true;
                chkFloatLayer5.Checked = true;
                UpdateLayerIconText();
                RenderS32Map();
            }
        }

        // æ›´æ–° Layer5 ç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
        private void UpdateLayer5HelpLabel()
        {
            if (lblLayer5Help == null)
            {
                lblLayer5Help = new Label();
                lblLayer5Help.AutoSize = false;
                lblLayer5Help.Size = new Size(200, 80);
                lblLayer5Help.BackColor = Color.FromArgb(220, 30, 30, 50);
                lblLayer5Help.ForeColor = Color.FromArgb(100, 180, 255);
                lblLayer5Help.Font = new Font("Microsoft JhengHei", 9F, FontStyle.Regular);
                lblLayer5Help.Padding = new Padding(8);
                lblLayer5Help.BorderStyle = BorderStyle.FixedSingle;
                s32MapPanel.Controls.Add(lblLayer5Help);
            }

            if (!_editState.IsLayer5EditMode)
            {
                lblLayer5Help.Visible = false;
                UpdateDefaultHintVisibility();
                return;
            }

            lblLayer5Help.Text = "ã€é€æ˜ç·¨è¼¯æ¨¡å¼ã€‘\n" +
                                 "â€¢ å·¦éµï¼šæ·»åŠ é€æ˜è¨­å®š\n" +
                                 "â€¢ å³éµï¼šåˆªé™¤é€æ˜è¨­å®š\n" +
                                 "â€¢ å†æŒ‰æŒ‰éˆ•ï¼šå–æ¶ˆæ¨¡å¼";
            lblLayer5Help.Location = new Point(s32MapPanel.Width - lblLayer5Help.Width - 20, 200);
            lblLayer5Help.Visible = true;
            lblLayer5Help.BringToFront();
            lblDefaultHint.Visible = false;
        }

        // æ›´æ–°é€šè¡Œæ€§ç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
        private void UpdatePassabilityHelpLabel()
        {
            if (currentPassableEditMode == PassableEditMode.None)
            {
                lblPassabilityHelp.Visible = false;
                UpdateDefaultHintVisibility();
                return;
            }

            string modeText = currentPassableEditMode == PassableEditMode.SetPassable ? "å…è¨±é€šè¡Œ" : "ç¦æ­¢é€šè¡Œ";
            Color borderColor = currentPassableEditMode == PassableEditMode.SetPassable ? Color.LimeGreen : Color.Red;

            lblPassabilityHelp.Text = $"ã€{modeText}æ¨¡å¼ã€‘\n" +
                                      "â€¢ é»æ“Šæ ¼å­ï¼šè¨­å®šæ•´æ ¼é€šè¡Œæ€§\n" +
                                      "â€¢ Ctrl+å·¦éµï¼šæ–°å¢å¤šé‚Šå½¢é ‚é»\n" +
                                      "â€¢ å³éµï¼šå®Œæˆå¤šé‚Šå½¢ (â‰¥3é»)\n" +
                                      "â€¢ å†æŒ‰æŒ‰éˆ•ï¼šå–æ¶ˆæ¨¡å¼";
            lblPassabilityHelp.ForeColor = borderColor;
            lblPassabilityHelp.Visible = true;
            lblPassabilityHelp.BringToFront();
            lblDefaultHint.Visible = false;
        }

        // æ›´æ–°å€åŸŸç·¨è¼¯æ“ä½œèªªæ˜æ¨™ç±¤
        private void UpdateRegionHelpLabel()
        {
            if (currentRegionEditMode == RegionEditMode.None)
            {
                lblRegionHelp.Visible = false;
                btnRegionNormal.Visible = false;
                btnRegionSafe.Visible = false;
                btnRegionCombat.Visible = false;
                UpdateDefaultHintVisibility();
                return;
            }

            string regionTypeName = GetRegionTypeName(currentRegionType);
            Color regionColor = GetRegionTypeColor(currentRegionType);

            lblRegionHelp.Text = $"ã€å€åŸŸè¨­ç½®æ¨¡å¼ã€‘\n" +
                                 "â€¢ å·¦éµæ‹–æ›³é¸å–ï¼Œå³éµå¥—ç”¨\n" +
                                 "â€¢ å†æŒ‰æŒ‰éˆ•ï¼šå–æ¶ˆæ¨¡å¼";
            lblRegionHelp.ForeColor = regionColor;
            lblRegionHelp.Visible = true;
            lblRegionHelp.BringToFront();
            lblDefaultHint.Visible = false;

            // é¡¯ç¤ºå€åŸŸé¡å‹æŒ‰éˆ•ä¸¦æ›´æ–°ç‹€æ…‹
            btnRegionNormal.Visible = true;
            btnRegionSafe.Visible = true;
            btnRegionCombat.Visible = true;
            btnRegionNormal.BringToFront();
            btnRegionSafe.BringToFront();
            btnRegionCombat.BringToFront();

            // é«˜äº®ç•¶å‰é¸ä¸­çš„é¡å‹
            btnRegionNormal.BackColor = currentRegionType == RegionType.Normal ? Color.White : Color.FromArgb(80, 80, 80);
            btnRegionSafe.BackColor = currentRegionType == RegionType.Safe ? Color.FromArgb(0, 150, 255) : Color.FromArgb(60, 60, 80);
            btnRegionCombat.BackColor = currentRegionType == RegionType.Combat ? Color.FromArgb(180, 0, 255) : Color.FromArgb(70, 50, 80);

            btnRegionNormal.ForeColor = currentRegionType == RegionType.Normal ? Color.Black : Color.White;
            btnRegionSafe.ForeColor = Color.White;
            btnRegionCombat.ForeColor = Color.White;
        }

        // æ›´æ–°é è¨­æ“ä½œæç¤ºçš„é¡¯ç¤ºç‹€æ…‹
        private void UpdateDefaultHintVisibility()
        {
            // å¦‚æœæ²’æœ‰ä»»ä½•ç·¨è¼¯æ¨¡å¼å•Ÿå‹•ï¼Œé¡¯ç¤ºé è¨­æç¤º
            bool anyModeActive = currentPassableEditMode != PassableEditMode.None ||
                                 currentRegionEditMode != RegionEditMode.None ||
                                 _editState.IsLayer5EditMode;

            lblDefaultHint.Visible = !anyModeActive;
            if (lblDefaultHint.Visible)
            {
                lblDefaultHint.BringToFront();
            }
        }

        // é‡æ–°è¼‰å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void btnReloadMap_Click(object sender, EventArgs e)
        {
            ReloadCurrentMap();
        }

        // æ¸²æŸ“ S32 åœ°åœ–ï¼ˆViewport æ¸²æŸ“ - åªæ¸²æŸ“å¯è¦‹å€åŸŸï¼‰
        private void RenderS32Map()
        {
            try
            {
                if (_document.S32Files.Count == 0 || string.IsNullOrEmpty(_document.MapId))
                {
                    lblS32Info.Text = "è«‹é¸æ“‡ä¸€å€‹åœ°åœ–";
                    return;
                }

                if (!Share.MapDataList.ContainsKey(_document.MapId))
                {
                    lblS32Info.Text = "åœ°åœ–è³‡æ–™ä¸å­˜åœ¨";
                    return;
                }

                // æ¸…é™¤å°åœ°åœ–å¿«å–ï¼ˆviewport ç§»å‹•æ™‚éœ€è¦æ›´æ–°ç´…æ¡†ï¼‰
                // æ³¨æ„ï¼šS32 Block Cache ä¸åœ¨é€™è£¡æ¸…é™¤ï¼Œåªåœ¨åœ°åœ–åˆ‡æ›æˆ–ç·¨è¼¯æ™‚æ¸…é™¤


                Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

                // è¨ˆç®—æ•´å¼µåœ°åœ–çš„å¤§å°ï¼ˆä½¿ç”¨èˆ‡ L1MapHelper ç›¸åŒçš„å…¬å¼ï¼‰
                // æ¯å€‹ block çš„åƒç´ å¤§å°: BMP_W = 64 * 24 * 2 = 3072, BMP_H = 64 * 12 * 2 = 1536
                int blockWidth = 64 * 24 * 2;  // 3072
                int blockHeight = 64 * 12 * 2; // 1536

                // åœ°åœ–åƒç´ å¤§å°ï¼ˆèˆ‡ L1MapHelper.LoadMap ç›¸åŒï¼‰
                int mapWidth = currentMap.nBlockCountX * blockWidth;
                int mapHeight = currentMap.nBlockCountX * blockHeight / 2 + currentMap.nBlockCountY * blockHeight / 2;

                // æ›´æ–° ViewState çš„åœ°åœ–å¤§å°
                _viewState.MapWidth = mapWidth;
                _viewState.MapHeight = mapHeight;
                _viewState.ViewportWidth = s32MapPanel.Width;
                _viewState.ViewportHeight = s32MapPanel.Height;
                _viewState.ZoomLevel = s32ZoomLevel;

                // æ›´æ–°æ²å‹•é™åˆ¶ï¼ˆä¿ç•™ç¾æœ‰çš„æ²å‹•ä½ç½®ï¼ŒViewState.ScrollX/ScrollY æœƒåœ¨é™åˆ¶ç¯„åœå…§èª¿æ•´ï¼‰
                _viewState.UpdateScrollLimits(mapWidth, mapHeight);

                // å–å¾—éœ€è¦æ¸²æŸ“çš„ä¸–ç•Œåº§æ¨™ç¯„åœï¼ˆå«ç·©è¡å€ï¼‰
                Rectangle renderRect = _viewState.GetRenderWorldRect();
                LogPerf($"[RENDER-MAP] ScrollX={_viewState.ScrollX}, ScrollY={_viewState.ScrollY}, renderRect=({renderRect.X},{renderRect.Y},{renderRect.Width},{renderRect.Height})");

                // æ¸²æŸ“ Viewportï¼ˆä½¿ç”¨å¿«å–çš„å‹¾é¸æª”æ¡ˆæ¸…å–®ï¼‰
                RenderViewport(renderRect, currentMap, _checkedS32Files);

                // çµ±è¨ˆå‹¾é¸çš„ S32 æ•¸é‡å’Œç‰©ä»¶æ•¸é‡
                int checkedCount = _checkedS32Files.Count;
                int totalObjects = _document.S32Files.Values
                    .Where(s => _checkedS32Files.Contains(s.FilePath))
                    .Sum(s => s.Layer4.Count);

                lblS32Info.Text = $"å·²æ¸²æŸ“ {checkedCount}/{_document.S32Files.Count} å€‹S32æª”æ¡ˆ | åœ°åœ–: {mapWidth}x{mapHeight} | Viewport: {renderRect.Width}x{renderRect.Height} | ç¬¬1å±¤:{(chkLayer1.Checked ? "é¡¯ç¤º" : "éš±è—")} ç¬¬3å±¤:{(chkLayer3.Checked ? "é¡¯ç¤º" : "éš±è—")} ç¬¬4å±¤:{(chkLayer4.Checked ? "é¡¯ç¤º" : "éš±è—")} ({totalObjects}å€‹ç‰©ä»¶)";
            }
            catch (Exception ex)
            {
                lblS32Info.Text = $"æ¸²æŸ“å¤±æ•—: {ex.Message}";
            }
        }

        // Viewport æ¸²æŸ“å–æ¶ˆ token
        private System.Threading.CancellationTokenSource _viewportRenderCts = null;
        private readonly object _viewportRenderLock = new object();
        private volatile bool _isRendering = false;
        private volatile int _renderRequestId = 0;

        // æ¸²æŸ“æŒ‡å®šç¯„åœçš„ Viewportï¼ˆéåŒæ­¥èƒŒæ™¯æ¸²æŸ“ï¼‰
        private void RenderViewport(Rectangle worldRect, Struct.L1Map currentMap, HashSet<string> checkedFilePaths)
        {
            // å–æ¶ˆä¹‹å‰çš„æ¸²æŸ“ä»»å‹™
            int currentRequestId;
            lock (_viewportRenderLock)
            {
                if (_viewportRenderCts != null)
                {
                    _viewportRenderCts.Cancel();
                    _viewportRenderCts.Dispose();
                }
                _viewportRenderCts = new System.Threading.CancellationTokenSource();
                currentRequestId = ++_renderRequestId;
            }
            var cancellationToken = _viewportRenderCts.Token;

            // é å…ˆè®€å– UI ç‹€æ…‹ï¼ˆåœ¨ UI Threadï¼‰
            bool showLayer1 = chkLayer1.Checked;
            bool showLayer2 = chkLayer2.Checked;
            bool showLayer4 = chkLayer4.Checked;
            bool showLayer3 = chkLayer3.Checked;
            bool showPassable = chkShowPassable.Checked;
            bool showGrid = chkShowGrid.Checked;
            bool showS32Boundary = chkShowS32Boundary.Checked;
            bool showLayer5 = chkShowLayer5.Checked;
            bool isLayer5Edit = _editState.IsLayer5EditMode;
            bool hasHighlight = _editState.HighlightedS32Data != null && _editState.HighlightedCellX >= 0 && _editState.HighlightedCellY >= 0;
            int panelWidth = s32MapPanel.Width;
            int panelHeight = s32MapPanel.Height;

            // è¤‡è£½éœ€è¦çš„è³‡æ–™ï¼ˆé¿å…è·¨åŸ·è¡Œç·’å­˜å–ï¼‰
            var s32FilesSnapshot = _document.S32Files.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

            // MapViewerControl ä½¿ç”¨ Dock=Fillï¼Œä¸éœ€è¦æ‰‹å‹•è¨­å®šå¤§å°
            s32MapPanel.AutoScroll = false;

            // ä¸ä½¿ç”¨å¢é‡æ¸²æŸ“ï¼Œæ¯æ¬¡å®Œæ•´é‡æ–°æ¸²æŸ“ï¼ˆé¿å…å¤šåŸ·è¡Œç·’ bitmap å­˜å–å•é¡Œï¼‰

            // èƒŒæ™¯åŸ·è¡Œæ¸²æŸ“
            Task.Run(() =>
            {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¢«æ›´æ–°çš„è«‹æ±‚å–ä»£
                if (cancellationToken.IsCancellationRequested || currentRequestId != _renderRequestId)
                    return;

                // æ¨™è¨˜æ­£åœ¨æ¸²æŸ“
                _isRendering = true;
                var renderSw = Stopwatch.StartNew();
                LogPerf($"[RENDER-START] worldRect={worldRect.Width}x{worldRect.Height}");

                int blockWidth = 64 * 24 * 2;  // 3072
                int blockHeight = 64 * 12 * 2; // 1536

                // å‰µå»ºæ–°çš„ Viewport Bitmap
                var createBmpSw = Stopwatch.StartNew();
                Bitmap viewportBitmap = new Bitmap(worldRect.Width, worldRect.Height, PixelFormat.Format16bppRgb555);
                createBmpSw.Stop();
                long createBmpMs = createBmpSw.ElapsedMilliseconds;
                HashSet<string> newRenderedBlocks = new HashSet<string>();
                int renderedCount = 0;
                int skippedCount = 0;
                long totalGetBlockMs = 0;
                long totalDrawImageMs = 0;

                // ä½¿ç”¨ç©ºé–“ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾èˆ‡ worldRect ç›¸äº¤çš„ S32 æª”æ¡ˆ
                var candidateFiles = GetS32FilesInRect(worldRect);
                LogPerf($"[SPATIAL-QUERY] worldRect=({worldRect.X},{worldRect.Y},{worldRect.Width},{worldRect.Height}), candidates={candidateFiles.Count}, total={s32FilesSnapshot.Count}");

                // ä½¿ç”¨èˆ‡åŸå§‹ L1MapHelper.LoadMap å®Œå…¨ç›¸åŒçš„æ’åºæ–¹å¼ï¼ˆUtils.SortDescï¼‰
                var sortedFilePaths = Utils.SortDesc(candidateFiles.ToList());

                // 1. ç¯©é¸éœ€è¦æ¸²æŸ“çš„å€å¡Š
                var blocksToRender = new List<(S32Data s32Data, string filePath, int drawX, int drawY)>();
                foreach (object filePathObj in sortedFilePaths)
                {
                    string filePath = filePathObj as string;
                    if (filePath == null || !s32FilesSnapshot.ContainsKey(filePath)) continue;
                    if (!checkedFilePaths.Contains(filePath)) continue;

                    var s32Data = s32FilesSnapshot[filePath];
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    Rectangle blockRect = new Rectangle(mx, my, blockWidth, blockHeight);
                    if (!blockRect.IntersectsWith(worldRect))
                    {
                        skippedCount++;
                        continue;
                    }

                    int drawX = mx - worldRect.X;
                    int drawY = my - worldRect.Y;
                    blocksToRender.Add((s32Data, filePath, drawX, drawY));
                    newRenderedBlocks.Add(filePath);
                }

                // æª¢æŸ¥å–æ¶ˆ
                if (cancellationToken.IsCancellationRequested)
                {
                    LogPerf($"[RENDER-CANCELLED] before parallel render");
                    _isRendering = false;
                    viewportBitmap.Dispose();
                    LogPerf($"[RENDER-VIEWMAP DISPOSED]");

                    return;
                }

                // 2. æ”¶é›†æ‰€æœ‰ Layer ç‰©ä»¶ä¸¦è¨ˆç®—çµ•å°åƒç´ ä½ç½®ï¼ˆå…¨åŸŸ Layer æ’åºï¼‰
                var getBlockSw = Stopwatch.StartNew();
                var allTiles = new List<(int pixelX, int pixelY, int layer, int tileId, int indexId)>();

                foreach (var (s32Data, filePath, offsetX, offsetY) in blocksToRender)
                {
                    // Layer 1 (åœ°æ¿) - layer å€¼è¨­ç‚º -2 ç¢ºä¿æœ€å…ˆç¹ªè£½
                    if (showLayer1)
                    {
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell != null && cell.TileId >= 0)
                                {
                                    int halfX = x / 2;
                                    int baseX = -24 * halfX;
                                    int baseY = 63 * 12 - 12 * halfX;
                                    int pixelX = offsetX + baseX + x * 24 + y * 24;
                                    int pixelY = offsetY + baseY + y * 12;

                                    allTiles.Add((pixelX, pixelY, -2, cell.TileId, cell.IndexId));
                                }
                            }
                        }
                    }

                    // Layer 2 - layer å€¼è¨­ç‚º -1 ç¢ºä¿åœ¨ Layer1 ä¹‹å¾Œã€Layer4 ä¹‹å‰ç¹ªè£½
                    if (showLayer2)
                    {
                        foreach (var item in s32Data.Layer2)
                        {
                            if (item.TileId > 0)
                            {
                                int x = item.X;
                                int y = item.Y;
                                int halfX = x / 2;
                                int baseX = -24 * halfX;
                                int baseY = 63 * 12 - 12 * halfX;
                                int pixelX = offsetX + baseX + x * 24 + y * 24;
                                int pixelY = offsetY + baseY + y * 12;

                                allTiles.Add((pixelX, pixelY, -1, item.TileId, item.IndexId));
                            }
                        }
                    }

                    // Layer 4 (ç‰©ä»¶) - ä½¿ç”¨åŸå§‹ Layer å€¼
                    if (showLayer4)
                    {
                        foreach (var obj in s32Data.Layer4)
                        {
                            int halfX = obj.X / 2;
                            int baseX = -24 * halfX;
                            int baseY = 63 * 12 - 12 * halfX;
                            int pixelX = offsetX + baseX + obj.X * 24 + obj.Y * 24;
                            int pixelY = offsetY + baseY + obj.Y * 12;

                            allTiles.Add((pixelX, pixelY, obj.Layer, obj.TileId, obj.IndexId));
                        }
                    }
                }
                getBlockSw.Stop();
                totalGetBlockMs = getBlockSw.ElapsedMilliseconds;
                renderedCount = blocksToRender.Count;

                // æª¢æŸ¥å–æ¶ˆ
                if (cancellationToken.IsCancellationRequested)
                {
                    LogPerf($"[RENDER-CANCELLED] after collecting tiles");
                    _isRendering = false;
                    viewportBitmap.Dispose();
                    return;
                }

                // 3. æŒ‰ Layer å…¨åŸŸæ’åºå¾Œç¹ªè£½
                var drawSw = Stopwatch.StartNew();
                var sortedTiles = allTiles.OrderBy(t => t.layer).ToList();

                Rectangle rect = new Rectangle(0, 0, viewportBitmap.Width, viewportBitmap.Height);
                BitmapData bmpData = viewportBitmap.LockBits(rect, ImageLockMode.ReadWrite, viewportBitmap.PixelFormat);
                int rowpix = bmpData.Stride;

                unsafe
                {
                    byte* ptr = (byte*)bmpData.Scan0;

                    foreach (var tile in sortedTiles)
                    {
                        DrawTilToBufferDirect(tile.pixelX, tile.pixelY, tile.tileId, tile.indexId,
                            rowpix, ptr, viewportBitmap.Width, viewportBitmap.Height);
                    }
                }

                viewportBitmap.UnlockBits(bmpData);
                drawSw.Stop();
                totalDrawImageMs = drawSw.ElapsedMilliseconds;
                renderSw.Stop();
                LogPerf($"[RENDER] total={renderSw.ElapsedMilliseconds}ms | createBmp={createBmpMs}ms, getBlock={totalGetBlockMs}ms, drawImage={totalDrawImageMs}ms | blocks={renderedCount}, cacheHit={_cacheHits}, cacheMiss={_cacheMisses}");
                _cacheHits = 0;
                _cacheMisses = 0;

                // æ›´æ–°å·²æ¸²æŸ“çš„ S32 æ¸…å–®
                lock (_renderedS32Blocks)
                {
                    _renderedS32Blocks.Clear();
                    foreach (var path in newRenderedBlocks)
                        _renderedS32Blocks.Add(path);
                }

                if (cancellationToken.IsCancellationRequested)
                {
                    viewportBitmap.Dispose();
                    return;
                }

                // ç¹ªè£½è¦†è“‹å±¤ï¼ˆéœ€è¦å‚³å…¥ä¸–ç•Œåº§æ¨™åç§»ï¼‰
                if (showLayer3)
                {
                    DrawLayer3AttributesViewport(viewportBitmap, currentMap, worldRect);
                }

                if (showPassable)
                {
                    DrawPassableOverlayViewport(viewportBitmap, currentMap, worldRect);
                }

                if (_viewState.ShowSafeZones || _viewState.ShowCombatZones)
                {
                    DrawRegionsOverlayViewport(viewportBitmap, currentMap, worldRect);
                }

                if (showGrid)
                {
                    DrawS32GridViewport(viewportBitmap, currentMap, worldRect);
                    DrawCoordinateLabelsViewport(viewportBitmap, currentMap, worldRect);
                }

                if (showS32Boundary)
                {
                    DrawS32BoundaryOnlyViewport(viewportBitmap, currentMap, worldRect);
                }

                if (showLayer5)
                {
                    DrawLayer5OverlayViewport(viewportBitmap, currentMap, worldRect, isLayer5Edit);
                }

                if (cancellationToken.IsCancellationRequested)
                {
                    viewportBitmap.Dispose();
                    return;
                }

                // å›åˆ° UI Thread æ›´æ–°
                LogPerf($"[RENDER-INVOKE] queuing BeginInvoke from thread {System.Threading.Thread.CurrentThread.ManagedThreadId}");
                try
                {
                    // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ Form é‚„å­˜åœ¨
                    if (this.IsDisposed || !this.IsHandleCreated)
                    {
                        _isRendering = false;
                        viewportBitmap.Dispose();
                        return;
                    }
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        var invokeSw = Stopwatch.StartNew();
                        LogPerf($"[RENDER-INVOKE] callback start");
                        _isRendering = false;  // æ¸²æŸ“å®Œæˆ

                        // å®‰å…¨æª¢æŸ¥
                        if (this.IsDisposed)
                        {
                            viewportBitmap.Dispose();
                            return;
                        }

                        if (cancellationToken.IsCancellationRequested)
                        {
                            viewportBitmap.Dispose();
                            LogPerf($"[RENDER-INVOKE] cancelled, total={invokeSw.ElapsedMilliseconds}ms");
                            return;
                        }

                        // å¦‚æœæœ‰é«˜äº®ï¼Œåœ¨ UI Thread ç¹ªè£½ï¼ˆå› ç‚ºéœ€è¦å­˜å– _editStateï¼‰
                        if (hasHighlight && _editState.HighlightedS32Data != null)
                        {
                            DrawHighlightedCellViewport(viewportBitmap, currentMap, worldRect);
                        }

                        // Layer8 æ¨™è¨˜å’Œ SPR å‹•ç•«çµ±ä¸€åœ¨ overlay ç¹ªè£½ï¼ˆPaintOverlay äº‹ä»¶ï¼‰
                        // é€™æ¨£ marker å’Œå‹•ç•«å¯ä»¥ä¸€èµ·æ›´æ–°ï¼Œä¸éœ€è¦ç­‰å®Œæ•´é‡ç¹ª

                        // ä¿å­˜æ¸²æŸ“çµæœå…ƒæ•¸æ“š
                        _viewState.SetRenderResult(worldRect.X, worldRect.Y, worldRect.Width, worldRect.Height, _viewState.ZoomLevel);
                        Console.WriteLine($"[MapForm.Render] SetRenderResult: origin=({worldRect.X},{worldRect.Y}), size=({worldRect.Width},{worldRect.Height}), zoom={_viewState.ZoomLevel}, ViewState.hashcode={_viewState.GetHashCode()}");

                        invokeSw.Stop();
                        LogPerf($"[RENDER-COMPLETE] size={viewportBitmap.Width}x{viewportBitmap.Height}, invokeTime={invokeSw.ElapsedMilliseconds}ms");

                        // å‚³é bitmap çµ¦ MapViewerControlï¼ˆMapViewerControl å–å¾—æ‰€æœ‰æ¬Šä¸¦è² è²¬ disposeï¼‰
                        _mapViewerControl.SetExternalBitmap(viewportBitmap);
                    });
                }
                catch
                {
                    _isRendering = false;  // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦é‡ç½®
                    viewportBitmap.Dispose();
                }
            });
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ä¸¦åŸ·è¡Œ
        private void CheckAndRerenderIfNeeded()
        {
            LogPerf($"[CHECK-RERENDER] start, s32Count={_document.S32Files.Count}, isDragging={isMainMapDragging}");

            if (_document.S32Files.Count == 0 || string.IsNullOrEmpty(_document.MapId))
                return;

            // æ‹–æ›³ä¸­ä¸é‡æ–°æ¸²æŸ“ï¼Œåªæ›´æ–°é¡¯ç¤º
            if (isMainMapDragging)
            {
                _mapViewerControl.Refresh();
                return;
            }

            // æ›´æ–°ç¸®æ”¾å’Œ Viewport å¤§å°åˆ° ViewState
            _viewState.ZoomLevel = s32ZoomLevel;
            _viewState.ViewportWidth = s32MapPanel.Width;
            _viewState.ViewportHeight = s32MapPanel.Height;
            // ScrollX/ScrollY å·²ç¶“åœ¨æ‹–æ›³æ™‚æ›´æ–°äº†ï¼Œé€™è£¡ä¸éœ€è¦å†è¨­å®š

            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
            bool needsRerender = _viewState.NeedsRerender();

            if (needsRerender)
            {
                LogPerf($"[RERENDER-TRIGGERED] ScrollX={_viewState.ScrollX}, ScrollY={_viewState.ScrollY}");
                RenderS32Map();
            }
            else
            {
                // åªéœ€è¦é‡ç¹ªï¼ˆä¸éœ€è¦é‡æ–°æ¸²æŸ“ï¼‰
                _mapViewerControl.Refresh();
            }
        }

        /// <summary>
        /// å–å¾—å¿«å–çš„ S32 Block æˆ–æ¸²æŸ“æ–°çš„ï¼ˆç”¨æ–¼ Viewport æ¸²æŸ“ï¼‰
        /// </summary>
        private int _cacheHits = 0;
        private int _cacheMisses = 0;

        private Bitmap GetOrRenderS32Block(S32Data s32Data, bool showLayer1, bool showLayer2, bool showLayer4)
        {
            // åªæœ‰ Layer1+Layer2+Layer4 éƒ½é–‹å•Ÿæ™‚æ‰ä½¿ç”¨å¿«å–
            if (showLayer1 && showLayer2 && showLayer4)
            {
                string cacheKey = s32Data.FilePath;
                if (_s32BlockCache.TryGetValue(cacheKey, out Bitmap cached))
                {
                    _cacheHits++;
                    return cached;
                }

                _cacheMisses++;
                // æ¸²æŸ“ä¸¦å¿«å–
                Bitmap rendered = RenderS32Block(s32Data, showLayer1, showLayer2, showLayer4);
                _s32BlockCache.TryAdd(cacheKey, rendered);
                return rendered;
            }

            // å…¶ä»–æƒ…æ³ç›´æ¥æ¸²æŸ“ï¼ˆä¸å¿«å–ï¼‰
            return RenderS32Block(s32Data, showLayer1, showLayer2, showLayer4);
        }

        /// <summary>
        /// åŒæ­¥ _checkedS32Files åˆ° _document.CheckedS32Filesï¼Œä¸¦æ›´æ–°åœ°åœ–å°ºå¯¸
        /// </summary>
        private void SyncCheckedS32FilesToDocument()
        {
            // åŒæ­¥ checked files
            _document.CheckedS32Files.Clear();
            foreach (var filePath in _checkedS32Files)
            {
                _document.CheckedS32Files.Add(filePath);
            }

            // åŒæ­¥åœ°åœ–å°ºå¯¸
            _document.SetMapPixelSize(_viewState.MapWidth, _viewState.MapHeight);
        }

        /// <summary>
        /// æ¸…é™¤ S32 Block å¿«å–ï¼ˆåœ°åœ–è®Šæ›´æˆ–ç·¨è¼¯æ™‚å‘¼å«ï¼‰
        /// </summary>
        private void ClearS32BlockCache()
        {
            foreach (var bmp in _s32BlockCache.Values)
            {
                bmp?.Dispose();
            }
            _s32BlockCache.Clear();
            lock (_renderedS32Blocks)
            {
                _renderedS32Blocks.Clear();
            }
            // æ³¨æ„ï¼šä¸é‡ç½® _viewState.RenderResultï¼Œè®“èˆŠçš„ viewport bitmap ç¹¼çºŒé¡¯ç¤º
            // ç›´åˆ°æ–°çš„æ¸²æŸ“å®Œæˆå¾Œç”± RenderViewport æ›´æ–°
        }

        /// <summary>
        /// æ¸…é™¤å–®å€‹ S32 Block çš„å¿«å–ï¼ˆç·¨è¼¯å¾Œå‘¼å«ï¼‰
        /// </summary>
        private void InvalidateS32BlockCache(string filePath)
        {
            if (_s32BlockCache.TryRemove(filePath, out Bitmap bmp))
            {
                bmp?.Dispose();
            }
            lock (_renderedS32Blocks)
            {
                _renderedS32Blocks.Remove(filePath);
            }
        }

        // æ¸²æŸ“å–®å€‹ S32 å€å¡Šç‚º bitmapï¼ˆèˆ‡ L1MapHelper.s32FileToBmp ç›¸åŒçš„æ–¹å¼ï¼‰
        private Bitmap RenderS32Block(S32Data s32Data, bool showLayer1, bool showLayer2, bool showLayer4)
        {
            int blockWidth = 64 * 24 * 2;  // 3072
            int blockHeight = 64 * 12 * 2; // 1536

            Bitmap result = new Bitmap(blockWidth, blockHeight, PixelFormat.Format16bppRgb555);

            Rectangle rect = new Rectangle(0, 0, result.Width, result.Height);
            BitmapData bmpData = result.LockBits(rect, ImageLockMode.ReadWrite, result.PixelFormat);
            int rowpix = bmpData.Stride;

            unsafe
            {
                byte* ptr = (byte*)bmpData.Scan0;

                // ç¬¬ä¸€å±¤ï¼ˆåœ°æ¿ï¼‰- èˆ‡ drawTilBlock å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—
                if (showLayer1)
                {
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId >= 0)
                            {
                                // èˆ‡ L1MapHelper.drawTilBlock å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—
                                int baseX = 0;
                                int baseY = 63 * 12;
                                baseX -= 24 * (x / 2);
                                baseY -= 12 * (x / 2);

                                int pixelX = baseX + x * 24 + y * 24;
                                int pixelY = baseY + y * 12;

                                DrawTilToBufferDirect(pixelX, pixelY, cell.TileId, cell.IndexId, rowpix, ptr, blockWidth, blockHeight);
                            }
                        }
                    }
                }

                // ç¬¬äºŒå±¤ - èˆ‡ç¬¬ä¸€å±¤æ¸²æŸ“æ–¹å¼ç›¸åŒ
                if (showLayer2)
                {
                    foreach (var item in s32Data.Layer2)
                    {
                        if (item.TileId > 0)
                        {
                            int x = item.X;
                            int y = item.Y;

                            int baseX = 0;
                            int baseY = 63 * 12;
                            baseX -= 24 * (x / 2);
                            baseY -= 12 * (x / 2);

                            int pixelX = baseX + x * 24 + y * 24;
                            int pixelY = baseY + y * 12;

                            DrawTilToBufferDirect(pixelX, pixelY, item.TileId, item.IndexId, rowpix, ptr, blockWidth, blockHeight);
                        }
                    }
                }

                // ç¬¬å››å±¤ï¼ˆç‰©ä»¶ï¼‰
                if (showLayer4)
                {
                    var sortedObjects = s32Data.Layer4.OrderBy(o => o.Layer).ToList();

                    foreach (var obj in sortedObjects)
                    {
                        int baseX = 0;
                        int baseY = 63 * 12;
                        baseX -= 24 * (obj.X / 2);
                        baseY -= 12 * (obj.X / 2);

                        int pixelX = baseX + obj.X * 24 + obj.Y * 24;
                        int pixelY = baseY + obj.Y * 12;

                        DrawTilToBufferDirect(pixelX, pixelY, obj.TileId, obj.IndexId, rowpix, ptr, blockWidth, blockHeight);
                    }
                }
            }

            result.UnlockBits(bmpData);
            return result;
        }

        // è¨­å®šåˆå§‹æ²å‹•ä½ç½®åˆ°åœ°åœ–ä¸­å¤®ï¼ˆä¸æ¸²æŸ“ï¼Œç”¨æ–¼è¼‰å…¥æ™‚å…ˆè¨­å®šä½ç½®ï¼‰
        private void SetInitialScrollToCenter(Struct.L1Map currentMap)
        {
            // è¨ˆç®—åœ°åœ–åƒç´ å¤§å°
            int blockWidth = 64 * 24 * 2;  // 3072
            int blockHeight = 64 * 12 * 2; // 1536
            int mapWidth = currentMap.nBlockCountX * blockWidth;
            int mapHeight = currentMap.nBlockCountX * blockHeight / 2 + currentMap.nBlockCountY * blockHeight / 2;

            // æ›´æ–° ViewStateï¼ˆRenderS32Map æœƒç”¨åˆ°ï¼‰
            _viewState.MapWidth = mapWidth;
            _viewState.MapHeight = mapHeight;
            _viewState.ViewportWidth = s32MapPanel.Width;
            _viewState.ViewportHeight = s32MapPanel.Height;
            _viewState.ZoomLevel = s32ZoomLevel;
            _viewState.UpdateScrollLimits(mapWidth, mapHeight);

            if (_document.S32Files.Count == 0)
            {
                _viewState.SetScrollSilent(0, 0);
                return;
            }

            // å–å¾—æ‰€æœ‰ S32 çš„éŠæˆ²åº§æ¨™ç¯„åœ
            int minGameX = int.MaxValue, minGameY = int.MaxValue;
            int maxGameX = int.MinValue, maxGameY = int.MinValue;
            foreach (var s32Data in _document.S32Files.Values)
            {
                int beginX = s32Data.SegInfo.nLinBeginX;
                int beginY = s32Data.SegInfo.nLinBeginY;
                int endX = beginX + 64;
                int endY = beginY + 64;

                minGameX = Math.Min(minGameX, beginX);
                minGameY = Math.Min(minGameY, beginY);
                maxGameX = Math.Max(maxGameX, endX);
                maxGameY = Math.Max(maxGameY, endY);
            }

            // è¨ˆç®—éŠæˆ²åº§æ¨™ä¸­å¿ƒé»
            int centerGameX = (minGameX + maxGameX) / 2;
            int centerGameY = (minGameY + maxGameY) / 2;

            LogPerf($"[SCROLL-CENTER] GameCoord range=({minGameX},{minGameY})-({maxGameX},{maxGameY}), center=({centerGameX},{centerGameY})");

            // ç›´æ¥è·³è½‰åˆ°éŠæˆ²åº§æ¨™ä¸­å¿ƒé»
            JumpToGameCoordinate(centerGameX, centerGameY);
        }

        // æ²å‹•åˆ°åœ°åœ–ä¸­å¤®ï¼ˆå«é‡æ–°æ¸²æŸ“ï¼‰
        private void ScrollToMapCenter()
        {
            int mapWidth = _viewState.MapWidth;
            int mapHeight = _viewState.MapHeight;

            if (mapWidth <= 0 || mapHeight <= 0)
                return;

            // è¨ˆç®—ä¸­å¤®ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
            int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);
            int centerX = mapWidth / 2 - viewportWidthWorld / 2;
            int centerY = mapHeight / 2 - viewportHeightWorld / 2;

            // é™åˆ¶åœ¨æœ‰æ•ˆç¯„åœå…§
            int maxScrollX = Math.Max(0, mapWidth - viewportWidthWorld);
            int maxScrollY = Math.Max(0, mapHeight - viewportHeightWorld);
            centerX = Math.Max(0, Math.Min(centerX, maxScrollX));
            centerY = Math.Max(0, Math.Min(centerY, maxScrollY));

            // è¨­å®š ViewState çš„æ²å‹•ä½ç½®
            _viewState.SetScrollSilent(centerX, centerY);

            // é‡æ–°æ¸²æŸ“ä¸¦æ›´æ–°å°åœ°åœ–
            CheckAndRerenderIfNeeded();
            UpdateMiniMap();
        }

        // ç¹ªè£½ç¬¬ä¸‰å±¤ï¼ˆåœ°åœ–å±¬æ€§ï¼‰- ç”¨é‚Šç·šé¡¯ç¤ºå±¬æ€§
        // Attribute1 = å·¦åŠé‚Š, Attribute2 = å³åŠé‚Š
        private void DrawLayer3Attributes(Bitmap bitmap, Struct.L1Map currentMap)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆ
                foreach (var s32Data in _document.S32Files.Values)
                {
                    // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    // Layer3 æ˜¯ 64x64ï¼Œæ¯å€‹ Layer3 æ ¼å­å°æ‡‰ Layer1 çš„ x*2 å’Œ x*2+1
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 64; x++)  // Layer3 åº§æ¨™ (0-63)
                        {
                            var attr = s32Data.Layer3[y, x];
                            if (attr == null) continue;

                            // åªæœ‰ç•¶å…©å€‹å±¬æ€§éƒ½ç‚º0æ™‚æ‰è·³é
                            if (attr.Attribute1 == 0 && attr.Attribute2 == 0) continue;

                            // ç¬¬3å±¤çš„ä¸€å€‹æ ¼å­å°æ‡‰ç¬¬1å±¤çš„å…©å€‹æ ¼å­ï¼ˆXæ–¹å‘ï¼‰
                            int x1 = x * 2;

                            // èˆ‡ drawTilBlock ç›¸åŒçš„åƒç´ è¨ˆç®—
                            int localBaseX = 0;
                            int localBaseY = 63 * 12;
                            localBaseX -= 24 * (x1 / 2);
                            localBaseY -= 12 * (x1 / 2);

                            int X = mx + localBaseX + x1 * 24 + y * 24;
                            int Y = my + localBaseY + y * 12;

                            // è±å½¢çš„å››å€‹é ‚é»
                            Point pTop = new Point(X + 24, Y + 0);
                            Point pRight = new Point(X + 48, Y + 12);
                            Point pBottom = new Point(X + 24, Y + 24);
                            Point pLeft = new Point(X + 0, Y + 12);
                            Point pCenter = new Point(X + 24, Y + 12);

                            // å·¦åŠé‚Š - ä½¿ç”¨ Attribute1
                            if (attr.Attribute1 != 0)
                            {
                                Color color1 = GetAttributeColor(attr.Attribute1);
                                using (Pen pen = new Pen(color1, 3))
                                {
                                    g.DrawLine(pen, pLeft, pTop);
                                    g.DrawLine(pen, pTop, pCenter);
                                    g.DrawLine(pen, pCenter, pBottom);
                                    g.DrawLine(pen, pBottom, pLeft);
                                }
                            }

                            // å³åŠé‚Š - ä½¿ç”¨ Attribute2
                            if (attr.Attribute2 != 0)
                            {
                                Color color2 = GetAttributeColor(attr.Attribute2);
                                using (Pen pen = new Pen(color2, 3))
                                {
                                    g.DrawLine(pen, pTop, pRight);
                                    g.DrawLine(pen, pRight, pBottom);
                                    g.DrawLine(pen, pBottom, pCenter);
                                    g.DrawLine(pen, pCenter, pTop);
                                }
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½é€šè¡Œæ€§è¦†è“‹å±¤ - ç”¨é‚Šç·šé¡¯ç¤ºå±¬æ€§
        // Attribute1 = å·¦ä¸Šé‚Šç·š, Attribute2 = å³ä¸Šé‚Šç·š
        // é¡è‰²åˆ†é¡ï¼ˆè€ƒæ…®çµ„åˆæƒ…æ³ï¼‰ï¼š
        //   ç´…è‰² = ä¸å¯é€šè¡Œ (0x01)
        //   æ·±ç´… = ä¸å¯é€šè¡Œ+å®‰å…¨å€ (0x01+0x02)
        //   æ©˜è‰² = ä¸å¯é€šè¡Œ+æˆ°é¬¥å€ (0x01+0x04)
        //   è—è‰² = å®‰å…¨å€ (0x02)
        //   é»ƒè‰² = æˆ°é¬¥å€ (0x04)
        //   ç¶ è‰² = å®‰å…¨å€+æˆ°é¬¥å€ (0x02+0x04)
        //   ç°è‰² = å…¶ä»–å±¬æ€§
        // ç¹ªè£½é€šè¡Œæ€§è¦†è“‹å±¤ - ç”¨é‚Šç·šé¡¯ç¤ºå¯é€šè¡Œ/ä¸å¯é€šè¡Œ
        // Attribute1 = å·¦åŠé‚Š, Attribute2 = å³åŠé‚Š
        private void DrawPassableOverlay(Bitmap bitmap, Struct.L1Map currentMap)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                // å®šç¾©ç•«ç­† - ä½¿ç”¨æ˜é¡¯å€åˆ†çš„é¡è‰² (ä¸é€æ˜é¿å…é‡ç–Šæ··è‰²)
                using (Pen penImpassable = new Pen(Color.FromArgb(255, 128, 0, 128), 3))  // ä¸å¯é€šè¡Œ - æ·±ç´«è‰²ç²—ç·š
                using (Pen penPassable = new Pen(Color.FromArgb(255, 50, 200, 255), 2))   // å¯é€šè¡Œ - å¤©è—è‰²
                {
                    // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆ
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        // ä½¿ç”¨ GetLoc è¨ˆç®—å€å¡Šä½ç½®
                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        // Layer3 æ˜¯ 64x64ï¼Œæ¯å€‹ Layer3 æ ¼å­å°æ‡‰ Layer1 çš„ x*2 å’Œ x*2+1
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 64; x++)  // Layer3 åº§æ¨™ (0-63)
                            {
                                var attr = s32Data.Layer3[y, x];
                                if (attr == null) continue;

                                // ç¬¬3å±¤çš„ä¸€å€‹æ ¼å­å°æ‡‰ç¬¬1å±¤çš„å…©å€‹æ ¼å­ï¼ˆXæ–¹å‘ï¼‰
                                int x1 = x * 2;

                                // ä½¿ç”¨ GetLoc + drawTilBlock å…¬å¼è¨ˆç®—åƒç´ ä½ç½®
                                int localBaseX = 0;
                                int localBaseY = 63 * 12;
                                localBaseX -= 24 * (x1 / 2);
                                localBaseY -= 12 * (x1 / 2);

                                int X = mx + localBaseX + x1 * 24 + y * 24;
                                int Y = my + localBaseY + y * 12;

                                // è±å½¢çš„å››å€‹é ‚é»
                                Point pTop = new Point(X + 24, Y + 0);
                                Point pRight = new Point(X + 48, Y + 12);
                                Point pBottom = new Point(X + 24, Y + 24);
                                Point pLeft = new Point(X + 0, Y + 12);
                                Point pCenter = new Point(X + 24, Y + 12);

                                // å·¦åŠé‚Š - ä½¿ç”¨ Attribute1 åˆ¤æ–·
                                Pen pen1 = (attr.Attribute1 & 0x01) != 0 ? penImpassable : penPassable;
                                g.DrawLine(pen1, pLeft, pTop);
                                g.DrawLine(pen1, pTop, pCenter);
                                g.DrawLine(pen1, pCenter, pBottom);
                                g.DrawLine(pen1, pBottom, pLeft);

                                // å³åŠé‚Š - ä½¿ç”¨ Attribute2 åˆ¤æ–·
                                Pen pen2 = (attr.Attribute2 & 0x01) != 0 ? penImpassable : penPassable;
                                g.DrawLine(pen2, pTop, pRight);
                                g.DrawLine(pen2, pRight, pBottom);
                                g.DrawLine(pen2, pBottom, pCenter);
                                g.DrawLine(pen2, pCenter, pTop);
                            }
                        }
                    }
                }
            }
        }
        
        // æ ¹æ“šå±¬æ€§å€¼å–å¾—å°æ‡‰çš„é¡è‰²ï¼ˆä¸åŒå€¼ = ä¸åŒé¡è‰²ï¼‰
        private Color GetAttributeColor(short attrValue)
        {
            return Color.FromArgb(230, 200, 200, 200);
            // æ ¹æ“šä¸åŒçš„å€¼è¿”å›ä¸åŒçš„é¡è‰²
            switch (attrValue)
            {
                case 0x0001: return Color.FromArgb(230, 255, 0, 0);       // ç´…è‰²
                case 0x0002: return Color.FromArgb(230, 0, 100, 255);     // è—è‰²
                case 0x0003: return Color.FromArgb(230, 180, 0, 180);     // ç´«è‰²
                case 0x0004: return Color.FromArgb(230, 255, 200, 0);     // é»ƒè‰²
                case 0x0005: return Color.FromArgb(230, 255, 100, 0);     // æ©˜è‰²
                case 0x0006: return Color.FromArgb(230, 0, 200, 100);     // ç¶ è‰²
                case 0x0007: return Color.FromArgb(230, 0, 200, 200);     // é’è‰²
                case 0x0008: return Color.FromArgb(230, 200, 100, 50);    // æ£•è‰²
                case 0x0009: return Color.FromArgb(230, 255, 150, 150);   // ç²‰ç´…
                case 0x000A: return Color.FromArgb(230, 150, 255, 150);   // æ·ºç¶ 
                case 0x000B: return Color.FromArgb(230, 150, 150, 255);   // æ·ºè—
                case 0x000C: return Color.FromArgb(230, 255, 255, 100);   // æ·ºé»ƒ
                case 0x000D: return Color.FromArgb(230, 255, 100, 255);   // æ´‹ç´…
                case 0x000E: return Color.FromArgb(230, 100, 255, 255);   // æ·ºé’
                case 0x000F: return Color.FromArgb(230, 200, 200, 200);   // æ·ºç°
                default:
                    // å°æ–¼å…¶ä»–å€¼ï¼Œæ ¹æ“šå€¼ç”Ÿæˆé¡è‰²
                    int r = (attrValue * 37) % 200 + 55;
                    int g = (attrValue * 73) % 200 + 55;
                    int b = (attrValue * 113) % 200 + 55;
                    return Color.FromArgb(230, r, g, b);
            }
        }

        // ç¹ªè£½é¸ä¸­æ ¼å­çš„é«˜äº®
        private void DrawHighlightedCell(Bitmap bitmap, Struct.L1Map currentMap)
        {
            if (_editState.HighlightedS32Data == null) return;

            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                // ä½¿ç”¨ GetLoc è¨ˆç®—å€å¡Šä½ç½®
                int[] loc = _editState.HighlightedS32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                // ä½¿ç”¨ GetLoc + drawTilBlock å…¬å¼è¨ˆç®—åƒç´ ä½ç½®
                int localBaseX = 0;
                int localBaseY = 63 * 12;
                localBaseX -= 24 * (_editState.HighlightedCellX / 2);
                localBaseY -= 12 * (_editState.HighlightedCellX / 2);

                int X = mx + localBaseX + _editState.HighlightedCellX * 24 + _editState.HighlightedCellY * 24;
                int Y = my + localBaseY + _editState.HighlightedCellY * 12;

                // è±å½¢çš„å››å€‹é ‚é»ï¼ˆ24x24 çš„è±å½¢ï¼‰
                Point p1 = new Point(X + 0, Y + 12);   // å·¦
                Point p2 = new Point(X + 12, Y + 0);   // ä¸Š
                Point p3 = new Point(X + 24, Y + 12);  // å³
                Point p4 = new Point(X + 12, Y + 24);  // ä¸‹

                // å¡«å……åŠé€æ˜é»ƒè‰²
                using (SolidBrush brush = new SolidBrush(Color.FromArgb(120, 255, 255, 0)))
                {
                    g.FillPolygon(brush, new Point[] { p1, p2, p3, p4 });
                }

                // ç¹ªè£½äº®é»ƒè‰²é‚Šæ¡†
                using (Pen pen = new Pen(Color.FromArgb(255, 255, 200, 0), 3))
                {
                    g.DrawPolygon(pen, new Point[] { p1, p2, p3, p4 });
                }
            }
        }

        // åªç¹ªè£½ S32 é‚Šç•Œæ¡†ï¼ˆç”¨æ–¼é™¤éŒ¯å°é½Šï¼‰ï¼Œå››å€‹è§’è½å…§å´é¡¯ç¤ºåº§æ¨™
        private void DrawS32BoundaryOnly(Bitmap bitmap, Struct.L1Map currentMap)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.ClearTypeGridFit;

                Font font = new Font("Arial", 9, FontStyle.Bold);
                Pen boundaryPen = new Pen(Color.Cyan, 2);

                foreach (var s32Data in _document.S32Files.Values)
                {
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    // ç”¨ Layer3 åº§æ¨™ç³»
                    // é‚Šç•Œæ¡†çš„å››å€‹è§’è½ç›´æ¥ç”¨ (x3, y) = (0,0), (64,0), (64,64), (0,64)
                    // é€™æ¨£ä¸‹ä¸€å€‹ S32 çš„ (0,0) å°±æœƒå’Œé€™å€‹ S32 çš„ (0,64) æˆ– (64,0) é‡ç–Š
                    Point[] corners = new Point[4];

                    int[][] cornerCoords = new int[][] {
                        new int[] { 0, 0 },    // å·¦ä¸Š
                        new int[] { 64, 0 },   // å³ä¸Š
                        new int[] { 64, 64 },  // å³ä¸‹
                        new int[] { 0, 64 }    // å·¦ä¸‹
                    };

                    for (int i = 0; i < 4; i++)
                    {
                        int x3 = cornerCoords[i][0];
                        int y = cornerCoords[i][1];
                        int x = x3 * 2;

                        int localBaseX = 0 - 24 * (x / 2);
                        int localBaseY = 63 * 12 - 12 * (x / 2);
                        int X = mx + localBaseX + x * 24 + y * 24;
                        int Y = my + localBaseY + y * 12;

                        // æ‰€æœ‰è§’è½éƒ½å–ã€Œä¸Šé ‚é»ã€ä½ç½®ï¼Œä¸¦å¾€å·¦ä¸‹ç§»ä¸€æ ¼ (-24, +12)
                        corners[i] = new Point(X, Y + 12);
                    }

                    // ç¹ªè£½é‚Šç•Œæ¡†
                    g.DrawLine(boundaryPen, corners[0], corners[1]);
                    g.DrawLine(boundaryPen, corners[1], corners[2]);
                    g.DrawLine(boundaryPen, corners[2], corners[3]);
                    g.DrawLine(boundaryPen, corners[3], corners[0]);

                    // åœ¨ä¸­å¿ƒé¡¯ç¤º GetLoc å€¼å’Œåº§æ¨™ç¯„åœ
                    int centerX = (corners[0].X + corners[2].X) / 2;
                    int centerY = (corners[0].Y + corners[2].Y) / 2;
                    string centerText = $"GetLoc({mx},{my})\n{s32Data.SegInfo.nLinBeginX},{s32Data.SegInfo.nLinBeginY}~{s32Data.SegInfo.nLinEndX},{s32Data.SegInfo.nLinEndY}";
                    using (SolidBrush cb = new SolidBrush(Color.FromArgb(200, Color.Black)))
                    using (SolidBrush ct = new SolidBrush(Color.Lime))
                    {
                        SizeF cs = g.MeasureString(centerText, font);
                        g.FillRectangle(cb, centerX - cs.Width/2 - 2, centerY - cs.Height/2 - 1, cs.Width + 4, cs.Height + 2);
                        g.DrawString(centerText, font, ct, centerX - cs.Width/2, centerY - cs.Height/2);
                    }

                    // å››å€‹è§’è½çš„éŠæˆ²åº§æ¨™
                    int bx = s32Data.SegInfo.nLinBeginX;
                    int by = s32Data.SegInfo.nLinBeginY;
                    int ex = s32Data.SegInfo.nLinEndX;
                    int ey = s32Data.SegInfo.nLinEndY;

                    // åœ¨å››å€‹è§’è½å…§å´ç¹ªè£½åº§æ¨™ï¼ˆåŒ…å«è¢å¹•åº§æ¨™ä»¥ä¾¿é™¤éŒ¯ï¼‰
                    using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(200, Color.Black)))
                    using (SolidBrush textBrush = new SolidBrush(Color.Yellow))
                    {
                        string[] texts = new string[] {
                            $"{bx},{by}\n({corners[0].X},{corners[0].Y})",   // å·¦ä¸Š
                            $"{ex},{by}\n({corners[1].X},{corners[1].Y})",   // å³ä¸Š
                            $"{ex},{ey}\n({corners[2].X},{corners[2].Y})",   // å³ä¸‹
                            $"{bx},{ey}\n({corners[3].X},{corners[3].Y})"    // å·¦ä¸‹
                        };

                        // åç§»é‡è®“æ–‡å­—åœ¨é‚Šç•Œå…§å´
                        int[][] offsets = new int[][] {
                            new int[] { 5, 5 },      // å·¦ä¸Šï¼šå¾€å³ä¸‹
                            new int[] { -90, 5 },    // å³ä¸Šï¼šå¾€å·¦ä¸‹
                            new int[] { -90, -35 },  // å³ä¸‹ï¼šå¾€å·¦ä¸Š
                            new int[] { 5, -35 }     // å·¦ä¸‹ï¼šå¾€å³ä¸Š
                        };

                        for (int i = 0; i < 4; i++)
                        {
                            SizeF size = g.MeasureString(texts[i], font);
                            int tx = corners[i].X + offsets[i][0];
                            int ty = corners[i].Y + offsets[i][1];
                            g.FillRectangle(bgBrush, tx - 2, ty - 1, size.Width + 4, size.Height + 2);
                            g.DrawString(texts[i], font, textBrush, tx, ty);
                        }
                    }
                }

                font.Dispose();
                boundaryPen.Dispose();
            }
        }

        // ç¹ªè£½ S32 æ ¼å­ç¶²æ ¼ç·š - åŸºæ–¼ Layer3 (64x64) ç¹ªè£½æ ¼ç·š
        // Layer3 çš„ä¸€å€‹æ ¼å­ = Layer1 çš„å…©å€‹æ ¼å­ (x*2, x*2+1)ï¼Œå½¢æˆä¸€å€‹å®Œæ•´çš„ç­‰è·è±å½¢
        private void DrawS32Grid(Bitmap bitmap, Struct.L1Map currentMap)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                using (Pen gridPen = new Pen(Color.FromArgb(100, Color.Red), 1)) // åŠé€æ˜ç´…è‰²
                {
                    // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆ
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        // ä½¿ç”¨èˆ‡ RenderS32Map ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        // ç¹ªè£½æ ¼ç·š - åŸºæ–¼ Layer3ï¼ˆæ¯å€‹æ ¼å­å°æ‡‰ Layer1 çš„ 2 å€‹æ ¼å­ï¼‰
                        // S32 è¦†è“‹ 128 å€‹ Layer1 X æ ¼å­ï¼Œå°æ‡‰ 64 å€‹ Layer3 X æ ¼å­
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x3 = 0; x3 < 64; x3++)  // Layer3 åº§æ¨™ (0-63)
                            {
                                // Layer3 åº§æ¨™è½‰ Layer1 åº§æ¨™ï¼ˆå–å¶æ•¸ xï¼‰
                                int x = x3 * 2;

                                // èˆ‡ drawTilBlock ç›¸åŒçš„åƒç´ è¨ˆç®—
                                int localBaseX = 0;
                                int localBaseY = 63 * 12;
                                localBaseX -= 24 * (x / 2);
                                localBaseY -= 12 * (x / 2);

                                int X = mx + localBaseX + x * 24 + y * 24;
                                int Y = my + localBaseY + y * 12;

                                // Layer3 è±å½¢çš„å››å€‹é ‚é»ï¼ˆ48x24ï¼Œè¦†è“‹å…©å€‹ Layer1 æ ¼å­ï¼‰
                                Point p1 = new Point(X, Y + 12);       // å·¦
                                Point p2 = new Point(X + 24, Y);       // ä¸Š
                                Point p3 = new Point(X + 48, Y + 12);  // å³
                                Point p4 = new Point(X + 24, Y + 24);  // ä¸‹

                                // ç¹ªè£½è±å½¢çš„å››æ¢é‚Š
                                g.DrawLine(gridPen, p1, p2);  // å·¦ä¸Šé‚Š
                                g.DrawLine(gridPen, p2, p3);  // å³ä¸Šé‚Š
                                g.DrawLine(gridPen, p3, p4);  // å³ä¸‹é‚Š
                                g.DrawLine(gridPen, p4, p1);  // å·¦ä¸‹é‚Š
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½åº§æ¨™æ¨™ç±¤ - æ¸²æŸ“æ•´å¼µåœ°åœ–çš„æ‰€æœ‰ S32
        private void DrawCoordinateLabels(Bitmap bitmap, Struct.L1Map currentMap)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.ClearTypeGridFit;

                Font font = new Font("Arial", 8, FontStyle.Bold);

                // æ¯éš” 10 æ ¼é¡¯ç¤ºä¸€æ¬¡åº§æ¨™ï¼ˆå¯èª¿æ•´é–“éš”ï¼‰
                int interval = 10;

                // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆ
                foreach (var s32Data in _document.S32Files.Values)
                {
                    // ä½¿ç”¨ GetLoc è¨ˆç®—å€å¡Šä½ç½®
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    for (int y = 0; y < 64; y += interval)
                    {
                        for (int x = 0; x < 128; x += interval)
                        {
                            // ä½¿ç”¨ GetLoc + drawTilBlock å…¬å¼è¨ˆç®—åƒç´ ä½ç½®
                            int localBaseX = 0;
                            int localBaseY = 63 * 12;
                            localBaseX -= 24 * (x / 2);
                            localBaseY -= 12 * (x / 2);

                            int X = mx + localBaseX + x * 24 + y * 24;
                            int Y = my + localBaseY + y * 12;

                            // è¨ˆç®—å¯¦éš›éŠæˆ²åº§æ¨™
                            int gameX = s32Data.SegInfo.nLinBeginX + x;
                            int gameY = s32Data.SegInfo.nLinBeginY + y;

                            // ç¹ªè£½åº§æ¨™æ–‡å­—
                            string coordText = $"{gameX},{gameY}";
                            SizeF textSize = g.MeasureString(coordText, font);

                            // ç¹ªè£½èƒŒæ™¯ï¼ˆåŠé€æ˜ç™½è‰²ï¼‰
                            int textX = X + 12 - (int)textSize.Width / 2;
                            int textY = Y + 12 - (int)textSize.Height / 2;

                            using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(180, Color.White)))
                            {
                                g.FillRectangle(bgBrush, textX - 2, textY - 1, textSize.Width + 4, textSize.Height + 2);
                            }

                            // ç¹ªè£½åº§æ¨™æ–‡å­—ï¼ˆè—è‰²ï¼‰
                            using (SolidBrush textBrush = new SolidBrush(Color.Blue))
                            {
                                g.DrawString(coordText, font, textBrush, textX, textY);
                            }
                        }
                    }
                }

                font.Dispose();
            }
        }

        #region Viewport ç‰ˆæœ¬çš„ç¹ªåœ–æ–¹æ³•

        // ç¹ªè£½ç¬¬ä¸‰å±¤å±¬æ€§ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        // æ ¹æ“šå®¢æˆ¶ç«¯é‚è¼¯ï¼Œæ•´å€‹æ ¼å­ä½¿ç”¨ Attribute1 åˆ¤æ–·
        private void DrawLayer3AttributesViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                foreach (var s32Data in _document.S32Files.Values)
                {
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 64; x++)
                        {
                            var attr = s32Data.Layer3[y, x];
                            if (attr == null) continue;
                            // åªæœ‰ç•¶å…©å€‹å±¬æ€§éƒ½ç‚º0æ™‚æ‰è·³é
                            if (attr.Attribute1 == 0 && attr.Attribute2 == 0) continue;

                            int x1 = x * 2;
                            int localBaseX = 0 - 24 * (x1 / 2);
                            int localBaseY = 63 * 12 - 12 * (x1 / 2);

                            int X = mx + localBaseX + x1 * 24 + y * 24 - worldRect.X;
                            int Y = my + localBaseY + y * 12 - worldRect.Y;

                            // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                            if (X + 48 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                                continue;

                            // è±å½¢çš„å››å€‹é ‚é»
                            Point pTop = new Point(X + 24, Y + 0);
                            Point pRight = new Point(X + 48, Y + 12);
                            Point pBottom = new Point(X + 24, Y + 24);
                            Point pLeft = new Point(X + 0, Y + 12);
                            Point pCenter = new Point(X + 24, Y + 12);

                            // å·¦åŠé‚Š - ä½¿ç”¨ Attribute1
                            if (attr.Attribute1 != 0)
                            {
                                Color color1 = GetAttributeColor(attr.Attribute1);
                                using (Pen pen = new Pen(color1, 3))
                                {
                                    g.DrawLine(pen, pLeft, pTop);
                                    g.DrawLine(pen, pTop, pCenter);
                                    g.DrawLine(pen, pCenter, pBottom);
                                    g.DrawLine(pen, pBottom, pLeft);
                                }
                            }

                            // å³åŠé‚Š - ä½¿ç”¨ Attribute2
                            if (attr.Attribute2 != 0)
                            {
                                Color color2 = GetAttributeColor(attr.Attribute2);
                                using (Pen pen = new Pen(color2, 3))
                                {
                                    g.DrawLine(pen, pTop, pRight);
                                    g.DrawLine(pen, pRight, pBottom);
                                    g.DrawLine(pen, pBottom, pCenter);
                                    g.DrawLine(pen, pCenter, pTop);
                                }
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½é€šè¡Œæ€§è¦†è“‹å±¤ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        // Attribute1 = å·¦åŠé‚Š, Attribute2 = å³åŠé‚Š
        private void DrawPassableOverlayViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                using (Pen penImpassable = new Pen(Color.FromArgb(255, 128, 0, 128), 3))
                using (Pen penPassable = new Pen(Color.FromArgb(255, 50, 200, 255), 2))
                {
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 64; x++)
                            {
                                var attr = s32Data.Layer3[y, x];
                                if (attr == null) continue;

                                int x1 = x * 2;
                                int localBaseX = 0 - 24 * (x1 / 2);
                                int localBaseY = 63 * 12 - 12 * (x1 / 2);

                                int X = mx + localBaseX + x1 * 24 + y * 24 - worldRect.X;
                                int Y = my + localBaseY + y * 12 - worldRect.Y;

                                // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                                if (X + 48 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                                    continue;

                                // è±å½¢çš„å››å€‹é ‚é»
                                Point pTop = new Point(X + 24, Y + 0);
                                Point pRight = new Point(X + 48, Y + 12);
                                Point pBottom = new Point(X + 24, Y + 24);
                                Point pLeft = new Point(X + 0, Y + 12);
                                Point pCenter = new Point(X + 24, Y + 12);

                                // å·¦åŠé‚Š - ä½¿ç”¨ Attribute1 åˆ¤æ–·
                                Pen pen1 = (attr.Attribute1 & 0x01) != 0 ? penImpassable : penPassable;
                                g.DrawLine(pen1, pLeft, pTop);
                                g.DrawLine(pen1, pTop, pCenter);
                                g.DrawLine(pen1, pCenter, pBottom);
                                g.DrawLine(pen1, pBottom, pLeft);

                                // å³åŠé‚Š - ä½¿ç”¨ Attribute2 åˆ¤æ–·
                                Pen pen2 = (attr.Attribute2 & 0x01) != 0 ? penImpassable : penPassable;
                                g.DrawLine(pen2, pTop, pRight);
                                g.DrawLine(pen2, pRight, pBottom);
                                g.DrawLine(pen2, pBottom, pCenter);
                                g.DrawLine(pen2, pCenter, pTop);
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½å€åŸŸè¦†è“‹å±¤ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        // Attribute1 = å·¦åŠé‚Š, Attribute2 = å³åŠé‚Šï¼ˆèˆ‡é€šè¡Œæ€§ç¹ªè£½ä¸€è‡´ï¼‰
        private void DrawRegionsOverlayViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            bool showSafe = _viewState.ShowSafeZones;
            bool showCombat = _viewState.ShowCombatZones;

            using (Graphics g = Graphics.FromImage(bitmap))
            {
                // å®šç¾©å€åŸŸé¡è‰²ï¼ˆåŠé€æ˜ï¼‰
                // å®‰å…¨å€ï¼šè—è‰²ï¼Œæˆ°é¬¥å€ï¼šç´…è‰²
                using (Brush safeBrush = new SolidBrush(Color.FromArgb(80, 0, 150, 255)))       // è—è‰²
                using (Brush combatBrush = new SolidBrush(Color.FromArgb(80, 255, 50, 50)))     // ç´…è‰²
                {
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 64; x++)
                            {
                                var attr = s32Data.Layer3[y, x];
                                if (attr == null) continue;

                                int x1 = x * 2;
                                int localBaseX = 0 - 24 * (x1 / 2);
                                int localBaseY = 63 * 12 - 12 * (x1 / 2);

                                int X = mx + localBaseX + x1 * 24 + y * 24 - worldRect.X;
                                int Y = my + localBaseY + y * 12 - worldRect.Y;

                                // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                                if (X + 48 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                                    continue;

                                // è±å½¢çš„å››å€‹é ‚é»
                                Point pTop = new Point(X + 24, Y + 0);
                                Point pRight = new Point(X + 48, Y + 12);
                                Point pBottom = new Point(X + 24, Y + 24);
                                Point pLeft = new Point(X + 0, Y + 12);

                                // æª¢æŸ¥å€åŸŸé¡å‹ï¼ˆæ ¹æ“š MapTool é‚è¼¯ï¼Œå®¢æˆ¶ç«¯åªç”¨ Attribute1 åˆ¤æ–·æ•´å€‹æ ¼å­ï¼‰
                                // ä½4ä½: 0-3=ä¸€èˆ¬, 4-7/C-F=å®‰å…¨(bit2), 8-B=æˆ°é¬¥(bit3ä¸”ébit2)
                                int val = attr.Attribute1 & 0x0F;
                                bool isSafe = (val & 0x04) != 0;  // bit 2 è¨­å®š = å®‰å…¨å€
                                bool isCombat = (val & 0x0C) == 0x08;  // bit 3 è¨­å®šä½† bit 2 æœªè¨­å®š = æˆ°é¬¥å€

                                // æ±ºå®šæ•´å€‹æ ¼å­çš„é¡è‰²
                                Brush regionBrush = null;
                                if (isCombat && showCombat)
                                    regionBrush = combatBrush;
                                else if (isSafe && showSafe)
                                    regionBrush = safeBrush;

                                if (regionBrush != null)
                                {
                                    // ç¹ªè£½æ•´å€‹è±å½¢
                                    Point[] diamond = new Point[] { pTop, pRight, pBottom, pLeft };
                                    g.FillPolygon(regionBrush, diamond);
                                }
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½ Layer5 è¦†è“‹å±¤ï¼ˆé€æ˜åœ–å¡Šæ¨™è¨˜ï¼‰
        private void DrawLayer5OverlayViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect, bool isLayer5Edit)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                // æ”¶é›†æ‰€æœ‰ Layer5 ä½ç½®ï¼ˆå»é‡ï¼‰
                var drawnPositions = new HashSet<(int mx, int my, int x, int y)>();

                // åŠé€æ˜è—è‰²å¡«å……å’Œé‚Šæ¡†
                using (SolidBrush fillBrush = new SolidBrush(Color.FromArgb(80, 60, 140, 255)))
                using (Pen borderPen = new Pen(Color.FromArgb(180, 80, 160, 255), 1.5f))
                using (Pen highlightPen = new Pen(Color.FromArgb(200, 150, 200, 255), 1f))
                {
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        if (s32Data.Layer5.Count == 0) continue;

                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        foreach (var item in s32Data.Layer5)
                        {
                            // åŒä½ç½®åªç•«ä¸€æ¬¡
                            var posKey = (mx, my, (int)item.X, (int)item.Y);
                            if (drawnPositions.Contains(posKey)) continue;
                            drawnPositions.Add(posKey);
                            // Layer5 çš„ X æ˜¯ 0-127ï¼ˆLayer1 åº§æ¨™ç³»ï¼‰ï¼ŒY æ˜¯ 0-63
                            // ç¹ªè£½åŠæ ¼å¤§å°çš„ä¸‰è§’å½¢ï¼ˆX åˆ‡åŠï¼‰
                            int x1 = item.X;  // 0-127
                            int y = item.Y;   // 0-63

                            int localBaseX = 0 - 24 * (x1 / 2);
                            int localBaseY = 63 * 12 - 12 * (x1 / 2);

                            int X = mx + localBaseX + x1 * 24 + y * 24 - worldRect.X;
                            int Y = my + localBaseY + y * 12 - worldRect.Y;

                            // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                            if (X + 24 < 0 || X > worldRect.Width || Y + 12 < 0 || Y > worldRect.Height)
                                continue;

                            // ç¹ªè£½åŠæ ¼ä¸‰è§’å½¢ï¼ˆæ ¹æ“š X å¥‡å¶æ±ºå®šå·¦åŠæˆ–å³åŠï¼‰
                            Point[] triangle;
                            if (x1 % 2 == 0)
                            {
                                // å¶æ•¸ Xï¼šå·¦åŠä¸‰è§’å½¢
                                Point pLeft = new Point(X + 0, Y + 12);
                                Point pTop = new Point(X + 24, Y + 0);
                                Point pBottom = new Point(X + 24, Y + 24);
                                triangle = new Point[] { pLeft, pTop, pBottom };

                                // å¡«å……
                                g.FillPolygon(fillBrush, triangle);
                                // é‚Šæ¡†ï¼ˆä¸Šäº®ä¸‹æš—ï¼‰
                                g.DrawLine(highlightPen, pLeft, pTop);
                                g.DrawLine(borderPen, pTop, pBottom);
                                g.DrawLine(borderPen, pBottom, pLeft);
                            }
                            else
                            {
                                // å¥‡æ•¸ Xï¼šå³åŠä¸‰è§’å½¢
                                Point pTop = new Point(X + 0, Y + 0);
                                Point pRight = new Point(X + 24, Y + 12);
                                Point pBottom = new Point(X + 0, Y + 24);
                                triangle = new Point[] { pTop, pRight, pBottom };

                                // å¡«å……
                                g.FillPolygon(fillBrush, triangle);
                                // é‚Šæ¡†ï¼ˆä¸Šäº®ä¸‹æš—ï¼‰
                                g.DrawLine(highlightPen, pTop, pRight);
                                g.DrawLine(borderPen, pRight, pBottom);
                                g.DrawLine(borderPen, pBottom, pTop);
                            }
                        }
                    }
                }

                // åœ¨é€æ˜ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œç¹ªè£½å·²è¨­å®š Layer5 çš„ç¾¤çµ„ç‰©ä»¶è¦†è“‹å±¤
                if (isLayer5Edit)
                {
                    DrawLayer5GroupOverlay(g, worldRect);
                }
            }
        }

        // ç¹ªè£½å·²è¨­å®š Layer5 çš„ç¾¤çµ„ç‰©ä»¶è¦†è“‹å±¤
        private void DrawLayer5GroupOverlay(Graphics g, Rectangle worldRect)
        {
            // åªæœ‰åœ¨æœ‰é¸å–æ ¼å­æ™‚æ‰é¡¯ç¤º
            if (_editState.SelectedCells.Count == 0) return;

            // å¾é¸å–çš„æ ¼å­æ”¶é›† Layer5 çš„ GroupId åŠå…¶ Type
            var groupLayer5Info = new Dictionary<int, byte>(); // GroupId -> Type
            foreach (var selectedCell in _editState.SelectedCells)
            {
                var s32Data = selectedCell.S32Data;
                int localX = selectedCell.LocalX;  // Layer1 åº§æ¨™ (0-127)
                int localY = selectedCell.LocalY;  // Layer3 åº§æ¨™ (0-63)

                // æŸ¥æ‰¾è©²æ ¼å­ä½ç½®å°æ‡‰çš„ Layer5 è¨­å®š
                // Layer5 çš„ X æ˜¯ 0-127ï¼ŒY æ˜¯ 0-63
                // selectedCell.LocalX æ˜¯ Layer1 åº§æ¨™ (0-127)ï¼ŒLocalY æ˜¯ (0-63)
                // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆlocalX å’Œ localX+1ï¼‰
                foreach (var item in s32Data.Layer5)
                {
                    if ((item.X == localX || item.X == localX + 1) && item.Y == localY)
                    {
                        // å¦‚æœåŒä¸€å€‹ GroupId æœ‰å¤šå€‹è¨­å®šï¼Œä¿ç•™ç¬¬ä¸€å€‹
                        if (!groupLayer5Info.ContainsKey(item.ObjectIndex))
                        {
                            groupLayer5Info[item.ObjectIndex] = item.Type;
                        }
                    }
                }
            }

            if (groupLayer5Info.Count == 0) return;

            // åŠé€æ˜è¦†è“‹è‰²ï¼šType=0 ç´«è‰²ï¼ˆé«˜å°æ¯”ï¼‰ï¼ŒType=1 ç´…è‰²
            using (SolidBrush type0Brush = new SolidBrush(Color.FromArgb(100, 180, 0, 255)))
            using (SolidBrush type1Brush = new SolidBrush(Color.FromArgb(100, 255, 80, 80)))
            {
                foreach (var s32Data in _document.S32Files.Values)
                {
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    foreach (var obj in s32Data.Layer4)
                    {
                        // æª¢æŸ¥è©²ç¾¤çµ„æ˜¯å¦æœ‰ Layer5 è¨­å®š
                        if (!groupLayer5Info.TryGetValue(obj.GroupId, out byte type))
                            continue;

                        // ä½¿ç”¨èˆ‡é«˜äº®æ ¼å­ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                        int x1 = obj.X;  // 0-127 (Layer1 åº§æ¨™ç³»)
                        int y = obj.Y;   // 0-63

                        int localBaseX = 0 - 24 * (x1 / 2);
                        int localBaseY = 63 * 12 - 12 * (x1 / 2);

                        int X = mx + localBaseX + x1 * 24 + y * 24 - worldRect.X;
                        int Y = my + localBaseY + y * 12 - worldRect.Y;

                        // è·³éä¸åœ¨ Viewport å…§çš„ç‰©ä»¶
                        if (X + 24 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                            continue;

                        // ç¹ªè£½åŠæ ¼è±å½¢è¦†è“‹ï¼ˆèˆ‡æ ¼å­é«˜äº®ç›¸åŒå¤§å°ï¼‰
                        SolidBrush brush = type == 0 ? type0Brush : type1Brush;
                        Point[] diamond = new Point[]
                        {
                            new Point(X + 0, Y + 12),   // å·¦
                            new Point(X + 12, Y + 0),   // ä¸Š
                            new Point(X + 24, Y + 12),  // å³
                            new Point(X + 12, Y + 24)   // ä¸‹
                        };
                        g.FillPolygon(brush, diamond);
                    }
                }
            }
        }

        // ç¹ªè£½é¸ä¸­æ ¼å­çš„é«˜äº®ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        private void DrawHighlightedCellViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            if (_editState.HighlightedS32Data == null) return;

            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                int[] loc = _editState.HighlightedS32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                int localBaseX = 0 - 24 * (_editState.HighlightedCellX / 2);
                int localBaseY = 63 * 12 - 12 * (_editState.HighlightedCellX / 2);

                int X = mx + localBaseX + _editState.HighlightedCellX * 24 + _editState.HighlightedCellY * 24 - worldRect.X;
                int Y = my + localBaseY + _editState.HighlightedCellY * 12 - worldRect.Y;

                Point p1 = new Point(X + 0, Y + 12);
                Point p2 = new Point(X + 12, Y + 0);
                Point p3 = new Point(X + 24, Y + 12);
                Point p4 = new Point(X + 12, Y + 24);

                using (SolidBrush brush = new SolidBrush(Color.FromArgb(120, 255, 255, 0)))
                {
                    g.FillPolygon(brush, new Point[] { p1, p2, p3, p4 });
                }

                using (Pen pen = new Pen(Color.FromArgb(255, 255, 200, 0), 3))
                {
                    g.DrawPolygon(pen, new Point[] { p1, p2, p3, p4 });
                }
            }
        }

        // ç¹ªè£½ Layer8 æ¨™è¨˜å’Œå•Ÿç”¨çš„ SPR å‹•ç•«
        private void DrawLayer8MarkersAndSprites(Bitmap bitmap, Rectangle worldRect)
        {
            int totalLayer8Count = 0;
            int drawnCount = 0;

            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

                // ç¹ªè£½æ‰€æœ‰ Layer8 é …ç›®çš„æ¨™è¨˜
                foreach (var s32Data in _document.S32Files.Values)
                {
                    totalLayer8Count += s32Data.Layer8.Count;
                    if (s32Data.Layer8.Count == 0) continue;

                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    for (int i = 0; i < s32Data.Layer8.Count; i++)
                    {
                        var item = s32Data.Layer8[i];

                        // Layer8 X,Y æ˜¯çµ•å°éŠæˆ²åº§æ¨™ï¼Œå…ˆè½‰ç‚ºæœ¬åœ°åº§æ¨™
                        int localLayer3X = item.X - s32Data.SegInfo.nLinBeginX;  // 0~63
                        int localLayer3Y = item.Y - s32Data.SegInfo.nLinBeginY;  // 0~63

                        // è·³éè¶…å‡ºç¯„åœçš„é …ç›®
                        if (localLayer3X < 0 || localLayer3X > 63 || localLayer3Y < 0 || localLayer3Y > 63)
                            continue;

                        // è½‰ç‚º Layer1 åº§æ¨™ä¸¦è¨ˆç®—ä¸–ç•Œåƒç´ åº§æ¨™
                        int layer1X = localLayer3X * 2;  // 0~127
                        int layer1Y = localLayer3Y;       // 0~63

                        int baseX = -24 * (layer1X / 2);
                        int baseY = 63 * 12 - 12 * (layer1X / 2);
                        int worldX = mx + baseX + layer1X * 24 + layer1Y * 24;
                        int worldY = my + baseY + layer1Y * 12;

                        // è½‰ç‚ºç•«å¸ƒåº§æ¨™ï¼ˆæ ¼å­ä¸­å¿ƒï¼‰
                        int x = worldX - worldRect.X + 12;
                        int y = worldY - worldRect.Y + 12;

                        // æª¢æŸ¥æ˜¯å¦åœ¨å¯è¦‹ç¯„åœå…§
                        if (x < -50 || x > bitmap.Width + 50 || y < -50 || y > bitmap.Height + 50)
                            continue;

                        bool isEnabled = _editState.EnabledLayer8Items.Contains((s32Data.FilePath, i));

                        // ç¹ªè£½æ¨™è¨˜ï¼ˆåœ“é»ï¼‰
                        // å•Ÿç”¨æ™‚ï¼šç°è‰²åŠé€æ˜ (opacity 0.1)ï¼Œåœ¨ SPR ä¸‹é¢
                        // åœç”¨æ™‚ï¼šæ©™è‰²å¯¦å¿ƒ
                        int markerRadius = 10;

                        if (isEnabled)
                        {
                            // å•Ÿç”¨ç‹€æ…‹ï¼šå…ˆç•«ç°è‰²åŠé€æ˜ marker
                            using (SolidBrush brush = new SolidBrush(Color.FromArgb(25, 128, 128, 128)))
                            {
                                g.FillEllipse(brush, x - markerRadius, y - markerRadius, markerRadius * 2, markerRadius * 2);
                            }
                            using (Pen pen = new Pen(Color.FromArgb(50, 255, 255, 255)))
                            {
                                g.DrawEllipse(pen, x - markerRadius, y - markerRadius, markerRadius * 2, markerRadius * 2);
                            }

                            // ç¹ªè£½ SPR å‹•ç•«ï¼ˆåœ¨ marker ä¸Šé¢ï¼‰
                            DrawLayer8Sprite(g, item.SprId, x, y, s32Data.FilePath, i);
                        }
                        else
                        {
                            // åœç”¨ç‹€æ…‹ï¼šæ©™è‰²å¯¦å¿ƒ marker
                            using (SolidBrush brush = new SolidBrush(Color.Orange))
                            {
                                g.FillEllipse(brush, x - markerRadius, y - markerRadius, markerRadius * 2, markerRadius * 2);
                            }
                            g.DrawEllipse(Pens.White, x - markerRadius, y - markerRadius, markerRadius * 2, markerRadius * 2);

                            // åªæœ‰åœç”¨ç‹€æ…‹æ‰é¡¯ç¤º SprId
                            using (Font font = new Font("Arial", 8, FontStyle.Bold))
                            {
                                g.DrawString(item.SprId.ToString(), font, Brushes.White, x + markerRadius + 2, y - 6);
                            }
                        }
                        drawnCount++;
                    }
                }
            }

            Console.WriteLine($"[Layer8] totalLayer8Count={totalLayer8Count}, drawnCount={drawnCount}, worldRect={worldRect}");
        }

        // ç¹ªè£½å–®å€‹ Layer8 SPR å‹•ç•«å¸§
        private void DrawLayer8Sprite(Graphics g, int sprId, int x, int y, string s32Path, int itemIndex)
        {
            // è¼‰å…¥ SPR å¸§ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥ï¼‰
            if (!_layer8SprCache.TryGetValue(sprId, out var frames))
            {
                frames = LoadLayer8SprFrames(sprId);
                _layer8SprCache[sprId] = frames;
            }

            if (frames == null || frames.Count == 0) return;

            // å–å¾—ç•¶å‰å¸§ç´¢å¼•
            var key = (s32Path, itemIndex);
            if (!_layer8AnimFrame.TryGetValue(key, out int frameIdx))
            {
                frameIdx = 0;
                _layer8AnimFrame[key] = 0;
            }

            Image frame = frames[frameIdx % frames.Count];

            // ç¹ªè£½ SPRï¼ˆç½®ä¸­æ–¼æ¨™è¨˜ä½ç½®ï¼‰
            g.DrawImage(frame, x - frame.Width / 2, y - frame.Height / 2);
        }

        // è¼‰å…¥ Layer8 SPR å¸§ï¼ˆæ”¯æ´å¤š idx æª”æ¡ˆï¼‰
        private List<Image> LoadLayer8SprFrames(int sprId)
        {
            string sprKey = $"{sprId}-0.spr";

            // ä¾åºå˜—è©¦ä¸åŒçš„ idx æª”æ¡ˆ
            string[] idxTypes = new[] {
                "Sprite",
                "Sprite00", "Sprite01", "Sprite02", "Sprite03",
                "Sprite04", "Sprite05", "Sprite06", "Sprite07",
                "Sprite08", "Sprite09", "Sprite10", "Sprite11",
                "Sprite12", "Sprite13", "Sprite14", "Sprite15"
            };

            foreach (var idxType in idxTypes)
            {
                try
                {
                    byte[] sprData = L1PakReader.UnPack(idxType, sprKey);
                    if (sprData != null && sprData.Length > 0)
                    {
                        var rawFrames = Lin.Helper.Core.Sprite.SprReader.LoadRaw(sprData);
                        if (rawFrames != null && rawFrames.Length > 0)
                        {
                            var result = new List<Image>();
                            foreach (var f in rawFrames)
                            {
                                if (f.Width > 0 && f.Height > 0 && f.Pixels != null)
                                {
                                    result.Add(CreateBitmapFromRgbaLayer8(f.Pixels, f.Width, f.Height));
                                }
                            }
                            if (result.Count > 0)
                                return result;
                        }
                    }
                }
                catch { }
            }

            return new List<Image>();  // æ‰¾ä¸åˆ°
        }

        // å°‡ RGBA åƒç´ è½‰æ›ç‚º BGRA ä¸¦å»ºç«‹ Bitmapï¼ˆLayer8 ç”¨ï¼‰
        private Bitmap CreateBitmapFromRgbaLayer8(byte[] rgbaPixels, int width, int height)
        {
            byte[] bgraPixels = new byte[rgbaPixels.Length];
            for (int i = 0; i < rgbaPixels.Length; i += 4)
            {
                bgraPixels[i + 0] = rgbaPixels[i + 2]; // B <- R
                bgraPixels[i + 1] = rgbaPixels[i + 1]; // G <- G
                bgraPixels[i + 2] = rgbaPixels[i + 0]; // R <- B
                bgraPixels[i + 3] = rgbaPixels[i + 3]; // A <- A
            }
            Bitmap bmp = new Bitmap(width, height, PixelFormat.Format32bppArgb);
            var bmpData = bmp.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);
            System.Runtime.InteropServices.Marshal.Copy(bgraPixels, 0, bmpData.Scan0, bgraPixels.Length);
            bmp.UnlockBits(bmpData);
            return bmp;
        }

        /// <summary>
        /// å°‡ S32 åœ°åœ–é¢æ¿çš„è¢å¹•åº§æ¨™è½‰æ›ç‚ºä¸–ç•Œåƒç´ åº§æ¨™
        /// è€ƒæ…®ç¸®æ”¾å’Œ RenderOrigin åç§»
        /// </summary>
        private Point S32ScreenToWorld(int screenX, int screenY)
        {
            // bitmap ç¹ªè£½ä½ç½® = (RenderOrigin - Scroll) * zoom
            int drawOffsetX = (int)((_viewState.RenderOriginX - _viewState.ScrollX) * s32ZoomLevel);
            int drawOffsetY = (int)((_viewState.RenderOriginY - _viewState.ScrollY) * s32ZoomLevel);

            // è¢å¹•åº§æ¨™ -> bitmap åº§æ¨™ -> ä¸–ç•Œåº§æ¨™
            int bitmapX = (int)((screenX - drawOffsetX) / s32ZoomLevel);
            int bitmapY = (int)((screenY - drawOffsetY) / s32ZoomLevel);
            int worldX = bitmapX + _viewState.RenderOriginX;
            int worldY = bitmapY + _viewState.RenderOriginY;

            return new Point(worldX, worldY);
        }

        // æŸ¥æ‰¾é»æ“Šä½ç½®çš„ Layer8 æ¨™è¨˜
        private (string s32Path, int index)? FindLayer8MarkerAtPosition(int worldX, int worldY)
        {
            const int hitRadius = 20;  // æ¨™è¨˜é»æ“Šç¯„åœï¼ˆåŠ å¤§ï¼‰
            Console.WriteLine($"[Layer8-Click] Finding marker at world ({worldX}, {worldY})");

            foreach (var s32Data in _document.S32Files.Values)
            {
                if (s32Data.Layer8.Count == 0) continue;

                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int i = 0; i < s32Data.Layer8.Count; i++)
                {
                    var item = s32Data.Layer8[i];

                    // Layer8 X,Y æ˜¯çµ•å°éŠæˆ²åº§æ¨™ï¼Œå…ˆè½‰ç‚ºæœ¬åœ°åº§æ¨™
                    int localLayer3X = item.X - s32Data.SegInfo.nLinBeginX;
                    int localLayer3Y = item.Y - s32Data.SegInfo.nLinBeginY;

                    if (localLayer3X < 0 || localLayer3X > 63 || localLayer3Y < 0 || localLayer3Y > 63)
                        continue;

                    int layer1X = localLayer3X * 2;
                    int layer1Y = localLayer3Y;

                    int baseX = -24 * (layer1X / 2);
                    int baseY = 63 * 12 - 12 * (layer1X / 2);
                    // æ¸²æŸ“æ™‚ç•«å¸ƒåº§æ¨™ = worldX - worldRect.X + 12
                    // æ‰€ä»¥æ¨™è¨˜çš„ä¸–ç•Œåº§æ¨™ä¸­å¿ƒæ˜¯ worldX + 12, worldY + 12
                    int markerWorldX = mx + baseX + layer1X * 24 + layer1Y * 24 + 12;
                    int markerWorldY = my + baseY + layer1Y * 12 + 12;

                    // æª¢æŸ¥æ˜¯å¦åœ¨é»æ“Šç¯„åœå…§
                    int dx = worldX - markerWorldX;
                    int dy = worldY - markerWorldY;
                    int distSq = dx * dx + dy * dy;

                    if (distSq <= hitRadius * hitRadius)
                    {
                        Console.WriteLine($"[Layer8-Click] HIT! marker at ({markerWorldX},{markerWorldY}), dist={Math.Sqrt(distSq):F1}");
                        return (s32Data.FilePath, i);
                    }
                }
            }

            Console.WriteLine($"[Layer8-Click] No marker found");
            return null;
        }

        // ç¹ªè£½ S32 é‚Šç•Œæ¡†ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        private void DrawS32BoundaryOnlyViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.ClearTypeGridFit;

                Font font = new Font("Arial", 9, FontStyle.Bold);
                Pen boundaryPen = new Pen(Color.Cyan, 2);

                foreach (var s32Data in _document.S32Files.Values)
                {
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    Point[] corners = new Point[4];
                    int[][] cornerCoords = new int[][] {
                        new int[] { 0, 0 },
                        new int[] { 64, 0 },
                        new int[] { 64, 64 },
                        new int[] { 0, 64 }
                    };

                    for (int i = 0; i < 4; i++)
                    {
                        int x3 = cornerCoords[i][0];
                        int y = cornerCoords[i][1];
                        int x = x3 * 2;

                        int localBaseX = 0 - 24 * (x / 2);
                        int localBaseY = 63 * 12 - 12 * (x / 2);
                        int X = mx + localBaseX + x * 24 + y * 24 - worldRect.X;
                        int Y = my + localBaseY + y * 12 - worldRect.Y;

                        corners[i] = new Point(X, Y + 12);
                    }

                    g.DrawLine(boundaryPen, corners[0], corners[1]);
                    g.DrawLine(boundaryPen, corners[1], corners[2]);
                    g.DrawLine(boundaryPen, corners[2], corners[3]);
                    g.DrawLine(boundaryPen, corners[3], corners[0]);

                    int centerX = (corners[0].X + corners[2].X) / 2;
                    int centerY = (corners[0].Y + corners[2].Y) / 2;
                    string centerText = $"GetLoc({mx},{my})\n{s32Data.SegInfo.nLinBeginX},{s32Data.SegInfo.nLinBeginY}~{s32Data.SegInfo.nLinEndX},{s32Data.SegInfo.nLinEndY}";
                    using (SolidBrush cb = new SolidBrush(Color.FromArgb(200, Color.Black)))
                    using (SolidBrush ct = new SolidBrush(Color.Lime))
                    {
                        SizeF cs = g.MeasureString(centerText, font);
                        g.FillRectangle(cb, centerX - cs.Width/2 - 2, centerY - cs.Height/2 - 1, cs.Width + 4, cs.Height + 2);
                        g.DrawString(centerText, font, ct, centerX - cs.Width/2, centerY - cs.Height/2);
                    }
                }

                font.Dispose();
                boundaryPen.Dispose();
            }
        }

        // ç¹ªè£½æ ¼ç·šï¼ˆViewport ç‰ˆæœ¬ï¼‰
        private void DrawS32GridViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                using (Pen gridPen = new Pen(Color.FromArgb(100, Color.Red), 1))
                {
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        int[] loc = s32Data.SegInfo.GetLoc(1.0);
                        int mx = loc[0];
                        int my = loc[1];

                        for (int y = 0; y < 64; y++)
                        {
                            for (int x3 = 0; x3 < 64; x3++)
                            {
                                int x = x3 * 2;

                                int localBaseX = 0 - 24 * (x / 2);
                                int localBaseY = 63 * 12 - 12 * (x / 2);

                                int X = mx + localBaseX + x * 24 + y * 24 - worldRect.X;
                                int Y = my + localBaseY + y * 12 - worldRect.Y;

                                // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                                if (X + 48 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                                    continue;

                                Point p1 = new Point(X, Y + 12);
                                Point p2 = new Point(X + 24, Y);
                                Point p3 = new Point(X + 48, Y + 12);
                                Point p4 = new Point(X + 24, Y + 24);

                                g.DrawLine(gridPen, p1, p2);
                                g.DrawLine(gridPen, p2, p3);
                                g.DrawLine(gridPen, p3, p4);
                                g.DrawLine(gridPen, p4, p1);
                            }
                        }
                    }
                }
            }
        }

        // ç¹ªè£½åº§æ¨™æ¨™ç±¤ï¼ˆViewport ç‰ˆæœ¬ï¼‰
        private void DrawCoordinateLabelsViewport(Bitmap bitmap, Struct.L1Map currentMap, Rectangle worldRect)
        {
            using (Graphics g = Graphics.FromImage(bitmap))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.ClearTypeGridFit;

                Font font = new Font("Arial", 8, FontStyle.Bold);
                int interval = 10;

                foreach (var s32Data in _document.S32Files.Values)
                {
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    for (int y = 0; y < 64; y += interval)
                    {
                        for (int x = 0; x < 128; x += interval)
                        {
                            int localBaseX = 0 - 24 * (x / 2);
                            int localBaseY = 63 * 12 - 12 * (x / 2);

                            int X = mx + localBaseX + x * 24 + y * 24 - worldRect.X;
                            int Y = my + localBaseY + y * 12 - worldRect.Y;

                            // è·³éä¸åœ¨ Viewport å…§çš„æ ¼å­
                            if (X + 24 < 0 || X > worldRect.Width || Y + 24 < 0 || Y > worldRect.Height)
                                continue;

                            int gameX = s32Data.SegInfo.nLinBeginX + x;
                            int gameY = s32Data.SegInfo.nLinBeginY + y;

                            string coordText = $"{gameX},{gameY}";
                            SizeF textSize = g.MeasureString(coordText, font);

                            int textX = X + 12 - (int)textSize.Width / 2;
                            int textY = Y + 12 - (int)textSize.Height / 2;

                            using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(180, Color.White)))
                            {
                                g.FillRectangle(bgBrush, textX - 2, textY - 1, textSize.Width + 4, textSize.Height + 2);
                            }

                            using (SolidBrush textBrush = new SolidBrush(Color.Blue))
                            {
                                g.DrawString(coordText, font, textBrush, textX, textY);
                            }
                        }
                    }
                }

                font.Dispose();
            }
        }

        #endregion

        // ç¹ªè£½ Tile åˆ°ç·©è¡å€ï¼ˆç°¡åŒ–ç‰ˆï¼‰
        private unsafe void DrawTilToBuffer(int x, int y, int tileId, int indexId, int rowpix, byte* ptr, int maxWidth, int maxHeight, int mapHeightInCells)
        {
            try
            {
                // ä½¿ç”¨å¿«å–æ¸›å°‘é‡è¤‡è®€å–ï¼ˆConcurrentDictionary.GetOrAdd æ˜¯åŸ·è¡Œç·’å®‰å…¨çš„ï¼‰
                string cacheKey = $"{tileId}_{indexId}";
                byte[] tilData = tileDataCache.GetOrAdd(cacheKey, _ =>
                {
                    string key = $"{tileId}.til";
                    byte[] data = L1PakReader.UnPack("Tile", key);
                    if (data == null) return null;

                    var tilArray = L1Til.Parse(data);
                    if (indexId >= tilArray.Count) return null;

                    return tilArray[indexId];
                });

                if (tilData == null) return;

                fixed (byte* til_ptr_fixed = tilData)
                {
                    byte* til_ptr = til_ptr_fixed;
                    byte type = *(til_ptr++);

                    int baseX = 0;
                    int baseY = (mapHeightInCells - 1) * 12;
                    baseX -= 24 * (x / 2);
                    baseY -= 12 * (x / 2);

                    if ((type & 0x02) == 0 && (type & 0x01) != 0 )
                    {
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 0;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int startX = baseX + x * 24 + y * 24 + tx;
                                int startY = baseY + y * 12 + ty;
                                if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                {
                                    int v = startY * rowpix + (startX * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else if ((type & 0x02) == 0 && (type & 0x01) == 0)
                    {
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 24 - n;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int startX = baseX + x * 24 + y * 24 + tx;
                                int startY = baseY + y * 12 + ty;
                                if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                {
                                    int v = startY * rowpix + (startX * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else if (type == 34 || type == 35)
                    {
                        // å£“ç¸®æ ¼å¼ - éœ€è¦èˆ‡èƒŒæ™¯æ··åˆ
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                    int startX = baseX + x * 24 + y * 24 + tx;
                                    int startY = baseY + y * 12 + ty + y_offset;
                                    if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                    {
                                        int v = startY * rowpix + (startX * 2);
                                        *(ptr + v) = (byte)(color & 0x00FF);
                                        *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                    else
                    {
                        // å…¶ä»–å£“ç¸®æ ¼å¼
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                    int startX = baseX + x * 24 + y * 24 + tx;
                                    int startY = baseY + y * 12 + ty + y_offset;
                                    if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                    {
                                        int v = startY * rowpix + (startX * 2);
                                        *(ptr + v) = (byte)(color & 0x00FF);
                                        *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
        }

        // ç¹ªè£½ Tile åˆ°ç·©è¡å€ï¼ˆç›´æ¥ä½¿ç”¨åƒç´ åº§æ¨™ï¼‰
        private unsafe void DrawTilToBufferDirect(int pixelX, int pixelY, int tileId, int indexId, int rowpix, byte* ptr, int maxWidth, int maxHeight)
        {
            try
            {
                // å…ˆå¾ til æª”æ¡ˆå¿«å–å–å¾—æ•´å€‹ til array
                List<byte[]> tilArray = _tilFileCache.GetOrAdd(tileId, _ =>
                {
                    string key = $"{tileId}.til";
                    byte[] data = L1PakReader.UnPack("Tile", key);
                    if (data == null) return null;
                    return L1Til.Parse(data);
                });

                // å‚™æ´æ©Ÿåˆ¶ï¼šç•¶ tilArray ç‚º null æˆ– indexId è¶Šç•Œæ™‚
                if (tilArray == null || indexId >= tilArray.Count)
                {
                    if (tileId != 0)
                    {
                        // è¼‰å…¥ 0.til ä½œç‚ºé è¨­å¡«è£œ
                        tilArray = _tilFileCache.GetOrAdd(0, _ =>
                        {
                            string key = "0.til";
                            byte[] data = L1PakReader.UnPack("Tile", key);
                            if (data == null) return null;
                            return L1Til.Parse(data);
                        });
                        if (tilArray == null || tilArray.Count == 0) return;
                        // ä½¿ç”¨ 187 æˆ– 188 ä½œç‚ºé è¨­ indexId (0x8CBB/0x8CBC è¨ˆç®—çµæœ)
                        indexId = 187 + ((pixelX / 24) & 1);
                        if (indexId >= tilArray.Count)
                            indexId = indexId % tilArray.Count;
                    }
                    else
                    {
                        // TileId=0 æ™‚ï¼Œå° tilArray.Count å–æ¨¡
                        if (tilArray != null && tilArray.Count > 0)
                            indexId = indexId % tilArray.Count;
                        else
                            return;
                    }
                }
                if (tilArray == null || indexId >= tilArray.Count) return;
                byte[] tilData = tilArray[indexId];
                if (tilData == null) return;

                fixed (byte* til_ptr_fixed = tilData)
                {
                    byte* til_ptr = til_ptr_fixed;
                    byte type = *(til_ptr++);

                    if ((type & 0x02) == 0 && (type & 0x01) != 0)
                    {
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 0;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int startX = pixelX + tx;
                                int startY = pixelY + ty;
                                if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                {
                                    int v = startY * rowpix + (startX * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else if ((type & 0x02) == 0 && (type & 0x01) == 0)
                    {
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 24 - n;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int startX = pixelX + tx;
                                int startY = pixelY + ty;
                                if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                {
                                    int v = startY * rowpix + (startX * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else if (type == 34 || type == 35)
                    {
                        // å£“ç¸®æ ¼å¼ - éœ€è¦èˆ‡èƒŒæ™¯æ··åˆ
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                    int startX = pixelX + tx;
                                    int startY = pixelY + ty + y_offset;
                                    if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                    {
                                        int v = startY * rowpix + (startX * 2);
                                        *(ptr + v) = (byte)(color & 0x00FF);
                                        *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                    else
                    {
                        // å…¶ä»–å£“ç¸®æ ¼å¼
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                    int startX = pixelX + tx;
                                    int startY = pixelY + ty + y_offset;
                                    if (startX >= 0 && startX < maxWidth && startY >= 0 && startY < maxHeight)
                                    {
                                        int v = startY * rowpix + (startX * 2);
                                        *(ptr + v) = (byte)(color & 0x00FF);
                                        *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
        }

        // å¿«å–èšåˆçš„ Tile è³‡æ–™ï¼ˆé¿å…æ¯æ¬¡æœå°‹éƒ½é‡æ–°è¨ˆç®—ï¼‰
        private Dictionary<int, TileInfo> cachedAggregatedTiles = new Dictionary<int, TileInfo>();

        // æ›´æ–° Tile æ¸…å–®é¡¯ç¤º - çµ±è¨ˆæ‰€æœ‰ S32 æª”æ¡ˆçš„ tiles
        private void UpdateTileList()
        {
            UpdateTileList(null);  // ä¸å¸¶æœå°‹æ¢ä»¶
        }

        /// <summary>
        /// èƒŒæ™¯è¼‰å…¥ Tile åˆ—è¡¨
        /// </summary>
        private void UpdateTileListAsync()
        {
            Task.Run(() =>
            {
                var sw = Stopwatch.StartNew();

                // èšåˆæ‰€æœ‰ S32 æª”æ¡ˆçš„ UsedTilesï¼ˆåœ¨èƒŒæ™¯åŸ·è¡Œç·’ï¼‰
                var aggregatedTiles = new Dictionary<int, TileInfo>();
                foreach (var s32Data in _document.S32Files.Values)
                {
                    foreach (var tileKvp in s32Data.UsedTiles)
                    {
                        int tileId = tileKvp.Key;
                        var tileInfo = tileKvp.Value;

                        if (aggregatedTiles.ContainsKey(tileId))
                        {
                            aggregatedTiles[tileId].UsageCount += tileInfo.UsageCount;
                        }
                        else
                        {
                            aggregatedTiles[tileId] = new TileInfo
                            {
                                TileId = tileInfo.TileId,
                                IndexId = tileInfo.IndexId,
                                UsageCount = tileInfo.UsageCount,
                                Thumbnail = null
                            };
                        }
                    }
                }

                // é å…ˆè¼‰å…¥æ‰€æœ‰ç¸®åœ–ï¼ˆåœ¨èƒŒæ™¯åŸ·è¡Œç·’ï¼‰
                foreach (var tile in aggregatedTiles.Values)
                {
                    if (tile.Thumbnail == null)
                    {
                        tile.Thumbnail = LoadTileThumbnail(tile.TileId, tile.IndexId);
                    }
                }

                sw.Stop();
                LogPerf($"[TILELIST] total={sw.ElapsedMilliseconds}ms | tiles={aggregatedTiles.Count}");

                // å›åˆ° UI åŸ·è¡Œç·’æ›´æ–°åˆ—è¡¨
                this.BeginInvoke((MethodInvoker)delegate
                {
                    cachedAggregatedTiles = aggregatedTiles;

                    lvTiles.BeginUpdate();  // æš«åœé‡ç¹ª
                    try
                    {
                        lvTiles.Items.Clear();
                        lvTiles.View = View.LargeIcon;

                        ImageList imageList = new ImageList();
                        imageList.ImageSize = new Size(48, 48);
                        imageList.ColorDepth = ColorDepth.Depth32Bit;
                        lvTiles.LargeImageList = imageList;

                        // æ‰¹é‡æº–å‚™é …ç›®
                        var items = new List<ListViewItem>();
                        int index = 0;
                        foreach (var tileKvp in aggregatedTiles.OrderBy(t => t.Key))
                        {
                            var tile = tileKvp.Value;
                            if (tile.Thumbnail != null)
                            {
                                imageList.Images.Add(tile.Thumbnail);

                                // æª¢æŸ¥æ˜¯å¦ç‚º R ç‰ˆ
                                bool isRemaster = _tilRemasterCache.TryGetValue(tile.TileId, out bool r) && r;
                                string rMark = isRemaster ? "(R)" : "";

                                var item = new ListViewItem
                                {
                                    Text = $"ID:{tile.TileId}{rMark}\nÃ—{tile.UsageCount}",
                                    ImageIndex = index,
                                    Tag = tile
                                };
                                items.Add(item);
                                index++;
                            }
                        }

                        // æ‰¹é‡æ·»åŠ 
                        lvTiles.Items.AddRange(items.ToArray());
                    }
                    finally
                    {
                        lvTiles.EndUpdate();  // æ¢å¾©é‡ç¹ª
                    }

                    lblTileList.Text = string.Format(LocalizationManager.L("Label_TileListCount"), lvTiles.Items.Count);
                });
            });
        }

        // æ›´æ–° Tile æ¸…å–®é¡¯ç¤ºï¼ˆæ”¯æ´æœå°‹éæ¿¾ï¼‰
        private void UpdateTileList(string searchText)
        {
            Console.WriteLine("Update tile list start");
            Stopwatch sw = new Stopwatch();
            sw.Start();
                
            lvTiles.BeginUpdate();  // æš«åœé‡ç¹ª
            try
            {
                lvTiles.Items.Clear();
                lvTiles.View = View.LargeIcon;

                // å‰µå»º ImageList
                ImageList imageList = new ImageList();
                imageList.ImageSize = new Size(48, 48);
                imageList.ColorDepth = ColorDepth.Depth32Bit;
                lvTiles.LargeImageList = imageList;

                if (_document.S32Files.Count == 0)
                {
                    this.toolStripStatusLabel1.Text = "æ²’æœ‰ S32 æª”æ¡ˆ";
                    return;
                }

                // å¦‚æœå¿«å–ç‚ºç©ºï¼Œé‡æ–°èšåˆæ‰€æœ‰ S32 æª”æ¡ˆçš„ UsedTiles
                if (cachedAggregatedTiles.Count == 0 || string.IsNullOrEmpty(searchText))
                {
                    cachedAggregatedTiles.Clear();

                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        foreach (var tileKvp in s32Data.UsedTiles)
                        {
                            int tileId = tileKvp.Key;
                            var tileInfo = tileKvp.Value;

                            if (cachedAggregatedTiles.ContainsKey(tileId))
                            {
                                // ç´¯åŠ ä½¿ç”¨æ¬¡æ•¸
                                cachedAggregatedTiles[tileId].UsageCount += tileInfo.UsageCount;
                            }
                            else
                            {
                                // æ–°å¢ tile
                                cachedAggregatedTiles[tileId] = new TileInfo
                                {
                                    TileId = tileInfo.TileId,
                                    IndexId = tileInfo.IndexId,
                                    UsageCount = tileInfo.UsageCount,
                                    Thumbnail = null
                                };
                            }
                        }
                    }
                }

                // éæ¿¾ tiles
                var filteredTiles = cachedAggregatedTiles.AsEnumerable();
                if (!string.IsNullOrWhiteSpace(searchText))
                {
                    searchText = searchText.Trim();
                    // æ”¯æ´å¤šç¨®æœå°‹æ–¹å¼ï¼š
                    // 1. ç²¾ç¢º ID æœå°‹ï¼ˆè¼¸å…¥æ•¸å­—ï¼‰
                    // 2. ç¯„åœæœå°‹ï¼ˆå¦‚ "100-200"ï¼‰
                    // 3. å¤šå€‹ ID æœå°‹ï¼ˆå¦‚ "100,200,300"ï¼‰
                    if (searchText.Contains("-"))
                    {
                        // ç¯„åœæœå°‹
                        var parts = searchText.Split('-');
                        if (parts.Length == 2 &&
                            int.TryParse(parts[0].Trim(), out int minId) &&
                            int.TryParse(parts[1].Trim(), out int maxId))
                        {
                            filteredTiles = filteredTiles.Where(t => t.Key >= minId && t.Key <= maxId);
                        }
                    }
                    else if (searchText.Contains(","))
                    {
                        // å¤šå€‹ ID æœå°‹
                        var ids = searchText.Split(',')
                            .Select(s => s.Trim())
                            .Where(s => int.TryParse(s, out _))
                            .Select(s => int.Parse(s))
                            .ToHashSet();
                        filteredTiles = filteredTiles.Where(t => ids.Contains(t.Key));
                    }
                    else if (int.TryParse(searchText, out int exactId))
                    {
                        // ç²¾ç¢º ID æˆ–å‰ç¶´æœå°‹
                        filteredTiles = filteredTiles.Where(t => t.Key.ToString().StartsWith(searchText));
                    }
                    else
                    {
                        // æ–‡å­—æœå°‹ï¼ˆID åŒ…å«æ­¤æ–‡å­—ï¼‰
                        filteredTiles = filteredTiles.Where(t => t.Key.ToString().Contains(searchText));
                    }
                }

                // æ‰¹é‡æº–å‚™é …ç›®
                var items = new List<ListViewItem>();
                int index = 0;
                int totalCount = cachedAggregatedTiles.Count;
                foreach (var tileKvp in filteredTiles.OrderBy(t => t.Key))
                {
                    var tile = tileKvp.Value;

                    // è¼‰å…¥ç¸®åœ–ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥ï¼‰
                    if (tile.Thumbnail == null)
                    {
                        tile.Thumbnail = LoadTileThumbnail(tile.TileId, tile.IndexId);
                    }

                    if (tile.Thumbnail != null)
                    {
                        imageList.Images.Add(tile.Thumbnail);

                        // æª¢æŸ¥æ˜¯å¦ç‚º R ç‰ˆ
                        bool isRemaster = _tilRemasterCache.TryGetValue(tile.TileId, out bool r) && r;
                        string rMark = isRemaster ? "(R)" : "";

                        var item = new ListViewItem
                        {
                            Text = $"ID:{tile.TileId}{rMark}\nÃ—{tile.UsageCount}",
                            ImageIndex = index,
                            Tag = tile
                        };
                        items.Add(item);
                        index++;
                    }
                }

                // æ‰¹é‡æ·»åŠ 
                lvTiles.Items.AddRange(items.ToArray());

                string statusText = string.IsNullOrWhiteSpace(searchText)
                    ? string.Format(LocalizationManager.L("Label_TileListCount"), lvTiles.Items.Count)
                    : $"{LocalizationManager.L("Label_SearchResult")}: {lvTiles.Items.Count}/{totalCount}";
                lblTileList.Text = statusText;
            }
            finally
            {
                lvTiles.EndUpdate();  // æ¢å¾©é‡ç¹ª
            }
            sw.Stop();
            Console.WriteLine("Update tile list end:"+sw.ElapsedMilliseconds+"ms");
        }

        // Tile æœå°‹æ¡†æ–‡å­—è®Šæ›´äº‹ä»¶
        private void txtTileSearch_TextChanged(object sender, EventArgs e)
        {
            UpdateTileList(txtTileSearch.Text);
        }

        // è¨ˆç®— Tile.idx ä¸­ 1-9999 ç¯„åœå…§å·²ä½¿ç”¨çš„ TileId æ•¸é‡
        private int GetTileIdxUsedCount()
        {
            try
            {
                // è§¸ç™¼è¼‰å…¥ Tile.idxï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥ï¼‰
                L1IdxReader.Find("Tile", "1.til");

                if (Share.IdxDataList.TryGetValue("Tile", out var tileIdx))
                {
                    int count = 0;
                    foreach (var key in tileIdx.Keys)
                    {
                        // æª”åæ ¼å¼ç‚º "xxx.til"ï¼Œè§£æå‡ºæ•¸å­—
                        if (key.EndsWith(".til"))
                        {
                            string numPart = key.Substring(0, key.Length - 4);
                            if (int.TryParse(numPart, out int tileId) && tileId >= 1 && tileId <= 9999)
                            {
                                count++;
                            }
                        }
                    }
                    return count;
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
            return 0;
        }

        /// <summary>
        /// è®€å– list.til ä¸­è¨˜éŒ„çš„æœ€å¤§ TileId
        /// list.til æ˜¯ä¸€å€‹åŒ…å«å–®ä¸€ int32 æ•¸å­—çš„æª”æ¡ˆï¼Œè¡¨ç¤º Tile çš„æœ€å¤§ ID
        /// </summary>
        private int GetListTilMaxId(bool forceReload = false)
        {
            if (_listTilMaxId.HasValue && !forceReload)
                return _listTilMaxId.Value;

            try
            {
                byte[] data = L1PakReader.UnPack("Tile", "list.til");
                if (data != null && data.Length >= 4)
                {
                    _listTilMaxId = BitConverter.ToInt32(data, 0);
                    return _listTilMaxId.Value;
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
            return 9999; // é è¨­å€¼
        }

        /// <summary>
        /// å–å¾— Tile.idx ä¸­å¯¦éš›ä½¿ç”¨çš„æœ€å¤§ TileId
        /// </summary>
        private int GetActualMaxTileId()
        {
            int maxId = 0;
            try
            {
                // è§¸ç™¼è¼‰å…¥ Tile.idx
                L1IdxReader.Find("Tile", "1.til");

                if (Share.IdxDataList.TryGetValue("Tile", out var tileIdx))
                {
                    foreach (var key in tileIdx.Keys)
                    {
                        if (key.EndsWith(".til") && key != "list.til")
                        {
                            string numPart = key.Substring(0, key.Length - 4);
                            if (int.TryParse(numPart, out int tileId) && tileId > maxId)
                            {
                                maxId = tileId;
                            }
                        }
                    }
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
            return maxId;
        }

        /// <summary>
        /// æª¢æŸ¥ list.til æ•¸å€¼æŒ‰éˆ•é»æ“Šäº‹ä»¶
        /// </summary>
        private void btnToolCheckListTil_Click(object sender, EventArgs e)
        {
            try
            {
                int listTilValue = GetListTilMaxId(true); // å¼·åˆ¶é‡æ–°è®€å–
                int actualMaxId = GetActualMaxTileId();
                int usedCount = GetTileIdxUsedCount();

                if (listTilValue > actualMaxId + 1)
                {
                    int suggestedValue = actualMaxId + 1;
                    var result = MessageBox.Show(
                        $"list.til æª¢æŸ¥çµæœï¼š\n\n" +
                        $"â€¢ list.til è¨˜éŒ„çš„ä¸Šé™ï¼š{listTilValue}\n" +
                        $"â€¢ å¯¦éš›ä½¿ç”¨çš„æœ€å¤§ TileIdï¼š{actualMaxId}\n" +
                        $"â€¢ Tile.idx ä¸­çš„ Tile æ•¸é‡ï¼š{usedCount}\n\n" +
                        $"list.til çš„æ•¸å€¼ ({listTilValue}) å¤§æ–¼å¯¦éš›ä½¿ç”¨çš„æœ€å¤§ TileId + 1 ({actualMaxId + 1})ã€‚\n\n" +
                        $"æ˜¯å¦è¦å°‡ list.til ä¿®æ”¹ç‚º {suggestedValue}ï¼Ÿ",
                        "list.til æ•¸å€¼æª¢æŸ¥",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Question);

                    if (result == DialogResult.Yes)
                    {
                        if (UpdateListTil(suggestedValue))
                        {
                            MessageBox.Show(
                                $"list.til å·²æ›´æ–°ç‚º {suggestedValue}ã€‚\n\nå‰©é¤˜å¯ç”¨ç©ºä½ï¼š{suggestedValue - actualMaxId}",
                                "æ›´æ–°æˆåŠŸ",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Information);

                            // æ›´æ–° Tile æ¸…å–®é¡¯ç¤º
                            UpdateTileList(txtTileSearch.Text);
                        }
                        else
                        {
                            MessageBox.Show(
                                "æ›´æ–° list.til å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ¬Šé™ã€‚",
                                "æ›´æ–°å¤±æ•—",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Error);
                        }
                    }
                }
                else
                {
                    MessageBox.Show(
                        $"list.til æª¢æŸ¥çµæœï¼š\n\n" +
                        $"â€¢ list.til è¨˜éŒ„çš„ä¸Šé™ï¼š{listTilValue}\n" +
                        $"â€¢ å¯¦éš›ä½¿ç”¨çš„æœ€å¤§ TileIdï¼š{actualMaxId}\n" +
                        $"â€¢ Tile.idx ä¸­çš„ Tile æ•¸é‡ï¼š{usedCount}\n" +
                        $"â€¢ å‰©é¤˜å¯ç”¨ç©ºä½ï¼š{listTilValue - actualMaxId}\n\n" +
                        $"list.til æ•¸å€¼æ­£å¸¸ï¼Œç„¡éœ€æ›´æ–°ã€‚",
                        "list.til æ•¸å€¼æª¢æŸ¥",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"æª¢æŸ¥ list.til æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}",
                    "éŒ¯èª¤",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// æ›´æ–° list.til çš„æ•¸å€¼ä¸¦å­˜å› pak
        /// </summary>
        private bool UpdateListTil(int newValue)
        {
            try
            {
                byte[] data = BitConverter.GetBytes(newValue);
                bool success = L1PakWriter.AppendFile("Tile", "list.til", data);
                if (success)
                {
                    _listTilMaxId = newValue;
                }
                return success;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"UpdateListTil error: {ex.Message}");
                return false;
            }
        }

        // è¼‰å…¥ Tile ç¸®åœ–ï¼ˆä½¿ç”¨å¿«å–ï¼‰
        private Bitmap LoadTileThumbnail(int tileId, int indexId)
        {
            try
            {
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¿«å–çš„ç‰ˆæœ¬è³‡è¨Š
                bool isRemaster = _tilRemasterCache.GetOrAdd(tileId, _ =>
                {
                    string key = $"{tileId}.til";
                    byte[] rawData = L1PakReader.UnPack("Tile", key);
                    return rawData != null && L1Til.IsRemaster(rawData);
                });

                // ä½¿ç”¨å·²å­˜åœ¨çš„ til æª”æ¡ˆå¿«å–
                List<byte[]> tilArray = _tilFileCache.GetOrAdd(tileId, _ =>
                {
                    string key = $"{tileId}.til";
                    byte[] data = L1PakReader.UnPack("Tile", key);
                    if (data == null) return null;
                    return L1Til.Parse(data);
                });

                if (tilArray == null || indexId >= tilArray.Count)
                    return CreatePlaceholderThumbnail(tileId);

                // ç¹ªè£½å¯¦éš›çš„ tile åœ–ç‰‡
                byte[] tilData = tilArray[indexId];
                return RenderTileThumbnail(tilData, tileId);
            }
            catch
            {
                return CreatePlaceholderThumbnail(tileId);
            }
        }

        // ç¹ªè£½ Tile åˆ°ç¸®åœ–
        private unsafe Bitmap RenderTileThumbnail(byte[] tilData, int tileId)
        {
            try
            {
                // å‰µå»º 48x48 çš„ç¸®åœ–
                Bitmap thumbnail = new Bitmap(48, 48, PixelFormat.Format16bppRgb555);

                Rectangle rect = new Rectangle(0, 0, thumbnail.Width, thumbnail.Height);
                BitmapData bmpData = thumbnail.LockBits(rect, ImageLockMode.ReadWrite, thumbnail.PixelFormat);
                int rowpix = bmpData.Stride;
                byte* ptr = (byte*)bmpData.Scan0;

                // å›ºå®š tilData é™£åˆ—ä»¥å–å¾—æŒ‡æ¨™
                fixed (byte* til_ptr_fixed = tilData)
                {
                    byte* til_ptr = til_ptr_fixed;
                    byte type = *(til_ptr++);

                    // ç¸®åœ–åç§»ï¼ˆç½®ä¸­ï¼‰
                    int offsetX = 12;
                    int offsetY = 12;

                    if ((type & 0x02) == 0 && (type & 0x01) != 0 )
                    {
                        // ä¸‹åŠéƒ¨ 2.5D æ–¹å¡Š
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 0;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int px = offsetX + tx;
                                int py = offsetY + ty;
                                if (px >= 0 && px < 48 && py >= 0 && py < 48)
                                {
                                    int v = py * rowpix + (px * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else if ((type & 0x02) == 0 && (type & 0x01) == 0 )
                    {
                        // ä¸ŠåŠéƒ¨ 2.5D æ–¹å¡Š
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 24 - n;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                int px = offsetX + tx;
                                int py = offsetY + ty;
                                if (px >= 0 && px < 48 && py >= 0 && py < 48)
                                {
                                    int v = py * rowpix + (px * 2);
                                    *(ptr + v) = (byte)(color & 0x00FF);
                                    *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                }
                                tx++;
                            }
                        }
                    }
                    else
                    {
                        // å£“ç¸®æ ¼å¼ï¼ˆtype 34, 35 æˆ–å…¶ä»–ï¼‰
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen && ty < 48; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));
                                    int px = offsetX + tx;
                                    int py = offsetY + ty + y_offset;
                                    if (px >= 0 && px < 48 && py >= 0 && py < 48)
                                    {
                                        int v = py * rowpix + (px * 2);
                                        *(ptr + v) = (byte)(color & 0x00FF);
                                        *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                }

                thumbnail.UnlockBits(bmpData);
                return thumbnail;
            }
            catch
            {
                return CreatePlaceholderThumbnail(tileId);
            }
        }

        // å‰µå»ºä½”ä½ç¸®åœ–
        private Bitmap CreatePlaceholderThumbnail(int tileId)
        {
            Bitmap placeholder = new Bitmap(48, 48);
            using (Graphics g = Graphics.FromImage(placeholder))
            {
                g.Clear(Color.DarkGray);
                g.DrawRectangle(Pens.Red, 1, 1, 46, 46);
                using (Font font = new Font("Arial", 8))
                {
                    g.DrawString("?", font, Brushes.White, 18, 16);
                }
            }
            return placeholder;
        }

        #region MapViewerControl äº‹ä»¶è™•ç†

        // MapViewerControl æ»‘é¼ æŒ‰ä¸‹äº‹ä»¶ - è½‰ç™¼çµ¦ç·¨è¼¯è™•ç†
        private void MapViewerControl_MapMouseDown(object sender, MapMouseEventArgs e)
        {
            // å…ˆç›´æ¥ç”¨ä¸–ç•Œåº§æ¨™è™•ç† Layer8 marker é»æ“Šï¼ˆé¿å…åº§æ¨™è½‰æ›èª¤å·®ï¼‰
            if (e.Button == MouseButtons.Left && Control.ModifierKeys == Keys.None && _viewState.ShowLayer8)
            {
                var clickedMarker = FindLayer8MarkerAtPosition(e.WorldLocation.X, e.WorldLocation.Y);
                if (clickedMarker.HasValue)
                {
                    var (s32Path, index) = clickedMarker.Value;
                    Console.WriteLine($"[Layer8-MapViewer] Clicked marker: {s32Path} index={index}");

                    // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
                    if (_editState.EnabledLayer8Items.Contains((s32Path, index)))
                    {
                        _editState.EnabledLayer8Items.Remove((s32Path, index));
                        _layer8AnimFrame.Remove((s32Path, index));

                        if (_editState.EnabledLayer8Items.Count == 0 && _layer8AnimTimer != null)
                        {
                            _layer8AnimTimer.Stop();
                        }
                        Console.WriteLine($"[Layer8-MapViewer] Disabled marker");
                    }
                    else
                    {
                        _editState.EnabledLayer8Items.Add((s32Path, index));
                        _layer8AnimFrame[(s32Path, index)] = 0;

                        if (_layer8AnimTimer != null && !_layer8AnimTimer.Enabled)
                        {
                            _layer8AnimTimer.Start();
                        }
                        Console.WriteLine($"[Layer8-MapViewer] Enabled marker, total enabled: {_editState.EnabledLayer8Items.Count}");
                    }

                    // åªé‡ç¹ª L8 å‹•ç•«è¦†è“‹å±¤ï¼Œä¸å½±éŸ¿åœ°åœ–å’Œå…¶ä»–åœ–å±¤
                    _mapViewerControl.InvalidateAnimationOverlay();
                    return;
                }
            }

            // ä½¿ç”¨ MapViewerControl æä¾›çš„ä¸–ç•Œåº§æ¨™ï¼Œè½‰æ›å›è¢å¹•åº§æ¨™çµ¦ç¾æœ‰é‚è¼¯
            var screenLocation = _mapViewerControl.WorldToScreen(e.WorldLocation);
            var me = new MouseEventArgs(e.Button, 1, screenLocation.X, screenLocation.Y, e.Delta);
            s32PictureBox_MouseDown(sender, me);
        }

        // MapViewerControl æ»‘é¼ ç§»å‹•äº‹ä»¶ - è½‰ç™¼çµ¦ç·¨è¼¯è™•ç†
        private void MapViewerControl_MapMouseMove(object sender, MapMouseEventArgs e)
        {
            var screenLocation = _mapViewerControl.WorldToScreen(e.WorldLocation);
            var me = new MouseEventArgs(e.Button, 0, screenLocation.X, screenLocation.Y, e.Delta);
            s32PictureBox_MouseMove(sender, me);
        }

        // MapViewerControl æ»‘é¼ æ”¾é–‹äº‹ä»¶ - è½‰ç™¼çµ¦ç·¨è¼¯è™•ç†
        private void MapViewerControl_MapMouseUp(object sender, MapMouseEventArgs e)
        {
            var screenLocation = _mapViewerControl.WorldToScreen(e.WorldLocation);
            var me = new MouseEventArgs(e.Button, 0, screenLocation.X, screenLocation.Y, e.Delta);
            s32PictureBox_MouseUp(sender, me);
        }

        // MapViewerControl ç¹ªè£½è¦†è“‹å±¤ - ç¹ªè£½ L8 å‹•ç•«ã€é¸å–æ¡†ã€å¤šé‚Šå½¢ç­‰
        private void MapViewerControl_PaintOverlay(object sender, PaintEventArgs e)
        {
            // ç¹ªè£½ Layer8 æ¨™è¨˜å’Œ SPR å‹•ç•«
            if (_viewState.ShowLayer8)
            {
                DrawLayer8OverlayOnControl(e.Graphics);
            }

            // è½‰ç™¼çµ¦åŸæœ‰çš„ Paint è™•ç†ï¼ˆè·³é bitmap ç¹ªè£½éƒ¨åˆ†ï¼Œåªç¹ªè£½ç·¨è¼¯å±¤ï¼‰
            DrawEditingOverlay(e.Graphics);
        }

        // åœ¨ MapViewerControl çš„è¦†è“‹å±¤ä¸Šç¹ªè£½ Layer8 æ¨™è¨˜
        private void DrawLayer8OverlayOnControl(Graphics g)
        {
            if (_document.S32Files.Count == 0) return;

            g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

            foreach (var s32Data in _document.S32Files.Values)
            {
                if (s32Data.Layer8.Count == 0) continue;

                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int i = 0; i < s32Data.Layer8.Count; i++)
                {
                    var item = s32Data.Layer8[i];

                    // Layer8 X,Y æ˜¯çµ•å°éŠæˆ²åº§æ¨™ï¼Œå…ˆè½‰ç‚ºæœ¬åœ°åº§æ¨™
                    int localLayer3X = item.X - s32Data.SegInfo.nLinBeginX;
                    int localLayer3Y = item.Y - s32Data.SegInfo.nLinBeginY;

                    if (localLayer3X < 0 || localLayer3X > 63 || localLayer3Y < 0 || localLayer3Y > 63)
                        continue;

                    int layer1X = localLayer3X * 2;
                    int layer1Y = localLayer3Y;

                    int baseX = -24 * (layer1X / 2);
                    int baseY = 63 * 12 - 12 * (layer1X / 2);

                    // Marker ä½ç½®ï¼šåŸå§‹ L8 åº§æ¨™ä½ç½®
                    int markerWorldX = mx + baseX + layer1X * 24 + layer1Y * 24 + 12;
                    int markerWorldY = my + baseY + layer1Y * 12 + 12;

                    // SPR ä½ç½®ï¼šåç§» (20, 30)
                    int sprWorldX = markerWorldX + 20;
                    int sprWorldY = markerWorldY + 30;

                    // è½‰ç‚ºè¢å¹•åº§æ¨™
                    var markerScreenPoint = _mapViewerControl.WorldToScreen(new Point(markerWorldX, markerWorldY));
                    int markerX = markerScreenPoint.X;
                    int markerY = markerScreenPoint.Y;

                    var sprScreenPoint = _mapViewerControl.WorldToScreen(new Point(sprWorldX, sprWorldY));
                    int sprX = sprScreenPoint.X;
                    int sprY = sprScreenPoint.Y;

                    // æª¢æŸ¥æ˜¯å¦åœ¨å¯è¦‹ç¯„åœå…§
                    if (markerX < -50 || markerX > _mapViewerControl.Width + 50 || markerY < -50 || markerY > _mapViewerControl.Height + 50)
                        continue;

                    bool isEnabled = _editState.EnabledLayer8Items.Contains((s32Data.FilePath, i));

                    // ç¹ªè£½æ¨™è¨˜ï¼ˆåœ“é»ï¼‰
                    // å•Ÿç”¨æ™‚ï¼šç°è‰²åŠé€æ˜ (opacity 0.1)ï¼Œåœ¨ SPR ä¸‹é¢
                    // åœç”¨æ™‚ï¼šæ©™è‰²å¯¦å¿ƒ
                    int markerRadius = (int)(10 * _viewState.ZoomLevel);
                    if (markerRadius < 5) markerRadius = 5;

                    if (isEnabled)
                    {
                        // å•Ÿç”¨ç‹€æ…‹ï¼šå…ˆç•«ç°è‰²åŠé€æ˜ marker
                        using (SolidBrush brush = new SolidBrush(Color.FromArgb(25, 128, 128, 128)))
                        {
                            g.FillEllipse(brush, markerX - markerRadius, markerY - markerRadius, markerRadius * 2, markerRadius * 2);
                        }
                        using (Pen pen = new Pen(Color.FromArgb(50, 255, 255, 255)))
                        {
                            g.DrawEllipse(pen, markerX - markerRadius, markerY - markerRadius, markerRadius * 2, markerRadius * 2);
                        }

                        // ç¹ªè£½ SPR å‹•ç•«ï¼ˆåœ¨ marker ä¸Šé¢ï¼Œä½†ä½ç½®å¾€å·¦åç§»ï¼‰
                        DrawLayer8SpriteOnOverlay(g, item.SprId, sprX, sprY, s32Data.FilePath, i);
                    }
                    else
                    {
                        // åœç”¨ç‹€æ…‹ï¼šæ©™è‰²å¯¦å¿ƒ marker
                        using (SolidBrush brush = new SolidBrush(Color.Orange))
                        {
                            g.FillEllipse(brush, markerX - markerRadius, markerY - markerRadius, markerRadius * 2, markerRadius * 2);
                        }
                        g.DrawEllipse(Pens.White, markerX - markerRadius, markerY - markerRadius, markerRadius * 2, markerRadius * 2);
                    }

                    // æ‰€æœ‰ç‹€æ…‹éƒ½é¡¯ç¤º SprId
                    using (Font font = new Font("Arial", (float)Math.Max(6, 8 * _viewState.ZoomLevel), FontStyle.Bold))
                    {
                        g.DrawString(item.SprId.ToString(), font, Brushes.White, markerX + markerRadius + 2, markerY - 6);
                    }
                }
            }
        }

        // åœ¨è¦†è“‹å±¤ä¸Šç¹ªè£½ Layer8 SPR å‹•ç•«å¸§
        private void DrawLayer8SpriteOnOverlay(Graphics g, int sprId, int x, int y, string s32Path, int itemIndex)
        {
            if (!_layer8SprCache.TryGetValue(sprId, out var frames))
            {
                frames = LoadLayer8SprFrames(sprId);
                _layer8SprCache[sprId] = frames;
            }

            if (frames == null || frames.Count == 0) return;

            var key = (s32Path, itemIndex);
            if (!_layer8AnimFrame.TryGetValue(key, out int frameIdx))
            {
                frameIdx = 0;
                _layer8AnimFrame[key] = 0;
            }

            Image frame = frames[frameIdx % frames.Count];
            float scale = (float)_viewState.ZoomLevel;
            int drawW = (int)(frame.Width * scale);
            int drawH = (int)(frame.Height * scale);

            // åŸºæº–é»ï¼šä¸‹ä¸­ (anchor = 2)
            int drawX = x - drawW / 2;
            int drawY = y - drawH;
            g.DrawImage(frame, drawX, drawY, drawW, drawH);
        }

        // MapViewerControl åº§æ¨™è®Šæ›´äº‹ä»¶ - æ›´æ–°ç‹€æ…‹åˆ—
        private void MapViewerControl_CoordinateChanged(object sender, CoordinateChangedEventArgs e)
        {
            this.toolStripStatusLabel2.Text = $"åº§æ¨™: ({e.GameX}, {e.GameY})";
        }

        // MapViewerControl æ¸²æŸ“å®Œæˆäº‹ä»¶
        private void MapViewerControl_RenderCompleted(object sender, RenderCompletedEventArgs e)
        {
            // å¯é¸ï¼šæ›´æ–°æ¸²æŸ“æ™‚é–“é¡¯ç¤º
            // LogPerf($"[RENDER-COMPLETE] {e.RenderTimeMs}ms");
        }

        // ç¹ªè£½ç·¨è¼¯è¦†è“‹å±¤ï¼ˆå¾ s32PictureBox_Paint ä¸­æå–ï¼‰
        private void DrawEditingOverlay(Graphics g)
        {
            // é€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼ï¼šç¹ªè£½å¤šé‚Šå½¢
            if (_editState.IsDrawingPassabilityPolygon && _editState.PassabilityPolygonPoints.Count > 0)
            {
                Color polygonColor = currentPassableEditMode == PassableEditMode.SetPassable ? Color.LimeGreen : Color.Red;

                using (Pen pen = new Pen(polygonColor, 3))
                {
                    for (int i = 0; i < _editState.PassabilityPolygonPoints.Count - 1; i++)
                    {
                        g.DrawLine(pen, _editState.PassabilityPolygonPoints[i], _editState.PassabilityPolygonPoints[i + 1]);
                    }
                    if (_editState.PassabilityPolygonPoints.Count >= 3)
                    {
                        using (Pen dashPen = new Pen(polygonColor, 2) { DashStyle = System.Drawing.Drawing2D.DashStyle.Dash })
                        {
                            g.DrawLine(dashPen, _editState.PassabilityPolygonPoints[_editState.PassabilityPolygonPoints.Count - 1], _editState.PassabilityPolygonPoints[0]);
                        }
                    }
                }

                using (SolidBrush brush = new SolidBrush(polygonColor))
                {
                    foreach (var pt in _editState.PassabilityPolygonPoints)
                    {
                        g.FillEllipse(brush, pt.X - 5, pt.Y - 5, 10, 10);
                    }
                }

                if (_editState.PassabilityPolygonPoints.Count >= 3)
                {
                    using (SolidBrush fillBrush = new SolidBrush(Color.FromArgb(50, polygonColor)))
                    {
                        g.FillPolygon(fillBrush, _editState.PassabilityPolygonPoints.ToArray());
                    }
                }
                return;
            }

            // æœ‰é¸ä¸­çš„æ ¼å­æ™‚ï¼Œç¹ªè£½å°é½Šæ ¼ç·šçš„è±å½¢é¸å–æ¡†
            if (_editState.SelectedCells.Count > 0)
            {
                Color color = isSelectingRegion ? Color.Green : Color.Orange;
                DrawSelectedCells(g, _editState.SelectedCells, color);

                if (isSelectingRegion)
                {
                    string info = $"é¸å– {_editState.SelectedCells.Count} æ ¼";
                    using (Font font = new Font("Arial", 10, FontStyle.Bold))
                    using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(180, Color.Black)))
                    using (SolidBrush textBrush = new SolidBrush(Color.White))
                    {
                        SizeF textSize = g.MeasureString(info, font);
                        float textX = regionEndPoint.X + 15;
                        float textY = regionEndPoint.Y - 20;
                        g.FillRectangle(bgBrush, textX - 2, textY - 2, textSize.Width + 4, textSize.Height + 4);
                        g.DrawString(info, font, textBrush, textX, textY);
                    }
                }
            }
        }

        #endregion

        // S32 åœ°åœ–é»æ“Šäº‹ä»¶ - æ›´æ–°é«˜äº®å’Œç‹€æ…‹åˆ—
        private void s32PictureBox_MouseClick(object sender, MouseEventArgs e)
        {
            var sw = Stopwatch.StartNew();
            LogPerf($"[MOUSE-CLICK] start, button={e.Button}, isDragging={isMainMapDragging}");

            // å¦‚æœæ­£åœ¨é¸æ“‡å€åŸŸï¼Œä¸è™•ç†é»æ“Š
            if (isSelectingRegion)
            {
                LogPerf($"[MOUSE-CLICK] skip - selecting region");
                return;
            }

            // ç²å–ç•¶å‰åœ°åœ–è³‡è¨Šä»¥è¨ˆç®—æ­£ç¢ºçš„ baseY
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
            {
                LogPerf($"[MOUSE-CLICK] skip - no map");
                return;
            }

            // å°‡é»æ“Šä½ç½®è½‰æ›ç‚ºä¸–ç•Œåº§æ¨™
            var worldPoint = S32ScreenToWorld(e.Location.X, e.Location.Y);
            int worldX = worldPoint.X;
            int worldY = worldPoint.Y;

            Console.WriteLine($"[Layer8-Debug] Screen=({e.Location.X},{e.Location.Y}) -> World=({worldX},{worldY}), ShowLayer8={_viewState.ShowLayer8}, Button={e.Button}");

            // Layer8 æ¨™è¨˜é»æ“Šè™•ç†
            if (_viewState.ShowLayer8 && e.Button == MouseButtons.Left)
            {
                var clickedMarker = FindLayer8MarkerAtPosition(worldX, worldY);
                if (clickedMarker.HasValue)
                {
                    var (s32Path, index) = clickedMarker.Value;

                    // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
                    if (_editState.EnabledLayer8Items.Contains((s32Path, index)))
                    {
                        _editState.EnabledLayer8Items.Remove((s32Path, index));
                        _layer8AnimFrame.Remove((s32Path, index));

                        // å¦‚æœæ²’æœ‰å•Ÿç”¨çš„é …ç›®ï¼Œåœæ­¢å‹•ç•«è¨ˆæ™‚å™¨
                        if (_editState.EnabledLayer8Items.Count == 0 && _layer8AnimTimer != null)
                        {
                            _layer8AnimTimer.Stop();
                        }
                    }
                    else
                    {
                        _editState.EnabledLayer8Items.Add((s32Path, index));
                        _layer8AnimFrame[(s32Path, index)] = 0;

                        // å•Ÿå‹•å‹•ç•«è¨ˆæ™‚å™¨
                        if (_layer8AnimTimer != null && !_layer8AnimTimer.Enabled)
                        {
                            _layer8AnimTimer.Start();
                        }
                    }

                    // é‡ç¹ª
                    RenderS32Map();
                    return;
                }
            }

            // ä½¿ç”¨å„ªåŒ–çš„æ ¼å­æŸ¥æ‰¾ï¼ˆå…ˆéæ¿¾ S32 ç¯„åœï¼Œæ¸›å°‘ 400x è¨ˆç®—é‡ï¼‰
            var result = CellFinder.FindCellOptimized(worldX, worldY, _document.S32Files.Values);
            LogPerf($"[MOUSE-CLICK] search done, found={result.Found}, elapsed={result.ElapsedMs}ms, s32Checked={result.S32Checked}, cellsChecked={result.CellsChecked}");

            if (result.Found)
            {
                var s32Data = result.S32Data;
                int x = result.CellX;
                int y = result.CellY;

                // è¨­ç½®ç•¶å‰é¸ä¸­çš„ S32 æª”æ¡ˆ
                currentS32FileItem = new S32FileItem
                {
                    FilePath = s32Data.FilePath,
                    SegInfo = s32Data.SegInfo
                };

                // è¨˜éŒ„é¸ä¸­çš„æ ¼å­ä¸¦æ›´æ–°ç‹€æ…‹åˆ—é¡¯ç¤ºç¬¬ä¸‰å±¤å±¬æ€§
                _editState.HighlightedS32Data = s32Data;
                _editState.HighlightedCellX = x;
                _editState.HighlightedCellY = y;
                UpdateStatusBarWithLayer3Info(s32Data, x, y);

                // é€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼ï¼šå–®æ“Šè¨­å®šé€šè¡Œæ€§
                if (currentPassableEditMode != PassableEditMode.None && e.Button == MouseButtons.Left)
                {
                    SetCellPassable(s32Data, x, y, currentPassableEditMode == PassableEditMode.SetPassable);
                    return;
                }

                // å€åŸŸç·¨è¼¯æ¨¡å¼ï¼šå³éµè®Šæ›´é¸å–å€åŸŸçš„å€åŸŸé¡å‹
                if (currentRegionEditMode != RegionEditMode.None && e.Button == MouseButtons.Right)
                {
                    if (_editState.SelectedCells.Count > 0)
                    {
                        SetSelectedCellsRegionType(currentRegionType);
                    }
                    return;
                }

                // ç´ æè²¼ä¸Šæ¨¡å¼ï¼šé»æ“Šè²¼ä¸Šç´ æ
                if (_pendingMaterial != null && e.Button == MouseButtons.Left)
                {
                    // ä½¿ç”¨ CoordinateHelper è½‰æ› Layer1 æœ¬åœ°åº§æ¨™ç‚ºéŠæˆ²åº§æ¨™
                    var (gameX, gameY) = CoordinateHelper.LocalToGameCoords(s32Data, x, y);
                    PasteMaterialAtPosition(gameX, gameY);
                    return;
                }

                // Ctrl + å·¦éµï¼šåˆªé™¤è©²æ ¼å­çš„æ‰€æœ‰ç¬¬å››å±¤ç‰©ä»¶
                if (e.Button == MouseButtons.Left && ModifierKeys == Keys.Control)
                {
                    DeleteAllLayer4ObjectsAtCell(x, y);
                }
                else
                {
                    // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé«˜äº®
                    RenderS32Map();

                    // é€æ˜ç·¨è¼¯æ¨¡å¼ä¸‹ï¼šé¡¯ç¤ºé™„è¿‘ç¾¤çµ„ç¸®åœ–
                    if (_editState.IsLayer5EditMode)
                    {
                        UpdateNearbyGroupThumbnails(s32Data, x, y, 10);
                    }
                    else
                    {
                        // éé€æ˜ç·¨è¼¯æ¨¡å¼ï¼Œä¸éœ€è¦æ›´æ–°ç¾¤çµ„æ¸…å–®
                    }
                }
                sw.Stop();
                LogPerf($"[MOUSE-CLICK] found cell, total={sw.ElapsedMilliseconds}ms");
                return;
            }

            sw.Stop();
            LogPerf($"[MOUSE-CLICK] no cell found, total={sw.ElapsedMilliseconds}ms, s32Count={_document.S32Files.Count}");
        }

        // S32 åœ°åœ–é›™æ“Šäº‹ä»¶ - é¡¯ç¤ºæ ¼å­è©³ç´°è³‡è¨Šæˆ–æ–°å¢ S32
        private void s32PictureBox_MouseDoubleClick(object sender, MouseEventArgs e)
        {
            // ç²å–ç•¶å‰åœ°åœ–è³‡è¨Š
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return;

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // å°‡é»æ“Šä½ç½®è½‰æ›ç‚ºä¸–ç•Œåº§æ¨™ï¼ˆè€ƒæ…®ç¸®æ”¾å’Œæ²å‹•ä½ç½®ï¼‰
            int worldX = (int)(e.Location.X / s32ZoomLevel) + _viewState.ScrollX;
            int worldY = (int)(e.Location.Y / s32ZoomLevel) + _viewState.ScrollY;

            // ä½¿ç”¨å„ªåŒ–çš„æ ¼å­æŸ¥æ‰¾
            var result = CellFinder.FindCellOptimized(worldX, worldY, _document.S32Files.Values);

            if (result.Found)
            {
                var s32Data = result.S32Data;
                int x = result.CellX;
                int y = result.CellY;

                // è¨­ç½®ç•¶å‰é¸ä¸­çš„ S32 æª”æ¡ˆ
                currentS32FileItem = new S32FileItem
                {
                    FilePath = s32Data.FilePath,
                    SegInfo = s32Data.SegInfo
                };

                // è¨˜éŒ„é¸ä¸­çš„æ ¼å­
                _editState.HighlightedS32Data = s32Data;
                _editState.HighlightedCellX = x;
                _editState.HighlightedCellY = y;

                // é¡¯ç¤ºæ ¼å­è©³ç´°è³‡æ–™
                ShowCellLayersDialog(x, y);
                return;
            }

            // å¦‚æœæ²’æœ‰é›™æ“Šåˆ°ä»»ä½• S32 å€å¡Šï¼Œæª¢æŸ¥æ˜¯å¦è¦æ–°å¢ S32
            if (e.Button == MouseButtons.Left)
            {
                Point adjustedLocation = new Point(worldX, worldY);
                TryCreateS32AtClickPosition(adjustedLocation, currentMap);
            }
        }

        // å˜—è©¦åœ¨é»æ“Šä½ç½®å‰µå»ºæ–°çš„ S32
        private void TryCreateS32AtClickPosition(Point clickPos, Struct.L1Map currentMap)
        {
            // å¾é»æ“Šåƒç´ ä½ç½®åæ¨ Block åº§æ¨™
            // GetLoc å…¬å¼ï¼š
            // baseX = 0;
            // baseY = (nMapBlockCountX - 1) * blockHeight / 2;
            // mx = blockX * blockWidth + my * 2 - blockX * blockWidth / 2 - blockY * blockWidth / 2;
            // my = baseY + blockY * blockHeight - blockX * blockHeight / 2 - blockY * blockHeight / 2;
            //
            // ç°¡åŒ–ï¼šå°æ–¼è±å½¢åœ°åœ–ï¼Œä½¿ç”¨ä¸€å€‹åƒè€ƒé»ä¾†è¨ˆç®—
            // å–å¾—ä¸€å€‹å·²çŸ¥ S32 çš„ä½ç½®ä½œç‚ºåƒè€ƒ

            if (_document.S32Files.Count == 0)
            {
                // å¦‚æœæ²’æœ‰ä»»ä½• S32ï¼Œä½¿ç”¨åœ°åœ–çš„ Min Block ä½œç‚ºåŸºæº–
                int defaultBlockX = currentMap.nMinBlockX != 0xFFFF ? currentMap.nMinBlockX : 0x7FFF;
                int defaultBlockY = currentMap.nMinBlockY != 0xFFFF ? currentMap.nMinBlockY : 0x8000;
                CreateNewS32AtBlock(defaultBlockX, defaultBlockY, currentMap);
                return;
            }

            // å–å¾—ç¬¬ä¸€å€‹ S32 ä½œç‚ºåƒè€ƒé»
            var refS32 = _document.S32Files.Values.First();
            int[] refLoc = refS32.SegInfo.GetLoc(1.0);
            int refMx = refLoc[0];
            int refMy = refLoc[1];
            int refBlockX = refS32.SegInfo.nBlockX - currentMap.nMinBlockX;
            int refBlockY = refS32.SegInfo.nBlockY - currentMap.nMinBlockY;

            // æ¯å€‹ S32 å€å¡Šçš„åƒç´ å¤§å°
            int blockWidth = 64 * 24 * 2;  // 3072
            int blockHeight = 64 * 12 * 2; // 1536

            // åƒè€ƒ S32 çš„ä¸­å¿ƒåƒç´ ä½ç½®
            int refCenterX = refMx + blockWidth / 2;
            int refCenterY = refMy + blockHeight / 2;

            // è¨ˆç®—é»æ“Šä½ç½®ç›¸å°æ–¼åƒè€ƒ S32 çš„åç§»é‡ï¼ˆåƒç´ ï¼‰
            int deltaPixelX = clickPos.X - refCenterX;
            int deltaPixelY = clickPos.Y - refCenterY;

            // è±å½¢åº§æ¨™ç³»è½‰æ›ï¼š
            // æ ¹æ“š GetLoc å…¬å¼ï¼š
            // mx = baseX + blockX*W - blockX*W/2 - blockY*W/2 + blockY*W = baseX + blockX*W/2 + blockY*W/2
            // my = baseY + blockY*H - blockX*H/2 - blockY*H/2 = baseY - blockX*H/2 + blockY*H/2
            //
            // æ‰€ä»¥ï¼š
            // deltaPixelX = (dBx + dBy) * blockWidth/2
            // deltaPixelY = (-dBx + dBy) * blockHeight/2
            //
            // åæ¨ï¼š
            // dBx + dBy = deltaPixelX * 2 / blockWidth
            // -dBx + dBy = deltaPixelY * 2 / blockHeight
            // 2*dBy = deltaPixelX * 2 / blockWidth + deltaPixelY * 2 / blockHeight
            // 2*dBx = deltaPixelX * 2 / blockWidth - deltaPixelY * 2 / blockHeight

            double sumDelta = (double)deltaPixelX * 2 / blockWidth;
            double diffDelta = (double)deltaPixelY * 2 / blockHeight;

            int deltaBlockX = (int)Math.Round((sumDelta - diffDelta) / 2);
            int deltaBlockY = (int)Math.Round((sumDelta + diffDelta) / 2);

            // è¨ˆç®—ç›®æ¨™ Block åº§æ¨™
            int targetRelBlockX = refBlockX + deltaBlockX;
            int targetRelBlockY = refBlockY + deltaBlockY;

            int targetBlockX = currentMap.nMinBlockX + targetRelBlockX;
            int targetBlockY = currentMap.nMinBlockY + targetRelBlockY;

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            string fileName = $"{targetBlockX:X4}{targetBlockY:X4}.s32".ToLower();
            string filePath = Path.Combine(currentMap.szFullDirName, fileName);

            if (File.Exists(filePath) || _document.S32Files.Keys.Any(k => k.EndsWith(fileName, StringComparison.OrdinalIgnoreCase)))
            {
                // å·²å­˜åœ¨ï¼Œé¡¯ç¤ºæç¤º
                this.toolStripStatusLabel1.Text = $"S32 å·²å­˜åœ¨: {fileName}";
                return;
            }

            // å‰µå»ºæ–° S32
            CreateNewS32AtBlock(targetBlockX, targetBlockY, currentMap);
        }

        // åœ¨æŒ‡å®š Block åº§æ¨™å‰µå»ºæ–°çš„ S32
        private void CreateNewS32AtBlock(int blockX, int blockY, Struct.L1Map currentMap)
        {
            string fileName = $"{blockX:X4}{blockY:X4}.s32".ToLower();
            string filePath = Path.Combine(currentMap.szFullDirName, fileName);

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (File.Exists(filePath))
            {
                MessageBox.Show($"S32 æª”æ¡ˆå·²å­˜åœ¨: {fileName}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (_document.S32Files.Keys.Any(k => k.EndsWith(fileName, StringComparison.OrdinalIgnoreCase)))
            {
                MessageBox.Show($"S32 æª”æ¡ˆå·²è¼‰å…¥: {fileName}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            // è¨ˆç®—éŠæˆ²åº§æ¨™ç¯„åœ
            int linEndX = (blockX - 0x7FFF) * 64 + 0x7FFF;
            int linEndY = (blockY - 0x7FFF) * 64 + 0x7FFF;
            int linBeginX = linEndX - 64 + 1;
            int linBeginY = linEndY - 64 + 1;

            // ç¢ºèªæ–°å¢
            var confirmResult = MessageBox.Show(
                $"è¦åœ¨æ­¤ä½ç½®æ–°å¢ S32 å€å¡Šå—ï¼Ÿ\n\n" +
                $"æª”æ¡ˆåç¨±: {fileName}\n" +
                $"Blockåº§æ¨™: ({blockX:X4}, {blockY:X4})\n" +
                $"éŠæˆ²åº§æ¨™: ({linBeginX},{linBeginY}) ~ ({linEndX},{linEndY})\n" +
                $"è·¯å¾‘: {filePath}",
                "æ–°å¢ S32",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question);

            if (confirmResult != DialogResult.Yes) return;

            // å‰µå»ºç©ºçš„ S32 è³‡æ–™
            S32Data newS32Data = CreateEmptyS32Data(blockX, blockY, filePath);

            // å‰µå»º SegInfo
            Struct.L1MapSeg segInfo = new Struct.L1MapSeg(blockX, blockY, true);
            segInfo.isRemastered = false;
            segInfo.nMapMinBlockX = currentMap.nMinBlockX;
            segInfo.nMapMinBlockY = currentMap.nMinBlockY;
            segInfo.nMapBlockCountX = currentMap.nBlockCountX;

            newS32Data.SegInfo = segInfo;
            newS32Data.IsModified = true;

            // åŠ å…¥åˆ°è¨˜æ†¶é«”ï¼ˆå…ˆåŠ å…¥æ‰èƒ½ç”¨ SaveS32Fileï¼‰
            _document.S32Files[filePath] = newS32Data;

            // å¯«å…¥æª”æ¡ˆ
            try
            {
                SaveS32File(filePath);  // ä½¿ç”¨æ­£ç¢ºæ ¼å¼çš„ä¿å­˜æ–¹æ³•
            }
            catch (Exception ex)
            {
                // ç§»é™¤å¤±æ•—çš„ S32
                _document.S32Files.Remove(filePath);
                MessageBox.Show($"å¯«å…¥æª”æ¡ˆå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            // åŠ å…¥åˆ° FullFileNameList
            currentMap.FullFileNameList[filePath] = segInfo;

            // æ›´æ–°åœ°åœ–é‚Šç•Œï¼ˆå¦‚æœæ–°çš„ S32 è¶…å‡ºç¾æœ‰é‚Šç•Œï¼‰
            if (blockX < currentMap.nMinBlockX || blockX > currentMap.nMaxBlockX ||
                blockY < currentMap.nMinBlockY || blockY > currentMap.nMaxBlockY)
            {
                currentMap.nMinBlockX = Math.Min(currentMap.nMinBlockX, blockX);
                currentMap.nMinBlockY = Math.Min(currentMap.nMinBlockY, blockY);
                currentMap.nMaxBlockX = Math.Max(currentMap.nMaxBlockX, blockX);
                currentMap.nMaxBlockY = Math.Max(currentMap.nMaxBlockY, blockY);
                currentMap.nBlockCountX = currentMap.nMaxBlockX - currentMap.nMinBlockX + 1;
                currentMap.nBlockCountY = currentMap.nMaxBlockY - currentMap.nMinBlockY + 1;
                currentMap.nLinLengthX = currentMap.nBlockCountX * 64;
                currentMap.nLinLengthY = currentMap.nBlockCountY * 64;
                currentMap.nLinEndX = (currentMap.nMaxBlockX - 0x7FFF) * 64 + 0x7FFF;
                currentMap.nLinEndY = (currentMap.nMaxBlockY - 0x7FFF) * 64 + 0x7FFF;
                currentMap.nLinBeginX = currentMap.nLinEndX - currentMap.nLinLengthX + 1;
                currentMap.nLinBeginY = currentMap.nLinEndY - currentMap.nLinLengthY + 1;

                // æ›´æ–°æ‰€æœ‰ SegInfo çš„å…±äº«å€¼
                foreach (var seg in currentMap.FullFileNameList.Values)
                {
                    seg.nMapMinBlockX = currentMap.nMinBlockX;
                    seg.nMapMinBlockY = currentMap.nMinBlockY;
                    seg.nMapBlockCountX = currentMap.nBlockCountX;
                }
            }

            // åŠ å…¥åˆ° UI æ¸…å–®
            string displayName = $"{fileName} ({blockX:X4},{blockY:X4}) [{segInfo.nLinBeginX},{segInfo.nLinBeginY}~{segInfo.nLinEndX},{segInfo.nLinEndY}]";
            S32FileItem item = new S32FileItem
            {
                FilePath = filePath,
                DisplayName = displayName,
                SegInfo = segInfo,
                IsChecked = true
            };
            int index = lstS32Files.Items.Add(item);
            lstS32Files.SetItemChecked(index, true);

            // é‡æ–°æ¸²æŸ“åœ°åœ–
            RenderS32Map();

            this.toolStripStatusLabel1.Text = $"å·²æ–°å¢ S32: {fileName}";
        }

        // æ›´æ–°ç‹€æ…‹åˆ—é¡¯ç¤ºç¬¬ä¸‰å±¤å±¬æ€§è³‡è¨Š
        private void UpdateStatusBarWithLayer3Info(S32Data s32Data, int cellX, int cellY)
        {
            // è¨ˆç®—ç¬¬ä¸‰å±¤åº§æ¨™ï¼ˆç¬¬ä¸‰å±¤æ˜¯ 64x64ï¼Œç¬¬ä¸€å±¤æ˜¯ 64x128ï¼‰
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;

            // è¨ˆç®—éŠæˆ²åº§æ¨™ï¼ˆLayer3 å°ºåº¦ï¼Œèˆ‡å·²é¸å–å€åŸŸé‚è¼¯ä¸€è‡´ï¼‰
            // å·²é¸å–å€åŸŸç”¨: globalLayer1X = nLinBeginX * 2 + LocalX
            // éŠæˆ²åº§æ¨™ = globalLayer1X / 2 = nLinBeginX + LocalX / 2 = nLinBeginX + layer3X
            int gameX = s32Data.SegInfo.nLinBeginX + layer3X;
            int gameY = s32Data.SegInfo.nLinBeginY + cellY;

            // æ›´æ–°é¸ä¸­çš„éŠæˆ²åº§æ¨™ï¼ˆç”¨æ–¼è¤‡è£½ç§»å‹•æŒ‡ä»¤ï¼‰
            _editState.SelectedGameX = gameX;
            _editState.SelectedGameY = gameY;
            toolStripCopyMoveCmd.Enabled = true;
            toolStripCopyMoveCmd.Text = $"ç§»å‹• {gameX} {gameY} {_document.MapId}";

            // å–å¾— S32 æª”å
            string s32FileName = Path.GetFileName(s32Data.FilePath);

            // å–å¾—ç›¸å°æ–¼ client çš„è·¯å¾‘
            string s32RelativePath = s32Data.FilePath;
            int clientIndex = s32RelativePath.IndexOf("\\client\\", StringComparison.OrdinalIgnoreCase);
            if (clientIndex >= 0)
            {
                s32RelativePath = s32RelativePath.Substring(clientIndex + 1);  // å¾ "client\" é–‹å§‹
            }

            // S32 é‚Šç•Œçš„éŠæˆ²åº§æ¨™ï¼ˆå››å€‹è§’è½ï¼‰
            int linBeginX = s32Data.SegInfo.nLinBeginX;
            int linBeginY = s32Data.SegInfo.nLinBeginY;
            int linEndX = s32Data.SegInfo.nLinEndX;
            int linEndY = s32Data.SegInfo.nLinEndY;

            // å–å¾— GetLoc è¿”å›å€¼ç”¨æ–¼é™¤éŒ¯
            int[] loc = s32Data.SegInfo.GetLoc(1.0);
            int mx = loc[0];
            int my = loc[1];

            string boundaryInfo = $"S32é‚Šç•Œ: [{linBeginX},{linBeginY}~{linEndX},{linEndY}] GetLoc=({mx},{my}) Block=({s32Data.SegInfo.nBlockX:X4},{s32Data.SegInfo.nBlockY:X4})";

            // å–å¾—å„å±¤è³‡è¨Š
            string layersInfo = $"L5:{s32Data.Layer5.Count} L6:{s32Data.Layer6.Count} L7:{s32Data.Layer7.Count} L8:{s32Data.Layer8.Count}";

            var attr = s32Data.Layer3[cellY, layer3X];
            if (attr != null)
            {
                this.toolStripStatusLabel1.Text = $"æ ¼å­({cellX},{cellY}) éŠæˆ²åº§æ¨™({gameX},{gameY}) | ç¬¬3å±¤[{layer3X},{cellY}]: Attr1={attr.Attribute1} (0x{attr.Attribute1:X4}) Attr2={attr.Attribute2} (0x{attr.Attribute2:X4}) | {layersInfo} | {s32RelativePath}";
            }
            else
            {
                this.toolStripStatusLabel1.Text = $"æ ¼å­({cellX},{cellY}) éŠæˆ²åº§æ¨™({gameX},{gameY}) | ç¬¬3å±¤: ç„¡è³‡æ–™ | {layersInfo} | {s32RelativePath}";
            }
        }

        // è¨­å®šå–®å€‹æ ¼å­çš„é€šè¡Œæ€§
        private void SetCellPassable(S32Data s32Data, int cellX, int cellY, bool passable)
        {
            // è¨ˆç®—ç¬¬ä¸‰å±¤åº§æ¨™ï¼ˆç¬¬ä¸‰å±¤æ˜¯ 64x64ï¼Œç¬¬ä¸€å±¤æ˜¯ 64x128ï¼‰
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;

            // è¨ˆç®—éŠæˆ²åº§æ¨™ï¼ˆLayer3 å°ºåº¦ï¼‰
            int gameX = s32Data.SegInfo.nLinBeginX + layer3X;
            int gameY = s32Data.SegInfo.nLinBeginY + cellY;

            // è¨­å®šé€šè¡Œæ€§å±¬æ€§
            if (s32Data.Layer3[cellY, layer3X] == null)
            {
                s32Data.Layer3[cellY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
            }

            if (passable)
            {
                // æ¸…é™¤ä¸å¯é€šè¡Œå±¬æ€§ï¼ˆAttribute1 & Attribute2 çš„ 0x01 ä½å…ƒï¼‰
                s32Data.Layer3[cellY, layer3X].Attribute1 = (short)(s32Data.Layer3[cellY, layer3X].Attribute1 & ~0x01);
                s32Data.Layer3[cellY, layer3X].Attribute2 = (short)(s32Data.Layer3[cellY, layer3X].Attribute2 & ~0x01);
                this.toolStripStatusLabel1.Text = $"å·²è¨­å®š ({gameX},{gameY}) ç‚ºå¯é€šè¡Œ";
            }
            else
            {
                // è¨­å®šä¸å¯é€šè¡Œå±¬æ€§ï¼ˆAttribute1 & Attribute2 çš„ 0x01 ä½å…ƒï¼‰
                s32Data.Layer3[cellY, layer3X].Attribute1 = (short)(s32Data.Layer3[cellY, layer3X].Attribute1 | 0x01);
                s32Data.Layer3[cellY, layer3X].Attribute2 = (short)(s32Data.Layer3[cellY, layer3X].Attribute2 | 0x01);
                this.toolStripStatusLabel1.Text = $"å·²è¨­å®š ({gameX},{gameY}) ç‚ºä¸å¯é€šè¡Œ";
            }

            s32Data.IsModified = true;
            RenderS32Map();
        }

        // æ‰¹æ¬¡è¨­å®šå€åŸŸé€šè¡Œæ€§
        private void SetRegionPassable(List<SelectedCell> cells, bool passable)
        {
            int modifiedCount = 0;
            HashSet<S32Data> modifiedS32Files = new HashSet<S32Data>();

            foreach (var cell in cells)
            {
                // è¨ˆç®—ç¬¬ä¸‰å±¤åº§æ¨™ï¼ˆç¬¬ä¸‰å±¤æ˜¯ 64x64ï¼Œç¬¬ä¸€å±¤æ˜¯ 64x128ï¼‰
                int layer3X = cell.LocalX / 2;
                if (layer3X >= 64) layer3X = 63;

                // è¨­å®šé€šè¡Œæ€§å±¬æ€§
                if (cell.S32Data.Layer3[cell.LocalY, layer3X] == null)
                {
                    cell.S32Data.Layer3[cell.LocalY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                }

                if (passable)
                {
                    // æ¸…é™¤ä¸å¯é€šè¡Œå±¬æ€§ï¼ˆAttribute1 & Attribute2 çš„ 0x01 ä½å…ƒï¼‰
                    cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute1 = (short)(cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute1 & ~0x01);
                    cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute2 = (short)(cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute2 & ~0x01);
                }
                else
                {
                    // è¨­å®šä¸å¯é€šè¡Œå±¬æ€§ï¼ˆAttribute1 & Attribute2 çš„ 0x01 ä½å…ƒï¼‰
                    cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute1 = (short)(cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute1 | 0x01);
                    cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute2 = (short)(cell.S32Data.Layer3[cell.LocalY, layer3X].Attribute2 | 0x01);
                }

                modifiedCount++;
                modifiedS32Files.Add(cell.S32Data);
            }

            // æ¨™è¨˜æ‰€æœ‰ä¿®æ”¹éçš„ S32 æª”æ¡ˆ
            foreach (var s32Data in modifiedS32Files)
            {
                s32Data.IsModified = true;
            }

            RenderS32Map();
            this.toolStripStatusLabel1.Text = $"å·²æ‰¹æ¬¡è¨­å®š {modifiedCount} å€‹æ ¼å­ç‚º{(passable ? "å¯é€šè¡Œ" : "ä¸å¯é€šè¡Œ")} (å½±éŸ¿ {modifiedS32Files.Count} å€‹ S32 æª”æ¡ˆ)";
        }

        // å¤šé‚Šå½¢é€šè¡Œæ€§è¨­å®šï¼šæ‰¾å‡ºå¤šé‚Šå½¢å…§çš„æ ¼å­é‚Šç•Œï¼Œè¨­å®šå°æ‡‰çš„é€šè¡Œå±¬æ€§
        private void SetPolygonPassable(List<Point> polygonPoints, bool passable)
        {
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return;

            if (polygonPoints.Count < 3)
            {
                this.toolStripStatusLabel1.Text = "å¤šé‚Šå½¢è‡³å°‘éœ€è¦ 3 å€‹é ‚é»";
                return;
            }

            // å°‡è¢å¹•åº§æ¨™è½‰æ›ç‚ºä¸–ç•Œåº§æ¨™ï¼ˆè€ƒæ…®ç¸®æ”¾å’Œæ²å‹•åç§»ï¼‰
            var scaledPolygon = polygonPoints.Select(p => new PointF(
                (float)(p.X / s32ZoomLevel) + _viewState.ScrollX,
                (float)(p.Y / s32ZoomLevel) + _viewState.ScrollY
            )).ToArray();

            // æ”¶é›†å¤šé‚Šå½¢å…§çš„é‚Šç•Œè³‡è¨Š (S32Data, layer3X, layer3Y, isAttribute1)
            var includedEdges = new List<(S32Data s32, int layer3X, int layer3Y, bool isAttribute1)>();

            // éæ­·æ‰€æœ‰ S32 çš„æ‰€æœ‰æ ¼å­ï¼Œæª¢æŸ¥é‚Šç•Œä¸­é»æ˜¯å¦åœ¨å¤šé‚Šå½¢å…§
            foreach (var s32Data in _document.S32Files.Values)
            {
                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                // Layer3 æ˜¯ 64x64
                for (int layer3Y = 0; layer3Y < 64; layer3Y++)
                {
                    for (int layer3X = 0; layer3X < 64; layer3X++)
                    {
                        // Layer3 åº§æ¨™è½‰ Layer1 åº§æ¨™ï¼ˆå–å¶æ•¸ xï¼‰
                        int x1 = layer3X * 2;

                        // èˆ‡ DrawPassabilityOverlay å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—
                        int localBaseX = 0;
                        int localBaseY = 63 * 12;
                        localBaseX -= 24 * (x1 / 2);
                        localBaseY -= 12 * (x1 / 2);

                        int X = mx + localBaseX + x1 * 24 + layer3Y * 24;
                        int Y = my + localBaseY + layer3Y * 12;

                        // Layer3 è±å½¢çš„å››å€‹é ‚é»ï¼ˆ48x24ï¼Œèˆ‡ DrawPassabilityOverlay ä¸€è‡´ï¼‰
                        float pLeftX = X + 0, pLeftY = Y + 12;       // å·¦
                        float pTopX = X + 24, pTopY = Y + 0;         // ä¸Š
                        float pRightX = X + 48, pRightY = Y + 12;    // å³

                        // è¨ˆç®—å·¦ä¸Šé‚Šçš„ä¸­é»
                        float leftTopMidX = (pLeftX + pTopX) / 2;
                        float leftTopMidY = (pLeftY + pTopY) / 2;

                        // è¨ˆç®—å³ä¸Šé‚Šçš„ä¸­é»
                        float rightTopMidX = (pTopX + pRightX) / 2;
                        float rightTopMidY = (pTopY + pRightY) / 2;

                        // æª¢æŸ¥å·¦ä¸Šé‚Šä¸­é»æ˜¯å¦åœ¨å¤šé‚Šå½¢å…§
                        if (IsPointInPolygon(leftTopMidX, leftTopMidY, scaledPolygon))
                        {
                            includedEdges.Add((s32Data, layer3X, layer3Y, true));  // Attribute1
                        }

                        // æª¢æŸ¥å³ä¸Šé‚Šä¸­é»æ˜¯å¦åœ¨å¤šé‚Šå½¢å…§
                        if (IsPointInPolygon(rightTopMidX, rightTopMidY, scaledPolygon))
                        {
                            includedEdges.Add((s32Data, layer3X, layer3Y, false)); // Attribute2
                        }
                    }
                }
            }

            // å»é™¤é‡è¤‡
            var uniqueEdges = includedEdges.Distinct().ToList();

            if (uniqueEdges.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "å¤šé‚Šå½¢å…§æ²’æœ‰ä»»ä½•æ ¼å­é‚Šç•Œ";
                return;
            }

            // è¨­å®šé€šè¡Œæ€§
            int modifiedCount = 0;
            HashSet<S32Data> modifiedS32Files = new HashSet<S32Data>();

            foreach (var (s32Data, layer3X, layer3Y, isAttribute1) in uniqueEdges)
            {
                if (s32Data.Layer3[layer3Y, layer3X] == null)
                {
                    s32Data.Layer3[layer3Y, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                }

                if (isAttribute1)
                {
                    if (passable)
                        s32Data.Layer3[layer3Y, layer3X].Attribute1 = (short)(s32Data.Layer3[layer3Y, layer3X].Attribute1 & ~0x01);
                    else
                        s32Data.Layer3[layer3Y, layer3X].Attribute1 = (short)(s32Data.Layer3[layer3Y, layer3X].Attribute1 | 0x01);
                }
                else
                {
                    if (passable)
                        s32Data.Layer3[layer3Y, layer3X].Attribute2 = (short)(s32Data.Layer3[layer3Y, layer3X].Attribute2 & ~0x01);
                    else
                        s32Data.Layer3[layer3Y, layer3X].Attribute2 = (short)(s32Data.Layer3[layer3Y, layer3X].Attribute2 | 0x01);
                }

                modifiedCount++;
                modifiedS32Files.Add(s32Data);
            }

            // æ¨™è¨˜æ‰€æœ‰ä¿®æ”¹éçš„ S32 æª”æ¡ˆ
            foreach (var s32Data in modifiedS32Files)
            {
                s32Data.IsModified = true;
            }

            RenderS32Map();
            this.toolStripStatusLabel1.Text = $"å·²è¨­å®š {modifiedCount} å€‹é‚Šç•Œç‚º{(passable ? "å¯é€šè¡Œ" : "ä¸å¯é€šè¡Œ")} (å½±éŸ¿ {modifiedS32Files.Count} å€‹ S32 æª”æ¡ˆ)";
        }

        // æª¢æŸ¥é»æ˜¯å¦åœ¨å¤šé‚Šå½¢å…§ï¼ˆå°„ç·šæ³•ï¼‰
        private bool IsPointInPolygon(float px, float py, PointF[] polygon)
        {
            bool inside = false;
            int j = polygon.Length - 1;

            for (int i = 0; i < polygon.Length; i++)
            {
                if ((polygon[i].Y < py && polygon[j].Y >= py || polygon[j].Y < py && polygon[i].Y >= py)
                    && (polygon[i].X <= px || polygon[j].X <= px))
                {
                    if (polygon[i].X + (py - polygon[i].Y) / (polygon[j].Y - polygon[i].Y) * (polygon[j].X - polygon[i].X) < px)
                    {
                        inside = !inside;
                    }
                }
                j = i;
            }

            return inside;
        }

        // S32 åœ°åœ–é¼ æ¨™æŒ‰ä¸‹äº‹ä»¶ - é–‹å§‹å€åŸŸé¸æ“‡æˆ–æ‹–æ‹½ç§»å‹•
        private void s32PictureBox_MouseDown(object sender, MouseEventArgs e)
        {
            // é»æ“Šä¸»åœ°åœ–æ™‚æ¸…é™¤å°åœ°åœ–ç„¦é»
            isMiniMapFocused = false;

            // ä¸­éµæ‹–æ‹½ç§»å‹•è¦–åœ–
            if (e.Button == MouseButtons.Middle)
            {
                isMainMapDragging = true;
                mainMapDragStartPoint = e.Location;
                // ä½¿ç”¨ ViewState çš„æ²å‹•ä½ç½®
                mainMapDragStartScroll = new Point(_viewState.ScrollX, _viewState.ScrollY);
                this._mapViewerControl.Cursor = Cursors.SizeAll;

                // åœæ­¢æ¸²æŸ“è¨ˆæ™‚å™¨ï¼Œé¿å…æ‹–æ›³ä¸­è§¸ç™¼æ–°æ¸²æŸ“
                dragRenderTimer.Stop();

                // å–æ¶ˆæ­£åœ¨é€²è¡Œçš„èƒŒæ™¯æ¸²æŸ“ï¼ˆé‡‹æ”¾ GDI+ é–ï¼Œé¿å… UI å‡çµï¼‰
                if (_isRendering)
                {
                    LogPerf($"[DRAG-START] Cancelling render...");
                    lock (_viewportRenderLock)
                    {
                        _viewportRenderCts?.Cancel();
                    }
                }
                else
                {
                    LogPerf($"[DRAG-START] No render in progress");
                }

                // é‡ç½®æ‹–æ›³æ•ˆèƒ½è¨ˆæ•¸å™¨
                _dragMoveCount = 0;
                _dragPaintCount = 0;
                _dragSessionSw.Restart();
                return;
            }

            // å…ˆæª¢æŸ¥ Layer8 marker é»æ“Šï¼ˆä¸éœ€è¦é¸å– S32ï¼‰
            if (e.Button == MouseButtons.Left && Control.ModifierKeys == Keys.None && _viewState.ShowLayer8)
            {
                var worldPoint = S32ScreenToWorld(e.Location.X, e.Location.Y);
                var clickedMarker = FindLayer8MarkerAtPosition(worldPoint.X, worldPoint.Y);
                if (clickedMarker.HasValue)
                {
                    var (s32Path, index) = clickedMarker.Value;
                    Console.WriteLine($"[Layer8] Clicked marker: {s32Path} index={index}");

                    // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
                    if (_editState.EnabledLayer8Items.Contains((s32Path, index)))
                    {
                        _editState.EnabledLayer8Items.Remove((s32Path, index));
                        _layer8AnimFrame.Remove((s32Path, index));

                        if (_editState.EnabledLayer8Items.Count == 0 && _layer8AnimTimer != null)
                        {
                            _layer8AnimTimer.Stop();
                        }
                        Console.WriteLine($"[Layer8] Disabled marker");
                    }
                    else
                    {
                        _editState.EnabledLayer8Items.Add((s32Path, index));
                        _layer8AnimFrame[(s32Path, index)] = 0;

                        if (_layer8AnimTimer != null && !_layer8AnimTimer.Enabled)
                        {
                            _layer8AnimTimer.Start();
                        }
                        Console.WriteLine($"[Layer8] Enabled marker, total enabled: {_editState.EnabledLayer8Items.Count}");
                    }

                    // é‡ç¹ª
                    RenderS32Map();
                    return;
                }
            }

            if (currentS32Data == null || currentS32FileItem == null)
                return;

            // Ctrl + å·¦éµ + é€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼ï¼šç¹ªè£½å¤šé‚Šå½¢é ‚é»
            if (e.Button == MouseButtons.Left && Control.ModifierKeys == Keys.Control && currentPassableEditMode != PassableEditMode.None)
            {
                _editState.IsDrawingPassabilityPolygon = true;
                _editState.PassabilityPolygonPoints.Add(e.Location);
                _mapViewerControl.Refresh();
                this.toolStripStatusLabel1.Text = $"å¤šé‚Šå½¢é ‚é»: {_editState.PassabilityPolygonPoints.Count} å€‹ (Ctrl+å·¦éµç¹¼çºŒæ–°å¢ï¼Œå³éµå®Œæˆ)";
                return;
            }
            // å³éµå®Œæˆå¤šé‚Šå½¢ç¹ªè£½
            if (e.Button == MouseButtons.Right && _editState.IsDrawingPassabilityPolygon && _editState.PassabilityPolygonPoints.Count >= 3)
            {
                // ç¢ºä¿é¡¯ç¤ºé€šè¡Œæ€§è¦†è“‹å±¤ï¼Œä»¥ä¾¿çœ‹åˆ°ä¿®æ”¹çµæœ
                EnsurePassabilityLayerVisible();
                SetPolygonPassable(_editState.PassabilityPolygonPoints, currentPassableEditMode == PassableEditMode.SetPassable);
                _editState.PassabilityPolygonPoints.Clear();
                _editState.IsDrawingPassabilityPolygon = false;
                _mapViewerControl.Refresh();
                return;
            }
            // å³éµå–æ¶ˆå¤šé‚Šå½¢ç¹ªè£½ï¼ˆé ‚é»ä¸è¶³ï¼‰
            if (e.Button == MouseButtons.Right && _editState.IsDrawingPassabilityPolygon)
            {
                _editState.PassabilityPolygonPoints.Clear();
                _editState.IsDrawingPassabilityPolygon = false;
                _mapViewerControl.Refresh();
                this.toolStripStatusLabel1.Text = "å·²å–æ¶ˆå¤šé‚Šå½¢ç¹ªè£½";
                return;
            }
            // å·¦éµï¼šé–‹å§‹å€åŸŸé¸æ“‡ï¼ˆLayer8 é»æ“Šå·²åœ¨å‰é¢è™•ç†ï¼‰
            else if (e.Button == MouseButtons.Left && Control.ModifierKeys == Keys.None && _pendingMaterial == null)
            {
                isSelectingRegion = true;
                isLayer4CopyMode = true;  // é€²å…¥è¤‡è£½æ¨¡å¼
                regionStartPoint = e.Location;
                regionEndPoint = e.Location;
                selectedRegion = new Rectangle();
                this.toolStripStatusLabel1.Text = "é¸å–å€åŸŸ... (æ”¾é–‹å¾ŒæŒ‰ Ctrl+C è¤‡è£½)";
            }
        }

        // S32 åœ°åœ–é¼ æ¨™ç§»å‹•äº‹ä»¶ - æ›´æ–°é¸æ“‡å€åŸŸæˆ–æ‹–æ‹½ç§»å‹•
        private void s32PictureBox_MouseMove(object sender, MouseEventArgs e)
        {
            var totalSw = Stopwatch.StartNew();

            // ä¸­éµæ‹–æ‹½ç§»å‹•è¦–åœ–
            if (isMainMapDragging)
            {
                // æ¯ 50 æ¬¡è¨˜éŒ„ä¸€æ¬¡ï¼Œé¿å… log éå¤š
                if (_dragMoveCount % 50 == 0)
                {
                    LogPerf($"[DRAG-MOVE] count={_dragMoveCount}");
                }

                int deltaX = e.X - mainMapDragStartPoint.X;
                int deltaY = e.Y - mainMapDragStartPoint.Y;

                // è¨ˆç®—æ–°çš„æ²å‹•ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼Œéœ€è¦é™¤ä»¥ç¸®æ”¾ï¼‰
                int newScrollX = mainMapDragStartScroll.X - (int)(deltaX / s32ZoomLevel);
                int newScrollY = mainMapDragStartScroll.Y - (int)(deltaY / s32ZoomLevel);

                // é™åˆ¶åœ¨æœ‰æ•ˆç¯„åœå…§ï¼ˆä½¿ç”¨ä¸–ç•Œåº§æ¨™ï¼‰
                int maxScrollX = Math.Max(0, _viewState.MapWidth - (int)(s32MapPanel.Width / s32ZoomLevel));
                int maxScrollY = Math.Max(0, _viewState.MapHeight - (int)(s32MapPanel.Height / s32ZoomLevel));
                newScrollX = Math.Max(0, Math.Min(newScrollX, maxScrollX));
                newScrollY = Math.Max(0, Math.Min(newScrollY, maxScrollY));

                // æ›´æ–° ViewState çš„æ²å‹•ä½ç½®
                _viewState.SetScrollSilent(newScrollX, newScrollY);

                // æ¨™è¨˜éœ€è¦é‡ç¹ªï¼ˆè®“ OS æ‰¹æ¬¡è™•ç† Paint è¨Šæ¯ï¼Œé¿å…åŒæ­¥é˜»å¡ï¼‰
                _mapViewerControl.Refresh();
                _dragMoveCount++;
                return;
            }

            // æ›´æ–°ç‹€æ…‹åˆ—é¡¯ç¤ºéŠæˆ²åº§æ¨™ï¼ˆæ‹–æ›³æ™‚è·³éï¼‰
            var statusSw = Stopwatch.StartNew();
            UpdateStatusBarWithGameCoords(e.X, e.Y);
            statusSw.Stop();

            if (isSelectingRegion)
            {
                regionEndPoint = e.Location;

                // è¨ˆç®—èµ·é»åˆ°çµ‚é»ä¹‹é–“çš„æ ¼å­ç¯„åœï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½å°é½Šæ ¼ç·šï¼‰
                var cellsSw = Stopwatch.StartNew();
                _editState.SelectedCells = GetCellsInIsometricRange(regionStartPoint, regionEndPoint);
                cellsSw.Stop();

                var boundsSw = Stopwatch.StartNew();
                if (_editState.SelectedCells.Count > 0)
                {
                    selectedRegion = GetAlignedBoundsFromCells(_editState.SelectedCells);
                }
                boundsSw.Stop();

                // é‡ç¹ªè¦†è“‹å±¤ä»¥é¡¯ç¤ºé¸æ“‡æ¡†ï¼ˆä¸éœ€è¦é‡æ–°æ¸²æŸ“åœ°åœ–ï¼‰
                var invalidateSw = Stopwatch.StartNew();
                _mapViewerControl.InvalidateOverlay();
                invalidateSw.Stop();

                totalSw.Stop();
                LogPerf($"[MOUSE-MOVE-SELECT] status={statusSw.ElapsedMilliseconds}ms, cells={cellsSw.ElapsedMilliseconds}ms ({_editState.SelectedCells.Count}), bounds={boundsSw.ElapsedMilliseconds}ms, invalidate={invalidateSw.ElapsedMilliseconds}ms, total={totalSw.ElapsedMilliseconds}ms");
            }
        }

        // æ›´æ–°ç‹€æ…‹åˆ—é¡¯ç¤ºéŠæˆ²åº§æ¨™
        private void UpdateStatusBarWithGameCoords(int screenX, int screenY)
        {
            var coords = ScreenToGameCoords(screenX, screenY);
            if (coords.gameX >= 0 && coords.gameY >= 0)
            {
                this.toolStripStatusLabel2.Text = $"åº§æ¨™: ({coords.gameX}, {coords.gameY})";
            }
            else
            {
                this.toolStripStatusLabel2.Text = "";
            }
        }

        // S32 åœ°åœ–é¼ æ¨™é‡‹æ”¾äº‹ä»¶ - å®Œæˆå€åŸŸé¸æ“‡ä¸¦åŸ·è¡Œæ‰¹é‡æ“ä½œ
        private void s32PictureBox_MouseUp(object sender, MouseEventArgs e)
        {
            var totalSw = Stopwatch.StartNew();

            // çµæŸä¸­éµæ‹–æ‹½
            if (e.Button == MouseButtons.Middle && isMainMapDragging)
            {
                var upSw = Stopwatch.StartNew();
                _dragSessionSw.Stop();
                long dragMs = _dragSessionSw.ElapsedMilliseconds;
                double fps = dragMs > 0 ? (_dragPaintCount * 1000.0 / dragMs) : 0;

                // è¼¸å‡ºæ‹–æ›³æ•ˆèƒ½çµ±è¨ˆ
                LogPerf($"[DRAG-END] duration={dragMs}ms, moves={_dragMoveCount}, paints={_dragPaintCount}, FPS={fps:F1}");

                isMainMapDragging = false;
                this._mapViewerControl.Cursor = Cursors.Default;

                // å»¶é²æ›´æ–° MiniMapï¼Œé¿å…é˜»å¡æ‹–æ›³çµæŸäº‹ä»¶
                this.BeginInvoke((MethodInvoker)delegate { UpdateMiniMap(); });

                // æ‹–æ›³çµæŸå¾Œé‡æ–°æ¸²æŸ“
                RenderS32Map();

                upSw.Stop();
                LogPerf($"[MOUSE-UP-MIDDLE] total={upSw.ElapsedMilliseconds}ms");
                return;
            }

            if (isSelectingRegion && e.Button == MouseButtons.Left)
            {
                isSelectingRegion = false;

                // Layer4 è¤‡è£½æ¨¡å¼ï¼šä¿ç•™é¸å–ç¯„åœï¼Œç­‰å¾… Ctrl+C æˆ– Ctrl+V
                if (isLayer4CopyMode)
                {
                    var boundsSw = Stopwatch.StartNew();
                    // _editState.SelectedCells å·²åœ¨ MouseMove ä¸­æ›´æ–°
                    if (_editState.SelectedCells.Count > 0)
                    {
                        // è¨ˆç®—æ‰€æœ‰é¸ä¸­æ ¼å­çš„è¢å¹•åº§æ¨™é‚Šç•Œ
                        copyRegionBounds = GetAlignedBoundsFromCells(_editState.SelectedCells);
                        selectedRegion = copyRegionBounds;
                    }
                    else
                    {
                        copyRegionBounds = selectedRegion;
                    }
                    boundsSw.Stop();

                    // è¨ˆç®—é¸å–å€åŸŸçš„å…¨åŸŸ Layer1 åº§æ¨™åŸé»ï¼ˆä½¿ç”¨é¸ä¸­æ ¼å­ä¸­æœ€å°çš„ X, Y ä½œç‚ºåŸé»ï¼‰
                    var originSw = Stopwatch.StartNew();
                    int globalX = -1, globalY = -1;
                    int gameX = -1, gameY = -1;
                    if (_editState.SelectedCells.Count > 0)
                    {
                        // æ‰¾å‡ºæ‰€æœ‰é¸ä¸­æ ¼å­çš„æœ€å°å…¨åŸŸ Layer1 åº§æ¨™
                        int minGlobalX = int.MaxValue, minGlobalY = int.MaxValue;
                        foreach (var cell in _editState.SelectedCells)
                        {
                            // nLinBeginX æ˜¯ Layer3 åº§æ¨™ï¼Œä¹˜ä»¥ 2 è½‰æˆ Layer1ï¼Œå†åŠ ä¸Š cell.LocalX
                            int cellGlobalX = cell.S32Data.SegInfo.nLinBeginX * 2 + cell.LocalX;
                            int cellGlobalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                            if (cellGlobalX < minGlobalX) minGlobalX = cellGlobalX;
                            if (cellGlobalY < minGlobalY) minGlobalY = cellGlobalY;
                        }
                        globalX = minGlobalX;
                        globalY = minGlobalY;
                        // è¨ˆç®—éŠæˆ²åº§æ¨™ï¼ˆLayer3 å°ºåº¦ï¼‰
                        gameX = globalX / 2;
                        gameY = globalY;
                    }
                    _editState.CopyRegionOrigin = new Point(globalX, globalY);
                    originSw.Stop();

                    // æ›´æ–°ç§»å‹•æŒ‡ä»¤ï¼ˆé¡¯ç¤ºé¸å–ç¬¬ä¸€æ ¼çš„åº§æ¨™ï¼‰
                    if (gameX >= 0 && gameY >= 0)
                    {
                        _editState.SelectedGameX = gameX;
                        _editState.SelectedGameY = gameY;
                        toolStripCopyMoveCmd.Enabled = true;
                        toolStripCopyMoveCmd.Text = $"ç§»å‹• {gameX} {gameY} {_document.MapId}";
                    }

                    // æ ¹æ“šæ˜¯å¦æœ‰å‰ªè²¼ç°¿è³‡æ–™é¡¯ç¤ºä¸åŒæç¤ºï¼ˆé¡¯ç¤ºéŠæˆ²åº§æ¨™ï¼‰
                    if (hasLayer4Clipboard && _editState.CellClipboard.Count > 0)
                    {
                        this.toolStripStatusLabel1.Text = $"å·²é¸å–è²¼ä¸Šä½ç½® (éŠæˆ²åº§æ¨™: {gameX}, {gameY})ï¼ŒæŒ‰ Ctrl+V è²¼ä¸Š {_editState.CellClipboard.Count} æ ¼è³‡æ–™ï¼Œé¸ä¸­ {_editState.SelectedCells.Count} æ ¼";
                    }
                    else
                    {
                        this.toolStripStatusLabel1.Text = $"å·²é¸å–å€åŸŸ (éŠæˆ²åº§æ¨™: {gameX}, {gameY})ï¼Œé¸ä¸­ {_editState.SelectedCells.Count} æ ¼ï¼ŒæŒ‰ Ctrl+C è¤‡è£½";
                    }

                    // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨
                    var thumbSw = Stopwatch.StartNew();
                    if (_editState.IsLayer5EditMode && _editState.SelectedCells.Count > 0)
                    {
                        // é€æ˜ç·¨è¼¯æ¨¡å¼ï¼šä½¿ç”¨é¸å–å€åŸŸç¬¬ä¸€æ ¼çš„ä½ç½®é¡¯ç¤ºé™„è¿‘ç¾¤çµ„ï¼ˆæœ‰ L5 è¨­å®šçš„æ’å‰é¢ï¼‰
                        var firstCell = _editState.SelectedCells[0];
                        UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
                    }
                    else
                    {
                        // ä¸€èˆ¬æ¨¡å¼ï¼šé¡¯ç¤ºé¸å–å€åŸŸå…§çš„ç¾¤çµ„
                        UpdateGroupThumbnailsList(_editState.SelectedCells);
                    }
                    thumbSw.Stop();

                    // é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿é¸å–å€åŸŸçš„ S32 éƒ½æœ‰é¡¯ç¤º
                    RenderS32Map();

                    // æ›´æ–°é¸å–å€åŸŸæ¶‰åŠçš„ S32 æª”æ¡ˆè³‡è¨Š
                    UpdateSelectionS32Info();

                    totalSw.Stop();
                    LogPerf($"[MOUSE-UP-SELECT] bounds={boundsSw.ElapsedMilliseconds}ms, origin={originSw.ElapsedMilliseconds}ms, thumb={thumbSw.ElapsedMilliseconds}ms, total={totalSw.ElapsedMilliseconds}ms, cells={_editState.SelectedCells.Count}");
                    return;
                }

                // æ‰¾å‡ºé¸ä¸­å€åŸŸå…§çš„æ‰€æœ‰æ ¼å­
                var cellsSw = Stopwatch.StartNew();
                List<SelectedCell> selectedCells = GetCellsInRegion(selectedRegion);
                cellsSw.Stop();

                if (selectedCells.Count > 0)
                {
                    // åˆªé™¤æ¨¡å¼ï¼šæ‰¹æ¬¡åˆªé™¤ç‰©ä»¶
                    var deleteSw = Stopwatch.StartNew();
                    DeleteAllLayer4ObjectsInRegion(selectedCells);
                    deleteSw.Stop();
                    totalSw.Stop();
                    LogPerf($"[MOUSE-UP-DELETE] cells={cellsSw.ElapsedMilliseconds}ms, delete={deleteSw.ElapsedMilliseconds}ms, total={totalSw.ElapsedMilliseconds}ms");
                }

                // æ¸…é™¤é¸æ“‡æ¡†
                selectedRegion = new Rectangle();
                _mapViewerControl.Refresh();
            }

            // å³éµé¡¯ç¤ºé¸å–å€åŸŸæ“ä½œé¸å–®
            if (e.Button == MouseButtons.Right && isLayer4CopyMode && _editState.SelectedCells.Count > 0)
            {
                ShowSelectionContextMenu(e.Location);
                return;
            }

        }

        // é¡¯ç¤ºé¸å–å€åŸŸå³éµé¸å–®
        private void ShowSelectionContextMenu(Point location)
        {
            var menu = new ContextMenuStrip();

            // æŸ¥çœ‹è©³ç´°è³‡æ–™ï¼ˆä½¿ç”¨æ»‘é¼ ä½ç½®çš„æ ¼å­ï¼Œæˆ–ç¬¬ä¸€å€‹é¸ä¸­çš„æ ¼å­ï¼‰
            var coords = ScreenToGameCoords(location.X, location.Y);
            SelectedCell detailCell = null;
            if (coords.s32Data != null)
            {
                // å„ªå…ˆä½¿ç”¨æ»‘é¼ ä½ç½®çš„æ ¼å­
                detailCell = _editState.SelectedCells.FirstOrDefault(c =>
                    c.S32Data == coords.s32Data && c.LocalX == coords.localX && c.LocalY == coords.localY);
            }
            if (detailCell == null && _editState.SelectedCells.Count > 0)
            {
                detailCell = _editState.SelectedCells[0];
            }

            if (detailCell != null)
            {
                var detailItem = new ToolStripMenuItem("æŸ¥çœ‹è©³ç´°è³‡æ–™...");
                detailItem.Click += (s, e) => {
                    _editState.HighlightedS32Data = detailCell.S32Data;
                    _editState.HighlightedCellX = detailCell.LocalX;
                    _editState.HighlightedCellY = detailCell.LocalY;
                    ShowCellLayersDialog(detailCell.LocalX, detailCell.LocalY);
                };
                menu.Items.Add(detailItem);
                menu.Items.Add(new ToolStripSeparator());
            }

            var exportFs32Item = new ToolStripMenuItem("åŒ¯å‡ºç‚º fs32 åœ°åœ–åŒ…...");
            exportFs32Item.Click += (s, e) => ExportSelectionAsFs32();
            menu.Items.Add(exportFs32Item);

            var saveAsFs3pItem = new ToolStripMenuItem("å„²å­˜ç‚ºç´ æ (fs3p)...");
            saveAsFs3pItem.Click += (s, e) => SaveSelectionAsMaterial();
            menu.Items.Add(saveAsFs3pItem);

            menu.Items.Add(new ToolStripSeparator());

            var copyItem = new ToolStripMenuItem("è¤‡è£½ (Ctrl+C)");
            copyItem.Click += (s, e) => CopySelectedCells();
            menu.Items.Add(copyItem);

            var clearItem = new ToolStripMenuItem("æ¸…é™¤é¸å–å€åŸŸè³‡æ–™...");
            clearItem.Click += (s, e) => ClearSelectedCellsWithDialog();
            menu.Items.Add(clearItem);

            menu.Show(_mapViewerControl, location);
        }

        // æ›´æ–°é¸å–å€åŸŸæ¶‰åŠçš„ S32 æª”æ¡ˆè³‡è¨Š
        private void UpdateSelectionS32Info()
        {
            if (_editState.SelectedCells.Count == 0)
            {
                // æ²’æœ‰é¸å–æ™‚æ¸…é™¤é«˜äº®
                ClearS32ListHighlight();
                return;
            }

            // æ”¶é›†é¸å–å€åŸŸæ¶‰åŠçš„ S32 æª”æ¡ˆ
            var involvedS32s = new HashSet<string>();
            foreach (var cell in _editState.SelectedCells)
            {
                if (cell.S32Data != null && !string.IsNullOrEmpty(cell.S32Data.FilePath))
                {
                    involvedS32s.Add(cell.S32Data.FilePath);
                }
            }

            if (involvedS32s.Count == 0)
                return;

            // æ›´æ–° lblS32Info é¡¯ç¤ºæ¶‰åŠçš„ S32 æª”æ¡ˆ
            var s32Names = involvedS32s.Select(p => Path.GetFileName(p)).OrderBy(n => n).ToList();
            string s32List = string.Join(", ", s32Names.Take(5));
            if (s32Names.Count > 5)
                s32List += $" ... å…± {s32Names.Count} å€‹";

            lblS32Info.Text = $"é¸å– {_editState.SelectedCells.Count} æ ¼ | æ¶‰åŠ S32: {s32List}";

            // é«˜äº® lstS32Files ä¸­çš„ç›¸é—œé …ç›®
            HighlightS32ListItems(involvedS32s);
        }

        // é«˜äº® S32 æª”æ¡ˆæ¸…å–®ä¸­çš„é …ç›®
        private void HighlightS32ListItems(HashSet<string> filePaths)
        {
            // å…ˆæ¸…é™¤ä¹‹å‰çš„é«˜äº®
            lstS32Files.Invalidate();

            // æ‰¾åˆ°ç¬¬ä¸€å€‹åŒ¹é…çš„é …ç›®ä¸¦æ²å‹•åˆ°è©²ä½ç½®
            for (int i = 0; i < lstS32Files.Items.Count; i++)
            {
                if (lstS32Files.Items[i] is S32FileItem item && filePaths.Contains(item.FilePath))
                {
                    // é¸ä¸­ç¬¬ä¸€å€‹åŒ¹é…çš„é …ç›®ï¼ˆè®“å®ƒå¯è¦‹ï¼‰
                    lstS32Files.SelectedIndex = i;
                    break;
                }
            }

            // å„²å­˜éœ€è¦é«˜äº®çš„æª”æ¡ˆè·¯å¾‘ä¾›ç¹ªè£½ä½¿ç”¨
            _highlightedS32Paths = filePaths;
            lstS32Files.Invalidate();
        }

        // æ¸…é™¤ S32 æª”æ¡ˆæ¸…å–®é«˜äº®
        private void ClearS32ListHighlight()
        {
            _highlightedS32Paths = null;
            lstS32Files.Invalidate();
        }

        // éœ€è¦é«˜äº®çš„ S32 æª”æ¡ˆè·¯å¾‘
        private HashSet<string> _highlightedS32Paths = null;

        // åŒ¯å‡ºé¸å–å€åŸŸç‚º fs32
        private void ExportSelectionAsFs32()
        {
            if (_editState.SelectedCells.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆé¸å–å€åŸŸ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†é¸å–å€åŸŸæ¶‰åŠçš„ S32 æª”æ¡ˆ
            var involvedS32s = new Dictionary<string, S32Data>();
            foreach (var cell in _editState.SelectedCells)
            {
                if (cell.S32Data != null)
                {
                    // å¾ _document.S32Files æ‰¾åˆ°å°æ‡‰çš„ key
                    var matchingEntry = _document.S32Files.FirstOrDefault(kvp => kvp.Value == cell.S32Data);
                    if (!string.IsNullOrEmpty(matchingEntry.Key) && !involvedS32s.ContainsKey(matchingEntry.Key))
                        involvedS32s[matchingEntry.Key] = cell.S32Data;
                }
            }

            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: false, hasSelection: true))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                // æª¢æŸ¥ç•°å¸¸ï¼ˆåŒ¯å‡ºä¸æª¢æŸ¥ Tile ä¸Šé™ï¼Œè‹¥æœƒç§»é™¤ L8 æ“´å±•å‰‡ä¸æª¢æŸ¥ï¼‰
                if (!CheckLayer5IssuesAndConfirm(involvedS32s, "åŒ¯å‡º", checkTileLimit: false, checkLayer8Extended: !dialog.StripLayer8Ext))
                    return;

                using (var saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32";
                    saveDialog.FileName = $"{_document.MapId}_export.fs32";

                    if (saveDialog.ShowDialog() != DialogResult.OK)
                        return;

                    try
                    {
                        Fs32Data fs32;
                        if (dialog.SelectedMode == L1MapViewer.Forms.ExportOptionsDialog.ExportMode.WholeMap)
                        {
                            fs32 = Fs32Writer.CreateFromMap(_document, dialog.LayerFlags, dialog.IncludeTiles, dialog.StripLayer8Ext);
                        }
                        else
                        {
                            fs32 = Fs32Writer.CreateFromS32List(involvedS32s.Values.ToList(), _document.MapId, dialog.LayerFlags, dialog.IncludeTiles, dialog.StripLayer8Ext);
                        }

                        // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                        if (dialog.IncludeTiles && fs32.Tiles.Count > 0)
                        {
                            int remasterCount = fs32.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                            if (remasterCount > 0)
                            {
                                var result = MessageBox.Show(
                                    $"åœ°åœ–åŒ…ä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                    "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                    "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                    "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                    "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                    MessageBoxButtons.YesNo,
                                    MessageBoxIcon.Question,
                                    MessageBoxDefaultButton.Button1);

                                if (result == DialogResult.Yes)
                                {
                                    foreach (var tileId in fs32.Tiles.Keys.ToList())
                                    {
                                        var tile = fs32.Tiles[tileId];
                                        if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                        {
                                            tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                            tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                        }
                                    }
                                }
                            }
                        }

                        Fs32Writer.Write(fs32, saveDialog.FileName);

                        string resultMsg = $"å·²åŒ¯å‡ºè‡³ {saveDialog.FileName}\n({fs32.Blocks.Count} å€å¡Š, {fs32.Tiles.Count} åœ–å¡Š)";
                        toolStripStatusLabel1.Text = resultMsg.Replace("\n", " ");
                        ShowAutoCloseMessage(resultMsg, "åŒ¯å‡ºå®Œæˆ");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[ExportSelectionAsFs32] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        // å„²å­˜é¸å–å€åŸŸç‚ºç´ æ (fs3p)
        private void SaveSelectionAsMaterial()
        {
            if (_editState.SelectedCells.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆé¸å–å€åŸŸ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: true, hasSelection: true))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                try
                {
                    // ç”¢ç”Ÿç¸®åœ–
                    Bitmap thumbnail = GenerateSelectionThumbnail(_editState.SelectedCells, 128);

                    // å»ºç«‹ fs3p
                    var fs3p = Fs3pWriter.CreateFromSelection(
                        _editState.SelectedCells,
                        _document.S32Files,
                        dialog.MaterialName,
                        dialog.LayerFlags,
                        dialog.IncludeTiles,
                        dialog.IncludeLayer5,
                        thumbnail);

                    if (fs3p == null)
                    {
                        MessageBox.Show("å»ºç«‹ç´ æå¤±æ•—", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                    if (dialog.IncludeTiles && fs3p.Tiles.Count > 0)
                    {
                        int remasterCount = fs3p.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                        if (remasterCount > 0)
                        {
                            var result = MessageBox.Show(
                                $"ç´ æä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                MessageBoxButtons.YesNo,
                                MessageBoxIcon.Question,
                                MessageBoxDefaultButton.Button1);  // é è¨­é¸ã€Œæ˜¯ã€

                            if (result == DialogResult.Yes)
                            {
                                // è½‰æ›æ‰€æœ‰ Rç‰ˆ tiles ç‚º å¤©1 æ ¼å¼
                                foreach (var tileId in fs3p.Tiles.Keys.ToList())
                                {
                                    var tile = fs3p.Tiles[tileId];
                                    if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                    {
                                        tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                        tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                    }
                                }
                            }
                        }
                    }

                    // å„²å­˜åˆ°ç´ æåº«
                    var library = new MaterialLibrary();
                    string savedPath = library.SaveMaterial(fs3p);

                    thumbnail?.Dispose();

                    toolStripStatusLabel1.Text = $"å·²å„²å­˜ç´ æ: {dialog.MaterialName} ({fs3p.Layer1Items.Count + fs3p.Layer2Items.Count + fs3p.Layer4Items.Count} é …ç›®, {fs3p.Tiles.Count} åœ–å¡Š)";

                    // æ›´æ–°ç´ æé¢æ¿
                    RefreshMaterialsList();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"å„²å­˜ç´ æå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // ç”¢ç”Ÿé¸å–å€åŸŸç¸®åœ–
        private Bitmap GenerateSelectionThumbnail(List<SelectedCell> cells, int maxSize)
        {
            if (cells == null || cells.Count == 0)
                return null;

            try
            {
                // è¨ˆç®—é¸å–ç¯„åœçš„ä¸–ç•Œåº§æ¨™é‚Šç•Œ
                int minWorldX = int.MaxValue, minWorldY = int.MaxValue;
                int maxWorldX = int.MinValue, maxWorldY = int.MinValue;

                foreach (var cell in cells)
                {
                    int worldX = cell.S32Data.SegInfo.nLinBeginX * 2 + cell.LocalX;
                    int worldY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                    // è½‰æ›ç‚ºåƒç´ åº§æ¨™
                    int pixelX = worldX * 24;
                    int pixelY = worldY * 24;

                    if (pixelX < minWorldX) minWorldX = pixelX;
                    if (pixelY < minWorldY) minWorldY = pixelY;
                    if (pixelX + 48 > maxWorldX) maxWorldX = pixelX + 48;
                    if (pixelY + 24 > maxWorldY) maxWorldY = pixelY + 24;
                }

                int width = maxWorldX - minWorldX;
                int height = maxWorldY - minWorldY;

                if (width <= 0 || height <= 0)
                    return null;

                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                float scale = Math.Min((float)maxSize / width, (float)maxSize / height);
                scale = Math.Min(scale, 1.0f);

                int thumbWidth = (int)(width * scale);
                int thumbHeight = (int)(height * scale);

                if (thumbWidth <= 0) thumbWidth = 1;
                if (thumbHeight <= 0) thumbHeight = 1;

                // å¾ç¾æœ‰çš„ viewport bitmap æˆªå–
                var thumbnail = new Bitmap(thumbWidth, thumbHeight);
                using (var g = Graphics.FromImage(thumbnail))
                {
                    g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBilinear;
                    g.Clear(Color.Transparent);

                    // å¦‚æœæœ‰ viewport bitmapï¼Œå¾ä¸­æˆªå–
                    lock (_viewportBitmapLock)
                    {
                        if (_viewportBitmap != null)
                        {
                            // è¨ˆç®—æºå€åŸŸåœ¨ viewport bitmap ä¸­çš„ä½ç½®
                            int srcX = minWorldX - _viewState.RenderOriginX;
                            int srcY = minWorldY - _viewState.RenderOriginY;

                            var srcRect = new Rectangle(srcX, srcY, width, height);
                            var destRect = new Rectangle(0, 0, thumbWidth, thumbHeight);

                            g.DrawImage(_viewportBitmap, destRect, srcRect, GraphicsUnit.Pixel);
                        }
                    }
                }

                return thumbnail;
            }
            catch
            {
                return null;
            }
        }

        // ç´ æåˆ—è¡¨çš„ ImageList
        private ImageList _materialsImageList;

        // åˆ·æ–°ç´ æåˆ—è¡¨
        private void RefreshMaterialsList()
        {
            try
            {
                var library = new MaterialLibrary();
                var recentMaterials = library.GetRecentMaterials();

                lvMaterials.Items.Clear();

                // åˆå§‹åŒ–æˆ–æ¸…ç©º ImageList
                if (_materialsImageList == null)
                {
                    _materialsImageList = new ImageList
                    {
                        ImageSize = new Size(48, 48),
                        ColorDepth = ColorDepth.Depth32Bit
                    };
                    lvMaterials.LargeImageList = _materialsImageList;
                }
                else
                {
                    _materialsImageList.Images.Clear();
                }

                int imageIndex = 0;
                foreach (var info in recentMaterials.Take(5))
                {
                    var item = new ListViewItem(info.Name ?? "æœªå‘½å");
                    item.Tag = info.FilePath;

                    // åŠ å…¥ç¸®åœ–
                    if (info.ThumbnailPng != null && info.ThumbnailPng.Length > 0)
                    {
                        try
                        {
                            using (var ms = new MemoryStream(info.ThumbnailPng))
                            {
                                var thumb = new Bitmap(ms);
                                _materialsImageList.Images.Add(thumb);
                                item.ImageIndex = imageIndex++;
                            }
                        }
                        catch
                        {
                            item.ImageIndex = -1;
                        }
                    }
                    else
                    {
                        item.ImageIndex = -1;
                    }

                    lvMaterials.Items.Add(item);
                }
            }
            catch
            {
                // å¿½ç•¥éŒ¯èª¤
            }
        }

        // S32 PictureBox ç¹ªè£½äº‹ä»¶ - ç¹ªè£½ Viewport å’Œé¸æ“‡æ¡†æˆ–å¤šé‚Šå½¢
        private void s32PictureBox_Paint(object sender, PaintEventArgs e)
        {
            if (isMainMapDragging)
            {
                LogPerf($"[PAINT-ENTER] dragging, moves={_dragMoveCount}");
            }

            var paintSw = Stopwatch.StartNew();
            long lockWaitMs = 0;
            long drawImageMs = 0;
            int bmpW = 0, bmpH = 0;
            int drawW = 0, drawH = 0;

            // ç¹ªè£½ Viewport Bitmapï¼ˆåŠ é–ä¿è­·é¿å…å¤šåŸ·è¡Œç·’è¡çªï¼‰
            var lockSw = Stopwatch.StartNew();
            lock (_viewportBitmapLock)
            {
                lockSw.Stop();
                lockWaitMs = lockSw.ElapsedMilliseconds;
                if (lockWaitMs > 10)
                {
                    LogPerf($"[PAINT-LOCK] waited {lockWaitMs}ms for lock");
                }
            
                if (_viewportBitmap != null && _viewState.RenderWidth > 0)
                {
                    bmpW = _viewportBitmap.Width;
                    bmpH = _viewportBitmap.Height;
            
                    // è¨ˆç®— Viewport Bitmap åœ¨ PictureBox ä¸Šçš„ç¹ªè£½ä½ç½®
                    // _viewState.RenderOriginX/Y æ˜¯å·²æ¸²æŸ“å€åŸŸçš„ä¸–ç•Œåº§æ¨™åŸé»
                    // _viewState.ScrollX/Y æ˜¯ç•¶å‰è¦–åœ–çš„ä¸–ç•Œåº§æ¨™ä½ç½®
                    // ç¹ªè£½ä½ç½® = (RenderOrigin - Scroll) * ZoomLevel
                    int drawX = (int)((_viewState.RenderOriginX - _viewState.ScrollX) * s32ZoomLevel);
                    int drawY = (int)((_viewState.RenderOriginY - _viewState.ScrollY) * s32ZoomLevel);
            
                    // Viewport Bitmap æ˜¯æœªç¸®æ”¾çš„ï¼Œéœ€è¦ç¸®æ”¾ç¹ªè£½
                    drawW = (int)(_viewState.RenderWidth * s32ZoomLevel);
                    drawH = (int)(_viewState.RenderHeight * s32ZoomLevel);
            
                    var drawSw = Stopwatch.StartNew();
                    e.Graphics.DrawImage(_viewportBitmap, drawX, drawY, drawW, drawH);
                    drawSw.Stop();
                    drawImageMs = drawSw.ElapsedMilliseconds;
            
                    // æ‹–æ›³æ™‚è¨ˆæ•¸ Paint æ¬¡æ•¸
                    if (isMainMapDragging)
                    {
                        _dragPaintCount++;
                    }
                }
                else
                {
                    LogPerf($"[PAINT] no bitmap, _viewportBitmap={(_viewportBitmap != null ? "exists" : "null")}, RenderWidth={_viewState.RenderWidth}");
                }
            }

            paintSw.Stop();
            // æ‹–æ›³æ™‚è¨˜éŒ„æ…¢çš„ Paintï¼ˆ> 30msï¼‰æˆ–æ¯ 20 æ¬¡è¨˜ä¸€æ¬¡
            if (isMainMapDragging && (paintSw.ElapsedMilliseconds > 30 || _dragPaintCount % 20 == 1))
            {
                LogPerf($"[PAINT-DRAG] total={paintSw.ElapsedMilliseconds}ms, lockWait={lockWaitMs}ms, drawImage={drawImageMs}ms, bmp={bmpW}x{bmpH}, draw={drawW}x{drawH}");
            }
            // éæ‹–æ›³æ™‚åªåœ¨è¶…é 10ms æ™‚è¨˜éŒ„
            else if (!isMainMapDragging && paintSw.ElapsedMilliseconds > 10)
            {
                LogPerf($"[PAINT] total={paintSw.ElapsedMilliseconds}ms, lockWait={lockWaitMs}ms, drawImage={drawImageMs}ms, bmp={bmpW}x{bmpH}, draw={drawW}x{drawH}");
            }

            // é€šè¡Œæ€§ç·¨è¼¯æ¨¡å¼ï¼šç¹ªè£½å¤šé‚Šå½¢
            if (_editState.IsDrawingPassabilityPolygon && _editState.PassabilityPolygonPoints.Count > 0)
            {
                Color polygonColor = currentPassableEditMode == PassableEditMode.SetPassable ? Color.LimeGreen : Color.Red;

                // ç¹ªè£½å·²æœ‰çš„å¤šé‚Šå½¢é‚Š
                using (Pen pen = new Pen(polygonColor, 3))
                {
                    for (int i = 0; i < _editState.PassabilityPolygonPoints.Count - 1; i++)
                    {
                        e.Graphics.DrawLine(pen, _editState.PassabilityPolygonPoints[i], _editState.PassabilityPolygonPoints[i + 1]);
                    }
                    // å¦‚æœæœ‰3å€‹ä»¥ä¸Šé ‚é»ï¼Œç¹ªè£½å°é–‰ç·šï¼ˆè™›ç·šé è¦½ï¼‰
                    if (_editState.PassabilityPolygonPoints.Count >= 3)
                    {
                        using (Pen dashPen = new Pen(polygonColor, 2) { DashStyle = System.Drawing.Drawing2D.DashStyle.Dash })
                        {
                            e.Graphics.DrawLine(dashPen, _editState.PassabilityPolygonPoints[_editState.PassabilityPolygonPoints.Count - 1], _editState.PassabilityPolygonPoints[0]);
                        }
                    }
                }

                // ç¹ªè£½é ‚é»æ¨™è¨˜
                using (SolidBrush brush = new SolidBrush(polygonColor))
                {
                    foreach (var pt in _editState.PassabilityPolygonPoints)
                    {
                        e.Graphics.FillEllipse(brush, pt.X - 5, pt.Y - 5, 10, 10);
                    }
                }

                // ç¹ªè£½åŠé€æ˜å¡«å……é è¦½ï¼ˆå¦‚æœæœ‰3å€‹ä»¥ä¸Šé ‚é»ï¼‰
                if (_editState.PassabilityPolygonPoints.Count >= 3)
                {
                    using (SolidBrush fillBrush = new SolidBrush(Color.FromArgb(50, polygonColor)))
                    {
                        e.Graphics.FillPolygon(fillBrush, _editState.PassabilityPolygonPoints.ToArray());
                    }
                }
                return;
            }

            // æœ‰é¸ä¸­çš„æ ¼å­æ™‚ï¼Œç¹ªè£½å°é½Šæ ¼ç·šçš„è±å½¢é¸å–æ¡†
            if (_editState.SelectedCells.Count > 0)
            {
                Color color = isSelectingRegion ? Color.Green : Color.Orange;
                var drawCellsSw = Stopwatch.StartNew();
                DrawSelectedCells(e.Graphics, _editState.SelectedCells, color);
                drawCellsSw.Stop();
                LogPerf($"[PAINT] DrawSelectedCells={drawCellsSw.ElapsedMilliseconds}ms, cellCount={_editState.SelectedCells.Count}");

                // é¡¯ç¤ºé¸å–çš„æ ¼å­æ•¸é‡
                if (isSelectingRegion)
                {
                    string info = $"é¸å– {_editState.SelectedCells.Count} æ ¼";
                    using (Font font = new Font("Arial", 10, FontStyle.Bold))
                    using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(180, Color.Black)))
                    using (SolidBrush textBrush = new SolidBrush(Color.White))
                    {
                        SizeF textSize = e.Graphics.MeasureString(info, font);
                        // åœ¨æ»‘é¼ ä½ç½®é™„è¿‘é¡¯ç¤º
                        float textX = regionEndPoint.X + 15;
                        float textY = regionEndPoint.Y - 20;
                        e.Graphics.FillRectangle(bgBrush, textX - 2, textY - 2, textSize.Width + 4, textSize.Height + 4);
                        e.Graphics.DrawString(info, font, textBrush, textX, textY);
                    }
                }
            }

            paintSw.Stop();
            LogPerf($"[PAINT] total={paintSw.ElapsedMilliseconds}ms");
        }

        // ç¹ªè£½é¸ä¸­çš„æ ¼å­ï¼ˆæ¯å€‹æ ¼å­ç¹ªè£½ç¨ç«‹çš„è±å½¢ï¼‰
        private void DrawSelectedCells(Graphics g, List<SelectedCell> cells, Color color)
        {
            if (cells.Count == 0 || string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return;

            // ä½¿ç”¨ ViewState çš„æ²å‹•ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            int scrollX = _viewState.ScrollX;
            int scrollY = _viewState.ScrollY;

            using (SolidBrush brush = new SolidBrush(Color.FromArgb(50, color)))
            using (Pen pen = new Pen(color, 2))
            {
                foreach (var cell in cells)
                {
                    // èˆ‡ DrawS32Grid å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—ï¼ˆLayer3 æ ¼å­ï¼Œ48x24ï¼‰
                    int[] loc = cell.S32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    int x = cell.LocalX;  // å·²ç¶“æ˜¯ Layer1 åº§æ¨™ (x3 * 2)
                    int y = cell.LocalY;

                    int localBaseX = 0;
                    int localBaseY = 63 * 12;
                    localBaseX -= 24 * (x / 2);
                    localBaseY -= 12 * (x / 2);

                    // è¨ˆç®—ä¸–ç•Œåº§æ¨™
                    int worldX = mx + localBaseX + x * 24 + y * 24;
                    int worldY = my + localBaseY + y * 12;

                    // è½‰æ›ç‚ºè¢å¹•åº§æ¨™ï¼ˆè€ƒæ…®æ²å‹•ä½ç½®å’Œç¸®æ”¾ï¼‰
                    // è¢å¹•åº§æ¨™ = (ä¸–ç•Œåº§æ¨™ - æ²å‹•ä½ç½®) * ç¸®æ”¾
                    int screenX = (int)((worldX - scrollX) * s32ZoomLevel);
                    int screenY = (int)((worldY - scrollY) * s32ZoomLevel);
                    int scaledWidth = (int)(48 * s32ZoomLevel);
                    int scaledHeight = (int)(24 * s32ZoomLevel);

                    // Layer3 è±å½¢å››å€‹é ‚é»ï¼ˆ48x24ï¼Œèˆ‡ DrawS32Grid ä¸€è‡´ï¼‰
                    Point[] diamondPoints = new Point[]
                    {
                        new Point(screenX, screenY + scaledHeight / 2),       // å·¦
                        new Point(screenX + scaledWidth / 2, screenY),        // ä¸Š
                        new Point(screenX + scaledWidth, screenY + scaledHeight / 2),  // å³
                        new Point(screenX + scaledWidth / 2, screenY + scaledHeight)   // ä¸‹
                    };

                    g.FillPolygon(brush, diamondPoints);
                    g.DrawPolygon(pen, diamondPoints);
                }
            }
        }

        // ç¹ªè£½ç­‰è·è±å½¢é¸å–æ¡†ï¼ˆæ”¯æ´é•·æ–¹å½¢ï¼‰
        private void DrawIsometricSelectionBox(Graphics g, Rectangle region, Color color)
        {
            // è¨ˆç®—ç­‰è·æŠ•å½±è±å½¢çš„å››å€‹é ‚é»
            float centerX = region.Left + region.Width / 2f;
            float centerY = region.Top + region.Height / 2f;

            // ä½¿ç”¨å¯¦éš›çš„å¯¬é«˜ï¼Œä¿æŒ 2:1 çš„ç­‰è·æ¯”ä¾‹
            float halfWidth = region.Width / 2f;       // æ°´å¹³æ–¹å‘åŠå¯¬
            float halfHeight = region.Height / 2f;     // å‚ç›´æ–¹å‘åŠé«˜

            PointF[] diamondPoints = new PointF[]
            {
                new PointF(centerX, centerY - halfHeight),  // ä¸Š
                new PointF(centerX + halfWidth, centerY),   // å³
                new PointF(centerX, centerY + halfHeight),  // ä¸‹
                new PointF(centerX - halfWidth, centerY)    // å·¦
            };

            // ç¹ªè£½åŠé€æ˜é¸æ“‡æ¡†ï¼ˆè±å½¢ï¼‰
            using (SolidBrush brush = new SolidBrush(Color.FromArgb(80, color)))
            {
                g.FillPolygon(brush, diamondPoints);
            }

            // ç¹ªè£½é‚Šæ¡†ï¼ˆè±å½¢ï¼‰
            using (Pen pen = new Pen(color, 3))
            {
                pen.DashStyle = System.Drawing.Drawing2D.DashStyle.Dash;
                g.DrawPolygon(pen, diamondPoints);
            }
        }

        // ç²å–çŸ©å½¢å€åŸŸå…§çš„æ‰€æœ‰æ ¼å­åº§æ¨™ï¼ˆè¿”å›æ ¼å­æ‰€å±¬çš„ S32Data å’Œå±€éƒ¨åº§æ¨™ï¼‰
        // SelectedCell å·²ç§»è‡³ Models/S32DataModels.cs

        private List<SelectedCell> GetCellsInRegion(Rectangle region)
        {
            List<SelectedCell> cells = new List<SelectedCell>();

            // ç²å–ç•¶å‰åœ°åœ–è³‡è¨Šä»¥è¨ˆç®—æ­£ç¢ºçš„ baseY
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
                return cells;

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // å°‡è¢å¹•çŸ©å½¢çš„å››å€‹è§’è½‰æ›ç‚ºéŠæˆ²åº§æ¨™ï¼Œæ‰¾å‡ºéŠæˆ²åº§æ¨™çš„ç¯„åœ
            // è¢å¹•åº§æ¨™ -> éŠæˆ²åº§æ¨™çš„åå‘è½‰æ›
            int baseYOffset = (currentMap.nLinLengthY - 1) * 12;

            // çŸ©å½¢çš„å››å€‹è§’é»
            Point[] corners = new Point[]
            {
                new Point(region.Left, region.Top),
                new Point(region.Right, region.Top),
                new Point(region.Left, region.Bottom),
                new Point(region.Right, region.Bottom)
            };

            // è¨ˆç®—æ¯å€‹è§’é»å°æ‡‰çš„éŠæˆ²åº§æ¨™ç¯„åœ
            int minGameX = int.MaxValue, maxGameX = int.MinValue;
            int minGameY = int.MaxValue, maxGameY = int.MinValue;

            foreach (var corner in corners)
            {
                // åå‘è¨ˆç®—éŠæˆ²åº§æ¨™ (è¿‘ä¼¼å€¼ï¼Œç”¨æ–¼ç¢ºå®šæœç´¢ç¯„åœ)
                // X = baseX + globalX * 24 + globalY * 24
                // Y = baseY + globalY * 12
                // å…¶ä¸­ baseX = -24 * (globalX / 2), baseY = baseYOffset - 12 * (globalX / 2)

                // ç°¡åŒ–ï¼šå‡è¨­ globalX ç‚ºå¶æ•¸æ™‚
                // X â‰ˆ globalX * 12 + globalY * 24
                // Y â‰ˆ baseYOffset + globalY * 12 - globalX * 6

                // å¾ Y å¾—ï¼šglobalY â‰ˆ (Y - baseYOffset + globalX * 6) / 12
                // å¾ X å¾—ï¼šglobalX â‰ˆ (X - globalY * 24) / 12

                // ç”¨è¿­ä»£æ–¹å¼ä¼°ç®—
                for (int gx = -50; gx < currentMap.nLinLengthX + 50; gx += 10)
                {
                    for (int gy = -50; gy < currentMap.nLinLengthY + 50; gy += 10)
                    {
                        int bx = -24 * (gx / 2);
                        int by = baseYOffset - 12 * (gx / 2);
                        int sx = bx + gx * 24 + gy * 24;
                        int sy = by + gy * 12;

                        if (Math.Abs(sx - corner.X) < 200 && Math.Abs(sy - corner.Y) < 100)
                        {
                            minGameX = Math.Min(minGameX, gx - 20);
                            maxGameX = Math.Max(maxGameX, gx + 20);
                            minGameY = Math.Min(minGameY, gy - 20);
                            maxGameY = Math.Max(maxGameY, gy + 20);
                        }
                    }
                }
            }

            // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆ
            foreach (var s32Data in _document.S32Files.Values)
            {
                // ä½¿ç”¨ GetLoc è¨ˆç®—å€å¡Šä½ç½®
                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        // ä½¿ç”¨ GetLoc + drawTilBlock å…¬å¼è¨ˆç®—åƒç´ ä½ç½®
                        int localBaseX = 0;
                        int localBaseY = 63 * 12;
                        localBaseX -= 24 * (x / 2);
                        localBaseY -= 12 * (x / 2);

                        int X = mx + localBaseX + x * 24 + y * 24;
                        int Y = my + localBaseY + y * 12;

                        // è±å½¢çš„ä¸­å¿ƒé»
                        Point centerPoint = new Point(X + 12, Y + 12);

                        // æª¢æŸ¥ä¸­å¿ƒé»æ˜¯å¦åœ¨é¸æ“‡å€åŸŸå…§ï¼ˆä½¿ç”¨45åº¦è±å½¢åˆ¤æ–·ï¼‰
                        // å°‡é¸æ“‡çŸ©å½¢è¦–ç‚ºè¢å¹•ä¸Šçš„è±å½¢å€åŸŸ
                        if (IsPointInIsometricRegion(centerPoint, region))
                        {
                            cells.Add(new SelectedCell
                            {
                                S32Data = s32Data,
                                LocalX = x,
                                LocalY = y
                            });
                        }
                    }
                }
            }

            return cells;
        }

        // æª¢æŸ¥é»æ˜¯å¦åœ¨ç­‰è·æŠ•å½±çš„è±å½¢å€åŸŸå…§ï¼ˆ2:1 æ¯”ä¾‹ï¼‰
        private bool IsPointInIsometricRegion(Point point, Rectangle screenRect)
        {
            // è¢å¹•çŸ©å½¢çš„ä¸­å¿ƒé»
            float centerX = screenRect.Left + screenRect.Width / 2f;
            float centerY = screenRect.Top + screenRect.Height / 2f;

            // å°‡é»ç›¸å°æ–¼ä¸­å¿ƒçš„åç§»
            float dx = point.X - centerX;
            float dy = point.Y - centerY;

            // ç­‰è·æŠ•å½±è±å½¢ï¼ˆ2:1 æ¯”ä¾‹ï¼‰
            // å–å¯¬å’Œé«˜çš„è¼ƒå¤§å€¼ä¾†æ±ºå®šè±å½¢å¤§å°ï¼Œä¿æŒ 2:1 æ¯”ä¾‹
            float size = Math.Max(screenRect.Width, screenRect.Height * 2);
            float halfWidth = size / 2f;      // æ°´å¹³æ–¹å‘åŠå¯¬
            float halfHeight = size / 4f;     // å‚ç›´æ–¹å‘åŠé«˜ï¼ˆ2:1 æ¯”ä¾‹ï¼‰

            // ä½¿ç”¨è±å½¢çš„æ¨™æº–åˆ¤æ–·å…¬å¼: |x/a| + |y/b| <= 1
            float normalizedX = Math.Abs(dx) / halfWidth;
            float normalizedY = Math.Abs(dy) / halfHeight;

            return (normalizedX + normalizedY) <= 1.0f;
        }

        // æ‰¹é‡åˆªé™¤å€åŸŸå…§é¸ä¸­å±¤çš„è³‡æ–™ï¼ˆæ ¹æ“šè¤‡è£½è¨­å®š checkboxï¼‰
        private void DeleteAllLayer4ObjectsInRegion(List<SelectedCell> cells)
        {
            bool deleteLayer1 = copySettingLayer1;
            bool deleteLayer2 = copySettingLayer2;
            bool deleteLayer3 = copySettingLayer3;
            bool deleteLayer4 = copySettingLayer4;
            bool deleteLayer5to8 = copySettingLayer5to8;

            if (!deleteLayer1 && !deleteLayer2 && !deleteLayer3 && !deleteLayer4 && !deleteLayer5to8)
            {
                this.toolStripStatusLabel1.Text = "è«‹é»æ“Šã€Œè¤‡è£½è¨­å®š...ã€æŒ‰éˆ•é¸æ“‡è¦åˆªé™¤çš„åœ–å±¤";
                return;
            }

            // çµ±è¨ˆè¦åˆªé™¤çš„è³‡æ–™
            int layer1Count = 0, layer2Count = 0, layer3Count = 0, layer4Count = 0, layer5to8Count = 0;
            Dictionary<S32Data, List<ObjectTile>> objectsToDeleteByS32 = new Dictionary<S32Data, List<ObjectTile>>();
            HashSet<S32Data> affectedS32 = new HashSet<S32Data>();

            // å…ˆçµ±è¨ˆæ•¸é‡
            foreach (var cell in cells)
            {
                int layer3X = cell.LocalX / 2;

                // Layer1 è³‡æ–™çµ±è¨ˆ
                if (deleteLayer1)
                {
                    int layer1X = cell.LocalX;  // cell.LocalX å·²ç¶“æ˜¯ Layer3 * 2
                    if (layer1X >= 0 && layer1X < 128)
                    {
                        var cell1 = cell.S32Data.Layer1[cell.LocalY, layer1X];
                        if (cell1 != null && cell1.TileId > 0) layer1Count++;
                    }
                    if (layer1X + 1 >= 0 && layer1X + 1 < 128)
                    {
                        var cell2 = cell.S32Data.Layer1[cell.LocalY, layer1X + 1];
                        if (cell2 != null && cell2.TileId > 0) layer1Count++;
                    }
                }

                // Layer3 è³‡æ–™çµ±è¨ˆ
                if (deleteLayer3)
                {
                    if (layer3X >= 0 && layer3X < 64)
                    {
                        var attr = cell.S32Data.Layer3[cell.LocalY, layer3X];
                        if (attr != null && (attr.Attribute1 != 0 || attr.Attribute2 != 0)) layer3Count++;
                    }
                }

                // Layer4 ç‰©ä»¶çµ±è¨ˆå·²ç§»è‡³è·¨å€å¡Šæœç´¢çµ±ä¸€è™•ç†

                affectedS32.Add(cell.S32Data);
            }

            // Layer4 è·¨å€å¡Šç‰©ä»¶æœç´¢ï¼šéæ­·æ‰€æœ‰ S32ï¼Œæ‰¾å‡ºåº§æ¨™ç²¾ç¢ºè½åœ¨é¸å–ç¯„åœå…§çš„ç‰©ä»¶
            if (deleteLayer4 && cells.Count > 0)
            {
                // å»ºç«‹é¸å–æ ¼å­çš„å…¨åŸŸåº§æ¨™é›†åˆ (Layer3 åº§æ¨™ç³»)
                var selectedGlobalCells = new HashSet<(int x, int y)>();
                foreach (var cell in cells)
                {
                    int globalX = cell.S32Data.SegInfo.nLinBeginX + cell.LocalX / 2;
                    int globalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                    selectedGlobalCells.Add((globalX, globalY));
                }

                // éæ­·æ‰€æœ‰ S32 æª”æ¡ˆæœç´¢ç‰©ä»¶ï¼ˆç²¾ç¢ºåŒ¹é…é¸å–æ ¼å­ï¼‰
                foreach (var s32Data in _document.S32Files.Values)
                {
                    int segStartX = s32Data.SegInfo.nLinBeginX;
                    int segStartY = s32Data.SegInfo.nLinBeginY;

                    foreach (var obj in s32Data.Layer4)
                    {
                        // è¨ˆç®—ç‰©ä»¶çš„å…¨åŸŸåº§æ¨™ (è€ƒæ…®ç‰©ä»¶ X å¯èƒ½è¶…å‡º 0-127 ç¯„åœï¼Œå³æº¢å‡ºåˆ°ç›¸é„°å€å¡Š)
                        // ç‰©ä»¶çš„ X ç¯„åœå¯é” 0-255ï¼ŒX/2 ç¯„åœç‚º 0-127ï¼Œå¯èƒ½è¶…å‡ºç•¶å‰ S32 çš„ 64 æ ¼ç¯„åœ
                        int objGlobalX = segStartX + obj.X / 2;
                        int objGlobalY = segStartY + obj.Y;

                        // ç²¾ç¢ºæª¢æŸ¥æ˜¯å¦åœ¨é¸å–çš„æ ¼å­å…§
                        if (selectedGlobalCells.Contains((objGlobalX, objGlobalY)))
                        {
                            // é¿å…é‡è¤‡åŠ å…¥
                            if (!objectsToDeleteByS32.ContainsKey(s32Data))
                            {
                                objectsToDeleteByS32[s32Data] = new List<ObjectTile>();
                            }
                            if (!objectsToDeleteByS32[s32Data].Contains(obj))
                            {
                                objectsToDeleteByS32[s32Data].Add(obj);
                                layer4Count++;
                            }
                        }
                    }
                }
            }

            // Layer2 çµ±è¨ˆï¼ˆæ•´å€‹ S32 å…±ç”¨çš„è³‡æ–™ï¼‰
            if (deleteLayer2)
            {
                foreach (var s32 in affectedS32)
                {
                    layer2Count += s32.Layer2.Count;
                }
            }

            // Layer5 çµ±è¨ˆï¼ˆæŒ‰æ ¼å­ä½ç½®åˆªé™¤é€æ˜åœ–å¡Šï¼‰
            Dictionary<S32Data, List<Layer5Item>> layer5ToDeleteByS32 = new Dictionary<S32Data, List<Layer5Item>>();
            if (deleteLayer5to8)
            {
                foreach (var cell in cells)
                {
                    // Layer5 çš„ X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                    // cell.LocalX å·²ç¶“æ˜¯ Layer1 åº§æ¨™ (0-127)
                    // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆLocalX å’Œ LocalX+1ï¼‰
                    int layer1X = cell.LocalX;
                    var layer5Items = cell.S32Data.Layer5.Where(l => (l.X == layer1X || l.X == layer1X + 1) && l.Y == cell.LocalY).ToList();
                    if (layer5Items.Count > 0)
                    {
                        if (!layer5ToDeleteByS32.ContainsKey(cell.S32Data))
                        {
                            layer5ToDeleteByS32[cell.S32Data] = new List<Layer5Item>();
                        }
                        layer5ToDeleteByS32[cell.S32Data].AddRange(layer5Items);
                        layer5to8Count += layer5Items.Count;
                    }
                }
            }

            if (layer1Count == 0 && layer2Count == 0 && layer3Count == 0 && layer4Count == 0 && layer5to8Count == 0)
            {
                this.toolStripStatusLabel1.Text = $"é¸ä¸­çš„ {cells.Count} å€‹æ ¼å­å…§æ²’æœ‰å¯åˆªé™¤çš„è³‡æ–™";
                return;
            }

            // çµ„åˆç¢ºèªè¨Šæ¯
            var deleteParts = new List<string>();
            if (deleteLayer1 && layer1Count > 0) deleteParts.Add($"L1:{layer1Count}");
            if (deleteLayer2 && layer2Count > 0) deleteParts.Add($"L2:{layer2Count} (æ•´å€‹S32)");
            if (deleteLayer3 && layer3Count > 0) deleteParts.Add($"L3:{layer3Count}");
            if (deleteLayer4 && layer4Count > 0) deleteParts.Add($"L4:{layer4Count}");
            if (deleteLayer5to8 && layer5to8Count > 0) deleteParts.Add($"L5:{layer5to8Count}");

            string deleteInfo = string.Join(", ", deleteParts);

            // ç¢ºèªåˆªé™¤
            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤é¸ä¸­å€åŸŸå…§çš„è³‡æ–™å—ï¼Ÿ\n" +
                $"é¸ä¸­æ ¼å­æ•¸: {cells.Count}\n" +
                $"åˆªé™¤é …ç›®: {deleteInfo}\n" +
                $"å½±éŸ¿ {affectedS32.Count} å€‹ S32 æª”æ¡ˆ",
                "ç¢ºèªæ‰¹é‡åˆªé™¤",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result == DialogResult.Yes)
            {
                // å»ºç«‹ Undo è¨˜éŒ„
                var undoAction = new UndoAction
                {
                    Description = $"æ‰¹é‡åˆªé™¤ {cells.Count} æ ¼ ({deleteInfo})"
                };

                // è¨˜éŒ„ Layer4 ç‰©ä»¶åˆ° Undo
                if (deleteLayer4)
                {
                    foreach (var kvp in objectsToDeleteByS32)
                    {
                        S32Data s32Data = kvp.Key;
                        int segStartX = s32Data.SegInfo.nLinBeginX;
                        int segStartY = s32Data.SegInfo.nLinBeginY;

                        foreach (var obj in kvp.Value)
                        {
                            undoAction.RemovedObjects.Add(new UndoObjectInfo
                            {
                                S32FilePath = s32Data.FilePath,
                                GameX = segStartX + obj.X / 2,
                                GameY = segStartY + obj.Y,
                                LocalX = obj.X,
                                LocalY = obj.Y,
                                GroupId = obj.GroupId,
                                Layer = obj.Layer,
                                IndexId = obj.IndexId,
                                TileId = obj.TileId
                            });
                        }
                    }
                }

                // å„²å­˜ Undo è¨˜éŒ„
                PushUndoAction(undoAction);

                // åŸ·è¡Œåˆªé™¤
                foreach (var cell in cells)
                {
                    int layer3X = cell.LocalX / 2;

                    // åˆªé™¤ Layer1 è³‡æ–™ï¼ˆæ¸…ç©ºç‚ºé è¨­å€¼ï¼‰
                    if (deleteLayer1)
                    {
                        int layer1X = cell.LocalX;
                        if (layer1X >= 0 && layer1X < 128)
                        {
                            cell.S32Data.Layer1[cell.LocalY, layer1X] = new TileCell { X = layer1X, Y = cell.LocalY, TileId = 0, IndexId = 0 };
                        }
                        if (layer1X + 1 >= 0 && layer1X + 1 < 128)
                        {
                            cell.S32Data.Layer1[cell.LocalY, layer1X + 1] = new TileCell { X = layer1X + 1, Y = cell.LocalY, TileId = 0, IndexId = 0 };
                        }
                    }

                    // åˆªé™¤ Layer3 è³‡æ–™ï¼ˆæ¸…ç©ºç‚ºé è¨­å€¼ï¼‰
                    if (deleteLayer3)
                    {
                        if (layer3X >= 0 && layer3X < 64)
                        {
                            cell.S32Data.Layer3[cell.LocalY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                        }
                    }

                    cell.S32Data.IsModified = true;
                }

                // åˆªé™¤ Layer4 ç‰©ä»¶
                if (deleteLayer4)
                {
                    foreach (var kvp in objectsToDeleteByS32)
                    {
                        S32Data s32Data = kvp.Key;
                        foreach (var obj in kvp.Value)
                        {
                            s32Data.Layer4.Remove(obj);
                        }
                        Layer4Index_RemoveRange(s32Data, kvp.Value);
                        s32Data.IsModified = true;
                    }
                }

                // åˆªé™¤ Layer2ï¼ˆæ•´å€‹ S32 çš„è³‡æ–™ï¼‰
                int layer2Deleted = 0;
                if (deleteLayer2)
                {
                    foreach (var s32 in affectedS32)
                    {
                        layer2Deleted += s32.Layer2.Count;
                        s32.Layer2.Clear();
                        s32.IsModified = true;
                    }
                }

                // åˆªé™¤ Layer5ï¼ˆæŒ‰æ ¼å­åˆªé™¤é€æ˜åœ–å¡Šï¼‰
                int layer5Deleted = 0;
                if (deleteLayer5to8)
                {
                    foreach (var kvp in layer5ToDeleteByS32)
                    {
                        S32Data s32Data = kvp.Key;
                        foreach (var item in kvp.Value)
                        {
                            s32Data.Layer5.Remove(item);
                            layer5Deleted++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“
                ClearS32BlockCache();
                RenderS32Map();

                // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
                UpdateLayer5InvalidButton();

                // çµ„åˆçµæœè¨Šæ¯
                var resultParts = new List<string>();
                if (deleteLayer1 && layer1Count > 0) resultParts.Add($"L1:{layer1Count}");
                if (deleteLayer2 && layer2Deleted > 0) resultParts.Add($"L2:{layer2Deleted}");
                if (deleteLayer3 && layer3Count > 0) resultParts.Add($"L3:{layer3Count}");
                if (deleteLayer4 && layer4Count > 0) resultParts.Add($"L4:{layer4Count}");
                if (deleteLayer5to8 && layer5Deleted > 0) resultParts.Add($"L5:{layer5Deleted}");

                string resultInfo = resultParts.Count > 0 ? string.Join(", ", resultParts) : "ç„¡";
                this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ {cells.Count} æ ¼ ({resultInfo})ï¼Œå½±éŸ¿ {affectedS32.Count} å€‹ S32 æª”æ¡ˆ";
            }
        }

        // åˆªé™¤æŒ‡å®šæ ¼å­çš„æ‰€æœ‰ç¬¬å››å±¤ç‰©ä»¶
        private void DeleteAllLayer4ObjectsAtCell(int cellX, int cellY)
        {
            // æ‰¾å‡ºè©²æ ¼å­çš„æ‰€æœ‰ç‰©ä»¶
            var objectsAtCell = currentS32Data.Layer4.Where(o => o.X == cellX && o.Y == cellY).ToList();

            if (objectsAtCell.Count == 0)
            {
                this.toolStripStatusLabel1.Text = $"æ ¼å­ ({cellX},{cellY}) æ²’æœ‰ç¬¬å››å±¤ç‰©ä»¶";
                return;
            }

            // ç¢ºèªåˆªé™¤ï¼ˆè¨ˆç®—éŠæˆ²åº§æ¨™ï¼ŒLayer3 å°ºåº¦ï¼‰
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;
            int gameX = currentS32FileItem.SegInfo.nLinBeginX + layer3X;
            int gameY = currentS32FileItem.SegInfo.nLinBeginY + cellY;

            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤æ ¼å­ ({cellX},{cellY}) çš„æ‰€æœ‰ç¬¬å››å±¤ç‰©ä»¶å—ï¼Ÿ\n" +
                $"éŠæˆ²åº§æ¨™: ({gameX},{gameY})\n" +
                $"å…±æœ‰ {objectsAtCell.Count} å€‹ç‰©ä»¶",
                "ç¢ºèªåˆªé™¤",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result == DialogResult.Yes)
            {
                // å»ºç«‹ Undo è¨˜éŒ„
                var undoAction = new UndoAction
                {
                    Description = $"åˆªé™¤æ ¼å­ ({gameX},{gameY}) çš„ {objectsAtCell.Count} å€‹ Layer4 ç‰©ä»¶"
                };

                // åˆªé™¤æ‰€æœ‰ç‰©ä»¶
                foreach (var obj in objectsAtCell)
                {
                    // è¨˜éŒ„åˆ° Undoï¼ˆåˆªé™¤çš„ç‰©ä»¶ï¼‰
                    undoAction.RemovedObjects.Add(new UndoObjectInfo
                    {
                        S32FilePath = currentS32Data.FilePath,
                        GameX = gameX,
                        GameY = gameY,
                        LocalX = obj.X,
                        LocalY = obj.Y,
                        GroupId = obj.GroupId,
                        Layer = obj.Layer,
                        IndexId = obj.IndexId,
                        TileId = obj.TileId
                    });

                    currentS32Data.Layer4.Remove(obj);
                }
                Layer4Index_RemoveRange(currentS32Data, objectsAtCell);

                // å„²å­˜ Undo è¨˜éŒ„
                PushUndoAction(undoAction);

                isS32Modified = true;
                RenderS32Map();
                this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤æ ¼å­ ({cellX},{cellY}) çš„ {objectsAtCell.Count} å€‹ç¬¬å››å±¤ç‰©ä»¶";
            }
        }

        // æª¢æŸ¥é»æ˜¯å¦åœ¨è±å½¢å…§
        private bool IsPointInDiamond(Point p, Point p1, Point p2, Point p3, Point p4)
        {
            // ä½¿ç”¨ Region ä¾†æª¢æ¸¬
            using (System.Drawing.Drawing2D.GraphicsPath path = new System.Drawing.Drawing2D.GraphicsPath())
            {
                path.AddPolygon(new Point[] { p1, p2, p3, p4 });
                using (Region region = new Region(path))
                {
                    return region.IsVisible(p);
                }
            }
        }

        // é¡¯ç¤ºæ ¼å­çš„å››å±¤ Tile å°è©±æ¡†
        private void ShowCellLayersDialog(int cellX, int cellY)
        {
            // è¨ˆç®—éŠæˆ²åº§æ¨™ï¼ˆLayer3 å°ºåº¦ï¼‰
            // cellX æ˜¯ Layer1 åº§æ¨™ (0-127)ï¼Œéœ€è½‰æ›ç‚º Layer3 åº§æ¨™ (0-63)
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;
            int gameX = currentS32FileItem.SegInfo.nLinBeginX + layer3X;
            int gameY = currentS32FileItem.SegInfo.nLinBeginY + cellY;

            // å‰µå»ºå°è©±æ¡†
            Form layerForm = new Form();
            layerForm.Text = $"æ ¼å­è©³ç´°è³‡è¨Š - æ ¼å­åº§æ¨™ ({cellX}, {cellY}) - éŠæˆ²åº§æ¨™ ({gameX}, {gameY})";
            layerForm.Size = new Size(700, 600);
            layerForm.FormBorderStyle = FormBorderStyle.Sizable;
            layerForm.StartPosition = FormStartPosition.CenterParent;

            // ä½¿ç”¨ TabControl ä¾†çµ„ç¹”ä¸åŒçš„è³‡è¨Š
            TabControl tabControl = new TabControl();
            tabControl.Dock = DockStyle.Fill;

            // Tab 1: å„å±¤è³‡æ–™
            TabPage tabLayers = new TabPage("å„å±¤è³‡æ–™");
            TableLayoutPanel table = new TableLayoutPanel();
            table.Dock = DockStyle.Fill;
            table.ColumnCount = 2;
            table.RowCount = 4;
            table.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50));
            table.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50));
            table.RowStyles.Add(new RowStyle(SizeType.Percent, 25));
            table.RowStyles.Add(new RowStyle(SizeType.Percent, 25));
            table.RowStyles.Add(new RowStyle(SizeType.Percent, 25));
            table.RowStyles.Add(new RowStyle(SizeType.Percent, 25));

            // ç¬¬ä¸€å±¤ï¼ˆåœ°æ¿ï¼‰
            var layer1Panel = CreateLayerPanel(cellX, cellY, 1);
            table.Controls.Add(layer1Panel, 0, 0);

            // ç¬¬äºŒå±¤ï¼ˆç›®å‰æ²’æœ‰è¦–è¦ºåŒ–ï¼‰
            var layer2Panel = CreateLayer2Panel(cellX, cellY);
            table.Controls.Add(layer2Panel, 1, 0);

            // ç¬¬ä¸‰å±¤ï¼ˆå±¬æ€§ï¼‰
            var layer3Panel = CreateLayer3Panel(cellX, cellY);
            table.Controls.Add(layer3Panel, 0, 1);

            // ç¬¬å››å±¤ï¼ˆç‰©ä»¶ï¼‰ - åªé¡¯ç¤ºè©²ä½ç½®çš„ç‰©ä»¶
            var layer4Panel = CreateLayer4Panel(cellX, cellY);
            table.Controls.Add(layer4Panel, 1, 1);

            // ç¬¬äº”å±¤ï¼ˆé€æ˜åœ–å¡Šï¼‰
            var layer5Panel = CreateLayer5Panel(cellX, cellY);
            table.Controls.Add(layer5Panel, 0, 2);

            // ç¬¬å…­å±¤ï¼ˆä½¿ç”¨çš„Tilï¼‰
            var layer6Panel = CreateLayer6Panel(cellX, cellY);
            table.Controls.Add(layer6Panel, 1, 2);

            // ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰
            var layer7Panel = CreateLayer7Panel(cellX, cellY);
            table.Controls.Add(layer7Panel, 0, 3);

            // ç¬¬å…«å±¤ï¼ˆç‰¹æ•ˆï¼‰
            var layer8Panel = CreateLayer8Panel(cellX, cellY);
            table.Controls.Add(layer8Panel, 1, 3);

            tabLayers.Controls.Add(table);
            tabControl.TabPages.Add(tabLayers);

            // Tab 2: æ‰€æœ‰ç›¸é—œç‰©ä»¶ï¼ˆåŒ…å«å‘¨åœï¼‰
            TabPage tabAllObjects = new TabPage("æ‰€æœ‰ç›¸é—œç‰©ä»¶");
            var allObjectsPanel = CreateAllRelatedObjectsPanel(cellX, cellY);
            tabAllObjects.Controls.Add(allObjectsPanel);
            tabControl.TabPages.Add(tabAllObjects);

            // Tab 3: æ¸²æŸ“è³‡è¨Š
            TabPage tabRenderInfo = new TabPage("æ¸²æŸ“è³‡è¨Š");
            var renderInfoPanel = CreateRenderInfoPanel(cellX, cellY);
            tabRenderInfo.Controls.Add(renderInfoPanel);
            tabControl.TabPages.Add(tabRenderInfo);

            layerForm.Controls.Add(tabControl);
            layerForm.ShowDialog();
        }

        // å‰µå»ºç¬¬ä¸€å±¤é¢æ¿
        private Panel CreateLayerPanel(int x, int y, int layer)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬1å±¤ (åœ°æ¿)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            PictureBox pb = new PictureBox();
            pb.Dock = DockStyle.Fill;
            pb.SizeMode = PictureBoxSizeMode.Zoom;
            pb.BackColor = Color.Black;

            var cell = currentS32Data.Layer1[y, x];
            if (cell != null && cell.TileId > 0)
            {
                pb.Image = LoadTileEnlarged(cell.TileId, cell.IndexId, 128);

                Panel bottomPanel = new Panel();
                bottomPanel.Dock = DockStyle.Bottom;
                bottomPanel.Height = 60;

                Label info = new Label();
                info.Text = $"Tile ID: {cell.TileId}\nIndex: {cell.IndexId}";
                info.Dock = DockStyle.Top;
                info.Height = 40;
                info.TextAlign = ContentAlignment.MiddleCenter;
                bottomPanel.Controls.Add(info);

                // åˆªé™¤æŒ‰éˆ•
                Button btnDelete = new Button();
                btnDelete.Text = "åˆªé™¤æ­¤ Tile";
                btnDelete.Dock = DockStyle.Bottom;
                btnDelete.Height = 25;
                btnDelete.BackColor = Color.Red;
                btnDelete.ForeColor = Color.White;
                btnDelete.Click += (s, e) =>
                {
                    if (MessageBox.Show("ç¢ºå®šè¦åˆªé™¤æ­¤ Tile å—ï¼Ÿ", "ç¢ºèª", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                    {
                        currentS32Data.Layer1[y, x] = new TileCell { X = x, Y = y, TileId = 0, IndexId = 0 };
                        isS32Modified = true;
                        RenderS32Map();
                        this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ç¬¬1å±¤ ({x},{y}) çš„ Tile";

                        // æ›´æ–°ç•¶å‰é¢æ¿é¡¯ç¤º
                        pb.Image = null;
                        info.Text = "å·²åˆªé™¤";
                        btnDelete.Enabled = false;
                    }
                };
                bottomPanel.Controls.Add(btnDelete);

                panel.Controls.Add(bottomPanel);
            }
            else
            {
                Label noData = new Label();
                noData.Text = "ç„¡è³‡æ–™";
                noData.Dock = DockStyle.Fill;
                noData.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(noData);
            }

            panel.Controls.Add(pb);
            return panel;
        }

        // å‰µå»ºç¬¬äºŒå±¤é¢æ¿
        private Panel CreateLayer2Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬2å±¤ (è³‡æ–™)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            Label info = new Label();
            info.Text = $"å…± {currentS32Data.Layer2.Count} é …è³‡æ–™\n(æ­¤å±¤ç„¡å°æ‡‰æ ¼å­è³‡æ–™)";
            info.Dock = DockStyle.Fill;
            info.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(info);

            return panel;
        }

        // å‰µå»ºç¬¬ä¸‰å±¤é¢æ¿
        private Panel CreateLayer3Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬3å±¤ (å±¬æ€§)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            // æ³¨æ„ï¼šç¬¬3å±¤æ˜¯ 64x64ï¼Œç¬¬1å±¤æ˜¯ 64x128
            // æ‰€ä»¥éœ€è¦å°‡ x åº§æ¨™é™¤ä»¥ 2
            int layer3X = x / 2;
            if (layer3X >= 64) layer3X = 63;

            var attr = currentS32Data.Layer3[y, layer3X];
            if (attr != null)
            {
                Label info = new Label();
                string attrText = $"ç¬¬3å±¤åº§æ¨™: [{layer3X}, {y}]\n\n";
                attrText += $"Attribute1 (å·¦ä¸Šé‚Š):\n";
                attrText += $"  {attr.Attribute1} (0x{attr.Attribute1:X4})\n\n";
                attrText += $"Attribute2 (å³ä¸Šé‚Š):\n";
                attrText += $"  {attr.Attribute2} (0x{attr.Attribute2:X4})\n";

                info.Text = attrText;
                info.Dock = DockStyle.Fill;
                info.TextAlign = ContentAlignment.TopCenter;
                panel.Controls.Add(info);

                // åˆªé™¤æŒ‰éˆ•
                Button btnDelete = new Button();
                btnDelete.Text = "æ¸…é™¤å±¬æ€§";
                btnDelete.Dock = DockStyle.Bottom;
                btnDelete.Height = 25;
                btnDelete.BackColor = Color.Red;
                btnDelete.ForeColor = Color.White;
                btnDelete.Click += (s, e) =>
                {
                    if (MessageBox.Show("ç¢ºå®šè¦æ¸…é™¤æ­¤æ ¼çš„å±¬æ€§å—ï¼Ÿ", "ç¢ºèª", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                    {
                        currentS32Data.Layer3[y, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                        isS32Modified = true;
                        RenderS32Map();
                        this.toolStripStatusLabel1.Text = $"å·²æ¸…é™¤ç¬¬3å±¤ ({layer3X},{y}) çš„å±¬æ€§";

                        // æ›´æ–°ç•¶å‰é¢æ¿é¡¯ç¤º
                        info.Text = "å·²æ¸…é™¤å±¬æ€§";
                        btnDelete.Enabled = false;
                    }
                };
                panel.Controls.Add(btnDelete);
            }
            else
            {
                Label noData = new Label();
                noData.Text = "ç„¡è³‡æ–™";
                noData.Dock = DockStyle.Fill;
                noData.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(noData);
            }

            return panel;
        }

        // å‰µå»ºç¬¬å››å±¤é¢æ¿
        private Panel CreateLayer4Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬4å±¤ (ç‰©ä»¶)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            // æŸ¥æ‰¾è©²ä½ç½®çš„æ‰€æœ‰ç‰©ä»¶
            var objectsAtCell = currentS32Data.Layer4.Where(obj => obj.X == x && obj.Y == y).OrderBy(obj => obj.Layer).ToList();

            if (objectsAtCell.Count > 0)
            {
                FlowLayoutPanel flow = new FlowLayoutPanel();
                flow.Dock = DockStyle.Fill;
                flow.AutoScroll = true;
                flow.FlowDirection = FlowDirection.TopDown;
                flow.WrapContents = false;

                foreach (var obj in objectsAtCell)
                {
                    Panel objPanel = new Panel();
                    objPanel.Width = flow.Width - 25;
                    objPanel.Height = 210;
                    objPanel.BorderStyle = BorderStyle.FixedSingle;
                    objPanel.Margin = new Padding(5);

                    PictureBox pb = new PictureBox();
                    pb.Dock = DockStyle.Top;
                    pb.Height = 128;
                    pb.SizeMode = PictureBoxSizeMode.Zoom;
                    pb.BackColor = Color.Black;
                    pb.Image = LoadTileEnlarged(obj.TileId, obj.IndexId, 128);
                    objPanel.Controls.Add(pb);

                    Label info = new Label();
                    info.Text = $"Layer: {obj.Layer} | Group: {obj.GroupId}\nTile: {obj.TileId} | Index: {obj.IndexId}";
                    info.Dock = DockStyle.Bottom;
                    info.Height = 50;
                    info.TextAlign = ContentAlignment.MiddleCenter;
                    objPanel.Controls.Add(info);

                    // åˆªé™¤æŒ‰éˆ•
                    Button btnDeleteObj = new Button();
                    btnDeleteObj.Text = "åˆªé™¤æ­¤ç‰©ä»¶";
                    btnDeleteObj.Dock = DockStyle.Bottom;
                    btnDeleteObj.Height = 25;
                    btnDeleteObj.BackColor = Color.Red;
                    btnDeleteObj.ForeColor = Color.White;
                    var objToDelete = obj; // Capture for lambda
                    btnDeleteObj.Click += (s, e) =>
                    {
                        if (MessageBox.Show($"ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©ä»¶å—ï¼Ÿ\n(Group:{objToDelete.GroupId}, Layer:{objToDelete.Layer})", "ç¢ºèª", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                        {
                            currentS32Data.Layer4.Remove(objToDelete);
                            Layer4Index_Remove(currentS32Data, objToDelete);

                            isS32Modified = true;
                            RenderS32Map();
                            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ç¬¬4å±¤ç‰©ä»¶ ({x},{y})";

                            // æ›´æ–°ç•¶å‰é¢æ¿é¡¯ç¤º
                            pb.Image = null;
                            info.Text = "å·²åˆªé™¤";
                            btnDeleteObj.Enabled = false;
                        }
                    };
                    objPanel.Controls.Add(btnDeleteObj);

                    flow.Controls.Add(objPanel);
                }

                panel.Controls.Add(flow);
            }
            else
            {
                Label noData = new Label();
                noData.Text = "ç„¡ç‰©ä»¶";
                noData.Dock = DockStyle.Fill;
                noData.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(noData);
            }

            return panel;
        }

        // å‰µå»ºç¬¬äº”å±¤é¢æ¿ - å¯é€æ˜åŒ–çš„åœ–å¡Šï¼ˆåªé¡¯ç¤ºè©²æ ¼å­ç›¸é—œçš„é …ç›®ï¼‰
        private Panel CreateLayer5Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬5å±¤ (é€æ˜åœ–å¡Š)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            // åªç¯©é¸è©²æ ¼å­ç›¸é—œçš„ Layer5 é …ç›®
            // x æ˜¯ Layer1 åº§æ¨™ (0-127)ï¼Œy æ˜¯ Layer3 åº§æ¨™ (0-63)
            // Layer5 çš„ X æ˜¯ 0-127ï¼ŒY æ˜¯ 0-63
            // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆx å’Œ x+1ï¼‰
            var cellLayer5Items = new List<(int index, Layer5Item item)>();
            for (int i = 0; i < currentS32Data.Layer5.Count; i++)
            {
                var item5 = currentS32Data.Layer5[i];
                if ((item5.X == x || item5.X == x + 1) && item5.Y == y)
                {
                    cellLayer5Items.Add((i, item5));
                }
            }

            if (cellLayer5Items.Count > 0)
            {
                Label countLabel = new Label();
                countLabel.Text = $"æ­¤æ ¼æ•¸é‡: {cellLayer5Items.Count}";
                countLabel.Dock = DockStyle.Top;
                countLabel.Height = 20;
                countLabel.TextAlign = ContentAlignment.MiddleCenter;

                ListView listView = new ListView();
                listView.Dock = DockStyle.Fill;
                listView.View = View.Details;
                listView.FullRowSelect = true;
                listView.GridLines = true;
                listView.Font = new Font("Consolas", 9, FontStyle.Regular);

                listView.Columns.Add("ç´¢å¼•", 40);
                listView.Columns.Add("X", 40);
                listView.Columns.Add("Y", 40);
                listView.Columns.Add("ObjIdx", 60);
                listView.Columns.Add("Type", 50);

                foreach (var (idx, item5) in cellLayer5Items)
                {
                    var lvItem = new ListViewItem(idx.ToString());
                    lvItem.SubItems.Add(item5.X.ToString());
                    lvItem.SubItems.Add(item5.Y.ToString());
                    lvItem.SubItems.Add(item5.ObjectIndex.ToString());
                    lvItem.SubItems.Add(item5.Type.ToString());
                    listView.Items.Add(lvItem);
                }

                // å…ˆåŠ å…¥ Fill çš„æ§ä»¶ï¼Œå†åŠ å…¥ Top çš„æ§ä»¶ï¼ˆDock é †åºï¼‰
                panel.Controls.Add(listView);
                panel.Controls.Add(countLabel);
            }
            else
            {
                Label info = new Label();
                info.Text = "æ­¤æ ¼ç„¡è³‡æ–™";
                info.Dock = DockStyle.Fill;
                info.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(info);
            }

            return panel;
        }

        // å‰µå»ºç¬¬å…­å±¤é¢æ¿ - ä½¿ç”¨çš„ til
        private Panel CreateLayer6Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬6å±¤ (ä½¿ç”¨çš„Til)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            if (currentS32Data.Layer6.Count > 0)
            {
                Label countLabel = new Label();
                countLabel.Text = $"æ•¸é‡: {currentS32Data.Layer6.Count}";
                countLabel.Dock = DockStyle.Top;
                countLabel.Height = 20;
                countLabel.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(countLabel);

                ListView listView = new ListView();
                listView.Dock = DockStyle.Fill;
                listView.View = View.Details;
                listView.FullRowSelect = true;
                listView.GridLines = true;
                listView.Font = new Font("Consolas", 9, FontStyle.Regular);

                listView.Columns.Add("ç´¢å¼•", 50);
                listView.Columns.Add("TilId", 80);
                listView.Columns.Add("åå…­é€²ä½", 80);

                for (int i = 0; i < currentS32Data.Layer6.Count; i++)
                {
                    var lvItem = new ListViewItem(i.ToString());
                    lvItem.SubItems.Add(currentS32Data.Layer6[i].ToString());
                    lvItem.SubItems.Add($"0x{currentS32Data.Layer6[i]:X8}");
                    listView.Items.Add(lvItem);
                }

                panel.Controls.Add(listView);
            }
            else
            {
                Label info = new Label();
                info.Text = "ç„¡è³‡æ–™";
                info.Dock = DockStyle.Fill;
                info.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(info);
            }

            return panel;
        }

        // å‰µå»ºç¬¬ä¸ƒå±¤é¢æ¿ - å‚³é€é»ã€å…¥å£é»
        private Panel CreateLayer7Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬7å±¤ (å‚³é€é»)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            if (currentS32Data.Layer7.Count > 0)
            {
                Label countLabel = new Label();
                countLabel.Text = $"æ•¸é‡: {currentS32Data.Layer7.Count}";
                countLabel.Dock = DockStyle.Top;
                countLabel.Height = 20;
                countLabel.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(countLabel);

                ListView listView = new ListView();
                listView.Dock = DockStyle.Fill;
                listView.View = View.Details;
                listView.FullRowSelect = true;
                listView.GridLines = true;
                listView.Font = new Font("Consolas", 9, FontStyle.Regular);

                listView.Columns.Add("åç¨±", 80);
                listView.Columns.Add("X", 30);
                listView.Columns.Add("Y", 30);
                listView.Columns.Add("ç›®æ¨™åœ°åœ–", 60);
                listView.Columns.Add("å‚³é€é»ID", 60);

                for (int i = 0; i < currentS32Data.Layer7.Count; i++)
                {
                    var item7 = currentS32Data.Layer7[i];
                    var lvItem = new ListViewItem(item7.Name);
                    lvItem.SubItems.Add(item7.X.ToString());
                    lvItem.SubItems.Add(item7.Y.ToString());
                    lvItem.SubItems.Add(item7.TargetMapId.ToString());
                    lvItem.SubItems.Add(item7.PortalId.ToString());
                    listView.Items.Add(lvItem);
                }

                panel.Controls.Add(listView);
            }
            else
            {
                Label info = new Label();
                info.Text = "ç„¡è³‡æ–™";
                info.Dock = DockStyle.Fill;
                info.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(info);
            }

            return panel;
        }

        // å‰µå»ºç¬¬å…«å±¤é¢æ¿ - ç‰¹æ•ˆã€è£é£¾å“
        private Panel CreateLayer8Panel(int x, int y)
        {
            Panel panel = new Panel();
            panel.BorderStyle = BorderStyle.FixedSingle;
            panel.Dock = DockStyle.Fill;

            Label title = new Label();
            title.Text = "ç¬¬8å±¤ (ç‰¹æ•ˆ)";
            title.Font = new Font("Arial", 10, FontStyle.Bold);
            title.Dock = DockStyle.Top;
            title.Height = 25;
            title.TextAlign = ContentAlignment.MiddleCenter;
            panel.Controls.Add(title);

            if (currentS32Data.Layer8.Count > 0)
            {
                Label countLabel = new Label();
                countLabel.Text = $"æ•¸é‡: {currentS32Data.Layer8.Count}";
                countLabel.Dock = DockStyle.Top;
                countLabel.Height = 20;
                countLabel.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(countLabel);

                ListView listView = new ListView();
                listView.Dock = DockStyle.Fill;
                listView.View = View.Details;
                listView.FullRowSelect = true;
                listView.GridLines = true;
                listView.Font = new Font("Consolas", 9, FontStyle.Regular);

                listView.Columns.Add("SprId", 60);
                listView.Columns.Add("X", 50);
                listView.Columns.Add("Y", 50);
                listView.Columns.Add("Unknown", 80);

                for (int i = 0; i < currentS32Data.Layer8.Count; i++)
                {
                    var item8 = currentS32Data.Layer8[i];
                    var lvItem = new ListViewItem(item8.SprId.ToString());
                    lvItem.SubItems.Add(item8.X.ToString());
                    lvItem.SubItems.Add(item8.Y.ToString());
                    lvItem.SubItems.Add($"0x{item8.ExtendedData:X8}");
                    listView.Items.Add(lvItem);
                }

                panel.Controls.Add(listView);
            }
            else
            {
                Label info = new Label();
                info.Text = "ç„¡è³‡æ–™";
                info.Dock = DockStyle.Fill;
                info.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(info);
            }

            return panel;
        }

        // Tile é›™æ“Šäº‹ä»¶ - é¡¯ç¤ºé è¦½+è©³ç´°è³‡æ–™
        private void lvTiles_DoubleClick(object sender, EventArgs e)
        {
            if (lvTiles.SelectedItems.Count == 0)
                return;

            var selectedItem = lvTiles.SelectedItems[0];
            var tileInfo = selectedItem.Tag as TileInfo;
            if (tileInfo == null)
                return;

            // é¡¯ç¤ºè©³ç´°è³‡æ–™è¦–çª—ï¼ˆå«é è¦½ï¼‰
            ShowTileInfoWithPreview(tileInfo);
        }

        // é¡¯ç¤º Tile é è¦½+è©³ç´°è³‡æ–™æ•´åˆè¦–çª—
        private void ShowTileInfoWithPreview(TileInfo tileInfo)
        {
            // æ”¶é›†æ‰€æœ‰ä½¿ç”¨æ­¤ TileId çš„ä½ç½®
            List<(int globalX, int globalY, string layer, int groupId, S32Data s32, int l4X, int l4Y)> locations =
                new List<(int, int, string, int, S32Data, int, int)>();

            foreach (var s32Data in _document.S32Files.Values)
            {
                int segStartX = s32Data.SegInfo.nLinBeginX;
                int segStartY = s32Data.SegInfo.nLinBeginY;

                // Layer1
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId == tileInfo.TileId)
                        {
                            int layer3X = x / 2;
                            int globalX = segStartX + layer3X;
                            int globalY = segStartY + y;
                            locations.Add((globalX, globalY, "L1", 0, s32Data, -1, -1));
                        }
                    }
                }

                // Layer4
                foreach (var obj in s32Data.Layer4)
                {
                    if (obj.TileId == tileInfo.TileId)
                    {
                        int layer3X = obj.X / 2;
                        int globalX = segStartX + layer3X;
                        int globalY = segStartY + obj.Y;
                        locations.Add((globalX, globalY, "L4", obj.GroupId, s32Data, obj.X, obj.Y));
                    }
                }
            }

            // å»ºç«‹è¦–çª—
            Form infoForm = new Form
            {
                Text = $"Tile {tileInfo.TileId} è©³ç´°è³‡è¨Š",
                Size = new Size(680, 480),
                StartPosition = FormStartPosition.CenterParent,
                FormBorderStyle = FormBorderStyle.Sizable,
                MinimizeBox = false
            };

            // å·¦å´é è¦½å€
            Panel previewPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(150, 180),
                BorderStyle = BorderStyle.FixedSingle
            };

            Bitmap enlargedTile = LoadTileEnlarged(tileInfo.TileId, tileInfo.IndexId, 144);
            PictureBox pbPreview = new PictureBox
            {
                Image = enlargedTile,
                SizeMode = PictureBoxSizeMode.Zoom,
                Dock = DockStyle.Fill,
                BackColor = Color.Black
            };
            previewPanel.Controls.Add(pbPreview);

            // åŸºæœ¬è³‡è¨Š
            Label lblBasicInfo = new Label
            {
                Text = $"TileId: {tileInfo.TileId}\nIndexId: {tileInfo.IndexId}\nä½¿ç”¨æ¬¡æ•¸: {tileInfo.UsageCount}\nç¸½å…± {locations.Count} å€‹ä½ç½®",
                Location = new Point(10, 195),
                Size = new Size(150, 80),
                Font = new Font(Font.FontFamily, 9, FontStyle.Regular)
            };

            // å³å´å€åŸŸ - è·³è½‰åº§æ¨™
            Label lblJump = new Label
            {
                Text = "è·³è½‰åº§æ¨™:",
                Location = new Point(170, 10),
                Size = new Size(70, 23),
                TextAlign = ContentAlignment.MiddleLeft
            };

            TextBox txtJumpCoord = new TextBox
            {
                Location = new Point(240, 10),
                Size = new Size(120, 23),
                PlaceholderText = "è¼¸å…¥ X,Y"
            };

            Button btnJump = new Button
            {
                Text = "è·³è½‰",
                Location = new Point(365, 9),
                Size = new Size(50, 25)
            };

            // åº§æ¨™åˆ—è¡¨
            ListView lvLocations = new ListView
            {
                Location = new Point(170, 40),
                Size = new Size(480, 340),
                View = View.Details,
                FullRowSelect = true,
                GridLines = true,
                Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right
            };
            lvLocations.Columns.Add("X", 55);
            lvLocations.Columns.Add("Y", 55);
            lvLocations.Columns.Add("åœ–å±¤", 40);
            lvLocations.Columns.Add("GroupId", 55);
            lvLocations.Columns.Add("L4åº§æ¨™", 70);
            lvLocations.Columns.Add("S32æª”æ¡ˆ", 180);

            // å³éµé¸å–® - è¤‡è£½æ•´è¡Œ
            ContextMenuStrip lvContextMenu = new ContextMenuStrip();
            ToolStripMenuItem copyRowItem = new ToolStripMenuItem("è¤‡è£½æ•´è¡Œ");
            copyRowItem.Click += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count > 0)
                {
                    var item = lvLocations.SelectedItems[0];
                    string rowText = $"{item.SubItems[0].Text},{item.SubItems[1].Text},{item.SubItems[2].Text},{item.SubItems[3].Text},{item.SubItems[4].Text},{item.SubItems[5].Text}";
                    Clipboard.SetText(rowText);
                    this.toolStripStatusLabel1.Text = "å·²è¤‡è£½æ•´è¡Œ";
                }
            };
            lvContextMenu.Items.Add(copyRowItem);
            lvLocations.ContextMenuStrip = lvContextMenu;

            // å¡«å……åˆ—è¡¨
            foreach (var loc in locations.OrderBy(l => l.globalX).ThenBy(l => l.globalY))
            {
                string s32FileName = Path.GetFileName(loc.s32.FilePath);
                var item = new ListViewItem(loc.globalX.ToString());
                item.SubItems.Add(loc.globalY.ToString());
                item.SubItems.Add(loc.layer);
                item.SubItems.Add(loc.groupId > 0 ? loc.groupId.ToString() : "-");
                item.SubItems.Add(loc.l4X >= 0 ? $"({loc.l4X},{loc.l4Y})" : "-");
                item.SubItems.Add(s32FileName);
                item.Tag = loc;
                lvLocations.Items.Add(item);
            }

            // åº•éƒ¨æŒ‰éˆ•
            Button btnCopyAll = new Button
            {
                Text = "è¤‡è£½å…¨éƒ¨åº§æ¨™",
                Location = new Point(170, 390),
                Size = new Size(100, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };

            Button btnCopySelected = new Button
            {
                Text = "è¤‡è£½é¸ä¸­",
                Location = new Point(275, 390),
                Size = new Size(80, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };

            Button btnClose = new Button
            {
                Text = "é—œé–‰",
                Location = new Point(570, 390),
                Size = new Size(80, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right
            };

            // äº‹ä»¶è™•ç†
            btnJump.Click += (s, ev) =>
            {
                string input = txtJumpCoord.Text.Trim();
                if (TryParseCoordinate(input, out int x, out int y))
                {
                    JumpToGameCoordinate(x, y);
                    this.toolStripStatusLabel1.Text = $"å·²è·³è½‰åˆ°åº§æ¨™ ({x}, {y})";
                }
                else
                {
                    MessageBox.Show("è«‹è¼¸å…¥æ­£ç¢ºçš„åº§æ¨™æ ¼å¼ï¼Œä¾‹å¦‚: 32800,32700", "æ ¼å¼éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
            };

            txtJumpCoord.KeyDown += (s, ev) =>
            {
                if (ev.KeyCode == Keys.Enter)
                {
                    btnJump.PerformClick();
                    ev.Handled = true;
                    ev.SuppressKeyPress = true;
                }
            };

            // å–®æ“Šåˆ—è¡¨é …ç›®è·³è½‰ä¸¦é«˜äº®
            lvLocations.SelectedIndexChanged += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count > 0)
                {
                    var loc = ((int globalX, int globalY, string layer, int groupId, S32Data s32, int l4X, int l4Y))lvLocations.SelectedItems[0].Tag;
                    JumpToGameCoordinate(loc.globalX, loc.globalY);
                    string l4Info = loc.l4X >= 0 ? $" L4åº§æ¨™:({loc.l4X},{loc.l4Y})" : "";
                    this.toolStripStatusLabel1.Text = $"å·²è·³è½‰åˆ°åº§æ¨™ ({loc.globalX}, {loc.globalY}) - {loc.layer}" +
                        (loc.groupId > 0 ? $" GroupId:{loc.groupId}" : "") + l4Info;
                }
            };

            btnCopyAll.Click += (s, ev) =>
            {
                var coords = locations.Select(l => $"{l.globalX},{l.globalY}");
                string text = string.Join("\n", coords);
                Clipboard.SetText(text);
                MessageBox.Show($"å·²è¤‡è£½ {locations.Count} å€‹åº§æ¨™åˆ°å‰ªè²¼ç°¿", "è¤‡è£½æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            btnCopySelected.Click += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆé¸å–è¦è¤‡è£½çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                var selectedRows = new List<string>();
                foreach (ListViewItem item in lvLocations.SelectedItems)
                {
                    string rowText = $"{item.SubItems[0].Text},{item.SubItems[1].Text},{item.SubItems[2].Text},{item.SubItems[3].Text},{item.SubItems[4].Text},{item.SubItems[5].Text}";
                    selectedRows.Add(rowText);
                }
                Clipboard.SetText(string.Join("\n", selectedRows));
                MessageBox.Show($"å·²è¤‡è£½ {selectedRows.Count} ç­†è³‡æ–™åˆ°å‰ªè²¼ç°¿", "è¤‡è£½æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            btnClose.Click += (s, ev) => infoForm.Close();

            infoForm.FormClosed += (s, ev) =>
            {
                enlargedTile?.Dispose();
            };

            // åŠ å…¥æ§åˆ¶é …
            infoForm.Controls.Add(previewPanel);
            infoForm.Controls.Add(lblBasicInfo);
            infoForm.Controls.Add(lblJump);
            infoForm.Controls.Add(txtJumpCoord);
            infoForm.Controls.Add(btnJump);
            infoForm.Controls.Add(lvLocations);
            infoForm.Controls.Add(btnCopyAll);
            infoForm.Controls.Add(btnCopySelected);
            infoForm.Controls.Add(btnClose);

            // ä½¿ç”¨ Show è€Œé ShowDialogï¼Œè®“ä¸»è¦–çª—å¯ä»¥å³æ™‚æ›´æ–°
            infoForm.Show(this);
        }

        // Tile å³éµé¸å–®
        private void lvTiles_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            if (lvTiles.SelectedItems.Count == 0)
                return;

            var selectedItem = lvTiles.SelectedItems[0];
            var tileInfo = selectedItem.Tag as TileInfo;
            if (tileInfo == null)
                return;

            // è¨ˆç®—ä½¿ç”¨æ­¤ TileId çš„å„åœ–å±¤æ•¸é‡
            int layer1Count = 0;
            int layer2Count = 0;
            int layer4Count = 0;
            foreach (var s32Data in _document.S32Files.Values)
            {
                // Layer1
                if (s32Data.Layer1 != null)
                {
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId == tileInfo.TileId)
                                layer1Count++;
                        }
                    }
                }
                // Layer2
                layer2Count += s32Data.Layer2.Count(o => o.TileId == tileInfo.TileId);
                // Layer4
                layer4Count += s32Data.Layer4.Count(o => o.TileId == tileInfo.TileId);
            }
            int totalCount = layer1Count + layer2Count + layer4Count;

            // å»ºç«‹å³éµé¸å–®
            ContextMenuStrip menu = new ContextMenuStrip();

            // åˆªé™¤æ‰€æœ‰ä½¿ç”¨æ­¤ TileId çš„ Layer4 ç‰©ä»¶
            ToolStripMenuItem deleteLayer4Item = new ToolStripMenuItem($"åˆªé™¤æ‰€æœ‰ Layer4 ç‰©ä»¶ ({layer4Count} å€‹)");
            deleteLayer4Item.Enabled = layer4Count > 0;
            deleteLayer4Item.Click += (s, ev) =>
            {
                DeleteAllLayer4ByTileId(tileInfo.TileId);
            };

            // åˆªé™¤æ‰€æœ‰ä½¿ç”¨æ­¤ TileId çš„å¼•ç”¨ï¼ˆLayer1 + Layer2 + Layer4ï¼‰
            ToolStripMenuItem deleteAllItem = new ToolStripMenuItem($"åˆªé™¤æ‰€æœ‰å¼•ç”¨ (L1:{layer1Count} L2:{layer2Count} L4:{layer4Count})");
            deleteAllItem.Enabled = totalCount > 0;
            deleteAllItem.Click += (s, ev) =>
            {
                DeleteAllReferencesByTileId(tileInfo.TileId, layer1Count, layer2Count, layer4Count);
            };

            // æŸ¥çœ‹ Tile è©³ç´°è³‡è¨Š
            ToolStripMenuItem infoItem = new ToolStripMenuItem("æŸ¥çœ‹è©³ç´°è³‡è¨Š");
            infoItem.Click += (s, ev) =>
            {
                ShowTileInfoWithPreview(tileInfo);
            };

            // åŒ¯å‡ºé¸ä¸­çš„ Tile
            ToolStripMenuItem exportSelectedItem = new ToolStripMenuItem("åŒ¯å‡ºé¸ä¸­çš„ Tile åœ–ç‰‡");
            exportSelectedItem.Click += (s, ev) =>
            {
                var selectedTiles = new List<TileInfo>();
                foreach (ListViewItem item in lvTiles.SelectedItems)
                {
                    if (item.Tag is TileInfo ti)
                        selectedTiles.Add(ti);
                }
                if (selectedTiles.Count > 0)
                    ExportTilesToZip(selectedTiles);
            };

            // åŒ¯å‡ºå…¨éƒ¨ Tile
            ToolStripMenuItem exportAllItem = new ToolStripMenuItem($"åŒ¯å‡ºå…¨éƒ¨ Tile ({lvTiles.Items.Count} å€‹)");
            exportAllItem.Click += (s, ev) =>
            {
                var allTiles = new List<TileInfo>();
                foreach (ListViewItem item in lvTiles.Items)
                {
                    if (item.Tag is TileInfo ti)
                        allTiles.Add(ti);
                }
                if (allTiles.Count > 0)
                    ExportTilesToZip(allTiles);
            };

            // é‡æ–°ç·¨è™Ÿ TileIdï¼ˆæ”¯æ´å¤šé¸ï¼‰
            int selectedCount = lvTiles.SelectedItems.Count;
            ToolStripMenuItem renumberItem = new ToolStripMenuItem($"é‡æ–°ç·¨è™Ÿ TileId ({selectedCount} å€‹)");
            renumberItem.Enabled = selectedCount > 0;
            renumberItem.Click += (s, ev) =>
            {
                var selectedTiles = new List<TileInfo>();
                foreach (ListViewItem item in lvTiles.SelectedItems)
                {
                    if (item.Tag is TileInfo ti)
                        selectedTiles.Add(ti);
                }
                if (selectedTiles.Count > 0)
                    RenumberTileIds(selectedTiles);
            };

            menu.Items.Add(infoItem);
            menu.Items.Add(new ToolStripSeparator());
            menu.Items.Add(renumberItem);
            menu.Items.Add(deleteLayer4Item);
            menu.Items.Add(deleteAllItem);
            menu.Items.Add(new ToolStripSeparator());
            menu.Items.Add(exportSelectedItem);
            menu.Items.Add(exportAllItem);

            menu.Show(lvTiles, e.Location);
        }

        // åŒ¯å‡º Tile åˆ° ZIP æª”æ¡ˆ
        private void ExportTilesToZip(List<TileInfo> tiles)
        {
            if (tiles.Count == 0)
            {
                MessageBox.Show("æ²’æœ‰è¦åŒ¯å‡ºçš„ Tile", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ R ç‰ˆ Tile
            var distinctTileIds = tiles.Select(t => t.TileId).Distinct().ToList();
            int remasterCount = distinctTileIds.Count(id => _tilRemasterCache.TryGetValue(id, out bool r) && r);
            bool hasRemasterTiles = remasterCount > 0;

            // è©¢å•åŒ¯å‡ºé¸é …
            using (var optionForm = new Form())
            {
                optionForm.Text = "åŒ¯å‡ºé¸é …";
                optionForm.ClientSize = new Size(300, hasRemasterTiles ? 180 : 150);
                optionForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                optionForm.StartPosition = FormStartPosition.CenterParent;
                optionForm.MaximizeBox = false;
                optionForm.MinimizeBox = false;

                var chkExportTil = new CheckBox { Text = "åŒ¯å‡º .til åŸå§‹æª”æ¡ˆ", Location = new Point(20, 15), Size = new Size(260, 24), Checked = true };
                var chkExportPng = new CheckBox { Text = "åŒ¯å‡º .png é è¦½åœ–ç‰‡", Location = new Point(20, 45), Size = new Size(260, 24), Checked = false };
                var chkDownscale = new CheckBox { Text = $"Rç‰ˆç¸®å°è‡³ 24x24 ({remasterCount} å€‹)", Location = new Point(20, 75), Size = new Size(260, 24), Checked = false, Enabled = hasRemasterTiles };

                int infoY = hasRemasterTiles ? 105 : 75;
                int btnY = hasRemasterTiles ? 140 : 110;
                var lblInfo = new Label { Text = $"å…± {distinctTileIds.Count} å€‹ til æª”æ¡ˆ", Location = new Point(20, infoY), Size = new Size(260, 20), ForeColor = Color.Gray };

                var btnOK = new Button { Text = "åŒ¯å‡º", Location = new Point(100, btnY), Size = new Size(80, 28), DialogResult = DialogResult.OK };
                var btnCancel = new Button { Text = "å–æ¶ˆ", Location = new Point(190, btnY), Size = new Size(80, 28), DialogResult = DialogResult.Cancel };

                optionForm.Controls.AddRange(new Control[] { chkExportTil, chkExportPng, chkDownscale, lblInfo, btnOK, btnCancel });
                optionForm.AcceptButton = btnOK;
                optionForm.CancelButton = btnCancel;

                if (optionForm.ShowDialog() != DialogResult.OK)
                    return;

                if (!chkExportTil.Checked && !chkExportPng.Checked)
                {
                    MessageBox.Show("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®åŒ¯å‡ºæ ¼å¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                bool exportTil = chkExportTil.Checked;
                bool exportPng = chkExportPng.Checked;
                bool downscale = chkDownscale.Checked;

                using (var saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "ZIP æª”æ¡ˆ|*.zip";
                    saveDialog.FileName = $"Tiles_Export_{DateTime.Now:yyyyMMdd_HHmmss}.zip";
                    saveDialog.Title = "åŒ¯å‡º Tile";

                    if (saveDialog.ShowDialog() != DialogResult.OK)
                        return;

                    try
                    {
                        // æŒ‰ TileId åˆ†çµ„
                        var tilesByNumber = tiles.GroupBy(t => t.TileId).OrderBy(g => g.Key).ToList();

                        using (var zipStream = new FileStream(saveDialog.FileName, FileMode.Create))
                        using (var archive = new System.IO.Compression.ZipArchive(zipStream, System.IO.Compression.ZipArchiveMode.Create))
                        {
                            int tilExportedCount = 0;
                            int pngExportedCount = 0;
                            int errorCount = 0;

                            foreach (var group in tilesByNumber)
                            {
                                int tileId = group.Key;

                                try
                                {
                                    // è¼‰å…¥ til æª”æ¡ˆ
                                    string key = $"{tileId}.til";
                                    byte[] data = L1PakReader.UnPack("Tile", key);
                                    if (data == null)
                                    {
                                        errorCount++;
                                        continue;
                                    }

                                    // å¦‚æœéœ€è¦ç¸®å°ä¸”æ˜¯ R ç‰ˆ
                                    byte[] exportData = data;
                                    if (downscale && L1Til.IsRemaster(data))
                                    {
                                        exportData = L1Til.DownscaleTil(data);
                                    }

                                    // åŒ¯å‡º .til åŸå§‹æª”æ¡ˆ
                                    if (exportTil)
                                    {
                                        string tilEntryName = $"{tileId}.til";
                                        var tilEntry = archive.CreateEntry(tilEntryName, System.IO.Compression.CompressionLevel.Optimal);
                                        using (var entryStream = tilEntry.Open())
                                        {
                                            entryStream.Write(exportData, 0, exportData.Length);
                                        }
                                        tilExportedCount++;
                                    }

                                    // åŒ¯å‡º .png é è¦½åœ–ç‰‡
                                    if (exportPng)
                                    {
                                        var tilArray = L1Til.Parse(exportData);
                                        string folderName = $"preview/til_{tileId:D6}";

                                        foreach (var tile in group)
                                        {
                                            if (tile.IndexId >= tilArray.Count)
                                            {
                                                errorCount++;
                                                continue;
                                            }

                                            byte[] tilData = tilArray[tile.IndexId];
                                            // ä½¿ç”¨æ—¢æœ‰çš„ RenderTileEnlarged æ–¹æ³•ä¾†æ­£ç¢ºæ¸²æŸ“ 2.5D æ ¼å¼
                                            using (var bitmap = RenderTileEnlarged(tilData, tileId, 48))
                                            {
                                                if (bitmap != null)
                                                {
                                                    string entryName = $"{folderName}/index_{tile.IndexId:D3}.png";
                                                    var entry = archive.CreateEntry(entryName, System.IO.Compression.CompressionLevel.Optimal);

                                                    using (var entryStream = entry.Open())
                                                    {
                                                        bitmap.Save(entryStream, System.Drawing.Imaging.ImageFormat.Png);
                                                    }
                                                    pngExportedCount++;
                                                }
                                                else
                                                {
                                                    errorCount++;
                                                }
                                            }
                                        }
                                    }
                                }
                                catch
                                {
                                    errorCount++;
                                }
                            }

                            var resultParts = new List<string>();
                            if (exportTil) resultParts.Add($".til æª”æ¡ˆ: {tilExportedCount} å€‹");
                            if (exportPng) resultParts.Add($".png åœ–ç‰‡: {pngExportedCount} å€‹");
                            if (errorCount > 0) resultParts.Add($"å¤±æ•—: {errorCount} å€‹");

                            // å„²å­˜çµæœè³‡è¨Šï¼Œç­‰é—œé–‰æª”æ¡ˆå¾Œå†é¡¯ç¤º
                            string resultMessage = $"åŒ¯å‡ºå®Œæˆï¼\n\n{string.Join("\n", resultParts)}\n\nå„²å­˜è‡³: {saveDialog.FileName}";
                            string savedFileName = System.IO.Path.GetFileName(saveDialog.FileName);

                            // å…ˆé—œé–‰ ZIP æª”æ¡ˆ
                            archive.Dispose();
                            zipStream.Close();

                            // å†é¡¯ç¤ºè¨Šæ¯
                            MessageBox.Show(resultMessage, "åŒ¯å‡ºçµæœ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            this.toolStripStatusLabel1.Text = $"å·²åŒ¯å‡º Tile åˆ° {savedFileName}";
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[Export] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        // é‡æ–°ç·¨è™Ÿ TileId
        private void RenumberTileIds(List<TileInfo> tiles)
        {
            if (tiles.Count == 0) return;

            // æŒ‰åŸå§‹ TileId æ’åº
            var sortedTiles = tiles.OrderBy(t => t.TileId).ToList();
            var oldTileIds = sortedTiles.Select(t => t.TileId).Distinct().ToList();

            // é¡¯ç¤ºè¼¸å…¥å°è©±æ¡†
            using (var inputForm = new Form())
            {
                inputForm.Text = "é‡æ–°ç·¨è™Ÿ TileId";
                inputForm.ClientSize = new Size(350, 180);
                inputForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                inputForm.StartPosition = FormStartPosition.CenterParent;
                inputForm.MaximizeBox = false;
                inputForm.MinimizeBox = false;

                var lblInfo = new Label
                {
                    Text = $"é¸ä¸­ {oldTileIds.Count} å€‹ TileId:\n{string.Join(", ", oldTileIds.Take(10))}{(oldTileIds.Count > 10 ? " ..." : "")}",
                    Location = new Point(15, 15),
                    Size = new Size(320, 40)
                };

                var lblStart = new Label { Text = "èµ·å§‹ç·¨è™Ÿ:", Location = new Point(15, 65), Size = new Size(80, 20) };
                var txtStart = new TextBox { Text = oldTileIds.Min().ToString(), Location = new Point(100, 62), Size = new Size(100, 24) };

                var lblPreview = new Label
                {
                    Text = "",
                    Location = new Point(15, 95),
                    Size = new Size(320, 40),
                    ForeColor = Color.Gray
                };

                // é è¦½é‡ç·¨çµæœ
                Action updatePreview = () =>
                {
                    if (int.TryParse(txtStart.Text, out int startId) && startId > 0)
                    {
                        var preview = new List<string>();
                        for (int i = 0; i < Math.Min(oldTileIds.Count, 5); i++)
                        {
                            preview.Add($"{oldTileIds[i]} â†’ {startId + i}");
                        }
                        if (oldTileIds.Count > 5)
                            preview.Add("...");
                        lblPreview.Text = "é è¦½: " + string.Join(", ", preview);
                    }
                    else
                    {
                        lblPreview.Text = "è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹ç·¨è™Ÿ (> 0)";
                    }
                };

                txtStart.TextChanged += (s, ev) => updatePreview();
                updatePreview();

                var btnOK = new Button { Text = "ç¢ºå®š", Location = new Point(160, 140), Size = new Size(80, 28), DialogResult = DialogResult.OK };
                var btnCancel = new Button { Text = "å–æ¶ˆ", Location = new Point(250, 140), Size = new Size(80, 28), DialogResult = DialogResult.Cancel };

                inputForm.Controls.AddRange(new Control[] { lblInfo, lblStart, txtStart, lblPreview, btnOK, btnCancel });
                inputForm.AcceptButton = btnOK;
                inputForm.CancelButton = btnCancel;

                if (inputForm.ShowDialog() != DialogResult.OK)
                    return;

                if (!int.TryParse(txtStart.Text, out int startTileId) || startTileId <= 0)
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹ç·¨è™Ÿ (> 0)", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // å»ºç«‹ oldTileId -> newTileId çš„å°æ‡‰è¡¨
                var tileIdMapping = new Dictionary<int, int>();
                for (int i = 0; i < oldTileIds.Count; i++)
                {
                    tileIdMapping[oldTileIds[i]] = startTileId + i;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰è¡çªï¼ˆæ–°ç·¨è™Ÿèˆ‡ç¾æœ‰æœªé¸ä¸­çš„ TileId é‡è¤‡ï¼‰
                var allCurrentTileIds = new HashSet<int>();
                foreach (var s32Data in _document.S32Files.Values)
                {
                    foreach (var cell in s32Data.Layer1)
                    {
                        if (cell != null && cell.TileId > 0)
                            allCurrentTileIds.Add(cell.TileId);
                    }
                    foreach (var obj in s32Data.Layer4)
                    {
                        if (obj.TileId > 0)
                            allCurrentTileIds.Add(obj.TileId);
                    }
                }

                // ç§»é™¤è¦é‡ç·¨çš„ TileId
                foreach (var oldId in oldTileIds)
                {
                    allCurrentTileIds.Remove(oldId);
                }

                // æª¢æŸ¥æ–°ç·¨è™Ÿæ˜¯å¦èˆ‡ç¾æœ‰ç·¨è™Ÿè¡çª
                var conflicts = new List<int>();
                foreach (var newId in tileIdMapping.Values)
                {
                    if (allCurrentTileIds.Contains(newId))
                        conflicts.Add(newId);
                }

                if (conflicts.Count > 0)
                {
                    var result = MessageBox.Show(
                        $"æ–°çš„ TileId èˆ‡ç¾æœ‰ TileId æœ‰è¡çª:\n{string.Join(", ", conflicts.Take(10))}{(conflicts.Count > 10 ? " ..." : "")}\n\næ˜¯å¦ç¹¼çºŒï¼Ÿï¼ˆæœƒåˆä½µé€™äº› TileIdï¼‰",
                        "è­¦å‘Š",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning);
                    if (result != DialogResult.Yes)
                        return;
                }

                // æª¢æŸ¥æ˜¯å¦è¦åŒæ™‚æ›´æ–° Tile.idx/Tile.pak
                bool updateTilePak = false;
                if (!string.IsNullOrEmpty(Share.LineagePath))
                {
                    var pakResult = MessageBox.Show(
                        $"æ˜¯å¦è¦åŒæ™‚å°‡ til æª”æ¡ˆä»¥æ–°ç·¨è™Ÿå¯«å…¥ Tile.idx/Tile.pakï¼Ÿ\n\n" +
                        $"é¸æ“‡ã€Œæ˜¯ã€ï¼šè®€å–åŸå§‹ til ä¸¦ä»¥æ–°ç·¨è™Ÿé™„åŠ åˆ° pak\n" +
                        $"é¸æ“‡ã€Œå¦ã€ï¼šåƒ…æ›´æ–° S32 ä¸­çš„å¼•ç”¨ï¼ˆéœ€æ‰‹å‹•è™•ç† til æª”æ¡ˆï¼‰",
                        "æ›´æ–° Tile.pak",
                        MessageBoxButtons.YesNoCancel,
                        MessageBoxIcon.Question);
                    if (pakResult == DialogResult.Cancel)
                        return;
                    updateTilePak = (pakResult == DialogResult.Yes);
                }

                // ç¢ºèªåŸ·è¡Œ
                string confirmMsg = $"ç¢ºå®šè¦é‡æ–°ç·¨è™Ÿå—ï¼Ÿ\n\n" +
                    $"é€™å°‡æ›´æ–°æ‰€æœ‰ S32 æª”æ¡ˆä¸­çš„ Layer1ã€Layer2 å’Œ Layer4 å¼•ç”¨ã€‚\n" +
                    $"å…± {oldTileIds.Count} å€‹ TileId å°‡è¢«é‡æ–°ç·¨è™Ÿã€‚";
                if (updateTilePak)
                    confirmMsg += "\n\nåŒæ™‚æœƒå°‡ til æª”æ¡ˆä»¥æ–°ç·¨è™Ÿå¯«å…¥ Tile.pakã€‚";

                var confirmResult = MessageBox.Show(confirmMsg, "ç¢ºèª", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (confirmResult != DialogResult.Yes)
                    return;

                // å¦‚æœè¦æ›´æ–° pakï¼Œå…ˆè®€å–æ‰€æœ‰åŸå§‹ til è³‡æ–™
                Dictionary<int, byte[]> tilDataCache = new Dictionary<int, byte[]>();
                if (updateTilePak)
                {
                    foreach (var oldTileId in oldTileIds)
                    {
                        string key = $"{oldTileId}.til";
                        byte[] data = L1PakReader.UnPack("Tile", key);
                        if (data != null)
                        {
                            tilDataCache[oldTileId] = data;
                        }
                    }
                }

                // åŸ·è¡Œé‡ç·¨
                int layer1Updated = 0;
                int layer2Updated = 0;
                int layer4Updated = 0;

                foreach (var s32Data in _document.S32Files.Values)
                {
                    // æ›´æ–° Layer1
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && tileIdMapping.TryGetValue(cell.TileId, out int newTileId))
                            {
                                cell.TileId = newTileId;
                                layer1Updated++;
                            }
                        }
                    }

                    // æ›´æ–° Layer2
                    foreach (var item in s32Data.Layer2)
                    {
                        if (tileIdMapping.TryGetValue(item.TileId, out int newTileId))
                        {
                            item.TileId = (ushort)newTileId;
                            layer2Updated++;
                        }
                    }

                    // æ›´æ–° Layer4
                    foreach (var obj in s32Data.Layer4)
                    {
                        if (tileIdMapping.TryGetValue(obj.TileId, out int newTileId))
                        {
                            obj.TileId = newTileId;
                            layer4Updated++;
                        }
                    }
                }

                // å¯«å…¥ Tile.pak
                int tilWrittenCount = 0;
                int tilSkippedCount = 0;
                if (updateTilePak && tilDataCache.Count > 0)
                {
                    var filesToWrite = new Dictionary<string, byte[]>();
                    foreach (var kvp in tileIdMapping)
                    {
                        int oldId = kvp.Key;
                        int newId = kvp.Value;
                        if (tilDataCache.TryGetValue(oldId, out byte[] data))
                        {
                            string newFileName = $"{newId}.til";
                            // æª¢æŸ¥æ–°ç·¨è™Ÿæ˜¯å¦å·²å­˜åœ¨
                            if (!L1PakWriter.FileExists("Tile", newFileName))
                            {
                                filesToWrite[newFileName] = data;
                            }
                            else
                            {
                                tilSkippedCount++;
                            }
                        }
                    }
                    tilWrittenCount = L1PakWriter.AppendFiles("Tile", filesToWrite);
                }

                // æ¨™è¨˜ç‚ºå·²ä¿®æ”¹
                foreach (var s32Data in _document.S32Files.Values)
                {
                    s32Data.IsModified = true;
                }

                // æ¸…é™¤å¿«å–
                cachedAggregatedTiles.Clear();
                _tilFileCache.Clear();
                _tilRemasterCache.Clear();

                // é‡æ–°æ•´ç† Tile åˆ—è¡¨ï¼ˆå…©è€…ä¸¦è¡ŒåŸ·è¡Œï¼‰
                UpdateGroupThumbnailsList();  // ç•°æ­¥ï¼Œç«‹å³è¿”å›
                UpdateTileList(txtTileSearch.Text);  // åŒæ­¥åŸ·è¡Œï¼Œä½†ç¾¤çµ„ç¸®åœ–å·²åœ¨èƒŒæ™¯è™•ç†

                // å¼·åˆ¶é‡æ–°æ¸²æŸ“åœ°åœ–
                _viewState.SetRenderResult(0, 0, 0, 0, 0);
                _mapViewerControl.Refresh();

                // å»ºæ§‹çµæœè¨Šæ¯
                var resultMsg = $"TileId é‡æ–°ç·¨è™Ÿå®Œæˆï¼\n\n" +
                    $"æ›´æ–° Layer1: {layer1Updated} æ ¼\n" +
                    $"æ›´æ–° Layer2: {layer2Updated} é …\n" +
                    $"æ›´æ–° Layer4: {layer4Updated} å€‹ç‰©ä»¶\n";

                if (updateTilePak)
                {
                    resultMsg += $"\nå¯«å…¥ Tile.pak: {tilWrittenCount} å€‹ til æª”æ¡ˆ";
                    if (tilSkippedCount > 0)
                        resultMsg += $"\nè·³éï¼ˆå·²å­˜åœ¨ï¼‰: {tilSkippedCount} å€‹";
                }

                resultMsg += $"\n\nå°æ‡‰è¡¨:\n{string.Join("\n", tileIdMapping.Select(kv => $"  {kv.Key} â†’ {kv.Value}"))}";

                MessageBox.Show(resultMsg, "å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);

                toolStripStatusLabel1.Text = $"å·²é‡æ–°ç·¨è™Ÿ {oldTileIds.Count} å€‹ TileId";
            }
        }

        // åˆªé™¤æ‰€æœ‰ä½¿ç”¨æŒ‡å®š TileId çš„ Layer4 ç‰©ä»¶
        private void DeleteAllLayer4ByTileId(int tileId)
        {
            // è¨ˆç®—è¦åˆªé™¤çš„æ•¸é‡
            int totalCount = 0;
            foreach (var s32Data in _document.S32Files.Values)
            {
                totalCount += s32Data.Layer4.Count(o => o.TileId == tileId);
            }

            if (totalCount == 0)
            {
                MessageBox.Show($"æ²’æœ‰æ‰¾åˆ°ä½¿ç”¨ TileId {tileId} çš„ Layer4 ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // ç¢ºèªåˆªé™¤
            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨ TileId {tileId} çš„ Layer4 ç‰©ä»¶å—ï¼Ÿ\n" +
                $"é€™å°‡ç§»é™¤ {totalCount} å€‹ç‰©ä»¶ã€‚",
                "ç¢ºèªåˆªé™¤",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result != DialogResult.Yes)
                return;

            // åŸ·è¡Œåˆªé™¤
            int deletedCount = 0;
            foreach (var s32Data in _document.S32Files.Values)
            {
                // å…ˆæ”¶é›†è¦åˆªé™¤çš„ç‰©ä»¶ä»¥æ›´æ–°ç©ºé–“ç´¢å¼•
                var toRemove = s32Data.Layer4.Where(o => o.TileId == tileId).ToList();
                if (toRemove.Count > 0)
                {
                    s32Data.Layer4.RemoveAll(o => o.TileId == tileId);
                    Layer4Index_RemoveRange(s32Data, toRemove);
                    deletedCount += toRemove.Count;
                    s32Data.IsModified = true;
                }
            }

            // é‡æ–°æ¸²æŸ“
            RenderS32Map();

            // æ›´æ–° Tile æ¸…å–®å’Œç¾¤çµ„ç¸®åœ–ï¼ˆä¸¦è¡ŒåŸ·è¡Œï¼‰
            cachedAggregatedTiles.Clear();
            UpdateGroupThumbnailsList();  // ç•°æ­¥ï¼Œç«‹å³è¿”å›
            UpdateTileList(txtTileSearch.Text);  // åŒæ­¥åŸ·è¡Œï¼Œä½†ç¾¤çµ„ç¸®åœ–å·²åœ¨èƒŒæ™¯è™•ç†

            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ TileId {tileId} çš„æ‰€æœ‰ Layer4 ç‰©ä»¶ï¼Œå…± {deletedCount} å€‹";
        }

        // åˆªé™¤æ‰€æœ‰ä½¿ç”¨æŒ‡å®š TileId çš„å¼•ç”¨ï¼ˆLayer1 + Layer2 + Layer4ï¼‰
        private void DeleteAllReferencesByTileId(int tileId, int layer1Count, int layer2Count, int layer4Count)
        {
            int totalCount = layer1Count + layer2Count + layer4Count;
            if (totalCount == 0)
            {
                MessageBox.Show($"æ²’æœ‰æ‰¾åˆ°ä½¿ç”¨ TileId {tileId} çš„å¼•ç”¨ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // ç¢ºèªåˆªé™¤
            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨ TileId {tileId} çš„å¼•ç”¨å—ï¼Ÿ\n\n" +
                $"Layer1 åœ°æ¿: {layer1Count} å€‹\n" +
                $"Layer2 è£é£¾: {layer2Count} å€‹\n" +
                $"Layer4 ç‰©ä»¶: {layer4Count} å€‹\n\n" +
                $"ç¸½è¨ˆ: {totalCount} å€‹",
                "ç¢ºèªåˆªé™¤",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result != DialogResult.Yes)
                return;

            // åŸ·è¡Œåˆªé™¤
            int deletedL1 = 0;
            int deletedL2 = 0;
            int deletedL4 = 0;

            foreach (var s32Data in _document.S32Files.Values)
            {
                bool modified = false;

                // Layer1 - å°‡ TileId è¨­ç‚º 0
                if (s32Data.Layer1 != null)
                {
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId == tileId)
                            {
                                cell.TileId = 0;
                                cell.IndexId = 0;
                                deletedL1++;
                                modified = true;
                            }
                        }
                    }
                }

                // Layer2 - ç§»é™¤ç‰©ä»¶
                int l2Removed = s32Data.Layer2.RemoveAll(o => o.TileId == tileId);
                if (l2Removed > 0)
                {
                    deletedL2 += l2Removed;
                    modified = true;
                }

                // Layer4 - ç§»é™¤ç‰©ä»¶ä¸¦æ›´æ–°ç©ºé–“ç´¢å¼•
                var toRemove = s32Data.Layer4.Where(o => o.TileId == tileId).ToList();
                if (toRemove.Count > 0)
                {
                    s32Data.Layer4.RemoveAll(o => o.TileId == tileId);
                    Layer4Index_RemoveRange(s32Data, toRemove);
                    deletedL4 += toRemove.Count;
                    modified = true;
                }

                if (modified)
                {
                    s32Data.IsModified = true;
                }
            }

            // é‡æ–°æ¸²æŸ“
            RenderS32Map();

            // æ›´æ–° Tile æ¸…å–®å’Œç¾¤çµ„ç¸®åœ–
            cachedAggregatedTiles.Clear();
            UpdateGroupThumbnailsList();
            UpdateTileList(txtTileSearch.Text);

            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ TileId {tileId} çš„æ‰€æœ‰å¼•ç”¨ (L1:{deletedL1} L2:{deletedL2} L4:{deletedL4})";
        }

        // åœ¨åœ°åœ–ä¸Šé«˜äº®é¡¯ç¤ºä½¿ç”¨æŒ‡å®š TileId çš„ç‰©ä»¶
        private void HighlightTileOnMap(int tileId)
        {
            // æ‰¾åˆ°ç¬¬ä¸€å€‹ä½¿ç”¨æ­¤ TileId çš„ç‰©ä»¶ä¸¦è·³è½‰
            foreach (var s32Data in _document.S32Files.Values)
            {
                var obj = s32Data.Layer4.FirstOrDefault(o => o.TileId == tileId);
                if (obj != null)
                {
                    // è¨ˆç®—å…¨åŸŸåº§æ¨™ä¸¦è·³è½‰
                    int globalX = s32Data.SegInfo.nLinBeginX * 2 + obj.X;
                    int globalY = s32Data.SegInfo.nLinBeginY + obj.Y;

                    // è·³è½‰åˆ°è©²ä½ç½®
                    JumpToGameCoordinate(globalX, globalY);

                    this.toolStripStatusLabel1.Text = $"è·³è½‰åˆ° TileId {tileId} çš„ç‰©ä»¶ä½ç½® ({globalX}, {globalY})";
                    return;
                }
            }

            MessageBox.Show($"æ²’æœ‰æ‰¾åˆ°ä½¿ç”¨ TileId {tileId} çš„ Layer4 ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // é¡¯ç¤º Tile è©³ç´°è³‡è¨Šï¼ˆå«åº§æ¨™åˆ—è¡¨å’Œè·³è½‰åŠŸèƒ½ï¼‰
        private void ShowTileInfo(TileInfo tileInfo)
        {
            // æ”¶é›†æ‰€æœ‰ä½¿ç”¨æ­¤ TileId çš„ä½ç½® (å¢åŠ  l4X, l4Y å„²å­˜ Layer4 åŸå§‹åº§æ¨™)
            List<(int globalX, int globalY, string layer, int groupId, S32Data s32, int l4X, int l4Y)> locations =
                new List<(int, int, string, int, S32Data, int, int)>();

            foreach (var s32Data in _document.S32Files.Values)
            {
                int segStartX = s32Data.SegInfo.nLinBeginX;
                int segStartY = s32Data.SegInfo.nLinBeginY;

                // Layer1 (64x128ï¼Œä½†éŠæˆ²åº§æ¨™ç”¨ Layer3 çš„ 64x64)
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId == tileInfo.TileId)
                        {
                            // Layer1 çš„ x è¦é™¤ä»¥ 2 ä¾†å°æ‡‰ Layer3 åº§æ¨™
                            int layer3X = x / 2;
                            int globalX = segStartX + layer3X;
                            int globalY = segStartY + y;
                            locations.Add((globalX, globalY, "L1", 0, s32Data, -1, -1));
                        }
                    }
                }

                // Layer4 (obj.X æ˜¯ Layer1 åº§æ¨™ 0-127ï¼Œobj.Y æ˜¯ Layer3 åº§æ¨™ 0-63)
                foreach (var obj in s32Data.Layer4)
                {
                    if (obj.TileId == tileInfo.TileId)
                    {
                        // Layer4 çš„ X ä¹Ÿè¦é™¤ä»¥ 2 ä¾†å°æ‡‰ Layer3 åº§æ¨™
                        int layer3X = obj.X / 2;
                        int globalX = segStartX + layer3X;
                        int globalY = segStartY + obj.Y;
                        locations.Add((globalX, globalY, "L4", obj.GroupId, s32Data, obj.X, obj.Y));
                    }
                }
            }

            // å»ºç«‹è©³ç´°è³‡è¨Šè¦–çª—
            Form infoForm = new Form
            {
                Text = $"Tile {tileInfo.TileId} è©³ç´°è³‡è¨Š",
                Size = new Size(500, 450),
                StartPosition = FormStartPosition.CenterParent,
                FormBorderStyle = FormBorderStyle.Sizable,
                MinimizeBox = false
            };

            // åŸºæœ¬è³‡è¨Šæ¨™ç±¤
            Label lblBasicInfo = new Label
            {
                Text = $"TileId: {tileInfo.TileId}  |  IndexId: {tileInfo.IndexId}  |  ç¸½å…± {locations.Count} å€‹ä½ç½®",
                Location = new Point(10, 10),
                Size = new Size(460, 20),
                Font = new Font(Font.FontFamily, 9, FontStyle.Bold)
            };

            // åº§æ¨™è·³è½‰è¼¸å…¥æ¡†
            Label lblJump = new Label
            {
                Text = "è·³è½‰åº§æ¨™:",
                Location = new Point(10, 38),
                Size = new Size(70, 23),
                TextAlign = ContentAlignment.MiddleLeft
            };

            TextBox txtJumpCoord = new TextBox
            {
                Location = new Point(80, 38),
                Size = new Size(150, 23),
                PlaceholderText = "è¼¸å…¥ X,Y åº§æ¨™"
            };

            Button btnJump = new Button
            {
                Text = "è·³è½‰",
                Location = new Point(235, 37),
                Size = new Size(60, 25)
            };

            // åº§æ¨™åˆ—è¡¨
            ListView lvLocations = new ListView
            {
                Location = new Point(10, 70),
                Size = new Size(460, 280),
                View = View.Details,
                FullRowSelect = true,
                GridLines = true,
                Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right
            };
            lvLocations.Columns.Add("X", 55);
            lvLocations.Columns.Add("Y", 55);
            lvLocations.Columns.Add("åœ–å±¤", 40);
            lvLocations.Columns.Add("GroupId", 55);
            lvLocations.Columns.Add("L4åº§æ¨™", 70);
            lvLocations.Columns.Add("S32æª”æ¡ˆ", 130);

            // å³éµé¸å–® - è¤‡è£½æ•´è¡Œ
            ContextMenuStrip lvContextMenu = new ContextMenuStrip();
            ToolStripMenuItem copyRowItem = new ToolStripMenuItem("è¤‡è£½æ•´è¡Œ");
            copyRowItem.Click += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count > 0)
                {
                    var item = lvLocations.SelectedItems[0];
                    string rowText = $"{item.SubItems[0].Text},{item.SubItems[1].Text},{item.SubItems[2].Text},{item.SubItems[3].Text},{item.SubItems[4].Text},{item.SubItems[5].Text}";
                    Clipboard.SetText(rowText);
                    this.toolStripStatusLabel1.Text = "å·²è¤‡è£½æ•´è¡Œ";
                }
            };
            lvContextMenu.Items.Add(copyRowItem);
            lvLocations.ContextMenuStrip = lvContextMenu;

            // å¡«å……åº§æ¨™åˆ—è¡¨
            foreach (var loc in locations.OrderBy(l => l.globalX).ThenBy(l => l.globalY))
            {
                string s32FileName = Path.GetFileName(loc.s32.FilePath);
                var item = new ListViewItem(loc.globalX.ToString());
                item.SubItems.Add(loc.globalY.ToString());
                item.SubItems.Add(loc.layer);
                item.SubItems.Add(loc.groupId > 0 ? loc.groupId.ToString() : "-");
                item.SubItems.Add(loc.l4X >= 0 ? $"({loc.l4X},{loc.l4Y})" : "-");
                item.SubItems.Add(s32FileName);
                item.Tag = loc;
                lvLocations.Items.Add(item);
            }

            // è¤‡è£½æŒ‰éˆ•
            Button btnCopyAll = new Button
            {
                Text = "è¤‡è£½å…¨éƒ¨åº§æ¨™",
                Location = new Point(10, 360),
                Size = new Size(100, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };

            Button btnCopySelected = new Button
            {
                Text = "è¤‡è£½é¸ä¸­",
                Location = new Point(115, 360),
                Size = new Size(80, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };

            Button btnClose = new Button
            {
                Text = "é—œé–‰",
                Location = new Point(390, 360),
                Size = new Size(80, 28),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right
            };

            // äº‹ä»¶è™•ç†
            btnJump.Click += (s, ev) =>
            {
                string input = txtJumpCoord.Text.Trim();
                if (TryParseCoordinate(input, out int x, out int y))
                {
                    JumpToGameCoordinate(x, y);
                    this.toolStripStatusLabel1.Text = $"å·²è·³è½‰åˆ°åº§æ¨™ ({x}, {y})";
                }
                else
                {
                    MessageBox.Show("è«‹è¼¸å…¥æ­£ç¢ºçš„åº§æ¨™æ ¼å¼ï¼Œä¾‹å¦‚: 32800,32700", "æ ¼å¼éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
            };

            txtJumpCoord.KeyDown += (s, ev) =>
            {
                if (ev.KeyCode == Keys.Enter)
                {
                    btnJump.PerformClick();
                    ev.Handled = true;
                    ev.SuppressKeyPress = true;
                }
            };

            // å–®æ“Šåˆ—è¡¨é …ç›®è·³è½‰ä¸¦é«˜äº®
            lvLocations.SelectedIndexChanged += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count > 0)
                {
                    var loc = ((int globalX, int globalY, string layer, int groupId, S32Data s32, int l4X, int l4Y))lvLocations.SelectedItems[0].Tag;
                    JumpToGameCoordinate(loc.globalX, loc.globalY);
                    string l4Info = loc.l4X >= 0 ? $" L4åº§æ¨™:({loc.l4X},{loc.l4Y})" : "";
                    this.toolStripStatusLabel1.Text = $"å·²è·³è½‰åˆ°åº§æ¨™ ({loc.globalX}, {loc.globalY}) - {loc.layer}" +
                        (loc.groupId > 0 ? $" GroupId:{loc.groupId}" : "") + l4Info;
                }
            };

            btnCopyAll.Click += (s, ev) =>
            {
                var coords = locations.Select(l => $"{l.globalX},{l.globalY}");
                string text = string.Join("\n", coords);
                Clipboard.SetText(text);
                MessageBox.Show($"å·²è¤‡è£½ {locations.Count} å€‹åº§æ¨™åˆ°å‰ªè²¼ç°¿", "è¤‡è£½æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            btnCopySelected.Click += (s, ev) =>
            {
                if (lvLocations.SelectedItems.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆé¸å–è¦è¤‡è£½çš„åº§æ¨™", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                var selectedCoords = new List<string>();
                foreach (ListViewItem item in lvLocations.SelectedItems)
                {
                    selectedCoords.Add(item.SubItems[4].Text);
                }
                Clipboard.SetText(string.Join("\n", selectedCoords));
                MessageBox.Show($"å·²è¤‡è£½ {selectedCoords.Count} å€‹åº§æ¨™åˆ°å‰ªè²¼ç°¿", "è¤‡è£½æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            btnClose.Click += (s, ev) => infoForm.Close();

            // åŠ å…¥æ§åˆ¶é …
            infoForm.Controls.Add(lblBasicInfo);
            infoForm.Controls.Add(lblJump);
            infoForm.Controls.Add(txtJumpCoord);
            infoForm.Controls.Add(btnJump);
            infoForm.Controls.Add(lvLocations);
            infoForm.Controls.Add(btnCopyAll);
            infoForm.Controls.Add(btnCopySelected);
            infoForm.Controls.Add(btnClose);

            infoForm.ShowDialog(this);
        }

        // è§£æåº§æ¨™å­—ä¸² (æ”¯æ´ "X,Y" æˆ– "X Y" æ ¼å¼)
        private bool TryParseCoordinate(string input, out int x, out int y)
        {
            x = 0;
            y = 0;
            if (string.IsNullOrWhiteSpace(input))
                return false;

            // æ”¯æ´é€—è™Ÿæˆ–ç©ºæ ¼åˆ†éš”
            string[] parts = input.Split(new char[] { ',', ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2 &&
                int.TryParse(parts[0].Trim(), out x) &&
                int.TryParse(parts[1].Trim(), out y))
            {
                return true;
            }
            return false;
        }

        // ç‹€æ…‹åˆ—åº§æ¨™è·³è½‰æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void toolStripJumpButton_Click(object sender, EventArgs e)
        {
            PerformCoordinateJump();
        }

        // ç‹€æ…‹åˆ—åº§æ¨™è¼¸å…¥æ¡†æŒ‰éµäº‹ä»¶
        private void toolStripJumpTextBox_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                PerformCoordinateJump();
                e.Handled = true;
                e.SuppressKeyPress = true;
            }
        }

        // è¤‡è£½ç§»å‹•æŒ‡ä»¤æŒ‰éˆ•é»æ“Šäº‹ä»¶
        private void toolStripCopyMoveCmd_Click(object sender, EventArgs e)
        {
            if (_editState.SelectedGameX >= 0 && _editState.SelectedGameY >= 0 && !string.IsNullOrEmpty(_document.MapId))
            {
                string moveCmd = $"ç§»å‹• {_editState.SelectedGameX} {_editState.SelectedGameY} {_document.MapId}";
                Clipboard.SetText(moveCmd);
                this.toolStripStatusLabel1.Text = $"å·²è¤‡è£½: {moveCmd}";
            }
        }

        // é¡¯ç¤ºå…¨éƒ¨ L8 æŒ‰éˆ•é»æ“Šäº‹ä»¶ - é¡¯ç¤ºåœ°åœ–ä¸­æ‰€æœ‰ Layer8 SPR
        private void toolStripShowAllL8_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                this.toolStripStatusLabel1.Text = LocalizationManager.L("Message_PleaseLoadMap");
                return;
            }

            int addedCount = 0;

            // é¡¯ç¤ºå…¨éƒ¨åœ°åœ–çš„ Layer8
            foreach (var s32Data in _document.S32Files.Values)
            {
                if (s32Data.Layer8.Count == 0) continue;

                for (int i = 0; i < s32Data.Layer8.Count; i++)
                {
                    var item = s32Data.Layer8[i];

                    // æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
                    int localL3X = item.X - s32Data.SegInfo.nLinBeginX;
                    int localL3Y = item.Y - s32Data.SegInfo.nLinBeginY;

                    if (localL3X < 0 || localL3X > 63 || localL3Y < 0 || localL3Y > 63)
                        continue;

                    var key = (s32Data.FilePath, i);
                    if (!_editState.EnabledLayer8Items.Contains(key))
                    {
                        _editState.EnabledLayer8Items.Add(key);
                        _layer8AnimFrame[key] = 0;
                        addedCount++;
                    }
                }
            }

            // å•Ÿå‹•å‹•ç•«è¨ˆæ™‚å™¨
            if (addedCount > 0 && _layer8AnimTimer != null && !_layer8AnimTimer.Enabled)
            {
                _layer8AnimTimer.Start();
            }

            // ç¢ºä¿ Layer8 é¡¯ç¤ºå·²é–‹å•Ÿ
            if (!_viewState.ShowLayer8)
            {
                _viewState.ShowLayer8 = true;
                chkFloatLayer8.Checked = true;
            }

            this.toolStripStatusLabel1.Text = string.Format(LocalizationManager.L("L8_EnabledCount"), addedCount, _editState.EnabledLayer8Items.Count);
            RenderS32Map();
        }

        // åŸ·è¡Œåº§æ¨™è·³è½‰
        private void PerformCoordinateJump()
        {
            string input = toolStripJumpTextBox.Text.Trim();
            if (string.IsNullOrEmpty(input))
            {
                this.toolStripStatusLabel1.Text = "è«‹è¼¸å…¥åº§æ¨™ï¼Œæ ¼å¼: X,Y";
                return;
            }

            if (TryParseCoordinate(input, out int x, out int y))
            {
                JumpToGameCoordinate(x, y);
                this.toolStripStatusLabel1.Text = $"å·²è·³è½‰åˆ°åº§æ¨™ ({x}, {y})";
            }
            else
            {
                this.toolStripStatusLabel1.Text = "åº§æ¨™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨æ ¼å¼: X,Y (ä¾‹å¦‚: 32800,32700)";
            }
        }

        // è·³è½‰åˆ°æŒ‡å®šçš„éŠæˆ²åº§æ¨™ (Layer3 åº§æ¨™ç³»ï¼š64x64)
        private void JumpToGameCoordinate(int globalX, int globalY)
        {
            if (!Share.MapDataList.ContainsKey(_document.MapId))
                return;

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // æ‰¾åˆ°åŒ…å«æ­¤åº§æ¨™çš„ S32 (ä½¿ç”¨ Layer3 åº§æ¨™ç³»ï¼š64x64)
            foreach (var s32Data in _document.S32Files.Values)
            {
                int segStartX = s32Data.SegInfo.nLinBeginX;
                int segStartY = s32Data.SegInfo.nLinBeginY;
                int segEndX = segStartX + 64;
                int segEndY = segStartY + 64;

                if (globalX >= segStartX && globalX < segEndX &&
                    globalY >= segStartY && globalY < segEndY)
                {
                    // Layer3 çš„æœ¬åœ°åº§æ¨™
                    int layer3LocalX = globalX - segStartX;
                    int localY = globalY - segStartY;

                    // è½‰æ›ç‚º Layer1 åº§æ¨™ (ç”¨æ–¼é«˜äº®å’Œè¢å¹•åº§æ¨™è¨ˆç®—)
                    int localX = layer3LocalX * 2;

                    // è¨ˆç®—è¢å¹•åº§æ¨™
                    int[] loc = s32Data.SegInfo.GetLoc(1.0);
                    int mx = loc[0];
                    int my = loc[1];

                    int localBaseX = 0;
                    int localBaseY = 63 * 12;
                    localBaseX -= 24 * (localX / 2);
                    localBaseY -= 12 * (localX / 2);

                    // è¨ˆç®—ä¸–ç•Œåº§æ¨™ï¼ˆé€™æ˜¯æ ¼å­çš„è¢å¹•åº§æ¨™ï¼Œä½†åœ¨é€™è£¡æ˜¯ä¸–ç•Œåº§æ¨™ï¼‰
                    int worldX = mx + localBaseX + localX * 24 + localY * 24;
                    int worldY = my + localBaseY + localY * 12;

                    // æ²å‹•åˆ°è©²ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
                    int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
                    int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);
                    int scrollX = worldX - viewportWidthWorld / 2;
                    int scrollY = worldY - viewportHeightWorld / 2;

                    int maxScrollX = Math.Max(0, _viewState.MapWidth - viewportWidthWorld);
                    int maxScrollY = Math.Max(0, _viewState.MapHeight - viewportHeightWorld);
                    scrollX = Math.Max(0, Math.Min(scrollX, maxScrollX));
                    scrollY = Math.Max(0, Math.Min(scrollY, maxScrollY));

                    _viewState.SetScrollSilent(scrollX, scrollY);

                    // è¨­å®šé«˜äº® (ä½¿ç”¨ Layer1 åº§æ¨™)
                    _editState.HighlightedS32Data = s32Data;
                    _editState.HighlightedCellX = localX;
                    _editState.HighlightedCellY = localY;

                    CheckAndRerenderIfNeeded();
                    UpdateMiniMap();
                    return;
                }
            }
        }

        // è¼‰å…¥æ”¾å¤§çš„ Tile
        private Bitmap LoadTileEnlarged(int tileId, int indexId, int size)
        {
            try
            {
                string key = $"{tileId}.til";
                byte[] data = L1PakReader.UnPack("Tile", key);
                if (data == null) return CreatePlaceholderThumbnail(tileId);

                var tilArray = L1Til.Parse(data);
                if (indexId >= tilArray.Count) return CreatePlaceholderThumbnail(tileId);

                // ç¹ªè£½å¯¦éš›çš„ tile åœ–ç‰‡ï¼ˆæ”¾å¤§ç‰ˆæœ¬ï¼‰
                byte[] tilData = tilArray[indexId];
                return RenderTileEnlarged(tilData, tileId, size);
            }
            catch
            {
                return CreatePlaceholderThumbnail(tileId);
            }
        }

        // å‰µå»ºæ‰€æœ‰ç›¸é—œç‰©ä»¶é¢æ¿ï¼ˆåŒ…å«å‘¨åœç‰©ä»¶ï¼‰
        private Panel CreateAllRelatedObjectsPanel(int cellX, int cellY)
        {
            Panel panel = new Panel();
            panel.Dock = DockStyle.Fill;
            panel.AutoScroll = true;

            // æ‰¾å‡ºæ‰€æœ‰å¯èƒ½å½±éŸ¿è©²æ ¼å­é¡¯ç¤ºçš„ç‰©ä»¶
            // åŒ…å«ï¼šè©²æ ¼å­çš„ç‰©ä»¶ + å‘¨åœæ ¼å­çš„å¤§å‹ç‰©ä»¶
            List<ObjectTile> relatedObjects = new List<ObjectTile>();

            // æœç´¢ç¯„åœï¼šç•¶å‰æ ¼å­ Â± 5 æ ¼ï¼ˆå¤§å‹ç‰©ä»¶å¯èƒ½å¾ˆå¤§ï¼‰
            int searchRange = 5;
            for (int dy = -searchRange; dy <= searchRange; dy++)
            {
                for (int dx = -searchRange; dx <= searchRange; dx++)
                {
                    int checkX = cellX + dx;
                    int checkY = cellY + dy;

                    // åœ¨ç¯„åœå…§
                    if (checkX >= 0 && checkX < 128 && checkY >= 0 && checkY < 64)
                    {
                        var objectsAtPos = currentS32Data.Layer4.Where(o => o.X == checkX && o.Y == checkY).ToList();
                        foreach (var obj in objectsAtPos)
                        {
                            // è¨ˆç®—ç‰©ä»¶èˆ‡ç›®æ¨™æ ¼å­çš„è·é›¢
                            int distance = Math.Abs(dx) + Math.Abs(dy);
                            relatedObjects.Add(obj);
                        }
                    }
                }
            }

            // æŒ‰è·é›¢å’Œå±¤æ¬¡æ’åº
            relatedObjects = relatedObjects
                .OrderBy(o => Math.Abs(o.X - cellX) + Math.Abs(o.Y - cellY))
                .ThenBy(o => o.Layer)
                .ToList();

            if (relatedObjects.Count > 0)
            {
                FlowLayoutPanel flow = new FlowLayoutPanel();
                flow.Dock = DockStyle.Fill;
                flow.AutoScroll = true;
                flow.FlowDirection = FlowDirection.TopDown;
                flow.WrapContents = false;

                Label header = new Label();
                header.Text = $"æ‰¾åˆ° {relatedObjects.Count} å€‹ç›¸é—œç‰©ä»¶";
                header.Font = new Font("Arial", 10, FontStyle.Bold);
                header.Height = 30;
                header.TextAlign = ContentAlignment.MiddleLeft;
                flow.Controls.Add(header);

                foreach (var obj in relatedObjects)
                {
                    Panel objPanel = new Panel();
                    objPanel.Width = flow.Width - 25;
                    objPanel.Height = 240;
                    objPanel.BorderStyle = BorderStyle.FixedSingle;
                    objPanel.Margin = new Padding(5);
                    objPanel.BackColor = (obj.X == cellX && obj.Y == cellY) ? Color.LightYellow : Color.White;

                    // ä½ç½®æ¨™ç±¤
                    Label posLabel = new Label();
                    int distance = Math.Abs(obj.X - cellX) + Math.Abs(obj.Y - cellY);
                    posLabel.Text = distance == 0
                        ? $"[æ­¤æ ¼å­] ä½ç½®: ({obj.X},{obj.Y})"
                        : $"[è·é›¢{distance}] ä½ç½®: ({obj.X},{obj.Y})";
                    posLabel.Dock = DockStyle.Top;
                    posLabel.Height = 20;
                    posLabel.BackColor = distance == 0 ? Color.Yellow : Color.LightGray;
                    posLabel.TextAlign = ContentAlignment.MiddleCenter;
                    posLabel.Font = new Font("Arial", 8, FontStyle.Bold);
                    objPanel.Controls.Add(posLabel);

                    PictureBox pb = new PictureBox();
                    pb.Dock = DockStyle.Top;
                    pb.Height = 128;
                    pb.SizeMode = PictureBoxSizeMode.Zoom;
                    pb.BackColor = Color.Black;
                    pb.Image = LoadTileEnlarged(obj.TileId, obj.IndexId, 128);
                    objPanel.Controls.Add(pb);

                    Label info = new Label();
                    info.Text = $"Tile ID: {obj.TileId} | Index: {obj.IndexId}\n" +
                               $"Layer: {obj.Layer} | Group: {obj.GroupId}\n" +
                               $"ä½ç½®: ({obj.X},{obj.Y})";
                    info.Dock = DockStyle.Bottom;
                    info.Height = 60;
                    info.TextAlign = ContentAlignment.MiddleCenter;
                    objPanel.Controls.Add(info);

                    // åˆªé™¤æŒ‰éˆ•
                    Button btnDeleteObj = new Button();
                    btnDeleteObj.Text = "åˆªé™¤æ­¤ç‰©ä»¶";
                    btnDeleteObj.Dock = DockStyle.Bottom;
                    btnDeleteObj.Height = 25;
                    btnDeleteObj.BackColor = Color.Red;
                    btnDeleteObj.ForeColor = Color.White;
                    var objToDelete = obj;
                    btnDeleteObj.Click += (s, e) =>
                    {
                        if (MessageBox.Show($"ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©ä»¶å—ï¼Ÿ\nä½ç½®:({objToDelete.X},{objToDelete.Y})\nGroup:{objToDelete.GroupId}, Layer:{objToDelete.Layer}",
                            "ç¢ºèª", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                        {
                            currentS32Data.Layer4.Remove(objToDelete);
                            Layer4Index_Remove(currentS32Data, objToDelete);

                            isS32Modified = true;
                            RenderS32Map();
                            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ç‰©ä»¶ ({objToDelete.X},{objToDelete.Y})";

                            // æ›´æ–°ç•¶å‰é¢æ¿é¡¯ç¤º
                            pb.Image = null;
                            info.Text = "å·²åˆªé™¤";
                            btnDeleteObj.Enabled = false;
                            objPanel.BackColor = Color.LightGray;
                        }
                    };
                    objPanel.Controls.Add(btnDeleteObj);

                    flow.Controls.Add(objPanel);
                }

                panel.Controls.Add(flow);
            }
            else
            {
                Label noData = new Label();
                noData.Text = "é™„è¿‘æ²’æœ‰ç‰©ä»¶";
                noData.Dock = DockStyle.Fill;
                noData.TextAlign = ContentAlignment.MiddleCenter;
                panel.Controls.Add(noData);
            }

            return panel;
        }

        // å‰µå»ºæ¸²æŸ“è³‡è¨Šé¢æ¿
        private Panel CreateRenderInfoPanel(int cellX, int cellY)
        {
            Panel panel = new Panel();
            panel.Dock = DockStyle.Fill;
            panel.AutoScroll = true;
            panel.BackColor = Color.White;

            TextBox txtInfo = new TextBox();
            txtInfo.Multiline = true;
            txtInfo.Dock = DockStyle.Fill;
            txtInfo.Font = new Font("Consolas", 9);
            txtInfo.ScrollBars = ScrollBars.Both;
            txtInfo.WordWrap = false;

            // è¨ˆç®—éŠæˆ²åº§æ¨™ï¼ˆLayer3 å°ºåº¦ï¼‰
            int layer3X = cellX / 2;
            if (layer3X >= 64) layer3X = 63;
            int gameX = currentS32FileItem.SegInfo.nLinBeginX + layer3X;
            int gameY = currentS32FileItem.SegInfo.nLinBeginY + cellY;

            StringBuilder info = new StringBuilder();
            info.AppendLine("==================== æ ¼å­æ¸²æŸ“è³‡è¨Š ====================");
            info.AppendLine($"æ ¼å­åº§æ¨™: ({cellX}, {cellY})");
            info.AppendLine($"éŠæˆ²åº§æ¨™: ({gameX}, {gameY})");
            info.AppendLine();

            // ç¬¬ä¸€å±¤è³‡è¨Š
            info.AppendLine("ã€ç¬¬1å±¤ - åœ°æ¿ã€‘");
            var cell = currentS32Data.Layer1[cellY, cellX];
            if (cell != null && cell.TileId > 0)
            {
                info.AppendLine($"  Tile ID: {cell.TileId}");
                info.AppendLine($"  Index ID: {cell.IndexId}");
                info.AppendLine($"  æª”æ¡ˆ: {cell.TileId}.til");
                info.AppendLine($"  å·²ä¿®æ”¹: {(cell.IsModified ? "æ˜¯" : "å¦")}");
            }
            else
            {
                info.AppendLine("  (ç©º)");
            }
            info.AppendLine();

            // ç¬¬äºŒå±¤è³‡è¨Š
            info.AppendLine("ã€ç¬¬2å±¤ - è³‡æ–™ã€‘");
            info.AppendLine($"  ç¸½å…±æœ‰ {currentS32Data.Layer2.Count} é …è³‡æ–™");
            info.AppendLine("  (æ­¤å±¤ä¸å°æ‡‰å…·é«”æ ¼å­)");
            info.AppendLine();

            // ç¬¬ä¸‰å±¤è³‡è¨Š
            info.AppendLine("ã€ç¬¬3å±¤ - å±¬æ€§ã€‘");
            var attr = currentS32Data.Layer3[cellY, layer3X];
            if (attr != null)
            {
                info.AppendLine($"  å·¦ä¸Šé‚Š: 0x{attr.Attribute1:X4} ({attr.Attribute1})");
                info.AppendLine($"  å³ä¸Šé‚Š: 0x{attr.Attribute2:X4} ({attr.Attribute2})");

                // å·¦ä¸Šé‚Šæ¨™è¨˜
                List<string> flags1 = new List<string>();
                if ((attr.Attribute1 & 0x01) != 0)
                    flags1.Add("ä¸å¯é€šè¡Œ");
                else
                    flags1.Add("å¯é€šè¡Œ");
                // æ ¹æ“š MapTool é‚è¼¯åˆ¤æ–·å€åŸŸ
                int val1 = attr.Attribute1 & 0x0F;
                if ((val1 & 0x04) != 0) flags1.Add("å®‰å…¨å€");
                else if ((val1 & 0x0C) == 0x08) flags1.Add("æˆ°é¬¥å€");
                if ((attr.Attribute1 & 0x02) != 0) flags1.Add("æ¨™è¨˜2");
                if ((attr.Attribute1 & 0x10) != 0) flags1.Add("æ¨™è¨˜16");
                info.AppendLine($"  å·¦ä¸Šé‚Šæ¨™è¨˜: {string.Join(", ", flags1)}");

                // å³ä¸Šé‚Šæ¨™è¨˜
                List<string> flags2 = new List<string>();
                if ((attr.Attribute2 & 0x01) != 0)
                    flags2.Add("ä¸å¯é€šè¡Œ");
                else
                    flags2.Add("å¯é€šè¡Œ");
                int val2 = attr.Attribute2 & 0x0F;
                if ((val2 & 0x04) != 0) flags2.Add("å®‰å…¨å€");
                else if ((val2 & 0x0C) == 0x08) flags2.Add("æˆ°é¬¥å€");
                if ((attr.Attribute2 & 0x02) != 0) flags2.Add("æ¨™è¨˜2");
                if ((attr.Attribute2 & 0x10) != 0) flags2.Add("æ¨™è¨˜16");
                info.AppendLine($"  å³ä¸Šé‚Šæ¨™è¨˜: {string.Join(", ", flags2)}");
            }
            else
            {
                info.AppendLine("  (ç©º)");
            }
            info.AppendLine();

            // ç¬¬å››å±¤è³‡è¨Š
            info.AppendLine("ã€ç¬¬4å±¤ - ç‰©ä»¶ã€‘");
            var objectsAtCell = currentS32Data.Layer4.Where(o => o.X == cellX && o.Y == cellY).OrderBy(o => o.Layer).ToList();
            if (objectsAtCell.Count > 0)
            {
                info.AppendLine($"  æ­¤æ ¼å­æœ‰ {objectsAtCell.Count} å€‹ç‰©ä»¶:");
                foreach (var obj in objectsAtCell)
                {
                    info.AppendLine($"    - Tile ID: {obj.TileId}, Index: {obj.IndexId}");
                    info.AppendLine($"      Layer: {obj.Layer}, Group: {obj.GroupId}");
                    info.AppendLine($"      æª”æ¡ˆ: {obj.TileId}.til æˆ– {obj.TileId}.spr");
                }
            }
            else
            {
                info.AppendLine("  (ç„¡ç‰©ä»¶)");
            }
            info.AppendLine();

            // å‘¨åœç‰©ä»¶çµ±è¨ˆ
            info.AppendLine("ã€å‘¨åœç‰©ä»¶çµ±è¨ˆã€‘");
            int nearbyCount = currentS32Data.Layer4.Count(o =>
                Math.Abs(o.X - cellX) <= 5 && Math.Abs(o.Y - cellY) <= 5);
            info.AppendLine($"  5æ ¼ç¯„åœå…§ç‰©ä»¶æ•¸: {nearbyCount}");
            info.AppendLine();

            // æª”æ¡ˆè³‡è¨Š
            info.AppendLine("ã€S32 æª”æ¡ˆè³‡è¨Šã€‘");
            info.AppendLine($"  æª”æ¡ˆ: {Path.GetFileName(currentS32FileItem.FilePath)}");
            info.AppendLine($"  Block åº§æ¨™: ({currentS32FileItem.SegInfo.nBlockX:X4}, {currentS32FileItem.SegInfo.nBlockY:X4})");
            info.AppendLine($"  éŠæˆ²åº§æ¨™ç¯„åœ: [{currentS32FileItem.SegInfo.nLinBeginX},{currentS32FileItem.SegInfo.nLinBeginY}] ~ [{currentS32FileItem.SegInfo.nLinEndX},{currentS32FileItem.SegInfo.nLinEndY}]");
            info.AppendLine($"  å·²ä¿®æ”¹: {(isS32Modified ? "æ˜¯" : "å¦")}");
            info.AppendLine();

            // ä½¿ç”¨çš„ Tile çµ±è¨ˆ
            info.AppendLine("ã€ä½¿ç”¨çš„ Tile çµ±è¨ˆã€‘");
            info.AppendLine($"  ç¸½å…±ä½¿ç”¨ {currentS32Data.UsedTiles.Count} ç¨®ä¸åŒçš„ Tile");
            info.AppendLine($"  ç¬¬1å±¤æ ¼å­æ•¸: {64 * 128} (64x128)");
            info.AppendLine($"  ç¬¬3å±¤æ ¼å­æ•¸: {64 * 64} (64x64)");
            info.AppendLine($"  ç¬¬4å±¤ç‰©ä»¶æ•¸: {currentS32Data.Layer4.Count}");

            txtInfo.Text = info.ToString();
            panel.Controls.Add(txtInfo);

            return panel;
        }

        // ä¿å­˜ S32 æŒ‰éˆ•é»æ“Šäº‹ä»¶ - ä¿å­˜æ‰€æœ‰è¢«ä¿®æ”¹çš„ S32 æª”æ¡ˆ
        private void btnSaveS32_Click(object sender, EventArgs e)
        {
            // æ‰¾å‡ºæ‰€æœ‰è¢«ä¿®æ”¹çš„ S32 æª”æ¡ˆ
            var modifiedFiles = _document.S32Files.Where(kvp => kvp.Value.IsModified).ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

            if (modifiedFiles.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "æ²’æœ‰éœ€è¦ä¿å­˜çš„ä¿®æ”¹";
                return;
            }

            // æª¢æŸ¥ Layer5 ç•°å¸¸
            if (!CheckLayer5IssuesAndConfirm(modifiedFiles, "ä¿å­˜"))
                return;

            int successCount = 0;
            int failCount = 0;
            StringBuilder errors = new StringBuilder();

            foreach (var kvp in modifiedFiles)
            {
                try
                {
                    SaveS32File(kvp.Key);
                    kvp.Value.IsModified = false;
                    successCount++;
                }
                catch (Exception ex)
                {
                    failCount++;
                    errors.AppendLine($"{Path.GetFileName(kvp.Key)}: {ex.Message}");
                }
            }

            // åªåœ¨ç‹€æ…‹åˆ—é¡¯ç¤ºçµæœ
            if (failCount == 0)
            {
                this.toolStripStatusLabel1.Text = $"æˆåŠŸä¿å­˜ {successCount} å€‹ S32 æª”æ¡ˆ";
            }
            else
            {
                this.toolStripStatusLabel1.Text = $"ä¿å­˜å®Œæˆï¼šæˆåŠŸ {successCount} å€‹ï¼Œå¤±æ•— {failCount} å€‹";
                // åªæœ‰å¤±æ•—æ™‚æ‰é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                MessageBox.Show(
                    $"ä¿å­˜å®Œæˆï¼š\næˆåŠŸ: {successCount} å€‹\nå¤±æ•—: {failCount} å€‹\n\nå¤±æ•—è©³æƒ…ï¼š\n{errors}",
                    "éƒ¨åˆ†å¤±æ•—",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);
            }
        }

        // ä¿å­˜ S32 æª”æ¡ˆï¼ˆå®‰å…¨æ¨¡å¼ï¼šåªæ›´æ–°ä¿®æ”¹éçš„éƒ¨åˆ†ï¼‰
        private void SaveS32File(string filePath)
        {
            // å¾å­—å…¸ä¸­å–å¾—å°æ‡‰çš„ S32Data
            if (!_document.S32Files.ContainsKey(filePath))
            {
                throw new InvalidOperationException($"S32 æª”æ¡ˆä¸åœ¨è¨˜æ†¶é«”ä¸­: {filePath}");
            }

            S32Data s32Data = _document.S32Files[filePath];

            using (MemoryStream ms = new MemoryStream())
            using (BinaryWriter bw = new BinaryWriter(ms))
            {
                // ç¬¬ä¸€æ­¥ï¼šå¯«å…¥å‰å››å±¤ä¹‹å‰çš„æ•¸æ“šï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œé€šå¸¸ç¬¬ä¸€å±¤å¾0é–‹å§‹ï¼‰
                if (s32Data.Layer1Offset > 0)
                {
                    bw.Write(s32Data.OriginalFileData, 0, s32Data.Layer1Offset);
                }

                // ç¬¬äºŒæ­¥ï¼šå¯«å…¥ç¬¬ä¸€å±¤ï¼ˆåœ°æ¿ï¼‰- 64x128
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null)
                        {
                            bw.Write((byte)cell.IndexId);
                            bw.Write((ushort)cell.TileId);
                            bw.Write((byte)0); // nk
                        }
                        else
                        {
                            bw.Write((byte)0);
                            bw.Write((ushort)0);
                            bw.Write((byte)0);
                        }
                    }
                }

                // ç¬¬ä¸‰æ­¥ï¼šå¯«å…¥ç¬¬äºŒå±¤
                bw.Write((ushort)s32Data.Layer2.Count);
                foreach (var item in s32Data.Layer2)
                {
                    bw.Write(item.X);
                    bw.Write(item.Y);
                    bw.Write(item.IndexId);
                    bw.Write(item.TileId);
                    bw.Write(item.UK);
                }

                // ç¬¬å››æ­¥ï¼šå¯«å…¥ç¬¬ä¸‰å±¤ï¼ˆåœ°åœ–å±¬æ€§ï¼‰- 64x64
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 64; x++)
                    {
                        var attr = s32Data.Layer3[y, x];
                        if (attr != null)
                        {
                            bw.Write(attr.Attribute1);
                            bw.Write(attr.Attribute2);
                        }
                        else
                        {
                            bw.Write((short)0);
                            bw.Write((short)0);
                        }
                    }
                }

                // ç¬¬äº”æ­¥ï¼šå¯«å…¥ç¬¬å››å±¤ï¼ˆç‰©ä»¶ï¼‰- é‡æ–°ç·¨æ’ GroupId å¾ 0 é–‹å§‹
                // æ”¶é›†æ‰€æœ‰ Layer5 å¼•ç”¨çš„ GroupId
                var layer5ReferencedGroups = new HashSet<int>(s32Data.Layer5.Select(l5 => (int)l5.ObjectIndex));

                // å°‡æ‰€æœ‰ç¾¤çµ„åˆ†çµ„
                var allGroups = s32Data.Layer4
                    .GroupBy(o => o.GroupId)
                    .ToList();

                // æ’åºï¼šæœ‰ Layer5 å¼•ç”¨çš„åœ¨å‰ï¼Œå…¶é¤˜æŒ‰åŸ GroupId æ’åº
                var sortedGroups = allGroups
                    .OrderByDescending(g => layer5ReferencedGroups.Contains(g.Key) ? 1 : 0)
                    .ThenBy(g => g.Key)
                    .ToList();

                // å»ºç«‹èˆŠ GroupId -> æ–° GroupId çš„æ˜ å°„
                var groupIdMapping = new Dictionary<int, int>();
                for (int idx = 0; idx < sortedGroups.Count; idx++)
                {
                    groupIdMapping[sortedGroups[idx].Key] = idx;
                }

                // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ Layer4 GroupId
                foreach (var obj in s32Data.Layer4)
                {
                    if (groupIdMapping.TryGetValue(obj.GroupId, out int newId))
                    {
                        obj.GroupId = newId;
                    }
                }

                // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ Layer5 ObjectIndex
                foreach (var l5Item in s32Data.Layer5)
                {
                    int oldIndex = l5Item.ObjectIndex;
                    if (groupIdMapping.TryGetValue(oldIndex, out int newIndex))
                    {
                        l5Item.ObjectIndex = (ushort)newIndex;
                    }
                }

                // é‡æ–°åˆ†çµ„ï¼ˆä½¿ç”¨æ–°çš„ GroupIdï¼‰
                var groupedObjects = s32Data.Layer4
                    .GroupBy(o => o.GroupId)
                    .OrderBy(g => g.Key)
                    .ToList();

                bw.Write(groupedObjects.Count); // çµ„æ•¸

                foreach (var group in groupedObjects)
                {
                    var objects = group.OrderBy(o => o.Layer).ToList();
                    bw.Write((short)group.Key); // GroupId (æ–°ç·¨è™Ÿ)
                    bw.Write((ushort)objects.Count); // è©²çµ„çš„ç‰©ä»¶æ•¸

                    foreach (var obj in objects)
                    {
                        bw.Write((byte)obj.X);
                        bw.Write((byte)obj.Y);
                        bw.Write((byte)obj.Layer);  // h (åœ–å±¤é«˜åº¦)
                        // tiledata = indexId | (tileId << 8)
                        uint tileData = (uint)(obj.IndexId & 0xFF) | (uint)((obj.TileId & 0xFFFFFF) << 8);
                        bw.Write(tileData);
                    }
                }

                // ç¬¬å…­æ­¥ï¼šå¯«å…¥ç¬¬5-8å±¤æ•¸æ“šï¼ˆå¾è§£æå¾Œçš„è³‡æ–™é‡æ–°ç”Ÿæˆï¼‰
                // ç¬¬äº”å±¤ - äº‹ä»¶ï¼ˆåªå¯«å…¥ X ç‚ºå¶æ•¸çš„é …ç›®ï¼‰
                var layer5EvenX = s32Data.Layer5.Where(item => item.X % 2 == 0).ToList();
                bw.Write(layer5EvenX.Count);
                foreach (var item in layer5EvenX)
                {
                    bw.Write(item.X);
                    bw.Write(item.Y);
                    bw.Write(item.ObjectIndex);
                    bw.Write(item.Type);
                }

                // ç¬¬å…­å±¤ - ä½¿ç”¨çš„ tilï¼ˆé‡æ–°è¨ˆç®—ä¸¦æ’åºï¼‰
                // æ”¶é›† Layer1 å’Œ Layer4 ä½¿ç”¨çš„æ‰€æœ‰ TileId
                HashSet<int> usedTileIds = new HashSet<int>();

                // å¾ Layer1 æ”¶é›†
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId > 0)
                        {
                            usedTileIds.Add(cell.TileId);
                        }
                    }
                }

                // å¾ Layer4 æ”¶é›†
                foreach (var obj in s32Data.Layer4)
                {
                    if (obj.TileId > 0)
                    {
                        usedTileIds.Add(obj.TileId);
                    }
                }

                // æ’åºå¾Œå¯«å…¥
                List<int> sortedTileIds = usedTileIds.OrderBy(id => id).ToList();
                bw.Write(sortedTileIds.Count);
                foreach (var tilId in sortedTileIds)
                {
                    bw.Write(tilId);
                }

                // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ Layer6 è³‡æ–™
                s32Data.Layer6.Clear();
                s32Data.Layer6.AddRange(sortedTileIds);

                // ç¬¬ä¸ƒå±¤ - å‚³é€é»ã€å…¥å£é»
                bw.Write((ushort)s32Data.Layer7.Count);
                foreach (var item in s32Data.Layer7)
                {
                    byte[] nameBytes = Encoding.Default.GetBytes(item.Name ?? "");
                    bw.Write((byte)nameBytes.Length);
                    bw.Write(nameBytes);
                    bw.Write(item.X);
                    bw.Write(item.Y);
                    bw.Write(item.TargetMapId);
                    bw.Write(item.PortalId);
                }

                // ç¬¬å…«å±¤ - ç‰¹æ•ˆã€è£é£¾å“
                ushort lv8Count = (ushort)s32Data.Layer8.Count;
                if (s32Data.Layer8HasExtendedData)
                {
                    lv8Count |= 0x8000;  // è¨­ç½®é«˜ä½è¡¨ç¤ºæœ‰æ“´å±•è³‡æ–™
                }
                bw.Write(lv8Count);
                foreach (var item in s32Data.Layer8)
                {
                    bw.Write(item.SprId);
                    bw.Write(item.X);
                    bw.Write(item.Y);
                    if (s32Data.Layer8HasExtendedData)
                    {
                        bw.Write(item.ExtendedData);
                    }
                }

                // ç¬¬ä¸ƒæ­¥ï¼šå°‡å®Œæ•´æ•¸æ“šå¯«å…¥æ–‡ä»¶
                byte[] outputData = ms.ToArray();
                File.WriteAllBytes(filePath, outputData);
            }
        }

        // ç¹ªè£½æ”¾å¤§çš„ Tile åˆ°æŒ‡å®šå¤§å°
        private unsafe Bitmap RenderTileEnlarged(byte[] tilData, int tileId, int size)
        {
            try
            {
                // å‰µå»ºæŒ‡å®šå¤§å°çš„ç¸®åœ–
                Bitmap thumbnail = new Bitmap(size, size, PixelFormat.Format16bppRgb555);

                Rectangle rect = new Rectangle(0, 0, thumbnail.Width, thumbnail.Height);
                BitmapData bmpData = thumbnail.LockBits(rect, ImageLockMode.ReadWrite, thumbnail.PixelFormat);
                int rowpix = bmpData.Stride;
                byte* ptr = (byte*)bmpData.Scan0;

                // å›ºå®š tilData é™£åˆ—ä»¥å–å¾—æŒ‡æ¨™
                fixed (byte* til_ptr_fixed = tilData)
                {
                    byte* til_ptr = til_ptr_fixed;
                    byte type = *(til_ptr++);

                    // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹å’Œåç§»ï¼ˆç½®ä¸­ä¸¦æ”¾å¤§ï¼‰
                    double scale = size / 48.0; // 48 æ˜¯åŸå§‹å¤§å°
                    int offsetX = (int)((size - 24 * scale) / 2);
                    int offsetY = (int)((size - 24 * scale) / 2);

                    if ((type & 0x02) == 0 && (type & 0x01) != 0)
                    {
                        // ä¸‹åŠéƒ¨ 2.5D æ–¹å¡Š
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 0;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));

                                // æ”¾å¤§ç¹ªè£½
                                int baseX = (int)(offsetX + tx * scale);
                                int baseY = (int)(offsetY + ty * scale);

                                for (int sy = 0; sy < (int)scale + 1; sy++)
                                {
                                    for (int sx = 0; sx < (int)scale + 1; sx++)
                                    {
                                        int px = baseX + sx;
                                        int py = baseY + sy;
                                        if (px >= 0 && px < size && py >= 0 && py < size)
                                        {
                                            int v = py * rowpix + (px * 2);
                                            *(ptr + v) = (byte)(color & 0x00FF);
                                            *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                        }
                                    }
                                }
                                tx++;
                            }
                        }
                    }
                    else if (type == 0 || type == 8 || type == 16)
                    {
                        // ä¸ŠåŠéƒ¨ 2.5D æ–¹å¡Š
                        for (int ty = 0; ty < 24; ty++)
                        {
                            int n = (ty <= 11) ? (ty + 1) * 2 : (23 - ty) * 2;
                            int tx = 24 - n;
                            for (int p = 0; p < n; p++)
                            {
                                ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));

                                // æ”¾å¤§ç¹ªè£½
                                int baseX = (int)(offsetX + tx * scale);
                                int baseY = (int)(offsetY + ty * scale);

                                for (int sy = 0; sy < (int)scale + 1; sy++)
                                {
                                    for (int sx = 0; sx < (int)scale + 1; sx++)
                                    {
                                        int px = baseX + sx;
                                        int py = baseY + sy;
                                        if (px >= 0 && px < size && py >= 0 && py < size)
                                        {
                                            int v = py * rowpix + (px * 2);
                                            *(ptr + v) = (byte)(color & 0x00FF);
                                            *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                        }
                                    }
                                }
                                tx++;
                            }
                        }
                    }
                    else
                    {
                        // å£“ç¸®æ ¼å¼
                        byte x_offset = *(til_ptr++);
                        byte y_offset = *(til_ptr++);
                        byte xxLen = *(til_ptr++);
                        byte yLen = *(til_ptr++);

                        for (int ty = 0; ty < yLen && ty < size; ty++)
                        {
                            int tx = x_offset;
                            byte xSegmentCount = *(til_ptr++);
                            for (int nx = 0; nx < xSegmentCount; nx++)
                            {
                                tx += *(til_ptr++) / 2;
                                int xLen = *(til_ptr++);
                                for (int p = 0; p < xLen; p++)
                                {
                                    ushort color = (ushort)(*(til_ptr++) | (*(til_ptr++) << 8));

                                    // æ”¾å¤§ç¹ªè£½
                                    int baseX = (int)(offsetX + tx * scale);
                                    int baseY = (int)(offsetY + (ty + y_offset) * scale);

                                    for (int sy = 0; sy < (int)scale + 1; sy++)
                                    {
                                        for (int sx = 0; sx < (int)scale + 1; sx++)
                                        {
                                            int px = baseX + sx;
                                            int py = baseY + sy;
                                            if (px >= 0 && px < size && py >= 0 && py < size)
                                            {
                                                int v = py * rowpix + (px * 2);
                                                *(ptr + v) = (byte)(color & 0x00FF);
                                                *(ptr + v + 1) = (byte)((color & 0xFF00) >> 8);
                                            }
                                        }
                                    }
                                    tx++;
                                }
                            }
                        }
                    }
                }

                thumbnail.UnlockBits(bmpData);
                return thumbnail;
            }
            catch
            {
                return CreatePlaceholderThumbnail(tileId);
            }
         }


        // æ›´æ–°é™„è¿‘ç¾¤çµ„ç¸®åœ–ï¼ˆé€æ˜ç·¨è¼¯æ¨¡å¼ç”¨ï¼‰
        private void UpdateNearbyGroupThumbnails(S32Data clickedS32Data, int cellX, int cellY, int radius)
        {
            // è¨ˆç®—é»æ“Šä½ç½®çš„éŠæˆ²åº§æ¨™
            int clickedGameX = clickedS32Data.SegInfo.nLinBeginX + cellX / 2;
            int clickedGameY = clickedS32Data.SegInfo.nLinBeginY + cellY;

            // å…ˆæ”¶é›†é»æ“Šæ ¼å­çš„ Layer5 è¨­å®šï¼ˆç”¨æ–¼åˆ¤æ–·ç¾¤çµ„æ˜¯å¦æœ‰è¨­å®šï¼‰
            var clickedCellLayer5 = new Dictionary<int, byte>();  // GroupId -> Type
            foreach (var item in clickedS32Data.Layer5)
            {
                if (item.X == cellX && item.Y == cellY)
                {
                    if (!clickedCellLayer5.ContainsKey(item.ObjectIndex))
                    {
                        clickedCellLayer5[item.ObjectIndex] = item.Type;
                    }
                }
            }

            // ä½¿ç”¨ç©ºé–“ç´¢å¼•æ”¶é›†é™„è¿‘çš„ç¾¤çµ„ï¼ˆå¾ O(n) é™åˆ° O(1)ï¼‰
            var indexedGroups = _layer4SpatialIndex.CollectNearbyGroups(clickedGameX, clickedGameY, radius);

            // åŠ å…¥ Layer5 è¨­å®šè³‡è¨Š
            var nearbyGroups = new Dictionary<int, (int distance, List<(S32Data s32, ObjectTile obj)> objects, bool hasLayer5, byte layer5Type)>();
            foreach (var kvp in indexedGroups)
            {
                int groupId = kvp.Key;
                var (distance, objects) = kvp.Value;
                bool hasLayer5 = clickedCellLayer5.TryGetValue(groupId, out byte layer5Type);
                nearbyGroups[groupId] = (distance, objects, hasLayer5, layer5Type);
            }

            if (nearbyGroups.Count == 0)
            {
                lblGroupThumbnails.Text = string.Format(LocalizationManager.L("Label_NearbyGroupsCount"), 0);
                lvGroupThumbnails.Items.Clear();
                return;
            }

            // æ’åºï¼šæœ‰ Layer5 è¨­å®šçš„å„ªå…ˆï¼Œç„¶å¾ŒæŒ‰è·é›¢æ’åº
            var sortedGroups = nearbyGroups
                .OrderByDescending(g => g.Value.hasLayer5)  // æœ‰ Layer5 è¨­å®šçš„æ’å‰é¢
                .ThenBy(g => g.Value.distance)              // è·é›¢è¿‘çš„æ’å‰é¢
                .ThenBy(g => g.Key)                         // ç›¸åŒæ™‚æŒ‰ GroupId æ’åº
                .ToList();

            // Debug: è¼¸å‡ºæ’åºçµæœ
            Console.WriteLine($"[Layer5Edit] clickedCellLayer5 count: {clickedCellLayer5.Count}");
            foreach (var g in sortedGroups.Take(10))
            {
                Console.WriteLine($"  GroupId={g.Key}, hasL5={g.Value.hasLayer5}, dist={g.Value.distance}");
            }

            // è¨ˆç®—æœ‰ Layer5 è¨­å®šçš„ç¾¤çµ„æ•¸é‡
            int l5Count = sortedGroups.Count(g => g.Value.hasLayer5);

            // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨
            lblGroupThumbnails.Text = string.Format(LocalizationManager.L("Label_NearbyGroupsLoading"), sortedGroups.Count, l5Count);

            // å–æ¶ˆä¹‹å‰çš„ç¸®åœ–ç”¢ç”Ÿä»»å‹™
            if (_groupThumbnailCts != null)
            {
                _groupThumbnailCts.Cancel();
                _groupThumbnailCts.Dispose();
            }
            _groupThumbnailCts = new System.Threading.CancellationTokenSource();
            var cancellationToken = _groupThumbnailCts.Token;

            int totalGroups = sortedGroups.Count;

            // åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸¦è¡Œç”¢ç”Ÿç¸®åœ–
            Task.Run(() =>
            {
                var stopwatch = Stopwatch.StartNew();
                var thumbnailResults = new System.Collections.Concurrent.ConcurrentDictionary<int, (int groupId, int objectCount, Bitmap thumbnail, List<(S32Data s32, ObjectTile obj)> objects, bool hasLayer5, byte layer5Type, int distance)>();

                Parallel.ForEach(sortedGroups, new ParallelOptions { MaxDegreeOfParallelism = Environment.ProcessorCount }, (kvp, state) =>
                {
                    if (cancellationToken.IsCancellationRequested)
                    {
                        state.Stop();
                        return;
                    }

                    int groupId = kvp.Key;
                    var info = kvp.Value;

                    // ç”Ÿæˆç¾¤çµ„ç¸®åœ–ï¼ˆå‚³é Layer5 è¨­å®šä»¥ç¹ªè£½é‚Šæ¡†ï¼‰
                    Bitmap thumbnail = GenerateGroupThumbnail(info.objects, 80, info.hasLayer5, info.layer5Type);

                    if (thumbnail != null && !cancellationToken.IsCancellationRequested)
                    {
                        thumbnailResults[groupId] = (groupId, info.objects.Count, thumbnail, info.objects, info.hasLayer5, info.layer5Type, info.distance);
                    }
                });

                stopwatch.Stop();
                long elapsedMs = stopwatch.ElapsedMilliseconds;

                if (cancellationToken.IsCancellationRequested)
                {
                    foreach (var result in thumbnailResults.Values)
                    {
                        result.thumbnail?.Dispose();
                    }
                    return;
                }

                // åœ¨ UI åŸ·è¡Œç·’æ›´æ–° ListViewï¼ˆä¿æŒæ’åºé †åºï¼‰
                try
                {
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        if (cancellationToken.IsCancellationRequested) return;

                        ImageList imageList = new ImageList();
                        imageList.ImageSize = new Size(80, 80);
                        imageList.ColorDepth = ColorDepth.Depth32Bit;

                        lvGroupThumbnails.BeginUpdate();  // æš«åœé‡ç¹ª
                        try
                        {
                            lvGroupThumbnails.Items.Clear();
                            if (lvGroupThumbnails.LargeImageList != null)
                            {
                                lvGroupThumbnails.LargeImageList.Dispose();
                            }

                            // æ‰¹é‡æº–å‚™é …ç›®
                            var items = new List<ListViewItem>();
                            int thumbnailIndex = 0;
                            // æŒ‰åŸå§‹æ’åºé †åºæ·»åŠ ï¼ˆæœ‰ Layer5 çš„å„ªå…ˆï¼Œç„¶å¾ŒæŒ‰è·é›¢ï¼‰
                            foreach (var kvp in sortedGroups)
                            {
                                if (!thumbnailResults.TryGetValue(kvp.Key, out var result)) continue;

                                imageList.Images.Add(result.thumbnail);

                                string distanceText = result.distance == 0 ? "â—" : $"D{result.distance}";
                                ListViewItem item = new ListViewItem($"{distanceText} G{result.groupId} ({result.objectCount})");
                                item.ImageIndex = thumbnailIndex;
                                item.Tag = new GroupThumbnailInfo
                                {
                                    GroupId = result.groupId,
                                    Objects = result.objects,
                                    HasLayer5Setting = result.hasLayer5,
                                    Layer5Type = result.layer5Type
                                };
                                items.Add(item);

                                thumbnailIndex++;
                            }

                            // æ‰¹é‡æ·»åŠ 
                            lvGroupThumbnails.Items.AddRange(items.ToArray());
                            lvGroupThumbnails.LargeImageList = imageList;
                        }
                        finally
                        {
                            lvGroupThumbnails.EndUpdate();  // æ¢å¾©é‡ç¹ª
                        }
                        lblGroupThumbnails.Text = string.Format(LocalizationManager.L("Label_NearbyGroupsTime"), totalGroups, elapsedMs);
                    });
                }
                catch { }
            });
        }

        // ç´ æé¢æ¿ - é›™æ“Šé¸æ“‡ç´ æ
        private void lvMaterials_DoubleClick(object sender, EventArgs e)
        {
            if (lvMaterials.SelectedItems.Count == 0)
                return;

            var item = lvMaterials.SelectedItems[0];
            if (item.Tag is string filePath)
            {
                try
                {
                    // è¼‰å…¥ç´ æ
                    var library = new L1MapViewer.Helper.MaterialLibrary();
                    var material = library.LoadMaterial(filePath);
                    if (material != null)
                    {
                        StartMaterialPasteMode(material, filePath);
                    }
                    else
                    {
                        MessageBox.Show("ç„¡æ³•è¼‰å…¥ç´ æ", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"è¼‰å…¥ç´ æå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // ç´ æé¢æ¿ - å³éµé¸å–®
        private void lvMaterials_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            if (lvMaterials.SelectedItems.Count == 0)
                return;

            var item = lvMaterials.SelectedItems[0];
            if (!(item.Tag is string filePath))
                return;

            var menu = new ContextMenuStrip();

            // æŸ¥çœ‹è©³æƒ…
            var detailItem = new ToolStripMenuItem("æŸ¥çœ‹è©³æƒ…...");
            detailItem.Click += (s, ev) => ShowMaterialDetails(filePath);
            menu.Items.Add(detailItem);

            // ä½¿ç”¨ç´ æ
            var useItem = new ToolStripMenuItem("ä½¿ç”¨ç´ æ");
            useItem.Click += (s, ev) =>
            {
                try
                {
                    var library = new L1MapViewer.Helper.MaterialLibrary();
                    var material = library.LoadMaterial(filePath);
                    if (material != null)
                    {
                        StartMaterialPasteMode(material, filePath);
                    }
                }
                catch { }
            };
            menu.Items.Add(useItem);

            menu.Items.Add(new ToolStripSeparator());

            // é‡æ–°å‘½å
            var renameItem = new ToolStripMenuItem("é‡æ–°å‘½å...");
            renameItem.Click += (s, ev) => RenameMaterial(filePath, item);
            menu.Items.Add(renameItem);

            // è¤‡è£½æª”æ¡ˆè·¯å¾‘
            var copyPathItem = new ToolStripMenuItem("è¤‡è£½æª”æ¡ˆè·¯å¾‘");
            copyPathItem.Click += (s, ev) =>
            {
                Clipboard.SetText(filePath);
                toolStripStatusLabel1.Text = "å·²è¤‡è£½è·¯å¾‘åˆ°å‰ªè²¼ç°¿";
            };
            menu.Items.Add(copyPathItem);

            // åŒ¯å‡ºï¼ˆå¦å­˜æ–°æª”ï¼‰
            var exportItem = new ToolStripMenuItem("åŒ¯å‡ºç´ æ...");
            exportItem.Click += (s, ev) => ExportMaterial(filePath);
            menu.Items.Add(exportItem);

            menu.Items.Add(new ToolStripSeparator());

            // åˆªé™¤ç´ æ
            var deleteItem = new ToolStripMenuItem("åˆªé™¤ç´ æ");
            deleteItem.Click += (s, ev) =>
            {
                if (MessageBox.Show($"ç¢ºå®šè¦åˆªé™¤ç´ æ \"{item.Text}\" å—ï¼Ÿ", "ç¢ºèªåˆªé™¤",
                    MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
                {
                    var library = new L1MapViewer.Helper.MaterialLibrary();
                    if (library.DeleteMaterial(filePath))
                    {
                        RefreshMaterialsList();
                        toolStripStatusLabel1.Text = $"å·²åˆªé™¤ç´ æ: {item.Text}";
                    }
                }
            };
            menu.Items.Add(deleteItem);

            menu.Show(lvMaterials, e.Location);
        }

        // æ‹–æ”¾é€²å…¥äº‹ä»¶
        private void lvMaterials_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                string[] files = (string[])e.Data.GetData(DataFormats.FileDrop);
                // æª¢æŸ¥æ˜¯å¦æœ‰ .fs32p æª”æ¡ˆ
                if (files.Any(f => f.EndsWith(".fs32p", StringComparison.OrdinalIgnoreCase)))
                {
                    e.Effect = DragDropEffects.Copy;
                    return;
                }
            }
            e.Effect = DragDropEffects.None;
        }

        // æ‹–æ”¾ç¶“éäº‹ä»¶ï¼ˆå¿…é ˆæŒçºŒè¨­å®š Effect æ‰èƒ½å…è¨±æ”¾ä¸‹ï¼‰
        private void lvMaterials_DragOver(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                string[] files = (string[])e.Data.GetData(DataFormats.FileDrop);
                if (files.Any(f => f.EndsWith(".fs32p", StringComparison.OrdinalIgnoreCase)))
                {
                    e.Effect = DragDropEffects.Copy;
                    return;
                }
            }
            e.Effect = DragDropEffects.None;
        }

        // æ‹–æ”¾æ”¾ä¸‹äº‹ä»¶
        private void lvMaterials_DragDrop(object sender, DragEventArgs e)
        {
            if (!e.Data.GetDataPresent(DataFormats.FileDrop))
                return;

            string[] files = (string[])e.Data.GetData(DataFormats.FileDrop);
            var library = new L1MapViewer.Helper.MaterialLibrary();
            int imported = 0;

            foreach (var file in files)
            {
                if (!file.EndsWith(".fs32p", StringComparison.OrdinalIgnoreCase))
                    continue;

                try
                {
                    // é©—è­‰æª”æ¡ˆ
                    if (!L1MapViewer.CLI.Fs3pParser.IsValidFs3pFile(file))
                    {
                        MessageBox.Show($"ç„¡æ•ˆçš„ç´ ææª”æ¡ˆ: {Path.GetFileName(file)}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        continue;
                    }

                    // åŠ åˆ°æœ€è¿‘ä½¿ç”¨
                    library.AddToRecent(file);
                    imported++;
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"åŒ¯å…¥å¤±æ•—: {Path.GetFileName(file)}\n{ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }

            if (imported > 0)
            {
                RefreshMaterialsList();
                toolStripStatusLabel1.Text = $"å·²åŒ¯å…¥ {imported} å€‹ç´ æ";
            }
        }

        // åŒ¯å…¥ç´ æé¸å–®é»æ“Šäº‹ä»¶
        private void importMaterialToolStripMenuItem_Click(object sender, EventArgs e)
        {
            using (var ofd = new OpenFileDialog())
            {
                ofd.Filter = "ç´ ææª”æ¡ˆ|*.fs32p|æ‰€æœ‰æª”æ¡ˆ|*.*";
                ofd.Title = "åŒ¯å…¥ç´ æ";
                ofd.Multiselect = true;

                if (ofd.ShowDialog() != DialogResult.OK)
                    return;

                var library = new L1MapViewer.Helper.MaterialLibrary();
                int imported = 0;

                foreach (var file in ofd.FileNames)
                {
                    try
                    {
                        if (!L1MapViewer.CLI.Fs3pParser.IsValidFs3pFile(file))
                        {
                            MessageBox.Show($"ç„¡æ•ˆçš„ç´ ææª”æ¡ˆ: {Path.GetFileName(file)}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            continue;
                        }

                        library.AddToRecent(file);
                        imported++;
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"åŒ¯å…¥å¤±æ•—: {Path.GetFileName(file)}\n{ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }

                if (imported > 0)
                {
                    RefreshMaterialsList();
                    toolStripStatusLabel1.Text = $"å·²åŒ¯å…¥ {imported} å€‹ç´ æ";
                }
            }
        }

        // åŒ¯å…¥åœ°åœ–åŒ…åˆ°æ–°åœ°åœ–é¸å–®é»æ“Šäº‹ä»¶
        private void importFs32ToNewMapToolStripMenuItem_Click(object sender, EventArgs e)
        {
            // æª¢æŸ¥æ˜¯å¦å·²é–‹å•Ÿå¤©å ‚å®¢æˆ¶ç«¯
            if (string.IsNullOrEmpty(Share.LineagePath) || !Directory.Exists(Share.LineagePath))
            {
                MessageBox.Show(
                    LocalizationManager.L("ImportNewMap_PleaseOpenClient"),
                    LocalizationManager.L("ImportNewMap_Title"),
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);
                return;
            }

            // é¸æ“‡ fs32 æª”æ¡ˆ
            using (var openDialog = new OpenFileDialog())
            {
                openDialog.Filter = "FS32 åœ°åœ–åŒ…|*.fs32|æ‰€æœ‰æª”æ¡ˆ|*.*";
                openDialog.Title = LocalizationManager.L("ImportNewMap_SelectFile");

                if (openDialog.ShowDialog() != DialogResult.OK)
                    return;

                string fs32FilePath = openDialog.FileName;

                // è¼¸å…¥åœ°åœ–ç·¨è™Ÿ
                string mapIdInput = ShowInputDialog(
                    LocalizationManager.L("ImportNewMap_Title"),
                    LocalizationManager.L("ImportNewMap_EnterMapId"),
                    "");

                if (string.IsNullOrWhiteSpace(mapIdInput))
                    return;

                // é©—è­‰åœ°åœ–ç·¨è™Ÿæ˜¯å¦ç‚ºæ•¸å­—
                if (!int.TryParse(mapIdInput.Trim(), out int mapIdNumber))
                {
                    MessageBox.Show(
                        LocalizationManager.L("ImportNewMap_InvalidMapId"),
                        LocalizationManager.L("ImportNewMap_Title"),
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning);
                    return;
                }

                string mapId = mapIdNumber.ToString();
                string mapPath = Path.Combine(Share.LineagePath, "map", mapId);

                // æª¢æŸ¥åœ°åœ–è³‡æ–™å¤¾æ˜¯å¦å·²å­˜åœ¨
                if (Directory.Exists(mapPath))
                {
                    // åœ°åœ–å·²å­˜åœ¨ï¼Œè©¢å•æ˜¯å¦ä½¿ç”¨æ—¢æœ‰åŒ¯å…¥æµç¨‹
                    var result = MessageBox.Show(
                        string.Format(LocalizationManager.L("ImportNewMap_MapExists"), mapId),
                        LocalizationManager.L("ImportNewMap_Title"),
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Question);

                    if (result == DialogResult.Yes)
                    {
                        // ä½¿ç”¨æ—¢æœ‰åŒ¯å…¥æµç¨‹ï¼šå…ˆåˆ‡æ›åˆ°è©²åœ°åœ–ï¼Œå†åŸ·è¡ŒåŒ¯å…¥
                        SwitchToMapAndImportFs32(mapId, fs32FilePath);
                    }
                    return;
                }

                // å»ºç«‹æ–°åœ°åœ–è³‡æ–™å¤¾ä¸¦åŒ¯å…¥
                try
                {
                    toolStripStatusLabel1.Text = LocalizationManager.L("ImportNewMap_CreatingFolder");
                    Application.DoEvents();

                    // å»ºç«‹åœ°åœ–è³‡æ–™å¤¾
                    Directory.CreateDirectory(mapPath);

                    toolStripStatusLabel1.Text = LocalizationManager.L("ImportNewMap_Importing");
                    Application.DoEvents();

                    // è¼‰å…¥ fs32
                    var fs32 = Fs32Parser.ParseFile(fs32FilePath);
                    if (fs32 == null || fs32.Blocks.Count == 0)
                    {
                        // åˆªé™¤å‰›å»ºç«‹çš„ç©ºè³‡æ–™å¤¾
                        try { Directory.Delete(mapPath); } catch { }
                        MessageBox.Show("ç„¡æ•ˆçš„ fs32 æª”æ¡ˆæˆ–ä¸åŒ…å«ä»»ä½•å€å¡Š", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    // è™•ç† Tilesï¼ˆå¦‚æœæœ‰ï¼‰
                    TileMappingResult tileMapping = null;
                    if (fs32.Tiles.Count > 0)
                    {
                        tileMapping = ProcessFs32Tiles(fs32);
                        if (tileMapping == null)
                        {
                            // ç”¨æˆ¶å–æ¶ˆï¼Œåˆªé™¤è³‡æ–™å¤¾
                            try { Directory.Delete(mapPath); } catch { }
                            return;
                        }
                    }

                    // ç›´æ¥å¯«å…¥ S32 å€å¡Šï¼ˆå› ç‚ºæ˜¯æ–°åœ°åœ–ï¼Œä¸éœ€è¦è¨ˆç®— MapInfoï¼‰
                    int importedCount = 0;
                    var errors = new List<string>();

                    foreach (var block in fs32.Blocks)
                    {
                        try
                        {
                            if (block.S32Data == null || block.S32Data.Length == 0)
                            {
                                continue;
                            }

                            // è§£æ S32 è³‡æ–™
                            var s32Data = S32Parser.Parse(block.S32Data);
                            if (s32Data == null)
                            {
                                errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: è§£æå¤±æ•—");
                                continue;
                            }

                            // æ‡‰ç”¨ TileId æ˜ å°„
                            if (tileMapping != null && tileMapping.IdMapping.Count > 0)
                            {
                                ApplyTileMappingToS32(s32Data, tileMapping);
                            }

                            // å¯«å…¥ S32 æª”æ¡ˆ
                            string s32FileName = $"{block.BlockX:X4}{block.BlockY:X4}.s32";
                            string s32FilePath = Path.Combine(mapPath, s32FileName);
                            S32Writer.Write(s32Data, s32FilePath);
                            importedCount++;
                        }
                        catch (Exception ex)
                        {
                            errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: {ex.Message}");
                        }
                    }

                    // é¡¯ç¤ºçµæœ
                    string resultMessage = string.Format(LocalizationManager.L("ImportNewMap_Success"), mapId) +
                                           $"\n\nåŒ¯å…¥ {importedCount} å€‹å€å¡Š";
                    if (fs32.Tiles.Count > 0)
                    {
                        resultMessage += $", {fs32.Tiles.Count} å€‹åœ–å¡Š";
                    }
                    if (errors.Count > 0)
                    {
                        resultMessage += $"\n\nâš ï¸ {errors.Count} å€‹å€å¡Šç™¼ç”ŸéŒ¯èª¤";
                    }

                    MessageBox.Show(resultMessage, LocalizationManager.L("ImportNewMap_Title"),
                        MessageBoxButtons.OK, MessageBoxIcon.Information);

                    toolStripStatusLabel1.Text = string.Format(LocalizationManager.L("ImportNewMap_Success"), mapId);

                    // é‡æ–°è¼‰å…¥åœ°åœ–åˆ—è¡¨
                    if (!string.IsNullOrEmpty(Share.LineagePath))
                    {
                        LoadMap(Share.LineagePath);
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show(
                        string.Format(LocalizationManager.L("ImportNewMap_Failed"), ex.Message),
                        LocalizationManager.L("ImportNewMap_Title"),
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Error);
                }
            }
        }

        // åˆ‡æ›åˆ°æŒ‡å®šåœ°åœ–ä¸¦åŒ¯å…¥ fs32
        private void SwitchToMapAndImportFs32(string mapId, string fs32FilePath)
        {
            // å…ˆåˆ‡æ›åˆ°è©²åœ°åœ–
            for (int i = 0; i < lstMaps.Items.Count; i++)
            {
                string itemText = lstMaps.Items[i].ToString();
                string itemMapId = itemText.Contains("-") ? itemText.Split('-')[0].Trim() : itemText;

                if (itemMapId == mapId)
                {
                    lstMaps.SelectedIndex = i;
                    Application.DoEvents();

                    // ç­‰å¾…åœ°åœ–è¼‰å…¥å®Œæˆ
                    System.Threading.Thread.Sleep(500);
                    Application.DoEvents();

                    // åŸ·è¡ŒåŒ¯å…¥
                    ImportFs32ToCurrentMapWithFile(fs32FilePath);
                    return;
                }
            }

            // å¦‚æœåœ¨åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç›´æ¥è¨­å®š MapId
            MessageBox.Show($"æ‰¾ä¸åˆ°åœ°åœ– {mapId}ï¼Œè«‹æ‰‹å‹•é¸æ“‡åœ°åœ–å¾Œå†åŒ¯å…¥",
                LocalizationManager.L("ImportNewMap_Title"),
                MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // ä½¿ç”¨æŒ‡å®šæª”æ¡ˆåŒ¯å…¥ fs32 åˆ°ç•¶å‰åœ°åœ–
        private void ImportFs32ToCurrentMapWithFile(string fs32FilePath)
        {
            if (string.IsNullOrEmpty(_document.MapId))
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            string mapPath = Path.Combine(Share.LineagePath, "Map", _document.MapId);

            try
            {
                // 1. è¼‰å…¥ fs32
                toolStripStatusLabel1.Text = "æ­£åœ¨è¼‰å…¥ fs32...";
                Application.DoEvents();

                var fs32 = Fs32Parser.ParseFile(fs32FilePath);
                if (fs32 == null || fs32.Blocks.Count == 0)
                {
                    MessageBox.Show("ç„¡æ•ˆçš„ fs32 æª”æ¡ˆæˆ–ä¸åŒ…å«ä»»ä½•å€å¡Š", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // 2. é¡¯ç¤ºåŒ¯å…¥è³‡è¨Šä¸¦é¸æ“‡åŒ¯å…¥æ¨¡å¼
                string infoMessage = $"fs32 åœ°åœ–åŒ…è³‡è¨Šï¼š\n\n" +
                                     $"â€¢ ä¾†æºåœ°åœ–: {fs32.SourceMapId}\n" +
                                     $"â€¢ å€å¡Šæ•¸é‡: {fs32.Blocks.Count}\n" +
                                     $"â€¢ åœ–å¡Šæ•¸é‡: {fs32.Tiles.Count}\n\n" +
                                     $"å°‡åŒ¯å…¥è‡³ç•¶å‰åœ°åœ–: {_document.MapId}";

                var importModeResult = ShowImportModeDialog(infoMessage);

                if (importModeResult == null)
                    return;

                bool isFullReplace = importModeResult.Value;

                // å…¨éƒ¨å–ä»£éœ€è¦äºŒæ¬¡ç¢ºèª
                if (isFullReplace)
                {
                    var warningResult = MessageBox.Show(
                        "âš ï¸ è­¦å‘Šï¼šå…¨éƒ¨å–ä»£æ¨¡å¼ âš ï¸\n\n" +
                        "é€™å°‡æœƒåˆªé™¤ç•¶å‰åœ°åœ–çš„æ‰€æœ‰æ—¢æœ‰å€å¡Šï¼\n" +
                        "æ•´å¼µåœ°åœ–å¯èƒ½æœƒæ¶ˆå¤±ï¼Œåªå‰©ä¸‹åŒ¯å…¥çš„å€å¡Šã€‚\n\n" +
                        "æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\n" +
                        "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ",
                        "å±éšªæ“ä½œç¢ºèª",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning,
                        MessageBoxDefaultButton.Button2);

                    if (warningResult != DialogResult.Yes)
                        return;
                }

                // 3. è™•ç† Tilesï¼ˆå¦‚æœæœ‰ï¼‰
                TileMappingResult tileMapping = null;
                if (fs32.Tiles.Count > 0)
                {
                    tileMapping = ProcessFs32Tiles(fs32);
                    if (tileMapping == null)
                        return;
                }

                // 4. å…¨éƒ¨å–ä»£æ¨¡å¼ï¼šåˆªé™¤æ—¢æœ‰ S32 æª”æ¡ˆ
                if (isFullReplace)
                {
                    toolStripStatusLabel1.Text = "æ­£åœ¨åˆªé™¤æ—¢æœ‰å€å¡Š...";
                    Application.DoEvents();

                    var existingS32Files = Directory.GetFiles(mapPath, "*.s32");
                    foreach (var file in existingS32Files)
                    {
                        try { File.Delete(file); } catch { }
                    }
                }

                // 5. è§£æä¸¦å¯«å…¥ S32 å€å¡Š
                toolStripStatusLabel1.Text = "æ­£åœ¨åŒ¯å…¥å€å¡Š...";
                Application.DoEvents();

                int importedCount = 0;
                var errors = new List<string>();

                // å–å¾— MapInfo
                int mapMinBlockX = 0x7FFF;
                int mapMinBlockY = 0x7FFF;
                int mapBlockCountX = 1;

                if (_document.MapInfo != null)
                {
                    mapMinBlockX = _document.MapInfo.nMinBlockX;
                    mapMinBlockY = _document.MapInfo.nMinBlockY;
                    mapBlockCountX = _document.MapInfo.nBlockCountX;
                }
                else if (_document.S32Files.Count > 0)
                {
                    var firstS32 = _document.S32Files.Values.First();
                    if (firstS32.SegInfo != null)
                    {
                        mapMinBlockX = firstS32.SegInfo.nMapMinBlockX;
                        mapMinBlockY = firstS32.SegInfo.nMapMinBlockY;
                        mapBlockCountX = firstS32.SegInfo.nMapBlockCountX;
                    }
                }

                foreach (var block in fs32.Blocks)
                {
                    try
                    {
                        if (block.S32Data == null || block.S32Data.Length == 0)
                            continue;

                        var s32Data = S32Parser.Parse(block.S32Data);
                        if (s32Data == null)
                        {
                            errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: è§£æå¤±æ•—");
                            continue;
                        }

                        // æ›´æ–° SegInfo
                        if (s32Data.SegInfo != null)
                        {
                            s32Data.SegInfo.nMapMinBlockX = mapMinBlockX;
                            s32Data.SegInfo.nMapMinBlockY = mapMinBlockY;
                            s32Data.SegInfo.nMapBlockCountX = mapBlockCountX;
                        }

                        // æ‡‰ç”¨ TileId æ˜ å°„
                        if (tileMapping != null && tileMapping.IdMapping.Count > 0)
                        {
                            ApplyTileMappingToS32(s32Data, tileMapping);
                        }

                        string s32FileName = $"{block.BlockX:X4}{block.BlockY:X4}.s32";
                        string s32FilePath = Path.Combine(mapPath, s32FileName);
                        S32Writer.Write(s32Data, s32FilePath);
                        importedCount++;
                    }
                    catch (Exception ex)
                    {
                        errors.Add($"å€å¡Š {block.BlockX:X4}{block.BlockY:X4}: {ex.Message}");
                    }
                }

                // 6. é‡æ–°è¼‰å…¥åœ°åœ–
                ReloadCurrentMap();

                // 7. é¡¯ç¤ºçµæœ
                string resultMessage = $"åŒ¯å…¥å®Œæˆï¼\n\n" +
                                       $"æˆåŠŸåŒ¯å…¥ {importedCount} å€‹å€å¡Š";
                if (fs32.Tiles.Count > 0)
                    resultMessage += $"\nè™•ç† {fs32.Tiles.Count} å€‹åœ–å¡Š";
                if (errors.Count > 0)
                    resultMessage += $"\n\nâš ï¸ {errors.Count} å€‹å€å¡Šç™¼ç”ŸéŒ¯èª¤";

                MessageBox.Show(resultMessage, "åŒ¯å…¥å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                toolStripStatusLabel1.Text = $"å·²åŒ¯å…¥ {importedCount} å€‹å€å¡Š";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"åŒ¯å…¥å¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // é‡æ–°å‘½åç´ æ
        private void RenameMaterial(string filePath, ListViewItem listItem)
        {
            try
            {
                var material = L1MapViewer.CLI.Fs3pParser.ParseFile(filePath);
                if (material == null)
                {
                    MessageBox.Show("ç„¡æ³•è¼‰å…¥ç´ æ", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                string currentName = material.Name ?? "æœªå‘½å";
                string newName = ShowInputDialog("é‡æ–°å‘½åç´ æ", "è«‹è¼¸å…¥æ–°çš„ç´ æåç¨±:", currentName);

                if (string.IsNullOrWhiteSpace(newName) || newName == currentName)
                    return;

                // æ›´æ–°ç´ æåç¨±
                material.Name = newName;

                // é‡æ–°å¯«å…¥æª”æ¡ˆ
                L1MapViewer.CLI.Fs3pWriter.Write(material, filePath);

                // æ›´æ–°åˆ—è¡¨é¡¯ç¤º
                listItem.Text = newName;
                toolStripStatusLabel1.Text = $"ç´ æå·²é‡æ–°å‘½åç‚º: {newName}";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"é‡æ–°å‘½åå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ç°¡æ˜“è¼¸å…¥å°è©±æ¡†
        private string ShowInputDialog(string title, string prompt, string defaultValue)
        {
            using (var form = new Form())
            {
                form.Text = title;
                form.Size = new Size(350, 150);
                form.FormBorderStyle = FormBorderStyle.FixedDialog;
                form.StartPosition = FormStartPosition.CenterParent;
                form.MaximizeBox = false;
                form.MinimizeBox = false;

                var label = new Label { Text = prompt, Left = 10, Top = 15, Width = 310 };
                var textBox = new TextBox { Text = defaultValue, Left = 10, Top = 40, Width = 310 };
                var okButton = new Button { Text = "ç¢ºå®š", Left = 150, Top = 75, Width = 80, DialogResult = DialogResult.OK };
                var cancelButton = new Button { Text = "å–æ¶ˆ", Left = 240, Top = 75, Width = 80, DialogResult = DialogResult.Cancel };

                form.Controls.AddRange(new Control[] { label, textBox, okButton, cancelButton });
                form.AcceptButton = okButton;
                form.CancelButton = cancelButton;

                return form.ShowDialog() == DialogResult.OK ? textBox.Text : defaultValue;
            }
        }

        // åŒ¯å…¥æ¨¡å¼é¸æ“‡å°è©±æ¡† (è¿”å› true=å…¨éƒ¨å–ä»£, false=éƒ¨ä»½å–ä»£, null=å–æ¶ˆ)
        private bool? ShowImportModeDialog(string infoMessage)
        {
            using (var form = new Form())
            {
                form.Text = "é¸æ“‡åŒ¯å…¥æ¨¡å¼";
                form.Size = new Size(420, 220);
                form.FormBorderStyle = FormBorderStyle.FixedDialog;
                form.StartPosition = FormStartPosition.CenterParent;
                form.MaximizeBox = false;
                form.MinimizeBox = false;

                var lblInfo = new Label
                {
                    Text = infoMessage,
                    Location = new Point(15, 15),
                    Size = new Size(380, 100),
                    AutoSize = false
                };
                form.Controls.Add(lblInfo);

                var btnPartial = new Button
                {
                    Text = "éƒ¨ä»½å–ä»£ï¼ˆæ¨è–¦ï¼‰",
                    Location = new Point(30, 130),
                    Size = new Size(140, 35),
                    DialogResult = DialogResult.Yes
                };
                form.Controls.Add(btnPartial);

                var btnFull = new Button
                {
                    Text = "å…¨éƒ¨å–ä»£",
                    Location = new Point(180, 130),
                    Size = new Size(100, 35),
                    DialogResult = DialogResult.No
                };
                form.Controls.Add(btnFull);

                var btnCancel = new Button
                {
                    Text = "å–æ¶ˆ",
                    Location = new Point(290, 130),
                    Size = new Size(80, 35),
                    DialogResult = DialogResult.Cancel
                };
                form.Controls.Add(btnCancel);

                form.AcceptButton = btnPartial;
                form.CancelButton = btnCancel;

                var result = form.ShowDialog();
                if (result == DialogResult.Cancel)
                    return null;
                return result == DialogResult.No; // No = å…¨éƒ¨å–ä»£
            }
        }

        // åŒ¯å‡ºç´ æ
        private void ExportMaterial(string filePath)
        {
            try
            {
                using (var sfd = new SaveFileDialog())
                {
                    sfd.Filter = "ç´ ææª”æ¡ˆ|*.fs32p";
                    sfd.Title = "åŒ¯å‡ºç´ æ";
                    sfd.FileName = Path.GetFileName(filePath);

                    if (sfd.ShowDialog() == DialogResult.OK)
                    {
                        File.Copy(filePath, sfd.FileName, true);
                        toolStripStatusLabel1.Text = $"ç´ æå·²åŒ¯å‡ºè‡³: {sfd.FileName}";
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Export] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // é¡¯ç¤ºç´ æè©³ç´°è³‡æ–™
        private void ShowMaterialDetails(string filePath)
        {
            try
            {
                var material = L1MapViewer.CLI.Fs3pParser.ParseFile(filePath);
                if (material == null)
                {
                    MessageBox.Show("ç„¡æ³•è¼‰å…¥ç´ æ", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                var sb = new System.Text.StringBuilder();
                sb.AppendLine($"ç´ æåç¨±: {material.Name}");
                sb.AppendLine($"æª”æ¡ˆè·¯å¾‘: {filePath}");
                sb.AppendLine();
                sb.AppendLine($"å°ºå¯¸: {material.Width} x {material.Height}");
                sb.AppendLine($"åŸé»åç§»: ({material.OriginOffsetX}, {material.OriginOffsetY})");
                sb.AppendLine();

                // Layer è³‡è¨Š
                sb.AppendLine("=== åœ–å±¤è³‡æ–™ ===");
                if (material.HasLayer1)
                    sb.AppendLine($"Layer1 (åœ°æ¿): {material.Layer1Items.Count} é …");
                if (material.HasLayer2)
                    sb.AppendLine($"Layer2 (è£é£¾): {material.Layer2Items.Count} é …");
                if (material.HasLayer3)
                    sb.AppendLine($"Layer3 (å±¬æ€§): {material.Layer3Items.Count} é …");
                if (material.HasLayer4)
                    sb.AppendLine($"Layer4 (ç‰©ä»¶): {material.Layer4Items.Count} é …");

                if (!material.HasLayer1 && !material.HasLayer2 && !material.HasLayer3 && !material.HasLayer4)
                    sb.AppendLine("(ç„¡åœ–å±¤è³‡æ–™)");

                sb.AppendLine();

                // Tile è³‡è¨Š
                sb.AppendLine("=== Tile è³‡æ–™ ===");
                if (material.Tiles.Count > 0)
                {
                    sb.AppendLine($"åŒ…å« {material.Tiles.Count} å€‹ Tiles:");
                    foreach (var tile in material.Tiles.OrderBy(t => t.Key))
                    {
                        sb.AppendLine($"  - Tile {tile.Key} ({tile.Value.TilData?.Length ?? 0} bytes)");
                    }
                }
                else
                {
                    sb.AppendLine("(æœªåŒ…å« Tile è³‡æ–™)");
                }

                sb.AppendLine();

                // ä½¿ç”¨çš„ TileId çµ±è¨ˆ
                var usedTileIds = new HashSet<int>();
                foreach (var item in material.Layer1Items)
                    if (item.TileId > 0) usedTileIds.Add(item.TileId);
                foreach (var item in material.Layer2Items)
                    if (item.TileId > 0) usedTileIds.Add(item.TileId);
                foreach (var item in material.Layer4Items)
                    if (item.TileId > 0) usedTileIds.Add(item.TileId);

                if (usedTileIds.Count > 0)
                {
                    sb.AppendLine($"=== ä½¿ç”¨çš„ TileId ({usedTileIds.Count} å€‹) ===");
                    var sortedIds = usedTileIds.OrderBy(x => x).ToList();
                    for (int i = 0; i < sortedIds.Count; i += 10)
                    {
                        var batch = sortedIds.Skip(i).Take(10);
                        sb.AppendLine(string.Join(", ", batch));
                    }
                }

                // Metadata
                sb.AppendLine();
                sb.AppendLine("=== ä¸­ç¹¼è³‡æ–™ ===");
                if (material.CreatedTime > 0)
                {
                    var created = DateTimeOffset.FromUnixTimeSeconds(material.CreatedTime).LocalDateTime;
                    sb.AppendLine($"å»ºç«‹æ™‚é–“: {created:yyyy-MM-dd HH:mm:ss}");
                }
                if (material.ModifiedTime > 0)
                {
                    var modified = DateTimeOffset.FromUnixTimeSeconds(material.ModifiedTime).LocalDateTime;
                    sb.AppendLine($"ä¿®æ”¹æ™‚é–“: {modified:yyyy-MM-dd HH:mm:ss}");
                }
                if (material.Tags.Count > 0)
                {
                    sb.AppendLine($"æ¨™ç±¤: {string.Join(", ", material.Tags)}");
                }

                // ä½¿ç”¨å¯è¤‡è£½çš„å°è©±æ¡†
                using (var detailForm = new Form())
                {
                    detailForm.Text = $"ç´ æè©³æƒ… - {material.Name}";
                    detailForm.Size = new Size(500, 450);
                    detailForm.StartPosition = FormStartPosition.CenterParent;
                    detailForm.FormBorderStyle = FormBorderStyle.Sizable;
                    detailForm.MinimumSize = new Size(400, 300);

                    var textBox = new TextBox
                    {
                        Multiline = true,
                        ReadOnly = true,
                        ScrollBars = ScrollBars.Both,
                        Dock = DockStyle.Fill,
                        Font = new Font("Consolas", 9),
                        Text = sb.ToString(),
                        SelectionStart = 0,
                        SelectionLength = 0
                    };

                    var btnPanel = new Panel
                    {
                        Dock = DockStyle.Bottom,
                        Height = 40
                    };

                    var btnCopy = new Button
                    {
                        Text = "è¤‡è£½å…¨éƒ¨",
                        Size = new Size(80, 28),
                        Location = new Point(10, 6)
                    };
                    btnCopy.Click += (s, ev) =>
                    {
                        Clipboard.SetText(sb.ToString());
                        toolStripStatusLabel1.Text = "å·²è¤‡è£½ç´ æè©³æƒ…åˆ°å‰ªè²¼ç°¿";
                    };

                    var btnClose = new Button
                    {
                        Text = "é—œé–‰",
                        Size = new Size(80, 28),
                        Location = new Point(100, 6),
                        DialogResult = DialogResult.OK
                    };

                    btnPanel.Controls.Add(btnCopy);
                    btnPanel.Controls.Add(btnClose);
                    detailForm.Controls.Add(textBox);
                    detailForm.Controls.Add(btnPanel);
                    detailForm.AcceptButton = btnClose;

                    detailForm.ShowDialog();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"è®€å–ç´ æå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ç´ æé¢æ¿ - æ›´å¤šæŒ‰éˆ•
        private void btnMoreMaterials_Click(object sender, EventArgs e)
        {
            using (var browser = new L1MapViewer.Forms.MaterialBrowserForm())
            {
                if (browser.ShowDialog() == DialogResult.OK && browser.SelectedMaterial != null)
                {
                    // é€²å…¥ç´ æè²¼ä¸Šé è¦½æ¨¡å¼
                    StartMaterialPasteMode(browser.SelectedMaterial, browser.SelectedFilePath);
                }
            }
        }

        // åœ¨æŒ‡å®šä½ç½®è²¼ä¸Šç´ æ
        private void PasteMaterialAtPosition(int gameX, int gameY)
        {
            if (_pendingMaterial == null)
                return;

            try
            {
                var material = _pendingMaterial;

                // è¨ˆç®—è²¼ä¸ŠåŸé»ï¼ˆLayer1 åº§æ¨™ï¼‰- é»æ“Šä½ç½®ç‚ºç´ æåº•éƒ¨
                int pasteOriginX = gameX * 2;
                int pasteOriginY = gameY;

                // æª¢æŸ¥ä¸¦ä¿®æ­£ RelativeX/Y åç§»ï¼ˆèˆŠç´ æå¯èƒ½æ²’æœ‰æ­£è¦åŒ–ï¼‰
                // è¨ˆç®—æ‰€æœ‰åœ–å±¤çš„ RelativeX/Y ç¯„åœ
                int minRelX = int.MaxValue;
                int minRelY = int.MaxValue;
                int maxRelY = int.MinValue;

                foreach (var item in material.Layer1Items)
                {
                    if (item.RelativeX < minRelX) minRelX = item.RelativeX;
                    if (item.RelativeY < minRelY) minRelY = item.RelativeY;
                    if (item.RelativeY > maxRelY) maxRelY = item.RelativeY;
                }
                foreach (var item in material.Layer2Items)
                {
                    if (item.RelativeX < minRelX) minRelX = item.RelativeX;
                    if (item.RelativeY < minRelY) minRelY = item.RelativeY;
                    if (item.RelativeY > maxRelY) maxRelY = item.RelativeY;
                }
                foreach (var item in material.Layer3Items)
                {
                    // Layer3 ä½¿ç”¨ä¸åŒåº§æ¨™ç³»çµ±ï¼Œæš«æ™‚è·³é
                }
                foreach (var item in material.Layer4Items)
                {
                    if (item.RelativeX < minRelX) minRelX = item.RelativeX;
                    if (item.RelativeY < minRelY) minRelY = item.RelativeY;
                    if (item.RelativeY > maxRelY) maxRelY = item.RelativeY;
                }

                // å¦‚æœæ²’æœ‰ä»»ä½•é …ç›®ï¼Œè¨­ç‚º 0
                if (minRelX == int.MaxValue) minRelX = 0;
                if (minRelY == int.MaxValue) minRelY = 0;
                if (maxRelY == int.MinValue) maxRelY = 0;

                // åç§»ä¿®æ­£å€¼ - ä½¿ç”¨ maxRelY ä½œç‚ºåŸºæº–é»ï¼ˆç´ æåº•éƒ¨å°é½Šé»æ“Šä½ç½®ï¼‰
                int offsetFixX = minRelX;
                int offsetFixY = maxRelY;

                int layer1Count = 0, layer2Count = 0, layer3Count = 0, layer4Count = 0;
                int skippedCount = 0;

                // å»ºç«‹ Undo è¨˜éŒ„
                var undoAction = new UndoAction
                {
                    Description = $"è²¼ä¸Šç´ æ {material.Name}"
                };

                // è²¼ä¸Š Layer1 è³‡æ–™ï¼ˆåœ°æ¿ï¼‰
                if (material.HasLayer1)
                {
                    foreach (var item in material.Layer1Items)
                    {
                        // å¥—ç”¨åç§»ä¿®æ­£
                        int targetGlobalX = pasteOriginX + item.RelativeX - offsetFixX;
                        int targetGlobalY = pasteOriginY + item.RelativeY - offsetFixY;
                        int targetGameX = targetGlobalX / 2;
                        int targetGameY = targetGlobalY;

                        S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                        if (targetS32 == null)
                        {
                            skippedCount++;
                            continue;
                        }

                        int localX = targetGlobalX - targetS32.SegInfo.nLinBeginX * 2;
                        int localY = targetGlobalY - targetS32.SegInfo.nLinBeginY;

                        if (localX < 0 || localX >= 128 || localY < 0 || localY >= 64)
                        {
                            skippedCount++;
                            continue;
                        }

                        var oldCell = targetS32.Layer1[localY, localX];
                        undoAction.ModifiedLayer1.Add(new UndoLayer1Info
                        {
                            S32FilePath = targetS32.FilePath,
                            LocalX = localX,
                            LocalY = localY,
                            OldTileId = oldCell?.TileId ?? 0,
                            OldIndexId = oldCell?.IndexId ?? 0,
                            NewTileId = item.TileId,
                            NewIndexId = item.IndexId
                        });

                        targetS32.Layer1[localY, localX] = new TileCell
                        {
                            X = localX,
                            Y = localY,
                            TileId = item.TileId,
                            IndexId = item.IndexId
                        };
                        if (item.TileId > 0) layer1Count++;
                        targetS32.IsModified = true;
                    }
                }

                // è²¼ä¸Š Layer3 è³‡æ–™ï¼ˆå±¬æ€§ï¼‰
                if (material.HasLayer3)
                {
                    foreach (var item in material.Layer3Items)
                    {
                        int targetGlobalX = pasteOriginX + item.RelativeX * 2;  // Layer3 æ˜¯éŠæˆ²åº§æ¨™
                        int targetGlobalY = pasteOriginY + item.RelativeY;
                        int targetGameX = targetGlobalX / 2;
                        int targetGameY = targetGlobalY;

                        S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                        if (targetS32 == null)
                        {
                            skippedCount++;
                            continue;
                        }

                        int layer3X = targetGameX - targetS32.SegInfo.nLinBeginX;
                        int localY = targetGameY - targetS32.SegInfo.nLinBeginY;

                        if (layer3X < 0 || layer3X >= 64 || localY < 0 || localY >= 64)
                        {
                            skippedCount++;
                            continue;
                        }

                        var oldAttr = targetS32.Layer3[localY, layer3X];
                        undoAction.ModifiedLayer3.Add(new UndoLayer3Info
                        {
                            S32FilePath = targetS32.FilePath,
                            LocalX = layer3X,
                            LocalY = localY,
                            OldAttribute1 = oldAttr?.Attribute1 ?? 0,
                            OldAttribute2 = oldAttr?.Attribute2 ?? 0,
                            NewAttribute1 = item.Attribute1,
                            NewAttribute2 = item.Attribute2
                        });

                        targetS32.Layer3[localY, layer3X] = new MapAttribute
                        {
                            Attribute1 = item.Attribute1,
                            Attribute2 = item.Attribute2
                        };
                        layer3Count++;
                        targetS32.IsModified = true;
                    }
                }

                // è¨ˆç®—æ–°çš„ GroupId èµ·å§‹å€¼ï¼ˆLayer4 å’Œ Layer5 å…±ç”¨ï¼‰
                int maxGroupId = 0;
                foreach (var s32 in _document.S32Files.Values)
                {
                    foreach (var obj in s32.Layer4)
                    {
                        if (obj.GroupId > maxGroupId)
                            maxGroupId = obj.GroupId;
                    }
                }
                int baseGroupId = maxGroupId + 1;

                // è²¼ä¸Š Layer4 è³‡æ–™ï¼ˆç‰©ä»¶ï¼‰
                if (material.HasLayer4)
                {
                    foreach (var item in material.Layer4Items)
                    {
                        // å¥—ç”¨åç§»ä¿®æ­£ï¼ˆèˆŠç´ æçš„ RelativeX/Y å¯èƒ½ä¸æ˜¯å¾ 0 é–‹å§‹ï¼‰
                        int targetGlobalX = pasteOriginX + item.RelativeX - offsetFixX;
                        int targetGlobalY = pasteOriginY + item.RelativeY - offsetFixY;
                        int targetGameX = targetGlobalX / 2;
                        int targetGameY = targetGlobalY;

                        S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                        if (targetS32 == null)
                        {
                            skippedCount++;
                            continue;
                        }

                        int objLocalX = targetGlobalX - targetS32.SegInfo.nLinBeginX * 2;
                        int objLocalY = targetGlobalY - targetS32.SegInfo.nLinBeginY;

                        if (objLocalY < 0 || objLocalY >= 64)
                        {
                            skippedCount++;
                            continue;
                        }

                        var newObj = new ObjectTile
                        {
                            GroupId = baseGroupId + item.GroupId,  // é‡æ–°æ˜ å°„ GroupId
                            X = objLocalX,
                            Y = objLocalY,
                            Layer = item.Layer,
                            IndexId = item.IndexId,
                            TileId = item.TileId
                        };
                        targetS32.Layer4.Add(newObj);
                        Layer4Index_Add(targetS32, newObj);
                        layer4Count++;

                        undoAction.AddedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = targetS32.FilePath,
                            GameX = targetS32.SegInfo.nLinBeginX + objLocalX / 2,
                            GameY = targetS32.SegInfo.nLinBeginY + objLocalY,
                            LocalX = newObj.X,
                            LocalY = newObj.Y,
                            GroupId = newObj.GroupId,
                            Layer = newObj.Layer,
                            IndexId = newObj.IndexId,
                            TileId = newObj.TileId
                        });

                        targetS32.IsModified = true;
                    }
                }

                // è²¼ä¸Š Layer5 è³‡æ–™ï¼ˆäº‹ä»¶/é€æ˜åŒ–ï¼‰
                int layer5Count = 0;
                if (material.HasLayer5 && material.Layer5Items.Count > 0)
                {
                    foreach (var item in material.Layer5Items)
                    {
                        // å¥—ç”¨åç§»ä¿®æ­£ï¼ˆèˆ‡ Layer4 ç›¸åŒï¼‰
                        int targetGlobalX = pasteOriginX + item.RelativeX - offsetFixX;
                        int targetGlobalY = pasteOriginY + item.RelativeY - offsetFixY;
                        int targetGameX = targetGlobalX / 2;
                        int targetGameY = targetGlobalY;

                        S32Data targetS32 = GetS32DataByGameCoords(targetGameX, targetGameY);
                        if (targetS32 == null)
                        {
                            continue;
                        }

                        // Layer5 çš„ X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                        int localX = targetGlobalX - targetS32.SegInfo.nLinBeginX * 2;
                        int localY = targetGlobalY - targetS32.SegInfo.nLinBeginY;

                        if (localX < 0 || localX >= 128 || localY < 0 || localY >= 64)
                        {
                            continue;
                        }

                        // è¨ˆç®—æ–°çš„ GroupIdï¼ˆèˆ‡ Layer4 ç›¸åŒæ˜ å°„ï¼‰
                        int newGroupId = baseGroupId + item.GroupId;

                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ Layer5 é …ç›®
                        if (!targetS32.Layer5.Any(l => l.X == localX && l.Y == localY && l.ObjectIndex == newGroupId))
                        {
                            targetS32.Layer5.Add(new Layer5Item
                            {
                                X = (byte)localX,
                                Y = (byte)localY,
                                ObjectIndex = (ushort)newGroupId,
                                Type = item.Type
                            });
                            layer5Count++;
                            targetS32.IsModified = true;
                        }
                    }
                }

                // åŠ å…¥ Undo è¨˜éŒ„
                if (undoAction.ModifiedLayer1.Count > 0 || undoAction.ModifiedLayer3.Count > 0 ||
                    undoAction.AddedObjects.Count > 0)
                {
                    _editState.UndoHistory.Push(undoAction);
                    _editState.RedoHistory.Clear();
                }

                // é‡æ–°æ¸²æŸ“
                RenderS32Map();

                // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
                if (layer5Count > 0)
                {
                    UpdateLayer5InvalidButton();
                }

                // æ›´æ–°ç‹€æ…‹ï¼ˆåŒ…å«åº§æ¨™è³‡è¨Šä»¥ä¾¿åµéŒ¯ï¼‰
                string info = $"å·²è²¼ä¸Šç´ æ: {material.Name} æ–¼ ({gameX}, {gameY})";
                if (layer1Count > 0) info += $", {layer1Count} åœ°æ¿";
                if (layer3Count > 0) info += $", {layer3Count} å±¬æ€§";
                if (layer4Count > 0) info += $", {layer4Count} ç‰©ä»¶";
                if (layer5Count > 0) info += $", {layer5Count} äº‹ä»¶";
                if (skippedCount > 0) info += $" (è·³é {skippedCount})";
                toolStripStatusLabel1.Text = info;

                // çµæŸè²¼ä¸Šæ¨¡å¼
                CancelMaterialPasteMode();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"è²¼ä¸Šç´ æå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // é–‹å§‹ç´ æè²¼ä¸Šé è¦½æ¨¡å¼
        private void StartMaterialPasteMode(Fs3pData material, string filePath)
        {
            // è™•ç†ç´ æä¸­çš„ Tiles - æª¢æŸ¥ MD5 ä¸¦åŒ¯å…¥
            if (material.Tiles != null && material.Tiles.Count > 0)
            {
                var mappingResult = ProcessMaterialTiles(material);
                if (mappingResult == null)
                {
                    // ä½¿ç”¨è€…å–æ¶ˆ
                    return;
                }

                // æ ¹æ“š mapping æ›´æ–°ç´ æä¸­çš„ TileId
                ApplyTileMappingToMaterial(material, mappingResult);
            }

            _pendingMaterial = material;
            _pendingMaterialPath = filePath;

            // æç¤ºç”¨æˆ¶
            toolStripStatusLabel1.Text = $"ç´ æè²¼ä¸Šæ¨¡å¼ï¼šé»æ“Šåœ°åœ–é¸æ“‡è²¼ä¸Šä½ç½®ï¼ŒESC å–æ¶ˆ | {material.Name} ({material.Width}x{material.Height})";

            // æ›´æ–°ç´ æåˆ—è¡¨ä¸¦é«˜äº®é¸ä¸­é …ç›®
            RefreshMaterialsList();
            HighlightPendingMaterial();
        }

        // è™•ç†ç´ æä¸­çš„ Tiles - æª¢æŸ¥ MD5 ä¸¦æ±ºå®šæ˜¯å¦éœ€è¦åŒ¯å…¥
        private TileMappingResult ProcessMaterialTiles(Fs3pData material)
        {
            // å…ˆé€²è¡Œé è¦½åˆ†æ - ä¸å¯¦éš›åŒ¯å…¥
            var previewResult = PreviewTileImport(material.Tiles);

            // å¦‚æœæ‰€æœ‰ tiles éƒ½å¯ä»¥é‡ç”¨ï¼ˆMD5 ä¸€è‡´ï¼‰ï¼Œç›´æ¥è¿”å›
            if (previewResult.NeedImportCount == 0 && previewResult.NeedRemapCount == 0)
            {
                // éœé»˜è™•ç†ï¼Œç›´æ¥ä½¿ç”¨ TileImportManager å»ºç«‹ mappingï¼ˆä¸æœƒå¯¦éš›å¯«å…¥ï¼‰
                var importer = new TileImportManager { StartSearchId = 10000 };
                return BuildMappingWithoutImport(material.Tiles);
            }

            // éœ€è¦åŒ¯å…¥æ–° tilesï¼Œé¡¯ç¤ºå°è©±æ¡†è®“ä½¿ç”¨è€…ç¢ºèª
            string message = $"ç´ æåŒ…å« {material.Tiles.Count} å€‹åœ–å¡Šï¼š\n\n" +
                             $"â€¢ å¯é‡ç”¨ (MD5 ç›¸ç¬¦): {previewResult.ReuseCount} å€‹\n" +
                             $"â€¢ éœ€é‡æ–°ç·¨è™Ÿ (ID è¡çª): {previewResult.NeedRemapCount} å€‹\n" +
                             $"â€¢ éœ€æ–°å¢åŒ¯å…¥: {previewResult.NeedImportCount} å€‹\n\n" +
                             $"è«‹è¼¸å…¥æ–°åœ–å¡Šçš„èµ·å§‹ç·¨è™Ÿ (å°‡å¾æ­¤ç·¨è™Ÿé–‹å§‹å°‹æ‰¾æœªä½¿ç”¨çš„ ID)ï¼š";

            using (var dialog = new Form())
            {
                dialog.Text = "åœ–å¡ŠåŒ¯å…¥è¨­å®š";
                dialog.Size = new Size(420, 220);
                dialog.StartPosition = FormStartPosition.CenterParent;
                dialog.FormBorderStyle = FormBorderStyle.FixedDialog;
                dialog.MaximizeBox = false;
                dialog.MinimizeBox = false;

                var lblMessage = new Label
                {
                    Text = message,
                    Location = new Point(15, 15),
                    Size = new Size(380, 100),
                    AutoSize = false
                };
                dialog.Controls.Add(lblMessage);

                var lblStartId = new Label
                {
                    Text = "èµ·å§‹ç·¨è™Ÿï¼š",
                    Location = new Point(15, 125),
                    Size = new Size(75, 20)
                };
                dialog.Controls.Add(lblStartId);

                var txtStartId = new TextBox
                {
                    Text = "10000",
                    Location = new Point(95, 122),
                    Size = new Size(100, 23)
                };
                dialog.Controls.Add(txtStartId);

                var btnOK = new Button
                {
                    Text = "ç¢ºå®šåŒ¯å…¥",
                    DialogResult = DialogResult.OK,
                    Location = new Point(220, 145),
                    Size = new Size(85, 28)
                };
                dialog.Controls.Add(btnOK);

                var btnCancel = new Button
                {
                    Text = "å–æ¶ˆ",
                    DialogResult = DialogResult.Cancel,
                    Location = new Point(310, 145),
                    Size = new Size(85, 28)
                };
                dialog.Controls.Add(btnCancel);

                dialog.AcceptButton = btnOK;
                dialog.CancelButton = btnCancel;

                if (dialog.ShowDialog() != DialogResult.OK)
                    return null;

                if (!int.TryParse(txtStartId.Text, out int startId) || startId < 1)
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹ç·¨è™Ÿ (å¤§æ–¼ 0)", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return null;
                }

                // å†æ¬¡ç¢ºèª
                int totalNewTiles = previewResult.NeedRemapCount + previewResult.NeedImportCount;
                string confirmMessage = $"å³å°‡åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n" +
                                        $"â€¢ é‡ç”¨ç¾æœ‰åœ–å¡Š: {previewResult.ReuseCount} å€‹\n" +
                                        $"â€¢ åŒ¯å…¥æ–°åœ–å¡Š: {totalNewTiles} å€‹\n" +
                                        $"  (å¾ç·¨è™Ÿ {startId} é–‹å§‹å°‹æ‰¾æœªä½¿ç”¨çš„ ID)\n\n" +
                                        $"ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ";

                if (MessageBox.Show(confirmMessage, "ç¢ºèªåŒ¯å…¥", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes)
                    return null;

                // æª¢æŸ¥èµ·å§‹ç·¨è™Ÿæ˜¯å¦æœƒè¶…éä¸Šé™
                int currentLimit = TileHashManager.GetTileLimit();
                if (currentLimit > 0)
                {
                    // ä¼°ç®—æœ€å¤§å¯èƒ½ä½¿ç”¨çš„ ID (èµ·å§‹ID + éœ€åŒ¯å…¥æ•¸é‡)
                    int estimatedMaxId = startId + totalNewTiles;
                    if (estimatedMaxId > currentLimit)
                    {
                        string limitWarning = $"é è¨ˆ Tile ID å°‡è¶…éä¸Šé™ï¼\n\n" +
                                              $"ç›®å‰ä¸Šé™: {currentLimit}\n" +
                                              $"é è¨ˆæœ€å¤§ ID: ~{estimatedMaxId}\n\n" +
                                              $"è¶…éä¸Šé™çš„ Tile å°‡é¡¯ç¤ºç‚ºä¸‰è§’å½¢åœ–æ¡ˆã€‚\n" +
                                              $"æ˜¯å¦å…ˆå°‡ä¸Šé™æ“´å…… +5000ï¼Ÿ\n" +
                                              $"(æ–°ä¸Šé™: {currentLimit + 5000})";

                        var limitResult = MessageBox.Show(limitWarning, "Tile ä¸Šé™è­¦å‘Š", MessageBoxButtons.YesNoCancel, MessageBoxIcon.Warning);
                        if (limitResult == DialogResult.Cancel)
                            return null;

                        if (limitResult == DialogResult.Yes)
                        {
                            int newLimit = currentLimit + 5000;
                            if (TileHashManager.UpdateTileLimit(newLimit))
                            {
                                toolStripStatusLabel1.Text = $"å·²å°‡ Tile ä¸Šé™æ“´å……è‡³ {newLimit}";
                            }
                            else
                            {
                                MessageBox.Show("æ“´å…… Tile ä¸Šé™å¤±æ•—ï¼Œç¹¼çºŒåŒ¯å…¥", "è­¦å‘Š", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            }
                        }
                    }
                }

                // åŸ·è¡Œå¯¦éš›åŒ¯å…¥
                var importer = new TileImportManager { StartSearchId = startId };
                var result = importer.ProcessTilesBatch(material.Tiles);

                // é¡¯ç¤ºåŒ¯å…¥çµæœ
                if (result.ImportedCount > 0 || result.RemappedCount > 0)
                {
                    toolStripStatusLabel1.Text = $"å·²åŒ¯å…¥ {result.ImportedCount} å€‹æ–°åœ–å¡Šï¼Œé‡æ–°ç·¨è™Ÿ {result.RemappedCount} å€‹ï¼Œé‡ç”¨ {result.ReuseCount} å€‹";
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰ Tile ID è¶…éä¸Šé™
                CheckAndExpandTileLimit(result);

                return result;
            }
        }

        // æª¢æŸ¥ä¸¦æ“´å…… Tile ä¸Šé™
        private void CheckAndExpandTileLimit(TileMappingResult result)
        {
            if (result == null)
                return;

            // æ”¶é›†æ‰€æœ‰æ–°çš„ Tile ID
            var newTileIds = new List<int>(result.IdMapping.Values);

            if (newTileIds.Count == 0)
                return;

            // æª¢æŸ¥æ˜¯å¦è¶…éä¸Šé™
            var checkResult = TileHashManager.CheckTileIdsOverLimit(newTileIds);
            if (!checkResult.IsOver)
                return;

            // è¶…éä¸Šé™ï¼Œè©¢å•ç”¨æˆ¶æ˜¯å¦æ“´å……
            string message = $"Tile ID å·²é”ä¸Šé™ï¼\n\n" +
                             $"ç›®å‰ä¸Šé™: {checkResult.CurrentLimit}\n" +
                             $"æœ€å¤§ Tile ID: {checkResult.MaxTileId}\n\n" +
                             $"è¶…éä¸Šé™çš„ Tile å°‡é¡¯ç¤ºç‚ºä¸‰è§’å½¢åœ–æ¡ˆã€‚\n" +
                             $"æ˜¯å¦å°‡ä¸Šé™æ“´å…… +5000ï¼Ÿ\n" +
                             $"(æ–°ä¸Šé™: {checkResult.CurrentLimit + 5000})";

            if (MessageBox.Show(message, "Tile ä¸Šé™è­¦å‘Š", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                int newLimit = checkResult.CurrentLimit + 5000;
                if (TileHashManager.UpdateTileLimit(newLimit))
                {
                    MessageBox.Show($"å·²å°‡ Tile ä¸Šé™æ“´å……è‡³ {newLimit}", "æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    MessageBox.Show("æ“´å…… Tile ä¸Šé™å¤±æ•—", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // é è¦½ Tile åŒ¯å…¥æƒ…æ³ï¼ˆä¸å¯¦éš›å¯«å…¥ï¼‰
        private (int ReuseCount, int NeedRemapCount, int NeedImportCount) PreviewTileImport(Dictionary<int, TilePackageData> tiles)
        {
            int reuseCount = 0;
            int needRemapCount = 0;
            int needImportCount = 0;

            foreach (var kvp in tiles)
            {
                int originalId = kvp.Key;
                byte[] packageMd5 = kvp.Value.Md5Hash;

                // æª¢æŸ¥ç¾æœ‰ Tile
                byte[] existingTilData = L1PakReader.UnPack("Tile", $"{originalId}.til");

                if (existingTilData != null)
                {
                    byte[] existingMd5 = TileHashManager.CalculateMd5(existingTilData);
                    if (TileHashManager.CompareMd5(existingMd5, packageMd5))
                    {
                        reuseCount++; // MD5 ä¸€è‡´ï¼Œå¯é‡ç”¨
                    }
                    else
                    {
                        // ID å­˜åœ¨ä½† MD5 ä¸åŒï¼Œæœå°‹æ˜¯å¦æœ‰å…¶ä»– tile çš„ MD5 ç›¸ç¬¦
                        int? existingIdByMd5 = TileHashManager.FindTileByMd5(packageMd5);
                        if (existingIdByMd5.HasValue)
                        {
                            reuseCount++; // æ‰¾åˆ°ç›¸åŒ MD5 çš„å…¶ä»– tileï¼Œå¯é‡æ˜ å°„
                        }
                        else
                        {
                            needImportCount++; // å®Œå…¨ä¸å­˜åœ¨ï¼Œéœ€æ–°å¢
                        }
                    }
                }
                else
                {
                    // ID ä¸å­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒ MD5 çš„å…¶ä»– tile
                    int? existingIdByMd5 = TileHashManager.FindTileByMd5(packageMd5);
                    if (existingIdByMd5.HasValue)
                    {
                        reuseCount++; // æ‰¾åˆ°ç›¸åŒ MD5ï¼Œå¯é‡ç”¨
                    }
                    else
                    {
                        needImportCount++; // å®Œå…¨ä¸å­˜åœ¨ï¼Œéœ€æ–°å¢
                    }
                }
            }

            return (reuseCount, needRemapCount, needImportCount);
        }

        // å»ºç«‹ Tile Mappingï¼ˆä¸å¯¦éš›åŒ¯å…¥ï¼Œç”¨æ–¼æ‰€æœ‰ tile éƒ½å¯é‡ç”¨çš„æƒ…æ³ï¼‰
        private TileMappingResult BuildMappingWithoutImport(Dictionary<int, TilePackageData> tiles)
        {
            var result = new TileMappingResult();

            foreach (var kvp in tiles)
            {
                int originalId = kvp.Key;
                byte[] packageMd5 = kvp.Value.Md5Hash;

                byte[] existingTilData = L1PakReader.UnPack("Tile", $"{originalId}.til");

                if (existingTilData != null)
                {
                    byte[] existingMd5 = TileHashManager.CalculateMd5(existingTilData);
                    if (TileHashManager.CompareMd5(existingMd5, packageMd5))
                    {
                        // åŸ ID å­˜åœ¨ä¸” MD5 ç›¸ç¬¦ï¼Œç›´æ¥ä½¿ç”¨
                        result.AddMapping(originalId, originalId, TileMatchType.Exact);
                    }
                    else
                    {
                        // ID å­˜åœ¨ä½† MD5 ä¸åŒï¼Œæœå°‹å…¶ä»–åŒ¹é…çš„ tile
                        int? existingIdByMd5 = TileHashManager.FindTileByMd5(packageMd5);
                        if (existingIdByMd5.HasValue)
                        {
                            result.AddMapping(originalId, existingIdByMd5.Value, TileMatchType.MergedByMd5);
                        }
                    }
                }
                else
                {
                    // åŸ ID ä¸å­˜åœ¨ï¼Œæœå°‹ MD5 åŒ¹é…çš„ tile
                    int? existingIdByMd5 = TileHashManager.FindTileByMd5(packageMd5);
                    if (existingIdByMd5.HasValue)
                    {
                        result.AddMapping(originalId, existingIdByMd5.Value, TileMatchType.MergedByMd5);
                    }
                }
            }

            return result;
        }

        // å°‡ Tile Mapping å¥—ç”¨åˆ°ç´ æçš„å„åœ–å±¤
        private void ApplyTileMappingToMaterial(Fs3pData material, TileMappingResult mapping)
        {
            // æ›´æ–° Layer1
            foreach (var item in material.Layer1Items)
            {
                if (item.TileId > 0)
                {
                    item.TileId = (ushort)mapping.GetNewTileId(item.TileId);
                }
            }

            // æ›´æ–° Layer2
            foreach (var item in material.Layer2Items)
            {
                if (item.TileId > 0)
                {
                    item.TileId = (ushort)mapping.GetNewTileId(item.TileId);
                }
            }

            // æ›´æ–° Layer4
            foreach (var item in material.Layer4Items)
            {
                if (item.TileId > 0)
                {
                    item.TileId = (ushort)mapping.GetNewTileId(item.TileId);
                }
            }
        }

        // å–æ¶ˆç´ æè²¼ä¸Šæ¨¡å¼
        private void CancelMaterialPasteMode()
        {
            _pendingMaterial = null;
            _pendingMaterialPath = null;
            toolStripStatusLabel1.Text = "";

            // æ¸…é™¤é«˜äº®
            ClearMaterialHighlight();
        }

        // é«˜äº®ç›®å‰é¸ä¸­çš„ç´ æ
        private void HighlightPendingMaterial()
        {
            if (_pendingMaterialPath == null) return;

            foreach (ListViewItem item in lvMaterials.Items)
            {
                if (item.Tag is string path && path == _pendingMaterialPath)
                {
                    item.BackColor = Color.LightBlue;
                    item.ForeColor = Color.Black;
                }
                else
                {
                    item.BackColor = lvMaterials.BackColor;
                    item.ForeColor = lvMaterials.ForeColor;
                }
            }
        }

        // æ¸…é™¤ç´ æé«˜äº®
        private void ClearMaterialHighlight()
        {
            foreach (ListViewItem item in lvMaterials.Items)
            {
                item.BackColor = lvMaterials.BackColor;
                item.ForeColor = lvMaterials.ForeColor;
            }
        }

        // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨ï¼ˆé¡¯ç¤ºæ‰€æœ‰å·²è¼‰å…¥ S32 çš„ç¾¤çµ„ï¼‰
        private void UpdateGroupThumbnailsList()
        {
            UpdateGroupThumbnailsList(null);  // ä¸å¸¶é¸å–å€åŸŸæ™‚é¡¯ç¤ºå…¨éƒ¨
        }

        // ç¾¤çµ„ç¸®åœ–ç”¢ç”Ÿå–æ¶ˆ token
        private System.Threading.CancellationTokenSource _groupThumbnailCts = null;

        // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨ï¼ˆå¯æŒ‡å®šåªé¡¯ç¤ºé¸å–å€åŸŸå…§çš„ç¾¤çµ„ï¼‰- å®Œå…¨éåŒæ­¥ç‰ˆæœ¬
        private void UpdateGroupThumbnailsList(List<SelectedCell> selectedCells)
        {
            var setupSw = Stopwatch.StartNew();

            // å–æ¶ˆä¹‹å‰çš„ç¸®åœ–ç”¢ç”Ÿä»»å‹™
            if (_groupThumbnailCts != null)
            {
                _groupThumbnailCts.Cancel();
                _groupThumbnailCts.Dispose();
            }
            _groupThumbnailCts = new System.Threading.CancellationTokenSource();
            var cancellationToken = _groupThumbnailCts.Token;

            lvGroupThumbnails.Items.Clear();

            if (lvGroupThumbnails.LargeImageList != null)
            {
                lvGroupThumbnails.LargeImageList.Dispose();
            }

            if (_document.S32Files.Count == 0)
            {
                lblGroupThumbnails.Text = LocalizationManager.L("Label_GroupThumbnails");
                return;
            }

            bool isSelectedMode = selectedCells != null && selectedCells.Count > 0;

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            lblGroupThumbnails.Text = isSelectedMode
                ? $"{LocalizationManager.L("Label_SelectedAreaGroups")} ({LocalizationManager.L("Status_Collecting")}...)"
                : $"{LocalizationManager.L("Label_GroupThumbnails")} ({LocalizationManager.L("Status_Collecting")}...)";

            // è¤‡è£½éœ€è¦çš„è³‡æ–™åˆ°èƒŒæ™¯åŸ·è¡Œç·’
            var s32FilesSnapshot = _document.S32Files.Values.ToList();
            var selectedCellsSnapshot = selectedCells?.ToList();

            setupSw.Stop();
            long setupMs = setupSw.ElapsedMilliseconds;
            int s32Count = s32FilesSnapshot.Count;
            int selectedCount = selectedCellsSnapshot?.Count ?? 0;
            LogPerf($"[THUMBNAILS-START] setup={setupMs}ms, s32={s32Count}, selected={selectedCount}");

            // æ•´å€‹éç¨‹éƒ½åœ¨èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œ
            Task.Run(() =>
            {
                if (cancellationToken.IsCancellationRequested) return;

                var stopwatch = Stopwatch.StartNew();
                var phaseSw = Stopwatch.StartNew();

                // æ”¶é›†ç¾¤çµ„ï¼ˆæ ¹æ“šæ˜¯å¦æœ‰é¸å–å€åŸŸæ±ºå®šç¯„åœï¼‰
                var allGroupsDict = new Dictionary<int, List<(S32Data s32, ObjectTile obj)>>();

                if (selectedCellsSnapshot != null && selectedCellsSnapshot.Count > 0)
                {
                    // å»ºç«‹é¸å–æ ¼å­çš„å…¨åŸŸåº§æ¨™é›†åˆ (ä½¿ç”¨ Layer1 åº§æ¨™ç³»çµ± 0-127)
                    var selectedLayer1Cells = new HashSet<(int x, int y)>();
                    foreach (var cell in selectedCellsSnapshot)
                    {
                        int layer1GlobalX = cell.S32Data.SegInfo.nLinBeginX * 2 + cell.LocalX;
                        int layer1GlobalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                        selectedLayer1Cells.Add((layer1GlobalX, layer1GlobalY));
                        selectedLayer1Cells.Add((layer1GlobalX + 1, layer1GlobalY));
                    }

                    // éæ­·æ‰€æœ‰ S32ï¼Œæ‰¾å‡ºå…¨åŸŸåº§æ¨™è½åœ¨é¸å–æ ¼å­å…§çš„ Layer4 ç‰©ä»¶
                    foreach (var s32Data in s32FilesSnapshot)
                    {
                        int segStartX = s32Data.SegInfo.nLinBeginX;
                        int segStartY = s32Data.SegInfo.nLinBeginY;

                        foreach (var obj in s32Data.Layer4)
                        {
                            int layer1GlobalX = segStartX * 2 + obj.X;
                            int layer1GlobalY = segStartY + obj.Y;

                            if (selectedLayer1Cells.Contains((layer1GlobalX, layer1GlobalY)))
                            {
                                if (!allGroupsDict.ContainsKey(obj.GroupId))
                                {
                                    allGroupsDict[obj.GroupId] = new List<(S32Data, ObjectTile)>();
                                }
                                allGroupsDict[obj.GroupId].Add((s32Data, obj));
                            }
                        }
                    }
                }
                else
                {
                    // ä½¿ç”¨é å…ˆå»ºç«‹çš„ç¾¤çµ„å­—å…¸ï¼ˆO(1) å–å¾—ï¼Œé¿å…æƒæ 4.6M ç‰©ä»¶ï¼‰
                    allGroupsDict = _layer4SpatialIndex.GetAllGroups();
                }

                if (cancellationToken.IsCancellationRequested) return;

                phaseSw.Stop();
                long collectGroupsMs = phaseSw.ElapsedMilliseconds;
                phaseSw.Restart();

                if (allGroupsDict.Count == 0)
                {
                    try
                    {
                        this.BeginInvoke((MethodInvoker)delegate
                        {
                            string label = isSelectedMode
                                ? string.Format(LocalizationManager.L("Label_SelectedAreaGroupsCount"), 0)
                                : string.Format(LocalizationManager.L("Label_GroupThumbnailsCount"), 0);
                            lblGroupThumbnails.Text = label;
                        });
                    }
                    catch { }
                    return;
                }

                int totalGroups = allGroupsDict.Count;

                // æ”¶é›†æ‰€æœ‰ Layer5 çš„ GroupId -> Type å°æ‡‰
                var groupLayer5Info = new Dictionary<int, byte>();
                if (selectedCellsSnapshot != null && selectedCellsSnapshot.Count > 0)
                {
                    foreach (var cell in selectedCellsSnapshot)
                    {
                        foreach (var item in cell.S32Data.Layer5)
                        {
                            if (item.X == cell.LocalX && item.Y == cell.LocalY)
                            {
                                if (!groupLayer5Info.ContainsKey(item.ObjectIndex))
                                {
                                    groupLayer5Info[item.ObjectIndex] = item.Type;
                                }
                            }
                        }
                    }
                }
                else
                {
                    foreach (var s32Data in s32FilesSnapshot)
                    {
                        foreach (var item in s32Data.Layer5)
                        {
                            if (!groupLayer5Info.ContainsKey(item.ObjectIndex))
                            {
                                groupLayer5Info[item.ObjectIndex] = item.Type;
                            }
                        }
                    }
                }

                if (cancellationToken.IsCancellationRequested) return;

                phaseSw.Stop();
                long collectLayer5Ms = phaseSw.ElapsedMilliseconds;
                phaseSw.Restart();

                // æ›´æ–° UI é¡¯ç¤ºé€²åº¦
                try
                {
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        lblGroupThumbnails.Text = isSelectedMode
                            ? $"{LocalizationManager.L("Label_SelectedAreaGroups")} ({LocalizationManager.L("Status_Loading")} 0/{totalGroups})"
                            : string.Format(LocalizationManager.L("Label_GroupThumbnailsLoading"), 0, totalGroups);
                    });
                }
                catch { }

                // æº–å‚™ç¾¤çµ„è³‡æ–™
                var groupList = allGroupsDict.OrderBy(k => k.Key).ToList();

                // ä½¿ç”¨ Parallel.ForEach ä¸¦è¡Œç”¢ç”Ÿç¸®åœ–
                var thumbnailResults = new System.Collections.Concurrent.ConcurrentDictionary<int, (int groupId, int objectCount, Bitmap thumbnail, List<(S32Data s32, ObjectTile obj)> objects, bool hasLayer5, byte layer5Type)>();

                int processedCount = 0;
                int lastReportedCount = 0;

                Parallel.ForEach(groupList, new ParallelOptions { MaxDegreeOfParallelism = Environment.ProcessorCount }, (kvp, state) =>
                {
                    if (cancellationToken.IsCancellationRequested)
                    {
                        state.Stop();
                        return;
                    }

                    int groupId = kvp.Key;
                    var objects = kvp.Value;

                    // æª¢æŸ¥è©²ç¾¤çµ„æ˜¯å¦æœ‰ Layer5 è¨­å®š
                    bool hasLayer5 = groupLayer5Info.TryGetValue(groupId, out byte layer5Type);

                    // ç”Ÿæˆç¾¤çµ„ç¸®åœ–ï¼ˆå‚³é Layer5 è¨­å®šä»¥ç¹ªè£½é‚Šæ¡†ï¼‰
                    Bitmap thumbnail = GenerateGroupThumbnail(objects, 80, hasLayer5, layer5Type);

                    if (thumbnail != null && !cancellationToken.IsCancellationRequested)
                    {
                        thumbnailResults[groupId] = (groupId, objects.Count, thumbnail, objects, hasLayer5, layer5Type);
                    }

                    // æ›´æ–°é€²åº¦ï¼ˆæ¯è™•ç† 10 å€‹æˆ–è™•ç†å®Œæˆæ™‚æ›´æ–° UIï¼‰
                    int current = System.Threading.Interlocked.Increment(ref processedCount);
                    if (current - lastReportedCount >= 10 || current == totalGroups)
                    {
                        lastReportedCount = current;
                        try
                        {
                            this.BeginInvoke((MethodInvoker)delegate
                            {
                                if (!cancellationToken.IsCancellationRequested)
                                {
                                    lblGroupThumbnails.Text = isSelectedMode
                                        ? $"{LocalizationManager.L("Label_SelectedAreaGroups")} ({LocalizationManager.L("Status_Loading")} {current}/{totalGroups})"
                                        : string.Format(LocalizationManager.L("Label_GroupThumbnailsLoading"), current, totalGroups);
                                }
                            });
                        }
                        catch { }
                    }
                });

                phaseSw.Stop();
                long generateThumbnailsMs = phaseSw.ElapsedMilliseconds;

                stopwatch.Stop();
                long elapsedMs = stopwatch.ElapsedMilliseconds;

                LogPerf($"[THUMBNAILS-DONE] total={elapsedMs}ms | collectGroups={collectGroupsMs}ms, collectLayer5={collectLayer5Ms}ms, generateThumbnails={generateThumbnailsMs}ms | groups={totalGroups}");

                // å¦‚æœè¢«å–æ¶ˆå°±ä¸æ›´æ–° UI
                if (cancellationToken.IsCancellationRequested)
                {
                    // æ¸…ç†å·²ç”¢ç”Ÿçš„ Bitmap
                    foreach (var result in thumbnailResults.Values)
                    {
                        result.thumbnail?.Dispose();
                    }
                    return;
                }

                // åœ¨ UI åŸ·è¡Œç·’æ›´æ–° ListView
                try
                {
                    this.BeginInvoke((MethodInvoker)delegate
                    {
                        var uiSw = Stopwatch.StartNew();

                        if (cancellationToken.IsCancellationRequested)
                        {
                            foreach (var result in thumbnailResults.Values)
                            {
                                result.thumbnail?.Dispose();
                            }
                            return;
                        }

                        // å»ºç«‹ ImageList
                        ImageList imageList = new ImageList();
                        imageList.ImageSize = new Size(80, 80);
                        imageList.ColorDepth = ColorDepth.Depth32Bit;

                        lvGroupThumbnails.BeginUpdate();  // æš«åœé‡ç¹ª
                        try
                        {
                            lvGroupThumbnails.Items.Clear();
                            if (lvGroupThumbnails.LargeImageList != null)
                            {
                                lvGroupThumbnails.LargeImageList.Dispose();
                            }

                            // æ‰¹é‡æº–å‚™é …ç›®
                            var items = new List<ListViewItem>();
                            int thumbnailIndex = 0;
                            foreach (var groupId in thumbnailResults.Keys.OrderBy(k => k))
                            {
                                var result = thumbnailResults[groupId];
                                imageList.Images.Add(result.thumbnail);

                                ListViewItem item = new ListViewItem($"G{result.groupId} ({result.objectCount})");
                                item.ImageIndex = thumbnailIndex;
                                item.Tag = new GroupThumbnailInfo
                                {
                                    GroupId = result.groupId,
                                    Objects = result.objects,
                                    HasLayer5Setting = result.hasLayer5,
                                    Layer5Type = result.layer5Type
                                };
                                items.Add(item);

                                thumbnailIndex++;
                            }

                            // æ‰¹é‡æ·»åŠ 
                            lvGroupThumbnails.Items.AddRange(items.ToArray());
                            lvGroupThumbnails.LargeImageList = imageList;
                        }
                        finally
                        {
                            lvGroupThumbnails.EndUpdate();  // æ¢å¾©é‡ç¹ª
                        }

                        uiSw.Stop();

                        string labelText = isSelectedMode
                            ? $"{LocalizationManager.L("Label_SelectedAreaGroups")} ({totalGroups}) [{elapsedMs}ms]"
                            : string.Format(LocalizationManager.L("Label_GroupThumbnailsTime"), totalGroups, elapsedMs);
                        lblGroupThumbnails.Text = labelText;

                        // æ›´æ–°ç‹€æ…‹åˆ—ï¼Œå°‡ã€Œbackgroundã€æ›¿æ›ç‚ºå¯¦éš›æ™‚é–“
                        if (this.toolStripStatusLabel1.Text.Contains("Thumbnails: background"))
                        {
                            this.toolStripStatusLabel1.Text = this.toolStripStatusLabel1.Text.Replace(
                                "Thumbnails: background",
                                $"Thumbnails: {elapsedMs}ms");
                        }

                        LogPerf($"[THUMBNAILS-UI] updateListView={uiSw.ElapsedMilliseconds}ms | groups={totalGroups}");
                    });
                }
                catch { }
            });
        }

        // ç¾¤çµ„ç¸®åœ–è³‡è¨Š
        private class GroupThumbnailInfo
        {
            public int GroupId { get; set; }
            public List<(S32Data s32, ObjectTile obj)> Objects { get; set; }
            public bool HasLayer5Setting { get; set; }  // æ˜¯å¦æœ‰ Layer5 è¨­å®š
            public byte Layer5Type { get; set; }        // Layer5 Type (0=åŠé€æ˜, 1=å…¶ä»–)
        }

        // ã€Œå…¨éƒ¨ã€æŒ‰éˆ•é»æ“Šäº‹ä»¶ - é¡¯ç¤ºå…¨éƒ¨ç¾¤çµ„
        private void btnShowAllGroups_Click(object sender, EventArgs e)
        {
            UpdateGroupThumbnailsList(null);  // å‚³å…¥ null é¡¯ç¤ºå…¨éƒ¨
        }

        // ç¸®åœ–é‚Šæ¡†ç•«ç­†ï¼ˆé‡ç”¨é¿å…é‡è¤‡å»ºç«‹ï¼‰
        private static readonly Pen _thumbnailBorderPen = new Pen(Color.LightGray, 1);
        private static readonly Pen _thumbnailBorderPenType0 = new Pen(Color.FromArgb(180, 0, 255), 3);  // ç´«è‰² - Type=0
        private static readonly Pen _thumbnailBorderPenType1 = new Pen(Color.FromArgb(255, 80, 80), 3);  // ç´…è‰² - Type=1

        // ç”Ÿæˆç¾¤çµ„ç¸®åœ–ï¼ˆå°‡åŒ GroupId çš„ç‰©ä»¶æŒ‰ç›¸å°ä½ç½®çµ„è£ï¼Œä½¿ç”¨èˆ‡ä¸»ç•«å¸ƒç›¸åŒçš„ç¹ªè£½æ–¹å¼ï¼‰
        private Bitmap GenerateGroupThumbnail(List<(S32Data s32, ObjectTile obj)> objects, int thumbnailSize, bool hasLayer5Setting = false, byte layer5Type = 0)
        {
            if (objects == null || objects.Count == 0)
                return null;

            try
            {
                // è¨ˆç®—æ‰€æœ‰ç‰©ä»¶çš„åƒç´ é‚Šç•Œ
                // ä½¿ç”¨èˆ‡ RenderS32Block å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—æ–¹å¼
                int pixelMinX = int.MaxValue, pixelMaxX = int.MinValue;
                int pixelMinY = int.MaxValue, pixelMaxY = int.MinValue;

                // é å…ˆè¨ˆç®—æ¯å€‹ç‰©ä»¶çš„åƒç´ åº§æ¨™ï¼Œé¿å…é‡è¤‡è¨ˆç®—
                var objectPixels = new List<(ObjectTile obj, int px, int py)>(objects.Count);

                foreach (var item in objects)
                {
                    var obj = item.obj;
                    // ä½¿ç”¨èˆ‡ RenderS32Block å®Œå…¨ç›¸åŒçš„åº§æ¨™è¨ˆç®—
                    int halfX = obj.X / 2;
                    int baseX = -24 * halfX;
                    int baseY = 63 * 12 - 12 * halfX;
                    int px = baseX + obj.X * 24 + obj.Y * 24;
                    int py = baseY + obj.Y * 12;

                    objectPixels.Add((obj, px, py));

                    pixelMinX = Math.Min(pixelMinX, px);
                    pixelMaxX = Math.Max(pixelMaxX, px + 48);  // tile å¯¬åº¦ç´„ 48
                    pixelMinY = Math.Min(pixelMinY, py);
                    pixelMaxY = Math.Max(pixelMaxY, py + 48);  // tile é«˜åº¦é ç•™ç©ºé–“
                }

                // è¨ˆç®—å¯¦éš›æ‰€éœ€çš„åœ–ç‰‡å¤§å°ï¼ˆåŠ ä¸Šé‚Šè·ï¼‰
                int margin = 8;
                int actualWidth = pixelMaxX - pixelMinX + margin * 2;
                int actualHeight = pixelMaxY - pixelMinY + margin * 2;

                // é™åˆ¶ tempBitmap å¤§å°ï¼šç¸®åœ–åªæœ‰ 80pxï¼Œä¸éœ€è¦å¤ªå¤§çš„æš«å­˜åœ–
                // æœ€å¤§ 512x512 è¶³å¤ ï¼Œè¶…éçš„æœƒè¢«ç¸®æ”¾
                int maxTempSize = 512;
                int tempWidth = Math.Min(Math.Max(actualWidth, 64), maxTempSize);
                int tempHeight = Math.Min(Math.Max(actualHeight, 64), maxTempSize);

                // å¦‚æœå¯¦éš›å¤§å°è¶…éé™åˆ¶ï¼Œè¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                float preScale = 1.0f;
                if (actualWidth > maxTempSize || actualHeight > maxTempSize)
                {
                    preScale = Math.Min((float)maxTempSize / actualWidth, (float)maxTempSize / actualHeight);
                    tempWidth = (int)(actualWidth * preScale);
                    tempHeight = (int)(actualHeight * preScale);
                }

                // ä½¿ç”¨ 16bpp æ ¼å¼èˆ‡ä¸»ç•«å¸ƒç›¸åŒ
                Bitmap tempBitmap = new Bitmap(tempWidth, tempHeight, PixelFormat.Format16bppRgb555);

                Rectangle rect = new Rectangle(0, 0, tempBitmap.Width, tempBitmap.Height);
                BitmapData bmpData = tempBitmap.LockBits(rect, ImageLockMode.ReadWrite, tempBitmap.PixelFormat);
                int rowpix = bmpData.Stride;

                unsafe
                {
                    byte* ptr = (byte*)bmpData.Scan0;

                    // ä½¿ç”¨ Marshal.Copy æ‰¹æ¬¡å¡«å……ç™½è‰²èƒŒæ™¯ (RGB555: 0x7FFF = ç™½è‰²)
                    // å»ºç«‹ä¸€è¡Œç™½è‰²è³‡æ–™
                    byte[] whiteLine = new byte[rowpix];
                    for (int x = 0; x < tempWidth; x++)
                    {
                        whiteLine[x * 2] = 0xFF;
                        whiteLine[x * 2 + 1] = 0x7F;
                    }
                    // æ‰¹æ¬¡è¤‡è£½åˆ°æ¯ä¸€è¡Œ
                    for (int y = 0; y < tempHeight; y++)
                    {
                        System.Runtime.InteropServices.Marshal.Copy(whiteLine, 0, (IntPtr)(ptr + y * rowpix), rowpix);
                    }

                    // é«˜é€Ÿå¹³è¡Œç¹ªè£½ï¼ˆç¸®åœ–ä¸éœ€è¦ç²¾ç¢º Layer é †åºï¼‰
                    // é å…ˆè¨ˆç®—æ‰€æœ‰ç¹ªè£½åƒæ•¸
                    var drawItems = objectPixels.Select(item => {
                        int pixelX = (int)((item.px - pixelMinX + margin) * preScale);
                        int pixelY = (int)((item.py - pixelMinY + margin) * preScale);
                        return (item.obj, pixelX, pixelY);
                    }).ToArray();

                    // å¹³è¡Œç¹ªè£½æ‰€æœ‰ tiles
                    Parallel.ForEach(drawItems, item =>
                    {
                        DrawTilToBufferDirect(item.pixelX, item.pixelY, item.obj.TileId, item.obj.IndexId, rowpix, ptr, tempWidth, tempHeight);
                    });
                }

                tempBitmap.UnlockBits(bmpData);

                // ç¸®æ”¾åˆ°ç›®æ¨™å¤§å°ï¼ˆç™½åº•ï¼‰
                Bitmap result = new Bitmap(thumbnailSize, thumbnailSize, PixelFormat.Format32bppArgb);
                using (Graphics g = Graphics.FromImage(result))
                {
                    // ç™½è‰²åº•
                    g.Clear(Color.White);
                    // ä½¿ç”¨è¼ƒå¿«çš„æ’å€¼æ¨¡å¼ï¼ˆç¸®åœ–ä¸éœ€è¦é«˜å“è³ªï¼‰
                    g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.NearestNeighbor;
                    g.PixelOffsetMode = System.Drawing.Drawing2D.PixelOffsetMode.HighSpeed;
                    g.CompositingQuality = System.Drawing.Drawing2D.CompositingQuality.HighSpeed;

                    // ä¿æŒæ¯”ä¾‹ç¸®æ”¾
                    float scaleX = (float)(thumbnailSize - 4) / tempWidth;
                    float scaleY = (float)(thumbnailSize - 4) / tempHeight;
                    float scale = Math.Min(scaleX, scaleY);
                    int scaledWidth = (int)(tempWidth * scale);
                    int scaledHeight = (int)(tempHeight * scale);
                    int drawX = (thumbnailSize - scaledWidth) / 2;
                    int drawY = (thumbnailSize - scaledHeight) / 2;

                    g.DrawImage(tempBitmap, drawX, drawY, scaledWidth, scaledHeight);

                    // åŠ é‚Šæ¡†ï¼ˆæ ¹æ“š Layer5 è¨­å®šä½¿ç”¨ä¸åŒé¡è‰²ï¼‰
                    if (hasLayer5Setting)
                    {
                        Pen borderPen = layer5Type == 0 ? _thumbnailBorderPenType0 : _thumbnailBorderPenType1;
                        g.DrawRectangle(borderPen, 1, 1, thumbnailSize - 3, thumbnailSize - 3);
                    }
                    else
                    {
                        g.DrawRectangle(_thumbnailBorderPen, 0, 0, thumbnailSize - 1, thumbnailSize - 1);
                    }
                }

                tempBitmap.Dispose();
                return result;
            }
            catch
            {
                // å¦‚æœç”Ÿæˆå¤±æ•—ï¼Œè¿”å›ä¸€å€‹å¸¶æ–‡å­—çš„é è¨­åœ–ç‰‡
                Bitmap fallback = new Bitmap(thumbnailSize, thumbnailSize);
                using (Graphics g = Graphics.FromImage(fallback))
                {
                    g.Clear(Color.White);
                    using (Font font = new Font("Arial", 10))
                    {
                        string text = $"G{objects[0].obj.GroupId}";
                        SizeF textSize = g.MeasureString(text, font);
                        g.DrawString(text, font, Brushes.Gray,
                            (thumbnailSize - textSize.Width) / 2,
                            (thumbnailSize - textSize.Height) / 2);
                    }
                }
                return fallback;
            }
        }

        // ç¾¤çµ„ç¸®åœ–å–®æ“Šäº‹ä»¶ - å·¦éµè¤‡è£½ç¾¤çµ„ï¼ˆæ”¯æ´å¤šé¸ï¼‰
        private void lvGroupThumbnails_MouseClick(object sender, MouseEventArgs e)
        {
            // åªè™•ç†å·¦éµé»æ“Šï¼ˆå³éµç”± MouseUp è™•ç†é¡¯ç¤º context menuï¼‰
            if (e.Button != MouseButtons.Left)
                return;

            if (lvGroupThumbnails.SelectedItems.Count == 0)
                return;

            // æ”¶é›†æ‰€æœ‰é¸ä¸­ç¾¤çµ„çš„è³‡è¨Š
            var selectedInfos = new List<GroupThumbnailInfo>();
            foreach (ListViewItem item in lvGroupThumbnails.SelectedItems)
            {
                if (item.Tag is GroupThumbnailInfo info && info.Objects.Count > 0)
                {
                    selectedInfos.Add(info);
                }
            }

            if (selectedInfos.Count > 0)
            {
                CopyMultipleGroupsToClipboard(selectedInfos);
            }
        }

        // ç¾¤çµ„é¸æ“‡è®Šæ›´äº‹ä»¶ - æ›´æ–°éæ¿¾ç‹€æ…‹
        private void lvGroupThumbnails_SelectedIndexChanged(object sender, EventArgs e)
        {
            // æ›´æ–°é¸å–çš„ç¾¤çµ„ ID åˆ—è¡¨
            _editState.SelectedLayer4Groups.Clear();
            foreach (ListViewItem item in lvGroupThumbnails.SelectedItems)
            {
                if (item.Tag is GroupThumbnailInfo info)
                {
                    _editState.SelectedLayer4Groups.Add(info.GroupId);
                }
            }

            // æ›´æ–°ç‹€æ…‹åˆ—
            if (_editState.SelectedLayer4Groups.Count > 0)
            {
                string groupIds = string.Join(", ", _editState.SelectedLayer4Groups);
                this.toolStripStatusLabel1.Text = $"å·²é¸å– {_editState.SelectedLayer4Groups.Count} å€‹ç¾¤çµ„: {groupIds}";
            }
        }

        // è¤‡è£½å¤šå€‹ç¾¤çµ„åˆ°å‰ªè²¼ç°¿
        private void CopyMultipleGroupsToClipboard(List<GroupThumbnailInfo> infos)
        {
            _editState.CellClipboard.Clear();

            // æ”¶é›†æ‰€æœ‰è¦è¤‡è£½çš„ç‰©ä»¶
            var allObjects = new List<(S32Data s32, ObjectTile obj)>();
            foreach (var info in infos)
            {
                allObjects.AddRange(info.Objects);
            }

            if (allObjects.Count == 0)
            {
                this.toolStripStatusLabel1.Text = "é¸å–çš„ç¾¤çµ„å…§æ²’æœ‰ä»»ä½•ç‰©ä»¶";
                return;
            }

            // è¨ˆç®—è¦è¤‡è£½ç‰©ä»¶çš„åº§æ¨™ç¯„åœï¼ˆä½¿ç”¨ Layer1 åº§æ¨™ç³»çµ±ï¼‰
            int minX = int.MaxValue, minY = int.MaxValue;
            foreach (var (s32, obj) in allObjects)
            {
                int globalLayer1X = s32.SegInfo.nLinBeginX * 2 + obj.X;
                int globalLayer1Y = s32.SegInfo.nLinBeginY + obj.Y;
                if (globalLayer1X < minX) minX = globalLayer1X;
                if (globalLayer1Y < minY) minY = globalLayer1Y;
            }

            // è¤‡è£½ç‰©ä»¶ï¼ˆä½¿ç”¨ Layer1 åº§æ¨™ç³»çµ±ï¼‰
            foreach (var (s32, obj) in allObjects)
            {
                int globalLayer1X = s32.SegInfo.nLinBeginX * 2 + obj.X;
                int globalLayer1Y = s32.SegInfo.nLinBeginY + obj.Y;

                var cellData = new CopiedCellData
                {
                    RelativeX = globalLayer1X - minX,
                    RelativeY = globalLayer1Y - minY
                };

                cellData.Layer4Objects.Add(new CopiedObjectTile
                {
                    RelativeX = globalLayer1X - minX,
                    RelativeY = globalLayer1Y - minY,
                    GroupId = obj.GroupId,
                    Layer = obj.Layer,
                    IndexId = obj.IndexId,
                    TileId = obj.TileId,
                    OriginalIndex = s32.Layer4.IndexOf(obj),
                    OriginalLocalLayer1X = obj.X,
                    OriginalLocalY = obj.Y
                });

                _editState.CellClipboard.Add(cellData);
            }

            // è¨­å®šå‰ªè²¼ç°¿ç‹€æ…‹
            hasLayer4Clipboard = true;
            _editState.SourceMapId = _document.MapId;

            // é¡¯ç¤ºè¨Šæ¯
            string groupIds = string.Join(", ", infos.Select(i => i.GroupId));
            this.toolStripStatusLabel1.Text = $"å·²è¤‡è£½ {infos.Count} å€‹ç¾¤çµ„ ({groupIds})ï¼Œå…± {allObjects.Count} å€‹ç‰©ä»¶ (é¸å–ä½ç½®å¾ŒæŒ‰ Ctrl+V è²¼ä¸Š)";
        }

        // è¤‡è£½å–®ä¸€ç¾¤çµ„åˆ°å‰ªè²¼ç°¿ï¼ˆä¿ç•™ä¾›ç›¸å®¹ï¼‰
        private void CopyGroupToClipboard(GroupThumbnailInfo info)
        {
            CopyMultipleGroupsToClipboard(new List<GroupThumbnailInfo> { info });
        }

        // é¡¯ç¤ºç¾¤çµ„é è¦½å°è©±æ¡†ï¼ˆå¯ç¸®æ”¾ï¼‰
        private void ShowGroupPreviewDialog(GroupThumbnailInfo info)
        {
            // ç”Ÿæˆé«˜è§£æåº¦é è¦½åœ–ï¼ˆ800x800ï¼‰
            int baseSize = 800;
            Bitmap previewImage = GenerateGroupThumbnail(info.Objects, baseSize);

            if (previewImage == null)
                return;

            // ç¸®æ”¾ç‹€æ…‹
            float currentZoom = 1.0f;
            float minZoom = 0.25f;
            float maxZoom = 4.0f;
            Point dragStart = Point.Empty;
            Point scrollOffset = Point.Empty;
            bool isDragging = false;

            // å»ºç«‹é è¦½å°è©±æ¡†
            Form previewForm = new Form
            {
                Text = $"ç¾¤çµ„ {info.GroupId} - {info.Objects.Count} å€‹ç‰©ä»¶ (æ»¾è¼ªç¸®æ”¾, æ‹–æ›³å¹³ç§»)",
                Size = new Size(520, 600),
                StartPosition = FormStartPosition.CenterParent,
                FormBorderStyle = FormBorderStyle.Sizable,
                MaximizeBox = true,
                MinimizeBox = false
            };

            // ä½¿ç”¨ Panel ä½œç‚ºå®¹å™¨ï¼Œæ”¯æ´æ»¾å‹•
            Panel container = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(480, 480),
                Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right,
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.White,
                AutoScroll = true
            };

            PictureBox pb = new PictureBox
            {
                Image = previewImage,
                Size = previewImage.Size,
                Location = new Point(0, 0),
                SizeMode = PictureBoxSizeMode.Zoom,
                BackColor = Color.White
            };

            // æ›´æ–° PictureBox å¤§å°çš„å‡½æ•¸
            Action updateZoom = () =>
            {
                int newWidth = (int)(baseSize * currentZoom);
                int newHeight = (int)(baseSize * currentZoom);
                pb.Size = new Size(newWidth, newHeight);
                previewForm.Text = $"ç¾¤çµ„ {info.GroupId} - {info.Objects.Count} å€‹ç‰©ä»¶ ({(int)(currentZoom * 100)}%)";
            };

            // æ»¾è¼ªç¸®æ”¾
            pb.MouseWheel += (s, ev) =>
            {
                float oldZoom = currentZoom;
                if (ev.Delta > 0)
                    currentZoom = Math.Min(currentZoom * 1.2f, maxZoom);
                else
                    currentZoom = Math.Max(currentZoom / 1.2f, minZoom);

                if (Math.Abs(oldZoom - currentZoom) > 0.001f)
                    updateZoom();
            };

            container.MouseWheel += (s, ev) =>
            {
                float oldZoom = currentZoom;
                if (ev.Delta > 0)
                    currentZoom = Math.Min(currentZoom * 1.2f, maxZoom);
                else
                    currentZoom = Math.Max(currentZoom / 1.2f, minZoom);

                if (Math.Abs(oldZoom - currentZoom) > 0.001f)
                    updateZoom();
            };

            // æ‹–æ›³å¹³ç§»
            pb.MouseDown += (s, ev) =>
            {
                if (ev.Button == MouseButtons.Left)
                {
                    isDragging = true;
                    dragStart = ev.Location;
                    pb.Cursor = Cursors.Hand;
                }
            };

            pb.MouseMove += (s, ev) =>
            {
                if (isDragging)
                {
                    int dx = ev.X - dragStart.X;
                    int dy = ev.Y - dragStart.Y;
                    container.AutoScrollPosition = new Point(
                        -container.AutoScrollPosition.X - dx,
                        -container.AutoScrollPosition.Y - dy);
                }
            };

            pb.MouseUp += (s, ev) =>
            {
                isDragging = false;
                pb.Cursor = Cursors.Default;
            };

            container.Controls.Add(pb);

            // ç¸®æ”¾æŒ‰éˆ•
            Button btnZoomIn = new Button
            {
                Text = "+",
                Size = new Size(40, 30),
                Location = new Point(10, 500),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };
            btnZoomIn.Click += (s, ev) =>
            {
                currentZoom = Math.Min(currentZoom * 1.5f, maxZoom);
                updateZoom();
            };

            Button btnZoomOut = new Button
            {
                Text = "-",
                Size = new Size(40, 30),
                Location = new Point(55, 500),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };
            btnZoomOut.Click += (s, ev) =>
            {
                currentZoom = Math.Max(currentZoom / 1.5f, minZoom);
                updateZoom();
            };

            Button btnZoomReset = new Button
            {
                Text = "1:1",
                Size = new Size(40, 30),
                Location = new Point(100, 500),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };
            btnZoomReset.Click += (s, ev) =>
            {
                currentZoom = 1.0f;
                updateZoom();
                container.AutoScrollPosition = Point.Empty;
            };

            Button btnGoto = new Button
            {
                Text = "è·³è½‰åˆ°ä½ç½®",
                Size = new Size(100, 30),
                Location = new Point(160, 500),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };
            btnGoto.Click += (s, ev) =>
            {
                previewForm.Close();
                JumpToGroupLocation(info);
            };

            Button btnClose = new Button
            {
                Text = "é—œé–‰",
                Size = new Size(80, 30),
                Location = new Point(420, 500),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right
            };
            btnClose.Click += (s, ev) => previewForm.Close();

            // é¡¯ç¤ºç‰©ä»¶è³‡è¨Š
            Label lblInfo = new Label
            {
                Text = $"GroupId: {info.GroupId} | ç‰©ä»¶æ•¸: {info.Objects.Count}",
                Location = new Point(270, 505),
                Size = new Size(140, 20),
                ForeColor = Color.Gray,
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left
            };

            previewForm.Controls.Add(container);
            previewForm.Controls.Add(btnZoomIn);
            previewForm.Controls.Add(btnZoomOut);
            previewForm.Controls.Add(btnZoomReset);
            previewForm.Controls.Add(btnGoto);
            previewForm.Controls.Add(btnClose);
            previewForm.Controls.Add(lblInfo);

            previewForm.FormClosed += (s, ev) =>
            {
                previewImage.Dispose();
            };

            // è¨­å®šç„¦é»è®“æ»¾è¼ªå¯ç”¨
            previewForm.Shown += (s, ev) => container.Focus();

            previewForm.ShowDialog(this);
        }

        // è·³è½‰åˆ°ç¾¤çµ„ä½ç½®
        private void JumpToGroupLocation(GroupThumbnailInfo info)
        {
            if (info.Objects.Count == 0)
                return;

            var firstObj = info.Objects[0];
            var s32Data = firstObj.s32;
            var obj = firstObj.obj;

            // è¨ˆç®—è¢å¹•åº§æ¨™
            int[] loc = s32Data.SegInfo.GetLoc(1.0);
            int mx = loc[0];
            int my = loc[1];

            int localBaseX = 0;
            int localBaseY = 63 * 12;
            localBaseX -= 24 * (obj.X / 2);
            localBaseY -= 12 * (obj.X / 2);

            // è¨ˆç®—ä¸–ç•Œåº§æ¨™
            int worldX = mx + localBaseX + obj.X * 24 + obj.Y * 24;
            int worldY = my + localBaseY + obj.Y * 12;

            // æ²å‹•åˆ°è©²ä½ç½®ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
            int viewportWidthWorld = (int)(s32MapPanel.Width / s32ZoomLevel);
            int viewportHeightWorld = (int)(s32MapPanel.Height / s32ZoomLevel);
            int scrollX = worldX - viewportWidthWorld / 2;
            int scrollY = worldY - viewportHeightWorld / 2;

            int maxScrollX = Math.Max(0, _viewState.MapWidth - viewportWidthWorld);
            int maxScrollY = Math.Max(0, _viewState.MapHeight - viewportHeightWorld);
            scrollX = Math.Max(0, Math.Min(scrollX, maxScrollX));
            scrollY = Math.Max(0, Math.Min(scrollY, maxScrollY));

            _viewState.SetScrollSilent(scrollX, scrollY);

            // é«˜äº®é¡¯ç¤ºè©²æ ¼å­
            _editState.HighlightedS32Data = s32Data;
            _editState.HighlightedCellX = obj.X;
            _editState.HighlightedCellY = obj.Y;

            _mapViewerControl.Refresh();
            UpdateMiniMap();

            this.toolStripStatusLabel1.Text = $"è·³è½‰åˆ°ç¾¤çµ„ {info.GroupId}ï¼Œä½ç½® ({obj.X}, {obj.Y})ï¼Œå…± {info.Objects.Count} å€‹ç‰©ä»¶";
        }

        // ç¾¤çµ„ç¸®åœ–é›™æ“Šäº‹ä»¶ - é¡¯ç¤ºæ”¾å¤§é è¦½
        private void lvGroupThumbnails_DoubleClick(object sender, EventArgs e)
        {
            if (lvGroupThumbnails.SelectedItems.Count == 0)
                return;

            var item = lvGroupThumbnails.SelectedItems[0];
            if (item.Tag is GroupThumbnailInfo info && info.Objects.Count > 0)
            {
                ShowGroupPreviewDialog(info);
            }
        }

        // ç¾¤çµ„ç¸®åœ–å³éµé¸å–®ï¼ˆæ”¯æ´å¤šé¸ï¼‰
        private void lvGroupThumbnails_MouseUp(object sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            if (lvGroupThumbnails.SelectedItems.Count == 0)
                return;

            // æ”¶é›†æ‰€æœ‰é¸ä¸­ç¾¤çµ„çš„è³‡è¨Š
            var selectedInfos = new List<GroupThumbnailInfo>();
            int totalObjects = 0;
            foreach (ListViewItem item in lvGroupThumbnails.SelectedItems)
            {
                if (item.Tag is GroupThumbnailInfo info && info.Objects.Count > 0)
                {
                    selectedInfos.Add(info);
                    totalObjects += info.Objects.Count;
                }
            }

            if (selectedInfos.Count == 0)
                return;

            // å»ºç«‹å³éµé¸å–®
            ContextMenuStrip menu = new ContextMenuStrip();

            if (selectedInfos.Count == 1)
            {
                // å–®é¸æ¨¡å¼ - é¡¯ç¤ºåŸæœ‰é¸é …
                var info = selectedInfos[0];

                ToolStripMenuItem copyItem = new ToolStripMenuItem($"è¤‡è£½ç¾¤çµ„ {info.GroupId}");
                copyItem.Click += (s, ev) => CopyGroupToClipboard(info);

                ToolStripMenuItem gotoItem = new ToolStripMenuItem("è·³è½‰åˆ°ä½ç½®");
                gotoItem.Click += (s, ev) => JumpToGroupLocation(info);

                ToolStripMenuItem detailItem = new ToolStripMenuItem($"åˆ—å‡º L4 æ˜ç´° ({info.Objects.Count} å€‹ç‰©ä»¶)");
                detailItem.Click += (s, ev) => ShowLayer4Details(info);

                ToolStripMenuItem deleteItem = new ToolStripMenuItem($"åˆªé™¤ç¾¤çµ„ {info.GroupId} ({info.Objects.Count} å€‹ç‰©ä»¶)");
                deleteItem.Click += (s, ev) => DeleteGroupFromMap(info);

                menu.Items.Add(copyItem);
                menu.Items.Add(gotoItem);
                menu.Items.Add(detailItem);
                menu.Items.Add(new ToolStripSeparator());

                ToolStripMenuItem saveMaterialItem = new ToolStripMenuItem($"å„²å­˜ç¾¤çµ„ {info.GroupId} ç‚ºç´ æ...");
                saveMaterialItem.Click += (s, ev) => SaveGroupsAsMaterial(new List<GroupThumbnailInfo> { info });
                menu.Items.Add(saveMaterialItem);

                menu.Items.Add(new ToolStripSeparator());
                menu.Items.Add(deleteItem);

                // è®Šæ›´ç¾¤çµ„ ID é¸é …
                menu.Items.Add(new ToolStripSeparator());

                ToolStripMenuItem changeIdItem = new ToolStripMenuItem($"è®Šæ›´ç¾¤çµ„ {info.GroupId} çš„ ID...");
                changeIdItem.Click += (s, ev) => ChangeGroupId(selectedInfos, false);

                ToolStripMenuItem autoNewIdItem = new ToolStripMenuItem($"è‡ªå‹•æŒ‡å®šæ–°ç¾¤çµ„ ID");
                autoNewIdItem.Click += (s, ev) => ChangeGroupId(selectedInfos, true);

                menu.Items.Add(changeIdItem);
                menu.Items.Add(autoNewIdItem);

                // Layer5 è¨­å®šé¸é …ï¼ˆåƒ…åœ¨é€æ˜ç·¨è¼¯æ¨¡å¼æˆ–æœ‰é¸å–æ ¼å­æ™‚é¡¯ç¤ºï¼‰
                if (_editState.IsLayer5EditMode && _editState.SelectedCells.Count > 0)
                {
                    menu.Items.Add(new ToolStripSeparator());

                    ToolStripMenuItem setTransparentItem = new ToolStripMenuItem($"è¨­å®šç¾¤çµ„ {info.GroupId} ç‚ºé€æ˜ (Type=0)");
                    setTransparentItem.Click += (s, ev) => SetGroupLayer5Setting(new List<GroupThumbnailInfo> { info }, 0);

                    ToolStripMenuItem setDisappearItem = new ToolStripMenuItem($"è¨­å®šç¾¤çµ„ {info.GroupId} ç‚ºæ¶ˆå¤± (Type=1)");
                    setDisappearItem.Click += (s, ev) => SetGroupLayer5Setting(new List<GroupThumbnailInfo> { info }, 1);

                    ToolStripMenuItem removeLayer5Item = new ToolStripMenuItem($"ç§»é™¤ç¾¤çµ„ {info.GroupId} çš„ Layer5 è¨­å®š");
                    removeLayer5Item.Click += (s, ev) => RemoveGroupLayer5Setting(new List<GroupThumbnailInfo> { info });

                    menu.Items.Add(setTransparentItem);
                    menu.Items.Add(setDisappearItem);
                    menu.Items.Add(removeLayer5Item);
                }
            }
            else
            {
                // å¤šé¸æ¨¡å¼ - é¡¯ç¤ºæ‰¹æ¬¡æ“ä½œé¸é …
                string groupIds = string.Join(", ", selectedInfos.Select(i => i.GroupId));

                ToolStripMenuItem copyItem = new ToolStripMenuItem($"è¤‡è£½ {selectedInfos.Count} å€‹ç¾¤çµ„ ({totalObjects} å€‹ç‰©ä»¶)");
                copyItem.Click += (s, ev) => CopyMultipleGroupsToClipboard(selectedInfos);

                ToolStripMenuItem deleteItem = new ToolStripMenuItem($"åˆªé™¤ {selectedInfos.Count} å€‹ç¾¤çµ„ ({totalObjects} å€‹ç‰©ä»¶)");
                deleteItem.Click += (s, ev) => DeleteMultipleGroupsFromMap(selectedInfos);

                menu.Items.Add(copyItem);
                menu.Items.Add(new ToolStripSeparator());

                ToolStripMenuItem saveMaterialItem = new ToolStripMenuItem($"å„²å­˜ {selectedInfos.Count} å€‹ç¾¤çµ„ç‚ºç´ æ...");
                saveMaterialItem.Click += (s, ev) => SaveGroupsAsMaterial(selectedInfos);
                menu.Items.Add(saveMaterialItem);

                menu.Items.Add(new ToolStripSeparator());
                menu.Items.Add(deleteItem);

                // è®Šæ›´ç¾¤çµ„ ID é¸é …
                menu.Items.Add(new ToolStripSeparator());

                ToolStripMenuItem changeIdItem = new ToolStripMenuItem($"è®Šæ›´ {selectedInfos.Count} å€‹ç¾¤çµ„çš„ ID...");
                changeIdItem.Click += (s, ev) => ChangeGroupId(selectedInfos, false);

                ToolStripMenuItem autoNewIdItem = new ToolStripMenuItem($"è‡ªå‹•æŒ‡å®šæ–°ç¾¤çµ„ IDï¼ˆå„è‡ªç¨ç«‹ï¼‰");
                autoNewIdItem.Click += (s, ev) => ChangeGroupId(selectedInfos, true);

                menu.Items.Add(changeIdItem);
                menu.Items.Add(autoNewIdItem);

                // Layer5 è¨­å®šé¸é …ï¼ˆåƒ…åœ¨é€æ˜ç·¨è¼¯æ¨¡å¼æˆ–æœ‰é¸å–æ ¼å­æ™‚é¡¯ç¤ºï¼‰
                if (_editState.IsLayer5EditMode && _editState.SelectedCells.Count > 0)
                {
                    menu.Items.Add(new ToolStripSeparator());

                    ToolStripMenuItem setTransparentItem = new ToolStripMenuItem($"è¨­å®š {selectedInfos.Count} å€‹ç¾¤çµ„ç‚ºé€æ˜ (Type=0)");
                    setTransparentItem.Click += (s, ev) => SetGroupLayer5Setting(selectedInfos, 0);

                    ToolStripMenuItem setDisappearItem = new ToolStripMenuItem($"è¨­å®š {selectedInfos.Count} å€‹ç¾¤çµ„ç‚ºæ¶ˆå¤± (Type=1)");
                    setDisappearItem.Click += (s, ev) => SetGroupLayer5Setting(selectedInfos, 1);

                    ToolStripMenuItem removeLayer5Item = new ToolStripMenuItem($"ç§»é™¤ {selectedInfos.Count} å€‹ç¾¤çµ„çš„ Layer5 è¨­å®š");
                    removeLayer5Item.Click += (s, ev) => RemoveGroupLayer5Setting(selectedInfos);

                    menu.Items.Add(setTransparentItem);
                    menu.Items.Add(setDisappearItem);
                    menu.Items.Add(removeLayer5Item);
                }
            }

            menu.Show(lvGroupThumbnails, e.Location);
        }

        // å¾åœ°åœ–åˆªé™¤å¤šå€‹ç¾¤çµ„
        private void DeleteMultipleGroupsFromMap(List<GroupThumbnailInfo> infos)
        {
            // æ”¶é›†æ‰€æœ‰è¦åˆªé™¤çš„ç‰©ä»¶
            var allObjects = new List<(S32Data s32, ObjectTile obj)>();
            foreach (var info in infos)
            {
                allObjects.AddRange(info.Objects);
            }

            if (allObjects.Count == 0)
            {
                MessageBox.Show("é¸å–çš„ç¾¤çµ„å…§æ²’æœ‰ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            string groupIds = string.Join(", ", infos.Select(i => i.GroupId));

            // ç¢ºèªåˆªé™¤
            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤ {infos.Count} å€‹ç¾¤çµ„å—ï¼Ÿ\n" +
                $"ç¾¤çµ„ ID: {groupIds}\n" +
                $"é€™å°‡ç§»é™¤é¸å–å€åŸŸå…§çš„ {allObjects.Count} å€‹ Layer4 ç‰©ä»¶ã€‚",
                "ç¢ºèªåˆªé™¤å¤šå€‹ç¾¤çµ„",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result != DialogResult.Yes)
                return;

            // å»ºç«‹ Undo è¨˜éŒ„
            var undoAction = new UndoAction
            {
                Description = $"åˆªé™¤ {infos.Count} å€‹ç¾¤çµ„ ({allObjects.Count} å€‹ç‰©ä»¶)"
            };

            // åˆªé™¤ç‰©ä»¶
            int deletedCount = 0;
            foreach (var (s32Data, obj) in allObjects)
            {
                // è¨˜éŒ„åˆ° Undo
                undoAction.RemovedObjects.Add(new UndoObjectInfo
                {
                    S32FilePath = s32Data.FilePath,
                    GameX = s32Data.SegInfo.nLinBeginX + obj.X / 2,
                    GameY = s32Data.SegInfo.nLinBeginY + obj.Y,
                    LocalX = obj.X,
                    LocalY = obj.Y,
                    GroupId = obj.GroupId,
                    Layer = obj.Layer,
                    IndexId = obj.IndexId,
                    TileId = obj.TileId
                });

                s32Data.Layer4.Remove(obj);
                Layer4Index_Remove(s32Data, obj);
                s32Data.IsModified = true;
                deletedCount++;
            }

            // è¨˜éŒ„ Undo
            PushUndoAction(undoAction);

            // æ¸…é™¤å·²åˆªé™¤ç¾¤çµ„çš„é¸å–ç‹€æ…‹
            foreach (var info in infos)
            {
                _editState.SelectedLayer4Groups.Remove(info.GroupId);
            }

            // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨
            if (_editState.SelectedCells.Count > 0)
            {
                UpdateGroupThumbnailsList(_editState.SelectedCells);
            }
            else
            {
                UpdateGroupThumbnailsList();
            }

            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ {infos.Count} å€‹ç¾¤çµ„ï¼Œå…± {deletedCount} å€‹ç‰©ä»¶";
        }

        // å¾åœ°åœ–åˆªé™¤ç¾¤çµ„ï¼ˆåªåˆªé™¤ info.Objects ä¸­çš„ç‰©ä»¶ï¼Œå³é¸å–å€åŸŸå…§çš„ç‰©ä»¶ï¼‰
        private void DeleteGroupFromMap(GroupThumbnailInfo info)
        {
            int groupId = info.GroupId;

            // ä½¿ç”¨ info.Objectsï¼ˆå·²ç¶“æ˜¯é¸å–å€åŸŸçš„äº¤é›†ï¼‰
            if (info.Objects == null || info.Objects.Count == 0)
            {
                MessageBox.Show($"ç¾¤çµ„ {groupId} åœ¨é¸å–å€åŸŸå…§æ²’æœ‰ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int totalCount = info.Objects.Count;

            // ç¢ºèªåˆªé™¤
            DialogResult result = MessageBox.Show(
                $"ç¢ºå®šè¦åˆªé™¤ç¾¤çµ„ {groupId} å—ï¼Ÿ\n" +
                $"é€™å°‡ç§»é™¤é¸å–å€åŸŸå…§çš„ {totalCount} å€‹ Layer4 ç‰©ä»¶ã€‚",
                "ç¢ºèªåˆªé™¤ç¾¤çµ„",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (result != DialogResult.Yes)
                return;

            // å»ºç«‹ Undo è¨˜éŒ„
            var undoAction = new UndoAction
            {
                Description = $"åˆªé™¤ç¾¤çµ„ {groupId} ({totalCount} å€‹ç‰©ä»¶)"
            };

            // åªåˆªé™¤ info.Objects ä¸­çš„ç‰©ä»¶ï¼ˆé¸å–å€åŸŸå…§çš„ç‰©ä»¶ï¼‰
            int deletedCount = 0;
            foreach (var (s32Data, obj) in info.Objects)
            {
                // è¨˜éŒ„åˆ° Undo
                undoAction.RemovedObjects.Add(new UndoObjectInfo
                {
                    S32FilePath = s32Data.FilePath,
                    GameX = s32Data.SegInfo.nLinBeginX + obj.X / 2,
                    GameY = s32Data.SegInfo.nLinBeginY + obj.Y,
                    LocalX = obj.X,
                    LocalY = obj.Y,
                    GroupId = obj.GroupId,
                    Layer = obj.Layer,
                    IndexId = obj.IndexId,
                    TileId = obj.TileId
                });

                // åˆªé™¤ç‰©ä»¶
                if (s32Data.Layer4.Remove(obj))
                {
                    Layer4Index_Remove(s32Data, obj);
                    deletedCount++;
                    s32Data.IsModified = true;
                }
            }

            // å„²å­˜ Undo è¨˜éŒ„
            if (undoAction.RemovedObjects.Count > 0)
            {
                PushUndoAction(undoAction);
            }

            // æ¸…é™¤å·²åˆªé™¤ç¾¤çµ„çš„é¸å–ç‹€æ…‹
            _editState.SelectedLayer4Groups.Remove(groupId);

            // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ¸²æŸ“ï¼ˆRenderS32Map å…§éƒ¨æœƒåœ¨å®Œæˆå¾Œè‡ªå‹• Invalidateï¼‰
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨ï¼ˆä¿æŒé¸å–å€åŸŸçš„äº¤é›†ï¼‰
            if (_editState.SelectedCells != null && _editState.SelectedCells.Count > 0)
            {
                UpdateGroupThumbnailsList(_editState.SelectedCells);
            }
            else
            {
                UpdateGroupThumbnailsList();
            }

            this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ç¾¤çµ„ {groupId}ï¼Œå…± {deletedCount} å€‹ç‰©ä»¶";
        }

        // å„²å­˜ç¾¤çµ„ç‚ºç´ æ
        private void SaveGroupsAsMaterial(List<GroupThumbnailInfo> infos)
        {
            if (infos == null || infos.Count == 0)
                return;

            // æ”¶é›†æ‰€æœ‰ç‰©ä»¶
            var allObjects = new List<(S32Data s32, ObjectTile obj)>();
            foreach (var info in infos)
            {
                allObjects.AddRange(info.Objects);
            }

            if (allObjects.Count == 0)
            {
                MessageBox.Show("é¸å–çš„ç¾¤çµ„å…§æ²’æœ‰ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // é è¨­ç´ æåç¨±
            string defaultName = infos.Count == 1
                ? $"ç¾¤çµ„_{infos[0].GroupId}"
                : $"ç¾¤çµ„_{string.Join("_", infos.Take(3).Select(i => i.GroupId))}";

            using (var dialog = new L1MapViewer.Forms.ExportOptionsDialog(isFs3p: true, hasSelection: true))
            {
                if (dialog.ShowDialog() != DialogResult.OK)
                    return;

                try
                {
                    // è¨ˆç®—ç‰©ä»¶çš„ä¸–ç•Œåº§æ¨™ç¯„åœ
                    int minWorldX = int.MaxValue, minWorldY = int.MaxValue;
                    int maxWorldX = int.MinValue, maxWorldY = int.MinValue;

                    foreach (var (s32, obj) in allObjects)
                    {
                        int worldX = s32.SegInfo.nLinBeginX * 2 + obj.X;
                        int worldY = s32.SegInfo.nLinBeginY + obj.Y;
                        if (worldX < minWorldX) minWorldX = worldX;
                        if (worldY < minWorldY) minWorldY = worldY;
                        if (worldX > maxWorldX) maxWorldX = worldX;
                        if (worldY > maxWorldY) maxWorldY = worldY;
                    }

                    // å»ºç«‹ fs3p è³‡æ–™ - OriginOffset è¨­ç‚º 0,0ï¼ˆRelativeX/Y å·²ç¶“æ˜¯ç›¸å°åº§æ¨™ï¼‰
                    var fs3p = new Fs3pData
                    {
                        Name = dialog.MaterialName,
                        LayerFlags = (ushort)(dialog.LayerFlags & 0x08), // åªä¿ç•™ Layer4 flag
                        OriginOffsetX = 0,
                        OriginOffsetY = 0,
                        Width = maxWorldX - minWorldX + 1,
                        Height = maxWorldY - minWorldY + 1
                    };
                    fs3p.SetCreatedNow();

                    // æ”¶é›†ä½¿ç”¨çš„ TileIds å’Œ GroupId é‡æ–°ç·¨è™Ÿ
                    HashSet<int> usedTileIds = new HashSet<int>();
                    Dictionary<int, int> groupIdMapping = new Dictionary<int, int>();
                    int nextGroupId = 0;

                    foreach (var (s32, obj) in allObjects)
                    {
                        int relX = s32.SegInfo.nLinBeginX * 2 + obj.X - minWorldX;
                        int relY = s32.SegInfo.nLinBeginY + obj.Y - minWorldY;

                        // é‡æ–°ç·¨è™Ÿ GroupId
                        if (!groupIdMapping.TryGetValue(obj.GroupId, out int newGroupId))
                        {
                            newGroupId = nextGroupId++;
                            groupIdMapping[obj.GroupId] = newGroupId;
                        }

                        fs3p.Layer4Items.Add(new Fs3pLayer4Item
                        {
                            RelativeX = relX,
                            RelativeY = relY,
                            GroupId = newGroupId,
                            Layer = (byte)obj.Layer,
                            IndexId = (byte)obj.IndexId,
                            TileId = (ushort)obj.TileId
                        });

                        if (obj.TileId > 0)
                            usedTileIds.Add(obj.TileId);
                    }

                    // æ‰“åŒ… Tiles
                    if (dialog.IncludeTiles)
                    {
                        foreach (int tileId in usedTileIds)
                        {
                            byte[] tilData = L1PakReader.UnPack("Tile", $"{tileId}.til");
                            if (tilData != null)
                            {
                                fs3p.Tiles[tileId] = new TilePackageData
                                {
                                    OriginalTileId = tileId,
                                    Md5Hash = TileHashManager.CalculateMd5(tilData),
                                    TilData = tilData
                                };
                            }
                        }

                        // æª¢æŸ¥ä¸¦è™•ç† Rç‰ˆ tiles
                        if (fs3p.Tiles.Count > 0)
                        {
                            int remasterCount = fs3p.Tiles.Values.Count(t => L1MapViewer.Converter.L1Til.IsRemaster(t.TilData));
                            if (remasterCount > 0)
                            {
                                var result = MessageBox.Show(
                                    $"ç´ æä¸­æœ‰ {remasterCount} å€‹ Rç‰ˆ (48x48) åœ–å¡Šã€‚\n\n" +
                                    "æ˜¯å¦è¦è½‰æ›ç‚ºå¤©1æ ¼å¼ (24x24)ï¼Ÿ\n\n" +
                                    "â€¢ æ˜¯ - è½‰æ›ç‚ºå¤©1æ ¼å¼ (æª”æ¡ˆè¼ƒå°ï¼Œç›¸å®¹èˆŠç‰ˆ)\n" +
                                    "â€¢ å¦ - ä¿ç•™ Rç‰ˆæ ¼å¼",
                                    "Rç‰ˆåœ–å¡Šåµæ¸¬",
                                    MessageBoxButtons.YesNo,
                                    MessageBoxIcon.Question,
                                    MessageBoxDefaultButton.Button1);  // é è¨­é¸ã€Œæ˜¯ã€

                                if (result == DialogResult.Yes)
                                {
                                    // è½‰æ›æ‰€æœ‰ Rç‰ˆ tiles ç‚º å¤©1 æ ¼å¼
                                    foreach (var tileId in fs3p.Tiles.Keys.ToList())
                                    {
                                        var tile = fs3p.Tiles[tileId];
                                        if (L1MapViewer.Converter.L1Til.IsRemaster(tile.TilData))
                                        {
                                            tile.TilData = L1MapViewer.Converter.L1Til.DownscaleTil(tile.TilData);
                                            tile.Md5Hash = TileHashManager.CalculateMd5(tile.TilData);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // ç”¢ç”Ÿç¸®åœ–
                    Bitmap thumbnail = GenerateGroupsThumbnail(infos, 128);
                    if (thumbnail != null)
                    {
                        using (var ms = new MemoryStream())
                        {
                            thumbnail.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                            fs3p.ThumbnailPng = ms.ToArray();
                        }
                        thumbnail.Dispose();
                    }

                    // å„²å­˜åˆ°ç´ æåº«
                    var library = new MaterialLibrary();
                    string savedPath = library.SaveMaterial(fs3p);

                    toolStripStatusLabel1.Text = $"å·²å„²å­˜ç´ æ: {dialog.MaterialName} ({fs3p.Layer4Items.Count} å€‹ç‰©ä»¶, {fs3p.Tiles.Count} åœ–å¡Š)";

                    // æ›´æ–°ç´ æé¢æ¿
                    RefreshMaterialsList();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"å„²å­˜ç´ æå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // ç”¢ç”Ÿå¤šå€‹ç¾¤çµ„çš„åˆä½µç¸®åœ–
        private Bitmap GenerateGroupsThumbnail(List<GroupThumbnailInfo> infos, int maxSize)
        {
            if (infos == null || infos.Count == 0)
                return null;

            try
            {
                // æ”¶é›†æ‰€æœ‰ç‰©ä»¶
                var allObjects = new List<(S32Data s32, ObjectTile obj)>();
                foreach (var info in infos)
                {
                    allObjects.AddRange(info.Objects);
                }

                if (allObjects.Count == 0)
                    return null;

                // ä½¿ç”¨ç¾æœ‰çš„ç¾¤çµ„ç¸®åœ–ç”Ÿæˆæ–¹æ³•
                return GenerateGroupThumbnail(allObjects, maxSize);
            }
            catch
            {
                return null;
            }
        }

        // è¨­å®šç¾¤çµ„çš„ Layer5 è¨­å®šï¼ˆé€æ˜æˆ–æ¶ˆå¤±ï¼‰
        private void SetGroupLayer5Setting(List<GroupThumbnailInfo> infos, byte type)
        {
            if (_editState.SelectedCells.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆé¸å–æ ¼å­", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int addedCount = 0;
            int updatedCount = 0;
            var groupIds = infos.Select(i => i.GroupId).ToHashSet();

            foreach (var cell in _editState.SelectedCells)
            {
                var s32Data = cell.S32Data;
                // Layer5 çš„ X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆLocalX å’Œ LocalX+1ï¼‰
                int layer5X1 = cell.LocalX;
                int layer5X2 = cell.LocalX + 1;
                int layer5Y = cell.LocalY;

                foreach (var groupId in groupIds)
                {
                    // æª¢æŸ¥å…©å€‹ X åº§æ¨™æ˜¯å¦å·²å­˜åœ¨ Layer5 è¨­å®š
                    for (int layer5X = layer5X1; layer5X <= layer5X2 && layer5X < 128; layer5X++)
                    {
                        var existingItem = s32Data.Layer5.FirstOrDefault(l =>
                            l.X == layer5X && l.Y == layer5Y && l.ObjectIndex == groupId);

                        if (existingItem != null)
                        {
                            // æ›´æ–°ç¾æœ‰é …ç›®
                            if (existingItem.Type != type)
                            {
                                existingItem.Type = type;
                                updatedCount++;
                                s32Data.IsModified = true;
                            }
                        }
                        else
                        {
                            // æ–°å¢ Layer5 é …ç›®
                            s32Data.Layer5.Add(new Layer5Item
                            {
                                X = (byte)layer5X,
                                Y = (byte)layer5Y,
                                ObjectIndex = (ushort)groupId,
                                Type = type
                            });
                            addedCount++;
                            s32Data.IsModified = true;
                        }
                    }
                }
            }

            // é‡æ–°æ¸²æŸ“
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹é¸å–æ ¼å­çš„è³‡è¨Šï¼‰
            if (_editState.SelectedCells.Count > 0)
            {
                var firstCell = _editState.SelectedCells[0];
                UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
            }

            string typeStr = type == 0 ? "é€æ˜" : "æ¶ˆå¤±";
            string message = $"å·²è¨­å®š {infos.Count} å€‹ç¾¤çµ„ç‚º{typeStr}";
            if (addedCount > 0) message += $"ï¼Œæ–°å¢ {addedCount} ç­†";
            if (updatedCount > 0) message += $"ï¼Œæ›´æ–° {updatedCount} ç­†";
            this.toolStripStatusLabel1.Text = message;
        }

        // ç§»é™¤ç¾¤çµ„çš„ Layer5 è¨­å®š
        private void RemoveGroupLayer5Setting(List<GroupThumbnailInfo> infos)
        {
            if (_editState.SelectedCells.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆé¸å–æ ¼å­", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int removedCount = 0;
            var groupIds = infos.Select(i => i.GroupId).ToHashSet();

            foreach (var cell in _editState.SelectedCells)
            {
                var s32Data = cell.S32Data;
                // Layer5 çš„ X æ˜¯ 0-127 (Layer1 åº§æ¨™)ï¼ŒY æ˜¯ 0-63
                // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼ˆLocalX å’Œ LocalX+1ï¼‰
                int layer5X1 = cell.LocalX;
                int layer5X2 = cell.LocalX + 1;
                int layer5Y = cell.LocalY;

                // æ‰¾å‡ºä¸¦ç§»é™¤ç¬¦åˆæ¢ä»¶çš„ Layer5 é …ç›®ï¼ˆå…©å€‹ X åº§æ¨™éƒ½è¦æª¢æŸ¥ï¼‰
                var itemsToRemove = s32Data.Layer5
                    .Where(l => (l.X == layer5X1 || l.X == layer5X2) && l.Y == layer5Y && groupIds.Contains(l.ObjectIndex))
                    .ToList();

                foreach (var item in itemsToRemove)
                {
                    s32Data.Layer5.Remove(item);
                    removedCount++;
                    s32Data.IsModified = true;
                }
            }

            // é‡æ–°æ¸²æŸ“
            ClearS32BlockCache();
            RenderS32Map();

            // æ›´æ–° Layer5 ç•°å¸¸æª¢æŸ¥æŒ‰éˆ•
            UpdateLayer5InvalidButton();

            // æ›´æ–°ç¾¤çµ„ç¸®åœ–åˆ—è¡¨ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹é¸å–æ ¼å­çš„è³‡è¨Šï¼‰
            if (_editState.SelectedCells.Count > 0)
            {
                var firstCell = _editState.SelectedCells[0];
                UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
            }

            this.toolStripStatusLabel1.Text = $"å·²ç§»é™¤ {removedCount} ç­† Layer5 è¨­å®š";
        }

        // è®Šæ›´ç¾¤çµ„ ID
        private void ChangeGroupId(List<GroupThumbnailInfo> infos, bool autoAssign)
        {
            if (infos.Count == 0)
                return;

            // æ”¶é›†æ‰€æœ‰æ¶‰åŠçš„ S32 æª”æ¡ˆ
            var affectedS32Files = new HashSet<S32Data>();
            foreach (var info in infos)
            {
                foreach (var (s32, obj) in info.Objects)
                {
                    affectedS32Files.Add(s32);
                }
            }

            if (affectedS32Files.Count == 0)
            {
                MessageBox.Show("é¸å–çš„ç¾¤çµ„å…§æ²’æœ‰ç‰©ä»¶ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ‰¾å‡ºæ‰€æœ‰ S32 ä¸­çš„æœ€å¤§ç¾¤çµ„ ID
            int maxGroupId = 0;
            foreach (var s32 in affectedS32Files)
            {
                foreach (var obj in s32.Layer4)
                {
                    if (obj.GroupId > maxGroupId)
                        maxGroupId = obj.GroupId;
                }
            }

            int newGroupId;
            if (autoAssign)
            {
                // è‡ªå‹•æŒ‡å®šï¼šæœ€å¤§ ID + 1
                newGroupId = maxGroupId + 1;
            }
            else
            {
                // è®“ä½¿ç”¨è€…è¼¸å…¥ ID
                string oldIds = string.Join(", ", infos.Select(i => i.GroupId).Distinct());
                string prompt = infos.Count == 1
                    ? $"å°‡ç¾¤çµ„ {infos[0].GroupId} è®Šæ›´ç‚ºæ–°çš„ IDï¼š"
                    : $"å°‡ {infos.Count} å€‹ç¾¤çµ„ ({oldIds}) è®Šæ›´ç‚ºåŒä¸€å€‹æ–° IDï¼š";

                using (var inputForm = new Form())
                {
                    inputForm.Text = "è®Šæ›´ç¾¤çµ„ ID";
                    inputForm.Size = new Size(350, 180);
                    inputForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                    inputForm.MaximizeBox = false;
                    inputForm.MinimizeBox = false;
                    inputForm.StartPosition = FormStartPosition.CenterParent;

                    Label lblPrompt = new Label
                    {
                        Text = prompt,
                        Location = new Point(15, 15),
                        Size = new Size(310, 40)
                    };

                    Label lblCurrentMax = new Label
                    {
                        Text = $"ï¼ˆç›®å‰æœ€å¤§ç¾¤çµ„ ID: {maxGroupId}ï¼‰",
                        Location = new Point(15, 55),
                        Size = new Size(200, 20),
                        ForeColor = Color.Gray
                    };

                    TextBox txtNewId = new TextBox
                    {
                        Location = new Point(15, 80),
                        Size = new Size(150, 24),
                        Text = (maxGroupId + 1).ToString()
                    };

                    Button btnOk = new Button
                    {
                        Text = "ç¢ºå®š",
                        Location = new Point(170, 100),
                        Size = new Size(75, 28),
                        DialogResult = DialogResult.OK
                    };

                    Button btnCancel = new Button
                    {
                        Text = "å–æ¶ˆ",
                        Location = new Point(255, 100),
                        Size = new Size(75, 28),
                        DialogResult = DialogResult.Cancel
                    };

                    inputForm.AcceptButton = btnOk;
                    inputForm.CancelButton = btnCancel;
                    inputForm.Controls.AddRange(new Control[] { lblPrompt, lblCurrentMax, txtNewId, btnOk, btnCancel });

                    if (inputForm.ShowDialog(this) != DialogResult.OK)
                        return;

                    if (!int.TryParse(txtNewId.Text, out newGroupId) || newGroupId < 0)
                    {
                        MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¾¤çµ„ IDï¼ˆéè² æ•´æ•¸ï¼‰", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                }
            }

            // å»ºç«‹ Undo å‹•ä½œ
            var undoAction = new UndoAction
            {
                Description = $"è®Šæ›´ {infos.Count} å€‹ç¾¤çµ„çš„ ID"
            };

            int changedCount = 0;
            var oldGroupIds = infos.Select(i => i.GroupId).ToHashSet();

            // å¦‚æœæ˜¯å¤šé¸ä¸”è‡ªå‹•æŒ‡å®šï¼Œæ¯å€‹ç¾¤çµ„åˆ†é…ä¸åŒçš„æ–° ID
            if (autoAssign && infos.Count > 1)
            {
                int nextId = newGroupId;
                foreach (var info in infos)
                {
                    int oldId = info.GroupId;
                    int assignedId = nextId++;

                    foreach (var (s32, obj) in info.Objects)
                    {
                        // è¨˜éŒ„ Undo è³‡è¨Š
                        undoAction.RemovedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = s32.FilePath,
                            GroupId = oldId,
                            LocalX = obj.X,
                            LocalY = obj.Y,
                            Layer = obj.Layer,
                            IndexId = obj.IndexId,
                            TileId = obj.TileId
                        });

                        // è®Šæ›´ GroupId
                        obj.GroupId = assignedId;
                        s32.IsModified = true;
                        changedCount++;

                        // è¨˜éŒ„æ–°ç‹€æ…‹
                        undoAction.AddedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = s32.FilePath,
                            GroupId = assignedId,
                            LocalX = obj.X,
                            LocalY = obj.Y,
                            Layer = obj.Layer,
                            IndexId = obj.IndexId,
                            TileId = obj.TileId
                        });
                    }

                    // åŒæ™‚æ›´æ–° Layer5 ä¸­çš„ ObjectIndex
                    foreach (var s32 in affectedS32Files)
                    {
                        foreach (var l5Item in s32.Layer5)
                        {
                            if (l5Item.ObjectIndex == oldId)
                            {
                                l5Item.ObjectIndex = (ushort)assignedId;
                            }
                        }
                    }
                }

                _editState.PushUndoAction(undoAction);

                // é‡æ–°æ¸²æŸ“
                ClearS32BlockCache();
                RenderS32Map();

                // æ›´æ–°ç¾¤çµ„åˆ—è¡¨
                if (_editState.SelectedCells.Count > 0)
                {
                    var firstCell = _editState.SelectedCells[0];
                    UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
                }

                this.toolStripStatusLabel1.Text = $"å·²å°‡ {infos.Count} å€‹ç¾¤çµ„è®Šæ›´ç‚ºæ–° IDï¼ˆ{newGroupId} ~ {nextId - 1}ï¼‰ï¼Œå…± {changedCount} å€‹ç‰©ä»¶";
            }
            else
            {
                // å–®é¸æˆ–å¤šé¸åˆä½µç‚ºåŒä¸€ ID
                foreach (var info in infos)
                {
                    int oldId = info.GroupId;

                    foreach (var (s32, obj) in info.Objects)
                    {
                        // è¨˜éŒ„ Undo è³‡è¨Š
                        undoAction.RemovedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = s32.FilePath,
                            GroupId = oldId,
                            LocalX = obj.X,
                            LocalY = obj.Y,
                            Layer = obj.Layer,
                            IndexId = obj.IndexId,
                            TileId = obj.TileId
                        });

                        // è®Šæ›´ GroupId
                        obj.GroupId = newGroupId;
                        s32.IsModified = true;
                        changedCount++;

                        // è¨˜éŒ„æ–°ç‹€æ…‹
                        undoAction.AddedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = s32.FilePath,
                            GroupId = newGroupId,
                            LocalX = obj.X,
                            LocalY = obj.Y,
                            Layer = obj.Layer,
                            IndexId = obj.IndexId,
                            TileId = obj.TileId
                        });
                    }

                    // åŒæ™‚æ›´æ–° Layer5 ä¸­çš„ ObjectIndex
                    foreach (var s32 in affectedS32Files)
                    {
                        foreach (var l5Item in s32.Layer5)
                        {
                            if (l5Item.ObjectIndex == oldId)
                            {
                                l5Item.ObjectIndex = (ushort)newGroupId;
                            }
                        }
                    }
                }

                _editState.PushUndoAction(undoAction);

                // é‡æ–°æ¸²æŸ“
                ClearS32BlockCache();
                RenderS32Map();

                // æ›´æ–°ç¾¤çµ„åˆ—è¡¨
                if (_editState.SelectedCells.Count > 0)
                {
                    var firstCell = _editState.SelectedCells[0];
                    UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
                }

                string oldIdsStr = string.Join(", ", oldGroupIds);
                this.toolStripStatusLabel1.Text = $"å·²å°‡ç¾¤çµ„ {oldIdsStr} è®Šæ›´ç‚º {newGroupId}ï¼Œå…± {changedCount} å€‹ç‰©ä»¶";
            }
        }

        // é¡¯ç¤º Layer4 ç¾¤çµ„æ˜ç´°å°è©±æ¡†
        private void ShowLayer4Details(GroupThumbnailInfo info)
        {
            if (info == null || info.Objects.Count == 0)
                return;

            using (var form = new Form())
            {
                form.Text = $"ç¾¤çµ„ {info.GroupId} - L4 æ˜ç´° ({info.Objects.Count} å€‹ç‰©ä»¶)";
                form.Size = new Size(700, 500);
                form.StartPosition = FormStartPosition.CenterParent;
                form.MinimizeBox = false;

                // ListView é¡¯ç¤ºç‰©ä»¶åˆ—è¡¨
                var listView = new ListView
                {
                    Dock = DockStyle.Fill,
                    View = View.Details,
                    FullRowSelect = true,
                    GridLines = true,
                    CheckBoxes = true
                };

                listView.Columns.Add("", 30);  // å‹¾é¸æ¬„
                listView.Columns.Add("S32 æª”æ¡ˆ", 120);
                listView.Columns.Add("X (L1)", 60);
                listView.Columns.Add("Y (L1)", 60);
                listView.Columns.Add("Layer", 50);
                listView.Columns.Add("IndexId", 70);
                listView.Columns.Add("TileId", 70);
                listView.Columns.Add("éŠæˆ²åº§æ¨™", 120);

                // å¡«å……è³‡æ–™
                foreach (var (s32, obj) in info.Objects)
                {
                    string fileName = System.IO.Path.GetFileName(s32.FilePath ?? "Unknown");

                    // è¨ˆç®—éŠæˆ²åº§æ¨™
                    string gameCoord = "";
                    if (!string.IsNullOrEmpty(s32.FilePath))
                    {
                        string fileNameWithoutExt = System.IO.Path.GetFileNameWithoutExtension(s32.FilePath);
                        if (fileNameWithoutExt.Length >= 8)
                        {
                            try
                            {
                                int blockX = Convert.ToInt32(fileNameWithoutExt.Substring(0, 4), 16);
                                int blockY = Convert.ToInt32(fileNameWithoutExt.Substring(4, 4), 16);
                                int nLinBeginX = (blockX - 0x7FFF) * 64 + 0x7FFF - 64 + 1;
                                int nLinBeginY = (blockY - 0x7FFF) * 64 + 0x7FFF - 64 + 1;
                                int gameX = nLinBeginX + obj.X / 2;
                                int gameY = nLinBeginY + obj.Y;
                                gameCoord = $"{gameX}, {gameY}";
                            }
                            catch { }
                        }
                    }

                    var item = new ListViewItem("");
                    item.SubItems.Add(fileName);
                    item.SubItems.Add(obj.X.ToString());
                    item.SubItems.Add(obj.Y.ToString());
                    item.SubItems.Add(obj.Layer.ToString());
                    item.SubItems.Add(obj.IndexId.ToString());
                    item.SubItems.Add(obj.TileId.ToString());
                    item.SubItems.Add(gameCoord);
                    item.Tag = (s32, obj);
                    listView.Items.Add(item);
                }

                // é›™æ“Šç·¨è¼¯é …ç›®
                listView.DoubleClick += (s, ev) =>
                {
                    if (listView.SelectedItems.Count == 0)
                        return;

                    var selectedItem = listView.SelectedItems[0];
                    if (!(selectedItem.Tag is (S32Data s32, ObjectTile obj)))
                        return;

                    // å»ºç«‹ç·¨è¼¯å°è©±æ¡†
                    using (var editForm = new Form())
                    {
                        editForm.Text = $"ç·¨è¼¯ç‰©ä»¶ - ç¾¤çµ„ {info.GroupId}";
                        editForm.Size = new Size(300, 290);
                        editForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                        editForm.MaximizeBox = false;
                        editForm.MinimizeBox = false;
                        editForm.StartPosition = FormStartPosition.CenterParent;

                        var lblX = new Label { Text = "X (L1):", Location = new Point(20, 25), Size = new Size(60, 20) };
                        var txtX = new TextBox { Text = obj.X.ToString(), Location = new Point(90, 22), Size = new Size(160, 22) };

                        var lblY = new Label { Text = "Y (L1):", Location = new Point(20, 60), Size = new Size(60, 20) };
                        var txtY = new TextBox { Text = obj.Y.ToString(), Location = new Point(90, 57), Size = new Size(160, 22) };

                        var lblLayer = new Label { Text = "Layer:", Location = new Point(20, 95), Size = new Size(60, 20) };
                        var txtLayer = new TextBox { Text = obj.Layer.ToString(), Location = new Point(90, 92), Size = new Size(160, 22) };

                        var lblIndexId = new Label { Text = "IndexId:", Location = new Point(20, 130), Size = new Size(60, 20) };
                        var txtIndexId = new TextBox { Text = obj.IndexId.ToString(), Location = new Point(90, 127), Size = new Size(160, 22) };

                        var lblTileId = new Label { Text = "TileId:", Location = new Point(20, 165), Size = new Size(60, 20) };
                        var txtTileId = new TextBox { Text = obj.TileId.ToString(), Location = new Point(90, 162), Size = new Size(160, 22) };

                        var btnOK = new Button { Text = "ç¢ºå®š", Location = new Point(90, 205), Size = new Size(75, 28), DialogResult = DialogResult.OK };
                        var btnCancel = new Button { Text = "å–æ¶ˆ", Location = new Point(175, 205), Size = new Size(75, 28), DialogResult = DialogResult.Cancel };

                        editForm.Controls.AddRange(new Control[] { lblX, txtX, lblY, txtY, lblLayer, txtLayer, lblIndexId, txtIndexId, lblTileId, txtTileId, btnOK, btnCancel });
                        editForm.AcceptButton = btnOK;
                        editForm.CancelButton = btnCancel;

                        if (editForm.ShowDialog(form) == DialogResult.OK)
                        {
                            if (!int.TryParse(txtX.Text, out int newX) ||
                                !int.TryParse(txtY.Text, out int newY) ||
                                !int.TryParse(txtLayer.Text, out int newLayer) ||
                                !int.TryParse(txtIndexId.Text, out int newIndexId) ||
                                !int.TryParse(txtTileId.Text, out int newTileId))
                            {
                                MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }

                            // é©—è­‰ç¯„åœ
                            if (newX < 0 || newX > 255 || newY < 0 || newY > 255)
                            {
                                MessageBox.Show("X å’Œ Y å¿…é ˆåœ¨ 0-255 ä¹‹é–“", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }

                            // è¨˜éŒ„ Undo
                            var undoAction = new UndoAction { Description = $"ç·¨è¼¯ç¾¤çµ„ {info.GroupId} ç‰©ä»¶" };
                            undoAction.RemovedObjects.Add(new UndoObjectInfo
                            {
                                S32FilePath = s32.FilePath,
                                GroupId = obj.GroupId,
                                LocalX = obj.X,
                                LocalY = obj.Y,
                                Layer = obj.Layer,
                                IndexId = obj.IndexId,
                                TileId = obj.TileId
                            });

                            // æ›´æ–°ç‰©ä»¶
                            obj.X = newX;
                            obj.Y = newY;
                            obj.Layer = newLayer;
                            obj.IndexId = newIndexId;
                            obj.TileId = newTileId;
                            s32.IsModified = true;

                            undoAction.AddedObjects.Add(new UndoObjectInfo
                            {
                                S32FilePath = s32.FilePath,
                                GroupId = obj.GroupId,
                                LocalX = newX,
                                LocalY = newY,
                                Layer = newLayer,
                                IndexId = newIndexId,
                                TileId = newTileId
                            });

                            _editState.PushUndoAction(undoAction);

                            // æ›´æ–° ListView
                            selectedItem.SubItems[2].Text = newX.ToString();
                            selectedItem.SubItems[3].Text = newY.ToString();
                            selectedItem.SubItems[4].Text = newLayer.ToString();
                            selectedItem.SubItems[5].Text = newIndexId.ToString();
                            selectedItem.SubItems[6].Text = newTileId.ToString();

                            // é‡æ–°è¨ˆç®—éŠæˆ²åº§æ¨™
                            string gameCoord = "";
                            if (!string.IsNullOrEmpty(s32.FilePath))
                            {
                                string fileNameWithoutExt = System.IO.Path.GetFileNameWithoutExtension(s32.FilePath);
                                if (fileNameWithoutExt.Length >= 8)
                                {
                                    try
                                    {
                                        int blockX = Convert.ToInt32(fileNameWithoutExt.Substring(0, 4), 16);
                                        int blockY = Convert.ToInt32(fileNameWithoutExt.Substring(4, 4), 16);
                                        int nLinBeginX = (blockX - 0x7FFF) * 64 + 0x7FFF - 64 + 1;
                                        int nLinBeginY = (blockY - 0x7FFF) * 64 + 0x7FFF - 64 + 1;
                                        int gameX = nLinBeginX + newX / 2;
                                        int gameY = nLinBeginY + newY;
                                        gameCoord = $"{gameX}, {gameY}";
                                    }
                                    catch { }
                                }
                            }
                            selectedItem.SubItems[7].Text = gameCoord;

                            // é‡æ–°æ¸²æŸ“
                            ClearS32BlockCache();
                            RenderS32Map();

                            this.toolStripStatusLabel1.Text = $"å·²æ›´æ–°ç‰©ä»¶: X={newX}, Y={newY}, Layer={newLayer}, IndexId={newIndexId}, TileId={newTileId}";
                        }
                    }
                };

                // åº•éƒ¨é¢æ¿
                var bottomPanel = new Panel
                {
                    Dock = DockStyle.Bottom,
                    Height = 50
                };

                var btnSelectAll = new Button
                {
                    Text = "å…¨é¸",
                    Location = new Point(10, 12),
                    Size = new Size(75, 26)
                };
                btnSelectAll.Click += (s, ev) =>
                {
                    foreach (ListViewItem item in listView.Items)
                        item.Checked = true;
                };

                var btnSelectNone = new Button
                {
                    Text = "å–æ¶ˆå…¨é¸",
                    Location = new Point(95, 12),
                    Size = new Size(75, 26)
                };
                btnSelectNone.Click += (s, ev) =>
                {
                    foreach (ListViewItem item in listView.Items)
                        item.Checked = false;
                };

                var btnDeleteSelected = new Button
                {
                    Text = "åˆªé™¤å‹¾é¸é …ç›®",
                    Location = new Point(200, 12),
                    Size = new Size(100, 26),
                    BackColor = Color.FromArgb(255, 200, 200)
                };
                btnDeleteSelected.Click += (s, ev) =>
                {
                    var checkedItems = listView.CheckedItems.Cast<ListViewItem>().ToList();
                    if (checkedItems.Count == 0)
                    {
                        MessageBox.Show("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    if (MessageBox.Show($"ç¢ºå®šè¦åˆªé™¤å‹¾é¸çš„ {checkedItems.Count} å€‹ç‰©ä»¶å—ï¼Ÿ\næ­¤æ“ä½œæ”¯æ´ Undoã€‚",
                        "ç¢ºèªåˆªé™¤", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes)
                        return;

                    // æ”¶é›†è¦åˆªé™¤çš„ç‰©ä»¶
                    var objectsToDelete = new List<(S32Data s32, ObjectTile obj)>();
                    foreach (ListViewItem item in checkedItems)
                    {
                        if (item.Tag is (S32Data s32, ObjectTile obj))
                        {
                            objectsToDelete.Add((s32, obj));
                        }
                    }

                    if (objectsToDelete.Count == 0)
                        return;

                    // å»ºç«‹ Undo å‹•ä½œ
                    var undoAction = new UndoAction { Description = $"åˆªé™¤ç¾¤çµ„ {info.GroupId} ä¸­çš„ {checkedItems.Count} å€‹ç‰©ä»¶" };

                    // åŸ·è¡Œåˆªé™¤
                    int deletedCount = 0;
                    foreach (var (s32, obj) in objectsToDelete)
                    {
                        // è¨˜éŒ„ Undo è³‡è¨Š
                        undoAction.RemovedObjects.Add(new UndoObjectInfo
                        {
                            S32FilePath = s32.FilePath,
                            GroupId = obj.GroupId,
                            LocalX = obj.X,
                            LocalY = obj.Y,
                            Layer = obj.Layer,
                            IndexId = obj.IndexId,
                            TileId = obj.TileId
                        });

                        // å¾ Layer4 ç§»é™¤
                        s32.Layer4.Remove(obj);
                        Layer4Index_Remove(s32, obj);
                        s32.IsModified = true;
                        deletedCount++;
                    }

                    _editState.PushUndoAction(undoAction);

                    // å¾ ListView ç§»é™¤å·²åˆªé™¤çš„é …ç›®
                    foreach (ListViewItem item in checkedItems)
                    {
                        listView.Items.Remove(item);
                    }

                    // æ›´æ–°æ¨™é¡Œ
                    form.Text = $"ç¾¤çµ„ {info.GroupId} - L4 æ˜ç´° ({listView.Items.Count} å€‹ç‰©ä»¶)";

                    // é‡æ–°æ¸²æŸ“
                    ClearS32BlockCache();
                    RenderS32Map();

                    // æ›´æ–°ç¾¤çµ„åˆ—è¡¨
                    if (_editState.SelectedCells.Count > 0)
                    {
                        var firstCell = _editState.SelectedCells[0];
                        UpdateNearbyGroupThumbnails(firstCell.S32Data, firstCell.LocalX, firstCell.LocalY, 10);
                    }

                    this.toolStripStatusLabel1.Text = $"å·²åˆªé™¤ {deletedCount} å€‹ç‰©ä»¶";

                    // å¦‚æœå…¨éƒ¨åˆªé™¤å®Œç•¢ï¼Œé—œé–‰å°è©±æ¡†
                    if (listView.Items.Count == 0)
                    {
                        MessageBox.Show("ç¾¤çµ„å…§æ‰€æœ‰ç‰©ä»¶å·²åˆªé™¤", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        form.Close();
                    }
                };

                var btnExportCsv = new Button
                {
                    Text = "åŒ¯å‡º CSV",
                    Location = new Point(320, 12),
                    Size = new Size(85, 26)
                };
                btnExportCsv.Click += (s, ev) =>
                {
                    using (var saveDialog = new SaveFileDialog())
                    {
                        saveDialog.Filter = "CSV æª”æ¡ˆ|*.csv";
                        saveDialog.FileName = $"Group_{info.GroupId}_L4.csv";
                        saveDialog.Title = "åŒ¯å‡º Layer4 æ˜ç´°";

                        if (saveDialog.ShowDialog() == DialogResult.OK)
                        {
                            try
                            {
                                using (var writer = new System.IO.StreamWriter(saveDialog.FileName, false, System.Text.Encoding.UTF8))
                                {
                                    // å¯«å…¥æ¨™é¡Œåˆ—
                                    writer.WriteLine("GroupId,S32æª”æ¡ˆ,X(L1),Y(L1),Layer,IndexId,TileId,éŠæˆ²åº§æ¨™X,éŠæˆ²åº§æ¨™Y");

                                    // å¯«å…¥è³‡æ–™
                                    foreach (ListViewItem item in listView.Items)
                                    {
                                        string s32File = item.SubItems[1].Text;
                                        string x = item.SubItems[2].Text;
                                        string y = item.SubItems[3].Text;
                                        string layer = item.SubItems[4].Text;
                                        string indexId = item.SubItems[5].Text;
                                        string tileId = item.SubItems[6].Text;
                                        string gameCoord = item.SubItems[7].Text;
                                        string gameX = "", gameY = "";
                                        if (!string.IsNullOrEmpty(gameCoord) && gameCoord.Contains(","))
                                        {
                                            var parts = gameCoord.Split(',');
                                            gameX = parts[0].Trim();
                                            gameY = parts.Length > 1 ? parts[1].Trim() : "";
                                        }

                                        writer.WriteLine($"{info.GroupId},{s32File},{x},{y},{layer},{indexId},{tileId},{gameX},{gameY}");
                                    }
                                }

                                MessageBox.Show($"å·²åŒ¯å‡º {listView.Items.Count} ç­†è³‡æ–™åˆ°\n{saveDialog.FileName}", "åŒ¯å‡ºæˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            }
                            catch (Exception ex)
                            {
                                Console.WriteLine($"[Export] Error: {ex}");
                        MessageBox.Show($"åŒ¯å‡ºå¤±æ•—: {ex.Message}\n\n{ex.StackTrace}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }
                    }
                };

                var btnClose = new Button
                {
                    Text = "é—œé–‰",
                    Location = new Point(580, 12),
                    Size = new Size(75, 26)
                };
                btnClose.Click += (s, ev) => form.Close();

                bottomPanel.Controls.AddRange(new Control[] { btnSelectAll, btnSelectNone, btnDeleteSelected, btnExportCsv, btnClose });

                form.Controls.Add(listView);
                form.Controls.Add(bottomPanel);

                form.ShowDialog(this);
            }
        }

        // ===== å·¥å…·åˆ—æŒ‰éˆ•äº‹ä»¶è™•ç† =====

        private void btnToolCopy_Click(object sender, EventArgs e)
        {
            CopySelectedCells();
        }

        private void btnToolPaste_Click(object sender, EventArgs e)
        {
            PasteSelectedCells();
        }

        private void btnToolDelete_Click(object sender, EventArgs e)
        {
            DeleteSelectedLayer4Objects();
        }

        private void btnToolUndo_Click(object sender, EventArgs e)
        {
            UndoLastAction();
        }

        private void btnToolRedo_Click(object sender, EventArgs e)
        {
            RedoLastAction();
        }

        private void btnToolSave_Click(object sender, EventArgs e)
        {
            btnSaveS32_Click(sender, e);
        }

        private void btnToolCellInfo_Click(object sender, EventArgs e)
        {
            // å¦‚æœæœ‰é¸å–å€åŸŸï¼Œé¡¯ç¤ºç¬¬ä¸€å€‹é¸å–æ ¼å­çš„è©³ç´°è³‡è¨Š
            if (_editState.SelectedCells.Count > 0)
            {
                var firstCell = _editState.SelectedCells[0];
                ShowCellLayersDialog(firstCell.LocalX, firstCell.LocalY);
            }
            else
            {
                this.toolStripStatusLabel1.Text = "è«‹å…ˆä½¿ç”¨å·¦éµé¸å–æ ¼å­";
            }
        }

        private void btnToolReplaceTile_Click(object sender, EventArgs e)
        {
            // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥åœ°åœ–
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // å‰µå»ºæ›¿æ›å°è©±æ¡†
            Form replaceForm = new Form();
            replaceForm.Text = "æ‰¹æ¬¡æ›¿æ› TileId";
            replaceForm.Size = new Size(420, 350);
            replaceForm.FormBorderStyle = FormBorderStyle.FixedDialog;
            replaceForm.StartPosition = FormStartPosition.CenterParent;
            replaceForm.MaximizeBox = false;
            replaceForm.MinimizeBox = false;

            // åœ–å±¤é¸æ“‡
            GroupBox gbLayer = new GroupBox();
            gbLayer.Text = "é¸æ“‡åœ–å±¤";
            gbLayer.Location = new Point(15, 10);
            gbLayer.Size = new Size(375, 50);
            replaceForm.Controls.Add(gbLayer);

            RadioButton rbLayer1 = new RadioButton { Text = "Layer1 (åœ°æ¿)", Location = new Point(15, 20), Size = new Size(110, 20), Checked = true };
            RadioButton rbLayer2 = new RadioButton { Text = "Layer2 (ç´¢å¼•)", Location = new Point(135, 20), Size = new Size(110, 20) };
            RadioButton rbLayer4 = new RadioButton { Text = "Layer4 (ç‰©ä»¶)", Location = new Point(255, 20), Size = new Size(110, 20) };
            gbLayer.Controls.AddRange(new Control[] { rbLayer1, rbLayer2, rbLayer4 });

            // ä¾†æºè¨­å®š
            GroupBox gbSource = new GroupBox();
            gbSource.Text = "ä¾†æº";
            gbSource.Location = new Point(15, 65);
            gbSource.Size = new Size(375, 80);
            replaceForm.Controls.Add(gbSource);

            Label lblSrcTileId = new Label { Text = "TileId:", Location = new Point(15, 25), Size = new Size(55, 20) };
            TextBox txtSrcTileId = new TextBox { Location = new Point(75, 22), Size = new Size(100, 22) };
            Label lblSrcIndexId = new Label { Text = "IndexId:", Location = new Point(190, 25), Size = new Size(55, 20) };
            TextBox txtSrcIndexId = new TextBox { Location = new Point(250, 22), Size = new Size(100, 22) };
            CheckBox chkMatchIndexId = new CheckBox { Text = "æ¯”å° IndexId", Location = new Point(15, 50), Size = new Size(120, 20), Checked = true };
            gbSource.Controls.AddRange(new Control[] { lblSrcTileId, txtSrcTileId, lblSrcIndexId, txtSrcIndexId, chkMatchIndexId });

            // ç›®æ¨™è¨­å®š
            GroupBox gbTarget = new GroupBox();
            gbTarget.Text = "æ›¿æ›ç‚º";
            gbTarget.Location = new Point(15, 150);
            gbTarget.Size = new Size(375, 80);
            replaceForm.Controls.Add(gbTarget);

            Label lblDstTileId = new Label { Text = "TileId:", Location = new Point(15, 25), Size = new Size(55, 20) };
            TextBox txtDstTileId = new TextBox { Location = new Point(75, 22), Size = new Size(100, 22) };
            Label lblDstIndexId = new Label { Text = "IndexId:", Location = new Point(190, 25), Size = new Size(55, 20) };
            TextBox txtDstIndexId = new TextBox { Location = new Point(250, 22), Size = new Size(100, 22) };
            CheckBox chkReplaceIndexId = new CheckBox { Text = "æ›¿æ› IndexId", Location = new Point(15, 50), Size = new Size(120, 20), Checked = true };
            gbTarget.Controls.AddRange(new Control[] { lblDstTileId, txtDstTileId, lblDstIndexId, txtDstIndexId, chkReplaceIndexId });

            // æŒ‰éˆ•
            Button btnPreview = new Button { Text = "é è¦½", Location = new Point(70, 245), Size = new Size(80, 30) };
            Button btnExecute = new Button { Text = "åŸ·è¡Œæ›¿æ›", Location = new Point(160, 245), Size = new Size(80, 30) };
            Button btnCancel = new Button { Text = "å–æ¶ˆ", Location = new Point(250, 245), Size = new Size(80, 30) };
            btnCancel.Click += (s, args) => replaceForm.Close();
            replaceForm.Controls.AddRange(new Control[] { btnPreview, btnExecute, btnCancel });

            // çµæœæ¨™ç±¤
            Label lblResult = new Label { Text = "", Location = new Point(15, 285), Size = new Size(375, 20), ForeColor = Color.Blue };
            replaceForm.Controls.Add(lblResult);

            // é è¦½åŠŸèƒ½
            btnPreview.Click += (s, args) =>
            {
                if (!int.TryParse(txtSrcTileId.Text, out int srcTileId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¾†æº TileId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                int srcIndexId = 0;
                bool matchIndex = chkMatchIndexId.Checked;
                if (matchIndex && !int.TryParse(txtSrcIndexId.Text, out srcIndexId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¾†æº IndexId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                int matchCount = 0;
                int s32Count = 0;

                foreach (var kvp in _document.S32Files)
                {
                    S32Data s32Data = kvp.Value;
                    bool hasMatch = false;

                    if (rbLayer1.Checked)
                    {
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell.TileId == srcTileId && (!matchIndex || cell.IndexId == srcIndexId))
                                {
                                    matchCount++;
                                    hasMatch = true;
                                }
                            }
                        }
                    }
                    else if (rbLayer2.Checked)
                    {
                        foreach (var item in s32Data.Layer2)
                        {
                            if (item.TileId == srcTileId && (!matchIndex || item.IndexId == srcIndexId))
                            {
                                matchCount++;
                                hasMatch = true;
                            }
                        }
                    }
                    else if (rbLayer4.Checked)
                    {
                        foreach (var obj in s32Data.Layer4)
                        {
                            if (obj.TileId == srcTileId && (!matchIndex || obj.IndexId == srcIndexId))
                            {
                                matchCount++;
                                hasMatch = true;
                            }
                        }
                    }

                    if (hasMatch) s32Count++;
                }

                string layerName = rbLayer1.Checked ? "Layer1" : (rbLayer2.Checked ? "Layer2" : "Layer4");
                lblResult.Text = $"[{layerName}] æ‰¾åˆ° {matchCount} å€‹åŒ¹é…é …ç›®ï¼Œåˆ†å¸ƒåœ¨ {s32Count} å€‹ S32 æª”æ¡ˆ";
            };

            // åŸ·è¡Œæ›¿æ›åŠŸèƒ½
            btnExecute.Click += (s, args) =>
            {
                if (!int.TryParse(txtSrcTileId.Text, out int srcTileId) ||
                    !int.TryParse(txtDstTileId.Text, out int dstTileId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¾†æºå’Œç›®æ¨™ TileId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                int srcIndexId = 0, dstIndexId = 0;
                bool matchIndex = chkMatchIndexId.Checked;
                bool replaceIndex = chkReplaceIndexId.Checked;

                if (matchIndex && !int.TryParse(txtSrcIndexId.Text, out srcIndexId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¾†æº IndexId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
                if (replaceIndex && !int.TryParse(txtDstIndexId.Text, out dstIndexId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®æ¨™ IndexId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                string layerName = rbLayer1.Checked ? "Layer1" : (rbLayer2.Checked ? "Layer2" : "Layer4");
                string matchInfo = matchIndex ? $"TileId={srcTileId}, IndexId={srcIndexId}" : $"TileId={srcTileId}";
                string replaceInfo = replaceIndex ? $"TileId={dstTileId}, IndexId={dstIndexId}" : $"TileId={dstTileId}";

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åœ¨ [{layerName}] å°‡æ‰€æœ‰ {matchInfo}\næ›¿æ›ç‚º {replaceInfo} å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒå½±éŸ¿æ‰€æœ‰å·²è¼‰å…¥çš„ S32 æª”æ¡ˆã€‚",
                    "ç¢ºèªæ›¿æ›",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int replacedCount = 0;
                HashSet<string> modifiedS32Files = new HashSet<string>();

                foreach (var kvp in _document.S32Files)
                {
                    S32Data s32Data = kvp.Value;
                    bool hasModified = false;

                    if (rbLayer1.Checked)
                    {
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell.TileId == srcTileId && (!matchIndex || cell.IndexId == srcIndexId))
                                {
                                    cell.TileId = dstTileId;
                                    if (replaceIndex) cell.IndexId = dstIndexId;
                                    cell.IsModified = true;
                                    replacedCount++;
                                    hasModified = true;
                                }
                            }
                        }
                    }
                    else if (rbLayer2.Checked)
                    {
                        foreach (var item in s32Data.Layer2)
                        {
                            if (item.TileId == srcTileId && (!matchIndex || item.IndexId == srcIndexId))
                            {
                                item.TileId = (ushort)dstTileId;
                                if (replaceIndex) item.IndexId = (byte)dstIndexId;
                                replacedCount++;
                                hasModified = true;
                            }
                        }
                    }
                    else if (rbLayer4.Checked)
                    {
                        foreach (var obj in s32Data.Layer4)
                        {
                            if (obj.TileId == srcTileId && (!matchIndex || obj.IndexId == srcIndexId))
                            {
                                obj.TileId = dstTileId;
                                if (replaceIndex) obj.IndexId = dstIndexId;
                                replacedCount++;
                                hasModified = true;
                            }
                        }
                    }

                    if (hasModified)
                    {
                        if (!s32Data.Layer6.Contains(dstTileId))
                        {
                            s32Data.Layer6.Add(dstTileId);
                        }
                        s32Data.IsModified = true;
                        modifiedS32Files.Add(kvp.Key);
                    }
                }

                ClearS32BlockCache();
                RenderS32Map();
                UpdateTileList();

                MessageBox.Show($"æ›¿æ›å®Œæˆï¼\nå…±æ›¿æ› {replacedCount} å€‹é …ç›®\nå½±éŸ¿ {modifiedS32Files.Count} å€‹ S32 æª”æ¡ˆ\n\nè«‹è¨˜å¾—å„²å­˜ä¿®æ”¹ã€‚",
                    "å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);

                this.toolStripStatusLabel1.Text = $"[{layerName}] å·²æ›¿æ› {replacedCount} å€‹é …ç›®ï¼Œå½±éŸ¿ {modifiedS32Files.Count} å€‹ S32 æª”æ¡ˆ";
                replaceForm.Close();
            };

            replaceForm.ShowDialog();
        }

        // æ¸…é™¤æ‰€æœ‰ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰è³‡æ–™
        private void btnToolClearLayer7_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // è¨ˆç®—ç¸½å…±æœ‰å¤šå°‘å€‹ç¬¬ä¸ƒå±¤è³‡æ–™
            int totalLayer7Count = 0;
            int affectedS32Count = 0;
            foreach (var s32Data in _document.S32Files.Values)
            {
                if (s32Data.Layer7 != null && s32Data.Layer7.Count > 0)
                {
                    totalLayer7Count += s32Data.Layer7.Count;
                    affectedS32Count++;
                }
            }

            if (totalLayer7Count == 0)
            {
                MessageBox.Show("æ²’æœ‰ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰è³‡æ–™éœ€è¦æ¸…é™¤", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // ç¢ºèªåˆªé™¤
            var confirmResult = MessageBox.Show(
                $"ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰è³‡æ–™å—ï¼Ÿ\n\n" +
                $"å…± {totalLayer7Count} ç­†å‚³é€é»è³‡æ–™\n" +
                $"åˆ†å¸ƒåœ¨ {affectedS32Count} å€‹ S32 æª”æ¡ˆä¸­\n\n" +
                $"æ­¤æ“ä½œå¯ä»¥ä½¿ç”¨ Undo é‚„åŸã€‚",
                "ç¢ºèªæ¸…é™¤",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (confirmResult != DialogResult.Yes) return;

            // å»ºç«‹ Undo è¨˜éŒ„
            var undoAction = new UndoAction
            {
                Description = $"æ¸…é™¤æ‰€æœ‰ç¬¬ä¸ƒå±¤è³‡æ–™ ({totalLayer7Count} ç­†)"
            };

            // å‚™ä»½ä¸¦æ¸…é™¤æ‰€æœ‰ç¬¬ä¸ƒå±¤è³‡æ–™
            int clearedCount = 0;
            foreach (var kvp in _document.S32Files)
            {
                S32Data s32Data = kvp.Value;
                if (s32Data.Layer7 != null && s32Data.Layer7.Count > 0)
                {
                    // å‚™ä»½åˆ° Undoï¼ˆå„²å­˜ç‚º Layer7Backupï¼‰
                    foreach (var item in s32Data.Layer7)
                    {
                        undoAction.RemovedLayer7Items.Add(new UndoLayer7Info
                        {
                            S32FilePath = kvp.Key,
                            Name = item.Name,
                            X = item.X,
                            Y = item.Y,
                            TargetMapId = item.TargetMapId,
                            PortalId = item.PortalId
                        });
                    }

                    clearedCount += s32Data.Layer7.Count;
                    s32Data.Layer7.Clear();
                    s32Data.IsModified = true;
                }
            }

            // åŠ å…¥ Undo å †ç–Š
            PushUndoAction(undoAction);

            // é‡æ–°æ¸²æŸ“
            RenderS32Map();

            this.toolStripStatusLabel1.Text = $"å·²æ¸…é™¤ {clearedCount} ç­†ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰è³‡æ–™ï¼Œè«‹è¨˜å¾—å„²å­˜";
        }

        // æ¸…é™¤æŒ‡å®šæ ¼å­çš„å„å±¤è³‡æ–™
        private void btnToolClearCell_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // å¦‚æœæœ‰é¸å–å€åŸŸï¼Œç›´æ¥æ‰¹é‡æ¸…é™¤
            if (_editState.SelectedCells.Count > 0)
            {
                ClearSelectedCellsWithDialog();
                return;
            }

            // æ²’æœ‰é¸å–å€åŸŸï¼Œé¡¯ç¤ºå–®æ ¼æ¸…é™¤å°è©±æ¡†
            ShowSingleCellClearDialog();
        }

        // æ‰¹é‡æ¸…é™¤é¸å–å€åŸŸçš„å°è©±æ¡†
        private void ClearSelectedCellsWithDialog()
        {
            Form clearForm = new Form();
            clearForm.Text = $"æ‰¹é‡æ¸…é™¤æ ¼å­è³‡æ–™ - å·²é¸å– {_editState.SelectedCells.Count} æ ¼";
            clearForm.Size = new Size(320, 320);
            clearForm.FormBorderStyle = FormBorderStyle.FixedDialog;
            clearForm.StartPosition = FormStartPosition.CenterParent;
            clearForm.MaximizeBox = false;
            clearForm.MinimizeBox = false;

            // é¸æ“‡è¦æ¸…é™¤çš„å±¤
            Label lblLayers = new Label();
            lblLayers.Text = $"é¸æ“‡è¦æ¸…é™¤çš„å±¤ (å…± {_editState.SelectedCells.Count} æ ¼):";
            lblLayers.Location = new Point(20, 20);
            lblLayers.Size = new Size(250, 20);
            clearForm.Controls.Add(lblLayers);

            CheckBox chkL1 = new CheckBox();
            chkL1.Text = "ç¬¬1å±¤ (åœ°æ¿)";
            chkL1.Location = new Point(30, 50);
            chkL1.Size = new Size(150, 20);
            chkL1.Checked = true;
            clearForm.Controls.Add(chkL1);

            CheckBox chkL3 = new CheckBox();
            chkL3.Text = "ç¬¬3å±¤ (å±¬æ€§) - è¨­ç‚ºå¯é€šè¡Œ";
            chkL3.Location = new Point(30, 75);
            chkL3.Size = new Size(200, 20);
            chkL3.Checked = true;
            clearForm.Controls.Add(chkL3);

            CheckBox chkL4 = new CheckBox();
            chkL4.Text = "ç¬¬4å±¤ (ç‰©ä»¶)";
            chkL4.Location = new Point(30, 100);
            chkL4.Size = new Size(150, 20);
            chkL4.Checked = true;
            clearForm.Controls.Add(chkL4);

            CheckBox chkL5 = new CheckBox();
            chkL5.Text = "ç¬¬5å±¤ (é€æ˜åœ–å¡Š)";
            chkL5.Location = new Point(30, 125);
            chkL5.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL5);

            CheckBox chkL7 = new CheckBox();
            chkL7.Text = "ç¬¬7å±¤ (å‚³é€é»)";
            chkL7.Location = new Point(30, 150);
            chkL7.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL7);

            CheckBox chkL8 = new CheckBox();
            chkL8.Text = "ç¬¬8å±¤ (ç‰¹æ•ˆ)";
            chkL8.Location = new Point(30, 175);
            chkL8.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL8);

            // åŸ·è¡ŒæŒ‰éˆ•
            Button btnExecute = new Button();
            btnExecute.Text = "æ¸…é™¤";
            btnExecute.Location = new Point(60, 220);
            btnExecute.Size = new Size(80, 30);
            clearForm.Controls.Add(btnExecute);

            Button btnCancel = new Button();
            btnCancel.Text = "å–æ¶ˆ";
            btnCancel.Location = new Point(160, 220);
            btnCancel.Size = new Size(80, 30);
            btnCancel.Click += (s, args) => clearForm.Close();
            clearForm.Controls.Add(btnCancel);

            btnExecute.Click += (s, args) =>
            {
                int totalL1 = 0, totalL3 = 0, totalL4 = 0, totalL5 = 0, totalL7 = 0, totalL8 = 0;
                HashSet<S32Data> modifiedS32s = new HashSet<S32Data>();

                // å»ºç«‹é¸å–æ ¼å­çš„å…¨åŸŸåº§æ¨™é›†åˆ (ç”¨æ–¼ Layer4 è·¨å€å¡Šç‰©ä»¶)
                var selectedGlobalCells = new HashSet<(int x, int y)>();
                foreach (var cell in _editState.SelectedCells)
                {
                    int globalX = cell.S32Data.SegInfo.nLinBeginX + cell.LocalX / 2;
                    int globalY = cell.S32Data.SegInfo.nLinBeginY + cell.LocalY;
                    selectedGlobalCells.Add((globalX, globalY));
                }

                foreach (var cell in _editState.SelectedCells)
                {
                    S32Data s32Data = cell.S32Data;
                    int layer1X = cell.LocalX;
                    int localY = cell.LocalY;
                    int layer3X = layer1X / 2;

                    // æ¸…é™¤ç¬¬1å±¤
                    if (chkL1.Checked && layer1X >= 0 && layer1X < 128 && localY >= 0 && localY < 64)
                    {
                        s32Data.Layer1[localY, layer1X] = new TileCell { X = layer1X, Y = localY, TileId = 0, IndexId = 0 };
                        totalL1++;
                        modifiedS32s.Add(s32Data);
                    }

                    // æ¸…é™¤ç¬¬3å±¤ï¼ˆè¨­ç‚ºå¯é€šè¡Œï¼‰- åªåœ¨å¶æ•¸ X æ™‚è™•ç†ï¼Œé¿å…é‡è¤‡
                    if (chkL3.Checked && layer1X % 2 == 0 && layer3X >= 0 && layer3X < 64 && localY >= 0 && localY < 64)
                    {
                        s32Data.Layer3[localY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                        totalL3++;
                        modifiedS32s.Add(s32Data);
                    }

                    // æ¸…é™¤ç¬¬5å±¤ - Layer5.X æ˜¯ 0-127 (Layer1 åº§æ¨™)
                    // ä¸€å€‹éŠæˆ²æ ¼å­å°æ‡‰å…©å€‹ Layer1 X åº§æ¨™ï¼Œåªåœ¨å¶æ•¸ X æ™‚è™•ç†é¿å…é‡è¤‡
                    if (chkL5.Checked && layer1X % 2 == 0)
                    {
                        totalL5 += s32Data.Layer5.RemoveAll(item => (item.X == layer1X || item.X == layer1X + 1) && item.Y == localY);
                        modifiedS32s.Add(s32Data);
                    }

                    // æ¸…é™¤ç¬¬7å±¤ - åªåœ¨å¶æ•¸ X æ™‚è™•ç†
                    if (chkL7.Checked && layer1X % 2 == 0)
                    {
                        totalL7 += s32Data.Layer7.RemoveAll(item => item.X == layer3X && item.Y == localY);
                        modifiedS32s.Add(s32Data);
                    }

                    // æ¸…é™¤ç¬¬8å±¤ - åªåœ¨å¶æ•¸ X æ™‚è™•ç†
                    if (chkL8.Checked && layer1X % 2 == 0)
                    {
                        totalL8 += s32Data.Layer8.RemoveAll(item => item.X == layer3X && item.Y == localY);
                        modifiedS32s.Add(s32Data);
                    }
                }

                // æ¸…é™¤ç¬¬4å±¤ - éœ€è¦éæ­·æ‰€æœ‰ S32 æ‰¾è·¨å€å¡Šç‰©ä»¶
                if (chkL4.Checked)
                {
                    foreach (var s32Data in _document.S32Files.Values)
                    {
                        int segStartX = s32Data.SegInfo.nLinBeginX;
                        int segStartY = s32Data.SegInfo.nLinBeginY;

                        // å…ˆæ”¶é›†è¦åˆªé™¤çš„ç‰©ä»¶ä»¥æ›´æ–°ç©ºé–“ç´¢å¼•
                        var toRemove = s32Data.Layer4.Where(obj =>
                        {
                            int objGlobalX = segStartX + obj.X / 2;
                            int objGlobalY = segStartY + obj.Y;
                            return selectedGlobalCells.Contains((objGlobalX, objGlobalY));
                        }).ToList();

                        if (toRemove.Count > 0)
                        {
                            s32Data.Layer4.RemoveAll(obj =>
                            {
                                int objGlobalX = segStartX + obj.X / 2;
                                int objGlobalY = segStartY + obj.Y;
                                return selectedGlobalCells.Contains((objGlobalX, objGlobalY));
                            });
                            Layer4Index_RemoveRange(s32Data, toRemove);
                            totalL4 += toRemove.Count;
                            modifiedS32s.Add(s32Data);
                        }
                    }
                }

                // æ¨™è¨˜ä¿®æ”¹
                foreach (var s32 in modifiedS32s)
                {
                    s32.IsModified = true;
                }

                // çµ„åˆçµæœè¨Šæ¯
                List<string> results = new List<string>();
                if (totalL1 > 0) results.Add($"L1:{totalL1}");
                if (totalL3 > 0) results.Add($"L3:{totalL3}");
                if (totalL4 > 0) results.Add($"L4:{totalL4}");
                if (totalL5 > 0) results.Add($"L5:{totalL5}");
                if (totalL7 > 0) results.Add($"L7:{totalL7}");
                if (totalL8 > 0) results.Add($"L8:{totalL8}");

                // ä¿å­˜æ•¸é‡å¾Œæ¸…é™¤é¸å–
                int clearedCellCount = _editState.SelectedCells.Count;
                _editState.SelectedCells.Clear();
                selectedRegion = new Rectangle();

                RenderS32Map();

                if (results.Count > 0)
                {
                    this.toolStripStatusLabel1.Text = $"å·²æ¸…é™¤ {clearedCellCount} æ ¼çš„ {string.Join(", ", results)} è³‡æ–™";
                }
                else
                {
                    this.toolStripStatusLabel1.Text = "é¸å–å€åŸŸæ²’æœ‰è³‡æ–™éœ€è¦æ¸…é™¤";
                }

                clearForm.Close();
            };

            clearForm.ShowDialog();
        }

        // å–®æ ¼æ¸…é™¤å°è©±æ¡†
        private void ShowSingleCellClearDialog()
        {
            Form clearForm = new Form();
            clearForm.Text = "æ¸…é™¤æ ¼å­è³‡æ–™";
            clearForm.Size = new Size(350, 380);
            clearForm.FormBorderStyle = FormBorderStyle.FixedDialog;
            clearForm.StartPosition = FormStartPosition.CenterParent;
            clearForm.MaximizeBox = false;
            clearForm.MinimizeBox = false;

            // åº§æ¨™è¼¸å…¥
            Label lblCoord = new Label();
            lblCoord.Text = "è¼¸å…¥éŠæˆ²åº§æ¨™:";
            lblCoord.Location = new Point(20, 20);
            lblCoord.Size = new Size(100, 20);
            clearForm.Controls.Add(lblCoord);

            Label lblX = new Label();
            lblX.Text = "X:";
            lblX.Location = new Point(20, 50);
            lblX.Size = new Size(30, 20);
            clearForm.Controls.Add(lblX);

            TextBox txtX = new TextBox();
            txtX.Location = new Point(50, 48);
            txtX.Size = new Size(80, 20);
            if (_editState.SelectedGameX >= 0) txtX.Text = _editState.SelectedGameX.ToString();
            clearForm.Controls.Add(txtX);

            Label lblY = new Label();
            lblY.Text = "Y:";
            lblY.Location = new Point(150, 50);
            lblY.Size = new Size(30, 20);
            clearForm.Controls.Add(lblY);

            TextBox txtY = new TextBox();
            txtY.Location = new Point(180, 48);
            txtY.Size = new Size(80, 20);
            if (_editState.SelectedGameY >= 0) txtY.Text = _editState.SelectedGameY.ToString();
            clearForm.Controls.Add(txtY);

            // é¸æ“‡è¦æ¸…é™¤çš„å±¤
            Label lblLayers = new Label();
            lblLayers.Text = "é¸æ“‡è¦æ¸…é™¤çš„å±¤:";
            lblLayers.Location = new Point(20, 90);
            lblLayers.Size = new Size(150, 20);
            clearForm.Controls.Add(lblLayers);

            CheckBox chkL1 = new CheckBox();
            chkL1.Text = "ç¬¬1å±¤ (åœ°æ¿)";
            chkL1.Location = new Point(30, 115);
            chkL1.Size = new Size(150, 20);
            chkL1.Checked = true;
            clearForm.Controls.Add(chkL1);

            CheckBox chkL3 = new CheckBox();
            chkL3.Text = "ç¬¬3å±¤ (å±¬æ€§) - è¨­ç‚ºå¯é€šè¡Œ";
            chkL3.Location = new Point(30, 140);
            chkL3.Size = new Size(200, 20);
            chkL3.Checked = true;
            clearForm.Controls.Add(chkL3);

            CheckBox chkL4 = new CheckBox();
            chkL4.Text = "ç¬¬4å±¤ (ç‰©ä»¶)";
            chkL4.Location = new Point(30, 165);
            chkL4.Size = new Size(150, 20);
            chkL4.Checked = true;
            clearForm.Controls.Add(chkL4);

            CheckBox chkL5 = new CheckBox();
            chkL5.Text = "ç¬¬5å±¤ (é€æ˜åœ–å¡Š)";
            chkL5.Location = new Point(30, 190);
            chkL5.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL5);

            CheckBox chkL7 = new CheckBox();
            chkL7.Text = "ç¬¬7å±¤ (å‚³é€é»)";
            chkL7.Location = new Point(30, 215);
            chkL7.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL7);

            CheckBox chkL8 = new CheckBox();
            chkL8.Text = "ç¬¬8å±¤ (ç‰¹æ•ˆ)";
            chkL8.Location = new Point(30, 240);
            chkL8.Size = new Size(150, 20);
            clearForm.Controls.Add(chkL8);

            // åŸ·è¡ŒæŒ‰éˆ•
            Button btnExecute = new Button();
            btnExecute.Text = "æ¸…é™¤";
            btnExecute.Location = new Point(80, 290);
            btnExecute.Size = new Size(80, 30);
            clearForm.Controls.Add(btnExecute);

            Button btnCancel = new Button();
            btnCancel.Text = "å–æ¶ˆ";
            btnCancel.Location = new Point(180, 290);
            btnCancel.Size = new Size(80, 30);
            btnCancel.Click += (s, args) => clearForm.Close();
            clearForm.Controls.Add(btnCancel);

            btnExecute.Click += (s, args) =>
            {
                if (!int.TryParse(txtX.Text, out int gameX) || !int.TryParse(txtY.Text, out int gameY))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æ‰¾åˆ°å°æ‡‰çš„ S32
                S32Data targetS32 = null;
                foreach (var s32Data in _document.S32Files.Values)
                {
                    if (gameX >= s32Data.SegInfo.nLinBeginX && gameX <= s32Data.SegInfo.nLinEndX &&
                        gameY >= s32Data.SegInfo.nLinBeginY && gameY <= s32Data.SegInfo.nLinEndY)
                    {
                        targetS32 = s32Data;
                        break;
                    }
                }

                if (targetS32 == null)
                {
                    MessageBox.Show($"æ‰¾ä¸åˆ°åº§æ¨™ ({gameX}, {gameY}) å°æ‡‰çš„ S32 å€å¡Š", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // è¨ˆç®—å±€éƒ¨åº§æ¨™
                int layer3X = gameX - targetS32.SegInfo.nLinBeginX;
                int localY = gameY - targetS32.SegInfo.nLinBeginY;
                int layer1X = layer3X * 2;  // Layer1 æ˜¯ 128 å¯¬

                List<string> clearedLayers = new List<string>();

                // æ¸…é™¤ç¬¬1å±¤
                if (chkL1.Checked && layer1X >= 0 && layer1X < 128 && localY >= 0 && localY < 64)
                {
                    // æ¸…é™¤å…©å€‹ Layer1 æ ¼å­ï¼ˆå› ç‚º Layer1 æ˜¯ 128 å¯¬ï¼ŒLayer3 æ˜¯ 64 å¯¬ï¼‰
                    targetS32.Layer1[localY, layer1X] = new TileCell { X = layer1X, Y = localY, TileId = 0, IndexId = 0 };
                    if (layer1X + 1 < 128)
                        targetS32.Layer1[localY, layer1X + 1] = new TileCell { X = layer1X + 1, Y = localY, TileId = 0, IndexId = 0 };
                    clearedLayers.Add("L1");
                }

                // æ¸…é™¤ç¬¬3å±¤ï¼ˆè¨­ç‚ºå¯é€šè¡Œï¼‰
                if (chkL3.Checked && layer3X >= 0 && layer3X < 64 && localY >= 0 && localY < 64)
                {
                    targetS32.Layer3[localY, layer3X] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 };
                    clearedLayers.Add("L3");
                }

                // æ¸…é™¤ç¬¬4å±¤
                if (chkL4.Checked)
                {
                    var toRemove = targetS32.Layer4.Where(obj =>
                        obj.X / 2 == layer3X && obj.Y == localY).ToList();
                    if (toRemove.Count > 0)
                    {
                        targetS32.Layer4.RemoveAll(obj =>
                            obj.X / 2 == layer3X && obj.Y == localY);
                        Layer4Index_RemoveRange(targetS32, toRemove);
                        clearedLayers.Add($"L4({toRemove.Count})");
                    }
                }

                // æ¸…é™¤ç¬¬5å±¤
                if (chkL5.Checked)
                {
                    int removedCount = targetS32.Layer5.RemoveAll(item =>
                        item.X == layer3X && item.Y == localY);
                    if (removedCount > 0) clearedLayers.Add($"L5({removedCount})");
                }

                // æ¸…é™¤ç¬¬7å±¤
                if (chkL7.Checked)
                {
                    int removedCount = targetS32.Layer7.RemoveAll(item =>
                        item.X == layer3X && item.Y == localY);
                    if (removedCount > 0) clearedLayers.Add($"L7({removedCount})");
                }

                // æ¸…é™¤ç¬¬8å±¤
                if (chkL8.Checked)
                {
                    int removedCount = targetS32.Layer8.RemoveAll(item =>
                        item.X == layer3X && item.Y == localY);
                    if (removedCount > 0) clearedLayers.Add($"L8({removedCount})");
                }

                if (clearedLayers.Count > 0)
                {
                    targetS32.IsModified = true;
                    RenderS32Map();
                    this.toolStripStatusLabel1.Text = $"å·²æ¸…é™¤æ ¼å­ ({gameX}, {gameY}) çš„ {string.Join(", ", clearedLayers)} è³‡æ–™";
                }
                else
                {
                    this.toolStripStatusLabel1.Text = $"æ ¼å­ ({gameX}, {gameY}) æ²’æœ‰è³‡æ–™éœ€è¦æ¸…é™¤";
                }

                clearForm.Close();
            };

            clearForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡ç®¡ç†ç¬¬å…­å±¤ï¼ˆä½¿ç”¨çš„TileIdï¼‰è³‡æ–™
        private void btnToolCheckL6_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†æœ‰ Layer6 è³‡æ–™çš„ S32
            List<(string filePath, string fileName, List<int> items)> s32WithL6 =
                new List<(string, string, List<int>)>();

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer6.Count > 0)
                {
                    s32WithL6.Add((filePath, fileName, s32Data.Layer6.ToList()));
                }
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L6 æŸ¥çœ‹èˆ‡ç®¡ç† - {s32WithL6.Count} å€‹ S32 æœ‰è³‡æ–™";
            resultForm.Size = new Size(750, 600);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            int totalItems = s32WithL6.Sum(x => x.items.Count);
            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {s32WithL6.Count} å€‹ S32 æª”æ¡ˆæœ‰ Layer6ï¼ˆä½¿ç”¨çš„TileIdï¼‰è³‡æ–™ï¼Œç¸½è¨ˆ {totalItems} é …ã€‚å‹¾é¸è¦åˆªé™¤çš„é …ç›®ï¼š";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(710, 20);
            resultForm.Controls.Add(lblSummary);

            CheckedListBox clbItems = new CheckedListBox();
            clbItems.Location = new Point(10, 35);
            clbItems.Size = new Size(710, 380);
            clbItems.Font = new Font("Consolas", 9);
            clbItems.CheckOnClick = true;

            List<(string filePath, int tileId)> itemInfoList = new List<(string, int)>();

            if (s32WithL6.Count == 0)
            {
                clbItems.Items.Add("æ²’æœ‰ä»»ä½• S32 æª”æ¡ˆæœ‰ Layer6 è³‡æ–™");
                clbItems.Enabled = false;
            }
            else
            {
                foreach (var (filePath, fileName, items) in s32WithL6)
                {
                    foreach (var tileId in items.OrderBy(x => x))
                    {
                        string displayText = $"[{fileName}] TileId={tileId}";
                        clbItems.Items.Add(displayText);
                        itemInfoList.Add((filePath, tileId));
                    }
                }
            }
            resultForm.Controls.Add(clbItems);

            Button btnSelectAll = new Button();
            btnSelectAll.Text = "å…¨é¸";
            btnSelectAll.Location = new Point(10, 425);
            btnSelectAll.Size = new Size(80, 30);
            btnSelectAll.Click += (s, args) =>
            {
                for (int i = 0; i < clbItems.Items.Count; i++)
                    clbItems.SetItemChecked(i, true);
            };
            resultForm.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button();
            btnDeselectAll.Text = "å–æ¶ˆå…¨é¸";
            btnDeselectAll.Location = new Point(100, 425);
            btnDeselectAll.Size = new Size(80, 30);
            btnDeselectAll.Click += (s, args) =>
            {
                for (int i = 0; i < clbItems.Items.Count; i++)
                    clbItems.SetItemChecked(i, false);
            };
            resultForm.Controls.Add(btnDeselectAll);

            // æª¢æŸ¥èˆ‡è‡ªå‹•ä¿®å¾©ç¼ºå¤±çš„ TileId
            Button btnCheckMissing = new Button();
            btnCheckMissing.Text = "æª¢æŸ¥ç¼ºå¤±ä¸¦è‡ªå‹•ä¿®å¾©";
            btnCheckMissing.Location = new Point(200, 425);
            btnCheckMissing.Size = new Size(150, 30);
            btnCheckMissing.Click += (s, args) =>
            {
                int totalFixed = 0;
                foreach (var kvp in _document.S32Files)
                {
                    S32Data s32Data = kvp.Value;
                    HashSet<int> layer6Set = new HashSet<int>(s32Data.Layer6);
                    bool modified = false;

                    // åŠ å…¥ Layer1 ç¼ºå°‘çš„ TileId
                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId > 0 && !layer6Set.Contains(cell.TileId))
                            {
                                s32Data.Layer6.Add(cell.TileId);
                                layer6Set.Add(cell.TileId);
                                modified = true;
                                totalFixed++;
                            }
                        }
                    }

                    // åŠ å…¥ Layer4 ç¼ºå°‘çš„ TileId
                    foreach (var obj in s32Data.Layer4)
                    {
                        if (obj.TileId > 0 && !layer6Set.Contains(obj.TileId))
                        {
                            s32Data.Layer6.Add(obj.TileId);
                            layer6Set.Add(obj.TileId);
                            modified = true;
                            totalFixed++;
                        }
                    }

                    if (modified)
                    {
                        s32Data.IsModified = true;
                    }
                }

                if (totalFixed > 0)
                {
                    MessageBox.Show($"å·²å°‡ {totalFixed} å€‹ç¼ºå°‘çš„ TileId åŠ å…¥åˆ° Layer6ã€‚\nè«‹è¨˜å¾—å„²å­˜ä¿®æ”¹ã€‚",
                        "ä¿®å¾©å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    resultForm.Close();
                }
                else
                {
                    MessageBox.Show("æ‰€æœ‰ S32 çš„ Layer6 éƒ½å·²å®Œæ•´ï¼Œç„¡éœ€ä¿®å¾©ã€‚", "æª¢æŸ¥å®Œæˆ",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            };
            resultForm.Controls.Add(btnCheckMissing);

            Button btnClearSelected = new Button();
            btnClearSelected.Text = "åˆªé™¤å‹¾é¸é …ç›®";
            btnClearSelected.Location = new Point(10, 465);
            btnClearSelected.Size = new Size(120, 35);
            btnClearSelected.BackColor = Color.LightCoral;
            btnClearSelected.Enabled = s32WithL6.Count > 0;
            btnClearSelected.Click += (s, args) =>
            {
                if (clbItems.CheckedIndices.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åˆªé™¤å‹¾é¸çš„ {clbItems.CheckedIndices.Count} å€‹ Layer6 é …ç›®å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆªé™¤ L6 ä¸­çš„ TileId å¯èƒ½æœƒå½±éŸ¿éŠæˆ²é¡¯ç¤ºã€‚",
                    "ç¢ºèªåˆªé™¤",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                Dictionary<string, List<int>> toRemove = new Dictionary<string, List<int>>();
                foreach (int idx in clbItems.CheckedIndices)
                {
                    var info = itemInfoList[idx];
                    if (!toRemove.ContainsKey(info.filePath))
                        toRemove[info.filePath] = new List<int>();
                    toRemove[info.filePath].Add(info.tileId);
                }

                int removedCount = 0;
                foreach (var kvp in toRemove)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out S32Data s32Data))
                    {
                        foreach (var tileId in kvp.Value)
                        {
                            if (s32Data.Layer6.Remove(tileId))
                                removedCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {removedCount} å€‹ Layer6 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button();
            btnClearAll.Text = "æ¸…é™¤å…¨éƒ¨ L6";
            btnClearAll.Location = new Point(140, 465);
            btnClearAll.Size = new Size(120, 35);
            btnClearAll.BackColor = Color.Salmon;
            btnClearAll.Enabled = s32WithL6.Count > 0;
            btnClearAll.Click += (s, args) =>
            {
                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ {totalItems} å€‹ Layer6 é …ç›®å—ï¼Ÿ\n\nè­¦å‘Šï¼šé€™å¯èƒ½æœƒåš´é‡å½±éŸ¿éŠæˆ²é¡¯ç¤ºï¼",
                    "ç¢ºèªæ¸…é™¤å…¨éƒ¨",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int removedCount = 0;
                foreach (var (filePath, fileName, items) in s32WithL6)
                {
                    if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                    {
                        removedCount += s32Data.Layer6.Count;
                        s32Data.Layer6.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²æ¸…é™¤ {removedCount} å€‹ Layer6 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearAll);

            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(630, 465);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            resultForm.Resize += (s, args) =>
            {
                clbItems.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 130);
                btnSelectAll.Location = new Point(10, resultForm.ClientSize.Height - 85);
                btnDeselectAll.Location = new Point(100, resultForm.ClientSize.Height - 85);
                btnCheckMissing.Location = new Point(200, resultForm.ClientSize.Height - 85);
                btnClearSelected.Location = new Point(10, resultForm.ClientSize.Height - 45);
                btnClearAll.Location = new Point(140, resultForm.ClientSize.Height - 45);
                btnClose.Location = new Point(resultForm.ClientSize.Width - 100, resultForm.ClientSize.Height - 45);
            };

            resultForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡ç·¨è¼¯ç¬¬å…«å±¤ï¼ˆç‰¹æ•ˆï¼‰è³‡æ–™
        private void btnToolCheckL8_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show(LocalizationManager.L("Message_PleaseLoadMap"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // å–å¾—åœ°åœ–é¸å–å€åŸŸæ¶‰åŠçš„ S32 æª”æ¡ˆè·¯å¾‘
            HashSet<string> selectedS32Paths = new HashSet<string>();
            if (_editState.SelectedCells != null && _editState.SelectedCells.Count > 0)
            {
                foreach (var cell in _editState.SelectedCells)
                {
                    // å¾é¸å–çš„æ ¼å­ç›´æ¥å–å¾— S32 æª”æ¡ˆè·¯å¾‘
                    if (cell.S32Data != null)
                    {
                        // æ‰¾åˆ°å°æ‡‰çš„æª”æ¡ˆè·¯å¾‘
                        foreach (var kvp in _document.S32Files)
                        {
                            if (kvp.Value == cell.S32Data)
                            {
                                selectedS32Paths.Add(kvp.Key);
                                break;
                            }
                        }
                    }
                }
            }

            // æ”¶é›†æœ‰ Layer8 è³‡æ–™çš„ S32ï¼ˆå…¨éƒ¨ï¼‰
            List<(string filePath, string fileName, int count, List<Layer8Item> items)> s32WithL8All =
                new List<(string, string, int, List<Layer8Item>)>();
            // æ”¶é›†æœ‰ Layer8 è³‡æ–™çš„ S32ï¼ˆé¸å–å€åŸŸæ¶‰åŠçš„ï¼‰
            List<(string filePath, string fileName, int count, List<Layer8Item> items)> s32WithL8Selected =
                new List<(string, string, int, List<Layer8Item>)>();

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer8.Count > 0)
                {
                    var entry = (filePath, fileName, s32Data.Layer8.Count, s32Data.Layer8.ToList());
                    s32WithL8All.Add(entry);
                    if (selectedS32Paths.Contains(filePath))
                    {
                        s32WithL8Selected.Add(entry);
                    }
                }
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = LocalizationManager.L("L8_Title");
            resultForm.Size = new Size(850, 680);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            int totalItemsAll = s32WithL8All.Sum(x => x.count);
            int totalItemsSelected = s32WithL8Selected.Sum(x => x.count);
            int extendedCount = _document.S32Files.Values.Count(s => s.Layer8HasExtendedData);
            Label lblSummary = new Label();
            lblSummary.Text = string.Format(LocalizationManager.L("L8_Summary"), s32WithL8Selected.Count, totalItemsSelected, s32WithL8All.Count, totalItemsAll, extendedCount);
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(810, 20);
            resultForm.Controls.Add(lblSummary);

            // å»ºç«‹ TabControl
            TabControl tabControl = new TabControl();
            tabControl.Location = new Point(10, 115);
            tabControl.Size = new Size(810, 330);

            TabPage tabAll = new TabPage(string.Format(LocalizationManager.L("L8_TabAll"), s32WithL8All.Count));
            TabPage tabSelected = new TabPage(string.Format(LocalizationManager.L("L8_TabSelected"), s32WithL8Selected.Count));
            tabControl.TabPages.Add(tabAll);
            tabControl.TabPages.Add(tabSelected);

            // ListView æ’åºç‹€æ…‹
            Dictionary<ListView, (int column, bool ascending)> sortStates = new Dictionary<ListView, (int, bool)>();

            // SPR åœ–ç‰‡å¿«å–
            Dictionary<int, Image> sprImageCache = new Dictionary<int, Image>();
            Dictionary<int, Image> sprFullImageCache = new Dictionary<int, Image>(); // å¤§åœ–å¿«å–
            HashSet<int> sprLoadFailed = new HashSet<int>(); // è¿½è¹¤è¼‰å…¥å¤±æ•—çš„ SPR
            ImageList sprImageList = new ImageList();
            sprImageList.ImageSize = new Size(48, 48);
            sprImageList.ColorDepth = ColorDepth.Depth32Bit;

            // å‹•ç•«å¿«å–ï¼šå„²å­˜æ‰€æœ‰å¸§
            Dictionary<int, List<Image>> sprAnimationCache = new Dictionary<int, List<Image>>();

            // å°‡ RGBA åƒç´ è½‰æ›ç‚º BGRA ä¸¦å»ºç«‹ Bitmap
            Bitmap CreateBitmapFromRgba(byte[] rgbaPixels, int width, int height)
            {
                byte[] bgraPixels = new byte[rgbaPixels.Length];
                for (int i = 0; i < rgbaPixels.Length; i += 4)
                {
                    bgraPixels[i + 0] = rgbaPixels[i + 2]; // B <- R
                    bgraPixels[i + 1] = rgbaPixels[i + 1]; // G <- G
                    bgraPixels[i + 2] = rgbaPixels[i + 0]; // R <- B
                    bgraPixels[i + 3] = rgbaPixels[i + 3]; // A <- A
                }
                Bitmap bmp = new Bitmap(width, height, PixelFormat.Format32bppArgb);
                var bmpData = bmp.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);
                System.Runtime.InteropServices.Marshal.Copy(bgraPixels, 0, bmpData.Scan0, bgraPixels.Length);
                bmp.UnlockBits(bmpData);
                return bmp;
            }

            // è¼‰å…¥ SPR åœ–ç‰‡çš„è¼”åŠ©æ–¹æ³• (è¿”å›ç¸®åœ–, æˆåŠŸæ™‚ä¹Ÿå¿«å–å¤§åœ–å’Œå‹•ç•«å¸§)
            Image LoadSprImage(int sprId)
            {
                if (sprImageCache.TryGetValue(sprId, out Image cached))
                    return cached;

                try
                {
                    string sprKey = $"{sprId}-0.spr";
                    byte[] sprData = L1PakReader.UnPack("Sprite", sprKey);
                    if (sprData != null && sprData.Length > 0)
                    {
                        var frames = SprReader.LoadRaw(sprData);
                        if (frames != null && frames.Length > 0)
                        {
                            // è¼‰å…¥æ‰€æœ‰å¸§åˆ°å‹•ç•«å¿«å–
                            List<Image> animFrames = new List<Image>();
                            foreach (var f in frames)
                            {
                                if (f.Width > 0 && f.Height > 0 && f.Pixels != null)
                                {
                                    animFrames.Add(CreateBitmapFromRgba(f.Pixels, f.Width, f.Height));
                                }
                            }
                            if (animFrames.Count > 0)
                            {
                                sprAnimationCache[sprId] = animFrames;
                                sprFullImageCache[sprId] = animFrames[0]; // ç¬¬ä¸€å¸§ä½œç‚ºéœæ…‹é è¦½
                            }

                            var frame = frames[0];
                            if (frame.Width > 0 && frame.Height > 0 && frame.Pixels != null)
                            {
                                Bitmap fullBmp = (Bitmap)animFrames[0];

                                // å»ºç«‹ 48x48 çš„ç¸®åœ–
                                Bitmap bmp = new Bitmap(48, 48, PixelFormat.Format32bppArgb);
                                using (Graphics g = Graphics.FromImage(bmp))
                                {
                                    g.Clear(Color.FromArgb(40, 40, 40));
                                    // ç¸®æ”¾åˆ° 48x48 ä¸¦ç½®ä¸­
                                    float scale = Math.Min(44f / frame.Width, 44f / frame.Height);
                                    int newW = (int)(frame.Width * scale);
                                    int newH = (int)(frame.Height * scale);
                                    int x = (48 - newW) / 2;
                                    int y = (48 - newH) / 2;
                                    g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBilinear;
                                    g.DrawImage(fullBmp, x, y, newW, newH);
                                }
                                sprImageCache[sprId] = bmp;
                                return bmp;
                            }
                        }
                    }
                }
                catch { }

                // è¼‰å…¥å¤±æ•—
                sprLoadFailed.Add(sprId);

                // å»ºç«‹ä½”ä½åœ–
                Bitmap placeholder = new Bitmap(48, 48, PixelFormat.Format32bppArgb);
                using (Graphics g = Graphics.FromImage(placeholder))
                {
                    g.Clear(Color.FromArgb(60, 60, 60));
                    using (Font font = new Font("Consolas", 7))
                    {
                        string text = sprId.ToString();
                        var size = g.MeasureString(text, font);
                        g.DrawString(text, font, Brushes.Gray, (48 - size.Width) / 2, (48 - size.Height) / 2);
                    }
                }
                sprImageCache[sprId] = placeholder;
                return placeholder;
            }

            // å»ºç«‹å…©å€‹ ListView çš„è¼”åŠ©æ–¹æ³•
            // æ¬„ä½é †åº: S32æª”æ¡ˆ(0), æ“´å±•(1), SprId(2), é è¦½(3), X(4), Y(5), ExtData(6)
            ListView CreateL8ListView()
            {
                ListView lv = new ListView();
                lv.Dock = DockStyle.Fill;
                lv.Font = new Font("Consolas", 9);
                lv.View = View.Details;
                lv.FullRowSelect = true;
                lv.CheckBoxes = true;
                lv.SmallImageList = sprImageList;
                lv.Columns.Add(LocalizationManager.L("L8_Column_File"), 100);
                lv.Columns.Add(LocalizationManager.L("L8_Column_Extended"), 45);
                lv.Columns.Add(LocalizationManager.L("L8_Column_SprId"), 60);
                lv.Columns.Add(LocalizationManager.L("L8_Column_Preview"), 55);
                lv.Columns.Add(LocalizationManager.L("L8_Column_X"), 50);
                lv.Columns.Add(LocalizationManager.L("L8_Column_Y"), 50);
                lv.Columns.Add(LocalizationManager.L("L8_Column_ExtData"), 70);

                // åˆå§‹åŒ–æ’åºç‹€æ…‹
                sortStates[lv] = (-1, true);

                // é»æ“Šæ¨™é¡Œæ’åº
                lv.ColumnClick += (sender, e) =>
                {
                    ListView listView = sender as ListView;
                    if (listView == null) return;

                    var (lastColumn, ascending) = sortStates[listView];
                    bool newAscending = (lastColumn == e.Column) ? !ascending : true;
                    sortStates[listView] = (e.Column, newAscending);

                    listView.ListViewItemSorter = new ListViewColumnSorter(e.Column, newAscending);
                    listView.Sort();
                };

                return lv;
            }

            ListView lvSelected = CreateL8ListView();
            ListView lvAll = CreateL8ListView();
            tabSelected.Controls.Add(lvSelected);
            tabAll.Controls.Add(lvAll);

            // é è¦½å€åŸŸ (å³å´)
            GroupBox gbPreview = new GroupBox();
            gbPreview.Text = LocalizationManager.L("L8_Preview");
            gbPreview.Location = new Point(640, 115);
            gbPreview.Size = new Size(180, 330);
            resultForm.Controls.Add(gbPreview);

            PictureBox pbPreview = new PictureBox();
            pbPreview.Location = new Point(10, 20);
            pbPreview.Size = new Size(160, 160);
            pbPreview.BackColor = Color.FromArgb(40, 40, 40);
            pbPreview.SizeMode = PictureBoxSizeMode.Zoom;
            pbPreview.BorderStyle = BorderStyle.FixedSingle;
            gbPreview.Controls.Add(pbPreview);

            Label lblPreviewInfo = new Label();
            lblPreviewInfo.Location = new Point(10, 185);
            lblPreviewInfo.Size = new Size(160, 45);
            lblPreviewInfo.Text = LocalizationManager.L("L8_SelectToPreview");
            lblPreviewInfo.ForeColor = Color.Gray;
            gbPreview.Controls.Add(lblPreviewInfo);

            // è·³è½‰æŒ‰éˆ•
            Button btnJumpToLocation = new Button();
            btnJumpToLocation.Text = LocalizationManager.L("L8_JumpToLocation");
            btnJumpToLocation.Location = new Point(10, 232);
            btnJumpToLocation.Size = new Size(160, 25);
            btnJumpToLocation.Enabled = false;
            gbPreview.Controls.Add(btnJumpToLocation);

            // ç¯©é¸ç„¡åœ–é …ç›®
            CheckBox chkFilterNoImage = new CheckBox();
            chkFilterNoImage.Text = LocalizationManager.L("L8_FilterNoImage");
            chkFilterNoImage.Location = new Point(10, 260);
            chkFilterNoImage.Size = new Size(160, 24);
            chkFilterNoImage.ForeColor = Color.OrangeRed;
            gbPreview.Controls.Add(chkFilterNoImage);

            Label lblNoImageCount = new Label();
            lblNoImageCount.Location = new Point(10, 285);
            lblNoImageCount.Size = new Size(160, 20);
            lblNoImageCount.ForeColor = Color.Gray;
            gbPreview.Controls.Add(lblNoImageCount);

            // å‹•ç•«æ’­æ”¾æ§åˆ¶
            System.Windows.Forms.Timer animTimer = new System.Windows.Forms.Timer();
            animTimer.Interval = 100; // 100ms per frame
            int currentAnimFrame = 0;
            List<Image> currentAnimFrames = null;
            int currentAnimSprId = -1;

            animTimer.Tick += (s, args) =>
            {
                if (currentAnimFrames != null && currentAnimFrames.Count > 1)
                {
                    currentAnimFrame = (currentAnimFrame + 1) % currentAnimFrames.Count;
                    pbPreview.Image = currentAnimFrames[currentAnimFrame];
                }
            };

            // è¡¨å–®é—œé–‰æ™‚åœæ­¢å‹•ç•«
            resultForm.FormClosed += (s, args) =>
            {
                animTimer.Stop();
                animTimer.Dispose();
            };

            // èª¿æ•´ TabControl å¤§å°ä»¥å®¹ç´é è¦½å€
            tabControl.Size = new Size(620, 330);
            resultForm.Controls.Add(tabControl);

            // ç›®å‰ä½œç”¨ä¸­çš„ ListViewï¼ˆç”¨æ–¼ç·¨è¼¯æ“ä½œï¼‰
            ListView lvItems = lvSelected;
            tabControl.SelectedIndexChanged += (s, args) =>
            {
                lvItems = tabControl.SelectedIndex == 0 ? lvSelected : lvAll;
            };

            // ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™ s32WithL8 è®Šæ•¸æŒ‡å‘å…¨éƒ¨è³‡æ–™
            var s32WithL8 = s32WithL8All;
            int totalItems = totalItemsAll;

            // æ“´å±•æ ¼å¼è¨­å®šå€
            GroupBox gbExtended = new GroupBox();
            gbExtended.Text = LocalizationManager.L("L8_ExtendedSettings");
            gbExtended.Location = new Point(10, 35);
            gbExtended.Size = new Size(810, 75);

            Label lblExtendedInfo = new Label();
            lblExtendedInfo.Text = LocalizationManager.L("L8_ExtendedInfo");
            lblExtendedInfo.Location = new Point(10, 18);
            lblExtendedInfo.Size = new Size(550, 20);
            gbExtended.Controls.Add(lblExtendedInfo);

            ComboBox cmbS32Extended = new ComboBox();
            cmbS32Extended.Location = new Point(10, 42);
            cmbS32Extended.Size = new Size(200, 23);
            cmbS32Extended.DropDownStyle = ComboBoxStyle.DropDownList;
            foreach (var kvp in _document.S32Files)
            {
                string fileName = Path.GetFileName(kvp.Key);
                string extMark = kvp.Value.Layer8HasExtendedData ? $" [{LocalizationManager.L("L8_ExtendedFormat")}]" : "";
                cmbS32Extended.Items.Add(new { FilePath = kvp.Key, Display = $"{fileName}{extMark}" });
            }
            cmbS32Extended.DisplayMember = "Display";
            if (cmbS32Extended.Items.Count > 0) cmbS32Extended.SelectedIndex = 0;
            gbExtended.Controls.Add(cmbS32Extended);

            Label lblCurrentStatus = new Label();
            lblCurrentStatus.Location = new Point(220, 45);
            lblCurrentStatus.Size = new Size(150, 20);
            lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), LocalizationManager.L("L8_NotSelected"));
            gbExtended.Controls.Add(lblCurrentStatus);

            Button btnSetExtended = new Button();
            btnSetExtended.Text = LocalizationManager.L("L8_SetExtended");
            btnSetExtended.Location = new Point(380, 40);
            btnSetExtended.Size = new Size(90, 28);
            btnSetExtended.Click += (s, args) =>
            {
                if (cmbS32Extended.SelectedItem == null) return;
                dynamic selected = cmbS32Extended.SelectedItem;
                string filePath = selected.FilePath;
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    s32Data.Layer8HasExtendedData = true;
                    s32Data.IsModified = true;
                    lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), LocalizationManager.L("L8_ExtendedFormat"));
                    // æ›´æ–° ComboBox é¡¯ç¤º
                    int idx = cmbS32Extended.SelectedIndex;
                    cmbS32Extended.Items[idx] = new { FilePath = filePath, Display = $"{Path.GetFileName(filePath)} [{LocalizationManager.L("L8_ExtendedFormat")}]" };
                    cmbS32Extended.SelectedIndex = idx;
                    // æ›´æ–° ListView ä¸­è©² S32 çš„é …ç›®
                    foreach (ListViewItem lvi in lvItems.Items)
                    {
                        if (lvi.Tag == null) continue;
                        var (lvFilePath, lvItem) = ((string, Layer8Item))lvi.Tag;
                        if (lvFilePath == filePath)
                        {
                            lvi.SubItems[1].Text = LocalizationManager.L("L8_Yes");  // æ“´å±•æ¬„ä½ (ç´¢å¼• 1)
                        }
                    }
                    // æ›´æ–°æ‘˜è¦
                    int newExtCount = _document.S32Files.Values.Count(x => x.Layer8HasExtendedData);
                    lblSummary.Text = string.Format(LocalizationManager.L("L8_Summary"), s32WithL8Selected.Count, totalItemsSelected, s32WithL8All.Count, totalItemsAll, newExtCount);
                    MessageBox.Show(string.Format(LocalizationManager.L("L8_SetExtendedDone"), Path.GetFileName(filePath)), LocalizationManager.L("Title_Success"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            };
            gbExtended.Controls.Add(btnSetExtended);

            Button btnSetNormal = new Button();
            btnSetNormal.Text = LocalizationManager.L("L8_SetNormal");
            btnSetNormal.Location = new Point(480, 40);
            btnSetNormal.Size = new Size(90, 28);
            btnSetNormal.Click += (s, args) =>
            {
                if (cmbS32Extended.SelectedItem == null) return;
                dynamic selected = cmbS32Extended.SelectedItem;
                string filePath = selected.FilePath;
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    s32Data.Layer8HasExtendedData = false;
                    // æ¸…é™¤æ‰€æœ‰ Layer8 é …ç›®çš„ ExtendedData
                    foreach (var item in s32Data.Layer8)
                    {
                        item.ExtendedData = 0;
                    }
                    s32Data.IsModified = true;
                    lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), LocalizationManager.L("L8_NormalFormat"));
                    // æ›´æ–° ComboBox é¡¯ç¤º
                    int idx = cmbS32Extended.SelectedIndex;
                    cmbS32Extended.Items[idx] = new { FilePath = filePath, Display = Path.GetFileName(filePath) };
                    cmbS32Extended.SelectedIndex = idx;
                    // æ›´æ–° ListView ä¸­è©² S32 çš„é …ç›®
                    foreach (ListViewItem lvi in lvItems.Items)
                    {
                        if (lvi.Tag == null) continue;
                        var (lvFilePath, lvItem) = ((string, Layer8Item))lvi.Tag;
                        if (lvFilePath == filePath)
                        {
                            lvi.SubItems[1].Text = "";  // æ“´å±•æ¬„ä½ (ç´¢å¼• 1)
                            lvi.SubItems[6].Text = "0"; // ExtData æ¬„ä½ (ç´¢å¼• 6)
                        }
                    }
                    // æ›´æ–°æ‘˜è¦
                    int newExtCount = _document.S32Files.Values.Count(x => x.Layer8HasExtendedData);
                    lblSummary.Text = string.Format(LocalizationManager.L("L8_Summary"), s32WithL8Selected.Count, totalItemsSelected, s32WithL8All.Count, totalItemsAll, newExtCount);
                    MessageBox.Show(string.Format(LocalizationManager.L("L8_SetNormalDone"), Path.GetFileName(filePath), s32Data.Layer8.Count), LocalizationManager.L("Title_Success"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            };
            gbExtended.Controls.Add(btnSetNormal);

            Button btnResetAllExtended = new Button();
            btnResetAllExtended.Text = LocalizationManager.L("L8_ResetAll");
            btnResetAllExtended.Location = new Point(580, 40);
            btnResetAllExtended.Size = new Size(120, 28);
            btnResetAllExtended.BackColor = Color.LightYellow;
            btnResetAllExtended.Click += (s, args) =>
            {
                int currentExtCount = _document.S32Files.Values.Count(x => x.Layer8HasExtendedData);
                if (currentExtCount == 0)
                {
                    MessageBox.Show(LocalizationManager.L("L8_NoExtendedFiles"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                var confirmResult = MessageBox.Show(
                    string.Format(LocalizationManager.L("L8_ConfirmResetAll"), currentExtCount),
                    LocalizationManager.L("L8_ConfirmResetTitle"),
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);
                if (confirmResult != DialogResult.Yes) return;

                int clearedItemCount = 0;
                foreach (var s32Data in _document.S32Files.Values)
                {
                    if (s32Data.Layer8HasExtendedData)
                    {
                        s32Data.Layer8HasExtendedData = false;
                        // æ¸…é™¤æ‰€æœ‰ Layer8 é …ç›®çš„ ExtendedData
                        foreach (var item in s32Data.Layer8)
                        {
                            item.ExtendedData = 0;
                            clearedItemCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }
                // é‡æ–°å¡«å…¥ ComboBox
                cmbS32Extended.Items.Clear();
                foreach (var kvp in _document.S32Files)
                {
                    cmbS32Extended.Items.Add(new { FilePath = kvp.Key, Display = Path.GetFileName(kvp.Key) });
                }
                if (cmbS32Extended.Items.Count > 0) cmbS32Extended.SelectedIndex = 0;
                lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), LocalizationManager.L("L8_NormalFormat"));
                // æ›´æ–° ListView ä¸­æ‰€æœ‰é …ç›®çš„æ“´å±•æ¬„ä½ (ç´¢å¼•: 0=æª”æ¡ˆ, 1=æ“´å±•, 2=SprId, 3=é è¦½, 4=X, 5=Y, 6=ExtData)
                foreach (ListViewItem lvi in lvItems.Items)
                {
                    lvi.SubItems[1].Text = "";  // æ“´å±•æ¬„ä½ (ç´¢å¼• 1)
                    lvi.SubItems[6].Text = "0"; // ExtData æ¬„ä½ (ç´¢å¼• 6)
                }
                lblSummary.Text = string.Format(LocalizationManager.L("L8_Summary"), s32WithL8Selected.Count, totalItemsSelected, s32WithL8All.Count, totalItemsAll, 0);
                MessageBox.Show(string.Format(LocalizationManager.L("L8_ResetAllDone"), currentExtCount, clearedItemCount), LocalizationManager.L("Title_Success"), MessageBoxButtons.OK, MessageBoxIcon.Information);
            };
            gbExtended.Controls.Add(btnResetAllExtended);

            cmbS32Extended.SelectedIndexChanged += (s, args) =>
            {
                if (cmbS32Extended.SelectedItem == null) return;
                dynamic selected = cmbS32Extended.SelectedItem;
                string filePath = selected.FilePath;
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), s32Data.Layer8HasExtendedData ? LocalizationManager.L("L8_ExtendedFormat") : LocalizationManager.L("L8_NormalFormat"));
                }
            };
            // åˆå§‹é¡¯ç¤º
            if (cmbS32Extended.Items.Count > 0)
            {
                dynamic firstItem = cmbS32Extended.Items[0];
                if (_document.S32Files.TryGetValue(firstItem.FilePath, out S32Data firstS32))
                {
                    lblCurrentStatus.Text = string.Format(LocalizationManager.L("L8_CurrentStatus"), firstS32.Layer8HasExtendedData ? LocalizationManager.L("L8_ExtendedFormat") : LocalizationManager.L("L8_NormalFormat"));
                }
            }
            resultForm.Controls.Add(gbExtended);

            // å¡«å…¥ ListView è³‡æ–™çš„è¼”åŠ©æ–¹æ³•
            // æ¬„ä½é †åº: S32æª”æ¡ˆ(0), æ“´å±•(1), SprId(2), é è¦½(3), X(4), Y(5), ExtData(6)
            void FillListView(ListView lv, List<(string filePath, string fileName, int count, List<Layer8Item> items)> dataList, bool filterNoImage = false)
            {
                lv.Items.Clear();
                if (dataList.Count == 0)
                {
                    lv.Items.Add(new ListViewItem(LocalizationManager.L("L8_NoExtendedFiles")));
                    lv.Enabled = false;
                }
                else
                {
                    foreach (var (filePath, fileName, count, items) in dataList)
                    {
                        bool hasExtended = _document.S32Files.TryGetValue(filePath, out S32Data s32) && s32.Layer8HasExtendedData;
                        foreach (var item in items)
                        {
                            // ç¯©é¸ç„¡åœ–é …ç›®
                            if (filterNoImage && !sprLoadFailed.Contains(item.SprId))
                                continue;

                            // è¼‰å…¥ SPR åœ–ç‰‡
                            Image sprImg = LoadSprImage(item.SprId);
                            string imgKey = $"spr_{item.SprId}";
                            if (!sprImageList.Images.ContainsKey(imgKey))
                            {
                                sprImageList.Images.Add(imgKey, sprImg);
                            }

                            // æ¬„ä½é †åº: S32æª”æ¡ˆ(0), æ“´å±•(1), SprId(2), é è¦½(3), X(4), Y(5), ExtData(6)
                            ListViewItem lvi = new ListViewItem(fileName);
                            lvi.SubItems.Add(hasExtended ? LocalizationManager.L("L8_Yes") : "");
                            lvi.SubItems.Add(item.SprId.ToString());
                            lvi.SubItems.Add(""); // é è¦½æ¬„ä½ (åœ–ç‰‡)
                            lvi.SubItems[3].Tag = imgKey; // å„²å­˜åœ–ç‰‡ key
                            lvi.ImageKey = imgKey; // ä½¿ç”¨ ImageKey é¡¯ç¤ºåœ–ç‰‡
                            lvi.SubItems.Add(item.X.ToString());
                            lvi.SubItems.Add(item.Y.ToString());
                            lvi.SubItems.Add(item.ExtendedData.ToString());
                            lvi.Tag = (filePath, item);
                            lv.Items.Add(lvi);
                        }
                    }
                }
            }

            // å¡«å…¥å…©å€‹ ListView
            FillListView(lvSelected, s32WithL8Selected);
            FillListView(lvAll, s32WithL8All);

            // æ›´æ–°ç„¡åœ–é …ç›®è¨ˆæ•¸
            int noImageCount = sprLoadFailed.Count;
            lblNoImageCount.Text = string.Format(LocalizationManager.L("L8_NoImageCount"), noImageCount);

            // ç¯©é¸ç„¡åœ–é …ç›®
            chkFilterNoImage.CheckedChanged += (s, args) =>
            {
                FillListView(lvSelected, s32WithL8Selected, chkFilterNoImage.Checked);
                FillListView(lvAll, s32WithL8All, chkFilterNoImage.Checked);
            };

            // ç›®å‰é¸å–çš„é …ç›®è³‡è¨Š (ç”¨æ–¼è·³è½‰)
            (string filePath, Layer8Item item)? currentSelectedItem = null;

            // é¸å–é …ç›®æ™‚æ›´æ–°é è¦½
            void UpdatePreview(ListView lv)
            {
                if (lv.SelectedItems.Count == 1 && lv.SelectedItems[0].Tag != null)
                {
                    var lvi = lv.SelectedItems[0];
                    var (filePath, item) = ((string, Layer8Item))lvi.Tag;
                    currentSelectedItem = (filePath, item);
                    btnJumpToLocation.Enabled = true;

                    // æª¢æŸ¥æ˜¯å¦æœ‰å‹•ç•«å¸§
                    if (sprAnimationCache.TryGetValue(item.SprId, out List<Image> frames) && frames.Count > 0)
                    {
                        // è¨­å®šå‹•ç•«
                        currentAnimFrames = frames;
                        currentAnimFrame = 0;
                        currentAnimSprId = item.SprId;
                        pbPreview.Image = frames[0];

                        string frameInfo = frames.Count > 1 ? $" ({frames.Count} å¸§)" : "";
                        lblPreviewInfo.Text = $"SprId: {item.SprId}{frameInfo}\nå¤§å°: {frames[0].Width}x{frames[0].Height}\nä½ç½®: ({item.X}, {item.Y})";
                        lblPreviewInfo.ForeColor = Color.White;

                        // åªæœ‰å¤šå¸§æ‰å•Ÿå‹•å‹•ç•«
                        if (frames.Count > 1)
                        {
                            animTimer.Start();
                        }
                        else
                        {
                            animTimer.Stop();
                        }
                    }
                    else if (sprFullImageCache.TryGetValue(item.SprId, out Image fullImg))
                    {
                        // åœæ­¢å‹•ç•«
                        animTimer.Stop();
                        currentAnimFrames = null;
                        currentAnimSprId = -1;

                        pbPreview.Image = fullImg;
                        lblPreviewInfo.Text = $"SprId: {item.SprId}\nå¤§å°: {fullImg.Width}x{fullImg.Height}\nä½ç½®: ({item.X}, {item.Y})";
                        lblPreviewInfo.ForeColor = Color.White;
                    }
                    else
                    {
                        // åœæ­¢å‹•ç•«
                        animTimer.Stop();
                        currentAnimFrames = null;
                        currentAnimSprId = -1;

                        pbPreview.Image = null;
                        lblPreviewInfo.Text = $"SprId: {item.SprId}\n(ç„¡æ³•è¼‰å…¥åœ–ç‰‡)\nä½ç½®: ({item.X}, {item.Y})";
                        lblPreviewInfo.ForeColor = Color.OrangeRed;
                    }
                }
                else
                {
                    // åœæ­¢å‹•ç•«
                    animTimer.Stop();
                    currentAnimFrames = null;
                    currentAnimSprId = -1;

                    currentSelectedItem = null;
                    btnJumpToLocation.Enabled = false;
                    pbPreview.Image = null;
                    lblPreviewInfo.Text = LocalizationManager.L("L8_SelectToPreview");
                    lblPreviewInfo.ForeColor = Color.Gray;
                }
            }

            lvSelected.SelectedIndexChanged += (s, args) => UpdatePreview(lvSelected);
            lvAll.SelectedIndexChanged += (s, args) => UpdatePreview(lvAll);

            // è·³è½‰æŒ‰éˆ•é»æ“Šäº‹ä»¶
            btnJumpToLocation.Click += (s, args) =>
            {
                if (currentSelectedItem == null) return;
                var (filePath, item) = currentSelectedItem.Value;

                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    // Layer8 çš„ X, Y æ˜¯ Layer3 åº§æ¨™ç³» (0-63)ï¼Œè½‰æ›ç‚ºå…¨åŸŸéŠæˆ²åº§æ¨™
                    int globalX = item.X;
                    int globalY = item.Y;

                    // ä½¿ç”¨æ—¢æœ‰çš„åº§æ¨™è·³è½‰æ–¹æ³•
                    JumpToGameCoordinate(globalX, globalY);

                    this.toolStripStatusLabel1.Text = string.Format(LocalizationManager.L("L8_JumpedToLocation"), globalX, globalY, item.SprId);
                }
            };

            List<(string filePath, Layer8Item item)> itemInfoList = new List<(string, Layer8Item)>();
            foreach (var (filePath, fileName, count, items) in s32WithL8All)
            {
                foreach (var item in items)
                {
                    itemInfoList.Add((filePath, item));
                }
            }

            // ç·¨è¼¯å€åŸŸ
            GroupBox gbEdit = new GroupBox();
            gbEdit.Text = LocalizationManager.L("L8_EditSection");
            gbEdit.Location = new Point(10, 455);
            gbEdit.Size = new Size(810, 80);

            Label lblSprId = new Label { Text = "SprId:", Location = new Point(10, 28), Size = new Size(45, 20) };
            TextBox txtSprId = new TextBox { Location = new Point(60, 25), Size = new Size(80, 23) };
            Label lblX = new Label { Text = "X:", Location = new Point(155, 28), Size = new Size(20, 20) };
            TextBox txtX = new TextBox { Location = new Point(175, 25), Size = new Size(80, 23) };
            Label lblY = new Label { Text = "Y:", Location = new Point(270, 28), Size = new Size(20, 20) };
            TextBox txtY = new TextBox { Location = new Point(290, 25), Size = new Size(80, 23) };
            Label lblExtData = new Label { Text = "ExtData:", Location = new Point(385, 28), Size = new Size(55, 20) };
            TextBox txtExtData = new TextBox { Location = new Point(445, 25), Size = new Size(80, 23) };

            Button btnApplyEdit = new Button();
            btnApplyEdit.Text = LocalizationManager.L("L8_ApplyEdit");
            btnApplyEdit.Location = new Point(545, 22);
            btnApplyEdit.Size = new Size(80, 28);
            btnApplyEdit.Click += (s, args) =>
            {
                if (lvItems.SelectedItems.Count != 1)
                {
                    MessageBox.Show(LocalizationManager.L("L8_SelectOneToEdit"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var lvi = lvItems.SelectedItems[0];
                var (filePath, item) = ((string, Layer8Item))lvi.Tag;

                if (!ushort.TryParse(txtSprId.Text, out ushort newSprId) ||
                    !ushort.TryParse(txtX.Text, out ushort newX) ||
                    !ushort.TryParse(txtY.Text, out ushort newY) ||
                    !int.TryParse(txtExtData.Text, out int newExtData))
                {
                    MessageBox.Show(LocalizationManager.L("L8_InvalidValue"), LocalizationManager.L("Title_Error"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æ›´æ–°è³‡æ–™
                item.SprId = newSprId;
                item.X = newX;
                item.Y = newY;
                item.ExtendedData = newExtData;

                // æ›´æ–° ListView é¡¯ç¤º (ç´¢å¼•: 0=æª”æ¡ˆ, 1=æ“´å±•, 2=SprId, 3=é è¦½, 4=X, 5=Y, 6=ExtData)
                lvi.SubItems[2].Text = item.SprId.ToString();
                lvi.SubItems[4].Text = item.X.ToString();
                lvi.SubItems[5].Text = item.Y.ToString();
                lvi.SubItems[6].Text = item.ExtendedData.ToString();

                // æ¨™è¨˜å·²ä¿®æ”¹
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    s32Data.IsModified = true;
                }

                MessageBox.Show(LocalizationManager.L("L8_EditApplied"), LocalizationManager.L("Title_Done"), MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            // æ–°å¢é …ç›®æŒ‰éˆ•
            Button btnAddNew = new Button();
            btnAddNew.Text = LocalizationManager.L("L8_AddNew");
            btnAddNew.Location = new Point(635, 22);
            btnAddNew.Size = new Size(60, 28);
            btnAddNew.Click += (s, args) =>
            {
                if (_document.S32Files.Count == 0)
                {
                    MessageBox.Show(LocalizationManager.L("Message_PleaseLoadMap"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!ushort.TryParse(txtSprId.Text, out ushort newSprId) ||
                    !ushort.TryParse(txtX.Text, out ushort newX) ||
                    !ushort.TryParse(txtY.Text, out ushort newY) ||
                    !int.TryParse(txtExtData.Text, out int newExtData))
                {
                    MessageBox.Show(LocalizationManager.L("L8_InvalidValue"), LocalizationManager.L("Title_Error"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // é¸æ“‡è¦åŠ å…¥çš„ S32 æª”æ¡ˆ
                var s32Files = _document.S32Files.Keys.Select(k => Path.GetFileName(k)).ToArray();
                Form selectForm = new Form();
                selectForm.Text = LocalizationManager.L("L8_SelectS32File");
                selectForm.Size = new Size(300, 150);
                selectForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                selectForm.StartPosition = FormStartPosition.CenterParent;

                Label lblSelect = new Label { Text = LocalizationManager.L("L8_SelectS32ForNewItem"), Location = new Point(10, 15), Size = new Size(260, 20) };
                ComboBox cmbS32 = new ComboBox { Location = new Point(10, 40), Size = new Size(260, 23), DropDownStyle = ComboBoxStyle.DropDownList };
                cmbS32.Items.AddRange(s32Files);
                if (cmbS32.Items.Count > 0) cmbS32.SelectedIndex = 0;

                Button btnOK = new Button { Text = LocalizationManager.L("Common_OK"), Location = new Point(100, 75), Size = new Size(80, 28), DialogResult = DialogResult.OK };
                selectForm.Controls.AddRange(new Control[] { lblSelect, cmbS32, btnOK });
                selectForm.AcceptButton = btnOK;

                if (selectForm.ShowDialog() == DialogResult.OK && cmbS32.SelectedIndex >= 0)
                {
                    string selectedFileName = cmbS32.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);

                    if (selectedFilePath != null && _document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        Layer8Item newItem = new Layer8Item
                        {
                            SprId = newSprId,
                            X = newX,
                            Y = newY,
                            ExtendedData = newExtData
                        };
                        s32Data.Layer8.Add(newItem);
                        s32Data.IsModified = true;

                        // è¼‰å…¥ SPR åœ–ç‰‡
                        Image sprImg = LoadSprImage(newSprId);
                        string imgKey = $"spr_{newSprId}";
                        if (!sprImageList.Images.ContainsKey(imgKey))
                        {
                            sprImageList.Images.Add(imgKey, sprImg);
                        }

                        // æ›´æ–° ListView (ç´¢å¼•: 0=æª”æ¡ˆ, 1=æ“´å±•, 2=SprId, 3=é è¦½, 4=X, 5=Y, 6=ExtData)
                        ListViewItem lvi = new ListViewItem(selectedFileName);
                        lvi.SubItems.Add(s32Data.Layer8HasExtendedData ? "æ˜¯" : "");
                        lvi.SubItems.Add(newItem.SprId.ToString());
                        lvi.SubItems.Add(""); // é è¦½æ¬„ä½
                        lvi.ImageKey = imgKey;
                        lvi.SubItems.Add(newItem.X.ToString());
                        lvi.SubItems.Add(newItem.Y.ToString());
                        lvi.SubItems.Add(newItem.ExtendedData.ToString());
                        lvi.Tag = (selectedFilePath, newItem);
                        lvItems.Items.Add(lvi);
                        itemInfoList.Add((selectedFilePath, newItem));

                        MessageBox.Show(string.Format(LocalizationManager.L("L8_ItemAdded"), selectedFileName), LocalizationManager.L("Title_Done"),
                            MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            };

            gbEdit.Controls.AddRange(new Control[] { lblSprId, txtSprId, lblX, txtX, lblY, txtY, lblExtData, txtExtData, btnApplyEdit, btnAddNew });
            resultForm.Controls.Add(gbEdit);

            // æ‰¹æ¬¡å–ä»£å€åŸŸ
            GroupBox gbBatchReplace = new GroupBox();
            gbBatchReplace.Text = LocalizationManager.L("L8_BatchReplace");
            gbBatchReplace.Location = new Point(10, 540);
            gbBatchReplace.Size = new Size(500, 50);

            Label lblFromSpr = new Label { Text = LocalizationManager.L("L8_FromSprId"), Location = new Point(10, 20), Size = new Size(60, 20) };
            TextBox txtFromSprId = new TextBox { Location = new Point(75, 17), Size = new Size(70, 23) };
            Label lblToSpr = new Label { Text = LocalizationManager.L("L8_ToSprId"), Location = new Point(155, 20), Size = new Size(40, 20) };
            TextBox txtToSprId = new TextBox { Location = new Point(195, 17), Size = new Size(70, 23) };

            Button btnBatchReplace = new Button();
            btnBatchReplace.Text = LocalizationManager.L("L8_BatchReplaceBtn");
            btnBatchReplace.Location = new Point(280, 15);
            btnBatchReplace.Size = new Size(80, 25);
            btnBatchReplace.Click += (s, args) =>
            {
                if (!ushort.TryParse(txtFromSprId.Text, out ushort fromSprId) ||
                    !ushort.TryParse(txtToSprId.Text, out ushort toSprId))
                {
                    MessageBox.Show(LocalizationManager.L("L8_InvalidSprId"), LocalizationManager.L("Title_Error"), MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                if (fromSprId == toSprId)
                {
                    MessageBox.Show(LocalizationManager.L("L8_SameSprId"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // è¨ˆç®—æœƒå½±éŸ¿å¤šå°‘é …ç›®
                int affectedCount = 0;
                foreach (var kvp in _document.S32Files)
                {
                    foreach (var item in kvp.Value.Layer8)
                    {
                        if (item.SprId == fromSprId) affectedCount++;
                    }
                }

                if (affectedCount == 0)
                {
                    MessageBox.Show(string.Format(LocalizationManager.L("L8_SprIdNotFound"), fromSprId), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    string.Format(LocalizationManager.L("L8_ConfirmBatchReplace"), fromSprId, affectedCount, toSprId),
                    LocalizationManager.L("L8_ConfirmBatchReplaceTitle"),
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);

                if (confirmResult != DialogResult.Yes) return;

                // åŸ·è¡Œæ‰¹æ¬¡å–ä»£
                int replacedCount = 0;
                HashSet<string> modifiedFiles = new HashSet<string>();
                foreach (var kvp in _document.S32Files)
                {
                    foreach (var item in kvp.Value.Layer8)
                    {
                        if (item.SprId == fromSprId)
                        {
                            item.SprId = toSprId;
                            replacedCount++;
                            modifiedFiles.Add(kvp.Key);
                        }
                    }
                    if (modifiedFiles.Contains(kvp.Key))
                    {
                        kvp.Value.IsModified = true;
                    }
                }

                // è¼‰å…¥æ–°çš„ SPR åœ–ç‰‡
                Image newSprImg = LoadSprImage(toSprId);
                string newImgKey = $"spr_{toSprId}";
                if (!sprImageList.Images.ContainsKey(newImgKey))
                {
                    sprImageList.Images.Add(newImgKey, newSprImg);
                }

                // æ›´æ–° ListView é¡¯ç¤º
                foreach (ListView lv in new[] { lvSelected, lvAll })
                {
                    foreach (ListViewItem lvi in lv.Items)
                    {
                        if (lvi.Tag == null) continue;
                        var (filePath, item) = ((string, Layer8Item))lvi.Tag;
                        if (item.SprId == toSprId && lvi.SubItems[2].Text == fromSprId.ToString())
                        {
                            lvi.SubItems[2].Text = toSprId.ToString();
                            lvi.ImageKey = newImgKey;
                        }
                    }
                }

                MessageBox.Show(
                    string.Format(LocalizationManager.L("L8_BatchReplaceComplete"), replacedCount, fromSprId, toSprId, modifiedFiles.Count),
                    LocalizationManager.L("L8_BatchReplaceCompleteTitle"),
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Information);
            };

            Label lblBatchHint = new Label { Text = LocalizationManager.L("L8_AffectsAllS32"), Location = new Point(370, 20), Size = new Size(120, 20), ForeColor = Color.Gray };

            gbBatchReplace.Controls.AddRange(new Control[] { lblFromSpr, txtFromSprId, lblToSpr, txtToSprId, btnBatchReplace, lblBatchHint });
            resultForm.Controls.Add(gbBatchReplace);

            // èª¿æ•´è¡¨å–®é«˜åº¦ä»¥å®¹ç´æ‰¹æ¬¡å–ä»£å€åŸŸ
            resultForm.Size = new Size(850, 730);

            // é¸å–é …ç›®æ™‚å¡«å…¥ç·¨è¼¯å€ï¼ˆç‚ºå…©å€‹ ListView éƒ½è¨»å†Šäº‹ä»¶ï¼‰
            void OnListViewSelectionChanged(object sender, EventArgs args)
            {
                ListView lv = sender as ListView;
                if (lv != null && lv.SelectedItems.Count == 1 && lv.SelectedItems[0].Tag != null)
                {
                    var lvi = lv.SelectedItems[0];
                    var (filePath, item) = ((string, Layer8Item))lvi.Tag;
                    txtSprId.Text = item.SprId.ToString();
                    txtX.Text = item.X.ToString();
                    txtY.Text = item.Y.ToString();
                    txtExtData.Text = item.ExtendedData.ToString();
                }
            }
            lvSelected.SelectedIndexChanged += OnListViewSelectionChanged;
            lvAll.SelectedIndexChanged += OnListViewSelectionChanged;

            Button btnSelectAll = new Button();
            btnSelectAll.Text = LocalizationManager.L("L8_SelectAll");
            btnSelectAll.Location = new Point(10, 600);
            btnSelectAll.Size = new Size(80, 30);
            btnSelectAll.Click += (s, args) =>
            {
                ListView currentLv = tabControl.SelectedIndex == 0 ? lvSelected : lvAll;
                foreach (ListViewItem lvi in currentLv.Items)
                    lvi.Checked = true;
            };
            resultForm.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button();
            btnDeselectAll.Text = LocalizationManager.L("L8_DeselectAll");
            btnDeselectAll.Location = new Point(100, 600);
            btnDeselectAll.Size = new Size(80, 30);
            btnDeselectAll.Click += (s, args) =>
            {
                ListView currentLv = tabControl.SelectedIndex == 0 ? lvSelected : lvAll;
                foreach (ListViewItem lvi in currentLv.Items)
                    lvi.Checked = false;
            };
            resultForm.Controls.Add(btnDeselectAll);

            Button btnClearSelected = new Button();
            btnClearSelected.Text = LocalizationManager.L("L8_DeleteChecked");
            btnClearSelected.Location = new Point(10, 640);
            btnClearSelected.Size = new Size(120, 35);
            btnClearSelected.BackColor = Color.LightCoral;
            btnClearSelected.Enabled = s32WithL8.Count > 0;
            btnClearSelected.Click += (s, args) =>
            {
                ListView currentLv = tabControl.SelectedIndex == 0 ? lvSelected : lvAll;
                int checkedCount = currentLv.CheckedItems.Count;
                if (checkedCount == 0)
                {
                    MessageBox.Show(LocalizationManager.L("L8_SelectToDelete"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    string.Format(LocalizationManager.L("L8_ConfirmDeleteChecked"), checkedCount),
                    LocalizationManager.L("L8_ConfirmDeleteTitle"),
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                Dictionary<string, List<Layer8Item>> toRemove = new Dictionary<string, List<Layer8Item>>();
                foreach (ListViewItem lvi in currentLv.CheckedItems)
                {
                    if (lvi.Tag == null) continue;
                    var (filePath, item) = ((string, Layer8Item))lvi.Tag;
                    if (!toRemove.ContainsKey(filePath))
                        toRemove[filePath] = new List<Layer8Item>();
                    toRemove[filePath].Add(item);
                }

                int removedCount = 0;
                foreach (var kvp in toRemove)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out S32Data s32Data))
                    {
                        foreach (var item in kvp.Value)
                        {
                            if (s32Data.Layer8.Remove(item))
                                removedCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show(string.Format(LocalizationManager.L("L8_DeleteComplete"), removedCount), LocalizationManager.L("Title_Done"),
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button();
            btnClearAll.Text = LocalizationManager.L("L8_DeleteAll");
            btnClearAll.Location = new Point(140, 640);
            btnClearAll.Size = new Size(120, 35);
            btnClearAll.BackColor = Color.Salmon;
            btnClearAll.Enabled = s32WithL8.Count > 0;
            btnClearAll.Click += (s, args) =>
            {
                var confirmResult = MessageBox.Show(
                    string.Format(LocalizationManager.L("L8_ConfirmDeleteAll"), totalItems),
                    LocalizationManager.L("L8_ConfirmDeleteAllTitle"),
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int removedCount = 0;
                foreach (var (filePath, fileName, count, items) in s32WithL8)
                {
                    if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                    {
                        removedCount += s32Data.Layer8.Count;
                        s32Data.Layer8.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show(string.Format(LocalizationManager.L("L8_DeleteComplete"), removedCount), LocalizationManager.L("Title_Done"),
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearAll);

            Button btnClose = new Button();
            btnClose.Text = LocalizationManager.L("L8_Close");
            btnClose.Location = new Point(730, 640);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            // ä½¿ç”¨éæ¨¡æ…‹å°è©±æ¡†ï¼Œå¯ä»¥å¹³è¡Œç€è¦½åœ°åœ–
            resultForm.Show();
        }

        // å•Ÿç”¨ç•«é¢ä¸­æ‰€æœ‰å¯è¦‹çš„ L8 ç‰¹æ•ˆ
        private void btnEnableVisibleL8_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show(LocalizationManager.L("Message_PleaseLoadMap"), LocalizationManager.L("Title_Info"), MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int enabledCount = 0;

            foreach (var s32Data in _document.S32Files.Values)
            {
                if (s32Data.Layer8.Count == 0) continue;

                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int mx = loc[0];
                int my = loc[1];

                for (int i = 0; i < s32Data.Layer8.Count; i++)
                {
                    var item = s32Data.Layer8[i];

                    // Layer8 X,Y æ˜¯çµ•å°éŠæˆ²åº§æ¨™ï¼Œå…ˆè½‰ç‚ºæœ¬åœ°åº§æ¨™
                    int localLayer3X = item.X - s32Data.SegInfo.nLinBeginX;
                    int localLayer3Y = item.Y - s32Data.SegInfo.nLinBeginY;

                    if (localLayer3X < 0 || localLayer3X > 63 || localLayer3Y < 0 || localLayer3Y > 63)
                        continue;

                    int layer1X = localLayer3X * 2;
                    int layer1Y = localLayer3Y;

                    int baseX = -24 * (layer1X / 2);
                    int baseY = 63 * 12 - 12 * (layer1X / 2);

                    int markerWorldX = mx + baseX + layer1X * 24 + layer1Y * 24 + 12;
                    int markerWorldY = my + baseY + layer1Y * 12 + 12;

                    // è½‰ç‚ºè¢å¹•åº§æ¨™
                    var markerScreenPoint = _mapViewerControl.WorldToScreen(new Point(markerWorldX, markerWorldY));
                    int markerX = markerScreenPoint.X;
                    int markerY = markerScreenPoint.Y;

                    // æª¢æŸ¥æ˜¯å¦åœ¨å¯è¦‹ç¯„åœå…§
                    if (markerX >= -50 && markerX <= _mapViewerControl.Width + 50 &&
                        markerY >= -50 && markerY <= _mapViewerControl.Height + 50)
                    {
                        var key = (s32Data.FilePath, i);
                        if (!_editState.EnabledLayer8Items.Contains(key))
                        {
                            _editState.EnabledLayer8Items.Add(key);
                            _layer8AnimFrame[key] = 0;
                            enabledCount++;
                        }
                    }
                }
            }

            // å•Ÿå‹•å‹•ç•«è¨ˆæ™‚å™¨
            if (enabledCount > 0 && _layer8AnimTimer != null && !_layer8AnimTimer.Enabled)
            {
                _layer8AnimTimer.Start();
            }

            // é‡ç¹ª L8 å‹•ç•«è¦†è“‹å±¤
            _mapViewerControl?.InvalidateAnimationOverlay();
        }

        // æŸ¥çœ‹èˆ‡ç·¨è¼¯ç¬¬ä¸€å±¤ï¼ˆåœ°æ¿åœ–å¡Šï¼‰è³‡æ–™
        private void btnToolCheckL1_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L1 æª¢æŸ¥èˆ‡ç·¨è¼¯ - {_document.S32Files.Count} å€‹ S32 æª”æ¡ˆ";
            resultForm.Size = new Size(750, 620);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {_document.S32Files.Count} å€‹ S32 æª”æ¡ˆã€‚é¸æ“‡ S32 æª”æ¡ˆå¾Œå¯ç·¨è¼¯æŒ‡å®šåº§æ¨™çš„ Layer1 è³‡æ–™ï¼š";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(710, 20);
            resultForm.Controls.Add(lblSummary);

            // S32 æª”æ¡ˆé¸æ“‡æ¸…å–®
            Label lblS32 = new Label { Text = "S32 æª”æ¡ˆ:", Location = new Point(10, 40), Size = new Size(70, 20) };
            resultForm.Controls.Add(lblS32);

            ComboBox cmbS32Files = new ComboBox();
            cmbS32Files.Location = new Point(85, 37);
            cmbS32Files.Size = new Size(200, 23);
            cmbS32Files.DropDownStyle = ComboBoxStyle.DropDownList;
            foreach (var kvp in _document.S32Files)
            {
                cmbS32Files.Items.Add(Path.GetFileName(kvp.Key));
            }
            if (cmbS32Files.Items.Count > 0)
                cmbS32Files.SelectedIndex = 0;
            resultForm.Controls.Add(cmbS32Files);

            // åº§æ¨™è¼¸å…¥
            Label lblLocX = new Label { Text = "X:", Location = new Point(300, 40), Size = new Size(20, 20) };
            TextBox txtLocX = new TextBox { Location = new Point(325, 37), Size = new Size(50, 23), Text = "0" };
            Label lblLocY = new Label { Text = "Y:", Location = new Point(385, 40), Size = new Size(20, 20) };
            TextBox txtLocY = new TextBox { Location = new Point(410, 37), Size = new Size(50, 23), Text = "0" };
            resultForm.Controls.AddRange(new Control[] { lblLocX, txtLocX, lblLocY, txtLocY });

            Button btnQuery = new Button();
            btnQuery.Text = "æŸ¥è©¢";
            btnQuery.Location = new Point(470, 35);
            btnQuery.Size = new Size(60, 27);
            resultForm.Controls.Add(btnQuery);

            // çµæœé¡¯ç¤ºå€
            GroupBox gbResult = new GroupBox();
            gbResult.Text = "æŸ¥è©¢çµæœ / ç·¨è¼¯å€åŸŸ";
            gbResult.Location = new Point(10, 75);
            gbResult.Size = new Size(710, 120);

            Label lblResultInfo = new Label { Text = "è«‹é¸æ“‡ S32 æª”æ¡ˆä¸¦è¼¸å…¥åº§æ¨™å¾Œé»æ“Šã€ŒæŸ¥è©¢ã€", Location = new Point(10, 25), Size = new Size(400, 20) };
            gbResult.Controls.Add(lblResultInfo);

            Label lblTileId = new Label { Text = "TileId:", Location = new Point(10, 55), Size = new Size(50, 20) };
            TextBox txtTileId = new TextBox { Location = new Point(65, 52), Size = new Size(80, 23), Enabled = false };
            Label lblIndexId = new Label { Text = "IndexId:", Location = new Point(160, 55), Size = new Size(55, 20) };
            TextBox txtIndexId = new TextBox { Location = new Point(220, 52), Size = new Size(80, 23), Enabled = false };
            gbResult.Controls.AddRange(new Control[] { lblTileId, txtTileId, lblIndexId, txtIndexId });

            Button btnApplyEdit = new Button();
            btnApplyEdit.Text = "å¥—ç”¨ä¿®æ”¹";
            btnApplyEdit.Location = new Point(320, 50);
            btnApplyEdit.Size = new Size(80, 28);
            btnApplyEdit.Enabled = false;
            gbResult.Controls.Add(btnApplyEdit);

            resultForm.Controls.Add(gbResult);

            // æ‰¹é‡ä¿®æ”¹å€åŸŸ
            GroupBox gbBatch = new GroupBox();
            gbBatch.Text = "æ‰¹é‡æ›¿æ› TileId";
            gbBatch.Location = new Point(10, 205);
            gbBatch.Size = new Size(710, 80);

            Label lblOldTileId = new Label { Text = "åŸ TileId:", Location = new Point(10, 30), Size = new Size(60, 20) };
            TextBox txtOldTileId = new TextBox { Location = new Point(75, 27), Size = new Size(80, 23) };
            Label lblNewTileId = new Label { Text = "æ–° TileId:", Location = new Point(170, 30), Size = new Size(60, 20) };
            TextBox txtNewTileId = new TextBox { Location = new Point(235, 27), Size = new Size(80, 23) };
            Label lblBatchScope = new Label { Text = "ç¯„åœ:", Location = new Point(330, 30), Size = new Size(40, 20) };
            ComboBox cmbBatchScope = new ComboBox { Location = new Point(375, 27), Size = new Size(150, 23), DropDownStyle = ComboBoxStyle.DropDownList };
            cmbBatchScope.Items.Add("ç•¶å‰é¸æ“‡çš„ S32");
            cmbBatchScope.Items.Add("æ‰€æœ‰ S32 æª”æ¡ˆ");
            cmbBatchScope.SelectedIndex = 0;

            Button btnBatchReplace = new Button();
            btnBatchReplace.Text = "æ‰¹é‡æ›¿æ›";
            btnBatchReplace.Location = new Point(540, 25);
            btnBatchReplace.Size = new Size(80, 28);
            btnBatchReplace.BackColor = Color.LightYellow;

            gbBatch.Controls.AddRange(new Control[] { lblOldTileId, txtOldTileId, lblNewTileId, txtNewTileId, lblBatchScope, cmbBatchScope, btnBatchReplace });
            resultForm.Controls.Add(gbBatch);

            // æ‰¹é‡åˆªé™¤å€åŸŸ
            GroupBox gbDelete = new GroupBox();
            gbDelete.Text = "æ‰¹é‡åˆªé™¤ï¼ˆå°‡ TileId è¨­ç‚º 0ï¼‰";
            gbDelete.Location = new Point(10, 290);
            gbDelete.Size = new Size(710, 80);

            Label lblDelTileId = new Label { Text = "TileId:", Location = new Point(10, 30), Size = new Size(50, 20) };
            TextBox txtDelTileId = new TextBox { Location = new Point(65, 27), Size = new Size(80, 23) };
            Label lblDelScope = new Label { Text = "ç¯„åœ:", Location = new Point(160, 30), Size = new Size(40, 20) };
            ComboBox cmbDelScope = new ComboBox { Location = new Point(205, 27), Size = new Size(150, 23), DropDownStyle = ComboBoxStyle.DropDownList };
            cmbDelScope.Items.Add("ç•¶å‰é¸æ“‡çš„ S32");
            cmbDelScope.Items.Add("æ‰€æœ‰ S32 æª”æ¡ˆ");
            cmbDelScope.SelectedIndex = 0;

            Button btnBatchDelete = new Button();
            btnBatchDelete.Text = "æ‰¹é‡åˆªé™¤";
            btnBatchDelete.Location = new Point(370, 25);
            btnBatchDelete.Size = new Size(80, 28);
            btnBatchDelete.BackColor = Color.LightCoral;

            Button btnDeleteFromStats = new Button();
            btnDeleteFromStats.Text = "åˆªé™¤é¸ä¸­çµ±è¨ˆé …";
            btnDeleteFromStats.Location = new Point(460, 25);
            btnDeleteFromStats.Size = new Size(110, 28);
            btnDeleteFromStats.BackColor = Color.LightCoral;
            this.toolTip1.SetToolTip(btnDeleteFromStats, "åœ¨ä¸‹æ–¹çµ±è¨ˆæ¸…å–®ä¸­é¸æ“‡é …ç›®å¾Œï¼Œé»æ“Šæ­¤æŒ‰éˆ•åˆªé™¤");

            gbDelete.Controls.AddRange(new Control[] { lblDelTileId, txtDelTileId, lblDelScope, cmbDelScope, btnBatchDelete, btnDeleteFromStats });
            resultForm.Controls.Add(gbDelete);

            // çµ±è¨ˆè³‡è¨Š
            GroupBox gbStats = new GroupBox();
            gbStats.Text = "çµ±è¨ˆè³‡è¨Šï¼ˆé»æ“Šé …ç›®å¯å¡«å…¥ TileIdï¼‰";
            gbStats.Location = new Point(10, 375);
            gbStats.Size = new Size(710, 130);

            ListView lvStats = new ListView();
            lvStats.Location = new Point(10, 20);
            lvStats.Size = new Size(690, 130);
            lvStats.Font = new Font("Consolas", 9);
            lvStats.View = View.Details;
            lvStats.FullRowSelect = true;
            lvStats.Columns.Add("TileId", 80);
            lvStats.Columns.Add("ä½¿ç”¨æ¬¡æ•¸", 80);
            lvStats.Columns.Add("IndexId", 80);
            gbStats.Controls.Add(lvStats);

            resultForm.Controls.Add(gbStats);

            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(630, 525);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            // ListView é …ç›®é»æ“Šå¡«å…¥ TileId
            lvStats.Click += (s, args) =>
            {
                if (lvStats.SelectedItems.Count > 0)
                {
                    string tileIdStr = lvStats.SelectedItems[0].Text;
                    txtDelTileId.Text = tileIdStr;
                    txtOldTileId.Text = tileIdStr;
                }
            };

            // ç•¶å‰æŸ¥è©¢çš„ TileCell
            TileCell currentCell = null;
            string currentFilePath = null;
            int currentX = -1, currentY = -1;

            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            Action updateStats = () =>
            {
                lvStats.Items.Clear();
                if (cmbS32Files.SelectedItem == null) return;

                string selectedFileName = cmbS32Files.SelectedItem.ToString();
                string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);
                if (selectedFilePath == null || !_document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data)) return;

                // çµ±è¨ˆ TileId ä½¿ç”¨æ¬¡æ•¸
                Dictionary<int, (int count, int indexId)> tileStats = new Dictionary<int, (int, int)>();
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null)
                        {
                            if (!tileStats.ContainsKey(cell.TileId))
                                tileStats[cell.TileId] = (1, cell.IndexId);
                            else
                                tileStats[cell.TileId] = (tileStats[cell.TileId].count + 1, cell.IndexId);
                        }
                    }
                }

                // æ’åºé¡¯ç¤º
                foreach (var kvp in tileStats.OrderByDescending(k => k.Value.count))
                {
                    ListViewItem lvi = new ListViewItem(kvp.Key.ToString());
                    lvi.SubItems.Add(kvp.Value.count.ToString());
                    lvi.SubItems.Add(kvp.Value.indexId.ToString());
                    lvStats.Items.Add(lvi);
                }
            };

            // æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
            btnQuery.Click += (s, args) =>
            {
                if (cmbS32Files.SelectedItem == null)
                {
                    MessageBox.Show("è«‹é¸æ“‡ S32 æª”æ¡ˆ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!int.TryParse(txtLocX.Text, out int locX) || !int.TryParse(txtLocY.Text, out int locY))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                if (locX < 0 || locX >= 128 || locY < 0 || locY >= 64)
                {
                    MessageBox.Show("åº§æ¨™è¶…å‡ºç¯„åœã€‚X ç¯„åœ: 0-127, Y ç¯„åœ: 0-63", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                string selectedFileName = cmbS32Files.SelectedItem.ToString();
                string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);
                if (selectedFilePath == null || !_document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                {
                    MessageBox.Show("ç„¡æ³•è¼‰å…¥ S32 è³‡æ–™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                var cell = s32Data.Layer1[locY, locX];
                if (cell == null)
                {
                    lblResultInfo.Text = $"åº§æ¨™ ({locX}, {locY}) ç„¡è³‡æ–™";
                    txtTileId.Text = "";
                    txtIndexId.Text = "";
                    txtTileId.Enabled = false;
                    txtIndexId.Enabled = false;
                    btnApplyEdit.Enabled = false;
                    currentCell = null;
                }
                else
                {
                    lblResultInfo.Text = $"åº§æ¨™ ({locX}, {locY}) çš„ Layer1 è³‡æ–™ï¼š";
                    txtTileId.Text = cell.TileId.ToString();
                    txtIndexId.Text = cell.IndexId.ToString();
                    txtTileId.Enabled = true;
                    txtIndexId.Enabled = true;
                    btnApplyEdit.Enabled = true;
                    currentCell = cell;
                    currentFilePath = selectedFilePath;
                    currentX = locX;
                    currentY = locY;
                }
            };

            // å¥—ç”¨ä¿®æ”¹æŒ‰éˆ•äº‹ä»¶
            btnApplyEdit.Click += (s, args) =>
            {
                if (currentCell == null || currentFilePath == null)
                {
                    MessageBox.Show("è«‹å…ˆæŸ¥è©¢ä¸€å€‹æœ‰æ•ˆçš„åº§æ¨™", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                if (!int.TryParse(txtTileId.Text, out int newTileId) || !int.TryParse(txtIndexId.Text, out int newIndexId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                currentCell.TileId = newTileId;
                currentCell.IndexId = newIndexId;

                if (_document.S32Files.TryGetValue(currentFilePath, out S32Data s32Data))
                {
                    s32Data.IsModified = true;
                }

                MessageBox.Show($"å·²ä¿®æ”¹åº§æ¨™ ({currentX}, {currentY}) çš„ Layer1 è³‡æ–™ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                updateStats();
            };

            // æ‰¹é‡æ›¿æ›æŒ‰éˆ•äº‹ä»¶
            btnBatchReplace.Click += (s, args) =>
            {
                if (!int.TryParse(txtOldTileId.Text, out int oldTileId) || !int.TryParse(txtNewTileId.Text, out int newTileId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ TileId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                bool allFiles = cmbBatchScope.SelectedIndex == 1;
                int replacedCount = 0;

                if (allFiles)
                {
                    var confirmResult = MessageBox.Show(
                        $"ç¢ºå®šè¦åœ¨æ‰€æœ‰ S32 æª”æ¡ˆä¸­å°‡ TileId {oldTileId} æ›¿æ›ç‚º {newTileId} å—ï¼Ÿ",
                        "ç¢ºèªæ‰¹é‡æ›¿æ›",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning);
                    if (confirmResult != DialogResult.Yes) return;

                    foreach (var kvp in _document.S32Files)
                    {
                        S32Data s32Data = kvp.Value;
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell != null && cell.TileId == oldTileId)
                                {
                                    cell.TileId = newTileId;
                                    replacedCount++;
                                }
                            }
                        }
                        if (replacedCount > 0)
                            s32Data.IsModified = true;
                    }
                }
                else
                {
                    if (cmbS32Files.SelectedItem == null)
                    {
                        MessageBox.Show("è«‹é¸æ“‡ S32 æª”æ¡ˆ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    string selectedFileName = cmbS32Files.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);
                    if (selectedFilePath == null || !_document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        MessageBox.Show("ç„¡æ³•è¼‰å…¥ S32 è³‡æ–™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    var confirmResult = MessageBox.Show(
                        $"ç¢ºå®šè¦åœ¨ {selectedFileName} ä¸­å°‡ TileId {oldTileId} æ›¿æ›ç‚º {newTileId} å—ï¼Ÿ",
                        "ç¢ºèªæ‰¹é‡æ›¿æ›",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning);
                    if (confirmResult != DialogResult.Yes) return;

                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId == oldTileId)
                            {
                                cell.TileId = newTileId;
                                replacedCount++;
                            }
                        }
                    }
                    if (replacedCount > 0)
                        s32Data.IsModified = true;
                }

                MessageBox.Show($"å·²æ›¿æ› {replacedCount} å€‹ Layer1 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                updateStats();
                RenderS32Map();
            };

            // æ‰¹é‡åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            btnBatchDelete.Click += (s, args) =>
            {
                if (!int.TryParse(txtDelTileId.Text, out int delTileId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ TileId", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                bool allFiles = cmbDelScope.SelectedIndex == 1;
                int deletedCount = 0;

                if (allFiles)
                {
                    var confirmResult = MessageBox.Show(
                        $"ç¢ºå®šè¦åœ¨æ‰€æœ‰ S32 æª”æ¡ˆä¸­åˆªé™¤ TileId = {delTileId} çš„æ‰€æœ‰é …ç›®å—ï¼Ÿ\n\nï¼ˆå°‡ TileId è¨­ç‚º 0ï¼‰",
                        "ç¢ºèªæ‰¹é‡åˆªé™¤",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning);
                    if (confirmResult != DialogResult.Yes) return;

                    foreach (var kvp in _document.S32Files)
                    {
                        S32Data s32Data = kvp.Value;
                        bool modified = false;
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell != null && cell.TileId == delTileId)
                                {
                                    cell.TileId = 0;
                                    cell.IndexId = 0;
                                    deletedCount++;
                                    modified = true;
                                }
                            }
                        }
                        if (modified)
                            s32Data.IsModified = true;
                    }
                }
                else
                {
                    if (cmbS32Files.SelectedItem == null)
                    {
                        MessageBox.Show("è«‹é¸æ“‡ S32 æª”æ¡ˆ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    string selectedFileName = cmbS32Files.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);
                    if (selectedFilePath == null || !_document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        MessageBox.Show("ç„¡æ³•è¼‰å…¥ S32 è³‡æ–™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    var confirmResult = MessageBox.Show(
                        $"ç¢ºå®šè¦åœ¨ {selectedFileName} ä¸­åˆªé™¤ TileId = {delTileId} çš„æ‰€æœ‰é …ç›®å—ï¼Ÿ\n\nï¼ˆå°‡ TileId è¨­ç‚º 0ï¼‰",
                        "ç¢ºèªæ‰¹é‡åˆªé™¤",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning);
                    if (confirmResult != DialogResult.Yes) return;

                    for (int y = 0; y < 64; y++)
                    {
                        for (int x = 0; x < 128; x++)
                        {
                            var cell = s32Data.Layer1[y, x];
                            if (cell != null && cell.TileId == delTileId)
                            {
                                cell.TileId = 0;
                                cell.IndexId = 0;
                                deletedCount++;
                            }
                        }
                    }
                    if (deletedCount > 0)
                        s32Data.IsModified = true;
                }

                MessageBox.Show($"å·²åˆªé™¤ {deletedCount} å€‹ Layer1 é …ç›®ï¼ˆTileId è¨­ç‚º 0ï¼‰ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                updateStats();
                ClearS32BlockCache();
                RenderS32Map();
            };

            // å¾çµ±è¨ˆæ¸…å–®åˆªé™¤é¸ä¸­é …ç›®
            btnDeleteFromStats.Click += (s, args) =>
            {
                if (lvStats.SelectedItems.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆåœ¨çµ±è¨ˆæ¸…å–®ä¸­é¸æ“‡è¦åˆªé™¤çš„ TileId", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                // æ”¶é›†æ‰€æœ‰é¸ä¸­çš„ TileId
                var selectedTileIds = new List<int>();
                foreach (ListViewItem item in lvStats.SelectedItems)
                {
                    if (int.TryParse(item.Text, out int tileId))
                        selectedTileIds.Add(tileId);
                }

                if (selectedTileIds.Count == 0) return;

                bool allFiles = cmbDelScope.SelectedIndex == 1;
                string scopeText = allFiles ? "æ‰€æœ‰ S32 æª”æ¡ˆ" : cmbS32Files.SelectedItem?.ToString() ?? "ç•¶å‰ S32";
                string tileIdsText = string.Join(", ", selectedTileIds);

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åœ¨ {scopeText} ä¸­åˆªé™¤ä»¥ä¸‹ TileId å—ï¼Ÿ\n\nTileId: {tileIdsText}\n\nï¼ˆå°‡ TileId è¨­ç‚º 0ï¼‰",
                    "ç¢ºèªæ‰¹é‡åˆªé™¤",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);
                if (confirmResult != DialogResult.Yes) return;

                int deletedCount = 0;
                var tileIdSet = new HashSet<int>(selectedTileIds);

                if (allFiles)
                {
                    foreach (var kvp in _document.S32Files)
                    {
                        S32Data s32Data = kvp.Value;
                        bool modified = false;
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell != null && tileIdSet.Contains(cell.TileId))
                                {
                                    cell.TileId = 0;
                                    cell.IndexId = 0;
                                    deletedCount++;
                                    modified = true;
                                }
                            }
                        }
                        if (modified)
                            s32Data.IsModified = true;
                    }
                }
                else
                {
                    if (cmbS32Files.SelectedItem == null)
                    {
                        MessageBox.Show("è«‹é¸æ“‡ S32 æª”æ¡ˆ", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return;
                    }

                    string selectedFileName = cmbS32Files.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);
                    if (selectedFilePath != null && _document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        for (int y = 0; y < 64; y++)
                        {
                            for (int x = 0; x < 128; x++)
                            {
                                var cell = s32Data.Layer1[y, x];
                                if (cell != null && tileIdSet.Contains(cell.TileId))
                                {
                                    cell.TileId = 0;
                                    cell.IndexId = 0;
                                    deletedCount++;
                                }
                            }
                        }
                        if (deletedCount > 0)
                            s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {deletedCount} å€‹ Layer1 é …ç›®ï¼ˆTileId è¨­ç‚º 0ï¼‰ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                updateStats();
                ClearS32BlockCache();
                RenderS32Map();
            };

            // S32 æª”æ¡ˆé¸æ“‡è®Šæ›´æ™‚æ›´æ–°çµ±è¨ˆ
            cmbS32Files.SelectedIndexChanged += (s, args) =>
            {
                updateStats();
                // æ¸…é™¤æŸ¥è©¢çµæœ
                lblResultInfo.Text = "è«‹é¸æ“‡ S32 æª”æ¡ˆä¸¦è¼¸å…¥åº§æ¨™å¾Œé»æ“Šã€ŒæŸ¥è©¢ã€";
                txtTileId.Text = "";
                txtIndexId.Text = "";
                txtTileId.Enabled = false;
                txtIndexId.Enabled = false;
                btnApplyEdit.Enabled = false;
                currentCell = null;
            };

            // åˆå§‹è¼‰å…¥çµ±è¨ˆ
            updateStats();

            resultForm.Resize += (s, args) =>
            {
                gbResult.Size = new Size(resultForm.ClientSize.Width - 20, 120);
                gbBatch.Size = new Size(resultForm.ClientSize.Width - 20, 80);
                gbBatch.Location = new Point(10, 205);
                gbDelete.Size = new Size(resultForm.ClientSize.Width - 20, 80);
                gbDelete.Location = new Point(10, 290);
                gbStats.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 430);
                gbStats.Location = new Point(10, 375);
                lvStats.Size = new Size(gbStats.Width - 20, gbStats.Height - 30);
                btnClose.Location = new Point(resultForm.ClientSize.Width - 100, resultForm.ClientSize.Height - 45);
            };

            resultForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡æ¸…é™¤ç¬¬äºŒå±¤è³‡æ–™
        private void btnToolCheckL2_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†æ‰€æœ‰ S32 çš„ Layer2 è³‡æ–™
            var s32WithL2 = new List<(string filePath, string fileName, int count, List<Layer2Item> items)>();
            int totalItems = 0;

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer2.Count > 0)
                {
                    s32WithL2.Add((filePath, fileName, s32Data.Layer2.Count, s32Data.Layer2.ToList()));
                    totalItems += s32Data.Layer2.Count;
                }
            }

            if (totalItems == 0)
            {
                MessageBox.Show("ç›®å‰æ²’æœ‰ä»»ä½• Layer2 è³‡æ–™ã€‚", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L2 æŸ¥çœ‹èˆ‡æ¸…é™¤ - {s32WithL2.Count} å€‹ S32 æœ‰è³‡æ–™ï¼Œå…± {totalItems} é …";
            resultForm.Size = new Size(850, 600);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {s32WithL2.Count} å€‹ S32 æª”æ¡ˆæœ‰ Layer2 è³‡æ–™ï¼Œç¸½è¨ˆ {totalItems} é …ã€‚å‹¾é¸å¾Œå¯æ¸…é™¤ï¼š";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(810, 20);
            resultForm.Controls.Add(lblSummary);

            // ä½¿ç”¨ CheckedListBox é¡¯ç¤ºæ‰€æœ‰ Layer2 é …ç›®
            CheckedListBox clbItems = new CheckedListBox();
            clbItems.Location = new Point(10, 35);
            clbItems.Size = new Size(810, resultForm.ClientSize.Height - 130);
            clbItems.Font = new Font("Consolas", 9);
            clbItems.CheckOnClick = true;
            clbItems.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

            // å»ºç«‹é …ç›®å°æ‡‰è¡¨ï¼ˆç”¨æ–¼åˆªé™¤ï¼‰
            var itemMap = new List<(string filePath, Layer2Item item)>();

            foreach (var (filePath, fileName, count, items) in s32WithL2)
            {
                foreach (var item in items)
                {
                    string displayText = $"[{fileName}] X={item.X}, Y={item.Y}, Tile={item.TileId}, Idx={item.IndexId}, UK={item.UK}";
                    clbItems.Items.Add(displayText);
                    itemMap.Add((filePath, item));
                }
            }
            resultForm.Controls.Add(clbItems);

            // æŒ‰éˆ•é¢æ¿
            Panel pnlButtons = new Panel();
            pnlButtons.Location = new Point(10, resultForm.ClientSize.Height - 90);
            pnlButtons.Size = new Size(810, 80);
            pnlButtons.Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
            resultForm.Controls.Add(pnlButtons);

            Button btnSelectAll = new Button { Text = "å…¨é¸", Location = new Point(0, 0), Size = new Size(80, 30) };
            btnSelectAll.Click += (s, args) => { for (int i = 0; i < clbItems.Items.Count; i++) clbItems.SetItemChecked(i, true); };
            pnlButtons.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button { Text = "å–æ¶ˆå…¨é¸", Location = new Point(90, 0), Size = new Size(80, 30) };
            btnDeselectAll.Click += (s, args) => { for (int i = 0; i < clbItems.Items.Count; i++) clbItems.SetItemChecked(i, false); };
            pnlButtons.Controls.Add(btnDeselectAll);

            // æŒ‰ S32 é¸æ“‡
            Button btnSelectByS32 = new Button { Text = "æŒ‰S32é¸", Location = new Point(180, 0), Size = new Size(80, 30) };
            btnSelectByS32.Click += (s, args) =>
            {
                // é¡¯ç¤º S32 é¸æ“‡å°è©±æ¡†
                var s32Names = s32WithL2.Select(x => x.fileName).Distinct().ToList();
                using (var selectForm = new Form())
                {
                    selectForm.Text = "é¸æ“‡ S32 æª”æ¡ˆ";
                    selectForm.Size = new Size(300, 400);
                    selectForm.StartPosition = FormStartPosition.CenterParent;

                    CheckedListBox clbS32 = new CheckedListBox();
                    clbS32.Location = new Point(10, 10);
                    clbS32.Size = new Size(260, 300);
                    clbS32.CheckOnClick = true;
                    foreach (var name in s32Names) clbS32.Items.Add(name);
                    selectForm.Controls.Add(clbS32);

                    Button btnOk = new Button { Text = "ç¢ºå®š", Location = new Point(100, 320), Size = new Size(80, 30) };
                    btnOk.Click += (s2, args2) =>
                    {
                        var selectedS32 = new HashSet<string>();
                        foreach (int idx in clbS32.CheckedIndices)
                            selectedS32.Add(s32Names[idx]);

                        for (int i = 0; i < itemMap.Count; i++)
                        {
                            string fileName = Path.GetFileName(itemMap[i].filePath);
                            clbItems.SetItemChecked(i, selectedS32.Contains(fileName));
                        }
                        selectForm.Close();
                    };
                    selectForm.Controls.Add(btnOk);
                    selectForm.ShowDialog();
                }
            };
            pnlButtons.Controls.Add(btnSelectByS32);

            Button btnClearSelected = new Button { Text = "æ¸…é™¤å‹¾é¸", Location = new Point(0, 40), Size = new Size(100, 35), BackColor = Color.LightCoral };
            btnClearSelected.Click += (s, args) =>
            {
                if (clbItems.CheckedIndices.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆå‹¾é¸è¦æ¸…é™¤çš„é …ç›®", "æç¤º");
                    return;
                }

                if (MessageBox.Show($"ç¢ºå®šè¦æ¸…é™¤å‹¾é¸çš„ {clbItems.CheckedIndices.Count} å€‹ Layer2 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªåˆªé™¤", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes)
                    return;

                // æŒ‰ S32 åˆ†çµ„è¦åˆªé™¤çš„é …ç›®
                var toDelete = new Dictionary<string, List<Layer2Item>>();
                foreach (int idx in clbItems.CheckedIndices)
                {
                    var (filePath, item) = itemMap[idx];
                    if (!toDelete.ContainsKey(filePath))
                        toDelete[filePath] = new List<Layer2Item>();
                    toDelete[filePath].Add(item);
                }

                int deletedCount = 0;
                foreach (var kvp in toDelete)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out var s32Data))
                    {
                        foreach (var item in kvp.Value)
                        {
                            s32Data.Layer2.Remove(item);
                            deletedCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²æ¸…é™¤ {deletedCount} å€‹ Layer2 é …ç›®", "æ¸…é™¤å®Œæˆ");
                ClearS32BlockCache();
                resultForm.Close();
                RenderS32Map();
            };
            pnlButtons.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button { Text = "æ¸…é™¤å…¨éƒ¨", Location = new Point(110, 40), Size = new Size(100, 35), BackColor = Color.Salmon };
            btnClearAll.Click += (s, args) =>
            {
                if (MessageBox.Show($"ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ {totalItems} å€‹ Layer2 é …ç›®å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤æ‰€æœ‰ S32 æª”æ¡ˆä¸­çš„ Layer2 è³‡æ–™ï¼",
                    "ç¢ºèªåˆªé™¤å…¨éƒ¨", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes)
                    return;

                int deletedCount = 0;
                foreach (var (filePath, _, _, _) in s32WithL2)
                {
                    if (_document.S32Files.TryGetValue(filePath, out var s32Data))
                    {
                        deletedCount += s32Data.Layer2.Count;
                        s32Data.Layer2.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²æ¸…é™¤ {deletedCount} å€‹ Layer2 é …ç›®", "æ¸…é™¤å®Œæˆ");
                ClearS32BlockCache();
                resultForm.Close();
                RenderS32Map();
            };
            pnlButtons.Controls.Add(btnClearAll);

            Button btnClose = new Button { Text = "é—œé–‰", Location = new Point(pnlButtons.Width - 90, 40), Size = new Size(80, 35), Anchor = AnchorStyles.Right };
            btnClose.Click += (s, args) => resultForm.Close();
            pnlButtons.Controls.Add(btnClose);

            resultForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡ç·¨è¼¯ç¬¬å››å±¤ï¼ˆç‰©ä»¶ï¼‰è³‡æ–™
        private void btnToolCheckL4_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†æ‰€æœ‰ Layer4 è³‡æ–™
            List<(string filePath, string fileName, List<ObjectTile> items)> s32WithL4 =
                new List<(string, string, List<ObjectTile>)>();

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer4.Count > 0)
                {
                    s32WithL4.Add((filePath, fileName, s32Data.Layer4.ToList()));
                }
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L4 æª¢æŸ¥ã€ç·¨è¼¯èˆ‡æ¸…é™¤ - {s32WithL4.Count} å€‹ S32 æœ‰è³‡æ–™";
            resultForm.Size = new Size(900, 650);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            int totalItems = s32WithL4.Sum(x => x.items.Count);
            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {s32WithL4.Count} å€‹ S32 æª”æ¡ˆæœ‰ Layer4ï¼ˆç‰©ä»¶ï¼‰è³‡æ–™ï¼Œç¸½è¨ˆ {totalItems} é …ã€‚é¸å–é …ç›®å¾Œå¯ç·¨è¼¯æˆ–åˆªé™¤ï¼š";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(860, 20);
            resultForm.Controls.Add(lblSummary);

            // ä½¿ç”¨ ListView ä¾†é¡¯ç¤ºè©³ç´°è³‡è¨Š
            ListView lvItems = new ListView();
            lvItems.Location = new Point(10, 35);
            lvItems.Size = new Size(860, 380);
            lvItems.Font = new Font("Consolas", 9);
            lvItems.View = View.Details;
            lvItems.FullRowSelect = true;
            lvItems.CheckBoxes = true;
            lvItems.Columns.Add("S32 æª”æ¡ˆ", 100);
            lvItems.Columns.Add("GroupId", 65);
            lvItems.Columns.Add("X", 50);
            lvItems.Columns.Add("Y", 50);
            lvItems.Columns.Add("Layer", 50);
            lvItems.Columns.Add("IndexId", 65);
            lvItems.Columns.Add("TileId", 65);

            List<(string filePath, ObjectTile item)> itemInfoList = new List<(string, ObjectTile)>();

            if (s32WithL4.Count == 0)
            {
                lvItems.Items.Add(new ListViewItem("æ²’æœ‰ä»»ä½• S32 æª”æ¡ˆæœ‰ Layer4 è³‡æ–™"));
                lvItems.Enabled = false;
            }
            else
            {
                foreach (var (filePath, fileName, items) in s32WithL4)
                {
                    foreach (var item in items)
                    {
                        ListViewItem lvi = new ListViewItem(fileName);
                        lvi.SubItems.Add(item.GroupId.ToString());
                        lvi.SubItems.Add(item.X.ToString());
                        lvi.SubItems.Add(item.Y.ToString());
                        lvi.SubItems.Add(item.Layer.ToString());
                        lvi.SubItems.Add(item.IndexId.ToString());
                        lvi.SubItems.Add(item.TileId.ToString());
                        lvi.Tag = (filePath, item);
                        lvItems.Items.Add(lvi);
                        itemInfoList.Add((filePath, item));
                    }
                }
            }
            resultForm.Controls.Add(lvItems);

            // ç·¨è¼¯å€åŸŸ
            GroupBox gbEdit = new GroupBox();
            gbEdit.Text = "ç·¨è¼¯é¸å–çš„é …ç›®";
            gbEdit.Location = new Point(10, 425);
            gbEdit.Size = new Size(860, 80);

            Label lblGroupId = new Label { Text = "GroupId:", Location = new Point(10, 25), Size = new Size(55, 20) };
            TextBox txtGroupId = new TextBox { Location = new Point(70, 22), Size = new Size(60, 23) };
            Label lblX = new Label { Text = "X:", Location = new Point(140, 25), Size = new Size(20, 20) };
            TextBox txtX = new TextBox { Location = new Point(160, 22), Size = new Size(50, 23) };
            Label lblY = new Label { Text = "Y:", Location = new Point(220, 25), Size = new Size(20, 20) };
            TextBox txtY = new TextBox { Location = new Point(240, 22), Size = new Size(50, 23) };
            Label lblLayer = new Label { Text = "Layer:", Location = new Point(300, 25), Size = new Size(40, 20) };
            TextBox txtLayer = new TextBox { Location = new Point(345, 22), Size = new Size(50, 23) };
            Label lblIndexId = new Label { Text = "IndexId:", Location = new Point(405, 25), Size = new Size(50, 20) };
            TextBox txtIndexId = new TextBox { Location = new Point(460, 22), Size = new Size(60, 23) };
            Label lblTileId = new Label { Text = "TileId:", Location = new Point(530, 25), Size = new Size(40, 20) };
            TextBox txtTileId = new TextBox { Location = new Point(575, 22), Size = new Size(70, 23) };

            Button btnApplyEdit = new Button();
            btnApplyEdit.Text = "å¥—ç”¨ä¿®æ”¹";
            btnApplyEdit.Location = new Point(660, 20);
            btnApplyEdit.Size = new Size(80, 28);
            btnApplyEdit.Click += (s, args) =>
            {
                if (lvItems.SelectedItems.Count != 1)
                {
                    MessageBox.Show("è«‹é¸å–ä¸€å€‹é …ç›®é€²è¡Œç·¨è¼¯", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var lvi = lvItems.SelectedItems[0];
                var (filePath, item) = ((string, ObjectTile))lvi.Tag;

                if (!int.TryParse(txtGroupId.Text, out int newGroupId) ||
                    !int.TryParse(txtX.Text, out int newX) ||
                    !int.TryParse(txtY.Text, out int newY) ||
                    !int.TryParse(txtLayer.Text, out int newLayer) ||
                    !int.TryParse(txtIndexId.Text, out int newIndexId) ||
                    !int.TryParse(txtTileId.Text, out int newTileId))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æ›´æ–°è³‡æ–™
                item.GroupId = newGroupId;
                item.X = newX;
                item.Y = newY;
                item.Layer = newLayer;
                item.IndexId = newIndexId;
                item.TileId = newTileId;

                // æ›´æ–° ListView é¡¯ç¤º
                lvi.SubItems[1].Text = item.GroupId.ToString();
                lvi.SubItems[2].Text = item.X.ToString();
                lvi.SubItems[3].Text = item.Y.ToString();
                lvi.SubItems[4].Text = item.Layer.ToString();
                lvi.SubItems[5].Text = item.IndexId.ToString();
                lvi.SubItems[6].Text = item.TileId.ToString();

                // æ¨™è¨˜å·²ä¿®æ”¹
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    s32Data.IsModified = true;
                }

                MessageBox.Show("å·²å¥—ç”¨ä¿®æ”¹ã€‚è«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            // æ–°å¢é …ç›®æŒ‰éˆ•
            Button btnAddNew = new Button();
            btnAddNew.Text = "æ–°å¢";
            btnAddNew.Location = new Point(760, 20);
            btnAddNew.Size = new Size(80, 28);
            btnAddNew.Click += (s, args) =>
            {
                // é¸æ“‡è¦æ–°å¢åˆ°å“ªå€‹ S32 æª”æ¡ˆ
                Form selectForm = new Form();
                selectForm.Text = "é¸æ“‡ S32 æª”æ¡ˆ";
                selectForm.Size = new Size(400, 350);
                selectForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                selectForm.StartPosition = FormStartPosition.CenterParent;
                selectForm.MaximizeBox = false;
                selectForm.MinimizeBox = false;

                Label lblSelect = new Label();
                lblSelect.Text = "é¸æ“‡è¦æ–°å¢ Layer4 é …ç›®çš„ S32 æª”æ¡ˆï¼š";
                lblSelect.Location = new Point(10, 10);
                lblSelect.Size = new Size(360, 20);
                selectForm.Controls.Add(lblSelect);

                ListBox lbS32Files = new ListBox();
                lbS32Files.Location = new Point(10, 35);
                lbS32Files.Size = new Size(360, 220);
                foreach (var kvp in _document.S32Files)
                {
                    lbS32Files.Items.Add(Path.GetFileName(kvp.Key));
                }
                if (lbS32Files.Items.Count > 0)
                    lbS32Files.SelectedIndex = 0;
                selectForm.Controls.Add(lbS32Files);

                Button btnOK = new Button();
                btnOK.Text = "ç¢ºå®š";
                btnOK.Location = new Point(100, 265);
                btnOK.Size = new Size(80, 30);
                btnOK.DialogResult = DialogResult.OK;
                selectForm.Controls.Add(btnOK);

                Button btnCancel = new Button();
                btnCancel.Text = "å–æ¶ˆ";
                btnCancel.Location = new Point(200, 265);
                btnCancel.Size = new Size(80, 30);
                btnCancel.DialogResult = DialogResult.Cancel;
                selectForm.Controls.Add(btnCancel);

                selectForm.AcceptButton = btnOK;
                selectForm.CancelButton = btnCancel;

                if (selectForm.ShowDialog() == DialogResult.OK && lbS32Files.SelectedItem != null)
                {
                    string selectedFileName = lbS32Files.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);

                    if (selectedFilePath != null && _document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        // é©—è­‰è¼¸å…¥
                        if (!int.TryParse(txtGroupId.Text, out int newGroupId))
                            newGroupId = 0;
                        if (!int.TryParse(txtX.Text, out int newX))
                            newX = 0;
                        if (!int.TryParse(txtY.Text, out int newY))
                            newY = 0;
                        if (!int.TryParse(txtLayer.Text, out int newLayer))
                            newLayer = 0;
                        if (!int.TryParse(txtIndexId.Text, out int newIndexId))
                            newIndexId = 0;
                        if (!int.TryParse(txtTileId.Text, out int newTileId))
                            newTileId = 0;

                        // å»ºç«‹æ–°é …ç›®
                        ObjectTile newItem = new ObjectTile
                        {
                            GroupId = newGroupId,
                            X = newX,
                            Y = newY,
                            Layer = newLayer,
                            IndexId = newIndexId,
                            TileId = newTileId
                        };

                        // åŠ å…¥ S32 è³‡æ–™
                        s32Data.Layer4.Add(newItem);
                        Layer4Index_Add(s32Data, newItem);
                        s32Data.IsModified = true;

                        // æ›´æ–° ListView
                        ListViewItem newLvi = new ListViewItem(selectedFileName);
                        newLvi.SubItems.Add(newItem.GroupId.ToString());
                        newLvi.SubItems.Add(newItem.X.ToString());
                        newLvi.SubItems.Add(newItem.Y.ToString());
                        newLvi.SubItems.Add(newItem.Layer.ToString());
                        newLvi.SubItems.Add(newItem.IndexId.ToString());
                        newLvi.SubItems.Add(newItem.TileId.ToString());
                        newLvi.Tag = (selectedFilePath, newItem);
                        lvItems.Items.Add(newLvi);
                        itemInfoList.Add((selectedFilePath, newItem));

                        // é¸å–æ–°å¢çš„é …ç›®
                        newLvi.Selected = true;
                        newLvi.EnsureVisible();

                        MessageBox.Show($"å·²æ–°å¢ Layer4 é …ç›®åˆ° {selectedFileName}ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                            MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            };

            gbEdit.Controls.AddRange(new Control[] { lblGroupId, txtGroupId, lblX, txtX, lblY, txtY, lblLayer, txtLayer, lblIndexId, txtIndexId, lblTileId, txtTileId, btnApplyEdit, btnAddNew });
            resultForm.Controls.Add(gbEdit);

            // é¸å–é …ç›®æ™‚å¡«å…¥ç·¨è¼¯å€
            lvItems.SelectedIndexChanged += (s, args) =>
            {
                if (lvItems.SelectedItems.Count == 1)
                {
                    var lvi = lvItems.SelectedItems[0];
                    var (filePath, item) = ((string, ObjectTile))lvi.Tag;
                    txtGroupId.Text = item.GroupId.ToString();
                    txtX.Text = item.X.ToString();
                    txtY.Text = item.Y.ToString();
                    txtLayer.Text = item.Layer.ToString();
                    txtIndexId.Text = item.IndexId.ToString();
                    txtTileId.Text = item.TileId.ToString();
                }
            };

            Button btnSelectAll = new Button();
            btnSelectAll.Text = "å…¨é¸";
            btnSelectAll.Location = new Point(10, 515);
            btnSelectAll.Size = new Size(80, 30);
            btnSelectAll.Click += (s, args) =>
            {
                foreach (ListViewItem lvi in lvItems.Items)
                    lvi.Checked = true;
            };
            resultForm.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button();
            btnDeselectAll.Text = "å–æ¶ˆå…¨é¸";
            btnDeselectAll.Location = new Point(100, 515);
            btnDeselectAll.Size = new Size(80, 30);
            btnDeselectAll.Click += (s, args) =>
            {
                foreach (ListViewItem lvi in lvItems.Items)
                    lvi.Checked = false;
            };
            resultForm.Controls.Add(btnDeselectAll);

            Button btnClearSelected = new Button();
            btnClearSelected.Text = "åˆªé™¤å‹¾é¸é …ç›®";
            btnClearSelected.Location = new Point(10, 555);
            btnClearSelected.Size = new Size(120, 35);
            btnClearSelected.BackColor = Color.LightCoral;
            btnClearSelected.Enabled = s32WithL4.Count > 0;
            btnClearSelected.Click += (s, args) =>
            {
                int checkedCount = lvItems.CheckedItems.Count;
                if (checkedCount == 0)
                {
                    MessageBox.Show("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åˆªé™¤å‹¾é¸çš„ {checkedCount} å€‹ Layer4 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªåˆªé™¤",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                Dictionary<string, List<ObjectTile>> toRemove = new Dictionary<string, List<ObjectTile>>();
                foreach (ListViewItem lvi in lvItems.CheckedItems)
                {
                    var (filePath, item) = ((string, ObjectTile))lvi.Tag;
                    if (!toRemove.ContainsKey(filePath))
                        toRemove[filePath] = new List<ObjectTile>();
                    toRemove[filePath].Add(item);
                }

                int removedCount = 0;
                foreach (var kvp in toRemove)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out S32Data s32Data))
                    {
                        foreach (var item in kvp.Value)
                        {
                            if (s32Data.Layer4.Remove(item))
                                removedCount++;
                        }
                        Layer4Index_RemoveRange(s32Data, kvp.Value);
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {removedCount} å€‹ Layer4 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button();
            btnClearAll.Text = "åˆªé™¤å…¨éƒ¨ L4";
            btnClearAll.Location = new Point(140, 555);
            btnClearAll.Size = new Size(120, 35);
            btnClearAll.BackColor = Color.Salmon;
            btnClearAll.Enabled = s32WithL4.Count > 0;
            btnClearAll.Click += (s, args) =>
            {
                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ {totalItems} å€‹ Layer4 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªåˆªé™¤å…¨éƒ¨",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int removedCount = 0;
                foreach (var (filePath, fileName, items) in s32WithL4)
                {
                    if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                    {
                        // å…ˆæ›´æ–°ç©ºé–“ç´¢å¼•ï¼ˆéœ€è¦åœ¨ Clear ä¹‹å‰ï¼‰
                        Layer4Index_RemoveRange(s32Data, s32Data.Layer4);
                        removedCount += s32Data.Layer4.Count;
                        s32Data.Layer4.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {removedCount} å€‹ Layer4 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearAll);

            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(780, 555);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            resultForm.Resize += (s, args) =>
            {
                lvItems.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 230);
                gbEdit.Location = new Point(10, resultForm.ClientSize.Height - 185);
                gbEdit.Size = new Size(resultForm.ClientSize.Width - 20, 80);
                btnSelectAll.Location = new Point(10, resultForm.ClientSize.Height - 95);
                btnDeselectAll.Location = new Point(100, resultForm.ClientSize.Height - 95);
                btnClearSelected.Location = new Point(10, resultForm.ClientSize.Height - 55);
                btnClearAll.Location = new Point(140, resultForm.ClientSize.Height - 55);
                btnClose.Location = new Point(resultForm.ClientSize.Width - 100, resultForm.ClientSize.Height - 55);
            };

            resultForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡ç®¡ç†ç¬¬äº”å±¤ï¼ˆé€æ˜åœ–å¡Šï¼‰è³‡æ–™
        private void btnToolCheckL5_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†æœ‰ Layer5 è³‡æ–™çš„ S32
            List<(string filePath, string fileName, int count, List<Layer5Item> items)> s32WithL5 =
                new List<(string, string, int, List<Layer5Item>)>();

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer5.Count > 0)
                {
                    s32WithL5.Add((filePath, fileName, s32Data.Layer5.Count, s32Data.Layer5.ToList()));
                }
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L5 æª¢æŸ¥èˆ‡æ¸…é™¤ - {s32WithL5.Count} å€‹ S32 æœ‰è³‡æ–™";
            resultForm.Size = new Size(700, 550);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            int totalItems = s32WithL5.Sum(x => x.count);
            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {s32WithL5.Count} å€‹ S32 æœ‰ Layer5 è³‡æ–™ï¼Œç¸½è¨ˆ {totalItems} é …ã€‚";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(660, 20);
            resultForm.Controls.Add(lblSummary);

            // æœå°‹å€åŸŸ
            Label lblSearch = new Label();
            lblSearch.Text = "æœå°‹:";
            lblSearch.Location = new Point(10, 35);
            lblSearch.Size = new Size(40, 20);
            resultForm.Controls.Add(lblSearch);

            TextBox txtSearchX = new TextBox();
            txtSearchX.Location = new Point(50, 32);
            txtSearchX.Size = new Size(60, 22);
            txtSearchX.PlaceholderText = "X";
            resultForm.Controls.Add(txtSearchX);

            TextBox txtSearchY = new TextBox();
            txtSearchY.Location = new Point(115, 32);
            txtSearchY.Size = new Size(60, 22);
            txtSearchY.PlaceholderText = "Y";
            resultForm.Controls.Add(txtSearchY);

            TextBox txtSearchObjIdx = new TextBox();
            txtSearchObjIdx.Location = new Point(180, 32);
            txtSearchObjIdx.Size = new Size(70, 22);
            txtSearchObjIdx.PlaceholderText = "ObjIdx";
            resultForm.Controls.Add(txtSearchObjIdx);

            Button btnSearch = new Button();
            btnSearch.Text = "æœå°‹";
            btnSearch.Location = new Point(255, 31);
            btnSearch.Size = new Size(50, 24);
            resultForm.Controls.Add(btnSearch);

            Button btnClearSearch = new Button();
            btnClearSearch.Text = "æ¸…é™¤";
            btnClearSearch.Location = new Point(310, 31);
            btnClearSearch.Size = new Size(50, 24);
            resultForm.Controls.Add(btnClearSearch);

            Label lblSearchResult = new Label();
            lblSearchResult.Text = "";
            lblSearchResult.Location = new Point(370, 35);
            lblSearchResult.Size = new Size(290, 20);
            lblSearchResult.ForeColor = Color.Blue;
            resultForm.Controls.Add(lblSearchResult);

            CheckedListBox clbItems = new CheckedListBox();
            clbItems.Location = new Point(10, 60);
            clbItems.Size = new Size(660, 355);
            clbItems.Font = new Font("Consolas", 9);
            clbItems.CheckOnClick = true;

            List<(string filePath, int itemIndex, Layer5Item item)> itemInfoList =
                new List<(string, int, Layer5Item)>();
            List<(string filePath, int itemIndex, Layer5Item item, string fileName)> allItems =
                new List<(string, int, Layer5Item, string)>();

            // å»ºç«‹å®Œæ•´é …ç›®åˆ—è¡¨
            foreach (var (filePath, fileName, count, items) in s32WithL5)
            {
                for (int i = 0; i < items.Count; i++)
                {
                    allItems.Add((filePath, i, items[i], fileName));
                }
            }

            // é¡¯ç¤ºé …ç›®çš„æ–¹æ³•
            Action<List<(string filePath, int itemIndex, Layer5Item item, string fileName)>> displayItems = (itemsToShow) =>
            {
                clbItems.Items.Clear();
                itemInfoList.Clear();
                if (itemsToShow.Count == 0)
                {
                    clbItems.Items.Add("æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®");
                    clbItems.Enabled = false;
                }
                else
                {
                    clbItems.Enabled = true;
                    foreach (var (filePath, itemIndex, item, fileName) in itemsToShow)
                    {
                        string displayText = $"[{fileName}] X={item.X}, Y={item.Y}, ObjIdx={item.ObjectIndex}, Type={item.Type}";
                        clbItems.Items.Add(displayText);
                        itemInfoList.Add((filePath, itemIndex, item));
                    }
                }
            };

            // æœå°‹æ–¹æ³•
            Action doSearch = () =>
            {
                string xText = txtSearchX.Text.Trim();
                string yText = txtSearchY.Text.Trim();
                string objIdxText = txtSearchObjIdx.Text.Trim();

                if (string.IsNullOrEmpty(xText) && string.IsNullOrEmpty(yText) && string.IsNullOrEmpty(objIdxText))
                {
                    displayItems(allItems);
                    lblSearchResult.Text = "";
                    return;
                }

                int? searchX = null, searchY = null;
                ushort? searchObjIdx = null;

                if (!string.IsNullOrEmpty(xText) && int.TryParse(xText, out int x)) searchX = x;
                if (!string.IsNullOrEmpty(yText) && int.TryParse(yText, out int y)) searchY = y;
                if (!string.IsNullOrEmpty(objIdxText) && ushort.TryParse(objIdxText, out ushort objIdx)) searchObjIdx = objIdx;

                var filtered = allItems.Where(a =>
                    (!searchX.HasValue || a.item.X == searchX.Value) &&
                    (!searchY.HasValue || a.item.Y == searchY.Value) &&
                    (!searchObjIdx.HasValue || a.item.ObjectIndex == searchObjIdx.Value)
                ).ToList();

                displayItems(filtered);

                var conditions = new List<string>();
                if (searchX.HasValue) conditions.Add($"X={searchX}");
                if (searchY.HasValue) conditions.Add($"Y={searchY}");
                if (searchObjIdx.HasValue) conditions.Add($"ObjIdx={searchObjIdx}");
                lblSearchResult.Text = $"æ‰¾åˆ° {filtered.Count} å€‹ ({string.Join(", ", conditions)})";
            };

            // åˆå§‹é¡¯ç¤ºå…¨éƒ¨
            if (s32WithL5.Count == 0)
            {
                clbItems.Items.Add("æ²’æœ‰ä»»ä½• S32 æª”æ¡ˆæœ‰ Layer5 è³‡æ–™");
                clbItems.Enabled = false;
            }
            else
            {
                displayItems(allItems);
            }

            // æœå°‹äº‹ä»¶
            btnSearch.Click += (s, args) => doSearch();

            // Enter éµæœå°‹
            EventHandler<KeyEventArgs> searchOnEnter = (s, args) =>
            {
                if (args.KeyCode == Keys.Enter)
                {
                    doSearch();
                    args.SuppressKeyPress = true;
                }
            };
            txtSearchX.KeyDown += (s, args) => searchOnEnter(s, args);
            txtSearchY.KeyDown += (s, args) => searchOnEnter(s, args);
            txtSearchObjIdx.KeyDown += (s, args) => searchOnEnter(s, args);

            // æ¸…é™¤æœå°‹
            btnClearSearch.Click += (s, args) =>
            {
                txtSearchX.Text = "";
                txtSearchY.Text = "";
                txtSearchObjIdx.Text = "";
                displayItems(allItems);
                lblSearchResult.Text = "";
            };

            resultForm.Controls.Add(clbItems);

            Button btnSelectAll = new Button();
            btnSelectAll.Text = "å…¨é¸";
            btnSelectAll.Location = new Point(10, 425);
            btnSelectAll.Size = new Size(80, 30);
            btnSelectAll.Click += (s, args) =>
            {
                for (int i = 0; i < clbItems.Items.Count; i++)
                    clbItems.SetItemChecked(i, true);
            };
            resultForm.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button();
            btnDeselectAll.Text = "å–æ¶ˆå…¨é¸";
            btnDeselectAll.Location = new Point(100, 425);
            btnDeselectAll.Size = new Size(80, 30);
            btnDeselectAll.Click += (s, args) =>
            {
                for (int i = 0; i < clbItems.Items.Count; i++)
                    clbItems.SetItemChecked(i, false);
            };
            resultForm.Controls.Add(btnDeselectAll);

            Button btnClearSelected = new Button();
            btnClearSelected.Text = "æ¸…é™¤å‹¾é¸é …ç›®";
            btnClearSelected.Location = new Point(10, 465);
            btnClearSelected.Size = new Size(120, 35);
            btnClearSelected.BackColor = Color.LightCoral;
            btnClearSelected.Enabled = s32WithL5.Count > 0;
            btnClearSelected.Click += (s, args) =>
            {
                if (clbItems.CheckedIndices.Count == 0)
                {
                    MessageBox.Show("è«‹å…ˆå‹¾é¸è¦æ¸…é™¤çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦æ¸…é™¤å‹¾é¸çš„ {clbItems.CheckedIndices.Count} å€‹ Layer5 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªæ¸…é™¤",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                Dictionary<string, List<Layer5Item>> toRemove = new Dictionary<string, List<Layer5Item>>();
                foreach (int idx in clbItems.CheckedIndices)
                {
                    var info = itemInfoList[idx];
                    if (!toRemove.ContainsKey(info.filePath))
                        toRemove[info.filePath] = new List<Layer5Item>();
                    toRemove[info.filePath].Add(info.item);
                }

                int removedCount = 0;
                foreach (var kvp in toRemove)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out S32Data s32Data))
                    {
                        foreach (var item in kvp.Value)
                        {
                            if (s32Data.Layer5.Remove(item))
                                removedCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²æ¸…é™¤ {removedCount} å€‹ Layer5 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                UpdateLayer5InvalidButton();
                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button();
            btnClearAll.Text = "æ¸…é™¤å…¨éƒ¨ L5";
            btnClearAll.Location = new Point(140, 465);
            btnClearAll.Size = new Size(120, 35);
            btnClearAll.BackColor = Color.Salmon;
            btnClearAll.Enabled = s32WithL5.Count > 0;
            btnClearAll.Click += (s, args) =>
            {
                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ {totalItems} å€‹ Layer5 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªæ¸…é™¤å…¨éƒ¨",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int removedCount = 0;
                foreach (var (filePath, fileName, count, items) in s32WithL5)
                {
                    if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                    {
                        removedCount += s32Data.Layer5.Count;
                        s32Data.Layer5.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²æ¸…é™¤ {removedCount} å€‹ Layer5 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                UpdateLayer5InvalidButton();
                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearAll);

            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(580, 465);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            resultForm.Resize += (s, args) =>
            {
                clbItems.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 130);
                btnSelectAll.Location = new Point(10, resultForm.ClientSize.Height - 85);
                btnDeselectAll.Location = new Point(100, resultForm.ClientSize.Height - 85);
                btnClearSelected.Location = new Point(10, resultForm.ClientSize.Height - 45);
                btnClearAll.Location = new Point(140, resultForm.ClientSize.Height - 45);
                btnClose.Location = new Point(resultForm.ClientSize.Width - 100, resultForm.ClientSize.Height - 45);
            };

            resultForm.Show();
        }

        // æª¢æŸ¥ Layer5 ç•°å¸¸ä¸¦æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼Œä¸é˜»å¡ UIï¼‰
        private void UpdateLayer5InvalidButton()
        {
            // å…ˆéš±è—æŒ‰éˆ•ï¼ŒèƒŒæ™¯æª¢æŸ¥å®Œæˆå¾Œå†æ›´æ–°
            btnToolCheckL5Invalid.Visible = false;

            Task.Run(() =>
            {
                var totalSw = Stopwatch.StartNew();

                var sw1 = Stopwatch.StartNew();
                var invalidL5Items = GetInvalidLayer5Items();
                sw1.Stop();

                var sw2 = Stopwatch.StartNew();
                var invalidTileItems = GetInvalidTileIds();
                sw2.Stop();

                var sw3 = Stopwatch.StartNew();
                var layer8ExtendedS32 = GetLayer8ExtendedS32Files();
                sw3.Stop();

                var sw4 = Stopwatch.StartNew();
                var (overLimitTileIds, tileLimit, maxTileId) = GetAllOverLimitTileIds();
                sw4.Stop();

                totalSw.Stop();

                int totalInvalid = invalidL5Items.Count + invalidTileItems.Count + layer8ExtendedS32.Count + overLimitTileIds.Count;
                Console.WriteLine($"[L5CHECK] Total: {totalSw.ElapsedMilliseconds}ms | L5Check: {sw1.ElapsedMilliseconds}ms ({invalidL5Items.Count}) | TileValidate: {sw2.ElapsedMilliseconds}ms ({invalidTileItems.Count}) | L8Ext: {sw3.ElapsedMilliseconds}ms ({layer8ExtendedS32.Count}) | OverLimit: {sw4.ElapsedMilliseconds}ms ({overLimitTileIds.Count})");

                // å›åˆ° UI åŸ·è¡Œç·’æ›´æ–°æŒ‰éˆ•
                this.BeginInvoke((MethodInvoker)delegate
                {
                    btnToolCheckL5Invalid.Visible = totalInvalid > 0;
                    if (totalInvalid > 0)
                    {
                        var tooltipParts = new List<string>();
                        if (invalidL5Items.Count > 0)
                            tooltipParts.Add($"Layer5ç•°å¸¸: {invalidL5Items.Count}");
                        if (invalidTileItems.Count > 0)
                            tooltipParts.Add($"ç„¡æ•ˆTileId: {invalidTileItems.Count}");
                        if (layer8ExtendedS32.Count > 0)
                            tooltipParts.Add($"L8æ“´å±•: {layer8ExtendedS32.Count}");
                        if (overLimitTileIds.Count > 0)
                            tooltipParts.Add($"Tileè¶…ä¸Šé™: {overLimitTileIds.Count}");
                        toolTip1.SetToolTip(btnToolCheckL5Invalid, $"ç™¼ç¾ç•°å¸¸: {string.Join(", ", tooltipParts)}");
                    }
                });
            });
        }

        // å–å¾—ä½¿ç”¨ Layer8 æ“´å±•æ ¼å¼çš„ S32 æª”æ¡ˆ
        private List<(string filePath, string fileName, int layer8Count)> GetLayer8ExtendedS32Files()
        {
            var result = new List<(string filePath, string fileName, int layer8Count)>();

            if (_document.S32Files.Count == 0)
                return result;

            foreach (var kvp in _document.S32Files)
            {
                if (kvp.Value.Layer8HasExtendedData)
                {
                    result.Add((kvp.Key, Path.GetFileName(kvp.Key), kvp.Value.Layer8.Count));
                }
            }

            return result;
        }

        // å–å¾— Layer5 ä¸­ ObjectIndex ä¸å­˜åœ¨æ–¼ Layer4 GroupId çš„é …ç›®
        // æˆ–é›–ç„¶å­˜åœ¨ä½†è©²æ ¼æ‰¾ä¸åˆ°å°æ‡‰ GroupId çš„ç‰©ä»¶
        private List<(string filePath, string fileName, Layer5Item item, int itemIndex, string reason)> GetInvalidLayer5Items()
        {
            if (_document.S32Files.Count == 0)
                return new List<(string filePath, string fileName, Layer5Item item, int itemIndex, string reason)>();

            // å–å¾—ç›®å‰ viewport ç¯„åœ
            var viewportRect = _viewState.GetViewportWorldRect();

            // éæ¿¾å‡º viewport å…§çš„ S32 æª”æ¡ˆ
            var viewportS32Files = new Dictionary<string, S32Data>();
            foreach (var kvp in _document.S32Files)
            {
                S32Data s32Data = kvp.Value;

                // æª¢æŸ¥ S32 æ˜¯å¦åœ¨ viewport å…§
                int[] loc = s32Data.SegInfo.GetLoc(1.0);
                int blockWidth = 64 * 24 * 2;  // 3072
                int blockHeight = 64 * 12 * 2; // 1536
                Rectangle blockRect = new Rectangle(loc[0], loc[1], blockWidth, blockHeight);
                if (blockRect.IntersectsWith(viewportRect))
                {
                    viewportS32Files[kvp.Key] = s32Data;
                }
            }

            // ä½¿ç”¨å…±ç”¨çš„ Layer5Checker æª¢æŸ¥ï¼ˆradius=0 è¡¨ç¤ºåªæª¢æŸ¥è©²æ ¼ï¼‰
            var results = Layer5Checker.Check(
                viewportS32Files,
                radius: -1,
                getSegInfo: s32 => (s32.SegInfo.nLinBeginX, s32.SegInfo.nLinBeginY));

            // è½‰æ›ç‚ºèˆŠæ ¼å¼
            return results.Select(r => (r.FilePath, r.FileName, r.Item, r.ItemIndex, r.Reason)).ToList();
        }

        /// <summary>
        /// æª¢æŸ¥æŒ‡å®šçš„ S32 æª”æ¡ˆæ˜¯å¦æœ‰ç•°å¸¸ï¼ˆLayer5ã€ç„¡æ•ˆTileIdã€Layer8æ“´å±•ã€Tileè¶…ä¸Šé™ï¼‰ï¼Œå¦‚æœæœ‰å‰‡æç¤ºç”¨æˆ¶ç¢ºèª
        /// </summary>
        /// <param name="s32Files">è¦æª¢æŸ¥çš„ S32 æª”æ¡ˆå­—å…¸</param>
        /// <param name="operationName">æ“ä½œåç¨±ï¼ˆç”¨æ–¼é¡¯ç¤ºè¨Šæ¯ï¼‰</param>
        /// <param name="checkTileLimit">æ˜¯å¦æª¢æŸ¥ Tile è¶…éä¸Šé™ï¼ˆåŒ¯å‡ºæ™‚ä¸éœ€è¦ï¼‰</param>
        /// <param name="checkLayer8Extended">æ˜¯å¦æª¢æŸ¥ Layer8 æ“´å±•æ ¼å¼ï¼ˆè‹¥æœƒç§»é™¤å‰‡ä¸éœ€è¦ï¼‰</param>
        /// <returns>true = ç¹¼çºŒæ“ä½œ, false = å–æ¶ˆæ“ä½œ</returns>
        private bool CheckLayer5IssuesAndConfirm(Dictionary<string, S32Data> s32Files, string operationName, bool checkTileLimit = true, bool checkLayer8Extended = true)
        {
            if (s32Files == null || s32Files.Count == 0)
                return true;

            try
            {
                // éæ¿¾æ‰ SegInfo ç‚º null çš„é …ç›®
                var validS32Files = s32Files.Where(kvp => kvp.Value?.SegInfo != null)
                    .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

                if (validS32Files.Count == 0)
                    return true;

                var msgParts = new List<string>();
                int totalIssues = 0;

                // 1. Layer5 æª¢æŸ¥
                var l5Results = Layer5Checker.Check(
                    validS32Files,
                    radius: -1,
                    getSegInfo: s32 => (s32.SegInfo.nLinBeginX, s32.SegInfo.nLinBeginY));
                if (l5Results.Count > 0)
                {
                    int noGroupCount = l5Results.Count(r => r.Reason == "GroupIdä¸å­˜åœ¨");
                    int noObjCount = l5Results.Count(r => r.Reason == "å‘¨åœç„¡å°æ‡‰ç‰©ä»¶");
                    var l5Parts = new List<string>();
                    if (noGroupCount > 0) l5Parts.Add($"GroupIdä¸å­˜åœ¨:{noGroupCount}");
                    if (noObjCount > 0) l5Parts.Add($"å‘¨åœç„¡ç‰©ä»¶:{noObjCount}");
                    msgParts.Add($"â€¢ {l5Results.Count} å€‹ Layer5 ç•°å¸¸ ({string.Join(", ", l5Parts)})");
                    totalIssues += l5Results.Count;
                }

                // 2. ç„¡æ•ˆ TileId æª¢æŸ¥
                var invalidTiles = CheckInvalidTileIds(validS32Files);
                if (invalidTiles.Count > 0)
                {
                    int l1Count = invalidTiles.Count(t => t.layer == "Layer1");
                    int l2Count = invalidTiles.Count(t => t.layer == "Layer2");
                    int l4Count = invalidTiles.Count(t => t.layer == "Layer4");
                    var tileParts = new List<string>();
                    if (l1Count > 0) tileParts.Add($"L1:{l1Count}");
                    if (l2Count > 0) tileParts.Add($"L2:{l2Count}");
                    if (l4Count > 0) tileParts.Add($"L4:{l4Count}");
                    msgParts.Add($"â€¢ {invalidTiles.Count} å€‹ç„¡æ•ˆçš„ TileId ({string.Join(", ", tileParts)})");
                    totalIssues += invalidTiles.Count;
                }

                // 3. Layer8 æ“´å±•æ ¼å¼æª¢æŸ¥ï¼ˆè‹¥æœƒç§»é™¤å‰‡ä¸éœ€è¦æª¢æŸ¥ï¼‰
                if (checkLayer8Extended)
                {
                    var l8Extended = validS32Files.Where(kvp => kvp.Value.Layer8HasExtendedData).ToList();
                    if (l8Extended.Count > 0)
                    {
                        int totalL8Items = l8Extended.Sum(kvp => kvp.Value.Layer8.Count);
                        msgParts.Add($"â€¢ {l8Extended.Count} å€‹ S32 ä½¿ç”¨ Layer8 æ“´å±•æ ¼å¼ï¼ˆå…± {totalL8Items} å€‹é …ç›®ï¼Œå¯èƒ½å°è‡´é–ƒé€€ï¼‰");
                        totalIssues += l8Extended.Count;
                    }
                }

                // 4. Tile è¶…éä¸Šé™æª¢æŸ¥ï¼ˆåŒ¯å‡ºæ™‚ä¸éœ€è¦ï¼‰
                if (checkTileLimit)
                {
                    var (overLimitTiles, tileLimit, maxTileId) = CheckOverLimitTileIds(validS32Files);
                    if (overLimitTiles.Count > 0)
                    {
                        msgParts.Add($"â€¢ {overLimitTiles.Count} å€‹ Tile è¶…éä¸Šé™ (ä¸Šé™={tileLimit}, æœ€å¤§={maxTileId})ï¼Œå°‡ç„¡æ³•é¡¯ç¤ºæˆ–å°è‡´é–ƒé€€");
                        totalIssues += overLimitTiles.Count;
                    }
                }

                if (totalIssues == 0)
                    return true;

                string message = $"ç™¼ç¾ä»¥ä¸‹ç•°å¸¸ï¼š\n\n{string.Join("\n", msgParts)}\n\n" +
                                 $"é€™äº›ç•°å¸¸å¯èƒ½å°è‡´éŠæˆ²ä¸­å‡ºç¾å•é¡Œã€‚\næ˜¯å¦ä»è¦ç¹¼çºŒ{operationName}ï¼Ÿ";

                var result = MessageBox.Show(message, "ç•°å¸¸æª¢æŸ¥è­¦å‘Š",
                    MessageBoxButtons.YesNo, MessageBoxIcon.Warning);

                return result == DialogResult.Yes;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[CheckIssues] Error: {ex}");
                var result = MessageBox.Show($"ç•°å¸¸æª¢æŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n{ex.Message}\n\n{ex.StackTrace}\n\næ˜¯å¦ä»è¦ç¹¼çºŒ{operationName}ï¼Ÿ",
                    "æª¢æŸ¥éŒ¯èª¤", MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                return result == DialogResult.Yes;
            }
        }

        /// <summary>
        /// æª¢æŸ¥æŒ‡å®š S32 æª”æ¡ˆä¸­çš„ç„¡æ•ˆ TileId
        /// </summary>
        private List<(string filePath, string layer, int tileId)> CheckInvalidTileIds(Dictionary<string, S32Data> s32Files)
        {
            var invalidTiles = new List<(string filePath, string layer, int tileId)>();

            // å»ºç«‹å¯ç”¨ TileId çš„ HashSet
            var availableTileIds = new HashSet<int>();
            L1PakReader.UnPack("Tile", "1.til");  // è§¸ç™¼è¼‰å…¥
            if (Share.IdxDataList.TryGetValue("Tile", out var tileIdx))
            {
                foreach (var key in tileIdx.Keys)
                {
                    string name = Path.GetFileNameWithoutExtension(key);
                    if (int.TryParse(name, out int tileId))
                        availableTileIds.Add(tileId);
                }
            }

            if (availableTileIds.Count == 0)
                return invalidTiles;

            foreach (var kvp in s32Files)
            {
                var s32Data = kvp.Value;

                // Layer1
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId > 0 && !availableTileIds.Contains(cell.TileId))
                            invalidTiles.Add((kvp.Key, "Layer1", cell.TileId));
                    }
                }

                // Layer2
                foreach (var item in s32Data.Layer2)
                {
                    if (item.TileId > 0 && !availableTileIds.Contains(item.TileId))
                        invalidTiles.Add((kvp.Key, "Layer2", item.TileId));
                }

                // Layer4
                foreach (var obj in s32Data.Layer4)
                {
                    if (obj.TileId > 0 && !availableTileIds.Contains(obj.TileId))
                        invalidTiles.Add((kvp.Key, "Layer4", obj.TileId));
                }
            }

            return invalidTiles;
        }

        /// <summary>
        /// æª¢æŸ¥æŒ‡å®š S32 æª”æ¡ˆä¸­è¶…éä¸Šé™çš„ TileId
        /// </summary>
        private (List<int> overLimitTileIds, int tileLimit, int maxTileId) CheckOverLimitTileIds(Dictionary<string, S32Data> s32Files)
        {
            var overLimitIds = new HashSet<int>();
            int maxId = 0;

            int tileLimit = TileHashManager.GetTileLimit();
            if (tileLimit <= 0)
                return (new List<int>(), tileLimit, maxId);

            foreach (var kvp in s32Files)
            {
                var s32Data = kvp.Value;

                // Layer1
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId > 0)
                        {
                            if (cell.TileId > maxId) maxId = cell.TileId;
                            if (cell.TileId > tileLimit) overLimitIds.Add(cell.TileId);
                        }
                    }
                }

                // Layer2
                foreach (var item in s32Data.Layer2)
                {
                    if (item.TileId > 0)
                    {
                        if (item.TileId > maxId) maxId = item.TileId;
                        if (item.TileId > tileLimit) overLimitIds.Add(item.TileId);
                    }
                }

                // Layer4
                foreach (var obj in s32Data.Layer4)
                {
                    if (obj.TileId > 0)
                    {
                        if (obj.TileId > maxId) maxId = obj.TileId;
                        if (obj.TileId > tileLimit) overLimitIds.Add(obj.TileId);
                    }
                }
            }

            return (overLimitIds.ToList(), tileLimit, maxId);
        }

        // ç„¡æ•ˆ TileId è³‡è¨Šé¡åˆ¥
        private class InvalidTileInfo
        {
            public string FilePath { get; set; } = string.Empty;
            public string FileName { get; set; } = string.Empty;
            public string Layer { get; set; } = string.Empty;  // "Layer1", "Layer2", "Layer4"
            public int X { get; set; }
            public int Y { get; set; }
            public int TileId { get; set; }
            public int IndexId { get; set; }
            public string Reason { get; set; } = string.Empty;  // "Tilæª”æ¡ˆä¸å­˜åœ¨" æˆ– "IndexIdè¶…å‡ºç¯„åœ"
        }

        // å–å¾—ç„¡æ•ˆçš„ TileIdï¼ˆLayer1, Layer2, Layer4ï¼‰- Fast mode ä½¿ç”¨ç´¢å¼•æŸ¥è©¢
        private List<InvalidTileInfo> GetInvalidTileIds()
        {
            var invalidTiles = new List<InvalidTileInfo>();

            if (_document.S32Files.Count == 0)
                return invalidTiles;

            // Fast mode: å¾ Tile ç´¢å¼•å»ºç«‹å¯ç”¨ TileId çš„ HashSet
            var availableTileIds = new HashSet<int>();

            // è§¸ç™¼è¼‰å…¥ Tile ç´¢å¼•ï¼ˆå¦‚æœå°šæœªè¼‰å…¥ï¼‰
            L1PakReader.UnPack("Tile", "1.til");

            if (Share.IdxDataList.TryGetValue("Tile", out var tileIdx))
            {
                foreach (var key in tileIdx.Keys)
                {
                    // key æ ¼å¼æ˜¯ "123.til"
                    if (key.EndsWith(".til"))
                    {
                        string numStr = key.Substring(0, key.Length - 4);
                        if (int.TryParse(numStr, out int tileId))
                        {
                            availableTileIds.Add(tileId);
                        }
                    }
                }
            }

            // æª¢æŸ¥ TileId æ˜¯å¦å­˜åœ¨æ–¼ç´¢å¼•ä¸­
            bool CheckTileValid(int tileId, out string reason)
            {
                reason = string.Empty;
                if (tileId <= 0) return true;  // TileId = 0 è¡¨ç¤ºç©ºæ ¼å­ï¼Œä¸ç®—ç„¡æ•ˆ

                if (!availableTileIds.Contains(tileId))
                {
                    reason = "Tilæª”æ¡ˆä¸å­˜åœ¨";
                    return false;
                }

                return true;
            }

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                // æª¢æŸ¥ Layer1ï¼ˆåœ°æ¿ï¼‰
                for (int y = 0; y < 64; y++)
                {
                    for (int x = 0; x < 128; x++)
                    {
                        var cell = s32Data.Layer1[y, x];
                        if (cell != null && cell.TileId > 0)
                        {
                            if (!CheckTileValid(cell.TileId, out string reason))
                            {
                                invalidTiles.Add(new InvalidTileInfo
                                {
                                    FilePath = filePath,
                                    FileName = fileName,
                                    Layer = "Layer1",
                                    X = x,
                                    Y = y,
                                    TileId = cell.TileId,
                                    IndexId = cell.IndexId,
                                    Reason = reason
                                });
                            }
                        }
                    }
                }

                // æª¢æŸ¥ Layer2
                for (int i = 0; i < s32Data.Layer2.Count; i++)
                {
                    var item = s32Data.Layer2[i];
                    if (item.TileId > 0)
                    {
                        if (!CheckTileValid(item.TileId, out string reason))
                        {
                            invalidTiles.Add(new InvalidTileInfo
                            {
                                FilePath = filePath,
                                FileName = fileName,
                                Layer = "Layer2",
                                X = item.X,
                                Y = item.Y,
                                TileId = item.TileId,
                                IndexId = item.IndexId,
                                Reason = reason
                            });
                        }
                    }
                }

                // æª¢æŸ¥ Layer4ï¼ˆç‰©ä»¶ï¼‰
                for (int i = 0; i < s32Data.Layer4.Count; i++)
                {
                    var obj = s32Data.Layer4[i];
                    if (obj.TileId > 0)
                    {
                        if (!CheckTileValid(obj.TileId, out string reason))
                        {
                            invalidTiles.Add(new InvalidTileInfo
                            {
                                FilePath = filePath,
                                FileName = fileName,
                                Layer = "Layer4",
                                X = obj.X,
                                Y = obj.Y,
                                TileId = obj.TileId,
                                IndexId = obj.IndexId,
                                Reason = reason
                            });
                        }
                    }
                }
            }

            return invalidTiles;
        }

        // å–å¾— Tile.idx ä¸­è¶…é list.til ä¸Šé™çš„æ‰€æœ‰ TileId
        private (List<int> overLimitTileIds, int tileLimit, int maxTileId) GetAllOverLimitTileIds()
        {
            var overLimitIds = new List<int>();
            int maxId = 0;

            // å–å¾— list.til ä¸Šé™
            int tileLimit = TileHashManager.GetTileLimit();
            if (tileLimit <= 0)
                return (overLimitIds, tileLimit, maxId);  // ç„¡æ³•è®€å–ä¸Šé™ï¼Œä¸æª¢æŸ¥

            // å–å¾—æ‰€æœ‰ Tile ç´¢å¼•
            var tileIdx = L1IdxReader.GetAll("Tile");
            if (tileIdx == null || tileIdx.Count == 0)
                return (overLimitIds, tileLimit, maxId);

            foreach (var key in tileIdx.Keys)
            {
                // key æ ¼å¼æ˜¯ "123.til"
                if (key.EndsWith(".til") && key != "list.til")
                {
                    string numStr = key.Substring(0, key.Length - 4);
                    if (int.TryParse(numStr, out int tileId))
                    {
                        if (tileId > maxId) maxId = tileId;
                        if (tileId > tileLimit)
                        {
                            overLimitIds.Add(tileId);
                        }
                    }
                }
            }

            overLimitIds.Sort();
            return (overLimitIds, tileLimit, maxId);
        }

        // æª¢æŸ¥ Layer5 ç•°å¸¸å’Œç„¡æ•ˆ TileId
        private void btnToolCheckL5Invalid_Click(object sender, EventArgs e)
        {
            var invalidL5Items = GetInvalidLayer5Items();
            var invalidTileItems = GetInvalidTileIds();
            var layer8ExtendedS32 = GetLayer8ExtendedS32Files();
            var (overLimitTileIds, tileLimit, maxTileId) = GetAllOverLimitTileIds();

            if (invalidL5Items.Count == 0 && invalidTileItems.Count == 0 && layer8ExtendedS32.Count == 0 && overLimitTileIds.Count == 0)
            {
                MessageBox.Show("æª¢æŸ¥å®Œæˆï¼Œæ²’æœ‰ç™¼ç¾ä»»ä½•ç•°å¸¸ã€‚",
                    "æª¢æŸ¥å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                btnToolCheckL5Invalid.Visible = false;
                return;
            }

            // å»ºç«‹è¨Šæ¯
            var msgParts = new List<string>();
            if (invalidL5Items.Count > 0)
            {
                int noGroupCount = invalidL5Items.Count(x => x.reason == "GroupIdä¸å­˜åœ¨");
                int noObjCount = invalidL5Items.Count(x => x.reason == "å‘¨åœç„¡å°æ‡‰ç‰©ä»¶");
                var l5Parts = new List<string>();
                if (noGroupCount > 0) l5Parts.Add($"GroupIdä¸å­˜åœ¨:{noGroupCount}");
                if (noObjCount > 0) l5Parts.Add($"å‘¨åœç„¡ç‰©ä»¶:{noObjCount}");
                msgParts.Add($"â€¢ {invalidL5Items.Count} å€‹ Layer5 ç•°å¸¸ ({string.Join(", ", l5Parts)})");
            }
            if (invalidTileItems.Count > 0)
            {
                // çµ±è¨ˆå„å±¤çš„ç„¡æ•ˆ TileId æ•¸é‡
                int l1Count = invalidTileItems.Count(t => t.Layer == "Layer1");
                int l2Count = invalidTileItems.Count(t => t.Layer == "Layer2");
                int l4Count = invalidTileItems.Count(t => t.Layer == "Layer4");
                var tileParts = new List<string>();
                if (l1Count > 0) tileParts.Add($"L1:{l1Count}");
                if (l2Count > 0) tileParts.Add($"L2:{l2Count}");
                if (l4Count > 0) tileParts.Add($"L4:{l4Count}");
                msgParts.Add($"â€¢ {invalidTileItems.Count} å€‹ç„¡æ•ˆçš„ TileId ({string.Join(", ", tileParts)})");
            }
            if (layer8ExtendedS32.Count > 0)
            {
                int totalL8Items = layer8ExtendedS32.Sum(x => x.layer8Count);
                msgParts.Add(string.Format(LocalizationManager.L("AbnormalCheck_Layer8Extended"), layer8ExtendedS32.Count, totalL8Items));
            }
            if (overLimitTileIds.Count > 0)
            {
                msgParts.Add(string.Format(LocalizationManager.L("AbnormalCheck_TileOverLimit"), overLimitTileIds.Count, tileLimit, maxTileId));
            }

            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            string message = $"{LocalizationManager.L("AbnormalCheck_FoundIssues")}\n\n{string.Join("\n", msgParts)}\n\n{LocalizationManager.L("AbnormalCheck_ViewDetails")}";
            var confirmResult = MessageBox.Show(message, LocalizationManager.L("AbnormalCheck_Title"),
                MessageBoxButtons.YesNo, MessageBoxIcon.Warning);

            if (confirmResult != DialogResult.Yes)
                return;

            // é¡¯ç¤ºæ¸…å–®è®“ä½¿ç”¨è€…é¸æ“‡è¦æ¸…é™¤çš„é …ç›®
            Form resultForm = new Form();
            resultForm.Text = LocalizationManager.L("AbnormalCheck_Title");
            resultForm.Size = new Size(850, 600);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            // ä½¿ç”¨ TabControl åˆ†é é¡¯ç¤º
            TabControl tabControl = new TabControl();
            tabControl.Location = new Point(10, 10);
            tabControl.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 60);
            tabControl.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
            resultForm.Controls.Add(tabControl);

            // ===== Tab 1: Layer5 ç•°å¸¸ =====
            if (invalidL5Items.Count > 0)
            {
                TabPage tabL5 = new TabPage(string.Format(LocalizationManager.L("AbnormalCheck_Tab_Layer5"), invalidL5Items.Count));
                tabControl.TabPages.Add(tabL5);

                Label lblL5Summary = new Label();
                lblL5Summary.Text = string.Format(LocalizationManager.L("AbnormalCheck_Layer5Summary"), invalidL5Items.Count);
                lblL5Summary.Location = new Point(5, 5);
                lblL5Summary.Size = new Size(tabL5.ClientSize.Width - 10, 20);
                lblL5Summary.Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right;
                tabL5.Controls.Add(lblL5Summary);

                CheckedListBox clbL5Items = new CheckedListBox();
                clbL5Items.Location = new Point(5, 30);
                clbL5Items.Size = new Size(tabL5.ClientSize.Width - 10, tabL5.ClientSize.Height - 110);
                clbL5Items.Font = new Font("Consolas", 9);
                clbL5Items.CheckOnClick = true;
                clbL5Items.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

                foreach (var (filePath, fileName, item, itemIndex, reason) in invalidL5Items)
                {
                    string displayText = $"[{fileName}] X={item.X}, Y={item.Y}, ObjIdx={item.ObjectIndex}, Type={item.Type} [{reason}]";
                    clbL5Items.Items.Add(displayText);
                }
                tabL5.Controls.Add(clbL5Items);

                // æŒ‰éˆ•é¢æ¿
                Panel pnlL5Buttons = new Panel();
                pnlL5Buttons.Location = new Point(5, tabL5.ClientSize.Height - 75);
                pnlL5Buttons.Size = new Size(tabL5.ClientSize.Width - 10, 70);
                pnlL5Buttons.Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
                tabL5.Controls.Add(pnlL5Buttons);

                Button btnL5SelectAll = new Button { Text = LocalizationManager.L("Button_SelectAll"), Location = new Point(0, 0), Size = new Size(80, 30) };
                btnL5SelectAll.Click += (s, args) => { for (int i = 0; i < clbL5Items.Items.Count; i++) clbL5Items.SetItemChecked(i, true); };
                pnlL5Buttons.Controls.Add(btnL5SelectAll);

                Button btnL5DeselectAll = new Button { Text = LocalizationManager.L("AbnormalCheck_DeselectAll"), Location = new Point(90, 0), Size = new Size(80, 30) };
                btnL5DeselectAll.Click += (s, args) => { for (int i = 0; i < clbL5Items.Items.Count; i++) clbL5Items.SetItemChecked(i, false); };
                pnlL5Buttons.Controls.Add(btnL5DeselectAll);

                Button btnL5ClearSelected = new Button { Text = LocalizationManager.L("AbnormalCheck_ClearSelected"), Location = new Point(0, 35), Size = new Size(100, 30), BackColor = Color.LightCoral };
                btnL5ClearSelected.Click += (s, args) =>
                {
                    if (clbL5Items.CheckedIndices.Count == 0) { MessageBox.Show(LocalizationManager.L("AbnormalCheck_PleaseSelectItems"), LocalizationManager.L("AbnormalCheck_Notice")); return; }
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmClearSelected"), clbL5Items.CheckedIndices.Count), LocalizationManager.L("AbnormalCheck_ConfirmDelete"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;

                    var toDelete = new Dictionary<string, List<Layer5Item>>();
                    foreach (int idx in clbL5Items.CheckedIndices)
                    {
                        var (filePath, _, item, _, _) = invalidL5Items[idx];
                        if (!toDelete.ContainsKey(filePath)) toDelete[filePath] = new List<Layer5Item>();
                        toDelete[filePath].Add(item);
                    }
                    int deletedCount = 0;
                    foreach (var kvp in toDelete)
                    {
                        if (_document.S32Files.TryGetValue(kvp.Key, out var s32Data))
                        {
                            foreach (var item in kvp.Value) { s32Data.Layer5.Remove(item); deletedCount++; }
                            s32Data.IsModified = true;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ClearedLayer5"), deletedCount), LocalizationManager.L("AbnormalCheck_ClearComplete"));
                    ClearS32BlockCache(); resultForm.Close(); RenderS32Map();
                };
                pnlL5Buttons.Controls.Add(btnL5ClearSelected);

                Button btnL5ClearAll = new Button { Text = LocalizationManager.L("AbnormalCheck_ClearAll"), Location = new Point(110, 35), Size = new Size(100, 30), BackColor = Color.Salmon };
                btnL5ClearAll.Click += (s, args) =>
                {
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmClearAll"), invalidL5Items.Count), LocalizationManager.L("AbnormalCheck_ConfirmDeleteAll"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;
                    var toDelete = new Dictionary<string, List<Layer5Item>>();
                    foreach (var (filePath, _, item, _, _) in invalidL5Items)
                    {
                        if (!toDelete.ContainsKey(filePath)) toDelete[filePath] = new List<Layer5Item>();
                        toDelete[filePath].Add(item);
                    }
                    int deletedCount = 0;
                    foreach (var kvp in toDelete)
                    {
                        if (_document.S32Files.TryGetValue(kvp.Key, out var s32Data))
                        {
                            foreach (var item in kvp.Value) { s32Data.Layer5.Remove(item); deletedCount++; }
                            s32Data.IsModified = true;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ClearedLayer5"), deletedCount), LocalizationManager.L("AbnormalCheck_ClearComplete"));
                    ClearS32BlockCache(); resultForm.Close(); RenderS32Map();
                };
                pnlL5Buttons.Controls.Add(btnL5ClearAll);
            }

            // ===== Tab 2: ç„¡æ•ˆ TileId =====
            if (invalidTileItems.Count > 0)
            {
                TabPage tabTile = new TabPage(string.Format(LocalizationManager.L("AbnormalCheck_Tab_InvalidTile"), invalidTileItems.Count));
                tabControl.TabPages.Add(tabTile);

                // çµ±è¨ˆè³‡è¨Š
                int l1Count = invalidTileItems.Count(t => t.Layer == "Layer1");
                int l2Count = invalidTileItems.Count(t => t.Layer == "Layer2");
                int l4Count = invalidTileItems.Count(t => t.Layer == "Layer4");

                Label lblTileSummary = new Label();
                lblTileSummary.Text = string.Format(LocalizationManager.L("AbnormalCheck_TileSummary"), invalidTileItems.Count, l1Count, l2Count, l4Count);
                lblTileSummary.Location = new Point(5, 5);
                lblTileSummary.Size = new Size(tabTile.ClientSize.Width - 10, 20);
                lblTileSummary.Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right;
                tabTile.Controls.Add(lblTileSummary);

                CheckedListBox clbTileItems = new CheckedListBox();
                clbTileItems.Location = new Point(5, 30);
                clbTileItems.Size = new Size(tabTile.ClientSize.Width - 10, tabTile.ClientSize.Height - 110);
                clbTileItems.Font = new Font("Consolas", 9);
                clbTileItems.CheckOnClick = true;
                clbTileItems.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

                foreach (var tile in invalidTileItems)
                {
                    string displayText = $"[{tile.FileName}] {tile.Layer} X={tile.X}, Y={tile.Y}, Tile={tile.TileId}, Idx={tile.IndexId} - {tile.Reason}";
                    clbTileItems.Items.Add(displayText);
                }
                tabTile.Controls.Add(clbTileItems);

                // æŒ‰éˆ•é¢æ¿
                Panel pnlTileButtons = new Panel();
                pnlTileButtons.Location = new Point(5, tabTile.ClientSize.Height - 75);
                pnlTileButtons.Size = new Size(tabTile.ClientSize.Width - 10, 70);
                pnlTileButtons.Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
                tabTile.Controls.Add(pnlTileButtons);

                Button btnTileSelectAll = new Button { Text = LocalizationManager.L("Button_SelectAll"), Location = new Point(0, 0), Size = new Size(80, 30) };
                btnTileSelectAll.Click += (s, args) => { for (int i = 0; i < clbTileItems.Items.Count; i++) clbTileItems.SetItemChecked(i, true); };
                pnlTileButtons.Controls.Add(btnTileSelectAll);

                Button btnTileDeselectAll = new Button { Text = LocalizationManager.L("AbnormalCheck_DeselectAll"), Location = new Point(90, 0), Size = new Size(80, 30) };
                btnTileDeselectAll.Click += (s, args) => { for (int i = 0; i < clbTileItems.Items.Count; i++) clbTileItems.SetItemChecked(i, false); };
                pnlTileButtons.Controls.Add(btnTileDeselectAll);

                // ç¯©é¸æŒ‰éˆ•
                Button btnFilterL1 = new Button { Text = LocalizationManager.L("AbnormalCheck_SelectL1Only"), Location = new Point(180, 0), Size = new Size(70, 30) };
                btnFilterL1.Click += (s, args) => { for (int i = 0; i < invalidTileItems.Count; i++) clbTileItems.SetItemChecked(i, invalidTileItems[i].Layer == "Layer1"); };
                pnlTileButtons.Controls.Add(btnFilterL1);

                Button btnFilterL2 = new Button { Text = LocalizationManager.L("AbnormalCheck_SelectL2Only"), Location = new Point(255, 0), Size = new Size(70, 30) };
                btnFilterL2.Click += (s, args) => { for (int i = 0; i < invalidTileItems.Count; i++) clbTileItems.SetItemChecked(i, invalidTileItems[i].Layer == "Layer2"); };
                pnlTileButtons.Controls.Add(btnFilterL2);

                Button btnFilterL4 = new Button { Text = LocalizationManager.L("AbnormalCheck_SelectL4Only"), Location = new Point(330, 0), Size = new Size(70, 30) };
                btnFilterL4.Click += (s, args) => { for (int i = 0; i < invalidTileItems.Count; i++) clbTileItems.SetItemChecked(i, invalidTileItems[i].Layer == "Layer4"); };
                pnlTileButtons.Controls.Add(btnFilterL4);

                Button btnTileClearSelected = new Button { Text = LocalizationManager.L("AbnormalCheck_ClearSelected"), Location = new Point(0, 35), Size = new Size(100, 30), BackColor = Color.LightCoral };
                btnTileClearSelected.Click += (s, args) =>
                {
                    if (clbTileItems.CheckedIndices.Count == 0) { MessageBox.Show(LocalizationManager.L("AbnormalCheck_PleaseSelectItems"), LocalizationManager.L("AbnormalCheck_Notice")); return; }
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmClearTiles"), clbTileItems.CheckedIndices.Count),
                        LocalizationManager.L("AbnormalCheck_ConfirmDelete"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;

                    int deletedCount = 0;
                    var checkedIndices = clbTileItems.CheckedIndices.Cast<int>().OrderByDescending(i => i).ToList();
                    foreach (int idx in checkedIndices)
                    {
                        var tile = invalidTileItems[idx];
                        if (_document.S32Files.TryGetValue(tile.FilePath, out var s32Data))
                        {
                            if (tile.Layer == "Layer1")
                            {
                                var cell = s32Data.Layer1[tile.Y, tile.X];
                                if (cell != null) { cell.TileId = 0; cell.IndexId = 0; deletedCount++; }
                            }
                            else if (tile.Layer == "Layer2")
                            {
                                var item = s32Data.Layer2.FirstOrDefault(l => l.X == tile.X && l.Y == tile.Y && l.TileId == tile.TileId && l.IndexId == tile.IndexId);
                                if (item != null) { s32Data.Layer2.Remove(item); deletedCount++; }
                            }
                            else if (tile.Layer == "Layer4")
                            {
                                var obj = s32Data.Layer4.FirstOrDefault(o => o.X == tile.X && o.Y == tile.Y && o.TileId == tile.TileId && o.IndexId == tile.IndexId);
                                if (obj != null) { s32Data.Layer4.Remove(obj); Layer4Index_Remove(s32Data, obj); deletedCount++; }
                            }
                            s32Data.IsModified = true;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ClearedTiles"), deletedCount), LocalizationManager.L("AbnormalCheck_ClearComplete"));
                    ClearS32BlockCache(); resultForm.Close(); RenderS32Map();
                };
                pnlTileButtons.Controls.Add(btnTileClearSelected);

                Button btnTileClearAll = new Button { Text = LocalizationManager.L("AbnormalCheck_ClearAll"), Location = new Point(110, 35), Size = new Size(100, 30), BackColor = Color.Salmon };
                btnTileClearAll.Click += (s, args) =>
                {
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmClearAllTiles"), invalidTileItems.Count),
                        LocalizationManager.L("AbnormalCheck_ConfirmDeleteAll"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;

                    int deletedCount = 0;
                    foreach (var tile in invalidTileItems)
                    {
                        if (_document.S32Files.TryGetValue(tile.FilePath, out var s32Data))
                        {
                            if (tile.Layer == "Layer1")
                            {
                                var cell = s32Data.Layer1[tile.Y, tile.X];
                                if (cell != null) { cell.TileId = 0; cell.IndexId = 0; deletedCount++; }
                            }
                            else if (tile.Layer == "Layer2")
                            {
                                var item = s32Data.Layer2.FirstOrDefault(l => l.X == tile.X && l.Y == tile.Y && l.TileId == tile.TileId && l.IndexId == tile.IndexId);
                                if (item != null) { s32Data.Layer2.Remove(item); deletedCount++; }
                            }
                            else if (tile.Layer == "Layer4")
                            {
                                var obj = s32Data.Layer4.FirstOrDefault(o => o.X == tile.X && o.Y == tile.Y && o.TileId == tile.TileId && o.IndexId == tile.IndexId);
                                if (obj != null) { s32Data.Layer4.Remove(obj); Layer4Index_Remove(s32Data, obj); deletedCount++; }
                            }
                            s32Data.IsModified = true;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ClearedTiles"), deletedCount), LocalizationManager.L("AbnormalCheck_ClearComplete"));
                    ClearS32BlockCache(); resultForm.Close(); RenderS32Map();
                };
                pnlTileButtons.Controls.Add(btnTileClearAll);
            }

            // ===== Tab 3: Layer8 æ“´å±•æ ¼å¼ =====
            if (layer8ExtendedS32.Count > 0)
            {
                int totalL8Items = layer8ExtendedS32.Sum(x => x.layer8Count);
                TabPage tabL8 = new TabPage(string.Format(LocalizationManager.L("AbnormalCheck_Tab_Layer8"), layer8ExtendedS32.Count));
                tabControl.TabPages.Add(tabL8);

                Label lblL8Summary = new Label();
                lblL8Summary.Text = string.Format(LocalizationManager.L("AbnormalCheck_Layer8Summary"), layer8ExtendedS32.Count, totalL8Items);
                lblL8Summary.Location = new Point(5, 5);
                lblL8Summary.Size = new Size(tabL8.ClientSize.Width - 10, 20);
                lblL8Summary.Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right;
                tabL8.Controls.Add(lblL8Summary);

                CheckedListBox clbL8Items = new CheckedListBox();
                clbL8Items.Location = new Point(5, 30);
                clbL8Items.Size = new Size(tabL8.ClientSize.Width - 10, tabL8.ClientSize.Height - 110);
                clbL8Items.Font = new Font("Consolas", 9);
                clbL8Items.CheckOnClick = true;
                clbL8Items.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

                foreach (var (filePath, fileName, layer8Count) in layer8ExtendedS32)
                {
                    string displayText = string.Format(LocalizationManager.L("AbnormalCheck_Layer8ItemCount"), fileName, layer8Count);
                    clbL8Items.Items.Add(displayText);
                }
                tabL8.Controls.Add(clbL8Items);

                // æŒ‰éˆ•é¢æ¿
                Panel pnlL8Buttons = new Panel();
                pnlL8Buttons.Location = new Point(5, tabL8.ClientSize.Height - 75);
                pnlL8Buttons.Size = new Size(tabL8.ClientSize.Width - 10, 70);
                pnlL8Buttons.Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
                tabL8.Controls.Add(pnlL8Buttons);

                Button btnL8SelectAll = new Button { Text = LocalizationManager.L("Button_SelectAll"), Location = new Point(0, 0), Size = new Size(80, 30) };
                btnL8SelectAll.Click += (s, args) => { for (int i = 0; i < clbL8Items.Items.Count; i++) clbL8Items.SetItemChecked(i, true); };
                pnlL8Buttons.Controls.Add(btnL8SelectAll);

                Button btnL8DeselectAll = new Button { Text = LocalizationManager.L("AbnormalCheck_DeselectAll"), Location = new Point(90, 0), Size = new Size(80, 30) };
                btnL8DeselectAll.Click += (s, args) => { for (int i = 0; i < clbL8Items.Items.Count; i++) clbL8Items.SetItemChecked(i, false); };
                pnlL8Buttons.Controls.Add(btnL8DeselectAll);

                Button btnL8ResetSelected = new Button { Text = LocalizationManager.L("AbnormalCheck_ResetSelectedFormat"), Location = new Point(0, 35), Size = new Size(150, 30), BackColor = Color.LightCoral };
                btnL8ResetSelected.Click += (s, args) =>
                {
                    if (clbL8Items.CheckedIndices.Count == 0) { MessageBox.Show(LocalizationManager.L("AbnormalCheck_PleaseSelectReset"), LocalizationManager.L("AbnormalCheck_Notice")); return; }
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmResetSelected"), clbL8Items.CheckedIndices.Count),
                        LocalizationManager.L("AbnormalCheck_ConfirmReset"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;

                    int resetCount = 0;
                    int clearedItems = 0;
                    foreach (int idx in clbL8Items.CheckedIndices)
                    {
                        var (filePath, _, _) = layer8ExtendedS32[idx];
                        if (_document.S32Files.TryGetValue(filePath, out var s32Data))
                        {
                            s32Data.Layer8HasExtendedData = false;
                            foreach (var item in s32Data.Layer8)
                            {
                                item.ExtendedData = 0;
                                clearedItems++;
                            }
                            s32Data.IsModified = true;
                            resetCount++;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ResetComplete"), resetCount, clearedItems), LocalizationManager.L("AbnormalCheck_ResetDone"));
                    UpdateLayer5InvalidButton();
                    resultForm.Close();
                };
                pnlL8Buttons.Controls.Add(btnL8ResetSelected);

                Button btnL8ResetAll = new Button { Text = LocalizationManager.L("AbnormalCheck_ResetAllFormat"), Location = new Point(160, 35), Size = new Size(150, 30), BackColor = Color.Salmon };
                btnL8ResetAll.Click += (s, args) =>
                {
                    if (MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ConfirmResetAll"), layer8ExtendedS32.Count),
                        LocalizationManager.L("AbnormalCheck_ConfirmResetAll_Title"), MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;

                    int resetCount = 0;
                    int clearedItems = 0;
                    foreach (var (filePath, _, _) in layer8ExtendedS32)
                    {
                        if (_document.S32Files.TryGetValue(filePath, out var s32Data))
                        {
                            s32Data.Layer8HasExtendedData = false;
                            foreach (var item in s32Data.Layer8)
                            {
                                item.ExtendedData = 0;
                                clearedItems++;
                            }
                            s32Data.IsModified = true;
                            resetCount++;
                        }
                    }
                    MessageBox.Show(string.Format(LocalizationManager.L("AbnormalCheck_ResetComplete"), resetCount, clearedItems), LocalizationManager.L("AbnormalCheck_ResetDone"));
                    UpdateLayer5InvalidButton();
                    resultForm.Close();
                };
                pnlL8Buttons.Controls.Add(btnL8ResetAll);
            }

            // ===== Tab 4: Tile è¶…éä¸Šé™ =====
            if (overLimitTileIds.Count > 0)
            {
                TabPage tabOverLimit = new TabPage(string.Format(LocalizationManager.L("AbnormalCheck_Tab_OverLimit"), overLimitTileIds.Count));
                tabControl.TabPages.Add(tabOverLimit);

                Label lblOverLimitSummary = new Label();
                lblOverLimitSummary.Text = string.Format(LocalizationManager.L("AbnormalCheck_OverLimitSummary"), overLimitTileIds.Count, tileLimit, maxTileId);
                lblOverLimitSummary.Location = new Point(5, 5);
                lblOverLimitSummary.Size = new Size(tabOverLimit.ClientSize.Width - 10, 40);
                lblOverLimitSummary.Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right;
                tabOverLimit.Controls.Add(lblOverLimitSummary);

                ListBox lbOverLimitItems = new ListBox();
                lbOverLimitItems.Location = new Point(5, 50);
                lbOverLimitItems.Size = new Size(tabOverLimit.ClientSize.Width - 10, tabOverLimit.ClientSize.Height - 130);
                lbOverLimitItems.Font = new Font("Consolas", 9);
                lbOverLimitItems.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

                foreach (var tileId in overLimitTileIds)
                {
                    lbOverLimitItems.Items.Add($"Tile ID: {tileId}");
                }
                tabOverLimit.Controls.Add(lbOverLimitItems);

                // æŒ‰éˆ•é¢æ¿
                Panel pnlOverLimitButtons = new Panel();
                pnlOverLimitButtons.Location = new Point(5, tabOverLimit.ClientSize.Height - 75);
                pnlOverLimitButtons.Size = new Size(tabOverLimit.ClientSize.Width - 10, 70);
                pnlOverLimitButtons.Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
                tabOverLimit.Controls.Add(pnlOverLimitButtons);

                // è¨ˆç®—å»ºè­°çš„æ–°ä¸Šé™ï¼ˆæœ€å¤§å€¼ + 5000ï¼‰
                int suggestedLimit = maxTileId + 5000;

                Label lblSuggestion = new Label();
                lblSuggestion.Text = $"å»ºè­°å°‡ä¸Šé™æ“´å……è‡³: {suggestedLimit}";
                lblSuggestion.Location = new Point(0, 5);
                lblSuggestion.Size = new Size(300, 20);
                pnlOverLimitButtons.Controls.Add(lblSuggestion);

                Button btnExpandLimit = new Button { Text = $"æ“´å……ä¸Šé™è‡³ {suggestedLimit}", Location = new Point(0, 30), Size = new Size(180, 30), BackColor = Color.LightGreen };
                btnExpandLimit.Click += (s, args) =>
                {
                    if (MessageBox.Show($"ç¢ºå®šè¦å°‡ list.til ä¸Šé™å¾ {tileLimit} æ“´å……è‡³ {suggestedLimit} å—ï¼Ÿ",
                        "ç¢ºèªæ“´å……ä¸Šé™", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes) return;

                    if (TileHashManager.UpdateTileLimit(suggestedLimit))
                    {
                        _listTilMaxId = null;  // æ¸…é™¤å¿«å–
                        MessageBox.Show($"å·²å°‡ list.til ä¸Šé™æ“´å……è‡³ {suggestedLimit}ã€‚", "æ“´å……æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        UpdateLayer5InvalidButton();
                        resultForm.Close();
                    }
                    else
                    {
                        MessageBox.Show("æ“´å……å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Tile.pak æ˜¯å¦å¯å¯«å…¥ã€‚", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                };
                pnlOverLimitButtons.Controls.Add(btnExpandLimit);

                Button btnExpandCustom = new Button { Text = "è‡ªè¨‚ä¸Šé™...", Location = new Point(190, 30), Size = new Size(100, 30) };
                btnExpandCustom.Click += (s, args) =>
                {
                    string input = Microsoft.VisualBasic.Interaction.InputBox(
                        $"è«‹è¼¸å…¥æ–°çš„ä¸Šé™å€¼ï¼ˆç›®å‰ä¸Šé™: {tileLimit}ï¼Œæœ€å¤§Tile: {maxTileId}ï¼‰ï¼š",
                        "è‡ªè¨‚ä¸Šé™", suggestedLimit.ToString());
                    if (string.IsNullOrEmpty(input)) return;
                    if (!int.TryParse(input, out int newLimit) || newLimit < maxTileId)
                    {
                        MessageBox.Show($"ç„¡æ•ˆçš„æ•¸å€¼ã€‚æ–°ä¸Šé™å¿…é ˆå¤§æ–¼æˆ–ç­‰æ–¼æœ€å¤§ Tile ID ({maxTileId})ã€‚", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        return;
                    }
                    if (TileHashManager.UpdateTileLimit(newLimit))
                    {
                        _listTilMaxId = null;
                        MessageBox.Show($"å·²å°‡ list.til ä¸Šé™è¨­ç‚º {newLimit}ã€‚", "è¨­å®šæˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        UpdateLayer5InvalidButton();
                        resultForm.Close();
                    }
                    else
                    {
                        MessageBox.Show("è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Tile.pak æ˜¯å¦å¯å¯«å…¥ã€‚", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                };
                pnlOverLimitButtons.Controls.Add(btnExpandCustom);
            }

            // é—œé–‰æŒ‰éˆ•
            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(resultForm.ClientSize.Width - 90, resultForm.ClientSize.Height - 40);
            btnClose.Size = new Size(80, 30);
            btnClose.Anchor = AnchorStyles.Bottom | AnchorStyles.Right;
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            resultForm.ShowDialog();
        }

        // æŸ¥çœ‹èˆ‡ç®¡ç†ç¬¬ä¸ƒå±¤ï¼ˆå‚³é€é»ï¼‰è³‡æ–™ - æ”¯æ´ç·¨è¼¯
        private void btnToolCheckL7_Click(object sender, EventArgs e)
        {
            if (_document.S32Files.Count == 0)
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            // æ”¶é›†æœ‰ Layer7 è³‡æ–™çš„ S32
            List<(string filePath, string fileName, int count, List<Layer7Item> items)> s32WithL7 =
                new List<(string, string, int, List<Layer7Item>)>();

            foreach (var kvp in _document.S32Files)
            {
                string filePath = kvp.Key;
                string fileName = Path.GetFileName(kvp.Key);
                S32Data s32Data = kvp.Value;

                if (s32Data.Layer7.Count > 0)
                {
                    s32WithL7.Add((filePath, fileName, s32Data.Layer7.Count, s32Data.Layer7.ToList()));
                }
            }

            // é¡¯ç¤ºçµæœ
            Form resultForm = new Form();
            resultForm.Text = $"L7 æª¢æŸ¥ã€ç·¨è¼¯èˆ‡æ¸…é™¤ - {s32WithL7.Count} å€‹ S32 æœ‰è³‡æ–™";
            resultForm.Size = new Size(800, 600);
            resultForm.FormBorderStyle = FormBorderStyle.Sizable;
            resultForm.StartPosition = FormStartPosition.CenterParent;

            int totalItems = s32WithL7.Sum(x => x.count);
            Label lblSummary = new Label();
            lblSummary.Text = $"å…± {s32WithL7.Count} å€‹ S32 æª”æ¡ˆæœ‰ Layer7ï¼ˆå‚³é€é»ï¼‰è³‡æ–™ï¼Œç¸½è¨ˆ {totalItems} é …ã€‚é¸å–é …ç›®å¾Œå¯ç·¨è¼¯æˆ–åˆªé™¤ï¼š";
            lblSummary.Location = new Point(10, 10);
            lblSummary.Size = new Size(760, 20);
            resultForm.Controls.Add(lblSummary);

            // ä½¿ç”¨ ListView ä¾†é¡¯ç¤ºè©³ç´°è³‡è¨Š
            ListView lvItems = new ListView();
            lvItems.Location = new Point(10, 35);
            lvItems.Size = new Size(760, 350);
            lvItems.Font = new Font("Consolas", 9);
            lvItems.View = View.Details;
            lvItems.FullRowSelect = true;
            lvItems.CheckBoxes = true;
            lvItems.Columns.Add("S32 æª”æ¡ˆ", 120);
            lvItems.Columns.Add("åç¨±", 150);
            lvItems.Columns.Add("X", 50);
            lvItems.Columns.Add("Y", 50);
            lvItems.Columns.Add("ç›®æ¨™åœ°åœ–", 80);
            lvItems.Columns.Add("PortalId", 80);

            List<(string filePath, Layer7Item item)> itemInfoList = new List<(string, Layer7Item)>();

            if (s32WithL7.Count == 0)
            {
                lvItems.Items.Add(new ListViewItem("æ²’æœ‰ä»»ä½• S32 æª”æ¡ˆæœ‰ Layer7 è³‡æ–™"));
                lvItems.Enabled = false;
            }
            else
            {
                foreach (var (filePath, fileName, count, items) in s32WithL7)
                {
                    foreach (var item in items)
                    {
                        ListViewItem lvi = new ListViewItem(fileName);
                        lvi.SubItems.Add(item.Name);
                        lvi.SubItems.Add(item.X.ToString());
                        lvi.SubItems.Add(item.Y.ToString());
                        lvi.SubItems.Add(item.TargetMapId.ToString());
                        lvi.SubItems.Add(item.PortalId.ToString());
                        lvi.Tag = (filePath, item);
                        lvItems.Items.Add(lvi);
                        itemInfoList.Add((filePath, item));
                    }
                }
            }
            resultForm.Controls.Add(lvItems);

            // ç·¨è¼¯å€åŸŸ
            GroupBox gbEdit = new GroupBox();
            gbEdit.Text = "ç·¨è¼¯é¸å–çš„é …ç›®";
            gbEdit.Location = new Point(10, 395);
            gbEdit.Size = new Size(760, 80);

            Label lblName = new Label { Text = "åç¨±:", Location = new Point(10, 25), Size = new Size(40, 20) };
            TextBox txtName = new TextBox { Location = new Point(55, 22), Size = new Size(120, 23) };
            Label lblX = new Label { Text = "X:", Location = new Point(185, 25), Size = new Size(20, 20) };
            TextBox txtX = new TextBox { Location = new Point(205, 22), Size = new Size(50, 23) };
            Label lblY = new Label { Text = "Y:", Location = new Point(265, 25), Size = new Size(20, 20) };
            TextBox txtY = new TextBox { Location = new Point(285, 22), Size = new Size(50, 23) };
            Label lblTarget = new Label { Text = "ç›®æ¨™åœ°åœ–:", Location = new Point(345, 25), Size = new Size(60, 20) };
            TextBox txtTarget = new TextBox { Location = new Point(410, 22), Size = new Size(60, 23) };
            Label lblPortal = new Label { Text = "PortalId:", Location = new Point(480, 25), Size = new Size(55, 20) };
            TextBox txtPortal = new TextBox { Location = new Point(540, 22), Size = new Size(60, 23) };

            Button btnApplyEdit = new Button();
            btnApplyEdit.Text = "å¥—ç”¨ä¿®æ”¹";
            btnApplyEdit.Location = new Point(620, 20);
            btnApplyEdit.Size = new Size(80, 28);
            btnApplyEdit.Click += (s, args) =>
            {
                if (lvItems.SelectedItems.Count != 1)
                {
                    MessageBox.Show("è«‹é¸å–ä¸€å€‹é …ç›®é€²è¡Œç·¨è¼¯", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var lvi = lvItems.SelectedItems[0];
                var (filePath, item) = ((string, Layer7Item))lvi.Tag;

                if (!byte.TryParse(txtX.Text, out byte newX) ||
                    !byte.TryParse(txtY.Text, out byte newY) ||
                    !ushort.TryParse(txtTarget.Text, out ushort newTarget) ||
                    !int.TryParse(txtPortal.Text, out int newPortal))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æ›´æ–°è³‡æ–™
                item.Name = txtName.Text;
                item.X = newX;
                item.Y = newY;
                item.TargetMapId = newTarget;
                item.PortalId = newPortal;

                // æ›´æ–° ListView é¡¯ç¤º
                lvi.SubItems[1].Text = item.Name;
                lvi.SubItems[2].Text = item.X.ToString();
                lvi.SubItems[3].Text = item.Y.ToString();
                lvi.SubItems[4].Text = item.TargetMapId.ToString();
                lvi.SubItems[5].Text = item.PortalId.ToString();

                // æ¨™è¨˜å·²ä¿®æ”¹
                if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                {
                    s32Data.IsModified = true;
                }

                MessageBox.Show("å·²å¥—ç”¨ä¿®æ”¹ã€‚è«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
            };

            // æ–°å¢é …ç›®æŒ‰éˆ•
            Button btnAddNew = new Button();
            btnAddNew.Text = "æ–°å¢";
            btnAddNew.Location = new Point(620, 52);
            btnAddNew.Size = new Size(80, 28);
            btnAddNew.Click += (s, args) =>
            {
                // é¸æ“‡è¦æ–°å¢åˆ°å“ªå€‹ S32 æª”æ¡ˆ
                Form selectForm = new Form();
                selectForm.Text = "é¸æ“‡ S32 æª”æ¡ˆ";
                selectForm.Size = new Size(400, 350);
                selectForm.FormBorderStyle = FormBorderStyle.FixedDialog;
                selectForm.StartPosition = FormStartPosition.CenterParent;
                selectForm.MaximizeBox = false;
                selectForm.MinimizeBox = false;

                Label lblSelect = new Label();
                lblSelect.Text = "é¸æ“‡è¦æ–°å¢ Layer7 é …ç›®çš„ S32 æª”æ¡ˆï¼š";
                lblSelect.Location = new Point(10, 10);
                lblSelect.Size = new Size(360, 20);
                selectForm.Controls.Add(lblSelect);

                ListBox lbS32Files = new ListBox();
                lbS32Files.Location = new Point(10, 35);
                lbS32Files.Size = new Size(360, 220);
                foreach (var kvp in _document.S32Files)
                {
                    lbS32Files.Items.Add(Path.GetFileName(kvp.Key));
                }
                if (lbS32Files.Items.Count > 0)
                    lbS32Files.SelectedIndex = 0;
                selectForm.Controls.Add(lbS32Files);

                Button btnOK = new Button();
                btnOK.Text = "ç¢ºå®š";
                btnOK.Location = new Point(100, 265);
                btnOK.Size = new Size(80, 30);
                btnOK.DialogResult = DialogResult.OK;
                selectForm.Controls.Add(btnOK);

                Button btnCancel = new Button();
                btnCancel.Text = "å–æ¶ˆ";
                btnCancel.Location = new Point(200, 265);
                btnCancel.Size = new Size(80, 30);
                btnCancel.DialogResult = DialogResult.Cancel;
                selectForm.Controls.Add(btnCancel);

                selectForm.AcceptButton = btnOK;
                selectForm.CancelButton = btnCancel;

                if (selectForm.ShowDialog() == DialogResult.OK && lbS32Files.SelectedItem != null)
                {
                    string selectedFileName = lbS32Files.SelectedItem.ToString();
                    string selectedFilePath = _document.S32Files.Keys.FirstOrDefault(k => Path.GetFileName(k) == selectedFileName);

                    if (selectedFilePath != null && _document.S32Files.TryGetValue(selectedFilePath, out S32Data s32Data))
                    {
                        // é©—è­‰è¼¸å…¥
                        if (!byte.TryParse(txtX.Text, out byte newX))
                            newX = 0;
                        if (!byte.TryParse(txtY.Text, out byte newY))
                            newY = 0;
                        if (!ushort.TryParse(txtTarget.Text, out ushort newTarget))
                            newTarget = 0;
                        if (!int.TryParse(txtPortal.Text, out int newPortal))
                            newPortal = 0;

                        // å»ºç«‹æ–°é …ç›®
                        Layer7Item newItem = new Layer7Item
                        {
                            Name = string.IsNullOrEmpty(txtName.Text) ? "NewPortal" : txtName.Text,
                            X = newX,
                            Y = newY,
                            TargetMapId = newTarget,
                            PortalId = newPortal
                        };

                        // åŠ å…¥ S32 è³‡æ–™
                        s32Data.Layer7.Add(newItem);
                        s32Data.IsModified = true;

                        // æ›´æ–° ListView
                        ListViewItem newLvi = new ListViewItem(selectedFileName);
                        newLvi.SubItems.Add(newItem.Name);
                        newLvi.SubItems.Add(newItem.X.ToString());
                        newLvi.SubItems.Add(newItem.Y.ToString());
                        newLvi.SubItems.Add(newItem.TargetMapId.ToString());
                        newLvi.SubItems.Add(newItem.PortalId.ToString());
                        newLvi.Tag = (selectedFilePath, newItem);
                        lvItems.Items.Add(newLvi);
                        itemInfoList.Add((selectedFilePath, newItem));

                        // é¸å–æ–°å¢çš„é …ç›®
                        newLvi.Selected = true;
                        newLvi.EnsureVisible();

                        MessageBox.Show($"å·²æ–°å¢ Layer7 é …ç›®åˆ° {selectedFileName}ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                            MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            };

            gbEdit.Controls.AddRange(new Control[] { lblName, txtName, lblX, txtX, lblY, txtY, lblTarget, txtTarget, lblPortal, txtPortal, btnApplyEdit, btnAddNew });
            resultForm.Controls.Add(gbEdit);

            // é¸å–é …ç›®æ™‚å¡«å…¥ç·¨è¼¯å€
            lvItems.SelectedIndexChanged += (s, args) =>
            {
                if (lvItems.SelectedItems.Count == 1)
                {
                    var lvi = lvItems.SelectedItems[0];
                    var (filePath, item) = ((string, Layer7Item))lvi.Tag;
                    txtName.Text = item.Name;
                    txtX.Text = item.X.ToString();
                    txtY.Text = item.Y.ToString();
                    txtTarget.Text = item.TargetMapId.ToString();
                    txtPortal.Text = item.PortalId.ToString();
                }
            };

            Button btnSelectAll = new Button();
            btnSelectAll.Text = "å…¨é¸";
            btnSelectAll.Location = new Point(10, 485);
            btnSelectAll.Size = new Size(80, 30);
            btnSelectAll.Click += (s, args) =>
            {
                foreach (ListViewItem lvi in lvItems.Items)
                    lvi.Checked = true;
            };
            resultForm.Controls.Add(btnSelectAll);

            Button btnDeselectAll = new Button();
            btnDeselectAll.Text = "å–æ¶ˆå…¨é¸";
            btnDeselectAll.Location = new Point(100, 485);
            btnDeselectAll.Size = new Size(80, 30);
            btnDeselectAll.Click += (s, args) =>
            {
                foreach (ListViewItem lvi in lvItems.Items)
                    lvi.Checked = false;
            };
            resultForm.Controls.Add(btnDeselectAll);

            Button btnClearSelected = new Button();
            btnClearSelected.Text = "åˆªé™¤å‹¾é¸é …ç›®";
            btnClearSelected.Location = new Point(10, 525);
            btnClearSelected.Size = new Size(120, 35);
            btnClearSelected.BackColor = Color.LightCoral;
            btnClearSelected.Enabled = s32WithL7.Count > 0;
            btnClearSelected.Click += (s, args) =>
            {
                int checkedCount = lvItems.CheckedItems.Count;
                if (checkedCount == 0)
                {
                    MessageBox.Show("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åˆªé™¤å‹¾é¸çš„ {checkedCount} å€‹ Layer7 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªåˆªé™¤",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                Dictionary<string, List<Layer7Item>> toRemove = new Dictionary<string, List<Layer7Item>>();
                foreach (ListViewItem lvi in lvItems.CheckedItems)
                {
                    var (filePath, item) = ((string, Layer7Item))lvi.Tag;
                    if (!toRemove.ContainsKey(filePath))
                        toRemove[filePath] = new List<Layer7Item>();
                    toRemove[filePath].Add(item);
                }

                int removedCount = 0;
                foreach (var kvp in toRemove)
                {
                    if (_document.S32Files.TryGetValue(kvp.Key, out S32Data s32Data))
                    {
                        foreach (var item in kvp.Value)
                        {
                            if (s32Data.Layer7.Remove(item))
                                removedCount++;
                        }
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {removedCount} å€‹ Layer7 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearSelected);

            Button btnClearAll = new Button();
            btnClearAll.Text = "åˆªé™¤å…¨éƒ¨ L7";
            btnClearAll.Location = new Point(140, 525);
            btnClearAll.Size = new Size(120, 35);
            btnClearAll.BackColor = Color.Salmon;
            btnClearAll.Enabled = s32WithL7.Count > 0;
            btnClearAll.Click += (s, args) =>
            {
                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ {totalItems} å€‹ Layer7 é …ç›®å—ï¼Ÿ",
                    "ç¢ºèªåˆªé™¤å…¨éƒ¨",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

                if (confirmResult != DialogResult.Yes) return;

                int removedCount = 0;
                foreach (var (filePath, fileName, count, items) in s32WithL7)
                {
                    if (_document.S32Files.TryGetValue(filePath, out S32Data s32Data))
                    {
                        removedCount += s32Data.Layer7.Count;
                        s32Data.Layer7.Clear();
                        s32Data.IsModified = true;
                    }
                }

                MessageBox.Show($"å·²åˆªé™¤ {removedCount} å€‹ Layer7 é …ç›®ã€‚\n\nè«‹è¨˜å¾—å„²å­˜ S32 æª”æ¡ˆã€‚", "å®Œæˆ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                resultForm.Close();
                RenderS32Map();
            };
            resultForm.Controls.Add(btnClearAll);

            Button btnClose = new Button();
            btnClose.Text = "é—œé–‰";
            btnClose.Location = new Point(680, 525);
            btnClose.Size = new Size(90, 35);
            btnClose.Click += (s, args) => resultForm.Close();
            resultForm.Controls.Add(btnClose);

            resultForm.Resize += (s, args) =>
            {
                lvItems.Size = new Size(resultForm.ClientSize.Width - 20, resultForm.ClientSize.Height - 210);
                gbEdit.Location = new Point(10, resultForm.ClientSize.Height - 165);
                gbEdit.Size = new Size(resultForm.ClientSize.Width - 20, 80);
                btnSelectAll.Location = new Point(10, resultForm.ClientSize.Height - 75);
                btnDeselectAll.Location = new Point(100, resultForm.ClientSize.Height - 75);
                btnClearSelected.Location = new Point(10, resultForm.ClientSize.Height - 35);
                btnClearAll.Location = new Point(140, resultForm.ClientSize.Height - 35);
                btnClose.Location = new Point(resultForm.ClientSize.Width - 100, resultForm.ClientSize.Height - 35);
            };

            resultForm.ShowDialog();
        }

        private void btnToolAddS32_Click(object sender, EventArgs e)
        {
            // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥åœ°åœ–
            if (string.IsNullOrEmpty(_document.MapId) || !Share.MapDataList.ContainsKey(_document.MapId))
            {
                MessageBox.Show("è«‹å…ˆè¼‰å…¥åœ°åœ–", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            Struct.L1Map currentMap = Share.MapDataList[_document.MapId];

            // å‰µå»ºæ–°å¢ S32 å°è©±æ¡†
            Form addS32Form = new Form();
            addS32Form.Text = "æ–°å¢ S32 å€å¡Š";
            addS32Form.Size = new Size(400, 280);
            addS32Form.FormBorderStyle = FormBorderStyle.FixedDialog;
            addS32Form.StartPosition = FormStartPosition.CenterParent;
            addS32Form.MaximizeBox = false;
            addS32Form.MinimizeBox = false;

            // èªªæ˜
            Label lblInfo = new Label();
            lblInfo.Text = "è¼¸å…¥è¦æ–°å¢çš„ S32 å€å¡Šåº§æ¨™ï¼ˆBlockX, BlockYï¼‰\næˆ–è¼¸å…¥éŠæˆ²åº§æ¨™è‡ªå‹•è¨ˆç®—";
            lblInfo.Location = new Point(20, 15);
            lblInfo.Size = new Size(350, 35);
            addS32Form.Controls.Add(lblInfo);

            // BlockX
            Label lblBlockX = new Label();
            lblBlockX.Text = "BlockX (16é€²ä½):";
            lblBlockX.Location = new Point(20, 60);
            lblBlockX.Size = new Size(100, 20);
            addS32Form.Controls.Add(lblBlockX);

            TextBox txtBlockX = new TextBox();
            txtBlockX.Location = new Point(130, 58);
            txtBlockX.Size = new Size(80, 20);
            txtBlockX.Text = "7FFF";
            addS32Form.Controls.Add(txtBlockX);

            // BlockY
            Label lblBlockY = new Label();
            lblBlockY.Text = "BlockY (16é€²ä½):";
            lblBlockY.Location = new Point(20, 90);
            lblBlockY.Size = new Size(100, 20);
            addS32Form.Controls.Add(lblBlockY);

            TextBox txtBlockY = new TextBox();
            txtBlockY.Location = new Point(130, 88);
            txtBlockY.Size = new Size(80, 20);
            txtBlockY.Text = "8000";
            addS32Form.Controls.Add(txtBlockY);

            // åˆ†éš”ç·š
            Label lblSeparator = new Label();
            lblSeparator.Text = "â”€â”€ æˆ–ç”¨éŠæˆ²åº§æ¨™è¨ˆç®— â”€â”€";
            lblSeparator.Location = new Point(20, 120);
            lblSeparator.Size = new Size(350, 20);
            lblSeparator.ForeColor = Color.Gray;
            addS32Form.Controls.Add(lblSeparator);

            // éŠæˆ²åº§æ¨™ X
            Label lblGameX = new Label();
            lblGameX.Text = "éŠæˆ²åº§æ¨™ X:";
            lblGameX.Location = new Point(20, 150);
            lblGameX.Size = new Size(100, 20);
            addS32Form.Controls.Add(lblGameX);

            TextBox txtGameX = new TextBox();
            txtGameX.Location = new Point(130, 148);
            txtGameX.Size = new Size(80, 20);
            addS32Form.Controls.Add(txtGameX);

            // éŠæˆ²åº§æ¨™ Y
            Label lblGameY = new Label();
            lblGameY.Text = "éŠæˆ²åº§æ¨™ Y:";
            lblGameY.Location = new Point(220, 150);
            lblGameY.Size = new Size(80, 20);
            addS32Form.Controls.Add(lblGameY);

            TextBox txtGameY = new TextBox();
            txtGameY.Location = new Point(300, 148);
            txtGameY.Size = new Size(80, 20);
            addS32Form.Controls.Add(txtGameY);

            // è¨ˆç®—æŒ‰éˆ•
            Button btnCalc = new Button();
            btnCalc.Text = "è¨ˆç®—";
            btnCalc.Location = new Point(230, 58);
            btnCalc.Size = new Size(60, 50);
            addS32Form.Controls.Add(btnCalc);

            // æ–°å¢æŒ‰éˆ•
            Button btnAdd = new Button();
            btnAdd.Text = "æ–°å¢";
            btnAdd.Location = new Point(100, 195);
            btnAdd.Size = new Size(80, 30);
            addS32Form.Controls.Add(btnAdd);

            // å–æ¶ˆæŒ‰éˆ•
            Button btnCancel = new Button();
            btnCancel.Text = "å–æ¶ˆ";
            btnCancel.Location = new Point(200, 195);
            btnCancel.Size = new Size(80, 30);
            btnCancel.Click += (s, args) => addS32Form.Close();
            addS32Form.Controls.Add(btnCancel);

            // è¨ˆç®—åŠŸèƒ½ï¼šå¾éŠæˆ²åº§æ¨™è¨ˆç®— BlockX, BlockY
            btnCalc.Click += (s, args) =>
            {
                if (!int.TryParse(txtGameX.Text, out int gameX) ||
                    !int.TryParse(txtGameY.Text, out int gameY))
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„éŠæˆ²åº§æ¨™", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // å¾éŠæˆ²åº§æ¨™è¨ˆç®— BlockX, BlockY
                // å…¬å¼ä¾†è‡ª L1MapSeg: nLinEndX = (nBlockX - 0x7fff) * 64 + 0x7fff
                // åæ¨: nBlockX = (nLinEndX - 0x7fff) / 64 + 0x7fff
                // è€Œ nLinEndX = nLinBeginX + 63ï¼Œæ‰€ä»¥ nLinBeginX åœ¨æŸå€‹ block å…§æ™‚
                // blockX = ((gameX - 0x7fff) / 64) + 0x7fff + (if gameX > 0x7fff then 1 else 0)
                int blockX = ((gameX - 0x7FFF - 1) / 64) + 0x8000;
                int blockY = ((gameY - 0x7FFF - 1) / 64) + 0x8000;

                txtBlockX.Text = blockX.ToString("X4");
                txtBlockY.Text = blockY.ToString("X4");
            };

            // æ–°å¢åŠŸèƒ½
            btnAdd.Click += (s, args) =>
            {
                int blockX, blockY;
                try
                {
                    blockX = Convert.ToInt32(txtBlockX.Text, 16);
                    blockY = Convert.ToInt32(txtBlockY.Text, 16);
                }
                catch
                {
                    MessageBox.Show("è«‹è¼¸å…¥æœ‰æ•ˆçš„ 16 é€²ä½ BlockX å’Œ BlockY", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å·²å­˜åœ¨
                string fileName = $"{blockX:X4}{blockY:X4}.s32".ToLower();
                string filePath = Path.Combine(currentMap.szFullDirName, fileName);

                if (File.Exists(filePath))
                {
                    MessageBox.Show($"S32 æª”æ¡ˆå·²å­˜åœ¨: {fileName}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦å·²åœ¨è¨˜æ†¶é«”ä¸­
                if (_document.S32Files.Keys.Any(k => k.EndsWith(fileName, StringComparison.OrdinalIgnoreCase)))
                {
                    MessageBox.Show($"S32 æª”æ¡ˆå·²è¼‰å…¥: {fileName}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // ç¢ºèªæ–°å¢
                var confirmResult = MessageBox.Show(
                    $"ç¢ºå®šè¦æ–°å¢ S32 å€å¡Šå—ï¼Ÿ\n\næª”æ¡ˆåç¨±: {fileName}\nBlockX: {blockX:X4}, BlockY: {blockY:X4}\nè·¯å¾‘: {filePath}",
                    "ç¢ºèªæ–°å¢",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);

                if (confirmResult != DialogResult.Yes) return;

                // å‰µå»ºç©ºçš„ S32 è³‡æ–™
                S32Data newS32Data = CreateEmptyS32Data(blockX, blockY, filePath);

                // å‰µå»º SegInfo
                Struct.L1MapSeg segInfo = new Struct.L1MapSeg(blockX, blockY, true);
                segInfo.isRemastered = false;
                segInfo.nMapMinBlockX = currentMap.nMinBlockX;
                segInfo.nMapMinBlockY = currentMap.nMinBlockY;
                segInfo.nMapBlockCountX = currentMap.nBlockCountX;

                newS32Data.SegInfo = segInfo;
                newS32Data.IsModified = true;

                // åŠ å…¥åˆ°è¨˜æ†¶é«”ï¼ˆå…ˆåŠ å…¥æ‰èƒ½ç”¨ SaveS32Fileï¼‰
                _document.S32Files[filePath] = newS32Data;

                // å¯«å…¥æª”æ¡ˆ
                try
                {
                    SaveS32File(filePath);  // ä½¿ç”¨æ­£ç¢ºæ ¼å¼çš„ä¿å­˜æ–¹æ³•
                }
                catch (Exception ex)
                {
                    // ç§»é™¤å¤±æ•—çš„ S32
                    _document.S32Files.Remove(filePath);
                    MessageBox.Show($"å¯«å…¥æª”æ¡ˆå¤±æ•—: {ex.Message}", "éŒ¯èª¤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // åŠ å…¥åˆ° FullFileNameList
                currentMap.FullFileNameList[filePath] = segInfo;

                // æ›´æ–°åœ°åœ–é‚Šç•Œï¼ˆå¦‚æœæ–°çš„ S32 è¶…å‡ºç¾æœ‰é‚Šç•Œï¼‰
                if (blockX < currentMap.nMinBlockX || blockX > currentMap.nMaxBlockX ||
                    blockY < currentMap.nMinBlockY || blockY > currentMap.nMaxBlockY)
                {
                    currentMap.nMinBlockX = Math.Min(currentMap.nMinBlockX, blockX);
                    currentMap.nMinBlockY = Math.Min(currentMap.nMinBlockY, blockY);
                    currentMap.nMaxBlockX = Math.Max(currentMap.nMaxBlockX, blockX);
                    currentMap.nMaxBlockY = Math.Max(currentMap.nMaxBlockY, blockY);
                    currentMap.nBlockCountX = currentMap.nMaxBlockX - currentMap.nMinBlockX + 1;
                    currentMap.nBlockCountY = currentMap.nMaxBlockY - currentMap.nMinBlockY + 1;
                    currentMap.nLinLengthX = currentMap.nBlockCountX * 64;
                    currentMap.nLinLengthY = currentMap.nBlockCountY * 64;
                    currentMap.nLinEndX = (currentMap.nMaxBlockX - 0x7FFF) * 64 + 0x7FFF;
                    currentMap.nLinEndY = (currentMap.nMaxBlockY - 0x7FFF) * 64 + 0x7FFF;
                    currentMap.nLinBeginX = currentMap.nLinEndX - currentMap.nLinLengthX + 1;
                    currentMap.nLinBeginY = currentMap.nLinEndY - currentMap.nLinLengthY + 1;

                    // æ›´æ–°æ‰€æœ‰ SegInfo çš„å…±äº«å€¼
                    foreach (var seg in currentMap.FullFileNameList.Values)
                    {
                        seg.nMapMinBlockX = currentMap.nMinBlockX;
                        seg.nMapMinBlockY = currentMap.nMinBlockY;
                        seg.nMapBlockCountX = currentMap.nBlockCountX;
                    }
                }

                // åŠ å…¥åˆ° UI æ¸…å–®
                string displayName = $"{fileName} ({blockX:X4},{blockY:X4}) [{segInfo.nLinBeginX},{segInfo.nLinBeginY}~{segInfo.nLinEndX},{segInfo.nLinEndY}]";
                S32FileItem item = new S32FileItem
                {
                    FilePath = filePath,
                    DisplayName = displayName,
                    SegInfo = segInfo,
                    IsChecked = true
                };
                int index = lstS32Files.Items.Add(item);
                lstS32Files.SetItemChecked(index, true);

                // é‡æ–°æ¸²æŸ“åœ°åœ–
                RenderS32Map();

                MessageBox.Show($"S32 å€å¡Šå·²æ–°å¢ï¼\n\næª”æ¡ˆ: {fileName}", "å®Œæˆ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                this.toolStripStatusLabel1.Text = $"å·²æ–°å¢ S32: {fileName}";
                addS32Form.Close();
            };

            addS32Form.ShowDialog();
        }

        // å‰µå»ºç©ºçš„ S32 è³‡æ–™
        private S32Data CreateEmptyS32Data(int blockX, int blockY, string filePath)
        {
            S32Data s32Data = new S32Data();
            s32Data.FilePath = filePath;

            // åˆå§‹åŒ– Layer1ï¼ˆ128x64 çš„æ ¼å­ï¼Œå…¨éƒ¨è¨­ç‚ºç©ºç™½ï¼‰
            s32Data.Layer1 = new TileCell[64, 128];
            for (int y = 0; y < 64; y++)
            {
                for (int x = 0; x < 128; x++)
                {
                    s32Data.Layer1[y, x] = new TileCell
                    {
                        X = x,
                        Y = y,
                        TileId = 0,
                        IndexId = 0,
                        IsModified = false
                    };
                }
            }

            // åˆå§‹åŒ– Layer2ï¼ˆç©ºçš„ï¼‰
            s32Data.Layer2 = new List<Layer2Item>();

            // åˆå§‹åŒ– Layer3ï¼ˆ64x64 çš„å±¬æ€§ï¼Œå…¨éƒ¨è¨­ç‚ºå¯é€šè¡Œï¼‰
            s32Data.Layer3 = new MapAttribute[64, 64];
            for (int y = 0; y < 64; y++)
            {
                for (int x = 0; x < 64; x++)
                {
                    s32Data.Layer3[y, x] = new MapAttribute { Attribute1 = 0, Attribute2 = 0 }; // é è¨­å¯é€šè¡Œ
                }
            }

            // åˆå§‹åŒ– Layer4ï¼ˆç‰©ä»¶åˆ—è¡¨ï¼Œç©ºçš„ï¼‰
            s32Data.Layer4 = new List<ObjectTile>();

            // åˆå§‹åŒ– Layer5-8
            s32Data.Layer5 = new List<Layer5Item>();
            s32Data.Layer6 = new List<int>();
            s32Data.Layer7 = new List<Layer7Item>();
            s32Data.Layer8 = new List<Layer8Item>();

            // åˆå§‹åŒ–å…¶ä»–æ¬„ä½
            s32Data.UsedTiles = new Dictionary<int, TileInfo>();
            s32Data.OriginalFileData = new byte[0];
            s32Data.Layer1Offset = 0;
            s32Data.Layer2Offset = 0;
            s32Data.Layer3Offset = 0;
            s32Data.Layer4Offset = 0;
            s32Data.Layer4EndOffset = 0;
            s32Data.Layer5to8Data = new byte[0];
            s32Data.IsModified = true;

            return s32Data;
        }

        /// <summary>
        /// é¡¯ç¤ºè‡ªå‹•é—œé–‰çš„è¨Šæ¯è¦–çª—
        /// </summary>
        /// <param name="message">è¨Šæ¯å…§å®¹</param>
        /// <param name="title">è¦–çª—æ¨™é¡Œ</param>
        /// <param name="seconds">è‡ªå‹•é—œé–‰ç§’æ•¸</param>
        private void ShowAutoCloseMessage(string message, string title, int seconds = 3)
        {
            var form = new Form
            {
                Text = title,
                Size = new Size(400, 150),
                FormBorderStyle = FormBorderStyle.FixedDialog,
                StartPosition = FormStartPosition.CenterParent,
                MaximizeBox = false,
                MinimizeBox = false,
                ShowInTaskbar = false
            };

            var label = new Label
            {
                Text = message,
                AutoSize = false,
                TextAlign = ContentAlignment.MiddleCenter,
                Dock = DockStyle.Fill,
                Font = new Font(form.Font.FontFamily, 10f)
            };
            form.Controls.Add(label);

            var timer = new System.Windows.Forms.Timer { Interval = seconds * 1000 };
            timer.Tick += (s, e) =>
            {
                timer.Stop();
                timer.Dispose();
                form.Close();
            };
            timer.Start();

            form.ShowDialog(this);
        }

        private void discordToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
            {
                FileName = "https://discord.gg/vjSKGD95HB",
                UseShellExecute = true
            });
        }
    }

    /// <summary>
    /// ListView æ¬„ä½æ’åºå™¨
    /// </summary>
    public class ListViewColumnSorter : System.Collections.IComparer
    {
        private int _column;
        private bool _ascending;

        public ListViewColumnSorter(int column, bool ascending)
        {
            _column = column;
            _ascending = ascending;
        }

        public int Compare(object x, object y)
        {
            ListViewItem itemX = x as ListViewItem;
            ListViewItem itemY = y as ListViewItem;
            if (itemX == null || itemY == null) return 0;

            string textX = _column < itemX.SubItems.Count ? itemX.SubItems[_column].Text : "";
            string textY = _column < itemY.SubItems.Count ? itemY.SubItems[_column].Text : "";

            int result;
            // å˜—è©¦æ•¸å­—æ¯”è¼ƒ
            if (int.TryParse(textX, out int numX) && int.TryParse(textY, out int numY))
            {
                result = numX.CompareTo(numY);
            }
            else
            {
                result = string.Compare(textX, textY, StringComparison.OrdinalIgnoreCase);
            }

            return _ascending ? result : -result;
        }
    }
}
